#!/usr/bin/env node
/* Copyright Â© 2020, PhotoStructure Inc. <https://photostructure.com/eula> */
module.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=413)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(46);function r(e,t){return null==e?void 0:t(e)}function s(e,t,n){return null==e||null==t?void 0:n(e,t)}function o(e,t){return null!=e?e:i.tot(t)}function a(e){return null!=e}t.map=r,t.mapTry=function(e,t){try{return r(e(),t)}catch(e){return}},t.map2=s,t.orElse=o,t.mapOr=function(e,t,n){return null==e?n():t(e)},t.map2Or=function(e,t,n,i){return o(s(e,t,n),i)},t.defined=a,t.allDefined=function(e){return null!=e&&e.every(a)},t.firstDefined=function(...e){return e.find(a)},t.denull=function(e){return null==e?void 0:e},t.nulled=function(e){return null==e?null:e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(3),r=n(94),s=n(186),o=n(45),a=n(0),u=n(51),l=n(83),c=n(19),d=n(7);function h(e){return s.isList(e)&&e.length>0&&e.some(e=>null!=e)}function f(e){return!h(e)}function p(e){return u.isPrimitive(e)||u.isPrimitiveArray(e)?e:e.valueOf()}function m(e,t=[]){if(null==e)return t;for(const n of e)null!=n&&(Array.isArray(n)?t.push(...S(n)):t.push(n));return t}function g(e,t){const n=e.map((e,n)=>({ea:e,cmp:m([t(e),n])})).sort((e,t)=>u.cmp(e.cmp,t.cmp));for(let t=0;t<e.length;t++)e[t]=n[t].ea;return e.length=n.length,e}function y(e,t){return c.toA(e).filter(e=>null!=e).map((e,n)=>({item:e,cmp:a.map(t(e),e=>[e,n])})).filter(e=>null!=e.cmp).sort((e,t)=>u.cmp(e.cmp,t.cmp)).map(e=>e.item)}function v(e,t){return null!=e&&null!=t&&e.length===t.length&&e.every((e,n)=>e===t[n])}function b(e,t,n){if(t===n||t<0||n<0||t>=e.length||n>=e.length)return e;const i=e[t];return e.splice(t,1),e.splice(n,0,i),e}function w(e,t){if(null==e)return!1;for(const n of e)if(t.valueOf()===n.valueOf())return!0;return!1}function S(e){if(null==e)return[];const t=c.toA(e);return t.every(a.defined)?t:t.filter(a.defined)}t.isNotEmpty=h,t.isEmpty=f,t.mapArray=function(e,t){return Array.isArray(e)?t(e):void 0},t.mapNotEmpty=function(e,t){return h(e)?t(e):void 0},t.flatten=m,t.sort=function(e){return g(S(e),p)},t.sortByInPlace=g,t.sorted=function(e){return e.every((t,n)=>0===n||t>e[n-1])},t.sortBy=y,t.deepSortBy=function e(t,n){return y(t,n).map(t=>r.isIterable(t)?e(t,n):t)},t.arrayEql=v,t.startsWith=function(e,t){return v(e.slice(0,t.length),t)},t.filterInPlace=function(e,t){for(let n=0;n<e.length;)t(e[n],n,e)?n++:e.splice(n,1);return e},t.move=b,t.includes=w,t.indexOf=function(e,t){if(null==e)return;let n=0;for(const i of e){if(t(i,n))return n;n++}},t.includesAll=function(e,t){return null!=e&&null!=t&&t.every(t=>w(e,t))},t.pushUniq=function(e,t){return w(e,t)||e.push(t),e},t.insertAt=function(e,t,...n){return e.splice(t,0,...n),e},t.insertUniq=function(e,t,n){for(let t=0;t<e.length-1;t++)if(n(e[t],e[t+1])>0)throw new Error("badly sorted array: "+e);for(let i=0;i<e.length;i++){const r=n(e[i],t);if(0===r)return e;if(r>0)return e.splice(i,0,t),e}return e.push(t),e},t.compact=S;const M=["","null","undefined"];function P(e,t=(e=>JSON.stringify(e))){if(f(e))return[];const n=new Map;return e.forEach(e=>a.map(e,e=>o.getOrSet(n,t(e),()=>e))),[...n.values()]}function E(e,t,n=1,i=(e=>e)){const r=[];if(e<t)for(let s=e;s<t;s+=n)r.push(i(s));else for(let s=e;s>t;s-=n)r.push(i(s));return r}t.compactBlankish=function(e){return c.toA(e).filter(e=>i.notBlank(e)&&!M.includes(d.toS(e).trim()))},t.compactBlanks=function(e){return null==e?[]:e.map(e=>d.toS(e).trim()).filter(e=>e.length>0)},t.uniq=function(e){return P(S(e),e=>JSON.stringify(e))},t.uniqBy=P,t.clear=function(e){return e.length=0,e},t.count=function(e,t){return e.reduce((e,n,i)=>e+(t(n,i)?1:0),0)},t.sum=function(e,t){return e.reduce((e,n,i)=>e+t(n,i),0)},t.firstMatch=function(e,t){for(const n of S(t)){const t=e.exec(n);if(null!=t)return t}},t.commonPrefixLength=function(e,t){if(null==e||null==t)return 0;if(e===t)return e.length;if("string"==typeof e&&(e=e.split("")),"string"==typeof t&&(t=t.split("")),v(e,t))return e.length;let n=0;for(;e[n]===t[n];)n++;return n},t.anneal=function({array:e,expense:t,allowedDelta:n}){const i=Math.round(n);if(i<2)return e;for(let n=0;n<e.length-1;n++){const r=l.randomInt(Math.max(0,n-i),Math.min(e.length,n+i),[n]);if(null==r)continue;const s=Math.max(0,Math.min(r,n)-1),o=Math.min(e.length,Math.max(r,n)+1),a=t(e,s,o);b(e,n,r);const c=t(e,s,o);u.lt(a,c)&&b(e,r,n)}return e},t.range=function(e,t,n=(e=>e)){return E(e,t,1,n)},t.stepRange=E},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0);t.lazy=function(e,t){let n,r=0;const s=[];function o(e){return r=Date.now(),n=e,s.forEach(e=>e(n)),n}function a(){return(0===r||null!=t&&r+t<=Date.now())&&o(e()),n}return a.clear=()=>{const e=n;return r=0,n=void 0,s.forEach(e=>e(n)),e},a.set=e=>o(e),a.prior=()=>n,a.refresh=()=>o(e()),a.ttl=()=>t,a.setTTL=e=>t=e,a.onChange=e=>{s.push(e),i.map(n,e)},a.toJSON=()=>"(Lazy)",a}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(46),s=n(19),o=n(7);function a(e){if(null==e)return!0;const t=o.toS(e);return 0===t.length||0===t.trim().length}function u(e){return!a(e)}function l(e,t){if(!1===e||null==e||""===e)return;const n=o.toS(e);return u(n)?t(n):void 0}t.blank=a,t.notBlank=u,t.ifNotBlank=function(e){if(null==e)return;const t=o.toS(e);return 0===t.length||0===t.trim().length?void 0:t},t.notBlankOr=function(e,t){if(null==e)return r.tot(t);const n=o.toS(e).trim();return n.length>0?n:r.tot(t)},t.notBlankAnd=function(e,t){return!a(e)&&t(e)},t.mapNotBlank=l,t.mapNotBlankOr=function(e,t,n){return i.orElse(l(e,t),n)},t.firstNotBlank=function(...e){return s.toA(e).find(e=>u(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(2),r=n(0),s=n(31),o=n(221),a=n(155),u=n(72),l=n(195),c=n(115),d=n(11);t.rootLogger=i.lazy(()=>a.ConsoleLogger.instance()),t.safeRootLogger=i.lazy(()=>u.safeLogger(t.rootLogger())),t.rootLogger.onChange(()=>t.safeRootLogger.clear()),t.alsoLogToConsole=function(){t.rootLogger.set(t.rootLogger()===a.ConsoleLogger.instance()?t.rootLogger():new o.CompoundLogger(t.rootLogger(),a.ConsoleLogger.instance()))},t.setLoggerProcessName=function(e,n=d.Settings.logDir.valueOrDefault){c.setProcessName(e);const i=t.rootLogger.prior();if(null!=i&&i instanceof l.LogWriter&&i.logDir.eql(n))return;r.map(t.rootLogger.prior(),e=>e.close());const u=new l.LogWriter(s.BaseFile.for(n));t.rootLogger.set(d.Settings.logStdout.valueOrDefault?new o.CompoundLogger(u,a.ConsoleLogger.instance()):u)},t.mkLogger=function(e){return new u.ContextualLogger(e,t.rootLogger)},t.mkSafeLogger=function(e){return new u.ContextualLogger(e,t.safeRootLogger)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(3),r=n(0),s=n(33),o=n(15),a=n(46),u=n(7);function l(e){return"number"==typeof e&&isFinite(e)}function c(e,t){return l(e)?t(e):void 0}function d(e){return v(e,e=>{const t=Math.trunc(e);return 0===t?Math.abs(t):t})}function h(e){return s.isFunction(e.toNumber)}function f(e,t){if(i.blank(e))return t.defaultValue;if(l(e))return t.nton(e);if(h(e))return t.nton(e.toNumber());try{const n=t.ston(u.toS(e));return l(n)?t.nton(n):t.defaultValue}catch(e){return t.defaultValue}}function p(e,t){return f(e,Object.assign({defaultValue:void 0,nton:e=>d(e),ston:parseInt},t))}function m(e,t){return f(e,Object.assign({defaultValue:void 0,nton:e=>e,ston:parseFloat},t))}function g(e){return l(e)&&e>0}function y(e,t){return o.Opt(e).flatMap(e=>p(e)).flatMap(t).get()}function v(e,t){return l(e)?t(e):void 0}function b(e){return e<0?-Math.round(-e):Math.round(e)}function w(e,t){if(null==e)return 0;const n=Math.pow(10,t);return b(e*n)/n}t.isNumber=l,t.mapFinite=c,t.finiteOrElse=function(e,t){return l(e)?e:t},t.diff=function(e,t){return l(e)&&l(t)?e-t:void 0},t.absdiff=function(e,t){return l(e)&&l(t)?Math.abs(e-t):void 0},t.closeTo=function(e,t,n){return null!=e&&null!=t&&Math.abs(e-t)<n},t.trunc=d,t.isToNumber=h,t.toInt=p,t.toFloat=m,t.toGt0=function(e){const t=p(e);return null!=t&&t>0?t:void 0},t.gt0=g,t.gtOrElse=function(e,t){return l(e)&&l(t)&&e>t?e:void 0},t.gte0=function(e){return l(e)&&e>=0},t.mapInt=y,t.mapFloat=function(e,t){return o.Opt(e).flatMap(e=>m(e)).flatMap(t).get()},t.id=function(e){const t=p(e);return g(t)?String(t):void 0},t.mapIntOr=function(e,t,n){return r.orElse(y(e,t),n)},t.mapNumeric=v,t.map2Numeric=function(e,t,n){return v(e,e=>v(t,t=>n(e,t)))},t.mapNumericOr=function(e,t,n){return l(e)?t(e):n},t.numericOr=function(e,t){return l(e)?e:a.tot(t)},t.round=b,t.toPrecisionMaybe=function(e,t){return c(e,e=>w(e,t))},t.toFixed=function(e,t){try{return v(e,e=>b(e*Math.pow(10,t))/Math.pow(10,t))}catch(e){return}},t.toPrecision=w,t.sigFigs=function(e,t){if(0===e||0===t)return 0;const n=Math.pow(10,t-b(Math.ceil(Math.log10(Math.abs(e)))));return b(e*n)/n},t.base2Ceil=function(e){return Math.pow(2,Math.ceil(Math.log2(e)))},t.base10Ceil=function(e){return Math.pow(10,Math.ceil(Math.log10(e)))},t.clamp=function(e,t,n){return l(n)?([e,t]=[Math.min(e,t),Math.max(e,t)],Math.max(e,Math.min(n,t))):b((e+t)/2)},t.times=function(e,t){if(!g(e))return[];const n=Math.round(e);return n<=0?[]:[...Array(n)].map((e,n)=>t(n))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(2),r=n(15),s=n(0);t.secondMs=1e3,t.minuteMs=60*t.secondMs,t.hourMs=60*t.minuteMs,t.dayMs=24*t.hourMs,t.weekMs=7*t.dayMs;const o=i.lazy(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));t.fmtDateShort=function(e){return r.Opt(e).flatMap(e=>e instanceof Date?e.getTime():e).map(e=>o().format(e)).get()},t.splitHMS=function(e){return s.mapOr(/^[0:]{1,4}/.exec(e),t=>[t[0],e.substr(t[0].length)],()=>["",e])}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toS=function e(t){return null==t?"":"string"==typeof t?t:Array.isArray(t)?t.map(e).join(","):t.toString()}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(30),s=n(1),o=n(6),a=n(38),u=n(0),l=n(5),c=n(33),d=n(15),h=n(12),f=n(23),p=n(14),m=n(22),g=n(213),y=n(52);var v=n(49);function b(e){return i(this,void 0,void 0,(function*(){try{return yield e,!0}catch(e){return!1}}))}function w(e,t,n=(()=>{}),r=(()=>{})){return i(this,void 0,void 0,(function*(){let i,s=!1,o=!1;return yield Promise.race([g.asPromise(e).then(e=>o?void 0:(i=e,s=!0,e)),a.unrefDelay(t).then(()=>{s||(o=!0)})]),s?yield r(i):yield n(),i}))}function S(e,n,r=t.DefaultMaxConcurrent){return i(this,void 0,void 0,(function*(){return(yield y.withBoundedConcurrency({name:"tuples",laters:e.map((e,t)=>()=>i(this,void 0,void 0,(function*(){return[yield n(e,t),e]}))),maxConcurrent:r})).filter(([e,t])=>null!=e&&null!=t)}))}t.thenMap=v.thenMap,t.DefaultMaxConcurrent=8,t.resolvedThen=function(e,t){return i(this,void 0,void 0,(function*(){if(null==e)return Promise.resolve(void 0);try{return yield e,t()}catch(e){return}}))},t.resolvedWithin=function(e,t){return Promise.race([e,a.delay(t).then(()=>{})])},t.resolved=b,t.rejected=function(e){return i(this,void 0,void 0,(function*(){return!(yield b(e))}))},t.thenDefined=function(e){return i(this,void 0,void 0,(function*(){return null!=(yield e)}))},t.allSerial=function(e){return i(this,void 0,void 0,(function*(){const t=[];for(const n of s.compact(e))t.push(yield n());return s.compact(t)}))},t.awaitAll=function(e){return i(this,void 0,void 0,(function*(){const t=s.compact(e);return s.isEmpty(t)?void 0:Promise.all(t).then(()=>{})}))},t.thenFlatten=function(e){return i(this,void 0,void 0,(function*(){return null==e?[]:s.flatten(s.compact(yield Promise.all(e)))}))},t.thenCompact=function(e){return i(this,void 0,void 0,(function*(){const t=s.compact(e);return s.isEmpty(t)?[]:s.compact(yield Promise.all(t))}))},t.asyncFind=function(e,t){return i(this,void 0,void 0,(function*(){for(const n of e)if(yield t(n))return n}))},t.asyncFilter=function(e,n,r=t.DefaultMaxConcurrent){return i(this,void 0,void 0,(function*(){return(yield S(s.compact(e),n,r)).filter(([e])=>e).map(([,e])=>e)}))},t.partitionAsync=function(e,t){return i(this,void 0,void 0,(function*(){const n=yield S(e,t);return[n.filter(([e])=>f.isTrue(e)).map(([,e])=>e),n.filter(([e])=>!f.isTrue(e)).map(([,e])=>e)]}))},t.tryAsync=function(e){return i(this,void 0,void 0,(function*(){try{return yield e()}catch(e){return}}))},t.DefaultTryAllTimeoutMs=30*o.secondMs,t.tryAll=function(e,n=(e=>console.error(e)),r=t.DefaultTryAllTimeoutMs){return i(this,void 0,void 0,(function*(){for(const t of e)try{yield w(t,r)}catch(e){n(e)}}))},t.thenFinally=function(e,t=(()=>{}),n=(()=>{})){return i(this,void 0,void 0,(function*(){let i,r=null;try{i=yield c.isFunction(e)?e():e}catch(e){r=e;try{yield t(e)}catch(e){}}try{yield n(null!=r?r:i)}catch(e){}if(null!=r)throw r;return i}))},t.thenNot=function(e,t=!0){return i(this,void 0,void 0,(function*(){if(null==e)return t;const n=yield e;return null==n?t:!f.isTrue(n)}))},t.thenMap2=function(e,t,n){return i(this,void 0,void 0,(function*(){const i=yield e;if(null==i)return;const r=yield t;return null!=r?n(i,r):void 0}))},t.thenMapOr=function(e,t,n){return i(this,void 0,void 0,(function*(){const i=yield e;if(null==i)return n();const r=yield t(i);return null==r?n():r}))},t.thenAnd=function(e,t){return i(this,void 0,void 0,(function*(){return null!=e&&(yield e)?t():void 0}))},t.thenOrElse=function(e,t){return i(this,void 0,void 0,(function*(){return u.orElse(yield e,t)}))},t.first=function(e,t){return i(this,void 0,void 0,(function*(){if(null!=e){let n=-1;for(const i of e){n++;try{if(null==i)continue;const e=yield t(i,n);if(null!=e)return e}catch(e){}}}}))},t.firstDefinedPromise=function(e,t=m.identity){return i(this,void 0,void 0,(function*(){for(const n of e){const e=yield n();if(null!=e){const n=yield t(e);if(null!=n)return n}}}))},t.firstResolvedDefinedPromise=function(e,t){return i(this,void 0,void 0,(function*(){for(const n of e)try{const e=yield n();if(null!=e)return e}catch(e){t(e)}}))},t.firstTruePromise=function(e,...t){return i(this,void 0,void 0,(function*(){for(const n of t)try{const t=yield n();if(null!=t&&!0===(yield e(t)))return t}catch(e){}}))},t.until=function(e,t,n){return i(this,void 0,void 0,(function*(){const i=Date.now(),s=p.mapGt0(t,e=>i+e),c=u.orElse(n,()=>u.orElse(t,30*o.secondMs)/10),d=l.clamp(100,10*o.secondMs,c);for(;null==s||Date.now()<s;){const t=yield e();if(!0===t)return!0;if(null!=t&&!1!==t)throw new Error("f must return a boolean, but returned "+r.inspect(t));yield a.delay(d)}return!1}))},t.untilDefined=function(e,{timeoutMs:t,timeBetweenMs:n}){return i(this,void 0,void 0,(function*(){const i=p.mapGt0(t,e=>Date.now()+e),r=d.Opt(n).getOrElse(()=>u.orElse(t,3e4)/10),s=l.clamp(50,1e4,r);for(;null==i||Date.now()<i;){const t=yield e();if(null!=t)return t;yield a.delay(s)}}))},t.thenOrTimeout=w,t.tuples=S,t.thenGreatest=function(e,t){return i(this,void 0,void 0,(function*(){return u.map(h.greatestBy(yield S(e,t),e=>e[0]),e=>e[1])}))},t.sortByAsync=function(e,t){return i(this,void 0,void 0,(function*(){return s.sortBy(yield S(e,t),e=>e[0]).map(e=>e[1])}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(0),o=n(5),a=n(7),u=n(12),l=n(208);var c=n(98);t.ensurePrefix=c.ensurePrefix,t.ensureSuffix=c.ensureSuffix,t.newlineRe=c.newlineRe,t.wrap=c.wrap,t.isString=function(e){return"string"==typeof e};const d={};function h(e,t){if(t<1)return"";for(null==d[e]&&(d[e]=e);t>d[e].length;)d[e]+=e;return d[e].substring(0,t)}function f(e,t){const n=[];let i,r=0;for(;null!=(i=t.exec(e));)i.index===t.lastIndex?t.lastIndex++:(n.push(e.substring(r,i.index)),n.push(i[0]),r=t.lastIndex=i[0].length+i.index);return r<e.length&&n.push(e.substring(r)),n}function p(e){return e.sort((e,t)=>e.valueOf().localeCompare(t.valueOf()))}t.leftPad=function e(t,n,i){if(0===i.length)throw new Error("leftPad() given empty pad");if("number"==typeof t&&t<0)return"-"+e(String(-t),n-1,i);const r=String(t);return h(i,n-r.length)+r},t.padding=h,t.padReplace=function(e,t,n,i){return e.substr(0,t)+h(i,n)+e.substr(t+n)},t.contains=function(e,t,n){return a.toS(e).indexOf(a.toS(t),n)>-1},t.count=function e(t,n,i=0){if(null==n||0===n.length)return 0;const r=t.indexOf(n,i);return-1===r?0:1+e(t,n,r+n.length)},t.replaceAll=function(e,t,n){return e.split(t).join(n)},t.maybeToS=function(e){return null==e?void 0:String(e)},t.mapParse=function(e,t){if(r.notBlank(e))try{return t(JSON.parse(e))}catch(e){}},t.trim=function(e){return e.map(a.toS).filter(e=>r.notBlank(e))},t.splitFirst=function(e,t){const n=e.indexOf(t);return-1==n?[e]:[e.slice(0,n),e.slice(n+t.length)]},t.splitEvery=function(e,t,n){const i=Math.min(Math.ceil(e.length/t),s.orElse(n,()=>e.length))-1;return i<=0?[e]:[...o.times(i,n=>e.slice(n*t,(n+1)*t)),e.slice(i*t)]},t.splitKeep=function(e,t,n=!0){const i=[];let r,s=0;for(;null!=(r=t.exec(e));)if(r.index===t.lastIndex)t.lastIndex++;else{t.lastIndex=r[0].length+r.index;const o=n?r.index:t.lastIndex;i.push(e.substring(s,o)),s=o}return s<e.length&&i.push(e.substring(s)),i},t.splitWith=f,t.removeCapture=function(e,t){const n=t.exec(e);if(null==n||null==n[1])return e;const i=n.index+n[0].length,r=i-n[1].length;return e.substr(0,r)+e.substr(i)},t.stripPrefix=function(e,t){const n=a.toS(e),i=a.toS(t);return i.length>0&&n.startsWith(i)?n.slice(i.length):n},t.stripPrefixIgnoreCase=function(e,t){const n=a.toS(e),i=a.toS(t);return i.length>0&&n.toLowerCase().startsWith(i.toLowerCase())?n.slice(i.length):n},t.stripSuffix=function(e,t){const n=a.toS(e),i=a.toS(t);return i.length>0&&n.endsWith(i)?n.slice(0,-i.length):n},t.stripPreSuff=function(e,t,n){return(e=a.toS(e)).endsWith(n)&&e.startsWith(t)?e.slice(t.length,-n.length):e},t.ellipsize=function(e,t=80){if(null==e)return"";const n=a.toS(e);return n.length<=t?n:n.slice(0,t-1)+"â¦"},t.gist=function(e,t=80,n=80){const i=a.toS(e),r=i.length-(t+n);return r<=0?i:i.slice(0,t).trim()+" â¦(+"+r+" chars)â¦"+i.slice(-n).trim()},t.capitalize=function(e){const t=(e=a.toS(e)).normalize().split("");return r.blank(e)?e:t[0].toLocaleUpperCase()+t.slice(1).join("")},t.equalsIgnoreCase=function(e,t){return null!=e&&null!=t&&a.toS(e).toLowerCase()===a.toS(t).toLowerCase()},t.startsWithIgnoreCase=function(e,t){return null!=e&&null!=t&&e.toLowerCase().normalize().startsWith(t.toLowerCase().normalize())},t.includesIgnoreCase=function(e,t){const n=a.toS(t).trim().toLowerCase().normalize();return!i.isEmpty(e)&&0!==n.length&&e.map(e=>a.toS(e).trim().toLowerCase().normalize()).filter(r.notBlank).some(e=>n.includes(e))},t.reverse=function(e){return null==e?e:e.split("").reverse().join("")},t.localeSort=p,t.sortChars=function(e){return p(e.split("")).join("")},t.longestPrefix=function(e,t){return u.greatestBy(t.filter(t=>e.startsWith(t)),e=>e.length)},t.stripAnsiEsc=function(e){return a.toS(e).replace(/\u001b\[[0-9;]+[a-z]/gi,"")};const m=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function g(e){return m.reduce((e,[t,n])=>e.replace(t,n),e).normalize()}t.dumbquote=g;const y=/^(['"]).+\1$/;function v(e,t=!0){return i.flatten(f(t?a.toS(e).toLowerCase():a.toS(e),/\S*\d*\S*/g).map(e=>f(e,/\d+/g))).filter(e=>null!=e&&e.length>0).map(e=>s.orElse(o.toInt(e),()=>e))}t.stripQuotes=function(e){return r.blank(e)||(e=a.toS(e).trim(),null!=y.exec(g(e))&&(e=e.slice(1,-1).trim())),e},t.wbrPath=function(e){return e.split(/(?<=[\\\/_,:=-]+)/).map(e=>l.escape(e.normalize())).join("<wbr>")},t.escapeRegExp=function(e){return a.toS(e).replace(/[?.()[\]{}*^+|$]/g,"\\$&")},t.zipStrings=function(...e){let t="";const n=i.compactBlanks(e),r=Math.max(...n.map(e=>e.length));for(let e=0;e<r;e++)for(let i=0;i<n.length;i++)s.map(n[i],n=>s.map(n[e],e=>t+=e));return t},t.joinEng=function(e){return(e=i.compactBlanks(e)).length<2?e.join(""):e.slice(0,-1).join(", ")+" or "+e[e.length-1]},t.sortNatural=function(e,t){return i.sortBy(e,e=>v(e,t))},t.sortNaturalBy=v},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(0),o=n(33);function a(e){return null==e||"object"!=typeof e?[]:Object.keys(e).filter(t=>"string"==typeof t&&(null==e.propertyIsEnumerable||e.propertyIsEnumerable(t)))}function u(e){return a(e).map(t=>e[t])}function l(e){return a(e).map(t=>[t,e[t]])}function c(e,t={}){return"object"!=typeof t&&(t={}),i.compact(e).reduce((e,[t,n])=>h(e,()=>{null!=t&&null!=n&&(e[t]=n)}),t)}function d(e){return u(e).every(e=>null!=e)}function h(e,t){return null!=t?t(e):"string"==typeof e?console.log(e):console.dir(e,{depth:3}),e}t.emptyObj=function(e){return i.isEmpty(a(e))},t.keys=a,t.values=u,t.compactValues=function(e){const t=l(e).filter(([e,t])=>null!=e&&null!=t);return i.isEmpty(t)?void 0:c(t)},t.entries=l,t.fromEntries=c,t.mapFields=function(e,t,n={}){return c(i.compact(l(e).map(([e,n])=>t(e,n))).filter(([e,t])=>null!=e&&null!=t),n)},t.pick=function(e,...t){if(null==e)return e;if(!t.every(e=>"string"==typeof e))throw new Error("bad keys: "+JSON.stringify(t));return i.isEmpty(t)?{}:t.reduce((t,n)=>h(t,()=>s.map(e[n],e=>t[n]=e)),{})},t.pickFirst=function(e,t,n=s.defined){if(null!=e)for(const i of t)if(n(e[i]))return e[i]},t.without=function(e,...t){if(null==e||t.every(t=>r.blank(e[t])))return e;const n=l(e).filter(([e])=>!t.includes(e));return i.isEmpty(n)?void 0:c(n)},t.reqValued=d,t.reqValuedOrElse=function(e){return d(e)?e:void 0},t.mapReqValued=function(e,t){return d(e)?t(e):void 0},t.onlyReqValued=function(e){return e.filter(d)},t.sortedKeys=function(e){return c(i.sortBy(l(e),([e])=>e))},t.filter=function(e,t){return null==e?e:c(l(e).filter(([e,n])=>t(e,n)))},t.tap=h,t.allKeys=function(e){const t=a(e);for(;null!=(e=Reflect.getPrototypeOf(e));)t.push(...Reflect.ownKeys(e).filter(e=>"string"==typeof e));return i.uniq(t)},t.maybeCall=function(e,t,...n){return null!=e&&o.isFunction(e[t])?e[t].bind(e)(...n):void 0},t.firstValueCaseInsensitive=function(e,t){if(r.blank(t))return;if(null!=e[t])return e[t];const n=t.toLocaleLowerCase().normalize();for(const t of a(e))if(n===t.toLocaleLowerCase().normalize()&&null!=e[t])return e[t]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(44),r=n(34),s=n(18),o=n(1),a=n(3),u=n(6),l=n(168),c=n(2),d=n(0),h=n(10),f=n(36),p=n(40),m=n(108),g=n(109),y=n(12),v=n(23),b=n(209),w=n(27),S=n(26),M=n(210),P=n(16),E=n(150),x=n(47),_=n(139);function F(e){const n=(a.blank(e)?"":e).split(r.delimiter);if(P.isWin&&a.blank(s.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return n.push(...t.DefaultPaths),o.uniq(n).filter(a.notBlank).join(r.delimiter)}function T(e){const n={};t.settingsForChildProcs().forEach(e=>e.maybeAddToEnv(n));const i=h.compactValues(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},s.env),{NODE_ENV:S.nodeEnv}),P.isElectron?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}),{PATH:t.pathWithDefaults()}),n),d.orElse(e,{})));return t.Settings.logStdout.deleteFromEnv(i),i}t.Settings={libraryPath:new _.MaybeStringSetting({name:"libraryPath",key:"PS_LIBRARY_PATH",alternateKeys:["PS_LIBRARY","PS_LIBRARY_DIR"],category:_.SettingCategories.System,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>S.isTest?"/home/test/Pictures":p.App.getPath("pictures"),persisted:!0,advanced:()=>!1,addToChildProcs:!0}),pidfile:new _.MaybeStringSetting({name:"pidfile",key:"PIDFILE",category:_.SettingCategories.System,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid",persisted:!0,addToChildProcs:!1}),cacheDir:new _.StringSetting({name:"cacheDir",key:"PS_CACHE_DIR",category:_.SettingCategories.Logging,description:"Where would you like PhotoStructure's scratch file directory? This should be a fast, local disk with several gigabytes free.",exampleValue:()=>S.isTest?"/tmp/ps_cache_dir":b.cacheDir(),defaultValue:()=>b.cacheDir(),persisted:!0,addToChildProcs:!0}),logLevel:new _.StringSetting({name:"logLevel",key:"PS_LOG_LEVEL",alternateKeys:["PS_LOG","LOG"],category:_.SettingCategories.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', or 'error'.",defaultValue:()=>S.isProd?"error":"info",persisted:!0,addToChildProcs:!0}),logDir:new _.StringSetting({name:"logDir",key:"PS_LOG_DIR",category:_.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>P.isMac?w.resolve(i.homedir(),"Library","Logs",g.AppName):w.resolve(m.appData(),g.AppName,"logs"),exampleValue:()=>S.isTest?"/var/log/photostructure":void 0,persisted:!0,addToChildProcs:!0}),logColor:new _.BooleanSetting({name:"logColor",key:"PS_LOG_COLOR",category:_.SettingCategories.Logging,description:"Should log messages be colorized with ANSI escape sequences? Great for nerds, bad for everyone else.",defaultValue:()=>!S.isProd,persisted:!0}),logCompression:new _.BooleanSetting({name:"logCompression",key:"PS_LOG_COMPRESS",category:_.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>S.isProd,persisted:!0}),logElapsedMs:new _.BooleanSetting({name:"logElapsedMs",key:"PS_LOG_ELAPSED_MS",category:_.SettingCategories.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!S.isProd,persisted:!0}),logWebRequests:new _.BooleanSetting({name:"logWebRequests",key:"PS_LOG_WEB_REQUESTS",category:_.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1,persisted:!0}),logWebDir:new _.MaybeStringSetting({name:"logWebDir",key:"PS_LOG_WEB_DIR",category:_.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir.",persisted:!0,addToChildProcs:!0}),logSql:new _.MaybeStringSetting({name:"logSql",key:"PS_LOG_SQL",category:_.SettingCategories.Logging,description:"If non-blank, and a given db query includes the given string, the query will be logged.",persisted:!0}),logStdout:new _.BooleanSetting({name:"logStdout",key:"PS_LOG_STDOUT",alternateKeys:["LOG_STDOUT","PS_STDOUT"],category:_.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,persisted:!1}),maxBusyDbMs:new _.IntegerSetting({name:"maxBusyDbMs",key:"PS_MAX_BUSY_DB_MS",category:_.SettingCategories.System,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 30 seconds, which seems like a long time, but hard drives and network filesystems can take > 20 seconds just to spin up if asleep.",defaultValue:30*u.secondMs,persisted:!0}),dbTimeoutMs:new _.IntegerSetting({name:"dbTimeoutMs",key:"PS_DB_TIMEOUT_MS",category:_.SettingCategories.System,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks.",defaultValue:()=>1e3,persisted:!0}),probationMs:new _.IntegerSetting({name:"probationMs",key:"PS_PROBATION_MS",category:_.SettingCategories.System,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*u.minuteMs,persisted:!0}),minTimeBetweenServiceRestartsMs:new _.IntegerSetting({name:"minTimeBetweenServiceRestartsMs",key:"PS_MIN_TIME_BETWEEN_SERVICE_RESTARTS_MS",category:_.SettingCategories.System,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*u.secondMs,persisted:!0}),fatalErrorRatePerMinute:new _.IntegerSetting({name:"fatalErrorRatePerMinute",key:"PS_FATAL_ERROR_RATE_PER_MINUTE",category:_.SettingCategories.System,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busy failing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10,persisted:!0}),autoLaunch:new _.BooleanSetting({name:"autoLaunch",key:"PS_AUTO_LAUNCH",category:_.SettingCategories.System,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!P.isElectron,persisted:!0}),minDiskFreeGb:new _.IntegerSetting({name:"minDiskFreeGb",key:"PS_MIN_DISK_FREE_GB",category:_.SettingCategories.System,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6,persisted:!0}),maxCpus:new _.BoundedIntegerSetting({name:"maxCpus",key:"PS_MAX_CPUS",category:_.SettingCategories.System,description:"This is the upper limit of sync-file jobs that PhotoStructure will spin up concurrently. Each sync-file job may run several threads in parallel, so the number of runnable processes will actually exceed system CPU count, but with a low priority to ensure your system is still responsive. If memory on this machine is limited, this value will automatically be reduced to prevent exhausting system memory.",defaultValue:()=>i.cpus().length,exampleValue:()=>S.isTest?5:i.cpus().length,min:1,max:64,persisted:!0}),processPriority:new _.StringEnumSetting({name:"processPriority",key:"PS_PROCESS_PRIORITY",category:_.SettingCategories.System,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>E.PriorityClasses.BelowNormal,validValues:E.PriorityClasses.values,persisted:!0}),maxMemoryMb:new _.BoundedIntegerSetting({name:"maxMemoryMb",key:"PS_MAX_MEMORY_MB",category:_.SettingCategories.System,description:"PhotoStructure will restart services if their process consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:512,max:8e3,persisted:!0}),pollIntervalMs:new _.IntegerSetting({name:"pollIntervalMs",key:"PS_POLL_INTERVAL_MS",category:_.SettingCategories.System,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>S.isProd?30*u.secondMs:100,persisted:!0}),copyAssetsToLibrary:new _.BooleanSetting({name:"copyAssetsToLibrary",key:"PS_COPY_ASSETS",category:_.SettingCategories.System,description:"Should PhotoStructure copy photos and videos to your PhotoStructure Library?",defaultValue:!0,advanced:()=>!1,persisted:!0}),scanAllDrives:new _.BooleanSetting({name:"scanAllDrives",key:"PS_SCAN_ALL_DRIVES",category:_.SettingCategories.System,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1,persisted:!0}),scanMyPictures:new _.BooleanSetting({name:"scanMyPictures",key:"PS_SCAN_MY_PICTURES",category:_.SettingCategories.System,description:"Should PhotoStructure only scan your system's 'Pictures' folder for photos and videos?",defaultValue:!1,advanced:()=>!1,persisted:!0}),hostScanPaths:new _.StringArraySetting({name:"hostScanPaths",key:"PS_HOST_SCAN_PATHS",category:_.SettingCategories.System,description:"This is only valid within docker, and holds an array of absolute paths that have been mounted to the host service through a VOLUME. Paths may be separated with 'Â¦'",persisted:!1,addToChildProcs:!0}),scanPaths:new _.StringArraySetting({name:"scanPaths",key:"PS_SCAN_PATHS",category:_.SettingCategories.System,description:"This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting (like \"/path/one:/path/two\") or JSON encoding (like \"['/path/one','/path/two']\").",advanced:()=>!1,exampleValue:()=>S.isTest?["/path/one","/path/two"]:[p.App.getPath("pictures")],persisted:!0}),dbBackupsCount:new _.IntegerSetting({name:"dbBackupsCount",key:"PS_DB_BACKUPS_COUNT",category:_.SettingCategories.Db,description:"How many prior backups should PhotoStructure retain? This should be a power of 2, as we use a towers of hanoi algorithm to retain both recent and older backups.",defaultValue:32,persisted:!0}),dbBackupFrequencyMinutes:new _.IntegerSetting({name:"dbBackupFrequencyMinutes",key:"PS_DB_BACKUP_FREQUENCY_MINUTES",category:_.SettingCategories.Db,description:"How many minutes should elapse before taking a backup of your library database? You want this to be frequent enough such that data loss isn't too painful, but backups pause sync and can cause the webserver to be momentarily unresponsive. Default is every hour. Set to 0 to disable backups.",defaultValue:60,persisted:!0}),dbCacheSizeMb:new _.IntegerSetting({name:"dbCacheSizeMb",key:"PS_DB_CACHE_SIZE_MB",category:_.SettingCategories.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:128,persisted:!0}),vlcPath:new _.StringSetting({name:"vlcPath",key:"PS_VLC_PATH",category:_.SettingCategories.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc",persisted:!0}),ffmpegPath:new _.StringSetting({name:"ffmpegPath",key:"PS_FFMPEG_PATH",category:_.SettingCategories.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH.',defaultValue:"ffmpeg",persisted:!0}),updateChannel:new _.StringEnumSetting({name:"updateChannel",key:"PS_UPDATE_CHANNEL",category:_.SettingCategories.Updates,description:'TL:DR; keep this on "latest." This controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds will not have been thoroughly tested. Please only consider changing this if customer support asks you to.',defaultValue:M.channel,validValues:["alpha","beta","latest"],persisted:!0}),allowDowngrade:new _.BooleanSetting({name:"allowDowngrade",key:"PS_ALLOW_DOWNGRADE",category:_.SettingCategories.Updates,description:"If you're running an alpha or beta build, and you switch back to 'updateChannel = \"latest\"', would you like PhotoStructure to downgrade you? Note that enabling this may make your library unreadable, if the current stable version of PhotoStructure can't read new alpha or beta database schemas.",defaultValue:!1,persisted:!0}),updateOnLaunch:new _.BooleanSetting({name:"updateOnLaunch",key:"PS_UPDATE_ON_LAUNCH",category:_.SettingCategories.Updates,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0,persisted:!0}),updateCheckMinutes:new _.IntegerSetting({name:"updateCheckMinutes",key:"PS_UPDATE_CHECK_MINUTES",category:_.SettingCategories.Updates,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:1440,persisted:!0}),bounceMinutes:new _.IntegerSetting({name:"bounceMinutes",key:"PS_BOUNCE_MINUTES",category:_.SettingCategories.Updates,description:"PhotoStructure will bounce the web and sync processes periodically. The default is every 5 hours. Set to -1 to disable.",defaultValue:300,persisted:!0}),email:new _.MaybeStringSetting({name:"email",key:"PS_EMAIL",category:_.SettingCategories.Reporting,description:"If set, this email will be added to error reports, so we can contact you to help debug the issue. It is not required.",exampleValue:()=>"email@example.com",advanced:()=>!1,persisted:!0}),reportErrors:new _.BooleanSetting({name:"reportErrors",key:"PS_REPORT_ERRORS",category:_.SettingCategories.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1,persisted:!0}),maxErrorsPerDay:new _.IntegerSetting({name:"maxErrorsPerDay",key:"PS_MAX_ERRORS_PER_DAY",category:_.SettingCategories.Reporting,description:"Set this to zero to remove all bugs in PhotoStructure.\n\nHUR HUR #DADJOKE\n\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3,persisted:!0}),inspect:new _.BooleanSetting({name:"inspect",key:"PS_INSPECT",category:_.SettingCategories.System,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,advanced:()=>!0,persisted:!0}),rpcPort:new _.IntegerSetting({name:"rpcPort",key:"PS_RPC_PORT",category:_.SettingCategories.Web,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807,persisted:!0,addToChildProcs:!0}),httpPort:new _.IntegerSetting({name:"httpPort",key:"PS_HTTP_PORT",category:_.SettingCategories.Web,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787,persisted:!0,addToChildProcs:!0}),sessionTimeoutHours:new _.BoundedIntegerSetting({name:"sessionTimeoutHours",key:"PS_SESSION_TIMEOUT_HOURS",category:_.SettingCategories.Web,description:"How long should unused HTTP sessions exist before requiring visitors to log back in? This defaults to 180 days, just to maximize convenience.",defaultValue:4320,max:8760,min:1,persisted:!0}),exposeNetworkWithoutAuth:new _.BooleanSetting({name:"exposeNetworkWithoutAuth",key:"PS_EXPOSE_NETWORK_WITHOUT_AUTH",category:_.SettingCategories.Web,description:"Normally the web service is bound to loopback, so your PhotoStructure library is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network (if they know your PhotoStructure port). You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n\n** Don't enable this unless you know what you're doing. **",defaultValue:()=>P.isDocker(),persisted:!0}),assetSubdirectoryDatestampFormat:new _.StringSetting({name:"assetSubdirectoryDatestampFormat",key:"PS_ASSET_SUBDIR_FORMAT",category:_.SettingCategories.Sync,description:"If you chose to copy assets into your library, they will be copied into <library directory>/<result of this pattern>/<original imagename>.\nSee <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.",defaultValue:"y/y-MM-dd",persisted:!0}),validateJpegImages:new _.BooleanSetting({name:"validateJpegImages",key:"PS_VALIDATE_JPEG_IMAGES",category:_.SettingCategories.Sync,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1,persisted:!0}),validateRawImages:new _.BooleanSetting({name:"validateRawImages",key:"PS_VALIDATE_RAW_IMAGES",category:_.SettingCategories.Sync,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1,persisted:!0}),validateVideos:new _.BooleanSetting({name:"validateVideos",key:"PS_VALIDATE_VIDEOS",category:_.SettingCategories.Sync,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!S.isTest,advanced:()=>!1,persisted:!0}),transcodeVideos:new _.BooleanSetting({name:"transcodeVideos",key:"PS_TRANSCODE_VIDEOS",category:_.SettingCategories.Sync,description:"Should videos be transcoded during import? FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0,persisted:!0}),doNotTranscodeMimetypes:new _.StringArraySetting({name:"doNotTranscodeMimetypes",key:"PS_DO_NOT_TRANSCODE_MIMETYPES",category:_.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "[\'video/quicktime\',\'video/mp4\']").',defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"],persisted:!0}),statTimeoutSeconds:new _.BoundedIntegerSetting({name:"statTimeoutSeconds",key:"PS_STAT_TIMEOUT_SECONDS",category:_.SettingCategories.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300,persisted:!0}),startPaused:new _.BooleanSetting({name:"startPaused",key:"PS_START_PAUSED",category:_.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray menu.",defaultValue:!1,persisted:!0}),syncIntervalHours:new _.BoundedIntegerSetting({name:"syncIntervalHours",key:"PS_SYNC_INTERVAL_HOURS",category:_.SettingCategories.Sync,description:"This value controls both how often the sync process runs, and how often new files are discovered and imported. WARNING: Setting this value to a small value (say, less than 10) will mean PhotoStructure is constantly scanning your disks, which may reduce the lifespan of your storage media. Note that setting this and fileSyncIntervalHours to 0 will disable automatic scheduling of the sync process. This defaults to every day (to balance picking up new files automatically and trying to avoid unnecessary wear and tear on your storage media).",defaultValue:24,max:504,min:0,persisted:!0}),fileSyncIntervalHours:new _.BoundedIntegerSetting({name:"fileSyncIntervalHours",key:"PS_FILE_SYNC_INTERVAL_HOURS",category:_.SettingCategories.Sync,description:"This value controls how often the files in your library are checked for changes. The `syncIntervalHours` setting, in contrast, controls how often *new* files are discovered. This defaults to every week (to try to balance picking up changes with wear and tear on your storage media)",defaultValue:168,max:1344,min:0,persisted:!0}),forceSync:new _.BooleanSetting({name:"forceSync",key:"PS_FORCE_SYNC",category:_.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem",defaultValue:!1,persisted:!1}),exitWhenDone:new _.BooleanSetting({name:"exitWhenDone",key:"PS_EXIT_WHEN_DONE",category:_.SettingCategories.Sync,description:"When set, the process will exit after jobs are completed",defaultValue:!1,persisted:!1}),defaultSidecarType:new _.StringEnumSetting({name:"defaultSidecarType",key:"PS_DEFAULT_SIDECAR_TYPE",category:_.SettingCategories.Sync,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:x.SidecarExtsEnum.values,persisted:!0}),writeMetadataToSidecars:new _.BooleanSetting({name:"writeMetadataToSidecars",key:"PS_WRITE_METADATA_TO_SIDECARS",category:_.SettingCategories.Sync,description:"Should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original?",defaultValue:!0,persisted:!0}),overwriteOriginal:new _.BooleanSetting({name:"overwriteOriginal",key:"PS_OVERWRITE_ORIGINAL",category:_.SettingCategories.Sync,description:"Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents.",defaultValue:!1,persisted:!0}),useImageHashes:new _.BooleanSetting({name:"useImageHashes",key:"PS_USE_IMAGE_HASHES",category:_.SettingCategories.Sync,description:"Should image hashes be computed? This slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing",defaultValue:!0,persisted:!0}),minImageCorrPct:new _.BoundedIntegerSetting({name:"minImageCorrPct",key:"PS_MIN_IMAGE_CORR_PCT",category:_.SettingCategories.Sync,description:"This is the minimum image hash correlation value for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 60% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>S.isTest?80:75,max:100,min:0,persisted:!0}),minColorCorrPct:new _.BoundedIntegerSetting({name:"minColorCorrPct",key:"PS_MIN_COLOR_CORR_PCT",category:_.SettingCategories.Sync,description:"This is the minimum correlation found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 40% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>45,max:100,min:0,persisted:!0}),skipAssetFileUpdates:new _.BooleanSetting({name:"skipAssetFileUpdates",key:"PS_SKIP_ASSET_FILE_UPDATES",category:_.SettingCategories.Sync,description:"Should outdated AssetFiles be updated on startup? (Only used for tests)",defaultValue:!1,addToChildProcs:!0,persisted:!1}),skipAssetUpdates:new _.BooleanSetting({name:"skipAssetUpdates",key:"PS_SKIP_ASSET_UPDATES",category:_.SettingCategories.Sync,description:"Should outdated Assets be updated on startup? (Only used for tests)",defaultValue:!1,addToChildProcs:!0,persisted:!1}),resyncAssetOnVisit:new _.BooleanSetting({name:"resyncAssetOnVisit",key:"PS_RESYNC_ASSET_ON_VISIT",category:_.SettingCategories.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 4 CPUs.",defaultValue:()=>!!S.isTest||i.cpus().length>=4,persisted:!0}),squareThumbStrategy:new _.StringEnumSetting({name:"squareThumbStrategy",key:"PS_SQUARE_THUMB_STRATEGY",category:_.SettingCategories.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: https://sharp.dimens.io/en/stable/api-resize/',defaultValue:"attention",validValues:["center","entropy","attention"],persisted:!0}),videoFrameAtSec:new _.FloatSetting({name:"videoFrameAtSec",key:"PS_VIDEO_FRAME_AT_SEC",category:_.SettingCategories.Previews,description:"When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.\nNote that if a video is shorter than this value, the frame will be captured from the middle of the video.",defaultValue:1.5,persisted:!0}),sharpen:new _.BooleanSetting({name:"sharpen",key:"PS_SHARPEN",category:_.SettingCategories.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1,persisted:!0}),progressive:new _.BooleanSetting({name:"progressive",key:"PS_PROGRESSIVE",category:_.SettingCategories.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0,persisted:!0}),previewResolutions:new _.StringEnumsSetting({name:"previewResolutions",key:"PS_PREVIEW_RESOLUTIONS",category:_.SettingCategories.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:y.diff(l.FitSizeValues,["uhd8k","uhd5k","qqvga"]),validValues:l.FitSizeValues,persisted:!0}),useEmbeddedPreviews:new _.BooleanSetting({name:"useEmbeddedPreviews",key:"PS_USE_EMBEDDED_PREVIEWS",category:_.SettingCategories.Previews,description:"Should embedded image previews be used when available? This speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.",defaultValue:!0,persisted:!0}),useEmbeddedThumbnails:new _.BooleanSetting({name:"useEmbeddedThumbnails",key:"PS_USE_EMBEDDED_THUMBNAILS",category:_.SettingCategories.Previews,description:"Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.",defaultValue:!0,persisted:!0}),requireMakeModel:new _.BooleanSetting({name:"requireMakeModel",key:"PS_REQUIRE_MAKE_MODEL",category:_.SettingCategories.Filters,description:"Normally PhotoStructure requires images to have an EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!0,persisted:!0}),minImageDimension:new _.IntegerSetting({name:"minImageDimension",key:"PS_MIN_IMAGE_DIMENSION",category:_.SettingCategories.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480,persisted:!0}),minVideoDimension:new _.IntegerSetting({name:"minVideoDimension",key:"PS_MIN_VIDEO_DIMENSION",category:_.SettingCategories.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240,persisted:!0}),minFileSizeBytes:new _.IntegerSetting({name:"minFileSizeBytes",key:"PS_MIN_ASSET_SIZE",category:_.SettingCategories.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*f.KB,persisted:!0}),maxFileSizeBytes:new _.IntegerSetting({name:"maxFileSizeBytes",key:"PS_MAX_ASSET_SIZE",category:_.SettingCategories.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library)",defaultValue:.5*f.GB,persisted:!0}),neverIgnored:new _.StringArraySetting({name:"neverIgnored",key:"PS_NEVER_IGNORED",category:_.SettingCategories.Filters,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files.",persisted:!0}),tagCamera:new _.BooleanSetting({name:"tagCamera",key:"PS_TAG_CAMERA",category:_.SettingCategories.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0,persisted:!0}),tagLens:new _.BooleanSetting({name:"tagLens",key:"PS_TAG_LENS",category:_.SettingCategories.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0,persisted:!0}),tagDate:new _.StringEnumSetting({name:"tagDate",key:"PS_TAG_YMD",category:_.SettingCategories.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["","y","ym","ymd"],persisted:!0}),tagKeywordsFromPath:new _.BooleanSetting({name:"tagKeywordsFromPath",key:"PS_TAG_KEYWORDS_FROM_PATH",category:_.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0,persisted:!0}),tagKeywordsFromMetadata:new _.BooleanSetting({name:"tagKeywordsFromMetadata",key:"PS_TAG_KEYWORDS_FROM_METADATA",category:_.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0,persisted:!0}),keywordDelimiters:new _.StringSetting({name:"keywordDelimiters",key:"PS_KEYWORD_DELIMITERS",category:_.SettingCategories.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be\n    interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;",persisted:!0}),keywordPathSeparators:new _.StringSetting({name:"keywordPathSeparators",key:"PS_KEYWORD_PATH_SEPARATORS",category:_.SettingCategories.Tagging,description:'PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "ObjectsâToolsâHammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don\'t want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.',defaultValue:"/|>â»ââ¸§",persisted:!0}),tagType:new _.BooleanSetting({name:"tagType",key:"PS_TAG_TYPE",category:_.SettingCategories.Tagging,description:'Should assets be tagged with their filetype (like "Type/Image/JPEG")?',defaultValue:!0,persisted:!0})},t.envSuggestedDirsKey="SUGGESTED_DIRS",t.envSkipFiltersKey="PS_SKIP_FILTERS",t.envSkipFilters=v.isTrue(s.env[t.envSkipFiltersKey]),t.DefaultPaths=Object.freeze(P.isWin?[s.env.SYSTEMROOT,r.join(s.env.SYSTEMROOT,"System32"),r.join(s.env.SYSTEMROOT,"System32","webm")]:["/usr/local/sbin","/usr/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),t.withDefaultPaths=F,t.pathWithDefaults=c.lazy(()=>F(s.env.PATH)),t.persistedSystemSettings=c.lazy(()=>h.values(t.Settings).filter(e=>e.opts.persisted&&_.SystemCategories.includes(e.category))),t.persistedLibrarySettings=c.lazy(()=>h.values(t.Settings).filter(e=>e.opts.persisted&&_.LibraryCategories.includes(e.category))),t.settingsForChildProcs=c.lazy(()=>h.values(t.Settings).filter(e=>e.opts.addToChildProcs)),t.psenv=function(){const e=h.values(t.Settings).map(e=>e.key);return h.sortedKeys(h.filter(s.env,t=>"nodeEnv"===t||e.includes(t)))},t.childEnv=T,t.spawnOptions=function(e){const t=d.orElse(e,{});return Object.assign(Object.assign({},t),{env:T(t.env),detached:!1,shell:!1})}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(30),s=n(1),o=n(3),a=n(0),u=n(5),l=n(10),c=n(33),d=n(51),h=n(57);function f(e){return a.defined(e)&&e.every(a.defined)}function p(e,...t){const n=e.length;return s.filterInPlace(e,e=>t.every(t=>!h.eql(e,t))),n!==e.length}t.allDefined=f,t.mapAllDefined=function(e,t){return f(e)?t(e):void 0},t.mapAll=function(e,t){return f(e)?t(e):void 0},t.allNotDefined=function(e){return null==e||e.every(e=>null==e)},t.allNotBlank=function(...e){return null!=e&&e.every(o.notBlank)},t.anyNotDefined=function(e){return null==e||e.some(e=>null==e)},t.anyDefined=function(e){return null!=e&&e.some(e=>null!=e)},t.first=function(e,t){if(null!=e)for(const n of s.compact(e)){const e=t(n);if(null!=e)return e}},t.firstAsync=function(e,t){return i(this,void 0,void 0,(function*(){if(null!=e){let n=-1;for(const i of e){n++;try{if(null==i)continue;const e=yield t(i,n);if(null!=e)return e}catch(e){}}}}))},t.firstNonEmptyThunk=function(...e){for(const t of e){const e=t();if(s.isNotEmpty(e))return e}},t.concat=function(...e){const t=[];for(const n of e)if(Array.isArray(n))for(const e of n)null!=e&&t.push(e);else null!=n&&t.push(n);return t},t.remove=p,t.moveToEnd=function(e,t){return p(e,t),e.push(t),e},t.moveIndexToEnd=function(e,t){const n=e[t];if(null==n)return e;e.push(n);for(let n=t;n<e.length-1;n++)e[n]=e[n+1];return e.length=e.length-1,e};const m=e=>{if(d.isPrimitive(e))return e;if(Array.isArray(e))return JSON.stringify(e);if(c.isFunction(e.valueOf))return e.valueOf();throw new Error("Cannot get primitive value for "+r.inspect(e))};function g(e,t,n=m){const i=new Set(t.map(n));return e.filter(e=>i.has(n(e)))}function y(...e){const t=Math.max(...e.map(e=>e.length));return u.times(t,t=>e.map(e=>e[t]))}function v(e){return w(e,e=>e.valueOf())}function b(e){return S(e,e=>e.valueOf())}function w(e,t){return M(e,t,(e,t)=>d.lt(e,t))}function S(e,t){return M(e,t,(e,t)=>d.gt(e,t))}function M(e,t,n){const i=e.map((e,n)=>({ea:e,index:n,v:a.map(e,t)})).filter(e=>null!=e&&null!=e.v);if(0===i.length)return-1;let r=0;for(let e=1;e<i.length;e++){const t=i[r].v;!0===n(i[e].v,t)&&(r=e)}return i[r].index}function P(e,t,n=!1){return i(this,void 0,void 0,(function*(){const i=[];e:for(const r of e){for(const e of i)if(n){if(yield x(e,e=>t(r,e))){e.push(r);continue e}}else if(yield E(e,e=>t(r,e))){e.push(r);continue e}i.push([r])}return i}))}function E(e,t){return i(this,void 0,void 0,(function*(){if(null!=e)for(let n=0;n<e.length;n++)if(yield t(e[n],n))return!0;return!1}))}function x(e,t){return i(this,void 0,void 0,(function*(){if(null!=e)for(let n=0;n<e.length;n++)if(!(yield t(e[n],n)))return!1;return!0}))}t.diff=function(e,t,n=m){const i=new Set(t.map(n));return e.filter(e=>!i.has(n(e)))},t.intersection=g,t.diceCoeff=function(e,t,n=m){return s.isEmpty(e)&&s.isEmpty(t)?1:2*g(e,t,n).length/(e.length+t.length)},t.eqlContents=function(e,t){return y(s.sort(e),s.sort(t)).every(([e,t])=>e===t)},t.removeFirst=function(e,t){const n=e.findIndex(t);return n>=0?e.splice(n,1)[0]:void 0},t.uniqInPlace=function(e){s.filterInPlace(e,(t,n)=>e.indexOf(t)===n)},t.partition=function(e,t){const n=[],i=[];return e.forEach((e,r)=>(t(e,r)?n:i).push(e)),[n,i]},t.uniqCount=function(e){return function e(t){if(null==t||0===t.length)return[];const n=t[0],i=t.lastIndexOf(n);return[{t:n,count:i+1},...e(t.slice(i+1))]}(e.sort())},t.mapCompact=function(e,t){return s.compact(s.compact(e).map(t))},t.toMapEntries=function(e,t){return new Map(e.map(t).filter(a.defined))},t.flatMap=function(e,t){return e.reduce((e,n)=>e.concat(t(n)),[])},t.retainLastN=function(e,t){return e.length>t&&e.splice(0,e.length-t),e},t.retainFirstN=function(e,t){return e.length=Math.min(e.length,t),e},t.contextAround=function(e,t,n,i){const r=e.findIndex(i);if(-1!==r){return{before:0===r?[]:e.slice(Math.max(0,r-t),r),after:r===e.length-1?[]:e.slice(r+1,Math.min(r+1+n,e.length))}}},t.zip=y,t.flatZip=function(...e){const t=Math.max(...e.map(e=>e.length)),n=[];return u.times(t,t=>e.map(e=>n.push(e[t]))),n},t.unzip=function(e){return[e.map(([e])=>e),e.map(([,e])=>e)]},t.ancestry=function(e){return u.times(e.length,t=>e.slice(0,t+1))},t.min=function(e){return e[v(e)]},t.leastIndex=v,t.max=function(e){return e[b(e)]},t.greatestIndex=b,t.leastIndexBy=w,t.greatestIndexBy=S,t.leastBy=function(e,t){return e[w(e,t)]},t.greatestBy=function(e,t){return e[S(e,t)]},t.combinations=function*e(t,n){if(!(null==t||t.length<n))for(let i=0;i<t.length;i++)if(1===n)yield[t[i]];else for(const r of e(t.slice(i+1),n-1))yield[t[i],...r]},t.reverse=function(e){const t=[];for(let n=e.length-1;n>=0;n--)t.push(e[n]);return t},t.batches=function(e,t){return t<=0&&(t=1),s.stepRange(0,e.length,t,n=>e.slice(n,n+t))},t.contextFilter=function(e,t){let n;return e.filter((e,i)=>l.tap(t(e,i,n),t=>{t&&(n=e)}))},t.mergesort=function(e,t){return e.reduce((e,n)=>function(e,t,n){const i=[],r=s.isEmpty(e),o=s.isEmpty(t);if(r&&o)return[];if(r)return t;if(o)return e;let a=0,u=0;for(;a<e.length||u<t.length;){for(;a<e.length&&!0!==n(t[u],e[a]);)i.push(e[a++]);for(;u<t.length&&!0!==n(e[a],t[u]);)i.push(t[u++])}return i}(e,n,t),[])},t.clusterStrictAsync=function(e,t){return i(this,void 0,void 0,(function*(){return P(e,t,!0)}))},t.clusterAsync=P,t.someAsync=E,t.everyAsync=x,t.firstIndexNearest=function({arr:e,fromIndex:t,pred:n,maxDelta:i}){for(let r=1;r<Math.min(i+1,e.length);r++){{const i=t-r;if(i>=0&&n(e[i],i))return i}{const i=t+r;if(i<e.length&&n(e[i],i))return i}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=new(n(217).EventEmitter);i.setMaxListeners(50),t.eventEmitter=i,t.emitBoom=function(){t.eventEmitter.emit("boom")},t.onBoom=function(e){t.eventEmitter.on("boom",e)},t.emitClearCache=function(){t.eventEmitter.emit("clearCache")},t.onClearCache=function(e){t.eventEmitter.on("clearCache",e)},t.emitIdle=function(){t.eventEmitter.emit("idle")},t.onIdle=function(e){t.eventEmitter.on("idle",e)},t.emitMigration=function(e){t.eventEmitter.emit("migration",e)},t.onMigration=function(e){t.eventEmitter.on("migration",e)},t.emitPause=function(){t.eventEmitter.emit("pause")},t.onPause=function(e){t.eventEmitter.on("pause",e)},t.emitResume=function(){t.eventEmitter.emit("resume")},t.onResume=function(e){t.eventEmitter.on("resume",e)},t.emitFileChanged=function(e){t.eventEmitter.emit("fileChanged",e)},t.onFileCopied=function(e){t.eventEmitter.on("fileCopied",e)},t.emitFileCopied=function(e,n){t.eventEmitter.emit("fileCopied",e,n)},t.onFileChanged=function(e){t.eventEmitter.on("fileChanged",e)},t.emitFocus=function(e,n){t.eventEmitter.emit("focus",e,n)},t.onFocus=function(e){t.eventEmitter.on("focus",e)},t.onFatal=function(e){t.eventEmitter.on("fatal",({message:t,error:n})=>e(t,n))},t.onNonFatal=function(e){t.eventEmitter.on("nonFatal",({message:t,error:n})=>e(t,n))},t.emitRpcServerChange=function(){t.eventEmitter.emit("rpcServerChange")},t.onRpcServerChange=function(e){t.eventEmitter.on("rpcServerChange",e)},t.readyToUpdate=!1,t.emitReadyToUpdate=function(){t.readyToUpdate=!0,t.eventEmitter.emit("readyToUpdate")},t.onReadyToUpdate=function(e){t.eventEmitter.on("readyToUpdate",e)},t.emitVolumesChanged=function(){t.eventEmitter.emit("volumesChanged")},t.onVolumesChanged=function(e){t.eventEmitter.on("volumesChanged",e)},t.emitSaveProgress=function(){t.eventEmitter.emit("saveProgress")},t.onSaveProgress=function(e){t.eventEmitter.on("saveProgress",e)},t.emitSettingsChanged=function(){t.eventEmitter.emit("settingsChanged")},t.onSettingsChanged=function(e){t.eventEmitter.on("settingsChanged",e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(0),o=n(5),a=n(9),u=e=>(t,n)=>o.isNumber(t)&&o.isNumber(n)&&e(t,n);function l(e,t){return o.mapInt(e,e=>e>=0?t(e):void 0)}function c(e,t){return o.mapInt(e,e=>e>0?t(e):void 0)}t.lt=u((e,t)=>e<t),t.lte=u((e,t)=>e<=t),t.gt=u((e,t)=>e>t),t.gte=u((e,t)=>e>=t),t.firstGt0=function(...e){return e.find(o.gt0)},t.firstNonZero=function(...e){for(const t of i.flatten(e)){const e=o.toFloat(t);if(null!=e&&0!==e)return e}},t.mapGte0=l,t.mapGte0Or=function(e,t,n){return s.orElse(l(e,t),n)},t.mapGte0f=function(e,t){return o.mapNumeric(e,e=>e>=0?t(e):void 0)},t.mapGt0=c,t.mapGt0f=function(e,t){return o.mapNumeric(e,e=>e>0?t(e):void 0)},t.mapGt0Or=function(e,t,n){return s.orElse(c(e,t),n)},t.within=function(e,n,i){return null!=i&&([e,n]=[Math.min(e,n),Math.max(e,n)],t.gte(i,e)&&t.lte(i,n))};const d=/[+-]?[0-9\.]/;function h(e){if(o.isNumber(e))return e;if(r.blank(e))return;const t=String(e);return s.map(d.exec(t),e=>o.toFloat(t.substr(e.index)))}t.extractInt=function(e){return o.toInt(h(e))},t.extractFloat=h,t.assertPositive=function(e,t){if(null==t||t<=0)throw new Error(e+" must be positive")};function f(e,t){if(null==e||null==t)return;const n=[e,t].map(e=>e.toString(2)),i=Math.max(...n.map(e=>e.length));return n.map(e=>a.leftPad(e,i,"0"))}t.Array2D=class{constructor(e){this.columns=e,this.store=[]}get(e,t){return e<0||t<0?0:s.orElse(this.store[e*this.columns+t],()=>0)}set(e,t,n){this.store[e*this.columns+t]=n}},t.hammingDistanceBigInt=function(e,t){return s.map(f(e,t),([e,t])=>i.count(e.split(""),(e,n)=>e!==t.charAt(n)))},t.hammRatioBigInt=function(e,t){return s.map(f(e,t),([e,t])=>{const n=e.length;return i.count(e.split(""),(e,n)=>e===t.charAt(n))/n})},t.valuesToBigInt=function(e,t){return i.isEmpty(e)?BigInt(0):BigInt("0b0"+e.map(e=>a.leftPad(e.toString(2),t-1,"0")).join(""))}},function(e,t,n){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.isDefined=!1,e.isEmpty=!0,e.get=function(){},e.exists=()=>!1;const t=()=>e;e.map=t,e.flatMap=t,e.filter=t,e.forEach=t,e.getOrElse=function(e){return e()},e.orElse=function(e){return s(e())},e.zip1=t,e.zip2=t,e.zip3=t}(i||(i={})),t.None=i;class r{constructor(e){this.a=e,this.isDefined=!0,this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new r(e(this.a))}flatMap(e){const t=e(this.a);return o(t)?t:s(t)}filter(e){return s(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(e){return this.a}orElse(e){return this}zip1(e,t){return s(e).flatMap(e=>t(this.a,e))}zip2(e,t,n){return s(e).flatMap(e=>s(t).flatMap(t=>n(this.a,e,t)))}zip3(e,t,n,i){return s(e).flatMap(e=>s(t).flatMap(t=>s(n).flatMap(n=>i(this.a,e,t,n))))}}function s(e){return o(e)?e:null!=e?new r(e):t.None}function o(e){return e instanceof r||e===t.None}t.Some=r,t.Opt=s,t.isOpt=o},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});const i=n(56),r=n(44),s=n(18),o=n(3),a=n(2),u=n(0),l=n(7),c=n(23),d=r.platform();t.inspectFlag=s.argv.includes("--inspect")||c.isTrue(s.env.NODE_INSPECT),t.isPacked=!l.toS(e).includes("Platform"),t.isWin=d.startsWith("win"),t.isWinPortable=t.isWin&&o.notBlank(s.env.PORTABLE_EXECUTABLE_DIR),t.isMac="darwin"===d,t.isLinux="linux"===d,t.isLinux_x64=t.isLinux&&"x64"===r.arch(),t.isArm="arm"===r.arch(),t.isLinux_arm=t.isLinux&&t.isArm,t.isLinuxAppImage=t.isLinux&&(o.notBlank(s.env.APPIMAGE)||o.notBlank(s.env.APPDIR)),t.isLinuxSnap=t.isLinux&&o.notBlank(s.env.SNAP_USER_DATA),t.isPosix=t.isMac||t.isLinux,t.isElectron=null!=s.versions.electron||c.isTrue(s.env.PS_IS_ELECTRON),t.isDocker=a.lazy(()=>{if(c.isTrue(s.env.PS_DOCKER))return!0;try{return t.isLinux&&i.readFileSync("/proc/1/cgroup").toString().includes("/docker/")}catch(e){return console.warn("isDocker(): failed to read /proc/1/cgroup: "+e),!1}}),t.isRaspberryPi=a.lazy(()=>t.isLinux_arm&&l.toS(t.procDeviceModel()).startsWith("Raspberry Pi")),t.procDeviceModel=a.lazy(()=>{try{return t.isLinux?u.map(i.readFileSync("/proc/device-tree/model"),l.toS):void 0}catch(e){return}}),t.platformName=t.isWin?"win":t.isMac?"mac":t.isLinux?"linux":d}).call(this,"/index.js")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(193),s=n(18),o=n(43),a=n(6),u=n(38),l=n(2),c=n(0),d=n(5),h=n(10),f=n(33),p=n(7),m=n(48),g=n(8),y=n(20),v=n(67),b=n(4),w=n(22),S=n(89),M=n(16),P=n(154),E=n(11),x=n(9),_=l.lazy(()=>b.mkLogger("ChildProcess"));function F(e){return h.pick(e,"pid","killed","connected","exitCode","signalCode")}function T(e,t){return"renice"!==e&&"sqlite3"!==e&&[e,...t].every(e=>!e.endsWith("web.js")&&!e.endsWith("db.js")&&!e.includes("sqlite3"))}function O(e,t,n,r){const u=new Date;let l=!1;e.on("exit",()=>l=!0);const c=T(t,n);return _().info("newProc()",{_niceable:c,cmd:t,args:n}),o.setTimeout(()=>i(this,void 0,void 0,(function*(){if(l)return;yield g.until(()=>d.gt0(e.pid),a.secondMs);const n=e.pid;return d.gt0(n)?(c&&(yield P.renice(n)),S.addPid({pid:n,cmd:t,maxAgeMs:r,ppid:s.pid},u)):void _().warn("newProc(): not writing pidfile, child_process has no pid",{cmd:t,cp:F(e)})})),M.isWin?500:250),e}function A(e,t,n,i){return O(r.execFile(e,t,E.spawnOptions(i)),e,t,n)}function k(e,t,n){return i(this,void 0,void 0,(function*(){const i=c.orElse(n.quiet,!1),r=c.orElse(n.ignoreStderr,!1),s=c.orElse(n.ignoreExitCode,!1);let a="";_().debug("stdoutResult(): execFile",{cmd:e,args:t});const u=yield A(e,t,n.timeout,h.without(n,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(!0===n.disconnect)return u.disconnect(),{result:"",pid:u.pid};const l=JSON.stringify({cmd:e,args:t}),d=new m.Deferred(l);o.setTimeout(()=>{d.pending&&_().warn("stdoutResult(): SLOW COMMAND",{cmd:e,args:t})},n.timeout/3).unref(),d.setTimeout(n.timeout);const g=(r,s)=>{y.isIgnorableError(s)||f.isFunction(n.isIgnorableError)&&n.isIgnorableError(s)?_().debug("stdoutResult(): ignorable error for "+r,{cmd:e,args:t,opts:n,error:s}):(null!=u.pid&&D(u),i||_().warn("stdoutResult(): "+r,{cmd:e,args:t,opts:n,error:s}),d.pending&&d.reject(s))};try{u.on("error",e=>g("on(error)",e)),u.on("close",n=>{const r=Date.now()-d.start,o=0!==n?"warn":"debug";i||_().log(o,"stdoutResult(): on(close)",{cmd:e,code:n,args:t,elapsedMs:r,result:x.gist(a,160,160)}),s||0===n?d.resolve({result:a,code:n,pid:u.pid}):d.reject(new Error("non-zero exit code: "+JSON.stringify({code:n,cmd:e,args:t})))}),u.stdin.end(),u.stdout.on("data",e=>c.map(e,e=>{a+=e.toString()})),u.stderr.on("error",e=>g("stderr(error)",e)),u.stderr.on("data",e=>r?_().warn("stdoutResult(): stderr(data): "+p.toS(e)):g("stderr(data)",e))}catch(e){g("try/catch",e)}return d.promise}))}function D(e,t=30*a.secondMs){return i(this,void 0,void 0,(function*(){if(null==e)return!1;const n=e.pid;if(_().debug("endProcess("+n+")",{killed:e.killed,connected:e.connected}),!e.killed){if(n<=0)return _().warn("endProcess(): asked to end invalid pid",F(e)),!1;if(n===s.pid)return _().warn("endProcess(): asked to end MY pid",F(e)),!1;w.Try(()=>e.kill())}return yield u.delay(250),yield v.closeStreams(e),e.connected&&w.Try(()=>e.disconnect()),w.Try(()=>e.unref()),(yield C(n,t))?(_().debug("endProcess(): exitted",F(e)),!0):(yield S.kill(n,!0).catch(e=>{_().warn("endProcess(): kill("+n+",true) failed: "+e)}),C(n,5e3))}))}function C(e,t){return g.until(()=>g.thenNot(S.pidExists(e)),t)}t.niceable=T,t.spawn=function(e,t,n,i){return _().debug("spawn()",{command:e,args:t,maxAgeMs:n,options:i}),O(r.spawn(e,t,E.spawnOptions(i)),e,t,n)},t.execFile=A,t.stdout=function(e,t,n){return k(e,t,n).then(e=>e.result)},t.stdoutResult=k,t.endProcess=D,t.waitForExit=C},function(e,t){e.exports=require("process")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(94);t.toA=function(e){return null==e?[]:i.isIterable(e)?Array.from(e):Array.isArray(e)?e:[e]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(6),o=n(28),a=n(2),u=n(15),l=n(7),c=n(24),d=n(23),h=n(216),f=n(13),p=n(4),m=n(105),g=n(14),y=n(65),v=n(11),b=n(9),w=Date.now(),S=a.lazy(()=>p.mkLogger("Error"));t.FatalErrorFlag="Â¹",t.NonRetriableErrorFlag="Â²",t.IgnorableErrorFlag="Â³",t.PleaseSendErrorFlag="â´",t.HealthCheckErrorFlag="âµ",t.ErrorFlags=[t.FatalErrorFlag,t.NonRetriableErrorFlag,t.IgnorableErrorFlag,t.PleaseSendErrorFlag,t.HealthCheckErrorFlag];const M=new RegExp("["+t.ErrorFlags.join("")+"]","g");function P(e){return e.replace(M,"")}t.ifError=function(e){return e instanceof Error?e:void 0},t.mapError=function(e,t){return e instanceof Error?t(e):void 0},t.removeErrorFlags=P,t.hasErrorFlag=function(e){return t.ErrorFlags.some(t=>e.includes(t))},t.isHealthCheckError=function(e){return o.errorToS(e).includes(t.HealthCheckErrorFlag)};const E=new m.Rate(s.minuteMs),x=new m.Rate(s.minuteMs);t.onError=function(e,t,n){const i=o.errorToS(e)+o.errorToS(t)+o.errorToS(n),r=F(t)||F(i)||d.isTrue(null==n?void 0:n.fatal);if(!r&&A(i))return void S().info("onError(): ignorable",Object.assign({message:e,error:t},n));E.onEvent(),r&&x.onEvent();const s=!r||T()?"nonFatal":"fatal";S().warn("onError()",Object.assign({event:s,message:e,error:t},n)),c.ending()||f.eventEmitter.emit(s,{message:e,error:t})};const _=new RegExp("SQLITE_IOERR|Error: Cannot find module|"+t.FatalErrorFlag,"i");function F(e){return null!=e&&(!!(e instanceof C&&e.fatal)||null!=_.exec(o.errorToS(e)))}function T(){const e=Date.now()>w+v.Settings.probationMs.valueOrDefault,t=g.lt(x.eventsPerMinute,v.Settings.fatalErrorRatePerMinute.valueOrDefault);return S().tap({level:"info",msg:"isFatalErrorAllowed()",result:y.isMainService()&&e&&t,meta:{mainService:y.isMainService(),postProbation:e,lowErrorRate:t,fatalErrorRatePerMin:x.eventsPerMinute,errorRatePerMin:E.eventsPerMinute,fatalErrorRatePerMinuteSetting:v.Settings.fatalErrorRatePerMinute.valueOrDefault}})}t.isFatalError=F,t.isFatalErrorAllowed=T,t.isRetriableError=function(e){return!F(e)&&!o.errorToS(e).includes(t.NonRetriableErrorFlag)&&(!(e instanceof C)||e.retriable)},t.isSendableError=function(e){if(null==e)return!1;const n=o.errorToS(e);return!A(n)&&n.includes(t.PleaseSendErrorFlag)};const O=[t.IgnorableErrorFlag,"Warning:","Can't set headers after they are sent","0 output files created","Missing expected status message","Unexpected error while trimming. Try to lower the tolerance","called while not idle","onExit(exit) called end()","end() called before task completed","BatchCluster has ended, cannot enqueue","diskutil: interrupted","net::ERR_","ECONNRESET","This socket has been ended by the other party","debugger listening on","for help","https://nodejs.org/en/docs/inspector","debugger attached"].map(e=>e.toLowerCase());function A(e){const t=o.errorToS(e).toLowerCase();return c.ending()||!F(e)&&O.some(e=>t.includes(e))}t.isIgnorableError=A,t.throws=function(e){try{return e(),!1}catch(e){return!0}},t.stack=function e(){const t={};return Error.captureStackTrace(t,e),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)},t.errorToHumanString=function(e,t=80){return b.ellipsize(D(o.errorToS(e)),t)};const k=[/^error:? /i,/^\bcode\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T\.: -]+Z? /i,/\[object Object\/]/i];function D(e){let t=P(b.stripAnsiEsc(e)),n=t;do{n=t,t=k.reduce((e,t)=>e.replace(t,""),t).trim()}while(n!==t);return i.compactBlanks(t.split(/\s+/).map(e=>{if(e.startsWith("E")){const n=h.describeError(e);return t.toLowerCase().includes(n.toLowerCase())?"":n+":"}return e})).join(" ")}t.trimErrorMessage=D,t.cleanError=function(e,t){return l.toS(e).split(/\r?\n/).map(e=>b.stripPrefix(e,t)).map(e=>e.replace(/: ?/,"")).filter(r.notBlank).join(", ")};class C extends Error{constructor({cause:e,message:n,retriable:s=!0,ignorable:o=!1,fatal:a=!1}){super(function(e,n,s,o,a){const c=[e];u.Opt(n).flatMap(e=>e.message).flatMap(e=>b.stripPrefix(e,"Error: ")).forEach(e=>c.push(e));const d=i.compactBlanks(c).map(e=>l.toS(e).trim()).filter(r.notBlank).join(": "),h=[];a||s||h.push(t.NonRetriableErrorFlag);o&&!a&&h.push(t.IgnorableErrorFlag);a&&h.push(t.FatalErrorFlag);i.isNotEmpty(h)&&h.unshift(" ");return d+h.join("")}(n,e,s,o,a)),this.cause=e,this.retriable=s,this.fatal=a}}t.WrappedError=C},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(79),s=n(1),o=n(3),a=n(6),u=n(45),l=n(0),c=n(5),d=n(15),h=n(51),f=n(36),p=n(123),m=n(42),g=n(14),y=n(22),v=n(9);function b(e){return e instanceof Date}function w(e,t=5*a.secondMs){return c.gt0(e)&&Date.now()-e<=t}function S(e){return v.leftPad(e,2,"0")}function M(e,t,n){return e<1?void 0:f.plur(e,t,n)}function P(e,t=2,n){if(!c.gte0(e))return c.isNumber(e)?"-"+P(Math.abs(e),t):"";const i=[M(Math.floor(e/a.dayMs),"day","days"),M(Math.floor(e/a.hourMs)%24,"hour","hours"),M(Math.floor(e/a.minuteMs)%60,"minute","minutes"),M(Math.floor(e/a.secondMs)%60,"second","seconds")],r=i.findIndex(e=>null!=e),o=s.compact(i.slice(r,r+t));return s.isEmpty(o)?"":null!=n&&1===o.length&&o[0].startsWith("1 ")?o[0]+" "+n.plural:o.join(", ")+l.mapOr(n,e=>" "+e.singular,()=>"")}t.isDate=b,t.cmpDate=function(e,t){const n=l.mapOr(e,e=>e.getTime(),()=>0),i=l.mapOr(t,e=>e.getTime(),()=>0);return h.cmp(n,i)},t.unixtime=function(e){const t=b(e)?e.getTime():c.isNumber(e)?e:void 0;return l.map(t,e=>Math.floor(e/1e3))},t.ago=function(e,t){return new Date(l.orElse(t,new Date).getTime()-e)},t.closeTo=function(e,t,n){return null!=e&&null!=t&&Math.abs(e.getTime()-t.getTime())<=n},t.recent=function(e,t=5*a.secondMs){return w(l.map(e,e=>m.datedToMillis(e)),t)},t.isRecentMs=w,t.elapsed=function(e){const t=Date.now(),n=e();return{elapsedMs:Date.now()-t,result:n}},t.elapsedAsync=function(e){return i(this,void 0,void 0,(function*(){const t=Date.now(),n=yield e();return{elapsedMs:Date.now()-t,result:n}}))},t.thenElapsed=function(e){return i(this,void 0,void 0,(function*(){const t=Date.now(),n=yield e;return{elapsedMs:Date.now()-t,result:n}}))},t.datestamp=function(e=new Date){return e.getFullYear()+"-"+S(e.getMonth()+1)+"-"+S(e.getDate())},t.datestampUTC=function(e=new Date){return e.getUTCFullYear()+"-"+S(e.getUTCMonth()+1)+"-"+S(e.getUTCDate())},t.filestamp=function(e=new Date){return[e.getFullYear(),S(e.getMonth()+1),S(e.getDate()),"-",S(e.getHours()),S(e.getMinutes()),S(e.getSeconds())].join("")},t.filestampUTC=function(e=new Date){return[e.getUTCFullYear(),S(e.getUTCMonth()+1),S(e.getUTCDate()),"-",S(e.getUTCHours()),S(e.getUTCMinutes()),S(e.getUTCSeconds())].join("")},t.fmtMs=function(e,t=2){return e<10*a.secondMs?Number(e).toLocaleString()+"ms":P(e,t)},t.durationToPaddedHMS=function(e){return r.Duration.fromMillis(e).toFormat("hhhh:mm:ss.SSS")},t.durationHMS=function(e){return r.Duration.fromMillis(c.round(e/a.secondMs)*a.secondMs).toFormat("h:mm:ss")},t.fmtDuration=P;const E=new Map;function x(e,t,n=r.DateTime.DATETIME_MED){return m.mapValidDate(e,e=>(o.mapNotBlank(t,t=>e=e.setLocale(t)),e.toLocaleString(n)))}t.fmtDateTime=x,t.fmtIsoDate=function(e,t,n=r.DateTime.DATETIME_MED){return d.Opt(r.DateTime.fromISO(e,{setZone:!0})).filter(m.validDate).orElse(()=>l.map(p.DateInterval.fromISO(e),e=>e.middle.toDateTime())).map(e=>x(e,t,n)).getOrElse(()=>e)},t.isoNow=function(){return(new Date).toISOString()},t.fmtShort=function(e,t="en-US"){return u.getOrSet(E,t,()=>new Intl.DateTimeFormat(t,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(m.datedToMillis(e))};const _=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;t.wmiDate=function(e){const t=_.exec(e);if(null==t)return;const n=t.slice(1,8).map(e=>c.toInt(e));if(!l.allDefined(n))return;const[i,r,s,o,u,d,h]=n,f=c.toInt(t[8],{defaultValue:0});return new Date(Date.UTC(i,r-1,s,o,u,d,h/1e3)-f*a.minuteMs)};const F=/Date\((\d+)\)/;function T(e){if(!o.blank(e))return d.Opt(r.DateTime.fromISO(v.removeCapture(e,k),{setZone:!0})).filter(e=>e.isValid).orElse(()=>l.map(p.DateInterval.fromISO(e),e=>e.middle.toDateTime())).get()}function O(e){return null!=e&&e.isValid?l.map(c.toInt(e.toFormat("yMMddHHmmss")),t=>100*t+A(e.millisecond)):void 0}function A(e){return Math.floor(e/10)}t.pwshJsonDate=function(e){return d.Opt(e).flatMap(e=>F.exec(e)).flatMap(e=>e[1]).flatMap(c.toInt).filter(e=>g.within(0,Date.now()+a.dayMs,e)).map(e=>new Date(e)).get()},t.MaxTzOffsetHours=14,t.isoToDateTime=T,t.dateTimeToLocal=O;const k=/\.\d\d\d(\d+)/;t.isoToLocal=function(e){return l.map(T(e),O)};const D=/^\d{1,4}-\d{2}-\d{2}$/;function C(e,t){if(null==e||e<0)return;let n=e;const i=()=>{const e=n%100;return n=Math.floor(n/100),e},s=10*i(),o=i(),a=i(),u=i(),c=i(),d=i();return{year:n,month:d,day:c,hour:u,minute:a,second:o,millisecond:s,zone:l.map(t,e=>r.Info.normalizeZone(e))}}function I(e,t){return l.map(C(e,t),e=>r.DateTime.fromObject(e))}t.isoToPrecisionMs=function(e){return o.mapNotBlank(e,e=>y.firstThunk(()=>l.map(p.DateInterval.fromISO(e),e=>e.intervalMs),()=>d.Opt(e.match(D)).flatMap(()=>r.DateTime.fromISO(e)).filter(m.validDate).map(()=>a.dayMs).get(),()=>d.Opt(r.DateTime.fromISO(e)).filter(m.validDate).map(()=>0).get()))},t.localToDateObject=C,t.localToDateTime=I,t.localToMs=function(e,t){return l.map(I(e,t),e=>e.toMillis())},t.tsToLocal=function(e){const t=new Date(e);return c.toInt([t.getFullYear(),...[t.getMonth()+1,t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),A(t.getUTCMilliseconds())].map(S)].join(""))},t.localPlusMs=function(e,t){return O(I(e).plus(t))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(10),o=n(51),a=n(12),u=n(21);function l(e,t){try{return e()}catch(e){return null!=t?t(e):void 0}}function c(e){return s.keys(e).filter(t=>o.isPrimitive(e[t])||u.isDate(e[t])).map(t=>[t,e[t]])}t.definedThunks=function(...e){return e.every(e=>r.defined(e()))},t.firstThunk=function(...e){for(const t of e){const e=t();if(null!=e)return e}},t.firstTrueThunk=function(e,t){for(const n of e){const e=n();if(null!=e&&(null==t||t(e)))return e}},t.firstDefined=function(...e){return e.find(r.defined)},t.firstDefinedField=function(e,...t){return r.map(t.find(t=>null!=e[t]),t=>e[t])},t.firstFieldLike=function(e,t){return a.first(s.keys(e),n=>t(n,e[n])?e[n]:void 0)},t.ornull=function(e){return void 0===e?null:e},t.mapAnd=function(e,t){return null!=e&&t(e)},t.mapOrThrow=function(e,t,n){if(null!=e)return t(e);throw new Error(n)},t.Try=l,t.tryEach=function(e,t){[...e].forEach(e=>l(()=>t(e)))},t.identity=function(e){return e},t.ctor=function(e){return r.map(e.constructor,e=>e.name)},t.hasKeys=function(e){return Object.keys(e).some(t=>"string"==typeof t&&e.propertyIsEnumerable(t))},t.primitiveEntries=c,t.spread=function(e,...t){return Object.assign({},e,...i.compact(t))},t.assignMissingPrimitives=function(e,t){if(null==t)return e;for(const[n,i]of c(t))null==e[n]&&(e[n]=i);return e},t.assignFields=function(e,t){if(null==t)return e;for(const[n,i]of s.entries(t))e[n]=i;return e},t.pickMap=function(e,t,n){const i={};for(const r of t)i[r]=n(r,e[r]);return i},t.mapEntries=function(e,t){const n={};for(const i of s.keys(e))r.map(t(i,e[i]),e=>n[i]=e);return n}},function(e,t,n){"use strict";function i(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e)return!0;const t=String(e).toLowerCase();return["true","1"].includes(t)}function r(e){if("boolean"==typeof e)return!e;if(null==e)return!1;if(0===e)return!0;const t=String(e).toLowerCase();return["false","0"].includes(t)}Object.defineProperty(t,"__esModule",{value:!0}),t.isBoolean=function(e){return"boolean"==typeof e},t.isTrue=i,t.toBoolean=function(e){return!!i(e)||!r(e)&&void 0},t.boolToInt=function(e){return i(e)?1:0},t.isFalse=r,t.or=function(e){return e.some(e=>i(e))},t.and=function(e){return e.every(e=>i(e))},t.mapBoolean=function(e,t){return i(e)?t(!0):r(e)?t(!1):void 0},t.mapTrue=function(e,t){return i(e)?t():void 0}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(6),o=n(2),a=n(0),u=n(37),l=n(60),c=n(4),d=n(84),h=n(26),f=n(14),p=n(22),m=n(8),g=n(58),y=o.lazy(()=>c.mkSafeLogger(l.red("Endable")));t.EndableWrapper=class{constructor(e,t,n){this.name=e,this._onEnd=t,this._isEnded=n,this._ended=!1}get ended(){return a.mapOr(this._isEnded,e=>e(),()=>!1)||this._ended}end(){return this._ended=!0,this._onEnd()}};const v=new d.MultiMap;g.setUnrefInterval(()=>E(),1*s.minuteMs);const b=new Map,w=5*s.secondMs;function S(e,t){return v.add(e,t),t}t.EndableRanks=u.strEnum("first","service","cleanup","db","logger"),t.addFirstEndable=function(e){return S(t.EndableRanks.first,e)},b.set(t.EndableRanks.first,5*s.secondMs),t.addServiceEndable=function(e){return S(t.EndableRanks.service,e)},t.addCleanupEndable=function(e){return S(t.EndableRanks.cleanup,e)},b.set(t.EndableRanks.cleanup,1*s.minuteMs),t.addDbEndable=function(e){return S(t.EndableRanks.db,e)},t.addLoggerEndable=function(e){return S(t.EndableRanks.logger,e)},b.set(t.EndableRanks.logger,10*s.secondMs),t.addEndable=S;let M=!1;function P(e,t=m.DefaultTryAllTimeoutMs){if(null!=e&&!e.ended)return y().debug(l.magenta(e.name+" ending...")),m.thenOrTimeout(e.end(),t,()=>y().warn(l.magenta(e.name+".end() timed out")),()=>y().debug(l.magenta(e.name+".end() completed"))).catch(t=>{p.Try(()=>y().warn(l.magenta(e.name+".end() rejected: ")+t))})}function E(){v.filterInPlace((e,t)=>!t.ended),y().debug("vacuumEndables()",v.entriesArray().map(([e,t])=>[e,t.map(e=>e.name)]))}t.ending=function(){return M},t.setEnding=function(e){if(!h.isTest)throw new Error("cannot set ending");M=e},t.end=P,t.endEndables=o.lazy(()=>i(void 0,void 0,void 0,(function*(){y().info("endEndables()",{isTest:h.isTest,isSingleSpecTests:h.isSingleSpecTests}),h.isTest||(M=!0),E();for(const e of t.EndableRanks.values){const t=a.orElse(v.get(e),[]);if(r.isNotEmpty(t)){y().debug(l.magenta("endEndables(): ending "+e));const n=h.isSingleSpecTests?100:f.firstGt0(b.get(e),w);yield Promise.all(t.map(e=>P(e,n)))}}})))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(6),r=n(36);t.mountpointsTtlMs=15*i.secondMs,t.dfTtlMs=5*i.minuteMs,t.cmdTimeoutMs=35*i.secondMs,t.longTtlMs=1*i.hourMs,t.MinIoRate=i.secondMs/(2*r.MiB)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(18),r=n(7),s=n(23);function o(){if(i.argv.some(e=>e.endsWith("mocha")))return"test";switch(r.toS(i.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";default:return"production"}}t._nodeEnv=o,t.nodeEnv=(()=>{const e=o();return i.env.NODE_ENV=e,e})(),t.isDev="development"===t.nodeEnv,t.isTest="test"===t.nodeEnv,t.isProd="production"===t.nodeEnv,t.isSingleSpecTests=t.isTest&&s.isTrue(i.env.SINGLE_SPEC_TESTS)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(34),r=n(3),s=n(0),o=n(5),a=n(7),u=n(12),l=n(16),c=n(9),d=i.posix;function h(e,t){if(i.sep===d.sep)return e;const n=r.notBlank(t)?i.sep+i.sep+t+i.sep:"",s=e.split(d.sep);return c.equalsIgnoreCase(s[0],t)&&s.unshift(),n+s.join(i.sep)}function f(e){return i.sep===d.sep||d.sep===i.sep?e:e.split(i.sep).join(d.sep)}t.posix2native=h,t.native2posix=f;const p=/^([A-Z]:)[\\/]?(.*)$/i;t.resolve=function(...e){const t=i.join(...e);return i.resolve(l.isWin?function(e){const t=p.exec(e);return null!=t?t[1].toUpperCase()+"\\"+t[2]:e}(t):t)};const m=/(\.?.*?)(\.[a-z]{1,10}\.(?:gz|z|xz|bz2))$/i;function g(e){const t=i.parse(e),n=y(t.base),r=c.stripSuffix(t.base,n);return Object.assign(Object.assign({},t),{ext:n,name:r})}function y(e){const t=m.exec(e);return null!=t&&r.notBlank(t[2])?t[2]:i.extname(e)}function v(e){return c.stripPrefix(e,i.sep).split(i.sep)}t.parsePosixPath=function(e){return g(h(e))},t.parseNativePath=g,t.basename=function(e){return c.stripSuffix(e,y(e))},t.extname2=y,t.containedBy=function(e,t){return r.notBlank(e)&&r.notBlank(t)&&(e===t||e.startsWith(c.ensureSuffix(t,d.sep)))},t.containedByNativePath=function(e,t){return r.notBlank(e)&&r.notBlank(t)&&(e===t||e.startsWith(c.ensureSuffix(t,i.sep)))},t.pathnames=v,t.posixPathFrom=function(e,t){return e.nativePath===t.nativePath?"":c.stripPrefix(f(t.nativePath),c.ensureSuffix(f(e.nativePath),"/"))},t.posixPathFromGrandparent=function(e){return v(e).slice(-3).join("/")};const b=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;t.nameWithoutCount=function(e){return s.mapOr(a.toS(e).match(b),e=>e[1],()=>e)},t.countFromName=function(e){return s.map(a.toS(e).match(b),e=>u.first([e[2],e[3]],o.toInt))},t.addNameSuffix=function(e,t){const n=y(e);return`${c.stripSuffix(e,n)}${t}${n}`}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(0),o=n(7);function a(e){return e instanceof Error?i.compactBlanks([e.name,s.map(e.code,e=>"code "+e),e.message]).join(": "):o.toS(e)}t.errorToS=a,t.verboseErrorToS=function(e){return a(e)+s.mapOr(e.stack,e=>e.split("\n").slice(0,5).join("\n"),()=>"")},t.asError=function(e){if(r.blank(e))throw new Error("undefined error");if(e instanceof Error)return e;if(Array.isArray(e)){const t=e[0];return t instanceof Error?(e.length>1&&(t.errors=e.slice(1)),t):new Error(e.map(e=>o.toS(e)).filter(r.notBlank).join(", "))}return new Error(o.toS(e))},t.isError=function(e){return"object"==typeof e&&e instanceof Error}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(34),s=n(116),o=n(1),a=n(3),u=n(6),l=n(2),c=n(0),d=n(5),h=n(15),f=n(64),p=n(19),m=n(12),g=n(8),y=n(17),v=n(21),b=n(13),w=n(4),S=n(54),M=n(84),P=n(16),E=n(11),x=n(9),_=n(111),F=n(47),T=n(35),O=n(31),A=n(132),k=n(158),D=n(169),C=n(136),I=n(27),L=new O.FileCache;t.groupByMountpoint=function(e,t){return M.groupBy(e,e=>c.map(e.bestMountpoint(t),e=>e.nativePath))},t.coalesce=function(e,t){const n=M.groupBy(e,e=>c.map(e.bestMountpoint(t),e=>e.nativePath));return o.sortBy(o.flatten(p.toA(n.values()).map(e=>m.contextFilter(o.sort(e),(e,t,n)=>null==n||!e.isDescendantOf(n)))),e=>e.pathnames)};class R extends O.BaseFile{constructor(e,t){super(e,t),this.nativePath=e,this.pflog=l.lazy(()=>w.mkLogger("PosixFile("+this.nativePath+")")),this.uriObject=l.lazy(()=>A.file2voluri(this)),this.uri=l.lazy(()=>g.thenMap(this.uriObject(),e=>s.format(e))),this.fileuri=l.lazy(()=>A.file2fileuri(this)),this.mountpoint=l.lazy(()=>g.thenMap(T.mountpoints(),e=>this.bestMountpoint(e.map(e=>this.for(e))))),this.etag=l.lazy(()=>g.thenMap(this.stat(),e=>[e.size,e.mtime.getTime()].map(e=>S.Radix58.encode(e)).join("-"))),this.ignorable=l.lazy(()=>i(this,void 0,void 0,(function*(){return(yield this.isDirectory())?D.ignorableDirectory(this):D.ignorableFile(this)}))),this.hidden=l.lazy(()=>k.hidden(this)),this.isMountpoint=l.lazy(()=>i(this,void 0,void 0,(function*(){return(yield this.isDirectory())&&(yield g.thenMapOr(T.mountpoints(),e=>e.includes(this.nativePath),()=>!1))}))),this.sidecars=l.lazy(()=>i(this,void 0,void 0,(function*(){if(this.isSidecar())return[];const e=yield this.dirEntSiblings(e=>e.filter(e=>F.isSidecarExt(e.ext)&&(e.name===this.name||e.name===this.base||I.nameWithoutCount(e.name)===I.nameWithoutCount(this.name))));return g.sortByAsync(p.toA(e),e=>e.mtimeMs())}))),L.set(e,this)}static for(e,t){if(a.blank(e))throw new Error("unexpectedly empty path");if(e instanceof R)return e;if(e instanceof O.BaseFile)return this.for(e.nativePath,t);if(A.isUri(e))throw new Error("use forUri");const n=L.get(e);if(null!=n)return n;const i=I.resolve(e);return L.getOrSet(i,()=>new R(i,t))}static forPosix(e){return this.for(e.replace(/\//g,r.sep))}static forUri(e,t){return g.thenMap(A.uri2file(e,t),e=>this.for(I.posix2native(e.posixPath,e.hostname)))}static forUriOrPath(e,t){return g.firstDefinedPromise([()=>this.forUri(e),()=>this.for(t)])}for(e,t){return R.for(e,t)}clear(){return super.clear(),this.uriObject.clear(),this.uri.clear(),this.fileuri.clear(),this.mountpoint.clear(),this.etag.clear(),this.ignorable.clear(),this.hidden.clear(),this.sidecars.clear(),this}bestMountpoint(e){return m.greatestBy(e.filter(e=>this.isDescendantOf(e)),e=>h.Opt(o.commonPrefixLength(this.pathnames,e.pathnames)).filter(t=>t>=e.pathnames.length).get())}isDeleted(e,t=T.mountpoints){return i(this,void 0,void 0,(function*(){if(yield this.exists())return!1;if(!this.nativePath.startsWith(e))return this.pflog().error("isDeleted("+e+"): INTERNAL ERROR: prefix doesn't match",{result:!0}),!0;const n=yield t();if(o.isNotEmpty(n)&&(n.includes(e)||x.includesIgnoreCase(n,e)))return this.pflog().debug("isDeleted("+e+"): mountpoint exists but I don't.",{result:!0}),!0;for(const t of this.parents().filter(t=>t.nativePath.length>e.length))if(yield t.exists())return this.pflog().debug("isDeleted("+e+"): ancestor "+t+" exists but I don't.",{result:!0}),!0;return this.pflog().debug("isDeleted("+e+"): Can't say positively that I was deleted from my mointpoint.",{result:!1}),!1}))}httpHeaders(){return i(this,void 0,void 0,(function*(){return{ETag:yield this.etag(),"Last-Modified":yield this.lastModifiedUtc()}}))}hide(){return i(this,void 0,void 0,(function*(){const e=yield P.isWin?y.stdout("attrib",["+h",this.nativePath],{timeout:10*u.secondMs}).catch(e=>e):P.isMac?y.stdout("chflags",["hidden",this.nativePath],{timeout:10*u.secondMs}).catch(e=>e):"";return a.notBlank(e)?void this.pflog().warn("hide("+this.nativePath+") failed: "+e):this.clear()}))}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}mkNoMedia(){return this.join(".NoMedia").writeTxt("See <https://support.photostructure.com/no-media/>").then(e=>e?(b.emitFileChanged(this.nativePath),this):void 0).catch(e=>{this.pflog().warn("Could not add .NoMedia file to "+this,e)})}hasNoMedia(){return i(this,void 0,void 0,(function*(){return C.hasNoMedia(yield this.directoryEntry())}))}ignorableCheap(){return D.ignorablePath(this.nativePath)}isSidecar(){return F.isSidecarExt(this.ext)}sidecar(){return i(this,void 0,void 0,(function*(){return f.thenOpt(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+F.asExt(E.Settings.defaultSidecarType.valueOrDefault).toLowerCase()))}))}jsonSidecar(){return i(this,void 0,void 0,(function*(){const e=yield this.dirEntSiblings(e=>e.filter(e=>x.equalsIgnoreCase(e.ext,".json")&&(e.name===this.name||e.name===this.base||I.nameWithoutCount(e.name)===I.nameWithoutCount(this.name)))),t=o.sortBy(p.toA(e),e=>-_.diceCoeff(this.name,e.name))[0];return this.pflog().debug("jsonSidecar(): "+t),t}))}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",()=>i(this,void 0,void 0,(function*(){const e=yield this.mtimeMs(),t=yield this.sidecars(),n=[e,...yield Promise.all(p.toA(t).map(e=>e.mtimeMs()))].filter(d.gt0);return o.mapNotEmpty(n,e=>Math.floor(Math.max(...e)))})))}thisOrSidecareMaxMtimeSec(){return g.thenMap(this.thisOrSidecareMaxMtimeMs(),e=>v.unixtime(e))}}t.PosixFile=R},function(e,t){e.exports=require("util")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(56),s=n(82),o=n(34),a=n(174),u=n(30),l=n(152),c=n(1),d=n(68),h=n(3),f=n(6),p=n(38),m=n(2),g=n(0),y=n(15),v=n(98),b=n(19),w=n(7),S=n(36),M=n(12),P=n(48),E=n(126),x=n(8),_=n(66),F=n(53),T=n(17),O=n(21),A=n(13),k=n(42),D=n(4),C=n(41),I=n(22),L=n(16),R=n(39),B=n(9),N=n(111),j=n(25),z=n(121),q=n(194),V=n(90),W=n(27),U=n(113),H=n(114),G=n(97),$=n(67),J=n(220);t.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1}),t.execDir=function(){return X.for(process.execPath).parent()};const K=f.minuteMs;class Y extends F.BoundedMap{constructor(){super(K,500,!0),A.onFileChanged(e=>this.clearFromPath(e)),A.onClearCache(()=>this.clearEntries()),this.on("expire",(e,t)=>g.map(t,e=>e.clear()))}clearEntries(){for(const e of this.values())e.clear()}clearFromPath(e){for(const t of this.values())(null==e||t.nativePath.startsWith(e))&&t.clear()}}t.FileCache=Y;const Q=new Y;class X{constructor(e,t){if(this.dirent=t,this.bflog=m.lazy(()=>D.mkLogger("BaseFile("+this.nativePath+")")),this.dirents=m.lazy(()=>i(this,void 0,void 0,(function*(){return x.thenMap(this.directoryEntry(),e=>e.children())}))),this.stat=m.lazy(()=>this.trap("stat",()=>s.stat(this.nativePath).catch(()=>{})),X.attrTTL),this.statSync=m.lazy(()=>this.trapSync("statSync",()=>I.Try(()=>s.statSync(this.nativePath))),X.attrTTL),this.executable=m.lazy(()=>this.access(s.constants.R_OK|s.constants.X_OK)),this.shaResult=m.lazy(()=>i(this,void 0,void 0,(function*(){const e=yield this.size();if(0===e||null==e)return;const t=e>5*S.MiB?new U.PushProgressObserver({op:"Computing SHA of",path:this.nativePath},e):void 0,n=yield O.elapsedAsync(()=>this.trap("sha",()=>V.fileSha(this.nativePath,{observer:t}))),i=g.map(n.result,e=>e.toString("base64"));return{elapsedMs:n.elapsedMs,buffer:n.result,b64:i}})),X.attrTTL),null!=t)this.nativePath=t.nativePath,this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext;else{this.nativePath=W.resolve(e),this.nativePath.startsWith("\\\\")&&(this.hostname=this.nativePath.split("\\")[2]);const t=W.parseNativePath(this.nativePath);this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext}this.posixPath=W.native2posix(this.nativePath),Q.set(e,this)}toJSON(){return{ctor:this.constructor.name,nativePath:this.nativePath}}[u.inspect.custom](){return this.toJSON()}static withFastestAccess(e){return i(this,void 0,void 0,(function*(){const t=c.compact(e),n=yield Promise.all(t.map(e=>e.shaMs()));return t[M.leastIndex(n)]}))}static forPosix(e){return e instanceof X?e:this.for(B.replaceAll(e,"/",o.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,t){if(e instanceof X)return e;const n=Q.get(e);if(null!=n)return n;const i=W.resolve(e);return Q.getOrSet(i,()=>new X(i,t))}static clear(e){A.emitFileChanged(e)}for(e,t){return X.for(e,t)}clear(){return this.dirent=void 0,this.dirents.clear(),this.stat.clear(),this.statSync.clear(),this.executable.clear(),this.shaResult.clear(),this}clearThisAndParent(){return A.emitFileChanged(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return null!=e&&this.nativePath===e.toString()}isExt(...e){return c.compactBlanks(e).map(e=>v.ensurePrefix(e,".").toLowerCase()).includes(w.toS(this.ext).toLowerCase())}get baseWithParent(){return(this.isRoot?"":this.parent().base)+"/"+this.base}get baseWithGrandparent(){return(this.isRoot?"":this.parent().baseWithParent)+"/"+this.base}posixPathFrom(e){return W.posixPathFrom(e,this)}directoryEntry(){return i(this,void 0,void 0,(function*(){if(null==this.dirent){const e=yield this.isFile(),t=yield this.isDirectory(),n=yield this.isSymbolicLink(),i={name:this.base,isFile:()=>e,isDirectory:()=>t,isSymbolicLink:()=>n};this.dirent=new q.DirectoryEntry(this.dir,i)}return this.dirent}))}_child(e){return this.for(o.join(this.nativePath,e.base),e)}childNames(){return x.thenMap(this.dirents(),e=>e.map(e=>e.base))}children(e){return i(this,void 0,void 0,(function*(){return x.thenMap(this.dirents(),t=>x.thenCompact(t.map(t=>i(this,void 0,void 0,(function*(){return E.apply(this._child(t),e)})))))}))}childFiles(e){return i(this,void 0,void 0,(function*(){const t=[];for(const n of b.toA(yield this.dirents()))if(n.isFile()){const i=this._child(n);(null==e||e(i))&&t.push(i)}return t}))}childDirectories(e){return i(this,void 0,void 0,(function*(){return x.thenMap(this.dirents(),t=>x.thenCompact(t.filter(e=>e.isDirectory()).map(t=>i(this,void 0,void 0,(function*(){return E.apply(this._child(t),e)})))))}))}childrenSync(){return g.orElse(this.trapSync("childrenSync",()=>r.readdirSync(this.nativePath).map(e=>this.join(e))),[])}hasChildren(e){return i(this,void 0,void 0,(function*(){const t=yield this.childNames();return c.isNotEmpty(e)?c.includesAll(t,e):c.isNotEmpty(t)}))}hasNoChildren(){return i(this,void 0,void 0,(function*(){return(yield this.isFile())||c.isEmpty(yield this.childNames())}))}visitDescendants(e){return i(this,void 0,void 0,(function*(){return x.thenMap(this.children(),t=>i(this,void 0,void 0,(function*(){for(const n of t)yield n.visitDescendants(e),yield e(n)})))}))}descendants(e){return i(this,void 0,void 0,(function*(){const t=[];for(const n of b.toA(yield this.childFiles()))(yield e(n))&&t.push(n);const n=yield this.childDirectories();if(null!=n){for(const i of n)yield x.thenMap(i.descendants(e),e=>t.push(...e));return t}}))}ancestorWithChildren(e){return i(this,void 0,void 0,(function*(){return(yield this.hasChildren(e))?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}))}siblings(){return i(this,void 0,void 0,(function*(){return this.selfAndSiblings().then(e=>e.filter(e=>!this.eql(e)))}))}dirEntSiblings(e){return i(this,void 0,void 0,(function*(){return x.thenMap(this.parent().dirents(),t=>e(t).map(e=>this.parent()._child(e)))}))}selfAndSiblings(){return i(this,void 0,void 0,(function*(){return this.parent().children()}))}firstExistingSelfOrAncestor(){return i(this,void 0,void 0,(function*(){return this.isRoot||(yield this.exists())?this:this.parent().firstExistingSelfOrAncestor()}))}get pathnames(){return this.nativePath.split(o.sep).filter(e=>null!=e&&""!==e)}get pathnamesWithoutDrive(){return L.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(L.isWin?1:0)}get isRoot(){return this.pathnames.length===(L.isWin?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return null!=e&&c.startsWith(e.pathnames,this.pathnames)}isDescendantOf(e){return null!=e&&c.startsWith(this.pathnames,e.pathnames)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){const e=this.parent();return this.isRoot?[]:[...e.parents(),e]}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return c.isEmpty(e)?this:this.for(o.join(this.nativePath,...e))}child(...e){return c.isEmpty(e)?this:this.join(...W.native2posix(o.join(...e)).split("/").filter(e=>".."!==e))}trap(e,t,n="warn"){return i(this,void 0,void 0,(function*(){try{const n=yield _.time("fs."+e,t);return this.bflog().trace(`trap ${e}()`,Buffer.isBuffer(n)?"<Buffer>":n),n}catch(t){return void this.bflog().log(n,`trap: ${e}() failed: ${t}`)}}))}trapOr(e,t,n="warn"){return i(this,void 0,void 0,(function*(){try{return this.bflog().debug(`trapOr ${e}()`),yield t(),!0}catch(t){return this.bflog().log(n,`trapOr: ${e}() failed: ${t}`),!1}}))}trapSync(e,t){try{return this.bflog().debug(`trapSync ${e}()`),t()}catch(t){return void this.bflog().warn(`trapSync: ${e}() failed: ${t}`)}}exists(){return i(this,void 0,void 0,(function*(){return null!=this.dirent||(yield x.thenDefined(this.stat()))}))}existsSync(){return null!=this.dirent||null!=this.statSync()}notExists(){return i(this,void 0,void 0,(function*(){return x.thenNot(this.exists())}))}mtime(){return x.thenMap(this.stat(),e=>e.mtime)}mtimeMs(){return x.thenMap(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return x.thenMap(this.stat(),e=>O.unixtime(e.mtime))}lastModifiedUtc(){return i(this,void 0,void 0,(function*(){return x.thenMap(this.stat(),e=>e.mtime.toUTCString())}))}statTimes(){return x.thenMap(this.stat(),e=>c.uniq([e.birthtimeMs,e.mtimeMs].filter(e=>null!=e&&0!==e)))}maxStatMs(){return x.thenMap(this.statTimes(),M.max)}maxStatDate(){return x.thenMap(this.maxStatMs(),e=>new Date(e))}minStatMs(){return x.thenMap(this.statTimes(),C.min)}minStatDate(){return x.thenMap(this.minStatMs(),e=>new Date(e))}size(){return x.thenMap(this.stat(),e=>e.size)}access(e){return this.trapOr("access("+e+")",()=>s.access(this.nativePath,e))}isReadable(){return this.access(s.constants.R_OK)}isHiddenPosix(){return this.base.startsWith(".")}isEmpty(){return i(this,void 0,void 0,(function*(){if(yield this.isDirectory())return c.isNotEmpty(yield this.childNames());{const e=yield this.size();return null==e||0===e}}))}isNonEmpty(e=1){return x.thenMapOr(this.stat(),t=>t.size>e,()=>!1)}isNonEmptyFile(e=1){return i(this,void 0,void 0,(function*(){return(yield this.isFile())&&(yield x.thenMapOr(this.stat(),t=>t.size>e,()=>!1))}))}modifiedGTE(e){return i(this,void 0,void 0,(function*(){return x.thenMap(this.mtime(),t=>O.unixtime(t)>=O.unixtime(e))}))}modifiedCloseTo(e,t){return i(this,void 0,void 0,(function*(){return x.thenMap(this.mtimeMs(),n=>Math.abs(n-e)<=t)}))}modifiedGT(e){return i(this,void 0,void 0,(function*(){if(null!=e)return x.thenMap(this.mtime(),t=>O.unixtime(t)>O.unixtime(e))}))}isDirectory(){return i(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isDirectory():x.thenMapOr(this.stat(),e=>e.isDirectory(),()=>!1)}))}isNotDirectory(){return i(this,void 0,void 0,(function*(){return x.thenNot(this.isDirectory())}))}isDirectorySync(){return null!=this.dirent?this.dirent.isDirectory():g.mapOr(this.statSync(),e=>e.isDirectory(),()=>!1)}isSymbolicLink(){return i(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isSymbolicLink():x.thenMapOr(this.stat(),e=>e.isSymbolicLink(),()=>!1)}))}nearestDir(){return i(this,void 0,void 0,(function*(){return(yield this.isDirectory())?this:this.parent()}))}isFile(){return i(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isFile():this.stat().then(e=>y.Opt(e).map(e=>e.isFile()).getOrElse(()=>!1))}))}isFileSync(){return null!=this.dirent?this.dirent.isFile():y.Opt(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>s.rmdir(this.nativePath),e)}mkdirp(){return i(this,void 0,void 0,(function*(){return(yield this.clear().isDirectory())?this:this.trap("mkdirp",()=>i(this,void 0,void 0,(function*(){try{return yield s.mkdirp(this.nativePath),this.clearThisAndParent()}catch(e){if("EEXIST"!==e.code)throw e}if(null==(yield this.parent().mkdirp()))throw new Error("Failed to mkdirp parent of "+this);if(yield s.mkdir(this.nativePath),!1===(yield x.until(()=>this.clear().isDirectory(),2*f.secondMs)))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()})))}))}mkdirpSync(){return this.trapSync("mkdirpSync",()=>(s.mkdirpSync(this.nativePath),this.clearThisAndParent()))}sha(){return x.thenMap(this.shaResult(),e=>e.b64)}shaMs(){return x.thenMap(this.shaResult(),e=>e.elapsedMs)}writeStream(e,t){return i(this,void 0,void 0,(function*(){return yield $.pipelineAsync([e,s.createWriteStream(this.nativePath,t)]),this.clearThisAndParent()}))}writeJSON(e,t={}){return i(this,void 0,void 0,(function*(){return this.trap("writeJSON",()=>i(this,void 0,void 0,(function*(){return yield this.parent().mkdirp(),yield s.writeFile(this.nativePath,JSON.stringify(e,t.replacer,t.spaces),Object.assign({flag:"w"},t)),this.clearThisAndParent()})))}))}readJSON(){return this.trap("readJSON",()=>d.retryOnReject(()=>s.readJSON(this.nativePath),{maxRetries:2,onRetryWaitUntil:()=>p.delay(25),errorIsRetriable:e=>-2!==e.errno}))}readJSONSync(){return this.trapSync("readJSONSync",()=>s.readJSONSync(this.nativePath))}readFile(){return this.trap("readFile",()=>s.readFile(this.nativePath),void 0)}zReadFile(){return i(this,void 0,void 0,(function*(){const e=new J.WritableToBuffer,t=[s.createReadStream(this.nativePath)];return this.ext.toLowerCase().endsWith(".gz")?t.push(l.createGunzip()):this.ext.toLowerCase().endsWith(".br")&&t.push(l.createBrotliDecompress()),t.push(e),yield $.pipelineAsync(t),e.buffer}))}zcat(){return i(this,void 0,void 0,(function*(){return this.trap("zcat",()=>x.thenMap(this.zReadFile(),w.toS))}))}readLines(){return x.thenMap(this.readFile(),e=>z.splitLines(e.toString()))}readFileSync(){return I.Try(()=>g.map(s.readFileSync(this.nativePath),w.toS))}writeTxt(e){return this.writeFile(z.crlf(e))}writeFile(e){return this.trapOr("writeFile",()=>i(this,void 0,void 0,(function*(){yield this.parent().mkdirp(),yield s.outputFile(this.nativePath,e),this.clearThisAndParent()})))}appendFile(e){return this.trapOr("appendFile",()=>i(this,void 0,void 0,(function*(){yield s.mkdirp(this.dir),yield s.appendFile(this.nativePath,e),this.clearThisAndParent()})))}wip(e="."){return this.sibling(e+this.base)}unwip(e="."){return i(this,void 0,void 0,(function*(){const t=this.sibling(B.stripPrefix(this.base,e));return this.mv(t,{overwrite:!0})}))}dest(e){return i(this,void 0,void 0,(function*(){const t=e.clear();return h.notBlank(this.ext)&&h.blank(t.ext)||(yield t.isDirectory())?t.join(this.base):t}))}copyFile(e){return _.time("fs.copyFile",()=>i(this,void 0,void 0,(function*(){const t=(yield this.dest(e)).clear();if(this.nativePath===t.nativePath)return this;if(null==(yield t.parent().mkdirp()))return this.bflog().throw("Cannot mkdirp "+t.dir);try{return yield this._nativeCopyFile(t)}catch(e){return yield this._copyFile(t)}})))}_copyFile(e){return i(this,void 0,void 0,(function*(){let t;const n=yield this.stat(),o=g.map(n,e=>e.size);if(null==n||null==o)return this.bflog().throw("Can't copy missing files");const a=yield this.sha();if(null==a)return this.bflog().throw("Can't copy file without SHA");const u=e.wip();try{const l=new Promise((e,t)=>r.copyFile(this.nativePath,u.nativePath,r.constants.COPYFILE_FICLONE,n=>null==n?e():t(n)));o>5*S.MiB&&(t=new U.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},o,()=>u.clear().size())),yield l;const c=yield x.until(()=>i(this,void 0,void 0,(function*(){return o===(yield u.clear().size())})),15*f.secondMs),d=yield u.clear().sha();if(!c||d!==a)return this.bflog().throw("copyFile() failed",{sizeMatches:c,destSha:d,thisSha:a});const h=yield u.unwip();return null==h?this.bflog().throw("copyFile("+e+") failed: .unwip() was null"):(yield s.chmod(h.nativePath,n.mode),yield s.utimes(h.nativePath,n.atime,n.mtime),this.bflog().debug(`copyFile(${e.nativePath}): success`),A.emitFileCopied(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(t){throw this.bflog().warn(`copyFile(${u.nativePath}) failed: ${t}`),yield u.unlink(),yield e.unlink(),t}finally{g.map(t,e=>e.end())}}))}copyTimeoutMs(){return i(this,void 0,void 0,(function*(){return x.thenMapOr(this.size(),e=>Math.max(j.cmdTimeoutMs,e*j.MinIoRate),()=>j.cmdTimeoutMs)}))}_nativeCopyFile(e){return i(this,void 0,void 0,(function*(){let t;try{const n=yield this.stat(),i=g.map(n,e=>e.size);return null==n||null==i?this.bflog().throw("Can't copy missing files"):(i>5*S.MiB&&(t=new U.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},i,()=>e.clear().size())),L.isWin?yield R.PowerShell.instance().execute(`Copy-Item -LiteralPath ${R.pwshQuote(this.nativePath)} -Destination ${R.pwshQuote(e.nativePath)}`,e=>e):yield T.stdout("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:yield this.copyTimeoutMs()}),A.emitFileCopied(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(t){return this.bflog().throw("_nativeCopyFile("+e+"): "+t)}finally{g.map(t,e=>e.end())}}))}touch(e=Date.now(),t){return i(this,void 0,void 0,(function*(){return this.trap("touch",()=>x.thenMap(this.ensureFile(),()=>this.utimes(e,t)))}))}utimes(e,t){return i(this,void 0,void 0,(function*(){const n=g.orElse(e,Date.now()),i=g.orElse(t,n);return this.trap("utimes",()=>s.utimes(this.nativePath,O.unixtime(i),O.unixtime(n)).then(()=>this.clearThisAndParent()))}))}unlink(e="warn"){return i(this,void 0,void 0,(function*(){return this.trap("unlink",()=>i(this,void 0,void 0,(function*(){return yield s.unlink(this.nativePath),this.clearThisAndParent()})),e)}))}remove(){return i(this,void 0,void 0,(function*(){return this.trap("remove",()=>i(this,void 0,void 0,(function*(){return this.bflog().info("remove()"),yield s.remove(this.nativePath),this.clearThisAndParent()})))}))}unlock(){return i(this,void 0,void 0,(function*(){return L.isMac&&(yield this.clear().exists())&&(yield T.stdout("chflags",["nouchg",this.nativePath],{timeout:j.cmdTimeoutMs})),this}))}renameWithNameSuffix(e){return i(this,void 0,void 0,(function*(){return x.thenMap(this.withNameSuffix(e).ensureNew({emptyIsNew:!0}),e=>e.unlink("debug").then(()=>this.mv(e)))}))}mv(e,t={overwrite:!1}){return i(this,void 0,void 0,(function*(){const n=yield this.dest(e);return this.nativePath===n.nativePath?(this.bflog().warn("mv(): no-op",new Error("internal error")),this):(yield n.parent().mkdirp(),yield Promise.all([this.unlock(),n.unlock()]),this.bflog().debug("mv",n),yield s.move(this.nativePath,n.nativePath,t),yield n.unlock(),this.clearThisAndParent(),n.clearThisAndParent())}))}pipeTo(e,t){return i(this,void 0,void 0,(function*(){return this.trap("pipeTo("+e+")",()=>i(this,void 0,void 0,(function*(){const n=yield this.for(this.nativePath+v.ensurePrefix(e,".")).ensureNew();return yield $.pipelineAsync([s.createReadStream(this.nativePath),t,s.createWriteStream(n.nativePath)]),yield this.unlink(),n})))}))}gzip(){return i(this,void 0,void 0,(function*(){return this.pipeTo(".gz",l.createGzip())}))}compressBrotli(){return i(this,void 0,void 0,(function*(){return this.pipeTo(".br",l.createBrotliCompress())}))}ensureFile(){return this.trap("ensureFile",()=>s.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync(){return this.trapSync("ensureFileSync",()=>(s.ensureFileSync(this.nativePath),this.clearThisAndParent()))}get nameWithoutCount(){return W.nameWithoutCount(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}ensureNewNativePath(e){return i(this,void 0,void 0,(function*(){const n=Object.assign(Object.assign({},t.DefaultEnsureNewOptions),e);if(this.clear(),!n.requireNumber&&((yield this.notExists())||n.emptyIsNew&&(yield this.isEmpty())))return this.nativePath;const i=this.parent();yield i.mkdirp();for(let e=n.startIndex;e<=n.maxVersions;e++){const t=i.join(`${this.name}-${B.leftPad(e,n.leftPad,"0")}${this.ext}`);if(t.clear(),(yield t.notExists())||n.emptyIsNew&&(yield t.isEmpty()))return t.nativePath}throw new Error("There are already more than "+n.maxVersions+" of "+this)}))}ensureNew(e={}){return this.ensureNewNativePath(e).then(e=>this.for(e))}renameYMD(){return i(this,void 0,void 0,(function*(){if(yield this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");const e=k.datedToYMD(yield x.thenOrElse(this.mtime(),()=>new Date));return this.mv(yield this.withNameSuffix("-"+e).ensureNew({emptyIsNew:!0}))}))}saveIfNewOrDelete(e){return i(this,void 0,void 0,(function*(){if(yield this.clear().isEmpty())return void(yield this.unlink("trace"));const t=yield this.siblingWithSameContents();if(null!=t)return yield this.unlink(),t;const n=yield this.sibling(e).ensureNew();return this.mv(n)}))}chmod(e){return i(this,void 0,void 0,(function*(){return yield s.chmod(this.nativePath,e),this.clear()}))}zreadline(){return a.createInterface({input:s.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe(l.createGunzip()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)})})}siblingWithSameContents(){return i(this,void 0,void 0,(function*(){return this.parent().childWithSameContents(this)}))}childWithSameContents(e){return i(this,void 0,void 0,(function*(){return _.time("fs.childWithSameContents",()=>i(this,void 0,void 0,(function*(){if((yield this.notExists())||!(yield this.isDirectory()))return;const t=yield e.size(),n=yield this.children(),i=[];for(const r of b.toA(n))(yield r.size())!==t||e.eql(r)||i.push(r);if(c.isEmpty(i))return;const r=yield e.sha();for(const e of i.sort((e,t)=>N.diceCoeff(e.base,t.base)).reverse())if((yield e.sha())===r)return e})))}))}applyWip(e){return i(this,void 0,void 0,(function*(){const t=this.wip();try{yield s.mkdirp(t.dir),yield t.unlink("debug");const n=yield e(t);if(yield t.clear().isEmpty())throw new Error("applyWip(): builder didn't write to dest");return yield t.unwip(),n}catch(e){throw yield x.tryAll([()=>t.unlink(),()=>this.unlink()]),e}}))}applyIfEmpty(e,t=0){return i(this,void 0,void 0,(function*(){return(yield this.clear().isNonEmpty(t))?(this.bflog().debug("applyIfEmpty(): non-empty"),this):(this.bflog().debug("applyIfEmpty(): empty, applying..."),yield this.applyWip(e),this)}))}firstMatchingLine(e){const t=new P.Deferred("firstMatchingLine("+this+")"),n=r.createReadStream(this.nativePath,{flags:"r"});return n.on("error",e=>{-2===e.errno||"ENOENT"===e.code?(t.maybeResolve(void 0),n.close()):t.maybeReject(e)}),n.on("close",()=>t.maybeResolve(void 0)),G.onDataChunked(n,B.newlineRe,i=>{const r=e.exec(i);null!=r&&(t.maybeResolve(r),n.close())}),t.promise}}t.BaseFile=X,X.attrTTL=3*f.minuteMs,X.projectRoot=m.lazy(()=>{const e=H.ProjectPath.Root();if(null==e)throw new Error("Cannot find project path");return X.for(e)})},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(95),s=n(34),o=n(1),a=n(3),u=n(6),l=n(28),c=n(59),d=n(2),h=n(0),f=n(10),p=n(19),m=n(7),g=n(40),y=n(24),v=n(8),b=n(66),w=n(161),S=n(53),M=n(21),P=n(57),E=n(13),x=n(163),_=n(29),F=n(164),T=n(177),O=n(198),A=n(127),k=n(73),D=n(4),C=n(16),I=n(11),L=n(70),R=n(129),B=n(197),N=n(282),j=n(47),z=n(283),q=n(199),V=n(200),W=n(99),U=n(130),H=n(179),G=d.lazy(()=>D.mkLogger("ExifTags")),$=d.lazy(()=>{const e=L.maxCpus()>4?2:1;return w.observeBatchCluster(new r.ExifTool({maxProcs:e,maxIdleMsPerProcess:u.minuteMs,cleanupChildProcs:!1}),"exiftool",y.EndableRanks.service).bc});function J(){const e=$();return e.ended?$.refresh():e}t.exiftool=J,t.shutdownExiftool=function(e=!1){return h.map($.clear(),t=>t.end(e))},E.onFileCopied((e,t)=>v.thenMap(Z(e),e=>{const n=_.PosixFile.for(t);return K.getOrSet(n.nativePath,()=>Promise.resolve(Object.assign(Object.assign({},e),{SourceFile:n.nativePath,FileName:n.base,Directory:n.dir})))})),t.extractBinaryTag=function(e,t,n){return J().extractBinaryTag(e,t,n)};const K=new S.BoundedMap(7*u.minuteMs,1024,!0);function Y(){K.clear(),t.rawTagsCache.clear()}t.rawTagsCache=new S.BoundedMap(7*u.minuteMs,1024,!0),t.clearTagsCache=Y,E.onClearCache(Y),E.onFileChanged(e=>{a.blank(e)?Y():(K.deleteIf(t=>t.startsWith(e)),t.rawTagsCache.deleteIf(t=>t.startsWith(e)))});const Q=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];function X(e){return i(this,void 0,void 0,(function*(){if(null==e)return;const t=_.PosixFile.for(e);return(yield t.isEmpty())?void 0:K.getOrSet(t.nativePath,()=>b.time("readTags",()=>i(this,void 0,void 0,(function*(){return v.thenMap(ie(t),e=>ae(t,e))}))))}))}function Z(e){return i(this,void 0,void 0,(function*(){return K.get(String(e))}))}function ee(e){return i(this,void 0,void 0,(function*(){if(a.blank(e))return;const t=_.PosixFile.for(e);return v.firstDefinedPromise([()=>v.thenMap(Z(t),e=>e.MIMEType),()=>v.thenMap(x.readFileType(t.nativePath),e=>"image/tiff"==e.mime?void 0:e.mime),()=>j.isExifExt(t.ext)?v.thenMap(ie(t,!1),e=>e.MIMEType):void 0])}))}function te(e,t){return i(this,void 0,void 0,(function*(){const n=_.PosixFile.for(e),i=null==t||a.blank(t.ImageHeight)?yield ie(n):t;if(null==i)return;const r=h.orElse(W.extractRotation(t),()=>W.extractRotation(i)),s=T.dcrawSupportedMimetype(i.MIMEType)?yield O.rawInfo(n).catch(e=>{G().warn("Failed to read raw info",{file:n.nativePath,err:l.errorToS(e)})}):void 0,o=U.extractSizeInfo(i,r,s);return null!=o?o:k.isVideoMimeType(i.MIMEType)?v.thenMap(A.extractVideoFrame(n,i.MIMEType),e=>te(e,i)):void 0}))}function ne(e,t="_original"){return i(this,void 0,void 0,(function*(){return e.sibling(e.base+t).saveIfNewOrDelete(e.name+t+e.ext)}))}function ie(e,t=!0){return G().debug("readRawTags(): ",m.toS(e)),b.time("tags.readRawTags",()=>i(this,void 0,void 0,(function*(){const n=_.PosixFile.for(e);if(!(yield n.isFile()))return;const r=yield oe(n.nativePath);if(null==r||!t)return r;const s=[],a=v.thenMap(n.jsonSidecar(),e=>i(this,void 0,void 0,(function*(){const t=yield z.readJsonSidecar(e);return null!=t&&s.push(e.base),t}))),u=v.thenMap(n.sidecars(),e=>v.tuples(e,e=>oe(e.nativePath)));let l=Object.assign(Object.assign({},r),yield a);for(const[e,t]of p.toA(yield u))s.push(t.base),l=Object.assign(Object.assign({},l),f.compactValues(f.without(e,...Q)));return o.isNotEmpty(s)&&(l.sidecars=s),l})))}t.sidecarEql=function(e,t){return i(this,void 0,void 0,(function*(){const n=e=>v.thenMap(ie(e,!1),e=>f.without(e,...Q));return(yield P.eqlAsync(e.clear().sha(),t.clear().sha()))||(yield P.eqlAsync(n(e),n(t)))}))},t.readTags=X,t.cachedTags=Z,t.capturedAt=function(e){return i(this,void 0,void 0,(function*(){return v.thenMap(X(e),e=>e.capturedAt)}))},t.mimetype=ee,t.readRotation=function(e){return i(this,void 0,void 0,(function*(){return v.thenMap(ie(e,!0),W.extractRotation)}))},t.isMimetype=function(e,t){return i(this,void 0,void 0,(function*(){const n=yield ee(e);return G().tap({msg:"isMimetype",meta:{path:m.toS(e),mimeType:n},result:null!=n&&t.has(n)})}))},t.sizeInfo=te,t.moveOriginal=ne,t.deleteAllTags=function(e){return i(this,void 0,void 0,(function*(){yield J().deleteAllTags(e.nativePath),yield e.sibling(e.base+"_original").unlink("trace")}))},t.writeTags=function(e,t){return b.time("tags.writeTags",()=>i(this,void 0,void 0,(function*(){const n=yield e.sidecar(),i=I.Settings.writeMetadataToSidecars.valueOrDefault||(yield n.exists())?n:e;yield J().write(i.nativePath,t,I.Settings.overwriteOriginal.valueOrDefault?["-overwrite_original"]:void 0);const r=yield ne(i);return o.uniq([e.nativePath,i.nativePath]).forEach(E.emitFileChanged),e.clearThisAndParent(),i.clearThisAndParent(),{original:r,dest:i}})))},t.readRawTags=ie;const re=new c.Latch,se=new c.Latch;function oe(e){return i(this,void 0,void 0,(function*(){return t.rawTagsCache.getOrSet(e,()=>i(this,void 0,void 0,(function*(){G().debug("readRawTags("+e+")");const t=re.pending;t?re.resolve():yield se.promise;const n=j.isVideoExt(s.extname(e))?[]:void 0,i=yield v.thenOrTimeout(M.thenElapsed(J().read(e,n).catch(t=>{G().info("Failed to read "+e,t)})),30*u.secondMs);return t&&se.resolve(),h.map(i,t=>(G().debug("read("+e+") in "+t.elapsedMs+"ms"),h.map(t.result,e=>{const n=o.compactBlanks([e.Error,...h.orElse(e.errors,[]),e.Warning].map(m.toS));return o.isNotEmpty(n)&&(e.problems=n),e.exiftoolMs=t.elapsedMs,e})))})))}))}function ae(e,t){return i(this,void 0,void 0,(function*(){if(null==t)return;const n=t.MIMEType,i=e.nativePath;if(a.blank(n))return void G().debug("No mimetype for "+e);const r=e.nativePath.startsWith(g.App.cache())||e.pathnames.includes(".photostructure");r||(yield H.inferMakeAndModel(e,t)),t.Make=V.make(t.Make),t.Model=V.model(t.Make,t.Model);const s=q.extractLensMakeModel(t),o=yield R.extractCapturedAt(e,t,r);if(null==o)return void G().info("No capturedAt for "+e);const u=N.extractExposureSettings(t),l=yield te(e,t);if(null==l)return void G().info("No size info for "+i);const c=Object.assign(Object.assign(Object.assign({mimetype:n,exposureSettings:u},s),l),{duration:n.startsWith("video/")?B.extractDurationSec(t):void 0,capturedAt:o,geohash:F.geohashNumeric(t.GPSLatitude,t.GPSLongitude),tz:t.tz});return G().debug("parsedTags",Object.assign(Object.assign({nativePath:i},c),{tzSource:t.tzSource,capturedAt:h.map(o,e=>({date:e.date,src:e.src}))})),Object.assign(Object.assign({},t),c)}))}C.isWin||(re.resolve(),se.resolve()),t.parseTags=ae},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(94),r=n(51);var s;function o(e){return"symbol"==typeof e}function a(e){return"function"==typeof e}function u(e){return null==e?s.Empty:o(e)?s.Symbol:r.isPrimitive(e)?s.Primitive:Array.isArray(e)?s.Array:i.isIterable(e)?s.Iterable:a(e)?s.Function:"object"==typeof e?e.constructor&&"Object"===e.constructor.name?s.Object:s.Instance:s.Unknown}!function(e){e[e.Empty=0]="Empty",e[e.Primitive=1]="Primitive",e[e.Symbol=2]="Symbol",e[e.Object=3]="Object",e[e.Array=4]="Array",e[e.Iterable=5]="Iterable",e[e.Instance=6]="Instance",e[e.Function=7]="Function",e[e.Unknown=8]="Unknown"}(s=t.ObjectType||(t.ObjectType={})),t.isSymbol=o,t.isFunction=a,t.isObject=function(e){return u(e)===s.Object},t.objectType=u},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(68),o=n(6),a=n(223),u=n(38),l=n(2),c=n(24),d=n(8),h=n(17),f=n(175),p=n(20),m=n(13),g=n(4),y=n(16),v=n(117),b=n(225),w=n(226),S=n(25);let M;function P(){return i(this,void 0,void 0,(function*(){return null==M&&null==t.localMountpointSetup.prior()&&(yield t.localMountpointSetup()),s.retryOnReject(()=>(M||t.nonRpcMountpoints)(),{maxRetries:3,onRetryWaitUntil:e=>u.delay(1500*e)}).catch(e=>{p.onError("mountpoints() failed",e)})}))}t.nonRpcMountpoints=l.lazy(y.isWin?w.mountpointsWin:b.mountpointsPosix,S.mountpointsTtlMs),m.onClearCache(()=>t.nonRpcMountpoints.clear()),t.setRpcMountpointsImpl=function(e){M=e,t.localMountpointSetup.clear()},t.localMountpointSetup=l.lazy(()=>i(void 0,void 0,void 0,(function*(){null==M?u.later(()=>i(void 0,void 0,void 0,(function*(){const e=g.mkLogger("Mountpoints.localMountpointSetup()");y.isMac?(e.info("Setting up Mac diskutil activity watcher"),t.nonRpcMountpoints.setTTL(S.dfTtlMs),t.diskUtilActivity()):y.isLinux&&((yield v.isGioSupported())?(e.info("Setting up Linux gio mount monitor"),t.nonRpcMountpoints.setTTL(S.dfTtlMs),t.gioMountMonitor()):(yield E())&&(e.info("Setting up Linux findmnt mount monitor"),t.nonRpcMountpoints.setTTL(S.dfTtlMs),t.findmntPoll()))})),30*o.secondMs).unref():yield d.awaitAll([c.end(t.diskUtilActivity.clear()),c.end(t.gioMountMonitor.clear()),c.end(t.findmntPoll.clear())])}))),t.mountpoints=P,t.mountsCacheKey=()=>d.thenMap(P(),e=>r.sort(e).join(":")),t.diskUtilActivity=l.lazy(()=>f.mkBasicWatchedChild({cmd:"diskutil",args:["activity"],onStdout:a.debounce(()=>t.nonRpcMountpoints.clear(),1.5*o.secondMs)})),t.gioMountMonitor=l.lazy(()=>f.mkBasicWatchedChild({cmd:v.GioCommand,args:v.GioMountMonitorArgs,onStdout:a.debounce(()=>{v.gioVolumes.clear(),v.mtabEntries.clear(),t.nonRpcMountpoints.clear()},1.5*o.secondMs)}));const E=l.lazy(()=>i(void 0,void 0,void 0,(function*(){if(!y.isLinux)return!1;try{return 0===(yield h.stdoutResult("findmnt",["--version"],{timeout:S.cmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}})));t.findmntPoll=l.lazy(()=>f.mkBasicWatchedChild({cmd:"findmnt",args:["--poll"],onStdout:a.debounce(()=>t.nonRpcMountpoints.clear(),1.5*o.secondMs)}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(5),r=n(37),s=new Intl.NumberFormat;function o(e){return s.format(e)}t.fmt=o,t.KB=1e3,t.MB=1e3*t.KB,t.GB=1e3*t.MB,t.TB=1e3*t.GB,t.KiB=1024,t.MiB=1024*t.KiB,t.GiB=1024*t.MiB,t.TiB=1024*t.GiB;const a=["B","KB","MB","GB","TB","PB"],u=["B","KiB","MiB","GiB","TiB","PiB"];t.fmtBytes=function(e,t=3){const n=Math.floor(Math.log10(e)),r=Math.floor(n/3),s=Math.pow(10,3*r),o=a[r];return i.sigFigs(e/s,t)+" "+o},t.fmtMebi=function(e,t=3){const n=Math.floor(Math.log2(e)),r=Math.floor(n/10),s=Math.pow(2,10*r),o=u[r];return i.sigFigs(e/s,t)+" "+o},t.MP=1e6,t.megapixels=function(e){return i.sigFigs(e/t.MP,3)},t.SizeDescriptions=r.strEnum("tiny","small","medium","large","original"),t.pixels2size=function(e){return e<76800?"tiny":e<345600?"small":e<2073600?"medium":"large"},t.plur=function(e,t,n=t+"s"){return o(e)+" "+(1===e?t:n)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(46);t.strEnum=function(...e){const t=Object.freeze(e),n={};for(const e of t)n[e]=e;const r=e=>null!=e&&t.includes(e);return Object.assign(Object.assign({},n),{values:t,has:r,indexOf:e=>null==e?-1:t.indexOf(e),validOrElse:(e,t)=>r(e)?e:i.tot(t),map:(e,t)=>r(e)?t(e):void 0})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(43),r=n(5);function s(e){return o(e,!1)}function o(e,t){return new Promise(n=>{if(e<=0)n();else{const s=i.setTimeout(()=>n(),r.round(e+1));t&&s.unref()}})}t.unrefDelay=function(e){return o(e,!0)},t.delay=s,t.delayUntil=function(e){const t=(r.gt0(e)?e:e.getTime())-Date.now();if(t<0){if(t>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-t+"ms")}return s(t).then(()=>t)},t.later=function(e,t=1){return i.setTimeout(e,Math.max(1,Math.round(t)))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(96),s=n(3),o=n(6),a=n(2),u=n(0),l=n(24),c=n(8),d=n(161),h=n(17),f=n(21),p=n(13),m=n(72),g=n(4),y=n(26),v=n(9),b=n(25),w=10*o.minuteMs;p.onClearCache(()=>u.map(S.instance.prior(),e=>e.clearMockResults())),t.pwshQuote=function(e){return'"'+v.splitKeep(e,/['`"ââ#]/g,!0).join("`").replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v")+'"'};class S{constructor(){this.name="PowerShell",this.logger=g.mkLogger("PowerShell"),this.mockResults=new Map,this.pwsh=d.observeBatchCluster(new r.BatchCluster({processFactory:()=>h.execFile("powershell",[],w),versionCommand:'function prompt {"{ready}"}',pass:"{ready}",fail:"Error",exitCommand:"exit",maxProcs:2,maxTasksPerProcess:150,taskTimeoutMillis:b.cmdTimeoutMs,cleanupChildProcs:!1}),"PowerShell",l.EndableRanks.db).bc}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return c.thenMap(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockResult(e,t){this.mockResults.set(v.ensureSuffix(e," | ConvertTo-Json -Compress"),t)}clearMockResults(){this.mockResults.clear()}execute(e,t){return i(this,void 0,void 0,(function*(){if(this.pwsh.ended||l.ending())this.logger.warn("execute() failed (ended)",{cmd:e});else{if(y.isTest&&this.mockResults.has(e)){const n=this.mockResults.get(e);return t(n.stdout,n.stderr,n.passed)}try{this.logger.debug("execute()",{cmd:e});const n=yield f.elapsedAsync(()=>this.pwsh.enqueueTask(new r.Task(e,(n,i,r)=>t(u.map(n,t=>v.stripPrefix(t,e)),i,r))));return this.logger.log(m.ms2level(n.elapsedMs,7*o.secondMs),"execute()",{cmd:e,elapsedMs:n.elapsedMs}),n.result}catch(t){return void this.logger.warn("execute() failed: "+t,{cmd:e})}}}))}executeJson(e){return i(this,void 0,void 0,(function*(){const t=yield this.execute(v.ensureSuffix(e," | ConvertTo-Json -Compress"),(e,t,n)=>({stdout:e,stderr:t,passed:n}));if(null!=t)if(s.blank(t.stdout)||s.notBlank(t.stderr)||!t.passed)this.logger.warn("executeJson(): failed result",Object.assign({cmd:e},t));else try{return JSON.parse(t.stdout)}catch(e){const n=t.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:v.ellipsize(t.stdout),after:v.ellipsize(n)}),JSON.parse(n)}else this.logger.warn("executeJson(): null result",{cmd:e})}))}executeJsonToA(e){return i(this,void 0,void 0,(function*(){return c.thenMap(this.executeJson(e),e=>Array.isArray(e)?e:[e])}))}}t.PowerShell=S,S.instance=a.lazy(()=>new S)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(56),r=n(44),s=n(18),o=n(1),a=n(2),u=n(0),l=n(10),c=n(37),d=n(108),h=n(109),f=n(12),p=n(27),m=n(26),g=n(11);var y;t.AppPaths=c.strEnum("exe","home","appData","userData","pictures","cache"),t.filenameSafeUsername=r.userInfo().username.replace(/[^a-z-_]/gi,""),function(e){e.getName=function(){return h.AppName},e.exe=a.lazy(()=>s.execPath),e.home=a.lazy(()=>u.orElse(f.first(o.compactBlanks([r.homedir(),s.env.HOME,s.env.HOMEPATH,s.env.USERPROFILE]).map(e=>p.resolve(e)),e=>u.map(i.statSync(e),()=>e)),r.homedir())),e.appData=a.lazy(()=>d.appData()),e.appName=a.lazy(()=>h.AppName+(m.isProd?"":"-"+m.nodeEnv)),e.userData=a.lazy(()=>p.resolve(e.appData(),e.appName())),e.pictures=a.lazy(()=>p.resolve(e.home(),"Pictures")),e.cache=()=>g.Settings.cacheDir.valueOrDefault,e.getPath=function(t){return l.maybeCall(e,t)},e.setPath=function(t,n){"cache"===t?g.Settings.cacheDir.tmpValue=n:e[t].set(p.resolve(n))}}(y=t.App||(t.App={})),y.appName.onChange(()=>y.userData.clear())},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(5),o=n(19),a=n(110),u=n(14),l=n(91);function c(e,t){const n=new a.CountingSet;return o.toA(e).forEach(e=>s.mapFinite(e,e=>n.incr(e))),n.topKeys(t)}function d(e){return o.toA(e).reduce((e,t)=>e+t,0)}function h(e){const t=o.toA(e);return i.isEmpty(t)?void 0:t.reduce((e,t,n)=>0===n?t:e*n/(n+1)+t/(n+1),0)}function f(e){return r.map(h(e),t=>h(e.map(e=>Math.pow(e-t,2))))}function p(e){return Math.sqrt(e.reduce((e,t)=>e+t*t,0))}function m(e,t){return e.reduce((e,n,i)=>e+n*t[i],0)}t.min=function(e){let t=void 0;for(const n of e)null!=n&&(null==t||n<t)&&(t=n);return t},t.max=function(e){let t=void 0;for(const n of e)null!=n&&(null==t||n>t)&&(t=n);return t},t.deltas=function(e){const t=o.toA(e);return null==e||t.length<=1?[]:t.slice(1).map((t,n)=>t-e[n])},t.modes=c,t.mode=function(e){return c(e,1)[0]},t.sum=d,t.avg=h,t.slope=function(e){const t=o.toA(e);return r.map(h(t),e=>{const n=(t.length-1)/2,i=d(t.map((t,i)=>(t-e)*(i-n))),r=d(t.map(t=>Math.pow(t-e,2)));return 0===r?0:i/r})},t.avgMaybe=function(...e){const t=i.compact(e);return i.isEmpty(t)?void 0:d(t)/t.length},t.variance=f,t.stdDev=function(e){return r.map(f(e),e=>Math.sqrt(e))},t.weightedAvg=function(e){let t;for(const n of e)t=null==t?n:(t+n)/2;return null==t?NaN:t},t.avgWeighted=function(e,t){let n=0;return e.reduce((e,i,r)=>{const s=u.mapGt0Or(t[r],e=>e,1);return n+=s,e+i*s},0)/n},t.euclidean=function(e,t){return Math.sqrt(o.toA(e).reduce((e,n,i)=>e+Math.pow(n-t[i],2),0))},t.centroid=function(e){return s.times(e[0].length,t=>h(e.map(e=>e[t])))},t.l2norm=p,t.dot=m,t.cosineSimilarity=function(e,t){return s.finiteOrElse(m(e,t)/(p(e)*p(t)),void 0)},t.jaccard=function(e,t){return i.isEmpty(e)&&i.isEmpty(t)?0:s.finiteOrElse(l.intersection(e,t).size/l.union(e,t).size,void 0)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(95),r=n(79),s=n(1),o=n(3),a=n(6),u=n(2),l=n(0),c=n(5),d=n(15),h=n(7),f=n(12),p=n(123),m=n(57),g=n(14),y=n(22),v=n(9);function b(e,t=2){return null==e?"":v.leftPad(e,t,"0")}function w(e){if(null==e||"string"==typeof e||0===e)return!1;const t=ne(e);return null!=t&&0!==t&&(!!E(q(e),V(e),W(e))&&(!ae(e)||l.mapOr(Z(e),e=>e.isValid,()=>!1)))}function S(e){return g.within(t.minYear,t.maxYear,e)}function M(e){return g.within(1,12,e)}function P(e,t,n){return null!=n&&r.DateTime.fromObject({year:e,month:t,day:n}).isValid}function E(e,t,n){return S(e)&&(null==t||M(t)&&(null==n||P(e,t,n)))}t.validDate=w,t.mapValidDate=function(e,t){return w(e)?t(e):void 0},t.minYear=1826,t.maxYear=(new Date).getFullYear()+2,t.validYear=S,t.validMonth=M,t.validDay=P,t.validYMD=E;class x{constructor(e,t,n){this.year=e,this.month=t,this.day=n}static for(e,t,n){return E(e,t,n)?new x(e,t,n):void 0}static localToday(){return se(new Date)}toString(){return s.compact([this.year,this.month,this.day]).map(e=>b(e)).join("-")}toISOString(){return this.toString()}toDateTime(){return r.DateTime.fromObject(this)}}t.FuzzyDate=x;class _{constructor(e,t,n,i,r){this.monthsToMonth=e,this.re=t,this.yearIndex=n,this.monthIndex=i,this.dayIndex=r}apply(e){const t=this.re.exec(e);if(null!=t){const e=parseInt(t[this.yearIndex],10),n=this.month(t),i=null==this.dayIndex?void 0:parseInt(t[this.dayIndex],10);return x.for(e,n,i)}}month(e){if(null==this.monthIndex)return;const t=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(t)?this.monthsToMonth.get(t):c.toInt(t)}}const F="((?:19|20)[0-9]{2})",T="([1-3][0-9]|0?[1-9])",O="([0-5][0-9])",A=O,k=O,D="([-\\.\\,:_/ |])?",C="(?:(Z)|(?:([+-])([01][0-9]):?([0-5][0-9])))",I=new RegExp("\\d\\d"+C+"(?:\\/|$)","i");function L(e,t){if(s.isEmpty(e))return t;const[n,i]=e.splice(0,2),[r,o]=e.splice(0,2).map(e=>c.toInt(e));return v.equalsIgnoreCase(n,"z")?0:f.anyNotDefined([i,r,o])?t:("-"===i?-1:1)*(60*r+o)}function R(e){return o.mapNotBlank(e,e=>y.firstTrueThunk([()=>i.ExifDateTime.fromEXIF(e),()=>Q(e)],e=>w(e)))}t.isoToOffsetMinutes=function(e){return l.map(I.exec(e),e=>L(e.slice(1)))},t.dateTimeBetween=function(e,t){return e.until(t).divideEqually(2)[0].end},t.agoMs=function(e){return c.mapNumeric(ne(e),e=>Date.now()-e)},t.parseDateTime=R,t.parseDated=function(e){return o.mapNotBlank(e,e=>y.firstTrueThunk([()=>p.DateInterval.fromISO(e),()=>R(e),()=>i.ExifDate.fromEXIF(e),()=>j().parseYMD(e),()=>new Date(e)],e=>w(e)))};class B{constructor(e){this.locale=e,this.monthsToMonth=new Map,this.ymdPatterns=[],this.ymPatterns=[],this.setup()}parseYMD(e){return f.first(this.ymdPatterns,t=>t.apply(e))}addParser(e,t,n,i){const r=new _(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),t,n,i);null!=i&&null!=n?this.ymdPatterns.push(r):null!=n&&this.ymPatterns.push(r)}setup(){["short","long"].forEach(e=>{const t=new Intl.DateTimeFormat(this.locale,{month:e});c.times(12,e=>{const n=t.format(new Date(2017,e));this.monthsToMonth.set(n.toLowerCase(),e+1)})});const e="("+s.sort([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(F+D+"(1[0-2]|0?[1-9])\\2"+T,1,3,4),this.addParser(F+D+e+"\\2"+T,1,3,4),this.addParser(e+D+T+",?\\2"+F,4,1,3),this.addParser(T+D+e+",?\\2"+F,4,3,1),this.addParser(e+D+F,3,1),this.addParser(F+D+e,1,3)}extractDateFromPath(e){z.forEach(t=>{s.startsWith(e,t)&&e.splice(0,t.length)}),e=e.filter(t=>o.notBlank(t)&&null==e[0].match(N));const t=[...e].reverse();return y.firstThunk(()=>f.first(t,e=>this.parseYMD(e)),()=>this.parseYMD(e.join(" ")),()=>this.parseYMD(t.join(" ")),()=>f.first(this.ymPatterns,t=>t.apply(e.join(" "))),()=>f.first(this.ymPatterns,e=>e.apply(t.join(" "))))}}t.FuzzyDateParser=B;const N=/^((DCIM)|(DSC[_0F]?|IMG_|GOPRO|MOV_|P)\d+)$/i,j=u.lazy(()=>new B(void 0)),z=[];function q(e){return l.map(e,e=>e instanceof Date?e.getFullYear():e.year)}function V(e){return l.map(e,e=>e instanceof Date?e.getMonth()+1:e.month)}function W(e){return l.map(e,e=>e instanceof Date?e.getDate():e.day)}function U(e){return ae(e)?e instanceof Date?e.getHours():e.hour:void 0}function H(e){return ae(e)?e instanceof Date?e.getMinutes():e.minute:void 0}function G(e){return ae(e)?e instanceof Date?e.getSeconds():e.second:void 0}function $(e){return ae(e)?e instanceof Date?e.getMilliseconds():e.millisecond:void 0}function J(e,t=!0){if(null==e)return;if(0===e)return t?"UTC":"";const n=e<0?"-":"+",i=15*c.round(e/15),r=Math.abs(i),s=Math.floor(r/60),o=Math.floor(Math.abs(r%60));return`${t?"UTC":""}${n}${b(s)}:${b(o)}`}function K(e){return e instanceof i.ExifDateTime?e.hasZone:e instanceof r.DateTime&&(null!=e.zone&&"local"!==e.zone.type)}function Y(e){return e instanceof r.DateTime?l.map(e.zone,e=>e.name):e instanceof i.ExifDateTime?e.zone:void 0}function Q(e,t=X){const n=t.exec(e);if(null==n)return;const i=[...n.slice(1)],[s,o,a,u,l,h]=i.splice(0,6).map(e=>c.toInt(e)),f=c.clamp(0,999,1e3*c.toFloat(i.shift(),{defaultValue:0})),p=J(L(i));return d.Opt(r.DateTime.fromObject({year:s,month:o,day:a,hour:u,minute:l,second:h,millisecond:f,zone:p})).filter(e=>e.isValid).flatMap(e=>ee(e,p)).get()}t.addIgnorableSubpath=function(e){z.push(e)},t.clearIgnorableSubpaths=function(){z.length=0},t.extractDateFromPath=function(e){return j().extractDateFromPath(e)},t.parseYMD=function(e){return j().parseYMD(e)},t.isDated=function(e){return null!=e&&(e instanceof x||e instanceof i.ExifDate||e instanceof i.ExifDateTime||e instanceof Date||e instanceof p.DateInterval||e instanceof r.DateTime||l.allDefined([e.year,e.month,e.day]))},t.getYear=q,t.getMonth=V,t.getDay=W,t.getHour=U,t.getMinute=H,t.getSecond=G,t.getMillisecond=$,t.hasSeconds=function(e){return ae(e)&&(c.gt0(H(e))||c.gt0(G(e))||c.gt0($(e)))},t.getSecMs=function(e){return l.map(G(e),t=>{const n=l.orElse($(e),0);let i=(t+n/1e3).toString();for(t<10&&(i="0"+i),0===n&&(i+=".");i.length<6;)i+="0";return i})},t.zoneOffsetToName=J,t.hasZone=K,t.getZoneName=Y,t.parseExifDateTime=Q;const X=new RegExp([F,"(1[0-2]|0[1-9])","([1-3][0-9]|0[1-9])","(1[0-9]|2[0-3]|0[0-9])",A,k,"(?:(\\.[0-9]+))?"].join("[-:_ ]?")+C+"?","i");function Z(e){return e instanceof r.DateTime?e:e instanceof i.ExifDateTime?e.toDateTime():e instanceof p.DateInterval?e.middle.toDateTime():e instanceof Date?r.DateTime.fromJSDate(e):void 0}function ee(e,t){if(null==e||!ae(e))return;if(e instanceof r.DateTime)return i.ExifDateTime.fromDateTime(e);const n=ne(e);if(null==n)return;const s=o.blank(t)?K(e)?Y(e):void 0:t,a=o.mapNotBlank(s,e=>ue(n,e));if(null!=t&&null==a)return;const u=l.map(q(e),t=>l.map(V(e),n=>l.map(W(e),r=>l.map(U(e),s=>new i.ExifDateTime(t,n,r,s,l.orElse(H(e),0),l.orElse(G(e),0),$(e),a,e.rawValue)))));return w(u)?u:void 0}function te(e){if(null==e)return;if("number"==typeof e)return new Date(e);if(e instanceof Date)return e;if(e instanceof r.DateTime)return e.toJSDate();if(e.toDate)return e.toDate();if(c.gt0(e.year)&&c.gt0(e.month)&&c.gt0(e.day))return new Date(e.year,l.orElse(e.month,1)-1,e.day,12);const t=h.toS(e);return o.notBlank(t)?l.map(ie(t),te):void 0}function ne(e){if(null!=e&&!v.isString(e))return c.isNumber(e)?e:e instanceof Date?e.getTime():e instanceof r.DateTime?e.toMillis():l.map(te(e),e=>e.getTime())}function ie(e,t){return"string"!=typeof e||o.blank(e)?void 0:d.Opt(i.ExifDateTime.fromISO(e,t)).orElse(()=>i.ExifDate.fromISO(e)).orElse(()=>i.ExifTime.fromEXIF(e)).get()}function re(e){return s.compact([q(e),V(e),W(e)]).map(e=>b(e)).join("-")}function se(e){return l.map(e,e=>l.map(q(e),t=>new x(t,V(e),W(e))))}function oe(e,t){const[n,i]=[e,t].map(ne);return null==n||null==i?void 0:n-i}function ae(e){return e instanceof Date||e instanceof i.ExifDateTime||e instanceof r.DateTime}function ue(e,t){const n=r.Info.normalizeZone(t);return n.isValid?n.offset(e):void 0}t.toDateTime=Z,t.toExifDateTime=ee,t.toDate=te,t.datedToMillis=ne,t.datedToOffsetMinutes=function(e){return l.map(e,e=>e instanceof i.ExifDateTime?e.tzoffsetMinutes:e instanceof r.DateTime?e.offset:void 0)},t.datedToPrecisionMs=function(e){return l.map(e,e=>e instanceof r.DateTime||e instanceof i.ExifDateTime||e instanceof Date?0:e instanceof i.ExifDate?a.dayMs:e instanceof p.DateInterval?e.intervalMs:void 0)},t.datedToISO=function(e,t=!0){if(e instanceof p.DateInterval)return e.toString(t);const n=c.isNumber(e)?new Date(e):e;return ae(n)?l.map(ee(n),e=>e.toISOString({includeOffset:t})):re(n)},t.fromISO=ie,t.datedToYMD=re,t.toFuzzyDate=se,t.sameDay=function(e,t){return m.eql(se(e),se(t))},t.diffMillis=oe,t.closeTo=function(e,t,n){return l.mapOr(oe(e,t),e=>Math.abs(e)<n,()=>!1)},t.gtDate=function(e,t){const n=ne(e),i=ne(t);return null!=n&&null!=i&&n>i},t.nowish=function(e,t=2500){const n=ne(e),i=Date.now();return g.within(i-t,i+t,n)},t.dateBetween=function(e,t,n=1,i=1){if(null==ne(e)||null==ne(t))return;const[s,o]=[e,t].map(e=>ne(e)).sort(),a=(o-s)/(i+1),u=Y(e),l=u===Y(t)?u:void 0,c=r.DateTime.fromMillis(s+a*n,{zone:l});return[e,t].some(e=>!ae(e))?se(c):c},t.hasTime=ae,t.zoneToOffset=ue,t.setZone=function(e,t){return e instanceof r.DateTime?e.setZone(t,{keepLocalTime:!0}):ee(e,t)}},function(e,t){e.exports=require("timers")},function(e,t){e.exports=require("os")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrSet=function(e,t,n){if(null==t)throw new Error("null key");if(e.has(t))return e.get(t);{const i=n();return e.set(t,i),i}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(33);t.tot=function(e){return i.isFunction(e)?e():e},t.firstDefinedThunk=function(e){for(const t of e){const e=t();if(null!=e)return e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(62),r=n(1),s=n(3),o=n(2),a=n(0),u=n(37),l=n(46),c=n(7),d=n(211),h=n(22),f=n(9);t.fileExtsToDesc=[[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["DNG"],"Digital Negative (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HEIC","HEIF"],"High Efficiency Image Format (QuickTime-based)"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PNG"],"Portable Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["THM"],"Thumbnail image (JPEG)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["XMP"],"Extensible Metadata Platform sidecar file"]];const p=t.fileExtsToDesc.map(([e])=>e);function m(e){return r.flatten(r.compact(e.map(e=>e.toUpperCase()).map(e=>p.find(t=>t.includes(e))))).map(g)}function g(e){return f.ensurePrefix(e,".").toUpperCase()}function y(e){return s.mapNotBlank(e,g)}function v(e){const t=o.lazy(()=>new Set(r.compactBlanks(l.tot(e).map(y))));return e=>a.orElse(a.map(y(e),e=>t().has(e)),!1)}t.asExt=g,t.isHeifEnabled=o.lazy(()=>h.mapAnd(i.format.heif,e=>e.input.file)),t.BaseSharpImageExts=o.lazy(()=>r.compact(["GIF",t.isHeifEnabled()?"HEIC":void 0,"JPEG","PNG","PPM","TIFF","THM","WEBP"])),t.SharpImageExts=o.lazy(()=>m(t.BaseSharpImageExts())),t.isSharpExt=v(t.SharpImageExts),t.sharpSupportedMimeTypes=o.lazy(()=>new Set(r.compact(["image/gif",...t.isHeifEnabled()?["image/heic","image/heif"]:[],"image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"]))),t.isSharpMimetype=function(e){return t.sharpSupportedMimeTypes().has(c.toS(e).toLowerCase())},t.BaseRawImageExts=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"],t.RawImageExts=m(t.BaseRawImageExts),t.isRawImageExt=v(t.RawImageExts),t.BaseVideoExts=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"],t.VideoExts=m(t.BaseVideoExts),t.isVideoExt=v(t.VideoExts),t.SidecarExtsEnum=u.strEnum("EXIF","EXV","MIE","XMP"),t.SidecarExts=m(t.SidecarExtsEnum.values),t.isSidecarExt=v(t.SidecarExts),t.AssetFileExts=o.lazy(()=>[...t.SharpImageExts(),...t.RawImageExts,...t.VideoExts].sort()),t.isAssetFileExt=v(t.AssetFileExts),t.AllExifExts=o.lazy(()=>[...t.AssetFileExts(),...t.SidecarExts].sort()),t.isExifExt=v(t.AllExifExts),t.BrowserImgExts=m(["JPEG","PNG"]),t.BrowserExts=m(["GIF","JPEG","MP4","PNG","WEBM","WEBP"]),t.isBrowserExt=v(t.BrowserExts),t.ExtTypes=u.strEnum("image","raw","video"),t.extType=function(e){return t.isSharpExt(e)?t.ExtTypes.image:t.isRawImageExt(e)?t.ExtTypes.raw:t.isVideoExt(e)?t.ExtTypes.video:void 0};const b=/\.[a-z0-9]{2,4}$/i;t.extractShortExt=function(e){return a.map(b.exec(c.toS(e)),e=>e[0])};const w=["image/gif","image/jpeg","image/pjpeg","image/png","image/webp"],S=["image/gif","image/jpeg","image/png"];t.isMimetypeSupported=function(e,t){return(d.isChrome(t)||d.isFirefox(t)?w:S).includes(c.toS(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(43),r=n(30),s=n(28),o=n(0),a=n(49),u=n(4),l=n(26),c=n(9),d=n(58);class h{constructor(e){this.name=e,this.start=Date.now(),this.state=a.PromiseStates.pending,this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t}),this.logger=u.mkLogger("Deferred("+this.toString()+")")}toString(){return c.isString(this.name)?this.name:JSON.stringify(this.name)}[r.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(e=>{this.resolve(e)}).catch(e=>{this.logger.log(l.isTest?"warn":"error","observeQuietly.reject()",e),this.resolve(void 0)}),this}observe(e){return e.then(e=>{this.resolve(e)}).catch(e=>{this.reject(e)}),this}setTimeout(e){return o.map(this.priorTimeout,i.clearTimeout),this.priorTimeout=d.setUnrefTimeout(()=>{if(this.pending){const e="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(e)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===a.PromiseStates.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==a.PromiseStates.pending}get resolved(){return this.state===a.PromiseStates.resolved}get rejected(){return this.state===a.PromiseStates.rejected}get settledMs(){return null==this.end?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=a.PromiseStates.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(l.isTest?"warn":"error",".reject()",e);const t=s.asError(e);return this.settle(()=>{this._error=t,this.state=a.PromiseStates.rejected,this._reject(t)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}settle(e){if(this.state===a.PromiseStates.pending){o.map(this.priorTimeout,i.clearTimeout),e(),this.end=Date.now();const t=this.settledMs;if(this.resolved&&t>5e3){const e=t>5e3?"info":"debug";this.logger.log(e,"Completed in "+t+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}}t.Deferred=h},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(37);t.thenMap=function(e,t){return i(this,void 0,void 0,(function*(){const n=yield e;return null==n?void 0:t(n)}))},t.thenTap=function(e,t=console.dir.bind(console)){return i(this,void 0,void 0,(function*(){const n=yield e;return yield t(n),n}))},t.isPromise=function(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch},t.PromiseStates=r.strEnum("pending","resolved","rejected")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(68),o=n(6),a=n(38),u=n(2),l=n(0),c=n(12),d=n(20),h=n(4),f=n(48),p=n(8);t.keyedLazy=function(e,t,n,m){const g=u.lazy(()=>h.mkLogger("KeyedLazy("+e+")")),y=[],v=()=>i(this,void 0,void 0,(function*(){try{return yield t()}catch(e){return void g().warn("key() failed: "+e)}})),b=Math.min(o.secondMs,m.timeoutMs/2,m.priorResultTtlMs/2),w=()=>i(this,void 0,void 0,(function*(){const t=yield v();if(r.filterInPlace(y,e=>(null==t||e.name===t)&&e.start+m.priorResultTtlMs>Date.now()&&!e.rejected),r.sortByInPlace(y,e=>[e.resolved,e.start]),null==t||y.length>0)return l.map(y[y.length-1],e=>e.promise);const i=new f.Deferred(t).setTimeout(m.timeoutMs).observe(s.retryOnReject(n,{maxRetries:m.maxRetries,onRetryWaitUntil:e=>a.delay(e*b)}));return i.promise.catch(n=>{g().warn("Caught error",{newKey:t,startAgoMs:Date.now()-i.start,error:n}),d.onError(e+" failed",n)}),y.push(i),i.promise}));return w.clear=()=>y.length=0,w.prior=()=>{c.greatestBy(y,e=>e.start)},w.refresh=()=>(w.clear(),w()),w.set=e=>p.thenMap(v(),t=>{y.length=0,y.push(new f.Deferred(t).resolve(e))}),w}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(7),s=["number","string","boolean"];function o(e){return-1!==s.indexOf(typeof e)}t.isPrimitive=o,t.mapPrimitive=function(e,t){return o(e)?t(e):void 0},t.mapPrimitiveOr=function(e,t,n){return o(e)?t(e):n()},t.isPrimitiveArray=function(e){return Array.isArray(e)&&e.every(o)};const a=["boolean","number","bigint","symbol","string","object","function"];function u(e,t){if(null==e&&null==t)return 0;if(null==e)return-1;if(null==t)return 1;const n=typeof e,i=typeof t;return"string"!==n&&"symbol"!==n||"string"!==i&&"symbol"!==i?Array.isArray(e)&&Array.isArray(t)?l(e,t):n!==i?a.indexOf(n)-a.indexOf(i):e>t?1:e<t?-1:0:r.toS(e).localeCompare(r.toS(t))}function l(e,t){if(i.isEmpty(e)&&i.isEmpty(t))return 0;const n=Math.min(e.length,t.length);for(let i=0;i<n;i++){const n=u(e[i],t[i]);if(0!==n)return n}return u(e.length,t.length)}t.cmp=u,t.lt=function(e,t){return u(e,t)<0},t.lte=function(e,t){return u(e,t)<=0},t.gte=function(e,t){return u(e,t)>=0},t.gt=function(e,t){return u(e,t)>0},t.cmpArr=l},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(59),o=n(33),a=n(76),u=n(70),l=n(48);class c{constructor(){this._pushCount=0,this._arr=[],this.nextSettledLatches=[],this.serialLatencyAvg=new a.Average}get arr(){return r.filterInPlace(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}push(e,t){this._pushCount++;const n=o.isFunction(t)?t():t;return this.arr.push(new l.Deferred(e).observeQuietly(n).finally(()=>this.emitSettled())),n}emitSettled(){this.nextSettledLatches.forEach(e=>e.resolve()),this.nextSettledLatches.length=0}awaitNextSettled(){const e=new s.Latch;return this.nextSettledLatches.push(e),e}serial(e,t){const n=Date.now();return this.push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-n),t())))}oneRunAtATime(e,t){return this.pending?this.awaitAll():this.serial(e,t)}maybeRun(e,t){return this.maybeRunConcurrent(e,t,1)}maybeRunConcurrent(e,t,n=u.maxCpus()){return this.pendingCount>=n?void 0:this.push(e,t)}get pendingCount(){return r.count(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return 0===this.arr.length}awaitAll(){return 0===this.arr.length?Promise.resolve(void 0):Promise.all(this.arr.map(e=>e.promise)).then(()=>{})}}t.Promises=c,t.oneRunAtATime=function(e,t){const n=new c;return()=>n.oneRunAtATime(e,t)},t.maybeRun=function(e,t){const n=new c;return()=>n.maybeRun(e,t)},t.serially=function(e,t){const n=new c;return()=>n.serial(e,t)},t.withBoundedConcurrency=function({name:e,laters:t,maxConcurrent:n=u.maxCpus()}){return i(this,void 0,void 0,(function*(){const i=[],r=new c;for(const s of t){for(;r.pendingCount>=n;)yield r.awaitNextSettled();i.push(r.push(e,s))}return Promise.all(i)}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(55),r=n(215);class s extends i.TTLMap{constructor(e,t,n){super(e,new r.MRUMap(t,n)),this.maxSize=t,this.fifo=n}}t.BoundedMap=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(112),r=n(3),s=n(0),o=n(219),a=n(22),u=n(9),l=BigInt(0);class c{constructor(e,t,n=a.identity){this.name=e,this.numerals=t,this.decodePreparser=n,this.base=t.length}digitsToNumerals(e){return e.map(e=>this.numerals[e]).join("")}encode(e,t=0){const n=[],i=e<0;if(i&&t--,0===(e=Math.abs(e)))n.push(0);else for(;e>0;)n.push(e%this.base),e=Math.floor(e/this.base);for(;n.length<t;)n.push(0);return(i?"-":"")+this.digitsToNumerals(n.reverse())}encodeBigInt(e){if("bigint"!=typeof e)throw new Error("bad input");if(e===l)return this.numerals[0];const t=[],n=BigInt(this.base);let i=e;for(;i>l;)t.push(Number(i%n)),i/=n;return this.digitsToNumerals(t.reverse())}encodeBuffer(e){if(null==e||0===e.length)return"";const t=[0];for(let n of e)for(t.forEach((e,i)=>{n+=e<<8,t[i]=n%this.base,n=Math.floor(n/this.base)});n>0;)t.push(n%this.base),n=Math.floor(n/this.base);return this.digitsToNumerals(t.reverse())}decode(e){return s.map(this.decodeBigInt(e),t=>{if(t>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(t)})}decodeBigInt(e){if(null==e||r.blank(e))return;const t="-"===(e=this.decodePreparser(e))[0];t&&(e=e.slice(1));const n=BigInt(this.base);let i=BigInt(0);for(const t of e){const e=this.numerals.indexOf(t);if(e<0)return;i=i*n+BigInt(e)}return t?BigInt(-1)*i:i}randomChars(e){return this.encodeBuffer(i.randomBytes(e+3)).slice(1,e+1)}randomUid(e=20,t=5){return u.splitEvery(this.randomChars(e),t).join("-")}safeRandomUid(e,t=5){let n="";do{n=this.randomUid(e,t)}while(o.isCussy(n));return n}}t.Radix=c,t.Hex=new c("hex","0123456789abcdef",e=>e.toLowerCase()),t.Radix58=new c("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.RadixAlphaNum=new c("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",e=>e.toLowerCase()),t.GeoRadix=new c("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",e=>e.toLowerCase()),t.TokenRadix=new c("TokenRadix","123456789abcdefghjkmnpqrstuvwxyz",e=>e.toLowerCase())},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0);class r{constructor(e){this.value=e,this.ctime=Date.now()}touch(){this.ctime=Date.now()}}t.Entry=r;class s{constructor(e,t=new Map){this.ttlMs=e,this.store=t,this.expireListeners=[]}get size(){return this.vacuum(),this.store.size}clear(){return this.store.clear(),this}delete(e){return this.store.delete(e)}deleteIf(e){this.store.forEach((t,n)=>{e(n,t.value)&&this.store.delete(n)})}entries(){const e=this;return function*(){for(const[t,n]of e.store.entries())e.expired(t,n)||(yield[t,n.value])}()}forEach(e){this.store.forEach((t,n)=>{this.expired(n,t)||e(t.value,n,this)})}get(e){return i.map(this.store.get(e),t=>this.expired(e,t)?void 0:t.value)}touch(e){i.map(this.store.get(e),e=>e.touch())}pop(e){const t=this.store.get(e);return this.store.delete(e),i.map(t,t=>this.expired(e,t)?void 0:t.value)}has(e){return!this.expired(e,this.store.get(e))}keys(){const e=this;return function*(){for(const[t,n]of e.store.entries())e.expired(t,n)||(yield t)}()}set(e,t){return i.map(this.store.get(e),t=>this.expireListeners.forEach(n=>n(e,t.value))),this.store.set(e,new r(t)),this}values(){const e=this;return function*(){for(const[t,n]of e.store.entries())e.expired(t,n)||(yield n.value)}()}[Symbol.iterator](){return this.entries()}getOrSet(e,t){const n=this.store.get(e);if(this.valid(e,n))return n.touch(),n.value;{const n=t();return this.set(e,n),n}}on(e,t){this.expireListeners.push(t)}valid(e,t){return!this.expired(e,t)}expired(e,t){return null!=t&&t.ctime+this.ttlMs<=Date.now()?(this.store.delete(e),this.expireListeners.forEach(n=>n(e,t.value)),!0):null==t}vacuum(){this.store.forEach((e,t)=>{this.expired(t,e)})}}t.TTLMap=s},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),s=n(207);function o(e,t){return s(e,t)}t.eql=o,t.definedAndEql=function(e,t){return null!=e&&null!=t&&o(e,t)},t.definedAndNotEql=function(e,t){return null!=e&&null!=t&&!o(e,t)},t.eqlAsync=function(e,t){return i(this,void 0,void 0,(function*(){return r.map2Or(yield e,yield t,o,()=>!1)}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(43),r=n(10);t.setUnrefTimeout=function(e,t,...n){return r.tap(i.setTimeout(e,Math.round(t),n),e=>e.unref())},t.setUnrefInterval=function(e,t,...n){return r.tap(i.setInterval(e,Math.round(t),n),e=>e.unref())},t.unref=function(e){return r.maybeCall(e,"unref"),e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Latch=class{constructor(e){this.id=e,this._state="pending",this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(){return this.pending&&this._resolve(),this._state="resolved",this}reject(e){return this.pending&&this._reject(e),this._state="rejected",this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve()).catch(e=>this.reject(e)),this}observeQuietly(e){return e.then(()=>this.resolve()).catch(()=>this.resolve()),this}get pending(){return"pending"===this._state}get settled(){return!this.pending}get resolved(){return"resolved"===this._state}get rejected(){return"rejected"===this._state}get state(){return this._state}then(e){return this.promise.then(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(11);function r(e,t){return n=>i.Settings.logColor.valueOrDefault?`[${e}m${n}[${t}m`:n}t.black=r(30,39),t.red=r(31,39),t.green=r(32,39),t.yellow=r(33,39),t.blue=r(34,39),t.magenta=r(35,39),t.cyan=r(36,39),t.lightGrey=r(37,39),t.darkGrey=r(90,39),t.redBright=r(91,39),t.greenBright=r(92,39),t.yellowBright=r(93,39),t.blueBright=r(94,39),t.magentaBright=r(95,39),t.cyanBright=r(96,39),t.white=r(97,39),t.bgBlack=r(40,49),t.bgRed=r(41,49),t.bgGreen=r(42,49),t.bgYellow=r(43,49),t.bgBlue=r(44,49),t.bgMagenta=r(45,49),t.bgCyan=r(46,49),t.bgLightGrey=r(47,49),t.bgDarkGrey=r(100,49),t.bgRedBright=r(101,49),t.bgGreenBright=r(102,49),t.bgYellowBright=r(103,49),t.bgBlueBright=r(104,49),t.bgMagentaBright=r(105,49),t.bgCyanBright=r(106,49),t.bgWhite=r(107,49)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.version="0.8.0-alpha.3",t.release="0.8.0-alpha.3+20200414043332",t.gitSha="4bd0a2d09bbc8748812addedf88efebb96c70e67",t.gitDate=new Date(1586838812e3)},function(e,t){e.exports=require("sharp")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.wmic=()=>"wmic",t.fsutil=()=>"fsutil",t.nslookupWin=()=>"nslookup",t.pingWin=()=>"ping",t.arpWin=()=>"arp"},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(0);t.thenOpt=function(e){return o(e)?e:new s(()=>e)};class s{constructor(e){this.a=e}_map(e,t){return i(this,void 0,void 0,(function*(){const n=null!=this.a?yield this.a():void 0,i=o(n)?yield n.get():n;return null!=i?e(i):t()}))}isDefined(){return i(this,void 0,void 0,(function*(){return this._map(()=>!0,()=>!1)}))}isEmpty(){return i(this,void 0,void 0,(function*(){return this._map(()=>!1,()=>!0)}))}get(){return i(this,void 0,void 0,(function*(){return this._map(e=>e,()=>{})}))}getRequired(){return i(this,void 0,void 0,(function*(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}))}exists(e){return i(this,void 0,void 0,(function*(){return this._map(e,()=>!1)}))}map(e){return new s(()=>i(this,void 0,void 0,(function*(){return this._map(e,()=>{})})))}flatMap(e){return new s(()=>i(this,void 0,void 0,(function*(){return this._map(e,()=>{})})))}filter(e){return new s(()=>i(this,void 0,void 0,(function*(){return this._map(t=>i(this,void 0,void 0,(function*(){return(yield e(t))?t:void 0})),()=>{})})))}catch(e){return new s(()=>this.get().catch(t=>i(this,void 0,void 0,(function*(){return e(t)}))))}forEach(e){return new s(()=>i(this,void 0,void 0,(function*(){const t=yield this.get();return yield r.map(t,e),t})))}getOrElse(e){return i(this,void 0,void 0,(function*(){return r.orElse(yield this.get(),e)}))}orElse(e){return new s(()=>i(this,void 0,void 0,(function*(){const t=yield this.get(),n=null==t?yield e():t;return o(n)?n.get():n})))}}function o(e){return e instanceof s}t.OptAsync=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(18),r=n(1),s=n(3),o=n(6),a=n(37),u=n(40),l=n(12),c=n(26);t.ServiceNames=a.strEnum("main","web","sync","sync-file","db"),t.DbServices=["web","db"],t.DbRpcServices=l.diff(t.ServiceNames.values,[...t.DbServices,"main"]),t.RestartOnRpcChangeServices=["sync-file"],t.WelcomeServices=["main","web"],t.title=function(e){return u.App.getName()+" "+e},t.serviceShutdownTimeoutMs=function(e){switch(e){case"main":case"web":case"db":return o.minuteMs;case"sync":case"sync-file":default:return 30*o.secondMs}};let d="",h="";function f(){if(c.isTest&&!s.blank(h))return h;const e=r.sortBy(t.ServiceNames.values,e=>-e.length);for(const t of e)if(i.argv.some(e=>e.includes(t)))return t;throw new Error("Failed to find name in "+i.argv.join(";"))}function p(){return s.blank(d)?f():d}t.guessServiceName=f,t.serviceName=p,t.setServiceName=function(e){if(!c.isTest&&e!==d&&""!==d)throw new Error("Cannot set service name twice");d=e},t.setTestingServiceName=function(e){h=e},t.isDbService=function(){return t.DbServices.includes(p())},t.isMainService=function(){return d===t.ServiceNames.main},t.isBatchService=function(){return"sync-file"===d},t.isWelcomeService=function(){return t.WelcomeServices.includes(p())},t.isDbRpcService=function(){return t.DbRpcServices.includes(p())}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(45),o=n(5),a=n(10),u=n(15),l=n(49),c=n(110),d=n(214),h=n(4),f=n(76),p=n(24);class m{constructor(){this.errors=new c.CountingSet,this.times=new Map}time(e,t,n){const i=Date.now();return l.thenTap(t(),t=>{const r=Date.now()-i;this.push(e,r),null!=n&&n(t,r)}).catch(t=>{throw this.errors.incr(e),null!=n&&n(t,Date.now()-i),t})}mkElapsed(e){return new d.Elapsed(e,(e,t)=>this.push(e,t))}push(e,t){s.getOrSet(this.times,e,()=>new f.Average).push(t)}weightedAvg(e){return u.Opt(this.times.get(e)).map(e=>e.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[t,n])=>Object.assign(Object.assign({},e),{[t]:n.n}),{})}weightedAvgs(){return a.compactValues([...this.times.entries()].reduce((e,[t,n])=>Object.assign(Object.assign({},e),{[t]:o.mapFinite(n.weightedSampleAvg,o.round)}),{}))}report(){return i.sortBy([...this.times.entries()],([,e])=>-e.avg*e.n).reduce((e,[t,n])=>Object.assign(Object.assign({},e),{[t]:n.stats()}),{})}}t.PromiseTimer=m;const g=r.lazy(()=>a.tap(new m,e=>p.addServiceEndable(new p.EndableWrapper("PromiseTimer",()=>{const t=h.mkLogger("PromiseTimer");t.info("timings:\n",e.report()),i.mapNotEmpty(e.errorCounts(),e=>t.warn("error counts:\n",e))}))));t.time=function(e,t,n){return g().time(e,t,n)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(153),s=n(30),o=n(38),a=n(0),u=n(10),l=n(24),c=n(20),d=n(22);class h extends r.Readable{constructor(e){super(),this.push(e),this.push(null)}}t.ReadableBuffer=h;class f extends r.Duplex{_write(e,t){this.push(e,t)}}t.PassthroughStream=f,t.end=function(e){return i(this,void 0,void 0,(function*(){null!=e&&(d.Try(()=>u.maybeCall(e,"unref")),l.ending()?e.end(null):yield new Promise(t=>e.end(null,t)),yield o.delay(50),d.Try(()=>u.maybeCall(e,"destroy")))}))},t.close=function(e){return i(this,void 0,void 0,(function*(){null!=e&&(d.Try(()=>u.maybeCall(e,"unref")),l.ending()?e.close(()=>{}):yield new Promise(t=>e.close(t)),yield o.delay(50),d.Try(()=>u.maybeCall(e,"destroy")))}))},t.onError=function(e,t){[{name:"cp",ea:e},{name:"stdin",ea:e.stdin},{name:"stdout",ea:e.stdout},{name:"stderr",ea:e.stderr}].forEach(({name:e,ea:n})=>a.map(n,n=>n.on("error",n=>{c.isIgnorableError(n)||t(e,n)})))},t.closeStreams=function(e){null!=e&&[e.stdin,e.stdout,e.stderr].forEach(e=>d.Try(()=>a.map(e,e=>e.destroy())))},t.pipelineAsync=s.promisify(r.pipeline),t.remoteDesc=function(e){return e.destroyed?"destroyed":`${e.remoteFamily}:${e.remoteAddress}:${e.remotePort}`}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(38),s=n(0),o=n(15),a=n(5);function u(e,t){return i(this,void 0,void 0,(function*(){let n=void 0;return Promise.race([e().then(e=>null==n?(n=!0,e):void 0),r.unrefDelay(t).then(()=>{if(null==n)throw n=!1,new Error("timeout")})])}))}t.thenOrTimeout=u,t.retryOnReject=function(e,t){return i(this,void 0,void 0,(function*(){const n=a.gt0(t.timeoutMs)?()=>u(e,t.timeoutMs):e;if(t.maxRetries<=0)return n();const l=o.Opt(t.errorIsRetriable).getOrElse(()=>()=>!0),c=o.Opt(t.onRetryWaitUntil).getOrElse(()=>e=>r.delay(250*s.orElse(e,1)));let d=0;const h=()=>i(this,void 0,void 0,(function*(){try{return yield n()}catch(e){if(l(e)&&d<t.maxRetries)return d++,yield c(d),h();throw e}}));return h()}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(246),r=n(59),s=n(4),o=n(284),a=n(11),u=n(2),l=n(0),c=n(74),d=s.mkLogger("DbClient");t.dbClient=u.lazy(()=>{if(c.dbRpc()){const e=a.Settings.rpcPort.valueOrDefault;d.debug("Creating new dbClient to "+e);const t=new o.Client("db@localhost:"+e,()=>function(e){const t=new r.Latch,n=new i.Socket;return n.on("error",e=>t.reject(e)),n.connect(e,"localhost",()=>{d.debug("Connected to "+e),t.resolve()}),t.then(()=>n)}(e));return t.ping(),t}}),t.dbClientReady=u.lazy(()=>l.map(t.dbClient(),e=>e.ping().then(e=>(d.debug("dbClientReady(): ping returned "+e),!0)).catch(e=>(d.warn("dbClientReady(): ping failed",e),!1))),5e3),t.dbClientEnd=function(){const e=t.dbClient.prior();return t.dbClient.clear(),l.map(e,e=>e.end())}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(44),r=n(6),s=n(2),o=n(5),a=n(36),u=n(4),l=n(41),c=n(11);t.maxCpus=s.lazy(()=>{const e=l.avg([i.freemem(),i.totalmem()]),t=500*a.MB,n=Math.max(1,Math.floor(e/t)),r=c.Settings.maxCpus.valueOrDefault;return u.mkLogger("MaxCpus").tap({msg:"maxCpus()",result:o.clamp(1,n,r),meta:{maxProcs:n,cpuCount:r}})},r.minuteMs),t.maxPending=s.lazy(()=>Math.max(2*t.maxCpus(),t.maxCpus()+10)),t.maxCpus.onChange(()=>t.maxPending.clear()),t.minPending=function(){return o.round((t.maxCpus()+t.maxPending())/2)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(2),o=n(0),a=n(5),u=n(10),l=n(19),c=n(7),d=n(4),h=n(91),f=n(9);class p{constructor(e){this.h=e,this.text=o.orElse(e.text,c.toS(e)),this.greedyLeft=o.orElse(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}}const m=s.lazy(()=>d.mkLogger("Fixed"));t.parseFixed=function(e,t,n=!0){return new g(e,t,n).entries};class g{constructor(e,t,n=!0){this.warnIfMissingHeaders=n;const s=t.split(/[\r\n]{1,2}/);this.headerRow=s[0],this.rows=s.slice(1);const o=Math.max(...this.rows.map(e=>e.length));this.col2blanks=new Map(a.times(o,e=>[e,i.count(this.rows,t=>r.blank(t[e]))])),this.headers=this.extractHeaders(e.map(e=>new p(e))),this.entries=this.rows.map(e=>this.headers.map(t=>t.toEntry(e))).map(e=>u.fromEntries(e)).filter(e=>u.values(e).some(r.notBlank))}extractHeaders(e){let t=this.headerRow;i.sortBy(e,e=>-e.text.length),m().trace("extractHeaders()",e),e.forEach(e=>{const n=new RegExp(`\\b${e.text}\\b`,"i"),i=n.exec(t);null==i?this.warnIfMissingHeaders&&m().warn("extractHeaders(): Failed to find header!",{re:n,headerLine:t}):(e.indexOf=i.index,t=f.padReplace(t,i.index,e.text.length," "))});const n=e.filter(e=>null!=e.indexOf),r=i.sortBy(n,e=>e.indexOf);m().trace("extractHeaders()",{byAppearance:r}),r.forEach((e,t)=>{const n=e.indexOf,i=r[t-1],s=0===t?0:i.indexOf+i.text.length-1,[a,u]=e.greedyLeft?[s,n]:[n,s];e.leftIdx=o.map(this.firstBlankColumn(a,u),e=>e+1),0===t&&null==e.leftIdx&&(e.leftIdx=0),m().trace("extractHeaders(): finding leftIdx",{from:n,to:s,header:e}),null==e.leftIdx&&m().warn("no blank column for "+e.text+" between "+n+" and "+s)}),i.filterInPlace(r,e=>null!=e.leftIdx),r.slice(0,-1).forEach((e,t)=>{const n=r[t+1];e.rightIdx=n.leftIdx-1});const s=l.toA(h.diff(e.map(e=>e.text),r.map(e=>e.text)));return s.length>0&&m().warn("Missing headers",{missingHeaders:s}),r}firstBlankColumn(e,t){return i.range(e,t).find(e=>this.col2blanks.get(e)===this.rows.length)}}t.Fixed=g},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(30),s=n(1),o=n(28),a=n(45),u=n(0),l=n(37),c=n(7),d=n(151),h=n(20),f=n(22);t.LogLevels=l.strEnum("error","warn","info","debug","trace"),t.ms2level=function(e,t){return e>=t?"error":e>=t/2?"warn":e>=t/4?"info":"debug"};const p=()=>{};function m(e){return i(this,void 0,void 0,(function*(){try{return yield e()}catch(e){return}}))}t.NoOpLogger={enabled:()=>!1,log:p,flush:()=>Promise.resolve(),close:p,error:p,warn:p,info:p,debug:p,trace:p},t.safeLogger=function(e){return{enabled:(t,n)=>f.Try(()=>e.enabled(t,n),()=>!1),log:(t,n,i,r)=>f.Try(()=>e.log(t,n,i,r)),flush:()=>m(()=>e.flush()),close:()=>m(()=>e.close())}};const g=/^[a-z]*/i;t.MaxRecentLogEntriesByLevel=20;const y=new Map;t.clearRecentLogEntries=function(){y.clear()},t.recentLogEntries=function(){const e=[];for(const t of y.values())e.push(...t.toA());return s.sortBy(e,e=>e.timestamp)};t.ContextualLogger=class{constructor(e,t){this.context=e,this.logger=t,this.error=(e,t)=>{this.log("error",e,t)},this.warn=(e,t)=>{this.log("warn",e,t)},this.info=(e,t)=>{this.log("info",e,t)},this.debug=(e,t)=>{this.log("debug",e,t)},this.trace=(e,t)=>{this.log("trace",e,t)},this.filterContext=u.mapOr(g.exec(c.toS(this.context)),e=>e[0],()=>this.context)}throw(e,t){const n=new h.WrappedError({cause:o.asError(e),message:this.context+u.mapOr(t,r.inspect,()=>"")});throw this.log("error",o.errorToS(e),t),n}tap(e){return this.log(u.orElse(e.level,"debug"),e.msg,Object.assign({result:e.result},e.meta)),e.result}log(e,n,i){var r;"trace"!==e&&(r={timestamp:Date.now(),level:e,context:this.context,msg:n,meta:i},a.getOrSet(y,r.level,()=>new d.BoundedList(t.MaxRecentLogEntriesByLevel)).push(r)),this.enabled(e)&&u.map(this.logger(),t=>t.log(e,this.context,n,o.isError(i)?o.errorToS(i):i))}enabled(e){const t=this.logger();return null!=t&&t.enabled(e,this.filterContext)}flush(){return this.logger().flush()}close(){return u.map(this.logger(),e=>e.close())}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(3);t.isVideoMimeType=function(e){return i.notBlank(e)&&(e.startsWith("video/")||"application/mp4"==e||"application/ogg"==e)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(13),s=n(35),o=n(86),a=n(2),u=n(0),l=n(69);let c=!0;function d(){return c}t.dbRpc=d,t.setDbRpc=function(e){c=e,e===(null==l.dbClient.prior())&&l.dbClientEnd(),e?(s.setRpcMountpointsImpl(t.rpcMountpoints),o.setRpcVolumesImpl(t.rpcVolumes)):(s.setRpcMountpointsImpl(void 0),o.setRpcVolumesImpl(void 0))},t.rpcMountpoints=a.lazy(()=>u.mapOr(l.dbClient(),e=>e.request("mountpoints"),s.nonRpcMountpoints),1e3),t.rpcVolumes=a.lazy(()=>i(void 0,void 0,void 0,(function*(){return u.mapOr(l.dbClient(),e=>e.request("volumes"),o.nonRpcVolumes)})),1e3),r.onClearCache(()=>{t.rpcMountpoints.clear(),t.rpcVolumes.clear()}),t.assertLocalDb=function(){if(d())throw new Error("only supported on db-local processes")},t.assertDbRpc=function(){if(!d())throw new Error("only supported on db-remote processes")}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(0),o=n(19),a=n(12);function u(e){const t=r.compact(e).filter(([e,t])=>null!=e&&null!=t);return new Map(t)}function l(e,t){return new Map([...e.entries()].filter(([e,n])=>t(e,n)))}t.hasAll=function(e,t){return t.every(t=>e.has(t))},t.getOrSetAsync=function(e,t,n){return i(this,void 0,void 0,(function*(){const i=e.get(t);if(null!=i)return i;const r=Promise.resolve(n());return e.set(t,r),r.then(n=>{null==n?e.delete(t):e.set(t,n)}).catch(()=>e.delete(t)),r}))},t.flatMap=function(e,t){return new Map(a.concat(...e.map(e=>t(e))))},t.compactMap=u,t.toMap=function(e,t){return u(r.compact(e).map(t))},t.toMapAsync=function(e,t){return i(this,void 0,void 0,(function*(){if(null==e)return new Map;return u(yield Promise.all(r.compact(o.toA(e)).map(e=>t(e))))}))},t.toObj=function(e){const t={};for(const[n,i]of e)t[n]=i;return t},t.filter=l,t.filterInPlace=function(e,t){[...e.entries()].forEach(([n,i])=>t(n,i)||e.delete(n))},t.pickKeys=function(e,t){return l(e,e=>t.indexOf(e)>=0)},t.getLike=function(e,t){return s.map([...e.entries()].find(([e])=>t(e)),([,e])=>e)},t.inverse=function(e){return new Map([...e.entries()].map(([e,t])=>[t,e]))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(30),r=n(1),s=n(0),o=n(5),a=n(10),u=n(12),l=n(151),c=n(110),d=n(14),h=n(41);class f{constructor(e=20){this.maxSamples=e,this._n=0,this._samples=new l.BoundedList(e)}static merge(e,t){if(0==e.n&&0==t.n)return new f(Math.max(e.maxSamples,t.maxSamples));if(0==e.n)return t.clone();if(0==t.n)return e.clone();if(e.n<=e.maxSamples){const n=t.clone();return n.pushAll(e.samples),n}if(t.n<=t.maxSamples){const n=e.clone();return n.pushAll(t.samples),n}{const n=new f(Math.max(e.maxSamples,t.maxSamples));n._n=e.n+t.n,n._avg=e._avg*e.n/n.n+t._avg*t.n/n.n,n._min=Math.min(e._min,t._min),n._max=Math.max(e._max,t._max),n._m=e._m*e.n/n.n+t._m*t.n/n.n,n._s=e._s*e.n/n.n+t._s*t.n/n.n;const i=r.flatten(u.zip(e.samples,t.samples));return n._samples.push(...i),n._weightedTotalAvg=h.weightedAvg([n._avg,...i]),n}}[i.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=null==this._min?e:Math.min(e,this._min),this._max=null==this._max?e:Math.max(e,this._max),1===this._n||null==this._m||null==this._s||null==this._avg||null==this._weightedTotalAvg)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{const t=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-t)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return a.tap(new f(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){e.forEach(e=>this.push(e))}stats(e=2){const t=t=>s.map(t,t=>o.sigFigs(t,e)),n={};return this.empty||(n.mean=t(this.avg),n.mode=t(this.sampleMode),n.sd=t(this.stdDev),n.max=t(this.max),n.min=t(this.min)),n.k=o.sigFigs(this.n,e),n}get empty(){return 0===this._n}get n(){return this._n}get avg(){return this.empty?void 0:o.sigFigs(this._avg,4)}get max(){return this._max}get min(){return this._min}get p84(){return d.mapGt0(this.avg,e=>d.mapGt0(this.stdDev,t=>e+t))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return s.map(this.variance,Math.sqrt)}get sampleMode(){return s.map(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;const t=new c.CountingSet;return this._samples.forEach(e=>t.incr(e)),t.topKeys(e)}get sampleStdDev(){return r.mapNotEmpty(this._samples,h.stdDev)}get sampleAvg(){return r.mapNotEmpty(this._samples,h.avg)}get sampleSlope(){return s.orElse(r.mapNotEmpty(this._samples,h.slope),0)}get samples(){return[...this._samples]}p(e){if(0===this._samples.length)return 0;const t=[...this._samples].sort((e,t)=>e-t);return t[Math.floor(t.length*(e/100))]}get weightedSampleAvg(){return r.mapNotEmpty(this._samples,e=>o.sigFigs(h.weightedAvg(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}}t.Average=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(10),r=n(49),s=n(53);t.memoize=function(e,t,n){let o=0;const a=new s.BoundedMap(t,n,!0),u=t=>(o++,a.getOrSet(JSON.stringify(t),()=>i.tap(e(t),e=>{r.isPromise(e)&&e.catch(()=>u.clear())})));return u.clear=e=>null==e?a.clear():a.delete(JSON.stringify(e)),u.prior=()=>new Map(a.entries()),u.size=()=>a.size,u.callCount=()=>o,u}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(34),r=n(1),s=n(10),o=n(7);t.joinQuery=function(e,t){if(null==t)return e;const n=s.entries(t).filter(([,e])=>null!=e);return r.isEmpty(n)?e:e+"?"+n.map(e=>e.map(o.toS).map(encodeURIComponent).join("=")).join("&")},t.parent=function(e){return i.posix.parse(e).dir},t.PS_LIBRARY_PROTOCOL="pslib:",t.PS_LOCAL_FILE_PROTOCOL="psfile:",t.PS_NETWORK_FILESYSTEM_PROTOCOL="psnet:"},function(e,t){e.exports=require("luxon")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(5),r=n(87),s=n(36);function o(e){return{width:e.height,height:e.width}}t.isDimensions=function(e){return null!=e&&i.gt0(e.width)&&i.gt0(e.height)},t.dimToS=function(e){return`${e.width} Ã ${e.height}`},t.dimToSize=function(e){return s.pixels2size(e.width*e.height)},t.flip=o,t.maybeFlip=function(e,t){return r.flippable(t)?o(e):e},t.maybeFlipInPlace=function(e,t){r.flippable(t)&&([e.width,e.height]=[e.height,e.width])},t.isPortrait=function(e){return e.width/e.height<1},t.dmegapixels=function(e){return s.megapixels(e.width*e.height)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(18),r=n(10);t.getEnv=function(e){return r.firstValueCaseInsensitive(i.env,e)}},function(e,t){e.exports=require("fs-extra")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(5);function s(e,t,n=[]){if(e=Math.ceil(e),t=Math.floor(t),i.isNotEmpty(n)&&n.length+10>t-e){const r=i.range(e,t).filter(e=>!n.includes(e));return i.mapNotEmpty(r,e=>e[s(0,r.length)])}const r=Math.floor(Math.random()*(t-e))+e;return n.includes(r)?s(e,t,n):r}function o(e,t){return Math.random()*(t-e)+e}function a(){return t.RandomChars[s(0,t.RandomChars.length)]}function u(e){const t=Array(...e);for(let e=t.length-1;e>0;e-=1){const n=Math.floor(Math.random()*(e+1));e!==n&&([t[e],t[n]]=[t[n],t[e]])}return t}t.randomInt=s,t.randomInts=function(e,t,n){const i=[];for(;i.length<n;)i.push(s(e,t,i));return i},t.randomFloat=o,t.RandomChars="0123456789abcdefghijkmnopqrstuvwxyz",t.randomChars=function(e){let t="";for(let n=0;n<e;n++)t+=a();return t},t.randomChar=a,t.pickRandom=function(...e){return e[s(0,e.length)]},t.shuffle=u,t.sample=function(e,t){if(t<e.length/10){const n=new Set;for(;n.size<t;)n.add(s(0,e.length));return[...n.keys()].map(t=>e[t])}return u([...e]).slice(0,t)},t.pickWeightedRandom=function(e){if(i.isEmpty(e))return;const t=e.filter(e=>r.gt0(e.priority));let n=o(0,i.sum(t,e=>e.priority));return t.find(e=>(n-=e.priority,n<=0))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(45),s=n(0),o=n(10),a=n(19),u=n(12),l=n(41);function c(e,t){const n=new d;return e.forEach(e=>s.map(t(e),t=>n.add(t,e))),n}t.groupBy=c,t.groupByValues=function(e,t){const n=c(e,t);return i.sortBy(a.toA(n.values()),e=>t(e[0]))};class d{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return l.sum([...this.store.values()].map(e=>e.length))}add(e,t){return o.tap(r.getOrSet(this.store,e,()=>[]),e=>e.push(t))}delete(e,t){if(null==t)return this.store.delete(e);{const n=this.store.get(e);if(null==n)return!1;{const i=u.remove(n,t);return i&&0===n.length&&this.store.delete(e),i}}}clear(){return this.store.clear(),this}keys(){const e=this;return function*(){for(const[t,n]of e.store.entries())n.length>0&&(yield t)}()}values(){const e=this;return function*(){for(const[,t]of e.store.entries())t.length>0&&(yield t)}()}flatValues(){const e=this;return function*(){for(const[,t]of e.store.entries())if(t.length>0)for(const e of t)yield e}()}entriesArray(){return[...this.store.entries()].filter(([,e])=>i.isNotEmpty(e))}entries(){const e=this;return function*(){for(const[t,n]of e.store.entries())n.length>0&&(yield[t,n])}()}tuples(){const e=this;return function*(){for(const[t,n]of e.store.entries())for(const e of a.toA(n))null!=e&&(yield[t,e])}()}filterInPlace(e){let t=!1;for(const[n,r]of this.store.entries()){const s=r.length;i.filterInPlace(r,t=>e(n,t)),t=t||s!==r.length}return t}}t.MultiMap=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(21),r=n(42),s=n(14),o=n(0),a=n(5),u=n(7),l=n(171);class c extends l.Model{static touch(e){return this.dbr(t=>t.exec(this.query().whereIn("id",e).update("updatedAt",Date.now())))}toID(){return this.class().hasUpdateCount&&(this.updateCount=s.mapGt0Or(this.updateCount,e=>e,1)),h(this)}get createdAtDate(){return s.mapGt0(this.createdAt,e=>new Date(e))}get updatedAtDate(){return s.mapGt0(this.updatedAt,e=>new Date(e))}$beforeUpsert(){null==this.createdAt&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),this.class().hasUpdateCount&&(this.updateCount=s.mapGt0Or(this.updateCount,e=>e+1,1))}$beforeInsert(){this.$beforeUpsert()}$beforeUpdate(){this.$beforeUpsert()}}t.TimestampedModel=c;const d=Math.pow(2,16);function h(e){return o.map(e,e=>({id:e.id,v:a.numericOr(e.updateCount,0)}))}t.encodeVersion=function(e){const t=o.orElse(r.datedToMillis(e),Date.now());return u.toS(i.unixtime(t)%d)},t.toID=h},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(3),o=n(6),a=n(2),u=n(15),l=n(49),c=n(12),d=n(50),h=n(8),f=n(23),p=n(81),m=n(57),g=n(20),y=n(13),v=n(27),b=n(4),w=n(156),S=n(16),M=n(9),P=n(230),E=n(231),x=n(233),_=n(234),F=n(236),T=n(35),O=n(237),A=n(157),k=n(25),D=n(238),C=a.lazy(()=>b.mkLogger("Volumes"));let I;t.nonRpcVolumes=d.keyedLazy("volumes",T.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=yield S.isWin?E.dfWin():P.dfPosix();if(null==e)return void C().warn("df failed");if(e.some(e=>e.remote&&s.blank(e.remoteHost))&&(yield h.thenOrTimeout(S.isWin?A.addRemoteVolumeInfoWin(e):O.addRemoteVolumeInfoPosix(e),10*o.secondMs).catch(e=>{g.onError("Failed to get remote volume info",e)})),null==(yield(S.isWin?F.addLocalVolumeInfoWin(e):S.isMac?x.addLocalVolumeInfoMac(e):_.addLocalVolumeInfoPosix(e)).catch(e=>{g.onError("Failed to get local volume info",e)})))return void C().warn("addLocalVolumeInfo failed");e.forEach(e=>s.mapNotBlank(e.remoteHost,t=>e.remoteHost=t.toLowerCase().normalize().trim()));for(const t of e)t.remote=f.isTrue(t.remote),yield D.volumeUUID(t);const t=r.sortBy(e,e=>e.mountpoint).filter(e=>!f.isTrue(e.ignorable));return C().info("_volumes(): final result",{sorted:t}),Object.freeze(t)}))}),{maxRetries:2,timeoutMs:1.5*k.cmdTimeoutMs,priorResultTtlMs:k.longTtlMs}),y.onClearCache(()=>t.nonRpcVolumes.clear()),t.setRpcVolumesImpl=function(e){I=e};let L=[];function R(){return i(this,void 0,void 0,(function*(){try{return yield l.thenTap((I||t.nonRpcVolumes)(),e=>{r.mapNotEmpty(e,e=>{const t=e.map(e=>e.mountpoint).sort();m.eql(L,t)||(y.emitVolumesChanged(),L=t)})})}catch(e){return void g.onError("volumes() failed",e)}}))}function B(e){return i(this,void 0,void 0,(function*(){return h.thenMap(R(),t=>N(t,e))}))}function N(e,t){const n=e.filter(e=>v.containedByNativePath(t,e.mountpoint));return c.greatestBy(n,e=>r.commonPrefixLength(e.mountpoint,t))}function j(e,t,n){return i(this,void 0,void 0,(function*(){const o=n.filter(e=>M.equalsIgnoreCase(t,e.remoteShare));if(r.isEmpty(o))return;const a=o.find(t=>f.isTrue(t.remote)&&s.notBlank(t.remoteHost)&&M.equalsIgnoreCase(e,t.remoteHost));if(null!=a)return a;const u=yield w.friendlyname(e);return h.asyncFind(o,e=>i(this,void 0,void 0,(function*(){return M.equalsIgnoreCase(u,yield w.friendlyname(e.remoteHost))})))}))}t.volumes=R,t.rootPath=a.lazy(()=>S.isWin?u.Opt(p.getEnv("SystemDrive")).filter(s.notBlank).orElse(()=>"C:").map(e=>M.ensureSuffix(e,"\\")).get():"/"),t.rootVolume=function(){return B(t.rootPath())},t.volumeFor=B,t.bestVolume=N,t.remoteVolumeFor=function(e,t){return i(this,void 0,void 0,(function*(){return h.thenMap(R(),n=>j(e,t,n))}))},t.bestRemoteVolume=j},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(5);function s(e){return r.isNumber(e)&&[0,90,180,270].includes(e)}function o(e){const t=i.map(e,e=>r.round(e+360*Math.ceil(-e/360)));return s(t)?t:void 0}t.isRotation=s,t.normalizeRotation=o,t.flippable=function(e){const t=o(e);return 90===t||270===t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(37);t.ReducerNames=i.strEnum("fit","sq")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(96),s=n(18),o=n(1),a=n(3),u=n(6),l=n(2),c=n(0),d=n(5),h=n(15),f=n(19),p=n(7),m=n(40),g=n(24),y=n(8),v=n(52),b=n(58),w=n(21),S=n(20),M=n(31),P=n(27),E=n(4),x=n(75),_=n(14),F=n(22),T=n(16),O=n(218),A=n(39),k=l.lazy(()=>E.mkLogger("Pids"));function D(e,t){return i(this,void 0,void 0,(function*(){return null!=e&&null!=t&&(e.name===p.toS(t.pid)&&I(yield e.readJSON(),t))}))}t.addPid=function(e,t){return L.instance().addPid(e,t)};const C=10*u.secondMs;function I(e,t){if(null==e||null==t)return!1;const n=c.map(t.start,e=>e.getTime()),i=e.startTime;return d.gt0(n)&&d.gt0(i)&&Math.abs(n-i)<C}class L{constructor(e=M.BaseFile.for(m.App.userData()).join("pids")){this.pidsDir=e,this.p=new v.Promises,this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",()=>i(this,void 0,void 0,(function*(){const t=c.orElse(e.everything,!1),n=c.orElse(e.force,T.isWin),i=yield this.pidfiles(),r=yield x.toMapAsync(i,e=>y.thenMap(e.readJSON(),e=>[e.pid,e])),a=o.uniq(o.flatten(f.toA(r.values()).map(e=>[e.pid,e.ppid])));if(o.isEmpty(a))return k().debug("killOldProcs(): no pidfiles"),[];const u=yield O.pidInfos(a);if(k().debug("killOldProcs()",{pids:a,allEntries:u}),null==u)return void S.onError("Pids.killOldProcs(): failed to get process information");const l=new Set(u.map(e=>e.pid)),h=u.filter(e=>r.has(e.pid)),p=o.sortBy(o.compact(h.map(e=>c.map(r.get(e.pid),t=>I(t,e)?Object.assign(Object.assign({},t),e):void 0))),e=>e.pid).filter(e=>s.pid!==e.pid),m=t?p:p.filter(t=>!l.has(t.ppid)||!l.has(t.pid)||d.gt0(t.timeoutTime)&&Date.now()>=t.timeoutTime||null!=e.everythingBefore&&t.startTime<e.everythingBefore);k().debug("killOldProcs()",{trackedEntries:h,victims:m,pidfiles:f.toA(r.values())});for(const e of m)k().info("killOldProcs(): killing",{entry:e}),R(e.pid,n,!1);return yield this.vacuumPids(),o.sortBy(m,e=>e.pid)})))}addPid(e,t){return i(this,void 0,void 0,(function*(){if(null==e)throw new Error("undefined info");const n=e.pid;if(!d.gt0(n))throw new Error("undefined pid");const i=this.pidsDir.join(e.pid+".json"),r=h.Opt(F.Try(()=>P.parseNativePath(e.cmd).base)).filter(a.notBlank).getOrElse(()=>e.cmd),s=t.getTime(),o=_.mapGt0(e.maxAgeMs,e=>s+e),u=Object.assign(Object.assign({},e),{cmd:r,startTime:s,timeoutTime:o});if(null==(yield i.writeJSON(u)))throw new Error("Failed to write to "+i);return k().debug("addPid() wrote "+i,u),i}))}pidfiles(){return this.pidsDir.clear().children(e=>".json"===e.ext&&null!=d.toInt(e.name))}onKill(e){return i(this,void 0,void 0,(function*(){const t=this.pidsDir.join(e+".json");return y.thenMap(t.clear().readJSON(),t=>this.addPid(Object.assign(Object.assign({},t),{maxAgeMs:1}),w.ago(u.minuteMs)).catch(t=>{k().info("onKill(): failed to rewrite pidfile: "+t,{pid:e})}))}))}vacuumPids(){return i(this,void 0,void 0,(function*(){const e=yield this.pidfiles(),t=f.toA(e).map(e=>d.toInt(e.name)).filter(d.gt0);if(o.isEmpty(t))return;const n=yield O.pidInfos(t);if(null!=n){k().debug("vacuumPids",{pids:t,pidfiles:f.toA(e).map(e=>e.base),entries:n});for(const t of e){const e=n.find(e=>p.toS(e.pid)===t.name);null!=e&&(yield D(t,e))||(k().debug("vacuumPids(): Removing old pidfile "+t.base,{psEntry:e,pidfile:yield t.readFile().then(p.toS).catch(e=>"(failed to read file: "+e+")")}),yield t.unlink())}}else S.onError("Failed to get pidInfo for pids "+t)}))}}function R(e,t=!1,n=!0){if(e===s.pid||e===s.ppid)throw new Error("cannot self-terminate");return t&&n&&L.instance().onKill(e),T.isWin?function(e,t=!1){return i(this,void 0,void 0,(function*(){if(g.ending()||A.PowerShell.instance().ended)return r.kill(e,t);try{const n=o.compact(["Stop-Process","-Id",d.toInt(e),t?"-Force":void 0]).join(" ");yield A.PowerShell.instance().execute(n,F.identity)}catch(n){k().warn("killWin(): pwsh error, using TASKKILL: "+n),r.kill(e,t)}}))}(e,t):function(e,t=!1){return i(this,void 0,void 0,(function*(){try{s.kill(e,t?"SIGKILL":"SIGTERM")}catch(e){if(!String(e).includes("ESRCH"))throw e}}))}(e,t)}function B(e){return i(this,void 0,void 0,(function*(){return null!=(yield O.pidInfo(e))}))}t.Pids=L,L.instance=l.lazy(()=>new L),t.kill=R,t.pidExists=B,t.pidNotExists=function(e){return y.thenNot(B(e))},t.ProcCleaner=l.lazy(()=>{const e=[{everything:!1,force:!1,intervalMs:5*u.minuteMs},{everything:!1,force:!0,intervalMs:17*u.minuteMs}].map(e=>b.setUnrefInterval(()=>L.instance().killOldProcs(e),e.intervalMs));return g.addCleanupEndable(new g.EndableWrapper("ProcCleaner",()=>(e.map(clearInterval),L.instance().killOldProcs())))})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(112),r=n(56),s=n(15),o=n(54);function a(e,n=t.HashBits){return i.createHash("sha512").update(e).digest().slice(0,n/8)}function u(e,t=9,n=o.Radix58,i=224){return n.encodeBuffer(a(e,i)).substring(0,t)}t.HashBits=192,t.fileSha=function(e,n){const o=r.createReadStream(e,{autoClose:!0}),a=i.createHash("sha512");let u=0;const l=s.Opt(n).flatMap(e=>e.msbits).getOrElse(()=>t.HashBits)/8;return new Promise((e,t)=>{o.on("error",e=>t(e)),o.on("data",e=>{u+=e.length,null!=n&&null!=n.observer&&n.observer.onProgress(u),a.update(e)}),o.on("end",()=>e(a.digest().slice(0,l)))})},t.stringSha=a,t.shortStringSha=u,t.shortFsStringSha=function(e,t=15,n=o.GeoRadix,i=224){return u(e,t,n,i)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(19);function r(e){return e instanceof Set?e:new Set(i.toA(e))}t.asSet=r,t.setEql=function(e,t){return i.toA(e.keys()).every(e=>t.has(e))&&i.toA(t.keys()).every(t=>e.has(t))},t.union=function(e,t){return new Set([...e,...t])},t.intersection=function(e,t){const n=r(t);return new Set([...e].filter(e=>n.has(e)))},t.diff=function(e,t){const n=r(t);return new Set([...e].filter(e=>!n.has(e)))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(222),s=n(1),o=n(3),a=n(28),u=n(2),l=n(0),c=n(10),d=n(15),h=n(19),f=n(7),p=n(40),m=n(8),g=n(57),y=n(13),v=n(31),b=n(121),w=n(4),S=n(9),M=n(61),P=n(143),E=n(139),x=n(11),_=w.mkLogger("SettingsIO");function F(){return m.thenMap(I(t.systemSettingsFile()),e=>e[x.Settings.libraryPath.name])}t.systemSettingsFile=()=>v.BaseFile.for(p.App.getPath("userData")).join("settings.toml"),t.librarySettingsFile=e=>d.Opt(e).filter(o.notBlank).orElse(()=>x.Settings.libraryPath.value).filter(o.notBlank).flatMap(e=>P.libraryDataDir(e)).map(e=>e.join("settings.toml")).get(),t.libraryTxtFile=()=>v.BaseFile.for(p.App.getPath("userData")).join("library.txt"),t.readSystemSettings=function(e=t.systemSettingsFile()){return i(this,void 0,void 0,(function*(){const n=yield m.thenOrElse(L(e),()=>[]);return o.blank(x.Settings.libraryPath.value)&&o.notBlank(yield function(){return i(this,void 0,void 0,(function*(){if(!t.libraryHasSettings()){const e=t.libraryTxtFile().clear();if(yield e.isNonEmpty()){const t=f.toS(yield e.readFile());if(o.notBlank(t))return _.info("Importing old library.txt file",{priorPath:t,libraryTxt:e}),x.Settings.libraryPath.value=t,null!=(yield C())&&(yield e.renameWithNameSuffix("-obsolete")),t}}}))}())&&s.pushUniq(n,x.Settings.libraryPath),n}))},t.envOrSavedLibraryPath=function(){var e;return null!==(e=x.Settings.libraryPath.value)&&void 0!==e?e:F()},t.savedLibraryPath=F,t.systemSettingsVersion=function(){return i(this,void 0,void 0,(function*(){return O(t.systemSettingsFile())}))},t.librarySettingsVersion=function(e){return i(this,void 0,void 0,(function*(){return l.map(t.librarySettingsFile(e),e=>O(e))}))},t.libraryHasSettings=u.lazy(()=>d.Opt(t.librarySettingsFile()).flatMap(e=>e.existsSync()).getOrElse(()=>!1)),x.Settings.libraryPath.addListener(()=>t.libraryHasSettings.clear()),y.onSettingsChanged(()=>t.libraryHasSettings.clear());const T=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;function O(e){return i(this,void 0,void 0,(function*(){return m.thenMap(e.firstMatchingLine(T),e=>e[1])}))}const A={maxLineLen:78,prefix:"# "};function k(e,n){return i(this,void 0,void 0,(function*(){const r=yield e.clear().isNonEmpty(),o=r?yield e.wip():e;_.info("maybeWriteFile(): writing settings",{file:e});const a=yield function(e,n,r){return i(this,void 0,void 0,(function*(){const i=l.orElse(yield I(r),{}),o=s.flatten(["","Hello!","","These are settings for PhotoStructure, and are formatted using TOML. See <https://github.com/toml-lang/toml>.","","NOTE: Please shut down PhotoStructure before editing this file.","",'Most settings have reasonable defaults, which are provided after the description. Remove the "#" from the beginning of the line to override the default.',"","Thanks for using PhotoStructure! Visit <https://support.photostructure.com> or email <mailto:support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+t.currentVersion(),""].map(e=>S.wrap(e,A)));n.forEach(e=>{const t=s.compactBlanks([e.key,...h.toA(e.opts.alternateKeys)]);o.push("","",...S.wrap(`${e.opts.description}\n(env: ${S.joinEng(t)})`,A));const n=e.addToJSON();s.isNotEmpty(c.keys(n))&&o.push("# "+JSON.stringify(n)),o.push("#");const r=i[e.name],a={},u=e.valueToPersist(r);null!=u?(a[e.name]=u,o.push(...D(a))):(a[e.name]=e.exampleValue,o.push(...D(a).map(e=>"# "+e)))});try{const t=yield e.writeTxt("\n"+o.map(e=>e.trimRight()).join("\n")+"\n\n");return t&&y.emitSettingsChanged(),t}catch(t){return _.error("Failed to write "+e+": "+t),!1}}))}(o,n,e);return a&&r&&((yield m.thenNot(g.eqlAsync(I(o),I(e))))&&(_.info("Archiving prior, different contents",{dest:o,file:e}),yield e.renameYMD()),yield o.unwip()),a}))}function D(e){return b.splitLines(...c.entries(e).map(([e,t])=>e+" = "+JSON.stringify(t,void 0,2)))}function C(e=t.systemSettingsFile()){return i(this,void 0,void 0,(function*(){return(yield k(e,x.persistedSystemSettings()))?e:void 0}))}function I(e){return i(this,void 0,void 0,(function*(){return m.thenMap(e.readFile(),t=>_.tap({msg:`read(${e})`,result:r.parse(S.dumbquote(t.toString()))}))}))}function L(e){return i(this,void 0,void 0,(function*(){const t=w.mkLogger("SettingsIO.importFileSettings("+e.baseWithGrandparent+")");try{t.debug("ENV before",x.psenv());const n=yield I(e);if(null==n){if(yield e.isNonEmpty())throw new Error("Failed to read "+e);return[]}const i=new Map(c.entries(x.Settings).filter(([,e])=>e instanceof E.Setting&&e.opts.persisted).map(([e,t])=>[e.toLowerCase(),t])),r=s.compact(c.entries(n).map(([e,n])=>{const r=i.get(f.toS(e).toLowerCase());return null==r?t.warn("Failed to import (no setting with this name)",{key:e}):r.importFromFile(n),r}));return t.info("loaded",{file:e.baseWithGrandparent,tomlMap:n,imported:r.map(e=>c.pick(e,"name","value","persist"))}),r}catch(e){return void t.error("Cannot read"+a.verboseErrorToS(e))}}))}t.currentVersion=u.lazy(()=>M.version),t.stringify=D,t.writeSystemSettings=C,t.readLibrarySettings=function(e){return i(this,void 0,void 0,(function*(){return l.map(t.librarySettingsFile(e),e=>L(e))}))},t.writeLibrarySettings=function(e){return i(this,void 0,void 0,(function*(){yield P.setupLibraryDataDir(o.firstNotBlank(e,x.Settings.libraryPath.value));const n=t.librarySettingsFile(e);return!0===(yield l.map(n,e=>k(e,x.persistedLibrarySettings())))?(t.libraryHasSettings.clear(),n):void 0}))};const R=u.lazy(()=>new Set([x.Settings.logLevel,x.Settings.httpPort,x.Settings.rpcPort].map(e=>e.key)));function B(){return i(this,void 0,void 0,(function*(){c.values(x.Settings).filter(e=>!R().has(e.key)).forEach(e=>e.clear()),y.emitClearCache(),y.emitSettingsChanged()}))}t.clearSettings=B,t.nukeSettings=function(){return i(this,void 0,void 0,(function*(){yield t.systemSettingsFile().unlink("debug"),yield l.map(t.librarySettingsFile(),e=>e.unlink("debug")),B()}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),s=n(52),o=n(23),a=n(21),u=n(13),l=n(288),c=n(75),d=n(22),h=n(137),f=n(32),p=n(99),m=n(101),g=n(1),y=n(160),v=n(88),b=n(2),w=n(0),S=n(10),M=n(87),P=n(19),E=n(260),x=n(102),_=n(69),F=n(182),T=n(120),O=n(206),A=n(167),k=n(104),D=n(85);class C extends D.TimestampedModel{constructor(){super(...arguments),this.attrs={},this.urls=b.lazy(()=>new y.AssetUrls(this.toID()))}static shownCount(){return this.ops().count(this.shownUnhidden())}static outdatedQuery(){return this.query().where("version","<",h.AssetVersion)}static shownUnhidden(e){return w.orElse(e,()=>C.query()).andWhere({shown:1,hidden:0})}static nextOutdated(e=d.identity){return this.ops().findOne(e(this.outdatedQuery()))}static outdatedCount(e=d.identity){return this.dbr(t=>t.pluckFirst(e(this.outdatedQuery()).count()))}static findFirstByFile(e,t){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")),t)}static addTags(e,t){const n=g.uniqBy(t,e=>x.joinTagPath(e));if(this.logger().debug("addTags()",{assetId:e,tagPaths:t,uniqTagPaths:n}),g.isEmpty(n))return;const i=_.dbClient();if(null!=i)return i.request("assetAddTags",{assetId:e,tagPaths:n});{const t=n.map(e=>k.Tag._findOrCreate(e)).map(e=>e.id);return A.AssetTag.addTagsToAsset(e,t)}}static removeTags(e,t){if(g.isEmpty(t))return;const n=_.dbClient();if(null!=n)return n.request("assetRemoveTags",{assetId:e,tagPaths:t});{const n=g.compact(t.map(e=>k.Tag.findByPath(e)));return this.logger().info("removeTags()",{assetId:e,tags:n.map(e=>S.pick(e,"id","path")),tagPaths:t}),A.AssetTag.removeTagsFromAsset(e,g.compact(n.map(e=>e.id)))}}static unshownAssetIds(){return this.dbr(e=>e.pluckAll("\n        SELECT DISTINCT af1.assetId\n        FROM AssetFile af1\n          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 \n            ON af1.assetId = af2.assetId\n        WHERE af2.assetId IS NULL"))}static archive(e){const t=_.dbClient();if(null!=t)return t.request("assetArchive",{assetId:e});{const t=C.opsLocal().findById(e);if(null==t)return;return t.getFiles(),t.getTags(),u.eventEmitter.emit("modelArchive",t),A.AssetTag.opsLocal().exec(A.AssetTag.query().where({assetId:e}).delete()),T.AssetFile.opsLocal().exec(T.AssetFile.query().where({assetId:e}).delete()),void C.opsLocal().delete([e])}}get capturedAt(){return a.localToDateObject(this.capturedAtLocal)}get capturedAtMs(){return a.localToMs(this.capturedAtLocal)}renderCaption(e){return w.map(this.capturedAtMs,t=>"Taken "+a.fmtShort(t,e))}whenTagPath(){return r.thenMap(E.dateTag(this.capturedAt),x.tagPathToStringArray)}addTagPaths(e){return C.addTags(this.id,e)}findAssetFileByUri(e){return i(this,void 0,void 0,(function*(){return yield this.getFiles(),this.files.find(t=>t.uri===e)}))}addAssetFile(e){return i(this,void 0,void 0,(function*(){return null==(yield this.findAssetFileByUri(e.uri))&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}))}static getTags(e,t){const n=k.Tag.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return k.Tag.ops().all(n,t)}getTags(e){return null!=this.tags?this.tags:m.atap(C.getTags(this.id,e),e=>this.tags=e)}static getTagPaths(e){const t=k.Tag.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return k.Tag.dbr(e=>e.pluckAll(t))}tagPaths(){return i(this,void 0,void 0,(function*(){return(yield this.getTags()).map(e=>e.path.join("/")).sort()}))}getStreams(e){if(null==this.streams){const t=this.getTags();this.logger().info("getStreams(): fetched tags "+t,{limit:e});const n=t.map(t=>t.getAssetStream(this,e));this.streams=O.coalesceStreams(g.compact(n)),this.streams.forEach(e=>e.tags.forEach(e=>e.getAncestors()))}return this.streams}getBeforeAfterId(){return m.atap(C.dbr(e=>e.all(C.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id"))),e=>i(this,void 0,void 0,(function*(){this.beforeId=w.map(e.reverse().find(e=>e.id<this.id),D.toID),this.afterId=w.map(e.find(e=>e.id>this.id),D.toID),yield w.orElse(this.beforeId,()=>this.getBeforeId()),yield w.orElse(this.afterId,()=>this.getAfterId())})))}getBeforeId(){return m.amap(C.dbr(e=>e.first(C.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}]))),e=>this.beforeId=D.toID(e))}getAfterId(){return m.amap(C.dbr(e=>e.first(C.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}]))),e=>this.afterId=D.toID(e))}getTagPaths(e){return Promise.resolve(this.getTags(e)).then(e=>e.map(e=>e.path))}getFiles(e){return null!=this.files?this.files:null==this.id?this.files=[]:m.atap(T.AssetFile.ops().findBy({assetId:this.id},e),e=>this.files=g.sortBy(e,e=>[o.isTrue(e.shown),e.mtime]).reverse())}getShown(e){return null!=this.files?this.files.find(e=>o.isTrue(e.shown)):m.atap(T.AssetFile.ops().findOneBy({assetId:this.id,shown:1},e),e=>w.map(e,e=>e.asset=this))}getCapturedAt(){return i(this,void 0,void 0,(function*(){const e=yield this.getFiles();return r.thenCompact(P.toA(e).map(e=>e.toCapturedAt()))}))}link(){return"/asset/"+this.id}sqAttrs(e=!0){return Object.assign(Object.assign(Object.assign({},this.urls().sqImgAttrs(e)),{title:this.renderCaption()}),this.attrs)}getImgAttrs(e,t,n=!1){return i(this,void 0,void 0,(function*(){return null==this.imgAttrs&&(this.imgAttrs=new Map),yield c.getOrSetAsync(this.imgAttrs,t,()=>i(this,void 0,void 0,(function*(){const s=e.ap(this.toID());yield r.thenMap(s.readInfo(),e=>i(this,void 0,void 0,(function*(){e.mimetype.startsWith("video/")&&(this.poster=yield s.posterLink())})));return s.imgAttrs(t,!0,n)}))),this.imgAttrs}))}fitAttrs(){const e=w.map(this.imgAttrs,e=>e.get(v.ReducerNames.fit));if(null==e)throw new Error("fitAttrs() called before getImgAttrs()");return Object.assign(Object.assign({},e),this.attrs)}isVideo(){if(null==this.files)throw new Error(".video called before getFiles()");return this.files.some(e=>e.isVideo)}videoAttrs(){return Object.assign({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(null==this.existingFiles)throw new Error(".videoSources called before getExistingFiles()");const e=this.existingFiles.filter(e=>e.isVideo).map(e=>({src:this.urls().videoLink(e.id),type:e.mimetype})),t=g.uniqBy(e,e=>e.type);if(t.every(e=>"video/mp4"!==e.type)){const e=this.existingFiles[0];t.unshift({src:this.urls().videoLink(e.id)+".mp4",type:"video/mp4"})}return t}getPosixFiles(e){return i(this,void 0,void 0,(function*(){const t=yield this.getFiles(e);return g.compact(yield Promise.all(t.map(e=>e.posixFile())))}))}getExistingAssetFiles(e){return i(this,void 0,void 0,(function*(){return null==this.existingFiles&&(this.existingFiles=yield r.asyncFilter(yield this.getFiles(e),e=>r.thenMapOr(e.posixFile(),e=>e.exists(),()=>!1))),this.existingFiles}))}findOrCreateByFile(e){return i(this,void 0,void 0,(function*(){const t=yield e.uri();if(null==t)return;const n=P.toA(yield T.AssetFile.findByAsset({id:this.id},{uri:t}))[0];return w.orElse(n,()=>i(this,void 0,void 0,(function*(){const t=new T.AssetFile;return t.asset=this,t.assetId=this.id,yield t.setFile(e),t})))}))}clear(){return this.files=void 0,this.tags=void 0,this.existingFiles=void 0,this}setHidden(e){return C.txOp("ApiAssetRouter.hide()",()=>(this.hidden=e,this.upsert()))}setRotation(e,t,n){if(M.isRotation(e)){if(null!=this.id)return F.withAdvisoryLocks(["asset:"+this.id],()=>i(this,void 0,void 0,(function*(){const o=yield n.ap(this.id).smallestFileForReducer("fit");if(null==o)return this.logger().error("no fit preview files for "+this.id),void t.broadcast("repairAsset",this.id);const a=yield this.getFiles();if(null==this.getShown())return this.logger().error("no shown AssetFile found for "+this.id),void t.broadcast("repairAsset",this.id);const u=n=>i(this,void 0,void 0,(function*(){return r.thenMap(n.posixFile(),r=>i(this,void 0,void 0,(function*(){if(yield r.notExists())return;const i=yield l.matchRotation(o,r,e);if(null==i)this.logger().warn("Can't compute match rotation",{assetId:this.id,rotation:e,file:r.nativePath});else{this.logger().info("setRotation(): Writing "+i.rotation+" to "+r);const s=p.rotationToWriteTag(i.rotation,n.mimetype);if(null!=s)return yield f.writeTags(r,s),n.updateFromFile(r);this.logger().error("rotationToWriteTag returned null",{assetId:this.id,rotation:e,mimetype:n.mimetype,file:r.nativePath}),n.shown&&t.broadcast("repairAsset",this.id)}})))})),c=g.compact(yield s.withBoundedConcurrency({name:"setRotation",laters:a.map(e=>()=>u(e))}));return yield T.AssetFile.txOp("Asset.setRotation()",()=>i(this,void 0,void 0,(function*(){for(const e of c)e.upsert()}))),yield n.apb(this.id,c).build({force:!0}),this.logger().info("setRotation("+e+"): completed.",{updatedAssetFiles:c}),c})));this.logger().warn("invalid asset (null id)")}else this.logger().warn("setRotation("+e+"): invalid rotation")}}t.Asset=C,C.tableName="Asset",C.uniqueColumnName="id",C.hasUpdateCount=!0,C.booleanFields=["shown","hidden","favorite"]},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIterable=function(e){return null!=e&&"string"!=typeof e&&"function"==typeof e[Symbol.iterator]}},function(e,t){e.exports=require("exiftool-vendored")},function(e,t){e.exports=require("batch-cluster")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(3),r=n(59);t.onDataChunked=function(e,t,n){new s(t,n,!0).read(e)};class s{constructor(e,t,n=!0){this.sep=e,this.onData=t,this.filterBlanks=n,this.incompleteChunk="",this.done=new r.Latch}onChunk(e){if(null==e)return;const t=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=t.pop(),t.forEach(e=>{this.filterBlanks&&!i.notBlank(e)||this.onData(e)})}clear(){this.onChunk(""),i.notBlank(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",e=>this.onChunk(e)),e.on("close",()=>{this.clear(),this.done.resolve()}),this}}t.Chunker=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(7);function s(e,t){return e=r.toS(e),t=r.toS(t),e.startsWith(t)?e:t+e}t.ensurePrefix=s,t.ensureSuffix=function(e,t){return e=r.toS(e),t=r.toS(t),e.endsWith(t)?e:e+t},t.newlineRe=/\r?\n/gm,t.wrap=function e(n,o={maxLineLen:75,prefix:""}){if(n.includes("\n"))return i.flatten(n.split(t.newlineRe).map(t=>e(t,o)));if((n=s(r.toS(n).trim(),o.prefix)).length<=o.maxLineLen)return[n.trim()];const a=n.slice(0,o.maxLineLen+1).replace(/[\s-]/g," ").lastIndexOf(" "),u=a<=1?o.maxLineLen-(o.prefix.length+2):a;return[n.slice(0,u+1).trim(),...e(n.slice(u+1),o)]},t.eqlStrings=function(e,t){return null!=e&&null!=t&&e.normalize()==t.normalize()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(87),s=n(73),o=n(22);t.extractRotation=function(e){return i.map(e,e=>o.firstThunk(()=>u(e.Orientation),()=>u(e.CameraOrientation),()=>r.normalizeRotation(e.Rotation)))};const a=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function u(e){return i.map(e,e=>a.get(e))}t.orientationToRotation=u;const l=new Map([[0,1],[90,6],[180,3],[270,8]]);function c(e){return i.map(e,e=>l.get(e))}t.rotationToExifOrientation=c,t.rotationToWriteTag=function(e,t){return i.map(r.normalizeRotation(e),e=>s.isVideoMimeType(t)?{Rotation:e}:i.map(c(e),e=>({"Orientation#":e})))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(62),s=n(6),o=n(5),a=n(55),u=n(8),l=n(244),c=n(32),d=n(47),h=new a.TTLMap(2*s.minuteMs);function f(e){return r(e.nativePath).metadata()}function p(e){return i(this,void 0,void 0,(function*(){return d.isSharpExt(e.ext)?u.thenMap(f(e),e=>{const t=[e.width,e.height];o.gt0(e.orientation)&&[5,6,7,8].includes(e.orientation)&&t.reverse();const[n,i]=t;return o.gt0(n)&&o.gt0(i)?{width:n,height:i}:void 0}):void 0}))}t.dimensions=function(e){return l.getOrSetByNativePath(e,()=>function(e){return u.firstDefinedPromise([()=>u.thenMap(c.cachedTags(e),e=>e.dimensions),()=>p(e),()=>u.thenMap(c.sizeInfo(e.nativePath),e=>({width:e.ImageWidth,height:e.ImageHeight}))])}(e),h)},t.sharpMetadata=f,t.sharpDimensions=p},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(10),r=n(49);t.atap=function(e,t){return r.isPromise(e)?r.thenTap(e,t):i.tap(e,t)},t.amap=function(e,t){return r.isPromise(e)?e.then(e=>t(e)):t(e)},t.awaitAll=function(e){return e.some(e=>r.isPromise(e))?Promise.all(e):e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(261),r=n(91),s=n(1),o=n(0),a=n(19),u=n(7);function l(e){return o.map(e,e=>o.orElse(e.name,u.toS(e)))}function c(e){return e.map(l)}function d(e){return c(e).join(t.TagSep).toLowerCase()}function h(e,t){const n=new Set(s.compact(t).map(e=>d(e)));return s.compact(e).filter(e=>!n.has(d(e)))}function f(e){return l(a.toA(e)[0])}function p(e){return new Set(s.compact(a.toA(e).map(f)))}t.TagSep=String.fromCharCode(31),t.When="When",t.Camera="Camera",t.Lens="Lens",t.Keywords="Keywords",t.Type="Type",t.Roots=[{name:t.When,ordinal:1},{name:t.Camera,ordinal:5},{name:t.Lens,ordinal:6},{name:t.Keywords,ordinal:7},{name:t.Type,ordinal:8}],t.WhereSynonyms=new i.CISet(["country","el paÃ­s","emplacement","endroit","gps","les pays","location","ort","pays","place","places","platz","posiciÃ³n","region","rÃ©gion","site","sitio","stÃ¤tte","ubicaciÃ³n","where"]),t.WhatSynonyms=new i.CISet(["article","articles","item","items","le sujet","matiÃ¨re","object","objects","objet","objets","subject","subjects","subjekt","sujet","sujeta","sujeto","what"]),t.RootTagSynonyms=new i.CISet([...t.Roots.map(e=>e.name),...t.WhereSynonyms,...t.WhatSynonyms]),t.tagRefToS=l,t.tagPathToStringArray=c,t.joinTagPath=function(e,n=t.TagSep){return c(e).join(n)},t.tagPathEql=function(e,t){return null!=e&&null!=t&&d(e)===d(t)},t.tagDiff=h,t.tagDeltas=function(e,t,n=!0){const i=h(t,e),s=h(e,t),o=n?r.diff(p(s),p(i)):new Set;return{add:i,remove:s.filter(e=>!o.has(f(e)))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(9),r=n(5),s=n(10),o=n(33),a=n(205);function u(e){return null!=e&&i.isString(e.sql)&&(null==e.bindings||a.isDbValued(e.bindings))}function l(e){if(null==e)throw new Error("null sql");if(u(e))return e;if(i.isString(e))return{sql:e};if(o.isFunction(e.toSQL))return s.without(e.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+JSON.stringify(e))}function c(e){return null!=/\blimit\b/i.exec(l(e).sql)}function d(e){return o.isFunction(e.where)&&o.isFunction(e.limit)}t.isSqlQuery=u,t.toSqlQuery=l,t.hasLimit=c,t.isQueryBuilder=d,t.maybeLimit=function(e,t=1e3){return d(e)&&!c(e)?e.limit(t):e},t.wherein=function(e){return"("+r.times(e,()=>"?").join(",")+")"}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(12),s=n(13),o=n(293),a=n(14),u=n(101),l=n(1),c=n(3),d=n(6),h=n(2),f=n(0),p=n(5),m=n(15),g=n(51),y=n(295),v=n(55),b=n(36),w=n(102),S=n(69),M=n(74),P=n(93),E=n(206),x=n(167),_=n(85);const F=M.dbRpc()?3*d.minuteMs:30*d.secondMs;function T(e){return O.cacheTag(e),e}s.onClearCache(()=>O.clear()),t.DefaultRelatedAssetLimit=24;class O extends _.TimestampedModel{constructor(){super(...arguments),this.urls=h.lazy(()=>new y.TagUrls(this.id))}static cmp(e,t){return g.cmp([f.orElse(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[f.orElse(t.ordinal,Number.MAX_SAFE_INTEGER),...t.path])}static clear(){this.root.clear(),this.roots.clear(),this._upsertDefaultRoots.clear(),this.recentTagsByPath.clear(),this.tagById.clear(),this._assetCountById.clear(),this._assetFileCountById.clear()}static onAssetTagChange(){this._assetCountById.clear(),this._assetFileCountById.clear()}static cacheTag(e){return i(this,void 0,void 0,(function*(){const t=yield e;null!=t&&(Array.isArray(t)?t.forEach(e=>this.cacheTag(e)):t instanceof O&&null!=t.id&&c.notBlank(t._path)&&(this.recentTagsByPath.set(t._path,t),f.map(t.id,e=>this.tagById.set(e,t))))}))}static newTag(e){const t=new O;t._path=w.joinTagPath(e);const n=e[e.length-1];return f.map(n.ordinal,e=>t.ordinal=e),t}static findByIdOrPath(e,t,n){return p.gt0(e)?this.findById(e,n):this.findByPath(t,n)}static findById(e,t){return 0===e?O.root():f.orElse(O.tagById.get(e),()=>T(this.ops().findById(e,t)))}static findByPath(e,t){if(l.isEmpty(e))return O.root();{const n=w.joinTagPath(e);return f.orElse(O.recentTagsByPath.get(n),()=>T(this.ops().findOneBy({_path:n},t)))}}static getPagedAssets(e,t){const n=new O;return n.id=e,n.getPagedAssets(t)}static findOrCreate(e){const t=S.dbClient();return null!=t?t.request("tagFindOrCreate",e).then(e=>O.fromJSON(e)):this._findOrCreate(e)}static _findOrCreate(e){if(M.assertLocalDb(),l.isEmpty(e))throw new Error("empty tagPath");const t=w.joinTagPath(e,"/"),n=this.findByPath(e);if(this.logger().debug("_findOrCreate("+t+")",{prior:n}),null!=n)return n;const i=this.newTag(e),r=i.isRoot?void 0:this._findOrCreate(e.slice(0,-1));f.map(r,e=>i.parentId=e.id);const s=T(this.opsLocal().upsertOne(i));return this.logger().debug("_findOrCreate("+t+") upserted",{newTag:i,result:s,parent:r}),s}set name(e){const t=null!=this.parent?this.parent.path:[];this._path=r.concat(t,[e]).join(w.TagSep)}get name(){const e=this.path;return e[e.length-1]}get path(){return f.orElse(c.mapNotBlank(this._path,e=>e.split(w.TagSep)),[])}get isRoot(){return-1===this._path.indexOf(w.TagSep)}get parentPath(){return this.path.slice(0,-1)}$childrenQuery(){return O.query().where({parentId:this.id}).orderByRaw("COALESCE(ordinal, _path)")}$assetsQuery(){return P.Asset.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],f.map(this.parent,t=>t.setAncestors(e.slice(0,-1)))}toApiTag(){return M.assertLocalDb(),{tagId:this.id,tagPath:this.path,assetCount:this.getAssetCount(),assetFileCount:this.getAssetFileCount()}}toStringId(){return"Tag("+this.path.join("/")+")"}getParent(e){if(!this.isRoot)return null!=this.parentId&&null==this.parent?u.atap(O.findById(this.parentId,e),e=>this.parent=e):this.parent}getRoot(e){return this.isRoot?this:null!=this.root?this.root:u.atap(O.findByPath(this.path.slice(0,1),e),e=>this.root=e)}getPagedChildren(e,t){if(0===this.id)return this.children;let n=this.$childrenQuery();return a.mapGt0(e.offset,e=>n=n.offset(e)),a.mapGt0(e.limit,e=>n=n.limit(e)),O.ops().all(n,t)}getChildrenCount(){const e=O.query().count();return O.dbr(t=>t.pluckFirst(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})))}getChildren(e){return u.atap(O.ops().all(this.$childrenQuery(),e),e=>{this.children=e,e.forEach(e=>{e.parent=this})})}link(){return"/tag/"+this.path.join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}getAncestors(e){const t=r.ancestry(this.parentPath).map(e=>w.joinTagPath(e)),n=t.map(e=>O.recentTagsByPath.get(e));if(n.every(e=>null!=e))return this.ancestors=n;const i=O.query().whereIn("_path",t).orderBy("_path");return u.atap(O.ops().all(i,e),e=>{T(e),this.ancestors=e,this.parent=f.orElse(this.parent,e[e.length-1])})}getPagedAssets(e,t){let n=this.$assetsQuery(),i="desc";return a.mapGte0(e.capturedAtLt,e=>{n=n.where("capturedAtLocal","<",e)}),a.mapGte0(e.capturedAtGt,e=>{n=n.where("capturedAtLocal",">",e),i="asc"}),a.mapGte0(e.limit,e=>n=n.limit(e)),n=n.orderBy("capturedAtLocal",i),P.Asset.ops().all(n,t)}getAssets(e){const t=this.$assetsQuery().orderBy("capturedAtLocal","desc");return P.Asset.ops().all(t,e)}assetCountDesc(e){const t=this.getAssetCount();return(null==e||e.length===t||0===e.length?"":b.fmt(e.length)+" of ")+b.plur(t,"asset")}getDirectAssetCount(){return this._getAssetCountWithQuery(e=>e.where({tagId:this.id}))}getAssetCount(){const e=()=>this._getAssetCountWithQuery(e=>e.join("Tag as t","t.id","AssetTag.tagId").join("Asset as a","a.id","AssetTag.assetId").where("t._path","like",this._path+"%").andWhere("a.shown",1).andWhere("a.hidden",0));return M.dbRpc()?e():O._assetCountById.getOrSet(this.id,e)}getAssetFileCount(){const e=()=>this._getAssetCountWithQuery(e=>e.join("Tag as t","t.id","AssetTag.tagId").join("Asset as a","a.id","AssetTag.assetId").join("AssetFile as af","af.assetId","a.id").where("t._path","like",this._path+"%").andWhere("a.shown",1).andWhere("a.hidden",0),"af.id");return M.dbRpc()?e():O._assetFileCountById.getOrSet(this.id,e)}_getAssetCountWithQuery(e,t="AssetTag.assetId"){if(null==this.id)return 0;if(0===this.id)return P.Asset.shownCount();const n=x.AssetTag.query().countDistinct(t);return c.notBlank(this._path)&&e(n),x.AssetTag.ops().count(n)}$assetStreamQuery(e,t,n){return this.$assetsQuery().orderBy("capturedAtLocal",n?"desc":"asc").where("capturedAtLocal",n?"<":">",e.capturedAtLocal).limit(t)}getAssetStream(e,t){t=p.gt0(t)?t:8;const n=P.Asset.opsLocal().all(this.$assetStreamQuery(e,t,!0)),i=P.Asset.opsLocal().all(this.$assetStreamQuery(e,t,!1)).reverse();return new E.AssetStream([this],n,i)}getRelatedAssetIds(e,n=t.DefaultRelatedAssetLimit){const i=x.AssetTag.query().distinct("Asset.id","Asset.capturedAtLocal","Asset.updatedAt").join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).orderByRaw(o.prngOrderByClause(e+f.orElse(this.id,0),"Asset.id",f.orElse(A(),Math.pow(2,20)))).limit(n),r=P.Asset.opsLocal().all(i);return l.sortByInPlace(r,e=>m.Opt(e.capturedAtLocal).map(e=>-e).getOrElse(()=>0)),this.logger().debug(this.path+": Found "+r.length+" related assets"),r.map(e=>e.toID())}get attrs(){return{href:this.link(),title:this.name}}}t.Tag=O,O.tableName="Tag",O.uniqueColumnName="_path",O.recentTagsByPath=new v.TTLMap(F),O.tagById=new v.TTLMap(F),O._assetCountById=new v.TTLMap(30*d.secondMs),O._assetFileCountById=new v.TTLMap(30*d.secondMs),O.root=h.lazy(()=>{const e=new O;return e.id=0,e.name="",e._path="",e.parentId=void 0,u.atap(O.roots(),t=>e.children=t),e.ancestors=[],e.upsert=()=>{throw new Error("upsert not supported")},e},F),O._upsertDefaultRoots=h.lazy(()=>O.ops().upsert(w.Roots.map(e=>({_path:e.name,ordinal:e.ordinal})))),O.roots=h.lazy(()=>{const e=S.dbClient();if(null!=e)return e.request("tagRoots").then(e=>e.map(e=>O.fromJSON(e)));{O._upsertDefaultRoots();const e=O.query().whereNull("parentId").orderByRaw("coalesce(ordinal, _path)");return u.atap(O.ops().all(e),e=>{O.logger().info("roots()",e),e.forEach(e=>{e.parentId=void 0,e.ancestors=[],T(e)})})}});const A=h.lazy(()=>p.base10Ceil(P.Asset.dbLocal().pluckFirst(P.Asset.query().count("id"))),d.minuteMs)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(30),r=n(6),s=n(5),o=n(14),a=n(187),u=n(41);class l{constructor(e){if(this.ttlMs=e,this._eventCount=0,this._lastEventTime=0,e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new a.TTLArray(e)}[i.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){const e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return o.mapGt0(this.eventDeltas.length,()=>u.weightedAvg(this.eventDeltas))}get msPerEvent(){return u.avg(this.eventDeltas)}get eventsPerMs(){return o.mapGte0f(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return o.mapGte0f(this.eventsPerMs,e=>s.sigFigs(r.secondMs*e,3))}get eventsPerMinute(){return o.mapGte0f(this.eventsPerMs,e=>s.sigFigs(r.minuteMs*e,3))}}t.Rate=l},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(3),o=n(2),a=n(7),u=n(26),l=n(11);function c(e){const n=t.LogLevels.indexOf(e.toLowerCase());return-1===n?t.LogLevels.length-1:n}t.LogLevels=["error","warn","info","debug","trace"],t.levelIndex=c,t.silently=function(e){try{return t.logFilter().silent=!0,e()}finally{t.logFilter().silent=!1}},t.silentlyAsync=function(e){return i(this,void 0,void 0,(function*(){try{return t.logFilter().silent=!0,yield e()}finally{t.logFilter().silent=!1}}))},function(e){e.highlight=()=>!1,e.enabled=()=>!e.silent,e.defaultLevelIndex=c("trace"),e.silent=!1}(t.PermissiveLogFilter||(t.PermissiveLogFilter={}));const d=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i;class h{constructor(e){this.silent=!1,this.contexts=[];let t=c(l.Settings.logLevel.defaultValue);const n=s.notBlank(e)?e:l.Settings.logLevel.valueOrDefault;r.compactBlanks(n.split(",")).forEach(n=>{const i=d.exec(n.trim());if(null==i)u.isTest||console.error("EnvLogFilter: Ignoring '"+n+"' from "+e);else{const e=a.toS(i[1]).toLowerCase(),n=c(i[2]);s.blank(e)?t=n:this.contexts.push({prefix:e,levelIndex:n})}}),this.defaultLevelIndex=t}contextOverride(e){if(0===this.contexts.length&&s.blank(e))return;const t=a.toS(e).toLowerCase();return this.contexts.find(e=>t.startsWith(e.prefix))}enabled(e,t){if(this.silent)return!1;const n=c(e),i=this.contextOverride(t);return n<=(null!=i?i.levelIndex:this.defaultLevelIndex)}highlight(e){const t=this.contextOverride(e);return null!=t&&t.levelIndex>=this.defaultLevelIndex}}t.LogFilterImpl=h,t.logFilter=o.lazy(()=>new h),l.Settings.logLevel.addListener(()=>t.logFilter.clear())},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(289),s=n(8),o=n(0),a=n(10);t.knex=r({client:"sqlite3",useNullAsDefault:!0}),t.firstMigratedAt=function(e){return i(this,void 0,void 0,(function*(){return s.thenMap(e("migrations").min("migration_time").first(),e=>o.map(a.values(e)[0],e=>new Date(e)))}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(44),r=n(34),s=n(3),o=n(81);t.appData=function(){const e=s.firstNotBlank(o.getEnv("PS_CONFIG_DIR"),o.getEnv("APPDATA"),o.getEnv("XDG_DATA_HOME"),o.getEnv("XDG_CONFIG_HOME"));if(s.notBlank(e))return e;switch(i.platform()){case"win32":return r.resolve(i.homedir(),"AppData","Roaming");case"darwin":return r.resolve(i.homedir(),"Library","Application Support");default:return r.resolve(i.homedir(),".config")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppName="PhotoStructure"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(5),o=n(10),a=n(76);t.CountingSet=class{constructor(){this.m=new Map}incr(e,t=1){const n=this.get(e)+t;return 0===n?this.m.delete(e):this.m.set(e,n),this}get(e){return r.orElse(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){const e=new a.Average(0);for(const t of this.keys()){if(!s.isNumber(t))return;e.push(t)}return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){const e=this.keyAvg();return i.sortBy([...this.entries()],([t,n])=>[-n,s.mapNumericOr(e,e=>Math.abs(t-e),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(e=>e[0])}get averageCounts(){return o.tap(new a.Average(this.size),e=>[...this.m.values()].forEach(t=>e.push(t)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return i.sort([...this.keys()]).map(e=>e+" "+this.get(e)).join("\n")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(6),o=n(5),a=n(7),u=n(53),l=n(54),c=n(14),d=n(22),h=n(91);function f(e,t){if(null==e)return t;if(null==t)return e;if((e=e.normalize())===(t=t.normalize())||t.includes(e))return e;if(e.includes(t))return t;const n=new c.Array2D(e.length);let i=0,r="";for(let s=0;s<e.length;s++)for(let o=0;o<t.length;o++)e[s]===t[o]&&(0===s||0===o?n.set(s,o,1):n.set(s,o,n.get(s-1,o-1)+1),n.get(s,o)>=i&&(i=n.get(s,o),r=e.substr(s-i+1,i)));return r}function p(e,t){if(null!=e&&null!=t)return e=e.normalize(),t=t.normalize(),e.length!==t.length?void 0:e.split("").reduce((e,n,i)=>n===t.charAt(i)?e:e+1,0)}t.commonSubstringRatio=function(e,t){return[e,t].some(r.blank)?0:f(e,t).length/Math.max(e.length,t.length)},t.lcs=f,t.hamming=p;const m=new u.BoundedMap(10*s.minuteMs,1e4,!0),g=String.fromCharCode(31);function y(e,t){return e=e.normalize(),t=t.normalize(),m.getOrSet(i.sort([e,t]).join(g),()=>{if(0===e.length)return t.length;if(0===t.length)return e.length;const n=e.charAt(e.length-1)===t.charAt(t.length-1)?0:1,i=e.slice(0,-1),r=t.slice(0,-1);return Math.min(y(i,t)+1,y(e,r)+1,y(i,r)+n)})}function v(e,t){const n=e.toUpperCase().normalize(),i=t.toUpperCase().normalize();return d.firstThunk(()=>n===i?1:void 0,()=>r.blank(e)!==r.blank(t)?0:void 0,()=>1===e.length&&1===t.length?0:void 0,()=>{const e=b(n),t=b(i);return 2*w(e,t).length/(e.length+t.length)})}function b(e){return null==e||0===e.length?[]:e.slice(0,-1).split("").map((t,n)=>t+e[n+1])}function w(e,t){const n=h.intersection(e,t),r=[];return n.forEach(n=>{const s=Math.min(i.count(e,e=>e===n),i.count(t,e=>e===n));o.times(s,()=>r.push(n))}),r}function S(e,t,n){const r=i.commonPrefixLength(e,t);return n(e.substr(r))-n(t.substr(r))}function M(e){const t=i.compactBlanks(a.toS(e).split(/[^\d]+/));return i.sortBy(t,e=>-e.length)[0]}function P(e,t){const[n,i]=[e,t].map(M).map(e=>r.blank(e)?"":e);return S(n,i,e=>o.toInt(e,{defaultValue:0}))}t.levenshtein=y,t.diceCoeff=v,t.bigrams=b,t.nonUniqIntersection=w,t.lnsDiff=P;const E=/[^0-9a-z]+/gi;function x(e,t){const[n,i]=[e,t].map(e=>a.toS(e).replace(E,"").toLowerCase());return S(n,i,e=>l.RadixAlphaNum.decode(e))}t.radixDiff=x,t.str=function(e,t){return{pref:i.commonPrefixLength(e,t),lev:y(e,t),ham:p(e,t),dice:v(e,t),lns:P(e,t),radixDiff:x(e,t)}},t.lcdiff=function(e){return i.count(e.normalize().split(""),e=>0!=e.toLowerCase().localeCompare(e))}},function(e,t){e.exports=require("crypto")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(43),r=n(181),s=n(0),o=n(5),a=n(162),u=n(8);t.PushProgressObserver=class{constructor(e,t){this.context=e,this.total=t,this.start=Date.now(),this.emit=a.throttle(()=>{r.emitProgressEvt(Object.assign(Object.assign({},this.context),{pct:100*this.current/this.total,elapsedMs:Date.now()-this.start}))},750,!0)}onProgress(e){this.current=o.clamp(0,this.total,s.orElse(e,s.orElse(this.current,0)+1)),this.emit()}};t.PullProgressObserver=class{constructor(e,t,n){this.ctx=e,this.total=t,this.progress=n,this.start=Date.now(),this.onInterval=a.throttle(()=>u.thenMap(this.progress(),e=>this.emit(e)),750),this.timer=i.setInterval(()=>this.onInterval(),750)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){s.map(e,e=>r.emitProgressEvt(Object.assign(Object.assign({},this.ctx),{pct:100*o.clamp(0,this.total,e)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>750&&this.emit(this.total),this.end()}end(){s.map(this.timer,e=>i.clearInterval(e)),this.timer=void 0}}},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});const i=n(56),r=n(34),s=n(18),o=n(1),a=n(2),u=n(12),l=n(16);function c(e){const t=[];for(;e!==r.dirname(e);)e=r.dirname(e),t.push(e);return t}function d(e){try{return i.readdirSync(e)}catch(e){return[]}}function h(e,t){const n=d(e);return t.every(e=>n.includes(e))}t.execDir=a.lazy(()=>r.dirname(process.execPath)),t.ancestors=c,t.childrenSync=d,t.ancestorWithChildren=function(e,t){return c(e).find(e=>h(e,t))},function(n){function i(e){return a.lazy(()=>r.join(n.Root(),e))}n.Root=a.lazy(()=>{const n=["migrations","public","views"],i=[];l.isDocker()&&i.push("/ps/app"),l.isElectron&&i.push(r.join(t.execDir(),"resources"),r.join(t.execDir(),"..","Resources")),i.push(...o.compactBlanks([t.execDir(),s.cwd(),e])),u.uniqInPlace(i);for(const e of i){if(h(e,n))return e;for(const t of c(e).slice(0,4)){if(h(t,n))return t;const i=r.join(e,"node_modules","photostructure");if(h(i,n))return i}}throw new Error("Failed to find project root. Looked in "+i)}),n.Migrations=i("migrations"),n.Public=i("public"),n.Tools=i("tools"),n.Views=i("views")}(t.ProjectPath||(t.ProjectPath={}))}).call(this,"/")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(18),r=n(3),s=n(2),o=n(60),a=s.lazy(()=>[{re:/sync-file/,f:o.cyan},{re:/sync/,f:o.blue},{re:/web/,f:o.green},{re:/db/,f:o.magenta},{re:/main/,f:o.yellow}]);let u="";t.processName=s.lazy(()=>{if(r.blank(u))return"";const e=u+"-"+i.pid,t=a().find(e=>u.match(e.re));return null!=t?o.bgBlack(t.f(e)):e}),t.processNamePlain=function(){return u+"-"+i.pid},t.setProcessName=function(e){u=e,t.processName.clear()}},function(e,t){e.exports=require("url")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(2),o=n(0),a=n(15),u=n(77),l=n(8),c=n(17),d=n(31),h=n(4),f=n(16),p=n(9),m=n(118),g=n(25);t.isGioSupported=s.lazy(()=>i(void 0,void 0,void 0,(function*(){if(!f.isLinux)return!1;try{return 0===(yield c.stdoutResult(t.GioCommand,["version"],{timeout:g.cmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}}))),t.GioCommand="gio",t.GioMountMonitorArgs=["mount","--monitor","--anonymous"];const y=h.mkLogger("Gio.gioVolumes()");t.gioVolumes=s.lazy(()=>i(void 0,void 0,void 0,(function*(){const e=yield function(){return i(this,void 0,void 0,(function*(){return(yield t.isGioSupported())?l.thenFlatten(yield l.thenMap(t.mtabEntries(),e=>e.map(e=>d.BaseFile.for(e).clear().childDirectories()))):[]}))}(),n=(yield l.thenFlatten(e.map(e=>i(void 0,void 0,void 0,(function*(){const t=yield m.dfPosixRaw(!1,e.nativePath).catch(t=>{y.warn("Failed to df "+e+": "+t)}),n=o.map(t,e=>e[0]);return o.map(n,t=>t.mountpoint=e.nativePath),n}))))).filter(e=>e.size>0);return Promise.all(n.map(e=>i(void 0,void 0,void 0,(function*(){return l.thenMapOr(b(e.mountpoint),t=>(e.remoteHost=t.remoteHost,e.remoteShare=t.remoteShare,e.label=t.displayName,e.remote=!0,e),()=>e)}))))})),g.dfTtlMs);const v=h.mkLogger("Gio.getRemoteInfo()"),b=u.memoize(e=>i(void 0,void 0,void 0,(function*(){try{const n=(yield c.stdout(t.GioCommand,["info",e],{timeout:g.cmdTimeoutMs})).split(/[\n\r]+/),i=r.mapNotBlank(n.find(e=>e.startsWith("uri: ")),e=>new URL(p.stripPrefix(e,"uri: ")));return{displayName:o.map(n.find(e=>e.startsWith("display name: ")),e=>p.stripPrefix(e,"display name: ")),remoteHost:o.map(i,e=>e.hostname),remoteShare:a.Opt(i).flatMap(e=>e.pathname).flatMap(e=>p.stripPrefix(e,"/")).flatMap(e=>p.stripSuffix(e,"/")).flatMap(decodeURIComponent).filter(r.notBlank).get()}}catch(t){return void v.warn("gio info failed",{mountpoint:e,err:t})}})),g.dfTtlMs,1e3);t.mtabEntries=s.lazy(()=>i(void 0,void 0,void 0,(function*(){return l.thenMap(d.BaseFile.for("/proc/mounts").readLines(),e=>e.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1]))})),g.dfTtlMs)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(5),o=n(7),a=n(17),u=n(71),l=n(16),c=n(224),d=n(25);function h(e){return 1024*s.toInt(e,{defaultValue:0})}const f=l.isMac?["devfs"]:["udev","tmpfs","devtmpfs"],p=["/boot/efi"];t.dfPosixRaw=function(e,t){return i(this,void 0,void 0,(function*(){const n=l.isMac?yield c.ignorableMacFilesystems():[],i=["-k","-P"];e&&i.push("-l"),r.notBlank(t)&&i.push(t);const s=yield a.stdout("df",i,{timeout:d.cmdTimeoutMs});return u.parseFixed(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],s).map(e=>({filesystem:e.Filesystem,size:h(e["1024-blocks"]),used:h(e.Used),available:h(e.Available),mountpoint:e["Mounted on"]})).filter(e=>{const t=o.toS(e.filesystem),i=o.toS(e.mountpoint);return r.notBlank(i)&&!p.includes(i)&&r.notBlank(t)&&!n.includes(t)&&!f.includes(t)})}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(62),s=n(68),o=n(3),a=n(2),u=n(0),l=n(8),c=n(177),d=n(4),h=n(11),f=n(32),p=n(47),m=n(99),g=n(130),y=n(70),v=n(128),b=n(100),w=n(125),S=n(198),M=n(127),P=n(73),E=d.mkLogger("SharpReadable");function x(e,t,n,r){return i(this,void 0,void 0,(function*(){return u.map(t,t=>u.map(t[n],()=>l.thenMap(F(e,n),t=>l.thenMap(b.dimensions(t),i=>E.tap({level:"info",msg:"imgFromExif",meta:{src:e.baseWithGrandparent,tag:n,dim:i,minDim:r},result:v.ltBoth(r,i)?t:void 0})))))}))}t.imgFromExif=x;const _=a.lazy(()=>r.concurrency(y.maxCpus()));function F(e,t){const n=t.toLowerCase().endsWith("tiff")?".tiff":".jpg";return l.thenMap(w.cachedImgFile(e,t,n),n=>n.applyIfEmpty(n=>i(this,void 0,void 0,(function*(){return f.extractBinaryTag(t,e.nativePath,n.nativePath)}))))}t.sharpReadable=function(e,t,n=!1){return i(this,void 0,void 0,(function*(){_();const r=!n,a=yield f.readRawTags(e,r),d=null==a?void 0:a.MIMEType;if(null==a||o.blank(d))throw new Error(e+" is not supported (missing mimetype)");const y=[],v=m.extractRotation(a),b=g.extractSizeInfo(a,v,c.dcrawSupportedMimetype(d)?yield S.rawInfo(e):void 0);if(null!=b){const i=u.orElse(t,{width:.95*b.dimensions.width,height:b.dimensions.height});if((n||null==v||0===v)&&!P.isVideoMimeType(d)){const n=h.Settings.useEmbeddedPreviews.valueOrDefault?["PreviewImage","PreviewTIFF","JpgFromRaw"]:[];h.Settings.useEmbeddedThumbnails.valueOrDefault&&null!=t&&t.width<=120&&t.height<=120&&n.unshift("ThumbnailImage","ThumbnailTIFF"),y.push(...n.map(t=>()=>x(e,a,t,i)))}}p.isSharpMimetype(d)&&y.push(()=>i(this,void 0,void 0,(function*(){return e}))),c.dcrawSupportedMimeTypes.has(d)&&y.push(()=>w.readableToFile(e,"dcraw",".tiff",()=>E.tap({level:"info",msg:"sharpReadable() -> dcraw()",result:c.dcraw(e),meta:{src:e.nativePath,minDim:t}}))),y.push(()=>s.retryOnReject(()=>M.extractVideoFrame(e,d),{maxRetries:1}));const F=[],T=yield l.firstResolvedDefinedPromise(y,t=>{E.warn("strategy failed for "+e+": "+t),F.push(t)});if(null==T)throw u.orElse(F[0],new Error("Cannot read "+e));return T}))},t.extractImageForThumbs=F},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(116),s=n(8),o=n(23),a=n(21),u=n(20),l=n(29),c=n(164),d=n(165),h=n(248),f=n(73),p=n(22),m=n(137),g=n(11),y=n(9),v=n(129),b=n(32),w=n(263),S=n(101),M=n(35),P=n(1),E=n(3),x=n(88),_=n(2),F=n(0),T=n(5),O=n(10),A=n(7),k=n(78),D=n(107),C=n(93),I=n(85);class L extends I.TimestampedModel{constructor(){super(...arguments),this.posixFile=_.lazy(()=>l.PosixFile.forUri(this.uri,this.mountpoint))}static recentAssetIdsByUriRoot(e,t,n=64){const i=Date.now()-t,r=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",i).andWhere("AssetFile.uri","like",e+"%").andWhere("Asset.shown",1).andWhere("Asset.hidden",0);return r.orderBy("AssetFile.updatedAt","desc").limit(n),this.logger().info("recentAssetIdsByUriRoot",r.toSQL()),this.dbLocal().pluckAll(r)}static assetCountByMimetype(e){const t=this.query().select(D.knex.raw("mimetype, count(*) as count"));return E.notBlank(e)&&t.andWhere("uri","like",e+"%"),t.groupBy("mimetype").orderBy("mimetype"),this.dbr(e=>e.all(t))}static children(e,t){const n=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${y.escapeRegExp(e)}/[^/]+$}`);return this.ops().all(F.mapOr(t,e=>e(n),()=>n))}get capturedAtDateTime(){return a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return a.fmtDateTime(this.capturedAtDateTime,e)}static outdatedQuery(e){const t=this.query().where("version","<",m.AssetFileVersion);return P.isEmpty(e)?t:t.andWhere(t=>t.whereIn("mountpoint",e).orWhereNull("mountpoint"))}static nextOutdated(e=p.identity){return i(this,void 0,void 0,(function*(){return this.ops().findOne(e(this.outdatedQuery(yield M.mountpoints())))}))}static outdatedCount(e=p.identity){return i(this,void 0,void 0,(function*(){const t=this.outdatedQuery(yield M.mountpoints());return this.dbr(n=>n.pluckFirst(e(t.count())))}))}static setShown(e,t,n){if(this.logger().info("setShown()",{assetId:e,assetFileId:t}),!T.gt0(e)||!T.gt0(t))throw new Error("setShown(): invalid IDs: "+JSON.stringify({assetId:e,assetFileId:t}));this.dbr(t=>t.run(L.query().update("shown",0).where("assetId",e)),n);const i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),r={assetId:e,assetFileId:t,updatedAt:Date.now()};return this.dbr(e=>e.run({sql:i,bindings:r}),n)}static findByAsset(e,t,n){const i=this.query().select("AssetFile.*");return F.map(O.compactValues(e),e=>{i.join("Asset","Asset.id","AssetFile.assetId").where(O.mapFields(e,(e,t)=>["Asset."+e,t]))}),F.map(O.compactValues(t),e=>{i.where(O.mapFields(e,(e,t)=>["AssetFile."+e,t]))}),this.ops().all(i,n)}get modes(){return P.compact(T.times(d.ModeCount,e=>this["mode"+e]))}set modes(e){T.times(d.ModeCount,t=>this["mode"+t]=e[t])}matchesFile(e){return i(this,void 0,void 0,(function*(){if(null==this.version||this.version<m.AssetFileVersion||g.Settings.forceSync.valueOrDefault)return!1;const t=yield s.thenOrElse(e,()=>this.posixFile());return null!=t&&null!=this.fileSize&&null!=this.mtime&&this.uri===(yield t.uri())&&this.fileSize===(yield t.size())&&this.mtime===(yield t.thisOrSidecareMaxMtimeMs())}))}isUpdated(){return null!=this.version&&this.version>=m.AssetFileVersion}updateIfNeeded(){return i(this,void 0,void 0,(function*(){return(yield this.matchesFile())?this:(yield this.notExists())?void 0:s.thenMap(this.updateFromFile(),()=>this.upsert())}))}maybeUpdateStats(e){return i(this,void 0,void 0,(function*(){if(null==(e=null!=e?e:yield this.posixFile())||(yield e.notExists()))return;const t=yield e.stat();return null!=t&&0!==t.size?(this.fileSize=t.size,this.mtime=F.orElse(yield e.thisOrSidecareMaxMtimeMs(),()=>t.mtimeMs),this):void 0}))}updateFromFile(e){return i(this,void 0,void 0,(function*(){const t=Date.now();if(this.logger().debug("updateFromFile() before",this),null!=this.id&&(yield this.matchesFile(e)))return void this.logger().info("updateFromFile() no-op: up-to-date version and file stat matches since last update");if(null!=e&&(yield this.setFile(e)),null==e&&(e=yield this.posixFile()),yield null==e?void 0:e.notExists())return void this.logger().info("updateFromFile() no-op, "+e+" is missing");if(null==e||null==(yield this.maybeUpdateStats(e)))return this.logger().throw("updateFromFile(): no file",{id:this.id,uri:this.uri});const n={},i=s.thenMap(e.sha(),e=>n.sha=e),r=yield b.readTags(e);if(null==r)return this.logger().throw("missing tags for "+e);if(E.blank(r.MIMEType))return this.logger().throw("missing MIMEType for "+e);n.mimetype=r.MIMEType;const o=r.capturedAt,a=o.toLocal();if(null==a)return this.logger().throw("Bad CapturedAt",o);n.capturedAtLocal=a,n.capturedAtOffset=o.toOffset(),n.capturedAtPrecisionMs=o.toPrecisionMs(),n.capturedAtSrc=o.src,F.map(r.exposureSettings,e=>{n.focalLength=e.focalLength,n.aperture=e.aperture,n.shutterSpeed=e.shutterSpeed,n.iso=e.iso});const u=r.dimensions;if(n.width=u.width,n.height=u.height,n.rotation=r.rotation,n.make=r.Make,n.model=r.Model,n.cameraId=w.cameraId(r),n.imageId=F.map(w.imageId(r),A.toS),n.lensId=w.lensId(r),n.geohash=c.geohashNumericShort(r.GPSLatitude,r.GPSLongitude),n.durationMs=F.map(r.duration,e=>Math.round(1e3*e)),g.Settings.useImageHashes.valueOrDefault&&(yield s.thenMap(d.imageHash(e),e=>{n.meanHash=e.meanHash,n.rightHash=e.rightHash,n.searchHash=e.searchHash,n.modes=e.modes})),null==(yield i))return this.logger().throw("missing SHA for "+e);for(const e of O.keys(n)){const t=n[e];(null!=t||g.Settings.forceSync.valueOrDefault)&&(this[e]=t)}this.version=m.AssetFileVersion;const l=Date.now()-t;return this.logger().log(l>250?"info":"debug","updateFromFile() after ("+l+"ms)",this),this}))}updateFromShaSibling(e){return i(this,void 0,void 0,(function*(){return this.isUpdated()?this:null!=e.sha&&e.sha===this.sha&&e.isUpdated()?(p.assignMissingPrimitives(this,O.without(e,"id","assetId","asset","shown","uri","mountpoint","mtime","createdAt","updatedAt")),this.version=m.AssetFileVersion,this.upsert()):this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e})}))}getAsset(e){return null==this.assetId||null!=this.asset?this.asset:S.atap(C.Asset.ops().findById(this.assetId,e),e=>this.asset=e)}exists(){return i(this,void 0,void 0,(function*(){return s.thenMapOr(this.posixFile(),e=>e.exists(),()=>!1)}))}notExists(){return i(this,void 0,void 0,(function*(){return s.thenNot(this.exists())}))}isDeleted(){return i(this,void 0,void 0,(function*(){if(this.uri.startsWith(k.PS_LIBRARY_PROTOCOL)){const e=g.Settings.libraryPath.value;if(E.blank(e))return this.logger().throw("isDeleted(): no set library path"+u.FatalErrorFlag,{uri:this.uri});const t=l.PosixFile.for(e);if(yield t.isNotDirectory())return this.logger().throw("isDeleted(): library path is missing"+u.FatalErrorFlag,{uri:this.uri,libraryPath:e});const n=yield this.posixFile();return null==n?this.logger().throw("isDeleted(): internal error: posixFile() is null",{uri:this.uri,libraryPath:e}):n.notExists()}return s.thenMapOr(this.posixFile(),e=>F.map(this.mountpoint,t=>e.isDeleted(t)),()=>!1)}))}setFile(e){return i(this,void 0,void 0,(function*(){const t=yield e.uriObject();if(null==t)throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);const n=r.format(t);if(null==n)throw new Error(e+" had no URI");if(null!=this.uri&&n!==this.uri)throw new Error("Cannot reassign URIs");return this.uri=n,this.mountpoint=F.map(t.volume,e=>e.mountpoint),this.posixFile.set(Promise.resolve(e)),n}))}nativePath(){return s.thenMap(this.posixFile(),e=>e.nativePath)}toCapturedAt(){return F.map(a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset),e=>s.thenMap(this.posixFile(),t=>new v.CapturedAt(t,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}downloadables(e){return i(this,void 0,void 0,(function*(){try{const t=yield this.posixFile();if(null==t)return[];const n=e.ap(this.assetId),i=[];if((yield t.isNonEmpty())&&i.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:h.mkDownloadableTitle(t,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:t.base,description:"Download original"}),this.isVideo||!o.isTrue(this.shown))return i;const r=P.compact(yield Promise.all([...yield n.previews()].reverse().filter(e=>e.reducer==x.ReducerNames.fit).map(e=>h.previewToDownloadable(t.base,e))));return i.push(...P.uniqBy(r,e=>e.size)),i}catch(e){return u.onError("AssetFile.downloadables failed",e,{context:this}),[]}}))}toApi(e){return i(this,void 0,void 0,(function*(){return s.thenMap(this.posixFile(),t=>i(this,void 0,void 0,(function*(){return O.reqValuedOrElse({assetId:this.assetId,assetFileId:this.id,nativePath:t.nativePath,wbrNativePath:y.wbrPath(t.nativePath),basename:t.base,exists:yield t.isNonEmpty(),mimetype:this.mimetype,shown:o.isTrue(this.shown),width:this.width,height:this.height,rotation:F.orElse(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:yield this.downloadables(e),createdAt:this.createdAt,updatedAt:this.updatedAt})})))}))}get isVideo(){return f.isVideoMimeType(this.mimetype)}}t.AssetFile=L,L.tableName="AssetFile",L.uniqueColumnName="uri",L.booleanFields=["shown"],L.hasUpdateCount=!0},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(16),s=n(9),o=n(7);t.crlf=function(e){const t=e+"\n";return r.isWin?t.replace(s.newlineRe,"\r\n"):t},t.splitLines=function(...e){return i.flatten(e.map(e=>o.toS(e).split(s.newlineRe)))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(196),s=n(6),o=n(0),a=n(5),u=n(36),l=n(8),c=n(14),d=n(11),h=n(32),f=n(47),p=n(25);t.MinSyncFileTimeoutMs=30*s.secondMs,t.MaxSyncFileTimeoutMs=15*s.minuteMs,t.DurationMultiplier=10;const m={p0:{x:.8*u.MB,y:4*s.secondMs},p1:{x:20*u.MB,y:12*s.secondMs}},g={p0:{x:11*u.MB,y:12*s.secondMs},p1:{x:26*u.MB,y:24*s.secondMs}},y={p0:{x:7*u.MB,y:45*s.secondMs},p1:{x:32*u.MB,y:90*s.secondMs}};function v(e){return f.isVideoExt(e.ext)?Math.max(o.orElse(c.mapGt0(e.durationMs,e=>e*t.DurationMultiplier),0),r.lerp2d(y.p0,y.p1,e.bytes)):0}function b(e){return l.thenMap(w(e),S)}function w(e){return l.thenMap(e.size(),t=>i(this,void 0,void 0,(function*(){return{bytes:t,ext:e.ext,durationMs:f.isVideoExt(e.ext)?yield l.thenMap(h.readRawTags(e),e=>c.mapGt0(e.Duration,e=>e*s.secondMs)):void 0}})))}function S(e){const n=a.clamp(.5*u.MB,64*u.GB,e.bytes),i=5*s.secondMs,o=p.cmdTimeoutMs,l=2*n*p.MinIoRate,c=e=>r.lerp2d(e.p0,e.p1,a.clamp(.5*u.MB,50*u.MB,n)),h=c(m),y="raw"===f.extType(e.ext)?c(g):0,b=v(e),w=d.Settings.validateVideos.valueOrDefault?b:0;return{result:a.clamp(t.MinSyncFileTimeoutMs,t.MaxSyncFileTimeoutMs,Math.round(i+o+l+h+y+b+w)),dbMs:i,tagMs:o,copyMs:l,thumbMs:h,rawDecodeMs:y,transcodeMs:b,validateMs:w}}t.transcodeTimeoutForFile=function(e){return f.isVideoExt(e.ext)?l.thenMap(w(e),v):void 0},t.transcodeTimeout=v,t.syncFileTimeoutForFileMs=function(e){return l.thenMap(b(e),e=>e.result)},t.syncFileTimeoutForFile=b,t.dcrawTimeout=function(e){return r.lerp2d(g.p0,g.p1,a.clamp(11*u.MB,100*u.MB,o.orElse(e,0)))},t.syncFileTimeout=S},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(95),r=n(0),s=n(5),o=n(7),a=n(42),u=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/;class l{constructor(e,t,n,i=0,r=1){this.start=e,this.middle=t,this.end=n,this.index=i,this.splits=r,this.toISOString=this.toString.bind(this),this.year=a.getYear(this.middle),this.month=a.getMonth(this.middle),this.day=a.getDay(this.middle)}static fromISO(e){e=o.toS(e).trim();const t=u.exec(e);if(null==t)return;const n=i.ExifDateTime.fromISO(t[1]),r=i.ExifDateTime.fromISO(t[2]),a=s.toInt(t[3]),l=s.toInt(t[4]);return this.for(n,r,a,l)}static for(e,t,n=0,i=1){if(!a.validDate(e)||!a.validDate(t))return;const o=a.toExifDateTime(e),u=a.toExifDateTime(t);if(null==o||null==u)return;i=s.clamp(1,1e3,s.toInt(i,{defaultValue:1})),n=s.clamp(0,i-1,s.toInt(n,{defaultValue:0}));const c=r.map(o.toDateTime().until(u.toDateTime()).divideEqually(i+1)[n],e=>e.end);return null!=c?new l(o,a.toExifDateTime(c,r.orElse(o.zone,u.zone)),u,n,i):void 0}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return r.orElse(this.start.zone,this.end.zone)}get hasTimes(){return a.hasTime(this.start)&&a.hasTime(this.end)}toString(e=!0){return`${a.datedToISO(this.start,e)}/${a.datedToISO(this.end,e)}`+(0===this.index&&1===this.splits?"":`/${this.index}/${this.splits}`)}includes(e){if(null==e)return!1;const t=a.toExifDateTime(e);return null!=t?this.interval().contains(t.toDateTime()):this.year===a.getYear(e)&&this.month===a.getMonth(e)&&this.day===a.getDay(e)}}t.DateInterval=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(13);let r=!1;function s(){r||(r=!0,i.emitPause())}function o(){r&&(r=!1,i.emitResume())}t.isPaused=function(){return r},t.pause=s,t.resume=o,i.onResume(()=>o()),i.onPause(()=>s())},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(82),s=n(62),o=n(6),a=n(2),u=n(0),l=n(8),c=n(20),d=n(163),h=n(90),f=n(29),p=n(4),m=n(54),g=n(11),y=n(9),v=n(32),b=n(47),w=n(99),S=n(130),M=n(119),P=a.lazy(()=>p.mkLogger("ImgCache"));function E(){return i(this,void 0,void 0,(function*(){const e=yield x();if(null==e||(yield e.isNotDirectory())&&(yield e.clear().isNotDirectory()))throw new Error("Cannot mkdir "+g.Settings.cacheDir.valueOrDefault+c.FatalErrorFlag);return e}))}t.imgCacheDir=E;const x=a.lazy(()=>i(void 0,void 0,void 0,(function*(){return l.thenMap(f.PosixFile.for(g.Settings.cacheDir.valueOrDefault).mkdirp(),e=>e.mkNoMedia())})),o.minuteMs);function _(e,t,n){return i(this,void 0,void 0,(function*(){const i=yield e.stat();if(null==i)throw new Error(`tmpImgFile(${e}): unreadable`);const r=yield E(),s=yield d.readFileType(e.nativePath);if(null==s)throw new Error("Cannot read filetype for "+e);const o=h.stringSha(JSON.stringify({basename:e.base.toLowerCase(),mimetype:s.mime,size:i.size})),a=m.GeoRadix.encodeBuffer(o).slice(0,24);n=y.ensurePrefix(n,".");const u=r.join(...y.splitEvery(a.slice(0,24),2,3),t+n);if(null==(yield u.parent().mkdirp()))throw new Error("Cannot make dest dir, "+u.parent());return P().info("tmpImgFile("+e.baseWithGrandparent+")",{desc:t,ext:n,result:u}),u}))}function F(e,t,n,r){return i(this,void 0,void 0,(function*(){try{return yield l.thenMap(_(e,t,n),e=>e.applyIfEmpty(r))}catch(t){throw P().warn("readableToFile("+e+"): "+t),t}}))}t.emptyImgCacheDir=function(){return i(this,void 0,void 0,(function*(){return l.thenMap(E(),e=>i(this,void 0,void 0,(function*(){return yield r.remove(e.nativePath),x.clear()})))}))},t.cachedImgFile=_,t.readableToFile=function(e,t,n,r){return i(this,void 0,void 0,(function*(){try{return yield l.thenMap(_(e,t,n),e=>e.applyIfEmpty(e=>i(this,void 0,void 0,(function*(){return l.thenMap(r(),t=>e.writeStream(t))}))))}catch(t){throw P().warn("readableToFile("+e+"): "+t),t}}))},t.withImgCache=F,t.prepFileForBrowser=function(e,t){return i(this,void 0,void 0,(function*(){if(yield e.notExists())return;const n=yield v.readRawTags(e,!0),r=null==n?void 0:n.MIMEType,o=u.orElse(w.extractRotation(n),0),a=u.map(n,e=>S.extractSizeInfo(e,o)),c=u.orElse(null==a?void 0:a.dimensions,t);if(null==c)return void P().warn("prepFileForBrowser(): no file dimensions",{file:e,si:a,info:t});const d={width:c.width-32,height:c.height-32};return b.isMimetypeSupported(r,t.userAgent)&&0==o?e:(P().info("prepFileForBrowser(): non-browser-supported mimetype",{file:e,mt:r,info:t}),F(e,"web-"+o,".jpg",t=>i(this,void 0,void 0,(function*(){return l.thenMap(M.sharpReadable(e,d),e=>i(this,void 0,void 0,(function*(){return s(e.nativePath).rotate(o).toFile(t.nativePath)})))}))))}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(0),o=n(8);t.True=()=>!0,t.not=function(e){return t=>!e(t)},t.and=function(...e){return t=>{for(const n of e)if(!n(t))return!1;return!0}},t.or=function(...e){return t=>{for(const n of e)if(n(t))return!0;return!1}},t.all=function(e,t){for(const n of e)if(!t(n))return!1;return!0},t.some=function(e,t){for(const n of e)if(t(n))return!0;return!1},t.none=function(e,t){for(const n of e)if(t(n))return!1;return!0},t.find=function(e,t){for(const n of e)if(t(n))return n},t.filter=function(e,t){return i(this,void 0,void 0,(function*(){return null==e||null==t?s.mapOr(e,r.compact,()=>[]):o.asyncFilter(e,t)}))},t.apply=function(e,t){return i(this,void 0,void 0,(function*(){return null==e||null==t||(yield t(e))?e:void 0}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6),s=n(0),o=n(5),a=n(8),u=n(66),l=n(23),c=n(113),d=n(4),h=n(196),f=n(14),p=n(11),m=n(9),g=n(274),y=n(197),v=n(32),b=n(99),w=n(130),S=n(188),M=n(100),P=n(125),E=n(245),x=n(122),_=n(73),F=n(202);function T(e,t,n){return Math.min(e,s.orElse(n,60)*s.orElse(t,500))}t.MaxBitrateKbps=18e3,t.bitrateKps=e=>o.sigFigs(h.lerp2d({x:76800,y:800},{x:8294400,y:t.MaxBitrateKbps},e),2),t.extractVideoFrame=function(e,t,n){var r;return i(this,void 0,void 0,(function*(){if(!_.isVideoMimeType(t))return;const o=!l.isTrue(null==n?void 0:n.useVlc)&&l.isTrue(yield a.thenOrElse(null==n?void 0:n.useFfmpeg,()=>S.isFFmpegSupported())),u=!o&&l.isTrue(yield a.thenOrElse(null==n?void 0:n.useVlc,()=>F.isVlcSupported()));if(!o&&!u)return;const c=d.mkLogger("img/Video.extractVideoFrame("+e+")"),h=yield P.cachedImgFile(e,"frame",".jpg");c.debug("extractVideoFrame",{dest:h.nativePath,mimetype:t});const f=yield e.mtimeMs();if(null==f)return c.throw("null mtime");const m=yield v.readRawTags(e);if(null==m)return c.throw("no tags");const g=b.extractRotation(m);c.debug("video orientation:"+g);const x=null===(r=w.extractSizeInfo(m,g))||void 0===r?void 0:r.dimensions,T=yield h.stat(),O=yield s.map(T,()=>M.sharpDimensions(h));if(null!=T&&T.mtimeMs>f&&null!=O&&(null==x||O.height===x.height&&O.width===x.width))return c.debug("prior dest, "+h+" seems reasonable",{srcDim:x,destDim:O}),h;const A=y.extractDurationSec(m),k=Math.min(null!=A?A:0,p.Settings.videoFrameAtSec.valueOrDefault);return c.info("extracted metadata",{startAtSec:k,duration:A}),yield h.applyWip(t=>i(this,void 0,void 0,(function*(){const n=Object.assign({src:e,dest:t,startAtSec:k},x);yield o?S.ffmpegFrame(n):F.vlcFrame(n),yield v.deleteAllTags(t),u&&null!=g&&0!==g&&(c.info("rotating in place..."+t,{rot:g}),yield E.rotateInPlace(t,g))}))),h}))},t.isVideoTranscodingSupported=function(){return i(this,void 0,void 0,(function*(){return p.Settings.transcodeVideos.valueOrDefault&&((yield S.isFFmpegSupported())||(yield F.isVlcSupported()))}))},t.transcode=function(e,n){return i(this,void 0,void 0,(function*(){const a=d.mkLogger("img/Video.transcode("+e+")");if(!p.Settings.transcodeVideos.valueOrDefault)return void a.debug("not transcoding (transcodeVideos is false)");const l=yield S.isFFmpegSupported(),h=!l&&(yield F.isVlcSupported());if(!l&&!h)return void a.debug("not transcoding (neither FFmpeg nor VLC are available)");const b=yield e.size();if(!o.gt0(b))throw new Error("transcode(): cannot read "+e);const w=yield v.readRawTags(e);if(null==w)throw new Error("Cannot transcode files that exiftool can't read");const M=w.MIMEType;if(!_.isVideoMimeType(M))return void a.debug("not transcoding (unsupported mimetype)",{mimetype:M});const P=p.Settings.doNotTranscodeMimetypes.values;if(!m.includesIgnoreCase(P,M))return u.time("Video.transcode()",()=>i(this,void 0,void 0,(function*(){const a=s.orElse(y.extractDurationSec(w),60),u=x.transcodeTimeout({bytes:b,durationMs:a*r.secondMs,ext:e.ext}),h=Object.assign({src:e,timeoutMs:u},function(e,n){const i=d.mkLogger("img/Video.dim("+e+")"),r=p.Settings.minVideoDimension.valueOrDefault,a=n.ImageWidth;if(null!=a&&!f.gte(a,r))return i.throw("invalid width: "+a);const u=n.ImageHeight;if(null!=u&&!f.gte(u,r))return i.throw("invalid height: "+u);const l=s.orElse(g.extractBitrateKbps(n),t.MaxBitrateKbps),c=f.mapGt0(a,e=>f.mapGt0(u,n=>o.clamp(0,l,t.bitrateKps(e*n)))),h={width:a,height:u,videoBitrateKbps:c};return i.debug("dim()",{src:e,result:h}),h}(e,w)),m=T(b,h.videoBitrateKbps,a),v=m/3,M=t=>i(this,void 0,void 0,(function*(){const r=Date.now(),o=new c.PullProgressObserver({path:e.nativePath,op:"Transcoding video"},m,()=>i(this,void 0,void 0,(function*(){const e=s.orElse(yield n.clear().size(),0),t=(Date.now()-r)/u*m;return Math.max(e,t)})));h.dest=t;const a=yield o.observe(l?S.ffmpegTranscode(h):F.vlcTranscode(h));if(0!==a.code)throw new Error("transcode failed with code "+a.code)}));return n.applyIfEmpty(e=>M(e),v)})));a.debug('not transcoding (mimetype is in "do not transcode")',{mimetype:M,doNotTranscodeMimetypes:P})}))},t.guessExpectedSize=T,t.validVideo=function(e){return i(this,void 0,void 0,(function*(){return(yield S.isFFmpegSupported())?S.ffmpegValidVideo(e):void 0}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(80),s=n(5),o=n(7),a=n(14);t.tmegapixels=function(e){return null!=e.dimensions?r.dmegapixels(e.dimensions):s.gt0(e.Megapixels)?e.Megapixels:void 0},t.ltBoth=function(e,t){return a.lt(e.width,t.width)&&a.lt(e.height,t.height)},t.ltEither=function(e,t){return a.lt(e.width,t.width)||a.lt(e.height,t.height)},t.parseDimensions=function(e){const t=i.compact(o.toS(e).split(/[xÃ]/).map(e=>s.toInt(e)));return 2==t.length?{width:t[0],height:t[1]}:void 0}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(79),s=n(1),o=n(6),a=n(2),u=n(0),l=n(19),c=n(7),d=n(12),h=n(8),f=n(21),p=n(42),m=n(22),g=n(179);function y(e){return c.toS(e).toLowerCase().startsWith("tags")}t.capturedAtSrcFromTags=y;class v{constructor(e,t,n,i,r){this.file=e,this.date=t,this.src=n,this.mtime=i,this.precisionMs=r,this.toISOString=a.lazy(()=>p.datedToISO(this.date))}spread(e){const t=Object.assign(Object.assign({},this),e);return new v(t.file,t.date,t.src,t.mtime)}toLocal(){return f.isoToLocal(this.toISOString())}toOffset(){return p.datedToOffsetMinutes(this.date)}get isFromTags(){return y(this.src)}toPrecisionMs(){return u.orElse(this.precisionMs,()=>p.datedToPrecisionMs(this.date))}toString(){return JSON.stringify({file:this.file.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return p.hasZone(this.date)}hasTime(){return p.hasTime(this.date)}}function b(e,t){return i(this,void 0,void 0,(function*(){if(!p.validDate(t))return;if(p.hasZone(t))return t;const n=yield g.nearestSiblingTzOffset(e);if(null!=n){const e=p.toExifDateTime(t,n);if(p.validDate(e))return e}return t}))}function w(e){return u.map(e,e=>d.first(["SubSecDateTimeOriginal","DateTimeOriginal","SubSecCreateDate","CreateDate","SubSecMediaCreateDate","MediaCreateDate","OriginalCreateDateTime","DateTimeCreated","DateTimeUTC","GPSDateTime"],t=>p.mapValidDate(e[t],e=>({date:e,src:t}))))}t.CapturedAt=v,t.bestCapturedAt=function(e){return i(this,void 0,void 0,(function*(){const t=s.sortBy(e,e=>-e.mtime.getTime());return m.firstThunk(()=>t.find(e=>e.src.startsWith("tags")),()=>t.find(e=>e.src.startsWith("bname+stat")),()=>t.find(e=>e.src.startsWith("bname")),()=>t.find(e=>e.src.startsWith("siblings")),()=>t.find(e=>e.src.startsWith("path")),()=>e[0])}))},t.capturedAtTags=function(e){return e=s.sortBy(l.toA(e),e=>-e.mtime),d.firstNonEmptyThunk(()=>e.filter(e=>e.src.startsWith("tags")),()=>e.filter(e=>e.src.startsWith("bname+stat")),()=>e.filter(e=>e.src.startsWith("bname")),()=>e.filter(e=>e.src.startsWith("siblings")),()=>e.filter(e=>e.src.startsWith("path")),()=>e.filter(e=>e.src.startsWith("stat")).slice(1,1),()=>[])},t.hasSubSecCapturedAt=function(e){return null!=e&&d.anyDefined([e.SubSecTime,e.SubSecTimeDigitized,e.SubSecTimeOriginal,e.SubSecCreateDate,e.SubSecDateTimeOriginal])},t.addTzFromSibs=b,t.extractCapturedAt=function(e,t,n){return i(this,void 0,void 0,(function*(){const a=yield e.mtime(),l=(o,u)=>i(this,void 0,void 0,(function*(){return h.thenMap(u,u=>h.thenMap(function(e,t,n,s){return i(this,void 0,void 0,(function*(){const i=yield n;if(p.validDate(i))return p.hasZone(i)?i:null!=t&&null!=t.tz&&r.Info.isValidIANAZone(t.tz)?p.setZone(i,t.tz):s?i:b(e,i)}))}(e,t,u.date,n),t=>new v(e,t,s.compactBlanks([o,u.src]).join(":"),a,u.precisionMs)))}));return h.firstDefinedPromise([()=>l("tags",w(t)),()=>l("bname+stat",g.extractStatname(e)),()=>n?void 0:l("siblings",g.inferCapturedAtFromSiblings(e)),()=>n?void 0:l("bname",u.map(p.parseDated(g.bname(e)),e=>({date:e,src:"",precisionMs:d.max([p.datedToPrecisionMs(e),o.secondMs])}))),()=>n?void 0:l("path",u.map(p.extractDateFromPath(e.pathnamesWithoutDrive),e=>({src:"",date:e}))),()=>l("stat",h.thenMap(e.minStatDate(),e=>({src:"",date:e})))])}))},t.capturedAtFromTags=w},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(80),r=n(2),s=n(5),o=n(12),a=n(4),u=r.lazy(()=>a.mkLogger("SizeInfo"));t.extractSizeInfo=function(e,t,n){const r=o.first([null==n?void 0:n.ImageSize,{width:e.SonyImageWidth,height:e.SonyImageHeight},{width:e.ImageWidth,height:e.ImageHeight}],e=>i.isDimensions(e)?e:void 0);if(u().debug("extractSizeInfo()",{filename:e.FileName,mimetype:e.MIMEType,rawInfo:n,fileDimensions:r}),null==r)return;const a=i.maybeFlip(r,t),l=s.sigFigs(a.width/a.height,5);return{ImageHeight:a.height,ImageWidth:a.width,aspectRatio:l,dimensions:a,rotation:t,fileDimensions:r}}},function(e,t){e.exports=require("semver")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(227),s=n(116),o=n(1),a=n(3),u=n(6),l=n(2),c=n(0),d=n(10),h=n(7),f=n(78),p=n(12),m=n(77),g=n(8),y=n(23),v=n(13),b=n(4),w=n(156),S=n(9),M=n(86),P=n(31),E=n(90),x=n(27),_=n(29),F=l.lazy(()=>b.mkLogger("FileURI")),T=["http:","https:","file:",f.PS_LOCAL_FILE_PROTOCOL,f.PS_NETWORK_FILESYSTEM_PROTOCOL].map(e=>e+"//");function O(e,t){try{return null!=e&&null!=t&&(e==t||decodeURI(h.toS(e)).normalize()==decodeURI(h.toS(t)).normalize())}catch(e){return!1}}function A(e,n,s=!0){return i(this,void 0,void 0,(function*(){const i=encodeURI(n.posixPathFrom(_.PosixFile.for(e.mountpoint)));return a.notBlank(e.uuid)?{protocol:f.PS_LOCAL_FILE_PROTOCOL,hostname:t.volsha(e.uuid),pathname:i,slashes:!0,volume:e}:y.isTrue(e.remote)&&a.notBlank(e.remoteHost)&&a.notBlank(e.remoteShare)?{protocol:f.PS_NETWORK_FILESYSTEM_PROTOCOL,hostname:r.toASCII(s?yield w.friendlyname(e.remoteHost):e.remoteHost),pathname:r.toASCII(e.remoteShare)+(a.blank(i)?i:"/"+i),slashes:!0,volume:e}:void 0}))}t.isUri=function(e){const t=h.toS(e).toLowerCase();return T.some(e=>t.startsWith(e))},t.FileToFileUri=e=>{if(null==e||a.blank(e.posixPath))return;const t=h.toS(e.hostname),n={pathname:encodeURI(S.stripPrefix(e.posixPath,"//"+t)),protocol:"file:",slashes:!0};return a.notBlank(t)&&(n.hostname=r.toASCII(t)),n},t.volsha=m.memoize(e=>d.tap(a.mapNotBlank(e,E.shortStringSha),t=>F().debug("volsha",{uuid:e,ea:t})),1*u.hourMs,128),v.onClearCache(()=>t.volsha.clear()),t.uriEqlSync=O,t.uriEql=function(e,t){return i(this,void 0,void 0,(function*(){if(null==e||null==t)return!1;if(O(e,t))return!0;const n=yield _.PosixFile.forUri(e);return null!=n&&n.eql(yield _.PosixFile.forUri(t))}))},t.volumeURI=A,t.FileToPsUri=e=>{const t=_.PosixFile.for(x.posix2native(e.posixPath));return g.thenMap(M.volumeFor(t.nativePath),e=>A(e,t))};const k=[t.FileToPsUri,t.FileToFileUri];function D(e){return i(this,void 0,void 0,(function*(){if(null!=e&&!a.blank(e.posixPath))return p.firstAsync(k,t=>t(e)).catch(t=>{F().warn("file2voluri failed",{file:e,err:t})})}))}t.addUriFormatter=function(e){k.unshift(e),p.uniqInPlace(k)},t.file2fileuri=function(e){return s.format(t.FileToFileUri(e))},t.nativePath2uriString=function(e){return g.thenMap(D({posixPath:x.native2posix(e)}),s.format)},t.file2voluri=D,t.uriToString=function(e){if(null==e||"string"==typeof e)return e;try{return s.format(e)}catch(t){return void F().warn("toString failed",{uri:e,err:t})}};const C=/^[a-z]+:\/\/([a-z0-9-\.]+?)(?:\/(.+)?)?$/i;t.PsfileUriToFile=(e,n)=>i(void 0,void 0,void 0,(function*(){if(null==e||a.blank(n))return;if(!S.equalsIgnoreCase(e.protocol,f.PS_LOCAL_FILE_PROTOCOL))return;const i=yield M.volumes();if(o.isEmpty(i))return void F().warn("PsfileUriToFile(): volumes() was empty: Can't resolve "+n);const r=n.match(C);if(null==r)return void F().warn("PsfileUriToFile(): didn't match regex",{raw:n});const s=r[1];if(a.blank(s))return void F().warn("PsfileUriToFile(): no volsha",{raw:n});const u=S.stripSuffix(decodeURI(h.toS(r[2])),"/").split("/"),l=i.find(e=>!e.remote&&a.notBlank(e.uuid)&&s===t.volsha(e.uuid));if(null!=l)return{posixPath:P.BaseFile.for(l.mountpoint).join(...u).posixPath};{const e=i.filter(e=>null!=e.uuid).map(e=>t.volsha(e.uuid));F().warn("PsfileUriToFile(): no volume had matching volsha",{raw:n,volid:s,volshas:e})}})),t.PsnetUriToFile=e=>i(void 0,void 0,void 0,(function*(){if(null==e)return;if(!S.equalsIgnoreCase(e.protocol,f.PS_NETWORK_FILESYSTEM_PROTOCOL))return;if(a.blank(e.pathname)||a.blank(e.hostname))return;const t=r.toUnicode(h.toS(e.hostname)),n=S.stripPrefix(h.toS(e.pathname),"/").split("/"),i=r.toUnicode(n.shift());if(a.blank(i))return;const s=n.map(decodeURIComponent);return g.thenMap(M.remoteVolumeFor(t,i),e=>({posixPath:P.BaseFile.for(e.mountpoint).join(...s).posixPath}))})),t.FileUriToFile=e=>{if(null==e)return;if(!S.equalsIgnoreCase(e.protocol,"file:")||a.blank(e.pathname))return;const t=decodeURI(h.toS(e.hostname)),n=decodeURI(h.toS(e.pathname));return a.notBlank(t)?{hostname:t,posixPath:n}:{posixPath:null!=n.match(/^\/[A-Z]:\//i)?n.substring(1):n}};const I=[t.PsfileUriToFile,t.PsnetUriToFile,t.FileUriToFile];function L(e){if(null!=e){if("string"!=typeof e&&[e.protocol,e.pathname,e.hostname].every(a.notBlank))return e;try{return s.parse(h.toS(e),!0)}catch(t){return void F().warn("toUrl failed",{uri:e,err:t})}}}t.addUriParser=function(e){I.unshift(e),p.uniqInPlace(I)},t.uri2file=function(e,t){return i(this,void 0,void 0,(function*(){if(a.blank(e))return;const n=function(e){try{return s.parse(e,!1,!0)}catch(t){return void F().warn("bad URI",{uri:e,err:t})}}(e);return null!=n?p.firstAsync(I,t=>t(n,e)).catch(i=>{if(F().warn("uri2file failed",{uri:e,err:i}),a.notBlank(t)&&null!=n.pathname){const e=n.pathname.split("/").slice(1);return{posixPath:_.PosixFile.for(t).join(...e).posixPath}}}):void 0}))},t.uri2protocol=function(e){return c.map(L(e),e=>c.denull(e.protocol))},t.toUrl=L},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(10),s=n(49),o=n(12),a=n(60),u=n(9),l=n(126);class c{constructor(e){this.apply=e}static lift(e){return new c(e)}static and(...e){return new c(t=>i(this,void 0,void 0,(function*(){for(const n of e){const e=yield n.apply(t);if(!e)return e}return!0})))}static or(...e){return new c(t=>i(this,void 0,void 0,(function*(){for(const n of e){const e=yield n.apply(t);if(e)return e}return!1})))}static andLogged(e,...t){return this.and(...o.flatMap(t,t=>r.entries(t).map(([t,n])=>n.asAsync().logged(e,t))))}static orLogged(e,...t){return this.or(...o.flatMap(t,t=>r.entries(t).map(([t,n])=>n.asAsync().logged(e,t))))}static andExplain(e,t){return i(this,void 0,void 0,(function*(){const n=[],i=[];for(const s of t)for(const[t,o]of r.entries(s))((yield o.apply(e))?n:i).push(t);return{accepted:n,rejected:i}}))}asAsync(){return this}and(...e){return c.and(this,...e)}not(){return c.lift(e=>this.apply(e).then(e=>!e))}or(e){return new c(t=>i(this,void 0,void 0,(function*(){return(yield this.apply(t))||(yield e.apply(t))})))}filter(e){return i(this,void 0,void 0,(function*(){return l.filter(e,e=>this.apply(e))}))}logged(e,t){return new c(n=>s.thenTap(this.apply(n),i=>{e.log(i?"debug":"info",[a.darkGrey(t),i?a.green("ACCEPT"):a.red("REJECT"),u.ellipsize(n)].join(" "))}))}}t.AsyncFilter=c},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(44),s=n(2),o=n(0),a=n(277),u=n(20),l=n(16),c=n(9),d=n(31),h=n(114);function f(...e){return i(this,void 0,void 0,(function*(){l.isWin&&e.push(c.ensureSuffix(e.pop(),".exe"));const t=e[e.length-1],n=o.map(h.ProjectPath.Tools(),e=>d.BaseFile.for(e));if(l.isElectron&&(null==n||(yield n.isNotDirectory())))throw new Error("Cannot find project path for tools"+u.FatalErrorFlag);function s(t){return n.join(l.platformName+"-"+t,...e)}function f(e){return i(this,void 0,void 0,(function*(){return null!=e&&(yield e.exists())?e.nativePath:void 0}))}return a.firstDefinedLater(()=>f(s(r.arch())),()=>"x64"===r.arch()?f(s("ia32")):void 0,()=>i(this,void 0,void 0,(function*(){return l.isElectron?void 0:t})),()=>{throw new Error("Cannot find path to tool "+e)})}))}t.pathToTool=f,t.dcrawNativePath=s.lazy(()=>f("dcraw","dcraw")),t.jpegtranNativePath=s.lazy(()=>f("jpegtran","jpegtran")),t.sqliteNativePath=s.lazy(()=>f("sqlite3","sqlite3"))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(5),s=n(7),o=n(12),a=n(159),u=n(204),l=n(9),c=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],d=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];function h(e){return i.map(s.toS(e).match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),e=>[e[1],e[2],e[3]].map(e=>parseInt(e,16)))}function f(e){return S(y(e))}function p(e){return m(P(M(e)))}function m(e){return[e[0],e[1],e[2]].map(e=>r.clamp(0,255,e))}function g(e){return[r.clamp(0,100,e[0]),r.clamp(-100,100,e[1]),r.clamp(-108,100,e[2])]}function y(e){const t=m(e).map(e=>e/255).map(e=>e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92);return u.matXvec(c,t)}t.rgbhex2triplet=h,t.rgbhex2Lab=function(e){return i.map(h(e),f)},t.rgbhex2Labhash=function(e,t){return i.map(h(e),e=>E(f(e),t))},t.lab2rgbhex=function(e){return"#"+p(e).map(e=>l.leftPad(e.toString(16),2,"0")).join("")},t.rgb2labs=function(e){const t=[];for(let n=0;n<e.length;n+=3)t.push(...f([e[n],e[n+1],e[n+2]]));return t},t.rgb2lab=f,t.lab2rgb=p,t.clampRGB=m,t.clampLab=g,t.rgb2xyz=y;const v=.95047,b=1,w=1.08883;function S(e){const[t,n,i]=u.vecXvec(e,[1/v,1/b,1/w]).map(e=>e>216/24389?Math.pow(e,1/3):(24389/27*e+16)/116);return[116*n-16,500*(t-n),200*(n-i)]}function M(e){const[t,n,i]=g(e),r=(t+16)/116,s=n/500+r,o=r-i/200,a=s*s*s,u=o*o*o,l=a>216/24389?a:(116*s-16)/(24389/27),c=t>8?Math.pow(r,3):t/(24389/27);return[l*v,c*b,(u>216/24389?u:(116*o-16)/(24389/27))*w]}function P(e){return u.matXvec(d,e).map(e=>{const t=e<0?-1:1,n=e*t;return r.round(255*t*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055))})}function E(e,t){return a.bitZip({dims:[{value:e[0],min:0,max:100},{value:e[1],min:-80,max:80},{value:e[2],min:-80,max:80}],bitDepth:t})}function x(e,t){const[n,i,s]=e,[o,a,u]=t,l=n-o,c=i-a,d=s-u,h=Math.sqrt(Math.pow(i,2)+Math.pow(s,2)),f=h-Math.sqrt(Math.pow(a,2)+Math.pow(u,2)),p=(m=Math.sqrt(Math.pow(c,2)+Math.pow(d,2)-Math.pow(f,2)),r.isNumber(m)?m:0);var m;const g=1+.045*h,y=1+.015*h;return Math.sqrt(Math.pow(l,2)+Math.pow(f/g,2)+Math.pow(p/y,2))}t.xyz2lab=S,t.lab2xyz=M,t.xyz2rgb=P,t.labhash=E,t.unlabhash=function(e,t){return a.bitUnzip(e,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:t})},t.diffCIE76=function(e,t){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))},t.diffCIE94=x,t.diffCIE94rgb=function(e,t){return x(f(e),f(t))},t.closestLab=function(e,t){return o.leastBy(e,e=>x(e,t))},t.MinCie=2,t.MaxCie=50,t.diffCIE94Corr=function(e,n){return null==e||null==n?1:r.clamp(0,t.MaxCie,x(e,n)-t.MinCie)/t.MaxCie},t.rgbhex2hsv=function(e){let t,n,i,r=0,s=0;const[o,a,u]=h(e).map(e=>e/255),l=Math.max(o,a,u),c=l-Math.min(o,a,u),d=e=>(l-e)/6/c+.5;return 0!==c&&(s=c/l,t=d(o),n=d(a),i=d(u),o===l?r=i-n:a===l?r=1/3+t-i:u===l&&(r=2/3+n-t),r<0?r+=1:r>1&&(r-=1)),[360*r,100*s,100*l]}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(34),s=n(3),o=n(6),a=n(2),u=n(5),l=n(8),c=n(23),d=n(53),h=n(21),f=n(13),p=n(4),m=n(31),g=n(144),y=n(27),v=/^\.?NoMedia$/i;function b(e){return null!=v.exec(e)}t.isNoMediaName=b,f.onClearCache(()=>S.clear()),f.onFileChanged(e=>{if(s.blank(e))S.clear();else for(const t of S.keys())t.startsWith(e)&&S.delete(t)});const w=15*o.secondMs,S=new d.BoundedMap(3*o.minuteMs,2e3,!1),M=a.lazy(()=>p.mkLogger("hasNoMedia()"));t.hasNoMedia=function e(t){return i(this,void 0,void 0,(function*(){if(g.pathIsNeverIgnored(t.nativePath))return M().debug(t+" is never ignoed"),!1;if(t instanceof m.BaseFile)return e(yield t.directoryEntry());if(b(t.base))return M().debug(t+" basename is NoMedia"),!0;const n=y.pathnames(t.nativePath);if(n.some(b))return M().debug(t+" parent path is NoMedia"),!0;for(let e=n.length-1;e>0;e--){const i=n.slice(0,e).join(r.sep),s=S.get(i);if(!0===s)return M().debug(t+" ancestor is NoMedia, "+i),!0;if(!1!==s&&(u.isNumber(s)&&(yield l.until(()=>c.isBoolean(S.get(i)),w))&&!0===S.get(i)))return M().debug(t+" ancestor is NoMedia, "+i),!0}const i=S.get(t.nativePath);if(c.isBoolean(i))return M().debug(t+" returning cached result, "+i),i;const s=yield t.isDirectory();if(s){if(null!=i&&h.isRecentMs(i,w)&&(M().debug(t+" is a work-in-progress. Waiting for prior result."),yield l.until(()=>c.isBoolean(S.get(t.nativePath)),w)))return e(t);const n=Date.now();S.set(t.nativePath,n);const r=yield t.children();if(null==r)return M().debug(t+" is a directory but has no children.",{result:!1}),S.set(t.nativePath,!1),!1;if(r.some(e=>b(e.base)))return M().debug(t+" is a directory and has a noMedia child",{result:!0}),S.set(t.nativePath,!0),!0}const o=yield t.parent();if(null==o||t.nativePath===o.nativePath)return M().debug(t+" root",{result:!1}),S.set(t.nativePath,!1),!1;{const n=yield e(o);return s&&S.set(t.nativePath,n),M().debug(t+" from parent",{result:n}),n}}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileVersion=9,t.AssetVersion=2},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(54);let r=0;t.ProcessUid=i.GeoRadix.randomChars(15),t.uid=function(){return t.ProcessUid+"-"+i.GeoRadix.encode(++r)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(34),r=n(18),s=n(1),o=n(3),a=n(0),u=n(5),l=n(15),c=n(37),d=n(46),h=n(19),f=n(7),p=n(23),m=n(57),g=n(26);t.envAtStartup=l.Opt(Object.assign({},r.env)).map(e=>g.isProd?Object.freeze(e):e).get(),t.SettingCategories=c.strEnum("System","Logging","Updates","Tools","Web","Db","Sync","Previews","Tagging","Filters","Reporting"),t.LibraryCategories=Object.freeze([t.SettingCategories.Filters,t.SettingCategories.Db,t.SettingCategories.Sync,t.SettingCategories.Previews,t.SettingCategories.Tagging,t.SettingCategories.Reporting,t.SettingCategories.Web]),t.SystemCategories=Object.freeze(t.SettingCategories.values.filter(e=>!t.LibraryCategories.includes(e)));class y{constructor(e){this.opts=e,this._persist=!1,this.listeners=[],this.importFromEnv()}hasValue(){return null!=this._value}readFromEnv(e){return l.Opt(e).orElse(()=>r.env).flatMap(e=>e[this.opts.key]).filter(o.notBlank).orElse(()=>l.Opt(this.opts.alternateKeys).map(e=>e.map(e=>r.env[e])).flatMap(e=>e.find(o.notBlank))).flatMap(this.opts.fromEnv).get()}importFromEnv(e=r.env){if(!this._persist)return a.map(this.readFromEnv(e),e=>this.setValue(e))}importFromFile(e){if(!this.hasValue()||this._persist)return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){s.filterInPlace(this.listeners,t=>t===e)}onChange(){const e=this.value;this.listeners.forEach(t=>t(e))}get name(){return this.opts.name}get persist(){return this._persist}get key(){return this.opts.key}get category(){return this.opts.category}get persisted(){return this.opts.persisted}get advanced(){return a.mapOr(this.opts.advanced,()=>this.opts.advanced(),()=>!0)}get value(){return this._value}set tmpValue(e){this._persist=!1,this.addToEnv(r.env,e),this.setValue(e)}set value(e){this._persist=!0,this.setValue(e)}setValue(e){const t=this._value,n=this.opts.toEnv(e),i=this.opts.fromEnv(n);return this._value=i,m.eql(t,this._value)||this.onChange(),this._value}get defaultValue(){return d.tot(this.opts.defaultValue)}get exampleValue(){return l.Opt(this.opts.exampleValue).flatMap(e=>e()).filter(o.notBlank).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return null!=this.value?this.value:this.defaultValue}maybeAddToEnv(e,t){const n=a.orElse(e,r.env);return this.hasValue()&&(n[this.opts.key]=v(this.opts.toEnv(a.orElse(t,this.valueOrDefault)))),n}addToEnv(e,t){const n=a.orElse(e,r.env);return n[this.opts.key]=v(this.opts.toEnv(a.orElse(t,this.valueOrDefault))),n}deleteFromEnv(e){const t=a.orElse(e,r.env);return delete t[this.opts.key],a.map(this.opts.alternateKeys,e=>e.forEach(e=>{delete t[e]})),t}valueToPersist(e){return this._persist?this._value:e}clear(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),this}addToJSON(){return{}}toJSON(){return{key:this.opts.key,value:this.value,defaultValue:this.opts.defaultValue,description:this.opts.description}}}t.Setting=y;const v=e=>o.notBlank(e)&&"undefined"!==e?f.toS(e).trim():void 0;t.MaybeStringSetting=class extends y{constructor(e){super(Object.assign({toEnv:v,fromEnv:v,defaultValue:void 0},e))}hasValue(){return o.notBlank(this.value)}};function b(e,t){const n=f.toS(e).toLowerCase();return t.find(e=>e.toLowerCase()===n)}t.StringSetting=class extends y{constructor(e){super(Object.assign({toEnv:v,fromEnv:v},e))}hasValue(){return o.notBlank(this.value)}};function w(e){return o.mapNotBlank(f.toS(e).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return s.compactBlankish(h.toA(JSON.parse(e)))}catch(e){}for(const t of["Â¦",i.delimiter])if(e.includes(t))return s.compactBlankish(e.split(t));return[e]})}t.StringEnumSetting=class extends y{constructor(e){if(super(Object.assign({toEnv:t=>b(t,e.validValues),fromEnv:t=>b(t,e.validValues)},e)),this.validValues=e.validValues,null!=this.defaultValue&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}},t.splitStringArray=w;t.StringArraySetting=class extends y{constructor(e){super(Object.assign({defaultValue:[],fromEnv:w,toEnv:e=>l.Opt(h.toA(e)).map(s.compactBlanks).map(s.uniq).filter(s.isNotEmpty).map(e=>JSON.stringify(e)).get()},e))}get values(){return s.uniq(s.compactBlanks(this.valueOrDefault))}pushFromEnv(...e){this.tmpValue=s.uniq(s.compactBlanks(this.valueOrDefault.concat(...e)))}removeValueFromEnv(e){a.map(this.value,t=>this.tmpValue=t.filter(t=>t!==e))}};t.StringEnumsSetting=class extends y{constructor(e){super(Object.assign({defaultValue:e.defaultValue,fromEnv:e=>o.mapNotBlank(e,e=>{try{return this.asValidValues(JSON.parse(e))}catch(t){return this.asValidValues(e.split(i.delimiter))}}),toEnv:e=>a.map(e,e=>JSON.stringify(s.uniq(e)))},e)),this.validValues=e.validValues}asValidValues(e){return s.compactBlankish(h.toA(e).map(e=>b(f.toS(e),this.validValues)))}addToJSON(){return{validValues:this.validValues}}};t.IntegerSetting=class extends y{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:v,fromEnv:u.toInt}))}};t.FloatSetting=class extends y{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:v,fromEnv:u.toFloat}))}};t.BoundedIntegerSetting=class extends y{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:v,fromEnv:t=>l.Opt(t).flatMap(parseInt).map(t=>u.clamp(e.min,e.max,t)).get()})),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};t.BooleanSetting=class extends y{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:v,fromEnv:p.toBoolean}))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(10);class r{constructor(e){this.ttlMs=e,this.expireListeners=[],this.delegate=new Map,this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,t=this.ttlMs){return this.delegate.set(e,Date.now()+(t-this.ttlMs)),this}addIfMissing(e,t){const n=this.delegate.get(e);return null==n||n&&this.expired(e,n)?(this.add(e),t()):void 0}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e,t){for(const[t,n]of this.delegate)this.expired(t,n)||e(t,t,this)}has(e){return!this.expired(e,this.delegate.get(e))}values(){const e=this;return function*(){for(const[t,n]of e.delegate.entries())e.expired(t,n)||(yield t)}()}entries(){const e=this;return function*(){for(const[t,n]of e.delegate.entries())e.expired(t,n)||(yield[t,t])}()}toA(){return this.vacuum(),[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}on(e,t){this.expireListeners.push(t)}expired(e,t){return i.tap(null==t||t+this.ttlMs<=Date.now(),n=>{null!=t&&n&&(this.expireListeners.forEach(t=>t(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,t)=>{this.expired(t,e)})}}t.TTLSet=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(30),r=n(1),s=n(7),o=n(60),a=n(26),u=n(11),l=n(142),c=n(106),d=n(115);t.OnlyMessages={formatLogEntry:e=>e.msg,format:(e,t,n,i)=>n};class h{constructor(e={}){this.inspectOptions=Object.assign(Object.assign({},h.defaultInspectOptions()),e),a.isTest&&(this.inspectOptions.breakLength=255)}formatLogEntry(e){const t=c.logFilter().highlight(e.context)?o.yellow:o.blue;return r.compactBlanks([l.dateForLog(e.timestamp),this.inspectOptions.processName(),"debug"==e.level?o.darkGrey("debug"):"info"==e.level?o.cyan("info "):"error"==e.level?o.redBright("error"):"warn"==e.level?o.yellowBright("warn "):e.level,t(e.context),e.msg,(n=e.meta,a=this.inspectOptions,null==n?n:i.inspect(n,a))]).map(e=>s.toS(e)).join(" ");var n,a}format(e,t,n,i){return this.formatLogEntry({timestamp:Date.now(),level:e,context:t,msg:n,meta:i})}}t.ColoredLogFormatter=h,h.defaultInspectOptions=()=>({showHidden:!1,depth:4,compact:!0,colors:u.Settings.logColor.valueOrDefault,customInspect:!0,maxArrayLength:25,processName:d.processName})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(79),r=n(10),s=n(60),o=n(11),a=Date.now();let u=[0,""];t.dateForLog=function(e){return u[0]===e?u[1]:r.tap(o.Settings.logElapsedMs.valueOrDefault?s.yellow(i.Duration.fromMillis(e-a).toFormat("hhhh:mm:ss.SSS")):s.darkGrey(new Date(e).toISOString()),t=>u=[e,t])},t.DefaultLogFlushMs=500},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(29),o=n(61),a=n(11),u="\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n\nMoving or deleting any files here will cause problems using your library.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v"+o.version;function l(e=a.Settings.libraryPath.value){return r.mapNotBlank(e,e=>s.PosixFile.for(e).join(".photostructure"))}t.libraryDataDir=l,t.setupLibraryDataDir=function(e){return i(this,void 0,void 0,(function*(){const t=l(e);if(null==t)throw new Error("empty dataDir");if(null==(yield t.mkdirp()))throw new Error("Could not mkdirp "+t);yield t.mkNoMedia();const n=t.join("README.txt");if((yield n.size())!==u.length&&!(yield n.writeTxt(u)))throw new Error("Could not write README to "+t);return t}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(13),o=n(4),a=n(11),u=n(31),l=r.lazy(()=>o.mkLogger("NeverIgnoredPaths")),c=r.lazy(()=>{a.Settings.neverIgnored.addListener(()=>{d.clear(),s.emitFileChanged(),l().info("Settings.neverIgnored changed",a.Settings.neverIgnored.value)}),a.Settings.scanPaths.addListener(()=>{d.clear(),s.emitFileChanged()}),s.onClearCache(()=>d.clear())}),d=r.lazy(()=>(c(),new Set(i.compactBlanks([...a.Settings.scanPaths.values,...a.Settings.neverIgnored.values]))));function h(e){return d().has(e)||d().has(e.toLowerCase())}t.pathIsNeverIgnored=h,t.neverIgnore=function(...e){a.Settings.neverIgnored.pushFromEnv(...i.compactBlanks(e.map(e=>u.BaseFile.for(e).nativePath)))},t.pathIsNeverIgnoredPredicate=function(e){return h(e)?{pathIsNeverIgnored:()=>!1}:void 0}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),s=n(176),o=n(13),a=n(4),u=n(26),l=n(65),c=n(11),d=n(124),h=n(1),f=n(3),p=n(6),m=n(28),g=n(2),y=n(36),v=n(69),b=n(74),w=n(247);function S(){const e=r.memoryUsage();return e.external+e.heapTotal}function M(){const e=c.Settings.maxMemoryMb.valueOrDefault,t=S(),n=Math.floor(t/y.MB),i=`Memory usage for ${l.serviceName()} (${y.fmtBytes(t,2)}, max: ${y.fmtBytes(e*y.MB,2)})`;return n>e?(a.mkLogger("HealthChecks.memoryCheck()").warn(i),{bad:[i+" is high"]}):{ok:[i+" is OK"]}}t.memoryUsageBytes=S,t.memoryUsageIsHigh=function(){return c.Settings.maxMemoryMb.valueOrDefault<S()/y.MB},t.memoryCheck=M,t.syncSettingsCheck=function(){return u.isTest||c.Settings.scanMyPictures.valueOrDefault||c.Settings.scanAllDrives.valueOrDefault||!h.isEmpty(c.Settings.scanPaths.values)?{}:{warn:["Nothing to scan: scanMyPictures and scanAllDrives are false and scanPaths is empty."]}},t.healthChecks=g.lazy(()=>i(void 0,void 0,void 0,(function*(){if(l.isMainService())return s.fullhc({warn:["main service should override --status()"]});try{return s.concatHealthChecks(yield b.dbRpc()?function(){return i(this,void 0,void 0,(function*(){const e=v.dbClient();return null!=e&&!0===(yield v.dbClientReady())?e.request("healthChecks"):{fail:["RPC client is not connected"]}}))}():w.libraryHealthChecks(),M())}catch(e){return s.fullhc({fail:[f.notBlankOr(m.errorToS(e),"healthChecks failed")]})}})),7*p.secondMs),c.Settings.libraryPath.addListener(()=>t.healthChecks.clear()),o.onSettingsChanged(()=>t.healthChecks.clear()),t.runvalve=function(){return i(this,void 0,void 0,(function*(){if(d.isPaused())return!1;const e=yield t.healthChecks();return null!=e&&h.isNotEmpty(e.ok)&&h.isEmpty(e.fail)&&h.isEmpty(e.warn)}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),s=n(24),o=n(59),a=n(8),u=n(23),l=n(20),c=n(29),d=n(258),h=n(125),f=n(307),p=n(4),m=n(14),g=n(65),y=n(143),v=n(11),b=n(92),w=n(1),S=n(68),M=n(3),P=n(2),E=n(0),x=n(10),_=n(269),F=n(74),T=n(312),O=n(182),A=n(189),k=n(317),D=n(318),C=n(299),I=n(325),L=n(173),R=n(301);t.libraryUID=function(){return i(this,void 0,void 0,(function*(){return b.libraryHasSettings()?E.map(B.instance(),e=>a.thenMap(e.uid(),e=>e.uid)):void 0}))},v.Settings.libraryPath.addListener(()=>B.onLibraryPathChange());class B extends s.EndableWrapper{constructor(e){super(`Library(${e})`,()=>this.onEnd()),this.logger=P.lazy(()=>p.mkLogger(this.name)),this.start=Date.now(),this._ready=new o.Latch,this.setup=P.lazy(()=>i(this,void 0,void 0,(function*(){this.logger().debug("setup()");try{if(yield y.setupLibraryDataDir(this.rootDir),yield b.readLibrarySettings(this.rootDir.nativePath),yield h.imgCacheDir(),g.isDbService()){if(this.logger().info("setup(): on db service, setting up directories and db..."),!b.libraryHasSettings.refresh())return void this.logger().info("Library settings don't exist yet. Skipping db RPC setup.");if(null==(yield this.cacheDir()))throw new Error("Could not create cache dir"+l.FatalErrorFlag);if(null==(yield h.imgCacheDir()))throw new Error("Could not create cache dir"+l.FatalErrorFlag);if(yield S.retryOnReject(()=>this.assertNotOpen(),{maxRetries:5}),null==(yield this.openedBy().write()))throw new Error("Failed to write to opened-by.json"+l.FatalErrorFlag);null==(yield this.modelDbJanitor())&&this.logger().throw("Failed to set up model DB"+l.FatalErrorFlag,{dbrpc:F.dbRpc(),serviceName:g.serviceName(),argv:r.argv}),this.logger().info("Setting up db RPC..."),yield this.dbServer()}A.installLibraryUriSupport(),this._ready.resolve()}catch(e){this._ready.reject(e)}}))),this.openedBy=P.lazy(()=>new C.OpenedByWriter(this.dataDir)),this.uidStore=P.lazy(()=>new d.UIDStore(this.dataDir)),this.uid=P.lazy(()=>this.uidStore().readUid()),this.cacheDir=P.lazy(()=>_.cacheDir()),this.localDbDir=P.lazy(()=>k.localDbDir()),this.previews=P.lazy(()=>new f.Previews(this.dataDir.join("previews"),O.RpcAdvisoryLockProvider)),this.assetFileRepository=P.lazy(()=>new R.AssetFileRepository(this.rootDir,()=>v.Settings.copyAssetsToLibrary.valueOrDefault)),this.modelDbJanitor=P.lazy(()=>i(this,void 0,void 0,(function*(){return F.dbRpc()?void 0:D.ModelDbJanitor.for(this.dataDir,this.localDbDir)}))),this.statsDbJanitor=P.lazy(()=>i(this,void 0,void 0,(function*(){return I.statsDbJanitor(yield this.cacheDir())}))),this.modelDb=()=>a.thenMap(this.modelDbJanitor(),e=>e.db.promise),this.statsDb=()=>a.thenMap(this.statsDbJanitor(),e=>e.db),this.dbServer=P.lazy(()=>i(this,void 0,void 0,(function*(){const e=yield this.modelDb();if(null==e)throw new Error("null model DB");const t=yield T.mkDbServer({db:e});this.logger().info("dbServer(): RPC service serving port "+t.port);const n={};return v.Settings.rpcPort.addToEnv(n),v.Settings.libraryPath.addToEnv(n),L.stdoutWrite(n),t}))),this.rootDir=c.PosixFile.for(e),this.dataDir=y.libraryDataDir(this.rootDir),this.logger().debug("new()")}static libraryPathChanged(){return v.Settings.libraryPath.value!==E.map(this.priorInstance,e=>e.rootDir.nativePath)}static onLibraryPathChange(){this.libraryPathChanged()&&E.map(this.priorInstance,s.end)}static instance(){var e;if(g.isMainService())return void p.mkLogger("Library.instance()").warn("invoked by mainService",l.stack());const t=this.libraryPathChanged(),n=u.isTrue(null===(e=this.priorInstance)||void 0===e?void 0:e.ended);return(t||n)&&(t&&this.onLibraryPathChange(),this.priorInstance=M.mapNotBlank(v.Settings.libraryPath.value,e=>x.tap(new B(e),e=>e.setup()))),this.priorInstance}get isPendingSetup(){return this._ready.pending}assertNotOpen(){return i(this,void 0,void 0,(function*(){const e=yield C.readOpenedBy(this.dataDir);u.isFalse(null==e?void 0:e.pidMatches)&&l.onError(w.compactBlanks(["Library is already open",E.map(e,e=>"on "+e.hostname),m.mapGt0(null==e?void 0:e.pid,e=>"("+e+")")]).join(" ")+l.FatalErrorFlag)}))}get ready(){return this._ready.promise}requiredFiles(){const e=[{desc:"System configuration directory",isDir:!0,file:()=>b.systemSettingsFile().parent()}];return this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library model DB",isDir:!1,file:()=>a.thenMap(this.modelDbJanitor(),e=>e.srcDbFile)},{desc:"Library model DB (local cache)",isDir:!1,file:()=>a.thenMap(this.modelDbJanitor(),e=>e.localDbFile)}),e}onEnd(){return i(this,void 0,void 0,(function*(){for(const e of yield a.thenCompact([this.dbServer.clear(),this.statsDbJanitor.clear(),this.modelDbJanitor.clear()]))yield s.end(e);this.logger().info("onEnd(): finished.")}))}}t.Library=B},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),s=n(4),o=n(140),a=n(6),u=n(2),l=n(83),c=u.lazy(()=>s.mkLogger("Transactions")),d=new o.TTLSet(30*a.secondMs);t.tx=function(e,t,n,s=!1){return i(this,void 0,void 0,(function*(){try{if(d.add(t),e.inTransaction&&(c().warn("ALREADY IN TRANSACTION, I'll wait...",{ctx:t,recent:d.toA()}),yield r.until(()=>!e.inTransaction,15e3,l.randomInt(20,100))),e.inTransaction)throw new Error("UNEXPECTEDLY IN A TRANSACTION YIKES");return e.transaction(()=>n())()}catch(e){throw c().log(s?"debug":"error","tx("+t+") error: "+e),e}}))}},function(e,t,n){"use strict";let i;Object.defineProperty(t,"__esModule",{value:!0}),t.modelDb=()=>i,t.setModelDb=e=>i=e},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(12),r=n(13),s=n(4),o=n(1),a=n(6),u=n(2),l=n(45),c=n(0),d=n(5),h=n(10),f=n(19),p=n(55),m=n(172),g=n(205),y=n(103),v=n(290);t.MaxBatchSize=99,r.onClearCache(()=>f.toA(b.instances.values()).forEach(e=>e.clear()));class b{constructor(e,t){this.model=e,this.db=t,this.dbr=u.lazy(()=>new m.DbRequestLocal(this.db)),this.columnNames=u.lazy(()=>this.db().pragma(`table_info(${this.tableName})`).map(e=>e.name)),this.stmts=new p.TTLMap(30*a.secondMs),this.logger=s.mkLogger("ModelOpsLocal("+e.$ctor+")")}static forTableName(e){return this.instances.get(e)}static forModel(e,t){const n=e;return l.getOrSet(this.instances,n.tableName,()=>new b(n,t))}clear(){this.stmts.clear()}get dbOpen(){return c.mapOr(this.db(),e=>e.open,()=>!1)}get tableName(){return this.model.tableName}toDbValued(e){const t=this.model.fromJSON(e),n=g.toDbValued(t);return h.pick(n,...this.columnNames())}exec(e,t){return this.dbr().exec(e)}run(e){return this.dbr().run(e)}first(e,t){return c.map(this.dbr().first(e),e=>this.model.fromJSON(e))}all(e,t){return this.dbr().all(y.maybeLimit(e)).map(e=>this.model.fromJSON(e))}findOne(e,t){return c.map(this.dbr().first(e.first()),e=>this.model.fromJSON(e))}findOneBy(e,t){return this.findOne(this.model.query().where(e))}findById(e,t){return this.findOneBy({id:e})}findByIds(e,n){const r=f.toA(e),s=o.flatten(i.batches(r,t.MaxBatchSize).map(e=>this.all(this.model.query().where("id","in",f.toA(e)))));return o.sortBy(s,e=>r.indexOf(e.id))}findBy(e,t){return this.all(this.model.queryBy(e))}rows(){return this.count(this.model.query())}count(e,t){return c.orElse(this.dbr().pluckFirst(e),0)}insert(e){const t=this.model.fromJSON(e);if(null!=t.id)throw new Error("insert called for "+JSON.stringify(e));t.$beforeUpsert();const n=t.$toDbJSON(this.columnNames()),i=this.run(this.model.query().insert(n));return this.findById(d.toInt(i.lastInsertRowid))}upsertOne(e,t){return this.upsert([e])[0]}get ucn(){return this.model.uniqueColumnName}upsert(e,n){if(e.length>t.MaxBatchSize)return o.flatten(i.batches(e,t.MaxBatchSize).map(e=>this.upsert(e)));const r=(Array.isArray(e)?e:[e]).map(e=>this.model.fromJSON(e)),s=r.map(e=>e[this.ucn]);r.forEach(e=>e.$beforeUpsert());const a=this.columnNames(),u=r.map(e=>e.$toDbJSON(a)).map(e=>{const t=y.toSqlQuery(v.mkUpsertSql(this.tableName,this.ucn,e));try{return this.stmts.getOrSet(t.sql,()=>this.db().prepare(t.sql)).run(t.bindings)}catch(e){throw this.logger.warn("upsert(): bad SQL",{tableName:this.tableName,sq:t}),e}}),l=s.map((e,t)=>c.orElse(e,u[t].lastInsertRowid)),d=this.all(this.model.query().whereIn(this.ucn,l)),h=o.sortBy(d,e=>s.indexOf(e[this.ucn]));return this.logger.debug("upsert()",{result:h}),h}delete(e,t){return o.mapNotEmpty(e.filter(d.gt0),e=>this.run(this.model.query().delete().whereIn("id",e)))}}t.ModelOpsLocal=b,b.instances=new Map},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(37);t.PriorityClasses=i.strEnum("AboveNormal","Normal","BelowNormal","Idle"),t.NiceLevel=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:11,Idle:19})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(5);class r{constructor(e){if(this.maxLength=e,this._length=0,this._firstIndex=0,e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...i.times(e,()=>null))}mapIndex(e,t){return e<0||e>this._length-1?void 0:t((e+this._firstIndex+this.maxLength)%this.maxLength)}get(e){return this.mapIndex(e,e=>this.store[e])}set(e,t){return this.mapIndex(e,e=>this.store[e]=t)}get length(){return this._length}set length(e){this._length=i.clamp(0,this._length,e)}[Symbol.iterator](){const e=this;return function*(){for(let t=0;t<e.length;t++)yield e.mapIndex(t,t=>e.store[t])}()}push(...e){for(const t of e)this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,e=>{this.store[e]=t});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(const t of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,e=>{this.store[e]=t,this._firstIndex=e});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}every(e){for(let t=0;t<this._length;t++)if(!e(this.get(t),t))return!1;return!0}some(e){for(let t=0;t<this._length;t++)if(e(this.get(t),t))return!0;return!1}forEach(e){for(let t=0;t<this._length;t++)e(this.get(t),t)}map(e){const t=[];for(let n=0;n<this._length;n++)t.push(e(this.get(n),n));return t}reduce(e,t){let n=t;for(let t=0;t<this._length;t++)n=e(n,this.get(t),t);return n}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,t=>{this.mapIndex(this._length-1-e,e=>{const n=this.store[e];this.store[e]=this.store[t],this.store[t]=n})});return this}toA(){return[...this]}slice(e,t){return[...this].slice(e,t)}}t.BoundedList=r},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("stream")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6),s=n(28),o=n(2),a=n(0),u=n(7),l=n(17),c=n(13),d=n(4),h=n(14),f=n(16),p=n(150),m=n(39),g=n(11),y=n(140),v=o.lazy(()=>d.mkLogger("Renice")),b=new y.TTLSet(r.minuteMs);c.onClearCache(()=>b.clear()),t.renice=function(e,t){return i(this,void 0,void 0,(function*(){return b.addIfMissing(e,()=>i(this,void 0,void 0,(function*(){const n=p.PriorityClasses.validOrElse(t,()=>g.Settings.processPriority.valueOrDefault);return h.mapGt0(e,()=>i(this,void 0,void 0,(function*(){try{yield f.isWin?function(e,t){return i(this,void 0,void 0,(function*(){return h.mapGt0(e,n=>p.PriorityClasses.map(t,n=>m.PowerShell.instance().execute(`(Get-Process -Id ${e}).PriorityClass = "${t}"`,e=>e)))}))}(e,n):function(e,t=19){return i(this,void 0,void 0,(function*(){return l.stdoutResult("renice",[t,"-p",e].map(u.toS),{timeout:10*r.secondMs})}))}(e,a.orElse(p.NiceLevel[n],11)),v().info("Renice pid "+e+" to "+n)}catch(t){return void v().warn("Failed to renice pid "+e+": "+s.errorToS(t))}})))})))}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(2),s=n(10),o=n(106),a=n(141),u=n(72);class l{constructor(e,t=[["error",console.error]]){this.logFilter=e,this.formatter=new a.ColoredLogFormatter,this.loggers=s.fromEntries(t)}log(e,t,n,i){(this.loggers[e]||console.log)(this.formatter.format(e,t,n,i))}enabled(e,t){return this.logFilter.enabled(e,t)}flush(){return i(this,void 0,void 0,(function*(){}))}close(){}}t.ConsoleLogger=l,l.instance=r.lazy(()=>new l(o.logFilter())),t.mkConsoleLogger=function(e){return new u.ContextualLogger(e,()=>l.instance())}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(228),s=n(30),o=n(3),a=n(6),u=n(5),l=n(7),c=n(77),d=n(8),h=n(13),f=n(4),p=n(229),m=n(14),g=new RegExp("^"+p.ipv4Re.source+"$");t.friendlyname=c.memoize(e=>i(void 0,void 0,void 0,(function*(){const n=null==g.exec(e)?e:yield t.nslookup(e);return l.toS(n).toLowerCase().normalize()})),10*a.minuteMs,128);const y=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function v(e){return null!=y.exec(e)}function b(e){const t=e.split(".").map(e=>u.toInt(e)).filter(e=>m.within(0,255,e));return 4===t.length?t:void 0}t.isLoopback=v,t.octets=b;const w=s.promisify(r.reverse),S=s.promisify(r.resolve4),M=f.mkLogger("nslookup");t.nslookup=c.memoize(e=>i(void 0,void 0,void 0,(function*(){try{const t=yield d.thenOrTimeout(()=>v(e)?e.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=b(e)?w(e):S(e),10*a.secondMs);if(null==t)return M.info("nslookup("+e+"): timeout"),e;const n=t.find(o.notBlank);return null==n?(M.warn("No name found for "+e),e):n}catch(t){return M.warn("Failed to look up "+e+", using name.",t),e}})),10*a.minuteMs,256),h.onClearCache(()=>t.nslookup.clear())},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(3),o=n(6),a=n(0),u=n(15),l=n(7),c=n(50),d=n(8),h=n(17),f=n(13),p=n(71),m=n(63),g=n(75),y=n(22),v=n(16),b=n(39),w=n(9),S=n(35),M=n(25);t.addRemoteVolumeInfoWin=function(e,t){return i(this,void 0,void 0,(function*(){if(!v.isWin)throw new Error("wtf");return yield d.thenMap(a.orElse(t,()=>O()),t=>{const n=g.toMap(t,e=>[e.mountpoint,e]);e.forEach(e=>{a.map(n.get(e.mountpoint),t=>{e.remote=!0,e.remoteHost=t.host,e.remoteShare=t.share,e.remoteOK=t.ok})})}),e}))};const P=["LocalName","RemoteName","Status"],E=["NETUSE","get",P.join(",")],x=/^\\\\(.+?)\\(.+)$/,_=/^[a-z]:\\?$/i;function F(e){if(!s.blank(e))return u.Opt(e).flatMap(e=>x.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>u.Opt(e).flatMap(e=>y.Try(()=>new URL(e))).filter(e=>s.notBlank(e.hostname)).map(e=>({host:e.hostname,share:u.Opt(e.pathname).filter(s.notBlank).getOrElse(()=>"/")}))).get()}function T(){return i(this,void 0,void 0,(function*(){const e=m.wmic(),t=yield h.stdout(e,E,{timeout:15*o.secondMs}),n=p.parseFixed(P,t);return r.compact(n.map(e=>a.map(x.exec(l.toS(e.RemoteName)),t=>a.map(_.exec(l.toS(e.LocalName)),n=>({mountpoint:w.ensureSuffix(n[0],"\\"),host:t[1],share:t[2],ok:"OK"===e.Status})))))}))}t.NetInfoCmd="Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status",t.parseRemoteName=F,t._netInfoWinWmic=T;const O=c.keyedLazy("netInfoWin",S.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=yield b.PowerShell.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return null==e?T():r.compact(e.filter(e=>s.notBlank(e.LocalName)).map(e=>a.map(F(e.RemoteName),({host:t,share:n})=>a.map(_.exec(l.toS(e.LocalName)),i=>({mountpoint:w.ensureSuffix(i[0],"\\"),host:t,share:n,ok:"OK"===e.Status&&"Connected"===e.ConnectionState})))))}))}),{maxRetries:2,timeoutMs:M.cmdTimeoutMs,priorResultTtlMs:M.longTtlMs});f.onClearCache(()=>O.clear())},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6),s=n(5),o=n(15),a=n(17),u=n(16),l=n(39);t.hidden=function(e){return!!e.base.startsWith(".")||(u.isWin?function(e){return i(this,void 0,void 0,(function*(){const t=yield l.PowerShell.instance().executeJsonToA(["Get-Item -Force -LiteralPath",l.pwshQuote(e.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return o.Opt(t).flatMap(e=>e[0]).flatMap(e=>e.Mode).flatMap(e=>e.includes("h")||e.includes("s")).getOrElse(()=>!1)}))}(e):!!u.isMac&&function(e){return i(this,void 0,void 0,(function*(){try{const t=yield a.stdout("stat",["-f","%f",e.nativePath],{timeout:10*r.secondMs}),n=s.toInt(t);return null!=n&&(32768&n)>0}catch(e){return!1}}))}(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(5),o=n(12),a=n(41);function u(e,t){const n=Math.pow(2,t),i=[];for(;e>0;)i.unshift(e%n),e=Math.floor(e/n);return i}function l(e){return e.toString(2).split("").reverse().map((e,t)=>"1"===e?t:-1).filter(e=>-1!==e)}t.concatBits=function(e,t){const n=Math.pow(2,t);return e.reduce((e,t)=>e*n+s.clamp(0,n,s.toInt(t,{defaultValue:0})),0)},t.splitBits=u,t.diffConcattedBits=function(e,t,n){return r.map2(e,t,(e,t)=>i.sum(o.zip(u(e,n),u(t,n)),([e,t])=>s.absdiff(e,t)))},t.bitZip=function(e){e.dims.forEach(e=>e.value=s.clamp(e.min,e.max,e.value));let t=0;for(let n=0;n<e.bitDepth;n++){t*=2;const i=n%e.dims.length,r=e.dims[i],s=a.avg([r.min,r.max]);r.value>s?(t+=1,r.min=s):r.max=s}return t},t.bitUnzip=function(e,t){if(t.bitDepth>52||t.bitDepth<0)return;const n=l(e);for(let e=0;e<t.bitDepth;e++){const i=e%t.dims.length,r=t.dims[i],s=a.avg([r.min,r.max]);n.includes(t.bitDepth-e-1)?r.min=s:r.max=s}return t.dims.map(e=>a.avg([e.min,e.max]))},t.bitsSet=l,t.pop=function(e){return e=(e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135,e+=e>>8,63&(e+=e>>16)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(88),s=n(168),o=n(0),a=n(5),u=n(7);class l{constructor(e,t=""){this.query="",this.query=t,this.assetId=a.isNumber(e)?e:e.id}static onNewPage(){this.pageImageCount=0}assetUrl(){return`/asset/${this.assetId}${this.query}`}linkAttrs(){return{href:this.assetUrl()}}imgLink(e,t){return`/img/${this.assetId}/${e}/${t}${this.query}`}imgActualLink(e){return`/img/${i.compact([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e){return this.imgAttrs("sq",s.SqWidths,e)}imgAttrs(e,t,n,i){const s=Math.min(...t),a={width:u.toS(s)},d=this.imgLink(e,s);l.pageImageCount++,(n=o.orElse(n,()=>l.pageImageCount>64))?(a.src="/images/clear-256.png",a["data-src"]=d):a.src=d,e===r.ReducerNames.sq&&(a.sizes="(min-width: 900px) 12.5vw, (min-width: 540px) 25vw, 50vw",a.height=u.toS(s));const h=t.map(t=>c(this.imgLink(e,t),t));o.map(i,e=>h.push(c(this.imgActualLink(),e.width)));const f=h.join(",");return n?a["data-srcSet"]=f:a.srcSet=f,a}}function c(e,t){return e+" "+t+"w"}t.AssetUrls=l,l.pageImageCount=0},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(96),s=n(18),o=n(6),a=n(28),u=n(0),l=n(24),c=n(20),d=n(4),h=n(89),f=n(154);class p{constructor(e,t){this.name=e,this.bc=t,this._ended=!1}get ended(){return this.bc.ended||this._ended}end(){return i(this,void 0,void 0,(function*(){this._ended=!0,r.setLogger(r.NoLogger),this.bc.ended||(yield this.bc.end())}))}}t.observeBatchCluster=function(e,t,n=l.EndableRanks.service){const i=d.mkLogger(t),m=new p(t,e);r.setLogger(i);const g=(e,n)=>{m.ended||l.ending()||c.onError(t+": "+e,n)};return e.on("childStart",n=>{f.renice(n.pid),h.addPid({pid:n.pid,ppid:s.pid,cmd:t,maxAgeMs:e.options.maxProcAgeMillis+o.minuteMs},new Date)}),e.on("startError",e=>g("Failed to start"+c.FatalErrorFlag,e)),e.on("taskError",(e,t)=>{const n=u.map(t,e=>e.command);i.warn("observeBatchCluster.taskError()",{error:e,cmd:n}),g("Failed to run "+n,e)}),e.on("internalError",e=>{i.warn("observeBatchCluster.internalError(): "+a.errorToS(e)),g("Internal error",e)}),e.on("endError",e=>{i.error("observeBatchCluster.endError(): "+a.errorToS(e))}),l.addEndable(n,m)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=function(e,t,n=!1){let i=n?Date.now()+t:0,r=0;const s=(...n)=>{const s=Date.now();return s>=i?(i=s+t,r++,e(...n)):void 0};return s.count=()=>r,s}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(275),s=n(82),o=n(34),a=n(3),u=n(6),l=n(64),c=n(8),d=n(53),h=n(13),f=n(9),p=n(32),m=n(256),g=new d.BoundedMap(5*u.minuteMs,1024,!1);function y(e){return f.stripPrefix(o.extname(e),".")}h.onClearCache(()=>g.clear()),h.onFileChanged(e=>null==e?g.clear():g.delete(e)),t.readFileType=function(e){return i(this,void 0,void 0,(function*(){return g.getOrSet(e,()=>i(this,void 0,void 0,(function*(){const{buffer:t}=yield m.readFilePart(e,0,248);return l.thenOpt(r.fromBuffer(t)).filter(e=>"image/tiff"!==e.mime).orElse(()=>l.thenOpt(c.resolved(s.stat(e))).filter(e=>e).flatMap(()=>p.exiftool().readRaw(e,["-mimetype"])).flatMap(e=>e.MIMEType).filter(a.notBlank).map(t=>({ext:y(e),mime:t})).get()).get()})))}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(159),s=n(54),o=n(14);function a(e,t){return o.within(-90,90,e)&&o.within(-180,180,t)&&0!==e&&0!==t}function u(e,t,n=50){return a(e,t)?r.bitZip({dims:[{min:-180,value:t,max:180},{min:-90,value:e,max:90}],bitDepth:n}):void 0}function l(e,t=52){return i.map(r.bitUnzip(e,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:t}),e=>e.reverse())}t.validLatLon=a,t.geohash=function(e,t,n=52){return i.map(u(e,t,n),e=>s.GeoRadix.encode(e))},t.geohashNumericShort=function(e,t){return u(e,t,30)},t.geohashNumeric=u,t.ungeohash=function(e,t=52){return i.map(s.GeoRadix.decode(e),e=>l(e,t))},t.ungeohash_num=l},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(62),s=n(1),o=n(3),a=n(6),u=n(80),l=n(28),c=n(0),d=n(5),h=n(7),f=n(12),p=n(8),m=n(66),g=n(53),y=n(21),v=n(13),b=n(72),w=n(4),S=n(262),M=n(204),P=n(203),E=n(41),x=n(32),_=n(135),F=n(100),T=n(119);t.ModeBits=12,t.SearchHashDim=4,t.SearchHashBits=t.SearchHashDim*t.SearchHashDim*3,t.MaxSearchHash=Math.pow(2,t.SearchHashBits),t.ModeCount=7,t.maxPerBits=function(e){return Math.floor(52/e)};const O=w.mkLogger("ImageHash"),A=new g.BoundedMap(3e5,500,!0);function k(e){return S.b64encode(BigInt("0b0"+e.map(e=>1===e?1:0).join("")))}function D(e){const t=[[],[],[]];for(let n=0;n<e.length;n+=3){const i=_.rgb2lab([e[n],e[n+1],e[n+2]]);t[0].push(i[0]),t[1].push(i[1]),t[2].push(i[2])}return t}v.onClearCache(()=>A.clear()),v.onFileChanged(e=>o.notBlank(e)?A.delete(e):A.clear()),v.onFileCopied((e,t)=>c.map(A.get(e),e=>A.getOrSet(t,()=>e))),t.imageHashTimers=new m.PromiseTimer,t.imageHash=function(e,n=!0){return i(this,void 0,void 0,(function*(){const o=JSON.stringify({p:e.nativePath,rotationInvariant:n});return A.getOrSet(o,()=>y.elapsedAsync(()=>m.time("img.imageHash "+h.toS(e.ext).toLowerCase(),()=>function(e,n=!0){return i(this,void 0,void 0,(function*(){const i=w.mkLogger("ImageHash("+e+")"),o=t.imageHashTimers.mkElapsed(i);try{const a=!n,l=yield T.sharpReadable(e,t.ModeDim,a);if(null==l)return void i.warn("Cannot build readable stream");if(o.elapsed("sharpReadable"),null==(yield F.dimensions(e)))return void i.warn("Can't extract dimensions");o.elapsed("dimensions");let h=r(l.nativePath).removeAlpha().toColorspace("srgb").trim().resize(Object.assign(Object.assign({},t.ModeDim),{fit:"fill",fastShrinkOnLoad:!0,withoutEnlargement:!0}));a||(yield p.thenMap(x.readRotation(e),e=>h=h.rotate(e)));const m=yield h.raw().toBuffer({resolveWithObject:!0});o.elapsed("big resize done: "+u.dimToS(m.info));let g=r(m.data,{raw:Object.assign(Object.assign({},m.info),{channels:3})});const{data:y,info:v}=yield g.resize({width:t.HashDim,height:t.HashDim,fit:"fill"}).raw().toBuffer({resolveWithObject:!0});o.elapsed("small resize done: "+u.dimToS(v));const b=D(y),w=d.times(3,e=>E.avg(b[e]));o.elapsed("means");const S=90*M.leastQuarter(b[0],{col:t.HashDim,row:t.HashDim}),O=e=>(i.debug("rotating "+S+" degrees"),e.map(e=>new P.SquareMatrix(e).rotate(S).m)),A=n?O(b):b,C=A.map((e,t)=>{const n=w[t];return e.map(e=>e>=n?1:0)}),I=k(s.flatten(C)),L=A.map(e=>e.map((t,n)=>t<c.orElse(e[n+1],0)?1:0).slice(0,-1)),R=k(s.flatten(L));o.elapsed("constructed hash");const{info:B,data:N}=yield m;o.elapsed("big resize done: "+u.dimToS(B));const j=function(e){const n=s.stepRange(0,e.length,3,t=>_.rgb2lab([e[t],e[t+1],e[t+2]]));return E.modes(n.map(e=>_.labhash(e,t.ModeBits)),t.ModeCount)}(N);o.elapsed("Dominant colors");let z=r(m.data,{raw:Object.assign(Object.assign({},m.info),{channels:3})});const q=D(yield z.resize({width:t.SearchHashDim,height:t.SearchHashDim}).raw().toBuffer()),V=(n?O(q):q).map((e,t)=>{const n=w[t];return e.map(e=>e>n?1:0)}),W=[...V[0],...f.flatZip(V[1],V[2])].join("");return{meanHash:I,rightHash:R,searchHash:parseInt(W,2),modes:j}}catch(t){return void i.warn("Failed to imageHash("+e.nativePath+"): "+l.errorToS(t),t.stack)}}))}(e,n))).then(({elapsedMs:n,result:i})=>(t.imageHashTimers.push("imageHash()",n),O.tap({level:b.ms2level(n,5*a.secondMs),msg:"imageHash()",result:i,meta:{file:e.nativePath,elapsedMs:n}}))))}))},t.HashDim=8,t.ModeDim={width:96,height:96}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(48),s=n(4),o=n(0),a=n(10),u=n(69),l=n(103);t.dbr=function(e,t){return i(this,void 0,void 0,(function*(){const n=o.orElse(t,new d),i=e(n);return null==t&&(yield n.submit()),i}))};const c=s.mkLogger("DbRequestRemote");class d{constructor(e=u.dbClient()){this.client=e,this.d=[],this.ops=[]}op(e,t){return this.ops.push(Object.assign(Object.assign({},l.toSqlQuery(t)),{method:e})),a.tap(new r.Deferred("DbRequestRemote."+e),e=>this.d.push(e)).promise}exec(e){return this.op("exec",e)}run(e){return this.op("run",e)}first(e){return this.op("first",e)}all(e){return this.op("all",e)}pluckFirst(e){return this.op("pluckFirst",e)}pluckAll(e){return this.op("pluckAll",e)}submit(){return this.client.request("batch",this.ops).then(e=>{c.debug("submit(): got response",{arr:e}),e.forEach((e,t)=>{this.d[t].resolve(e)})})}}t.DbRequestRemote=d},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(13),s=n(101),o=n(201),a=n(1),u=n(6),l=n(0),c=n(5),d=n(171),h=n(104);r.onClearCache(()=>f.clear());class f extends d.Model{static clear(){this.assetId2tagIds.clear()}$pk(){return[l.orElse(this.assetId,()=>l.map(this.asset,e=>e.id)),l.orElse(this.tagId,()=>l.map(this.tag,e=>e.id))].join(":")}static addTagsToAsset(e,t,n){return i(this,void 0,void 0,(function*(){const i=c.id(e);if(null==i)return void this.logger().warn("addTagsToAsset(): got null assetId");const r=a.compact(t.map(c.id));if(a.isEmpty(r))return void this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:t});const s="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+r.map(e=>`(${i},${e})`).join(",");return h.Tag.onAssetTagChange(),t.forEach(t=>this.assetId2tagIds.add(e,t)),this.dbr(e=>e.run(s),n)}))}static removeTagsFromAsset(e,t,n){t=a.compact(t),h.Tag.onAssetTagChange();const i=this.query().whereIn("tagId",t).andWhere({assetId:e}).delete();return s.atap(this.dbr(e=>e.run(i),n),()=>t.forEach(t=>this.assetId2tagIds.delete(e,t)))}}t.AssetTag=f,f.tableName="AssetTag",f.assetId2tagIds=new o.TTLMultiMap(5*u.minuteMs)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(37);t.FitSizes=i.strEnum("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),t.FitSizeValues=t.FitSizes.values,t.SqSizes=i.strEnum("s480","s240","s120","s60"),t.SqWidths=[60,120,240,480]},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(3),o=n(2),a=n(40),u=n(8),l=n(81),c=n(240),d=n(4),h=n(26),f=n(16),p=n(241),m=n(35),g=n(158),y=n(144),v=n(136),b=n(27),w=n(29),S=n(242),M=n(243);function P(e){const t=e.nativePath.toLowerCase().normalize();return y.pathIsNeverIgnored(e.nativePath)||y.pathIsNeverIgnored(t)?{pathIsNeverIgnored:()=>!1}:Object.assign(Object.assign({},x(e.nativePath)),{snapDirectory:()=>i(this,void 0,void 0,(function*(){return f.isLinux&&(yield M.ignorableSnapDir.apply(e))})),noMedia:()=>v.hasNoMedia(e),hidden:()=>g.hidden(e),seemsRecursive:()=>S.seemsRecursive(e.pathnames),mountpoint:()=>i(this,void 0,void 0,(function*(){return u.thenMapOr(m.mountpoints(),t=>t.includes(e.nativePath),()=>!1)}))})}t.ignorablePredicates=function(e){return i(this,void 0,void 0,(function*(){return(yield e.isDirectory())?P(e):x(e.nativePath)}))},t.ignorableFile=function(e){return _(e.nativePath)},t.ignorableDirectory=function(e){return i(this,void 0,void 0,(function*(){return c.orLoggedAsync([P(e)],d.mkLogger("ignorableDirectory("+e.nativePath+")"))}))},t.ignorableDirectoryPredicates=P;const E=o.lazy(()=>new F);function x(e){return Object.assign(Object.assign({},E().ignorablePathPredicates(e)),{notExists:()=>w.PosixFile.for(e).notExists()})}function _(e){return E().ignorablePath(e)}t.ignorablePathPredicates=x,t.ignorablePath=_;class F{constructor(e=h.isTest){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","var","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize())),this.ignorableDirectories=new Set(["_includes","#recycle","@Recycle","@eaDir","@SynoResource","$Recycle.Bin","Application Data","Application Support","Applications","arangodb","cache","caches","com.apple.TimeMachine.localsnapshots","cpan","cygwin","cygwin64","DefinitelyTyped","Desktop DB","Desktop DF","Download","Downloads","DisplayDriver","ehthumbs.db","lost+found","Network Trash Folder","node_modules","Program Files (x86)","Program Files","ProgramData","steamapps","spotifycache","System32","System Volume Information","Temporary Items","testutils","test_suite","third_party","3rdParty","tmp","iTunes","iTunes Media","Thumbnails","Thumbs.db","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase())),this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/.*?\.photos?library\/(?!Masters?\/)/i,/\/ImageMagick[\d\.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Smart Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d\.-]*(\/|$)/i,/\/Python[\d\.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d\.-]+(amd64|x64)?(\/|$)/i],this.systemDirs=r.uniq(r.compactBlanks([a.App.appData(),l.getEnv("APPDATA"),l.getEnv("SYSTEMROOT"),l.getEnv("ProgramFiles"),l.getEnv("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize())),this.ignorableSubdirs=new p.SetSet,f.isLinux&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);const t=["bin","etc","games","include","lib","lib32","local","locale","man","sbin","share","src"];this.addIgnorableSubdirs("usr",t),this.addIgnorableSubdirs("local",t),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...t]),this.addIgnorableSubdirs("var",["cache","crash","lib","local","log","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);const n=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",n),this.addIgnorableSubdirs("Perl64",n),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(l.getEnv("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"))}addIgnorableSubdirs(e,t){if(s.blank(e))return;const n=e.toLowerCase().normalize();r.compactBlanks(t).forEach(e=>this.ignorableSubdirs.add(n,e.toLowerCase().normalize()))}ignorablePathPredicates(e){const t=y.pathIsNeverIgnoredPredicate(e);if(null!=t)return t;const n=e.toLowerCase().normalize(),i=r.compactBlanks(b.pathnames(n));return{hiddenPosix:()=>i.some(e=>e.startsWith(".")),systemDir:()=>this.systemDirs.some(e=>n.startsWith(e)),ignorableRoot:()=>this.ignorableRootDirectories.has(i[0]),ignorableDirectory:()=>i.some(e=>this.ignorableDirectories.has(e)),ignorablePath:()=>this.ignorableSubdirs.has(i),ignorablePattern:()=>{const t=b.native2posix(e);return this.ignorableDirectoryPatterns.some(e=>e.test(t))}}}ignorablePath(e){return c.orLogged([this.ignorablePathPredicates(e)],d.mkLogger("FsAttrs("+e+")"))}}t.Ignorable=F},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(6),o=n(59),a=n(0),u=n(10),l=n(15),c=n(19),d=n(55),h=n(20),f=n(122),p=n(4),m=n(26),g=n(287),y=n(8);t.AdvisoryLockRequest=class{constructor(e){this.id=e,this.released=new o.Latch}};const v=new d.TTLMap(f.MaxSyncFileTimeoutMs),b=p.mkLogger("AdvisoryLocks");t.AdvisoryLocks={busyLocks:()=>c.toA(v.values()).filter(e=>!e.idle).map(e=>e.name),lockMaybeAvailable:e=>l.Opt(v.get(e)).flatMap(e=>e.idle).getOrElse(()=>!0),acquireAdvisoryLocks:e=>i(void 0,void 0,void 0,(function*(){b.debug(`acquireAdvisoryLocks(${e})`);const n=r.compactBlanks(e).map(e=>{return t=e,v.getOrSet(t,()=>new g.AdvisoryLock(t));var t}),i=()=>n.every(e=>e.idle),o=[];if(!i()&&(b.info(`acquireAdvisoryLocks(${e}): waiting for locks to be free`),!(yield y.until(i,30*s.secondMs,250))))throw new h.WrappedError({message:"Cannot acquire locks",retriable:!0});try{for(const e of n){const t=yield e.acquire();o.push({name:e.name,lockId:t})}return b.debug(`acquireAdvisoryLocks(${e}): all locks acquired.`),o}catch(n){throw b.warn(`acquireAdvisoryLocks(${e}): failed`,n),t.AdvisoryLocks.releaseAdvisoryLocks(o),n}})),releaseAdvisoryLocks:e=>(b.debug("releaseAdvisoryLocks(): ",{lockRefs:e}),e.reverse().every(e=>a.map(v.get(e.name),t=>t.release(e.lockId)))),withAdvisoryLocks:(e,n)=>i(void 0,void 0,void 0,(function*(){const i=[];try{return i.push(...yield t.AdvisoryLocks.acquireAdvisoryLocks(e)),yield n(i)}finally{t.AdvisoryLocks.releaseAdvisoryLocks(i)}})),releaseAll:()=>{if(!m.isTest)throw new Error("cannot release all locks except in tests");v.clear()}},t.AdvisoryLockHandlers=u.pick(t.AdvisoryLocks,"acquireAdvisoryLocks","releaseAdvisoryLocks")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(30),r=n(23),s=n(4),o=n(26),a=n(101),u=n(1),l=n(3),c=n(0),d=n(10),h=n(51),f=n(7),p=n(172),m=n(166),g=n(74),y=n(107),v=n(147),b=n(148),w=n(250),S=n(149),M=n(291);class P{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return null==this._logger&&(this._logger=s.mkLogger(this.tableName)),this._logger}static query(){return y.knex(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static dbr(e,t){return g.dbRpc()?m.dbr(e,t):e(this.dbLocal())}static dbLocal(){return null==this._dbLocal&&(this._dbLocal=new p.DbRequestLocal(this.db,this.tableName)),this._dbLocal}static txOp(e,t){const n=this.db();if(null==n)throw new Error("only supported on db-local processes");return v.tx(n,this.tableName+": "+e,()=>t(this.opsLocal()))}static tx(e,t,n=!1){const i=this.db();if(null==i)throw new Error("only supported on db-local processes");return v.tx(i,this.tableName+": "+e,()=>t(this.dbLocal()),n)}static ops(){return g.dbRpc()?M.ModelOpsRemote.forModel(this):S.ModelOpsLocal.forModel(this,this.db)}static opsLocal(){return g.assertLocalDb(),S.ModelOpsLocal.forModel(this,this.db)}static opsRemote(){return g.assertDbRpc(),M.ModelOpsRemote.forModel(this)}static truncate(){if(o.isProd)throw new Error("rejecting attempt to truncate in prod");return this.dbr(e=>e.exec("DELETE FROM "+this.tableName))}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return f.toS(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${c.orElse(this.id,this[this.class().uniqueColumnName])})`}logger(){return s.mkLogger(f.toS(this.valueOf()))}[i.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return w.fromJSON(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}static toDbJSON(e,t){return this.fromJSON(e).$toDbJSON(t)}$toShallowJSON(){return this.$_toJSON(r.isTrue)}$toDbJSON(e){const t=this.$_toJSON(r.boolToInt);return l.notBlank(e)?d.pick(t,...e):t}toJSON(){return this.$_toJSON(r.isTrue)}$_toJSON(e){const t=this.class();return d.mapFields(this,(n,i)=>{if(null!=i&&h.isPrimitive(i))return u.includes(t.booleanFields,n)?[n,e(i)]:[n,i]},{$ctor:t.$ctor})}insert(){return this.$beforeUpsert(),a.atap(this.class().ops().insert(this),e=>{w.assignFromJSON(this,e)})}update(e){return a.atap(this.class().dbr(t=>t.exec(this.class().query().where({id:this.id}).update(e))),()=>{w.assignFromJSON(this,e)})}upsert(){return a.atap(this.class().ops().upsertOne(this),e=>{const t=this.class().uniqueColumnName;if("id"!==t&&this[t]!==e[t])throw this.logger().error("unexpected upsert result",{self:this,upserted:e}),new Error("unexpected upsert result");w.assignFromJSON(this,e)})}$beforeUpsert(){}}t.Model=P,P.schema="models",P.db=b.modelDb,P.hasUpdateCount=!1},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(13),r=n(4),s=n(3),o=n(2),a=n(45),u=n(0),l=n(107),c=n(103),d=n(10),h=o.lazy(()=>r.mkLogger("DbRequestLocal"));i.onClearCache(()=>{p.clear(),f.clear()});const f=new Map,p=new Map;t.DbRequestLocal=class{constructor(e,t){this.db=e,this.tableName=t,s.mapNotBlank(t,e=>p.set(e,this))}qb(){return l.knex(this.tableName)}exec(e){this.db().exec(c.toSqlQuery(e).sql)}wrap({q:e,pluck:t,m:n}){const i=c.toSqlQuery(e);let r=a.getOrSet(f,(t?"pluck:":"")+i.sql,()=>this.db().prepare(i.sql));t&&(r=r.pluck());const s=r[n].bind(r);return u.mapOr(i.bindings,e=>s(e),()=>s())}run(e){return this.wrap({q:e,m:"run"})}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}first(e){return this.wrap({q:e,m:"get"})}all(e){return this.wrap({q:e,m:"all"})}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}},t.DbMethods=["exec","run","first","all","pluckFirst","pluckAll"],t.execBatch=function(e,n){return n.map(n=>{try{if(!t.DbMethods.includes(n.method))throw new Error("unknown method "+n.method);return h().tap({msg:"batch()."+n.method,result:d.maybeCall(e,n.method,n),meta:{req:n}})}catch(e){throw h().warn("batch() failed",{req:n,err:e}),e}})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(18),r=n(65);t.stdoutWrite=function(e,n=r.isBatchService()){i.stdout.write(JSON.stringify(e)+"\n"),n&&i.stdout.write(t.readyStr+"\n")},t.readyStr=JSON.stringify({ready:!0})},function(e,t){e.exports=require("readline")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(3),o=n(6),a=n(28),u=n(2),l=n(0),c=n(33),d=n(15),h=n(24),f=n(8),p=n(52),m=n(21),g=n(20),y=n(97),v=n(67),b=n(4),w=n(105),S=n(14),M=n(22),P=n(89),E=n(11),x=n(17);t.mkBasicWatchedChild=function(e){return new _(Object.assign({name:r.compact([e.cmd,...e.args]).join(" "),childFactory:()=>x.spawn(e.cmd,e.args,30*o.minuteMs),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},e))};class _{constructor(e){this.startMs=Date.now(),this._stopped=!1,this.logger=u.lazy(()=>b.mkLogger("WatchedChild("+r.compact([this.name,this.pid]).join(":")+")")),this.startRate=new w.Rate(2*o.minuteMs),this.mutex=new p.Promises,this._ended=!1,this.onError=(e,t)=>i(this,void 0,void 0,(function*(){const n=g.isFatalError(e)||g.isFatalError(t),i=new g.WrappedError({message:e+l.map(t,a.errorToS),cause:g.ifError(t)}),r=g.isIgnorableError(i),s={src:e,fatal:n,ignorable:r,errToS:a.errorToS(t)};if(this.logger().log(r?"warn":"error","onError()",s),!this._ended&&!r)return this.lastError=i,g.onError(e,i),n?this.end():this.opts.onError(e,t)?(this.logger().warn("onError requested restart",s),this._restart()):void 0})),this.name=e.name,this.opts=Object.assign({dataSep:"\n",maxErrorsPerMinute:3,endTimeoutMs:10*o.secondMs,endableRank:h.EndableRanks.first,exitCommand:"",restartOnExit:!0},e),h.addEndable(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}end(){return i(this,void 0,void 0,(function*(){return this._ended=!0,this._stop()}))}get proc(){return this.cp}get pid(){return l.map(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return l.mapOr(this.pid,e=>P.pidExists(e),()=>i(this,void 0,void 0,(function*(){return!1})))}notRunning(){return f.thenNot(this.running())}stop(){return i(this,void 0,void 0,(function*(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}))}_stop(){return i(this,void 0,void 0,(function*(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});const e=this.cp;return this.cp=void 0,null==e||this.stopChild(e)}))}stopChild(e){return i(this,void 0,void 0,(function*(){return yield d.Opt(this.opts.exitCommand).filter(s.notBlank).flatMap(t=>d.Opt(e).flatMap(e=>e.stdin).filter(e=>e.writable).forEach(e=>M.Try(()=>e.write(t+"\n"))).map(v.end).get()),x.endProcess(e,this.opts.endTimeoutMs)}))}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:S.gt(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}restart(){return i(this,void 0,void 0,(function*(){return this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),!this._ended&&!h.ending()&&(this.startRate.msSinceLastEvent<E.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault?void this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:E.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault}):this.mutex.serial(`WatchedChild(${this.name}).restart`,()=>i(this,void 0,void 0,(function*(){return yield this._stop(),this._stopped=!1,this._start()}))))}))}start(){return i(this,void 0,void 0,(function*(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,()=>i(this,void 0,void 0,(function*(){return this._stopped=!1,this._start()})))}))}_restart(){return i(this,void 0,void 0,(function*(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,()=>i(this,void 0,void 0,(function*(){return yield this._stop(),!this._stopped&&!this._ended&&(this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),m.isRecentMs(this.startMs,E.Settings.probationMs.valueOrDefault)&&g.onError("Can't restart "+this.name+", failure rate is too high."+g.FatalErrorFlag,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),c.isFunction(this.opts.onRestart)&&this.opts.onRestart(),this._start()))})))}))}_start(){return i(this,void 0,void 0,(function*(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended)return!1;if(yield this.running())return!1;this.startRate.onEvent();const e=this.cp=yield this.opts.childFactory();this.logger.clear(),this.logger().info("_start(): spawned pid "+this.pid);const t="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:e,desc:n})=>{l.map(e,e=>e.on("error",e=>this.onError(t+n+".on(error)",e)))}),y.onDataChunked(this.cp.stdout,this.opts.dataSep,e=>{this.logger().debug("onDataChunked()",e),this.opts.onStdout(e)}),this.cp.stderr.on("data",e=>{c.isFunction(this.opts.onStderr)&&!this.opts.onStderr(e)||this.onError(t+".stderr.on(data)",e)}),this.cp.on("exit",(e,t)=>{this.logger().info("onExit",{code:e,signal:t,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?this._restart():(this.logger().info("onExit(): this.opts.restartOnExit is false, so we're done."),this.end())}),this.logger().info("_start(): finished setting up new child "+this.pid),!0}))}}t.WatchedChild=_},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(19);t.hasWarn=function(e){return null!=e&&i.isNotEmpty(e.warn)},t.hasBad=function(e){return null!=e&&i.isNotEmpty(e.bad)},t.hasFail=function(e){return null!=e&&i.isNotEmpty(e.fail)},t.fullhc=function(e){return{ok:r.toA(e.ok),warn:r.toA(e.warn),bad:r.toA(e.bad),fail:r.toA(e.fail)}},t.uniqhc=function(...e){const t=i.compact(e);return{ok:i.uniq(i.flatten(t.map(e=>e.ok))),warn:i.uniq(i.flatten(t.map(e=>e.warn))),bad:i.uniq(i.flatten(t.map(e=>e.bad))),fail:i.uniq(i.flatten(t.map(e=>e.fail)))}},t.concatHealthChecks=function(...e){function t(t){return i.uniq(i.compact(i.flatten(e.map(t))))}return e=i.compact(e),{ok:t(e=>e.ok),warn:t(e=>e.warn),bad:t(e=>e.bad),fail:t(e=>e.fail)}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6),s=n(7),o=n(36),a=n(8),u=n(17),l=n(20),c=n(276),d=n(163),h=n(113),f=n(134),p=n(4),m=n(32),g=n(70),y=n(128),v=n(178),b=n(122);t.dcrawSupportedMimeTypes=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);const w=p.mkLogger("dcraw");function S(e){return w.tap({msg:"dcrawSupportedMimetype("+e+")",result:t.dcrawSupportedMimeTypes.has(s.toS(e).toLowerCase())})}t.dcrawSupported=function(e){return i(this,void 0,void 0,(function*(){try{return S(yield a.thenMap(d.readFileType(e.nativePath),e=>e.mime))}catch(e){return w.warn("dcrawSupported(): failed to read filetype",e),!1}}))},t.dcrawSupportedMimetype=S;const M=v.ImageSize.largestFit().megapixels();t.dcraw=function(e){return i(this,void 0,void 0,(function*(){const t=Date.now(),n=yield m.readTags(e.nativePath),s=y.tmegapixels(n),a=null!=s&&s>4*M?["-h"]:[],d=yield f.dcrawNativePath(),p=["-T","-c","-H","2","-w","-o","1",...a,"-t","0","-q","2",e.nativePath],v=5*r.minuteMs,S={encoding:"buffer",timeout:v,maxBuffer:250*o.MB};w.debug("dcraw()",{cmd:d,args:p,opts:S});const P=yield u.execFile(d,p,v,S),E=t=>i(this,void 0,void 0,(function*(){(yield c.emitSafely(P.stdout,"error","Problem from "+e+": "+l.cleanError(t,e.nativePath)))||w.error("No listeners for error when reading "+e,t),P.kill("SIGINT")}));P.on("error",E),P.stderr.on("data",E);const x=b.dcrawTimeout(yield e.size())/g.maxCpus(),_=new h.PullProgressObserver({path:e.nativePath,op:"Converting raw image"},x,()=>Date.now()-t);return P.on("close",()=>_.end()),P.stdout}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(30),r=n(80),s=n(2),o=n(36),a=n(12),u=n(11),l=n(278);class c{constructor(e,t,n,i,r=!0){this.name=e,this.maxWidth=t,this.maxHeight=n,this.reducer=i,this.rotational=r,this.megapixels=s.lazy(()=>o.megapixels(this.maxWidth*this.maxHeight)),this.max={width:t,height:n},c._Sizes.push(this)}static sq(){return this._Sizes.filter(e=>e.reducer===l.Square)}static largestSq(){return a.greatestBy(this.sq(),e=>e.megapixels())}static fit(){const e=u.Settings.previewResolutions.valueOrDefault;return this._Sizes.filter(t=>t.reducer===l.Fit&&e.includes(t.name))}static largestFit(){return a.greatestBy(this.fit(),e=>e.megapixels())}[i.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"Ã"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&r.isPortrait(e)?r.flip(this.max):this.max,e)}resize(e,t){return t=t.resize(Object.assign(Object.assign({},e),{fit:this.reducer.fit,withoutEnlargement:!0}))}toJpeg({path:e,sh:t,outputSize:n}){return(r.dmegapixels(n)<2||u.Settings.sharpen.valueOrDefault)&&(t=t.sharpen()),t.jpeg({quality:85,progressive:u.Settings.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}}t.ImageSize=c,c._Sizes=[],c.UHD8k=new c("uhd8k",7680,4320,l.Fit,!1),c.UHD5k=new c("uhd5k",5120,2880,l.Fit,!1),c.UHD=new c("uhd4k",4096,2160,l.Fit),c.QHD=new c("qhd",3120,1440,l.Fit),c.FHD=new c("fhd",1920,1080,l.Fit),c.HD=new c("hd",1280,720,l.Fit),c.WVGA=new c("wvga",720,480,l.Fit),c.QVGA=new c("qvga",320,240,l.Fit),c.QQVGA=new c("qqvga",160,120,l.Fit),c.S480=new c("s480",480,480,l.Square),c.S240=new c("s240",240,240,l.Square),c.S120=new c("s120",120,120,l.Square),c.S60=new c("s60",60,60,l.Square)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(3),o=n(6),a=n(0),u=n(15),l=n(7),c=n(55),d=n(12),h=n(8),f=n(21),p=n(123),m=n(252),g=n(42),y=n(4),v=n(111),b=n(129),w=n(32),S=n(47),M=y.mkLogger("TagInference"),P=y.mkLogger("TagInference.inferMakeAndModel()");t.inferMakeAndModel=function(e,t){return i(this,void 0,void 0,(function*(){if(s.notBlank(t.Make)&&s.notBlank(t.Model))return;if(s.blank(t.Make)&&(l.toS(t.HandlerDescription)+l.toS(t.CompressorName)).includes("GoPro"))return void(t.Make="GoPro");const n=O(e),{younger:i,older:o}=yield D(e),a=r.compact(r.flatten(d.zip(i,o))).slice(0,50).filter(e=>v.diceCoeff(O(e),n)>.7).slice(0,10);M.info("inferMakeAndModel("+e+"): looking at nearby siblings",a.map(e=>e.base));for(const n of a){const i=yield w.readRawTags(n);if(null!=i&&d.allNotBlank(i.Make,i.Model))return P.info("Inferring Make and Model",{file:e.nativePath,sibling:n.base,Make:i.Make,Model:i.Model}),t.Make=i.Make,void(t.Model=i.Model)}}))};const E=y.mkLogger("TagInference.inferCapturedAtFromSiblings()");function x(e,t=7){return i(this,void 0,void 0,(function*(){return d.firstAsync(e.slice(0,t),(e,t)=>h.thenMap(w.readRawTags(e),e=>h.thenMap(b.capturedAtFromTags(e),e=>Object.assign(Object.assign({},e),{index:t}))))}))}t.inferCapturedAtFromSiblings=function(e){return i(this,void 0,void 0,(function*(){return h.thenMap(function(e){return _.getOrSet(e.nativePath,()=>i(this,void 0,void 0,(function*(){const{younger:t,older:n}=yield D(e),i=yield x(t),r=yield x(n);return null==i||null==r?void 0:{before:i,after:r,index:i.index,slots:i.index+r.index+1}})))}(e),({before:t,after:n,index:i,slots:r})=>{if(g.sameDay(t.date,n.date))return a.map(p.DateInterval.for(t.date,n.date,i,r),e=>({date:e,src:`before:${t.src},after:${n.src}`}));E.debug("rejecting, not same day",{file:e.nativePath,before:l.toS(t),after:l.toS(n)})})}))};const _=new c.TTLMap(2*o.minuteMs);const F=/(?:burst)(.{8,})$/i,T=/^(?:(?:dsc0|dscf|img|mov|mvimg|vid|gpfr|gopro?|gp|gf|p|100)(?:[-_ ])?)(\S.+)$/i;function O(e){return u.Opt(e).flatMap(e=>e.name).flatMap(e=>a.mapOr(F.exec(e),e=>e[1],()=>e)).flatMap(e=>a.mapOr(T.exec(e),e=>e[1],()=>e)).getOrElse(()=>e.name).replace(/^[\s-_]+/,"").replace(/[\s-_][\d\s]{0,4}$/,"").replace(/_cover$/i,"").toLowerCase().normalize()}t.bname=O;const A=m.extFilter(S.AllExifExts),k=new c.TTLMap(2*o.minuteMs);function D(e,t=7){return i(this,void 0,void 0,(function*(){return k.getOrSet(e.nativePath,()=>i(this,void 0,void 0,(function*(){const n=O(e),i=(yield e.siblings()).filter(e=>!e.base.startsWith(".")&&A.apply(e)&&!S.isSidecarExt(e.ext)&&v.diceCoeff(O(e),n)>.7),s=r.sortBy(i,e=>O(e)),[o,a]=d.partition(s,e=>O(e)<n);return o.reverse(),{younger:o.slice(0,t),older:a.slice(0,t)}})))}))}t.nearestSiblings=D,t.nearestSiblingTzOffset=function(e){return i(this,void 0,void 0,(function*(){const{younger:t,older:n}=yield D(e),r=d.flatZip(t,n).slice(0,10),s=yield h.thenMap(function(e,t=7){return i(this,void 0,void 0,(function*(){return d.firstAsync(e.slice(0,t),(e,t)=>h.thenMap(w.readRawTags(e),e=>h.thenMap(b.capturedAtFromTags(e),e=>u.Opt(e).filter(e=>g.hasZone(e.date)).flatMap(e=>g.getZoneName(e.date)).map(e=>({zoneName:e,index:t})).get())))}))}(r),e=>e.zoneName);return M.info("nearestSiblingTzOffset()",{f:e.baseWithGrandparent,result:s}),s}))},t.extractStatname=function(e){return i(this,void 0,void 0,(function*(){const t=g.parseDateTime(O(e));if(null==t)return;const n=g.datedToMillis(t);if(null==n)return;const i=yield e.stat();return null!=i?d.first(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],e=>Math.abs(i[e]-n)<f.MaxTzOffsetHours?{src:e,date:t}:void 0):void 0}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqliteExt=".sqlite3",t.pathToDb=function(e,n){return e.join(n,"db"+t.SqliteExt)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(3),r=n(5),s=n(14),o=n(13);function a(e){return null!=e&&i.notBlank(e.path)&&i.notBlank(e.op)&&s.within(0,100,e.pct)}t.isProgressEvt=a;t.emitProgressEvt=function(e){a(e)&&o.eventEmitter.emit("progress",Object.assign(Object.assign({},e),{pct:r.round(r.clamp(0,100,e.pct))}))},t.onProgressEvt=function(e){o.eventEmitter.on("progress",e)},t.removeProgressEvtListener=function(e){return o.eventEmitter.removeListener("progress",e)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(170),s=n(20),o=n(4),a=n(1),u=n(2),l=n(69),c=n(74),d=o.mkLogger("withAdvisoryLock()");function h(e,t){return i(this,void 0,void 0,(function*(){try{return yield c.dbRpc()?function(e,t){return i(this,void 0,void 0,(function*(){const n=l.dbClient();if(null==n)throw new Error("only for dbrpc services");const i=yield n.request("acquireAdvisoryLocks",e);a.isEmpty(i)&&d.throw("failed to get advisory lock",{lockNames:e}),d.info("acquired",{lockNames:e,locks:i});const r=u.lazy(()=>n.request("releaseAdvisoryLocks",i));try{const e=yield t(i),n=yield r();return!0===n?d.info("released",{locks:i,released:n}):d.throw("failed to release",{locks:i,released:n}),e}catch(e){throw yield r(),e}}))}(e,t):r.AdvisoryLocks.withAdvisoryLocks(e,t)}catch(t){throw new s.WrappedError({cause:t,message:"Failed to get advisory lock for "+e,retriable:!0})}}))}t.RpcAdvisoryLockProvider={withAdvisoryLocks:h},t.withAdvisoryLocks=h},function(e,t){("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"0.8.0-alpha.3+20200414043332"}},function(e,t){e.exports=require("commander")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(18),r=n(98),s=(new Date).getFullYear();t.descriptionFooter=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.\n\nCopyright Â© ${s}, PhotoStructure Inc.\n\nRunning this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula>`,t.CliDesc={main:"Launches PhotoStructure. Manages web and sync services.",info:"File metadata and import diagnostics tool.",ls:"List all paths in a Library. Use --json or --dump with `jq` to extract columns.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"Web service. Automatically started by main.",db:"DB service. Normally runs within the web service.",sync:"Directory synchronization service. Automatically started by main.",syncFile:"File synchronization service. Automatically started by sync."},t.addFooter=function(e){return e.on("--help",()=>{var e;console.log("\n"+r.wrap(t.descriptionFooter,{maxLineLen:null!==(e=i.stdout.columns)&&void 0!==e?e:78,prefix:""}).join("\n")+"\n")})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(33);t.isList=function(e){return null!=e&&(Array.isArray(e)||isFinite(e.length)&&i.isFunction(e[Symbol.iterator])&&i.isFunction(e.push)&&i.isFunction(e.pop)&&i.isFunction(e.forEach)&&i.isFunction(e.some))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(5);class r{constructor(e,t){this.ttlMs=e,this.maxLength=t,this.times=[],this.a=[]}[Symbol.iterator](){this.vacuum();const e=[...this.a];return function*(){for(const t of e)yield t}()}push(...e){i.times(e.length,()=>this.times.push(Date.now())),this.a.push(...e),null!=this.maxLength&&this.vacuum()}pushUniq(...e){e.forEach(e=>{this.includes(e)||this.push(e)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;if(null!=this.maxLength){const e=this.a.length-this.maxLength;this.times.splice(0,e),this.a.splice(0,e)}const e=Date.now()-this.ttlMs,t=this.times.findIndex(t=>t>e);-1===t?this.clear():t>0&&(this.times.splice(0,t),this.a.splice(0,t))}}t.TTLArray=r},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(131),s=n(1),o=n(6),a=n(28),u=n(2),l=n(0),c=n(5),d=n(15),h=n(7),f=n(8),p=n(17),m=n(4),g=n(14),y=n(11),v=n(25),b=n(70),w=n(122),S=u.lazy(()=>m.mkLogger("ffmpeg")),M=/ffmpeg version (\S+)/i;t.ffmpegVersion=u.lazy(()=>i(void 0,void 0,void 0,(function*(){try{const e=yield p.stdoutResult(y.Settings.ffmpegPath.valueOrDefault,["-version"],{timeout:v.cmdTimeoutMs,ignoreStderr:!0,isIgnorableError:()=>!0}),t=l.map(M.exec(e.result),e=>l.orElse(r.parse(e[1]),e[1]));return S().info("ffmpegVersion",Object.assign({version:t},e)),0===e.code?t:void 0}catch(e){return}}))),t.ffmpegVersionDescription=u.lazy(()=>f.thenMapOr(t.ffmpegVersion(),e=>"version "+e,()=>"(not found)")),t.checkFFmpegVersion=function(){return i(this,void 0,void 0,(function*(){return f.thenOrElse(t.ffmpegVersion.prior(),()=>t.ffmpegVersion.refresh())}))},t.isFFmpegSupported=function(){return i(this,void 0,void 0,(function*(){return null!=(yield t.ffmpegVersion())}))},t.ffmpegFrame=function(e){var t;return i(this,void 0,void 0,(function*(){return(yield e.dest.exists())&&(yield e.dest.isEmpty())&&(yield e.dest.unlink()),p.stdoutResult(y.Settings.ffmpegPath.valueOrDefault,s.compact(["-loglevel","error","-i",e.src.nativePath,...null!==(t=g.mapGte0f(e.startAtSec,e=>["-ss",e.toFixed(1)]))&&void 0!==t?t:[],"-vframes","1","-f","singlejpeg","-y",e.dest.nativePath]),{timeout:o.minuteMs,isIgnorableError:E})}))},t.ffmpegTranscode=function(e){return i(this,void 0,void 0,(function*(){const t=d.Opt(e.videoBitrateKbps).filter(c.gt0).map(e=>c.sigFigs(e,2)).map(e=>["-b:v",e+"k","-maxrate",e+"k","-bufsize",c.sigFigs(e/2,2)+"k"]).getOrElse(()=>[]);return p.stdoutResult(y.Settings.ffmpegPath.valueOrDefault,["-loglevel","error","-threads",h.toS(b.maxCpus()),"-i",e.src.nativePath,"-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high",...t,"-c:a","aac",e.dest.nativePath],{timeout:e.timeoutMs,isIgnorableError:E})}))};const P=/(?:corrupt|invalid|error.*decoding|decode.*failed|nothing.*output|partial file)/i;function E(e){return null==a.errorToS(e).match(P)}t.ffmpegValidVideo=function e(t,n=1){return i(this,void 0,void 0,(function*(){const i=yield p.stdoutResult(y.Settings.ffmpegPath.valueOrDefault,["-v","error","-i",t.nativePath,"-f","null","-"],{timeout:l.orElse(yield w.syncFileTimeoutForFileMs(t),2*o.minuteMs),isIgnorableError:E,ignoreExitCode:!0,quiet:!1});return null!=i.code||n<=0?i:e(t,n-1)}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(132),r=n(27),s=n(29),o=n(11),a=n(9),u=n(3),l=n(2),c=n(15),d=n(78);t.installLibraryUriSupport=l.lazy(()=>{i.addUriParser(p),i.addUriFormatter(f)});const h=l.lazy(()=>c.Opt(o.Settings.libraryPath.value).filter(u.notBlank).map(e=>s.PosixFile.for(e)));function f(e){const t=s.PosixFile.for(r.posix2native(e.posixPath));return h().filter(e=>t.isDescendantOf(e)).map(t=>({pathname:encodeURI(s.PosixFile.for(e.posixPath).posixPathFrom(t)),protocol:d.PS_LIBRARY_PROTOCOL,slashes:!0})).get()}function p(e){return c.Opt("").filter(()=>a.equalsIgnoreCase(e.protocol,d.PS_LIBRARY_PROTOCOL)).flatMap(()=>h()).map(t=>u.mapNotBlankOr(e.pathname,e=>t.join(decodeURIComponent(e)),()=>t)).get()}o.Settings.libraryPath.addListener(()=>h.clear()),t.uriFromLibraryPath=f,t.posixPathFromUri=p},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(17),s=n(21),o=n(134),a=n(4),u=n(6),l=n(7),c=a.mkLogger("SQLite");function d(e,t){return i(this,void 0,void 0,(function*(){const n=yield o.sqliteNativePath(),i=yield s.elapsedAsync(()=>r.stdout(n,[e.nativePath,t],{timeout:1*u.minuteMs}));return c.debug("ops on "+e+" in "+i.elapsedMs+"ms",i.result),i.result}))}t.sqlite=d,t.backupDb=function(e,t){return i(this,void 0,void 0,(function*(){if(null==(yield t.parent().mkdirp()))return!1;try{return yield d(e,`.backup '${t.nativePath}'`),c.info("backupDb(): copied",{srcDb:l.toS(e),destDb:l.toS(t)}),!0}catch(n){return c.warn("backupDb(): copy failed",{srcDb:l.toS(e),destDb:l.toS(t),err:n}),!1}}))},t.verifyDb=function(e){return i(this,void 0,void 0,(function*(){const t=yield d(e,"VACUUM ; PRAGMA integrity_check").catch(e=>e);return"ok"===t.trim()?(c.info("verifyDb("+e+"): OK"),!0):(c.warn("verifyDb("+e+"): NOT OK",t),!1)}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(149),r=n(85),s=n(267);class o extends r.TimestampedModel{static ops(){return this.opsLocal()}static opsLocal(){return i.ModelOpsLocal.forModel(this,this.db)}static dbr(e,t){return e(this.dbLocal())}}t.StatsModel=o,o.schema="stats",o.db=s.statsDb},,function(e,t){e.exports=require("child_process")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(56),s=n(82),o=n(34),a=n(1),u=n(0),l=n(8),c=n(9),d=n(27);class h{constructor(e,t){this.dir=e,this.nativePath=o.join(this.dir,t.name),this.ext=d.extname2(t.name),this.base=t.name,this.name=c.stripSuffix(this.base,this.ext),this._isFile=t.isFile(),this._isDirectory=t.isDirectory(),this._isSymbolicLink=t.isSymbolicLink()}static for(e){return i(this,void 0,void 0,(function*(){const t=d.parseNativePath(e);return s.stat(e).then(e=>new h(t.dir,{name:t.base,isFile:e.isFile.bind(e),isDirectory:e.isDirectory.bind(e),isSymbolicLink:e.isSymbolicLink.bind(e)})).catch(()=>{})}))}get pathnames(){return this.nativePath.split(o.sep)}toString(){return this.nativePath}isFile(){return this._isFile}isDirectory(){return this._isDirectory}isSymbolicLink(){return this._isSymbolicLink}parent(){const e=d.parseNativePath(this.dir);return e.dir===this.dir?this:new h(e.dir,{name:e.base,isFile:function(){return!1},isDirectory:function(){return!0},isSymbolicLink:function(){return!1}})}children(){return this.isDirectory()?new Promise((e,t)=>{r.readdir(this.nativePath,{withFileTypes:!0},(n,i)=>{null!=n?t(n):e(u.map(i,e=>a.sortBy(e,e=>e.name.toLowerCase().normalize()).map(e=>new h(this.nativePath,e))))})}):void 0}stat(){return s.stat(this.nativePath).catch(()=>{})}size(){return i(this,void 0,void 0,(function*(){return l.thenMap(this.stat(),e=>e.size)}))}mtimeMs(){return i(this,void 0,void 0,(function*(){return l.thenMap(this.stat(),e=>e.mtimeMs)}))}}t.DirectoryEntry=h},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(56),s=n(43),o=n(0),a=n(24),u=n(52),l=n(58),c=n(21),d=n(67),h=n(11),f=n(9),p=n(155),m=n(142),g=n(106),y=n(141),v=n(115);t.CaptureLogger=class{constructor(){this.logEntries=[]}log(e,t,n,i){this.logEntries.push({timestamp:Date.now(),level:e,context:t,msg:n,meta:i})}enabled(){return!0}close(){}flush(){return i(this,void 0,void 0,(function*(){}))}};t.LogWriter=class{constructor(e,t={}){this.logDir=e,this.ended=!1,this.mutex=new u.Promises,this._linesSinceRotate=0,this.pendingWrites=[],this._startIndex=0,this.maybeFlush=()=>{this.mutex.maybeRun("maybeFlush",()=>this._flush())},this.shouldRotate=()=>null==this._stream||this._linesSinceRotate>=this.opts.maxLinesPerFile,this.flush=()=>this.mutex.serial("flush",()=>this._flush()),this.name="GzLogWriter("+e+")",this.opts=Object.assign({filter:g.logFilter(),maxLinesPerFile:25e4,logFormatter:new y.ColoredLogFormatter(t),errorLogger:p.ConsoleLogger.instance(),flushEveryMs:m.DefaultLogFlushMs,processName:v.processName},t),this.flushInterval=l.setUnrefInterval(()=>this.maybeFlush(),this.opts.flushEveryMs),a.addLoggerEndable(this)}enabled(e,t){return this.opts.filter.enabled(e,t)}log(e,t,n,i){this.opts.filter.enabled(e,t)&&(this.ended&&g.levelIndex(e)<=1?this.opts.errorLogger.log(e,t,n,i):this.pendingWrites.push(this.opts.logFormatter.format(e,t,n,i)+"\n"))}end(){return i(this,void 0,void 0,(function*(){return this.ended=!0,o.map(this.flushInterval,s.clearInterval),this.flushInterval=void 0,this.close()}))}close(){return i(this,void 0,void 0,(function*(){return yield this.flush(),this.mutex.serial("close",()=>this._closeCurrent())}))}_flush(){return i(this,void 0,void 0,(function*(){const e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&(yield this._rotate());const t=this._stream;if(null==t)return void this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const n=this.opts.maxLinesPerFile-this._linesSinceRotate,i=e.splice(0,n);this._linesSinceRotate+=i.length,t.write(i.join(""))}}))}errback(e){return t=>this.opts.errorLogger.log("error","Caught error from "+e,t)}_rotate(){return i(this,void 0,void 0,(function*(){yield this._closeCurrent(),this._currentFile=yield this.logDir.join(c.datestamp(),f.stripAnsiEsc(this.opts.processName())+".log").ensureNew({emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=r.createWriteStream(this._currentFile.nativePath).on("error",this.errback("file write stream"))}))}_closeCurrent(){return i(this,void 0,void 0,(function*(){yield o.map(this._stream,e=>d.end(e)),this._stream=void 0,this._linesSinceRotate=0,h.Settings.logCompression.valueOrDefault&&(yield o.map(this._currentFile,e=>e.gzip())),this._currentFile=void 0}))}}},function(e,t,n){"use strict";function i(e,t,n=.5){return(1-n)*e+n*t}Object.defineProperty(t,"__esModule",{value:!0}),t.lerp=i,t.lerp2d=function(e,t,n){const r=t.x-e.x,s=(n-e.x)/r;return i(e.y,t.y,s)},t.lerp2d_=function(e,t,n){return(e.y*(t.x-n)+t.y*(n-e.x))/(t.x-e.x)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),s=n(5),o=n(64),a=n(29),u=n(73),l=n(32);function c(e){return r.map(e,e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(s.gt0))}t.extractDurationSec=c,t.duration=function(e){return i(this,void 0,void 0,(function*(){const t=a.PosixFile.for(e);return o.thenOpt(l.mimetype(t)).filter(u.isVideoMimeType).flatMap(()=>l.readRawTags(t,!1)).flatMap(c).get()}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(3),o=n(6),a=n(28),u=n(2),l=n(0),c=n(5),d=n(10),h=n(7),f=n(23),p=n(53),m=n(17),g=n(13),y=n(121),v=n(280),b=n(134),w=n(42),S=n(4),M=n(9),P=n(128),E=new p.BoundedMap(7*o.minuteMs,2048,!1);g.onClearCache(()=>E.clear()),g.onFileChanged(e=>null==e?E.clear():E.delete(e));const x=u.lazy(()=>S.mkLogger("DCRawInfo"));function _(e){const t=y.splitLines(e),n=r.compact(t.map(e=>{const[t,n]=M.splitFirst(e,":"),i=function(e){return h.toS(e).split(/\W+/).map(M.capitalize).join("")}(t);return l.map(function(e,t){return s.blank(t)||F.includes(e)?void 0:e.toLowerCase().includes("time")?l.orElse(w.parseDated(t),t):e.endsWith("Size")?P.parseDimensions(t):T.includes(e)?c.toInt(t):O.includes(e)?f.toBoolean(t):t}(i,h.toS(n).trim()),e=>[i,e])}));return x().tap({msg:"parseRawInfoOutput",result:d.fromEntries(n)})}t.rawInfo=function(e){return i(this,void 0,void 0,(function*(){return E.getOrSet(e.nativePath,()=>i(this,void 0,void 0,(function*(){try{const t=yield b.dcrawNativePath(),n=yield m.stdout(t,["-v","-i",e.nativePath],{timeout:v.StatTimeoutMs,ignoreExitCode:!0});return s.mapNotBlank(n,_)}catch(t){return void x().warn("rawInfo failed",{file:e.nativePath,error:a.errorToS(t)})}})))}))},t.parseRawInfoOutput=_;const F=["CameraMultipliers","DaylightMultipliers"],T=["RawColors","ISOSpeed","NumberOfRawImages"],O=["EmbeddedICCProfile"]},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(9),o=n(200);function a(e){return e.filter(e=>r.notBlank(e)&&"n/a"!==e.trim())}t.extractLensMakeModel=function(e){const t=o.make(e.LensMake),n=o.make(e.Make),u=a([t,e.LensMake,n,e.Make]),l=e=>u.reduce((e,t)=>s.stripPrefixIgnoreCase(e,t).trim(),e);if(r.notBlank(t)&&r.notBlank(e.LensModel))return{lensMake:t,lensModel:l(e.LensModel)};const c=a([e.LensID,e.LensType,e.LensInfo,e.LensModel]);for(const e of c){if(r.notBlank(t))return{lensMake:t,lensModel:l(e)};if(e.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:l(e)};for(const r of i.compactBlanks([t,n,"Canon","Carl Zeiss","Fujifilm","Konica","Leica","Olympus","Sigma","Sony"]))if(e.toLowerCase().includes(r.toLowerCase()))return u.unshift(r),{lensMake:r,lensModel:l(e)}}return i.isNotEmpty(u)&&i.isNotEmpty(c)?{lensMake:u[0],lensModel:s.stripPrefixIgnoreCase(c[0],"unknown").trim()}:void 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(3),r=n(0),s=n(9),o=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|"),a=new RegExp(`[\\s\\.,_-]*(?:${o})[\\s\\.,_-]*$`,"i");function u(e,t,n=""){const i=e.replace(t,n);return i===e?e:u(i,t,n)}function l(e){const t=e.trim();return"gopro"===t.toLowerCase()?"GoPro":"benq"===t.toLowerCase()?"BenQ":"oneplus"===t.toLowerCase()?"OnePlus":t.length<4?t:t.toLowerCase().replace(/(?:^|\s|-)\S/g,e=>e.toUpperCase())}t.companyCased=l,t.make=function(e){return i.mapNotBlank(e,e=>e=l(e=u(e=s.stripQuotes(e),a).replace("LGE","LG")))};const c=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i],d=new Map([["Samsung",[[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]]],["LG",[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]]],["OnePlus",[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]]]]);t.model=function(e,t){if(i.blank(e)||i.blank(t))return;let n=s.stripQuotes(t);const o=r.map(d.get(e),e=>e.find(([e])=>null!=n.match(e)));return null!=o?o[1]:("Sony"===e&&(n=n.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"Î±").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V")),"Olympus"===e&&(n=r.mapOr(/^(.+?\d)mark(i.+?)$/i.exec(n),e=>`${e[1]} Mark ${e[2]}`,()=>n)),"Canon"===e&&(n=n.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel")),c.forEach(e=>n=u(n,e).trim()),n=n.replace(new RegExp(`^${e}\\s+`,"i"),""),null!=e.match(/^HP|Hewlett.Packard$/i)&&null!=n.match(/^hp\b/i)&&(n=n.slice(2).trim()),n)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(55),r=n(84);class s extends r.MultiMap{constructor(e){super(new i.TTLMap(e)),this.ttlMs=e,this.m=this.store}add(e,t){return this.m.touch(e),super.add(e,t)}}t.TTLMultiMap=s},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(34),s=n(131),o=n(1),a=n(3),u=n(6),l=n(2),c=n(0),d=n(5),h=n(10),f=n(15),p=n(8),m=n(17),g=n(81),y=n(20),v=n(29),b=n(4),w=n(14),S=n(16),M=n(39),P=n(11),E=n(9),x=n(25),_=l.lazy(()=>b.mkLogger("vlc"));t.vlcVersionDescription=l.lazy(()=>p.thenMapOr(t.vlcInfo().catch(()=>{}),e=>"version "+e.version,()=>"(not found)"));const F=/VLC version (\S+)/i,T=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"];function O(e){return i(this,void 0,void 0,(function*(){return p.thenMap(m.stdoutResult(e,[...T,"--version"],{timeout:x.cmdTimeoutMs,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),e=>f.Opt(e.result).filter(a.notBlank).map(e=>e.trim()).flatMap(e=>F.exec(e)).flatMap(e=>s.parse(e[1])).get())}))}function A(e){return p.thenMap(M.PowerShell.instance().execute(`(Get-Item -path ${M.pwshQuote(e)}).VersionInfo.FileVersion`,e=>e).catch(t=>{_().warn("Failed to run vlcInfoWin: "+e+": "+t)}),e=>c.denull(s.parse(e.trim())))}t.vlcInfo=l.lazy(()=>function(){return i(this,void 0,void 0,(function*(){const e=[P.Settings.vlcPath.valueOrDefault];function t(...t){e.push(v.PosixFile.for(r.join(...t)))}const n=[];if(S.isMac){const e="/Applications/VLC.app/Contents/MacOS/VLC";a.mapNotBlank(g.getEnv("HOME"),n=>t(n+e)),t(e)}if(S.isWin){const e=["VideoLAN","VLC","vlc.exe"];a.mapNotBlank(g.getEnv("LOCALAPPDATA"),n=>{t(n,"Apps",...e)}),a.mapNotBlank(g.getEnv("HOMEPATH"),n=>{t(n,"AppData","Local","Apps",...e)}),a.mapNotBlank(g.getEnv("ProgramFiles"),n=>{t(n,...e)}),a.mapNotBlank(g.getEnv("ProgramFiles(x86)"),n=>{t(n,...e)})}for(const t of e)try{if(t instanceof v.PosixFile&&(yield t.clear().notExists()))continue;const e=t.toString(),i=yield S.isWin?A(e):O(e);if(null==i){_().info("No VLC version found for "+t);continue}if(3===i.major&&0===i.minor)return h.tap({path:e,version:i},e=>_().info("VLC version found!",e));n.push({path:e,unsupportedVersion:i})}catch(e){_().warn("vlcInfo(): err:"+e,{path:t})}return n[0]}))}()),t.checkVlcInfo=function(){return i(this,void 0,void 0,(function*(){const e=yield t.vlcInfo.prior();return null!=e&&null!=e.version?e:yield t.vlcInfo.refresh()}))},t.isVlcSupported=function(){return i(this,void 0,void 0,(function*(){return!S.isArm&&(yield p.thenMapOr(t.vlcInfo(),e=>null!=e.version,()=>!1))}))},t.vlcPath=l.lazy(()=>p.thenMap(t.vlcInfo(),e=>null==e.version?void 0:e.path)),t.vlcFrame=function(e){var n;return i(this,void 0,void 0,(function*(){const i=yield t.vlcPath();if(a.blank(i))throw new Error(e.src+" is not supported (no vlc)");const r=E.stripPrefix(e.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(r))return _().throw("vlcFrame(): Invalid destination extension"+y.NonRetriableErrorFlag,{format:r,args:e});const s=null!==(n=e.startAtSec)&&void 0!==n?n:0,l=s+1,c=yield m.stdoutResult(i,o.compact([...T,"--avcodec-hw=none","--video-filter=scene","--scene-format="+r,"--scene-replace","--scene-ratio=500","--scene-path="+e.dest.dir,"--scene-prefix="+e.dest.name,"--start-time="+s.toFixed(1),"--stop-time="+l.toFixed(1),e.src.nativePath,"vlc://quit"]),{timeout:u.minuteMs,ignoreStderr:!0});if(e.dest.clear(),d.gt0(c.code))throw new Error("vlc failed: "+JSON.stringify(c));return c}))},t.vlcTranscode=function(e){return i(this,void 0,void 0,(function*(){const n=yield t.vlcPath();if(a.blank(n))throw new Error("vlc.transcode(): VLC is not installed, cannot transcode "+e.src);const i=o.compact(["vcodec=h264",w.mapGt0(e.videoBitrateKbps,e=>"vb="+e),w.mapGt0(e.width,e=>"width="+Math.floor(e)),w.mapGt0(e.height,e=>"height="+Math.floor(e)),"venc=x264{ref=2:me=hex:mixed_ref=0:chroma_qp_offset=0:b_adapt=1:direct=1:weightp=1:rc_lookahead=20}","acodec=mp4a","ab=128","channels=2","samplerate=44100","scodec=none","deinterlace"]).join(","),r=["access=file{overwrite}","mux=mp4","dst="+e.dest.base].join(",");return m.stdoutResult(n,[...T,"--no-repeat","--no-loop",e.src.fileuri(),`--sout=#transcode{${i}}:standard{${r}}`,"vlc://quit"],{cwd:e.dest.dir,timeout:e.timeoutMs,ignoreStderr:!0})}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(87);t.SquareMatrix=class{constructor(e,t=1){if(this.m=e,this.ary=t,this.rows=Math.sqrt(e.length/t),this.rows!=Math.floor(this.rows))throw new Error(`Only square tuple matrices are supported: ${1==this.ary?"":this.ary}(${this.rows}Ã${this.rows}) != ${e.length}`)}index(e,t){return this.ary*(t+e*this.rows)}swap(e,t){for(let n=0;n<this.ary;n++){const i=this.m[e+n];this.m[e+n]=this.m[t+n],this.m[t+n]=i}}transpose(){for(let e=0;e<this.rows;e++)for(let t=e+1;t<this.rows;t++)this.swap(this.index(e,t),this.index(t,e));return this}reverseRows(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(t,e),this.index(this.rows-1-t,e));return this}reverseCols(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(e,t),this.index(e,this.rows-1-t));return this}reverse(){const e=Math.pow(this.rows,2);for(let t=0;t<e/2;t++)this.swap(t,e-1-t);return this}rotate(e){switch(i.normalizeRotation(e)){case 0:break;case 90:this.transpose(),this.reverseCols();break;case 180:this.reverse();break;case 270:this.transpose(),this.reverseRows();break;default:throw new Error("unsupported rotate("+e+")")}return this}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(5),s=n(12),o=n(76),a=n(41);function u(e,t,n,i){const r=Math.floor(Math.max(0,t.row)),s=Math.ceil(Math.min(e.row,n.row)),o=Math.floor(Math.max(0,t.col)),a=Math.ceil(Math.min(e.col,n.col));for(let t=r;t<s;t++)for(let n=o;n<a;n++)i(t*e.col+n)}function l(e,t,n,i){let s=0;return u(t,n,i,t=>r.mapFinite(e[t],e=>s+=e*e)),Math.sqrt(s)}function c(e,t,n,i){const s=[];return u(t,n,i,t=>r.mapFinite(e[t],e=>s.push(e))),a.mode(s)}t.vecXvec=function(e,t){return e.map((e,n)=>e*t[n])},t.matXvec=function(e,t){return e.map((e,n)=>{if(e.length!==t.length)throw new Error("misshaped matrix on row "+n);return a.sum(e.map((e,n)=>e*t[n]))})},t.slice=function(e,t,n){const r=Math.max(0,t.row),s=Math.min(e.length,n.row),o=Math.max(0,t.col),a=Math.min(e[0].length,n.col);return i.range(r,s,t=>e[t].slice(o,a))},t.index1D=function(e,t,n){return t*e.col+n},t.submatrixForEach=u,t.submatrixMagnitude=l,t.subMatrixMode=c,t.leastQuarter=function(e,t){const n=t.col,i=t.row,r=[l(e,t,{col:n/2,row:0},{col:n,row:i/2}),l(e,t,{col:0,row:0},{col:n/2,row:i/2}),l(e,t,{col:0,row:i/2},{col:n/2,row:i}),l(e,t,{col:n/2,row:i/2},{col:n,row:i})];return s.leastIndex(r)},t.greatestHalf=function(e,t){const n=t.col,i=t.row,r=[c(e,t,{col:0,row:0},{col:n,row:i/2}),c(e,t,{col:0,row:0},{col:n/2,row:i}),c(e,t,{col:0,row:i/2},{col:n,row:i}),c(e,t,{col:n/2,row:0},{col:n,row:i})];return s.greatestIndex(r)},t.submatrixCollect=function(e,t,n){const i=[];return u(e,t,n,e=>i.push(e)),i},t.modeReduce=function(e,t,n){const a=Math.floor(t.col/n.col),l=Math.floor(t.row/n.row),c=new o.Average(Math.ceil(a*l));return s.concat(...i.stepRange(0,t.row,l,n=>i.stepRange(0,t.col,a,i=>(c.clear(),u(t,{col:i,row:n},{col:i+a,row:n+l},t=>r.mapFinite(e[t],e=>c.push(e))),c.sampleMode))))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(42),r=n(1),s=n(10);function o(e){return r.includes(["number","string"],typeof e)}t.isDbValue=o,t.isDbValued=function(e){return null!=e&&s.entries(e).every(([,e])=>o(e))},t.toDbValued=function(e){return s.mapFields(e,(e,t)=>{if(!e.startsWith("$"))return"boolean"==typeof t?[e,t?1:0]:o(t)?[e,t]:i.isDated(t)?[e,i.datedToMillis(t)]:void 0})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(12),r=n(4),s=n(41),o=n(1),a=n(0),u=n(5),l=n(51),c=n(104);t.AssetStream=class{constructor(e,t,n){this.tags=e,this.before=t,this.after=n,this.logger=()=>r.mkLogger("TaggedAssetStream("+this.toString()+")")}toString(){return this.tags.map(e=>e.path.join("")).join(",")}valueOf(){return this.toString()}mergeWith(e){this.logger().info("mergeWith()",{tas:e,beforeIds:this.before.map(e=>e.id),afterIds:this.after.map(e=>e.id)}),e.tags.forEach(e=>o.insertUniq(this.tags,e,c.Tag.cmp)),e.before.forEach(e=>o.insertUniq(this.before,e,(e,t)=>l.cmp([t.capturedAtLocal,t.id],[e.capturedAtLocal,e.id]))),e.after.forEach(e=>o.insertUniq(this.after,e,(e,t)=>l.cmp([t.capturedAtLocal,t.id],[e.capturedAtLocal,e.id]))),this.logger().info("mergeWith() complete",{tas:e,tags:this.tags.map(e=>e.path),beforeIds:this.before.map(e=>e.id),afterIds:this.after.map(e=>e.id)})}toApi(){return{tags:this.tags.map(e=>e.toApiTag()),assetIdsBefore:this.before.map(e=>e.toID()),assetIdsAfter:this.after.map(e=>e.toID())}}streamCoeff(e){return this.logger().tap({level:"info",msg:"streamCoeff",meta:{this:this.tags.map(e=>e.path),tas:e.tags.map(e=>e.path)},result:s.avg([i.diceCoeff(this.before,e.before,e=>e.id),i.diceCoeff(this.after,e.after,e=>e.id)])})}},t.coalesceStreams=function(e){const t=[];for(const n of e)a.mapOr(i.greatestBy(t,e=>u.gtOrElse(e.streamCoeff(n),.75)),e=>{e.mergeWith(n)},()=>{t.push(n)});return t}},function(e,t){e.exports=require("deep-eql")},function(e,t){e.exports=require("he")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(44),r=n(108),s=n(109),o=n(27),a=n(16);t.cacheDir=function(){return a.isWin?o.resolve(r.appData(),"..","Local","Temp",s.AppName):a.isMac?o.resolve(i.homedir(),"Library","Caches",s.AppName):o.resolve(i.homedir(),".cache",s.AppName)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(131),r=n(2),s=n(61);t.Version=r.lazy(()=>i.parse(s.version)),t.isAlphaVersion=r.lazy(()=>s.version.includes("-alpha")),t.isBetaVersion=r.lazy(()=>s.version.includes("-beta")),t.channel=r.lazy(()=>t.isAlphaVersion()?"alpha":t.isBetaVersion()?"beta":"latest")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(7);t.isSafari=function(e){return i.toS(e).includes(" Safari/")},t.isChrome=function(e){return i.toS(e).includes(" Chrome/")},t.isFirefox=function(e){return i.toS(e).includes(" Firefox/")}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(184),s=n(18),o=n(61),a=n(0),u=n(185);t.CLI=class{constructor(e,t){this.serviceName=e,this.args=t,this.plugins=[]}add(...e){return this.plugins.push(...e),this}parse(){return i(this,void 0,void 0,(function*(){let e=u.addFooter(r.program.version(o.version,"--version").description(u.CliDesc[this.serviceName]));a.map(this.args,t=>{e=e.arguments(t)});for(const t of this.plugins)e=t.beforeParse(e);e.parse(s.argv);for(const t of this.plugins)yield t.afterParse(e);return e}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(33);t.asPromise=function(e){return i(this,void 0,void 0,(function*(){return r.isFunction(e)?e():e}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0);t.Elapsed=class{constructor(e,t){this.l=e,this.listener=t,this.ts=Date.now()}elapsed(e){const t=Date.now(),n=t-this.ts;this.ts=t,i.map(this.listener,t=>t(e,n)),n>2&&this.l.log(n>500?"warn":n>100?"info":"debug",e,n)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(10);class r{constructor(e=1e3,t=!1){if(this.maxSize=e,this.fifo=t,this.delegate=new Map,this.expireListeners=[],e<1)throw new Error("maxSize must be positive")}get size(){return this.delegate.size}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}entries(){return this.delegate.entries()}forEach(e){this.delegate.forEach(e)}get(e){if(this.delegate.has(e)){const t=this.delegate.get(e);return this.fifo||(this.delegate.delete(e),this.delegate.set(e,t)),t}}getOrSet(e,t){return this.delegate.has(e)?this.get(e):i.tap(t(),t=>this.set(e,t))}has(e){return this.delegate.has(e)}keys(){return this.delegate.keys()}set(e,t){return this.delegate.set(e,t),this.vacuum(),this}values(){return this.delegate.values()}[Symbol.iterator](){return this.entries()}on(e,t){this.expireListeners.push(t)}vacuum(){if(this.delegate.size>this.maxSize)for(const[e,t]of this.delegate)if(this.delegate.delete(e),this.expireListeners.forEach(n=>n(e,t)),this.delegate.size<=this.maxSize)return}}t.MRUMap=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(7),s=n(9);t.describeError=function(e){const t=s.stripSuffix(r.toS(e).trim().toUpperCase(),":");return i.mapOr(o[t],e=>e.description,()=>e)};const o=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}})},function(e,t){e.exports=require("events")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),s=n(1),o=n(3),a=n(6),u=n(2),l=n(0),c=n(5),d=n(10),h=n(49),f=n(19),p=n(7),m=n(24),g=n(8),y=n(17),v=n(21),b=n(71),w=n(63),S=n(4),M=n(16),P=n(39),E=u.lazy(()=>S.mkLogger("Ps"));function x(e){return null!=e&&c.gt0(e.pid)&&null!=e.start&&o.notBlank(e.cmd)}function _(e){return i(this,void 0,void 0,(function*(){const t=f.toA(e).filter(c.gt0);if(s.isEmpty(t))throw new Error("Invalid pids: "+JSON.stringify(e));return h.thenTap(g.thenMap(M.isWin?function(e){return i(this,void 0,void 0,(function*(){if(m.ending()||P.PowerShell.instance().ended)return C(e);const t=[T,"-Id",A(e),"-ErrorAction SilentlyContinue",O].join(" ");return g.thenMap(P.PowerShell.instance().executeJsonToA(t),e=>F(e))}))}(t):function(e){return i(this,void 0,void 0,(function*(){return I((yield y.stdoutResult("ps",["-p",A(e),"-wwwo","pid,lstart,command"],Object.assign(Object.assign({},k),{ignoreExitCode:!0}))).result)}))}(t),e=>e.filter(e=>x(e)&&t.includes(e.pid))),e=>E().debug("pidInfo()",{pids:t,result:e}))}))}function F(e){return e.map(e=>({pid:e.Id,start:v.pwshJsonDate(e.StartTime),cmd:e.ProcessName}))}t.ps=function(){return i(this,void 0,void 0,(function*(){const e=yield M.isWin?function(){return i(this,void 0,void 0,(function*(){if(m.ending()||P.PowerShell.instance().ended)return C();const e=yield P.PowerShell.instance().executeJsonToA([T,O].join(" "));return null==e?C():F(e)}))}():function(){return i(this,void 0,void 0,(function*(){return I(yield y.stdout("ps",["-ewwwo","pid,lstart,command"],k))}))}();return l.orElse(s.sortBy(e.filter(x),e=>e.pid),[])}))},t.pidInfo=function(e){return i(this,void 0,void 0,(function*(){return g.thenMap(_([e]),t=>f.toA(t).find(t=>t.pid===e))}))},t.pidInfos=_;const T="Get-Process",O="| Select-Object -Property Id,ProcessName,StartTime";function A(e){return s.uniq([...e.filter(c.gt0),r.pid]).join(",")}const k={maxBuffer:1048576,timeout:15*a.secondMs,ignoreExitCode:!0,ignoreStderr:!0},D=["CommandLine","CreationDate","ProcessId"];function C(e){return i(this,void 0,void 0,(function*(){const t=["process"];if(s.isNotEmpty(e)){const n=s.uniq([...e.filter(c.gt0),r.pid]).map(e=>"ProcessId="+e).join(" or ");t.push("where",n)}t.push("get",D.join(","));const n=yield y.stdoutResult(w.wmic(),t,k);return d.onlyReqValued(b.parseFixed(D,n.result).map(e=>({pid:c.toInt(e.ProcessId,{defaultValue:-1}),start:v.wmiDate(e.CreationDate),cmd:p.toS(e.CommandLine)})))}))}function I(e){return b.parseFixed(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],e).map(e=>({pid:c.toInt(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:p.toS(e.COMMAND)}))}t.psWinWmic=C},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(152),r=n(2).lazy(()=>i.inflateSync(Buffer.from(["eJw9lgkWoyoQRTfEpkophchgM8SY1f9bpvufExGVQA2XV1zFyVKd9O7WmZ2PH6etOn0nt8nutnq","4ba5ch9vrwuW5brdP+vfpQny7eKh7yelecef6uuM43MFcxyUu6del7l3hW4mnO1XdWTNXdef0ru","vHjTjcKMPN9XCXLO6qO9fprrG5z1jd5/Nxd/TYaYYu1ktJnBRJNLM7aZkPratbZLGmbW6pZafB5","GUm3k0e1yBvmkkvseZaWXCttbi1Yf46scHLXmlycV6tFxnizUEfCz2b1NeTx8YsfubF+Zuvm7Th","toRTm3mxK27vWqLb43kSsGrRa+L2VtUFeUWaU1xQzA2qC01KLlQcDFU7TbZeU4J7EV2b7xV7tvg","SYDPoMIMOc+EwFw5z4TAXDjMoKVOlmG+XJXeXdQSXzZkc0+Zy3SrNwde58Wh/K/KNrpilZXqlYZ","badnGnHJHmJmHKBKd667W3OwNQnJFZzphJbYShM354rOHJcKFpNC2uJBtXT5v0nDZujur+zJhdU","7zsK6x1A7AH6wXSQ/N13UDqRlJPJK+nyYesDMnWO5m5/9FAMxlisR+CR0NI1JDm3VAZRlh3wyI0","pr27ePeOSwM3gnjpADpb8gqGndn3sbDf9lWWCVjS9mhkpdTdEscaYEsewtbA+7oLFAVLyRqqeLA","irSCFE+DUiJHXXI2qd0zAlAiiFs3i9DF9kyHBbbqS/E0T82+ELoITNNPu6aZ92JIFnvdYvpVdGE","naftcTWsQ/WGUBH6mMCbWwbqhdmws4Rf/OWlz0sQ4XCzTTvmaBL5yk7U97qYcz5nOHrEaVbLFB2","WCvHo9Hx7Ni0m6QPfOnuYB3mhaHdBfsz/xLXN53vmYwhbXaWLHoir4U3a298xlgy3ugkYKFpxbr","E1UBD9XNNbE3XXzstJkVO2+AgogVmGl6oSLmV9cTq3p44Inmbz8sgz3Vk34WoterR316rYM3LAx","6sMybc9rIITvcaB8KLtWguSyn82iAMVle3Ltm5n/P9BZ4kR7cFXe2yRUTOZKmFW1aVAp+L1EeVO","Ju+rokLOBWg6211P6gM58ILfczcmUET2uNg1SsNWeoW2sxo72EzDcfvSe5vuIJAnXrZmjIj5z1s","D206YjYtUX8AJ4EqEgUsxg4cpvm7i2W3QDKNud+SUw8XWq3wL4hUUHb+UiRN/QDysDIuKR6TbBh","OWOo2+2Q0Y2T+LhysJCpP8oCuiki2CZFj2Mp/pmVW0V/gYO9VRAimfzAI9lkuZK1hCY1b+R8Ee5","J6RhWJUp6VjijbiYk1QLK7ZGfJiv+IifrmKYqOLtz040/NH20oMVlUbs9s7SYX5SHxs5A4Hp5Et","BH3DbQGPOkzvRLcBf5KGb8qA354NaN+ElsydFb2IpkX1F7RTu+32jC0bDRfcm7laxmGgIG5CGaZ","kh/zFnkWyvivOB2xOUlTSUhkJEsXG6BQOoCiGxbJBPLHCObzkhrEz1fU92tVvp4PoLpbTi7dm8q","z55nn5iHIfan1IU6nsr2ImrG40vbURHLV8yb8fICRfx1R6j8EvnMSFrn3ruNT/Gtxk6qb2qj5S3","88jeTDOS84NcdKA5Ii9l/JrkXzgqNvbviX5P9sa8jjUUJcriT2dVnXKO3HRfPxPzzJCHU0wtUB/","m6TA/xRzYKiVWVZbb2zLRK1jQoqSuM9yc29TRrbNO0EkwF13vRZmZ7UFjtk2edX2GfiJFNuKEHl","hM6s/WaTV/f+gumJcOivNfyFfYxnVGfch2LxdsCGV+vyFnDHf/MOEo13omZnF7YLFRgoQCxaJG2","1kHdqvZ3YkIdreUJbKuzeL3RpFKv5ZGrYfsU3/t9hphIxhArLRg2Ai4kjlQjQDmxcrOsSQdKMc+","/hi1xnS3WaaJDjb+tlixGxzAuPIubxhancQ/DiptT4PgFUD9IK7LKuaZNKp4cJh7sgUVgLUhs92","NikLQxJ3lKFD71O/UksylWaqun1+JrclRDkT+/H3rMcUYXq/OJvEe2F/qLIgxUiO1Fvh8Pb4JcL","wvnMr0P8rz0KnjXKhXcq/7fjYKM/wbUfYebm9RvT+xIrqe6KHKC4xw9BJ2JOYqdTKqJveBkr6Vu","v8r+5cz2d7Jt+l3PnyjvSb7qUcZpIlXL2kzT7BBCRDFrZ8XBAXEqiUaQxlWZ73pOcTICqdFuoHF","CaCjVQb0wUZmlaKqbbSqqn7QEk3AEMu/IoaNYvo6nhhouNoyjLTyx5Zp2Fn+0uP8HaKKA+A=="].join(""),"base64")).toString().split(","));t.isCussy=function(e){const t=e.toLowerCase().replace(/[^a-z]/gi,"");return r().some(e=>t.includes(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(153),r=n(48);class s extends i.Writable{constructor(e){super(e),this.deferred=new r.Deferred("WritableToBuffer"),this._buf=[],this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",e=>{this.deferred.reject(e)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,t,n){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,t)),n()}}t.WritableToBuffer=s},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});t.CompoundLogger=class{constructor(e,...t){if(this.primary=e,null==e)throw new Error("null primary logger");this.delegates=[e,...t]}enabled(e,t){return this.primary.enabled(e,t)}log(e,t,n,i){this.enabled(e,t)&&this.delegates.forEach(r=>r.log(e,t,n,i))}flush(){return i(this,void 0,void 0,(function*(){yield Promise.all(this.delegates.map(e=>e.flush()))}))}close(){this.delegates.forEach(e=>e.close())}}},function(e,t){e.exports=require("@iarna/toml")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0);t.debounce=function(e,t){let n,r=[];const s=(...s)=>{r=s,i.map(n,global.clearTimeout),n=global.setTimeout(()=>e(...r),t)};return s.reset=()=>{i.map(n,global.clearTimeout),n=void 0},s.now=()=>{s.reset(),e()},s}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(2),o=n(0),a=n(8),u=n(17),l=n(57),c=n(31),d=n(25),h=/^([a-z0-9\/ -_]+) on (.+?) \((.+)\)$/i;function f(){return i(this,void 0,void 0,(function*(){const e=yield u.stdout("mount",[],{timeout:d.cmdTimeoutMs});return r.compact(e.split("\n").map(e=>o.map(h.exec(e),e=>{const[t,n,i]=e.slice(1);return{filesystem:t,mountpoint:n,options:i.split(",").map(e=>e.trim())}})))}))}function p(e){return i(this,void 0,void 0,(function*(){const t=c.BaseFile.for(e),n=yield a.thenMapOr(yield t.childNames(),e=>e.filter(e=>!e.startsWith(".")).map(e=>e.toLowerCase()).sort(),()=>[]);return l.eql(n,["applications","photostructure.app"])}))}t.mounts=f,t.ignorableMacFilesystems=s.lazy(()=>i(void 0,void 0,void 0,(function*(){return a.asyncFilter(yield f(),e=>i(void 0,void 0,void 0,(function*(){return e.options.includes("nobrowse")||e.options.includes("quarantine")||(yield p(e.mountpoint))}))).then(e=>e.map(e=>e.filesystem))})),d.mountpointsTtlMs),t.isInstallDmg=p},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(0),o=n(8),a=n(118),u=n(117);t.mountpointsPosix=function(){return i(this,void 0,void 0,(function*(){const e=yield o.thenMap(a.dfPosixRaw(!1),e=>r.compactBlanks(e.map(e=>e.mountpoint)));if(null!=e&&(yield u.isGioSupported())){const t=yield u.gioVolumes();e.push(...t.map(e=>e.mountpoint))}return s.map(e,e=>e.filter(e=>!e.startsWith("/snap/")&&"/dev"!==e))}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(6),o=n(2),a=n(64),u=n(17),l=n(63),c=n(39),d=n(25),h=/\s([A-Z]:\\)/g;t.mountpointsWin=o.lazy(()=>i(void 0,void 0,void 0,(function*(){return a.thenOpt(c.PowerShell.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(e=>e.map(e=>e.Root)).filter(r.isNotEmpty).orElse(()=>t.mountpointsWinFsutil()).map(e=>e.sort()).getRequired()})),d.mountpointsTtlMs),t.mountpointsWinFsutil=o.lazy(()=>i(void 0,void 0,void 0,(function*(){const e=(yield u.stdout(yield l.fsutil(),["fsinfo","drives"],{timeout:10*s.secondMs})).trim(),t=[];let n;for(;null!==(n=h.exec(e));)t.push(n[1]);return t})),d.mountpointsTtlMs)},function(e,t){e.exports=require("punycode")},function(e,t){e.exports=require("dns")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(6),o=n(5),a=n(15),u=n(7),l=n(77),c=n(17),d=n(63),h=n(16);t.ping=l.memoize(e=>i(void 0,void 0,void 0,(function*(){const t=h.isWin?yield d.pingWin():"ping";return c.stdout(t,[h.isWin?"-n":"-c","1",e],{timeout:5*s.secondMs})})),5*s.minuteMs,255),t.ipv4Re=new RegExp("\\b"+o.times(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),t.ipAddrFromPing=l.memoize(e=>i(void 0,void 0,void 0,(function*(){return a.Opt(yield t.ping(e).catch(e=>{console.warn("failed to ping: "+e)})).filter(r.notBlank).flatMap(e=>t.ipv4Re.exec(u.toS(e))).map(e=>e[0]).get()})),5*s.minuteMs,255)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(50),s=n(8),o=n(118),a=n(117),u=n(35),l=n(25),c=r.keyedLazy("localMountpoints",u.mountsCacheKey,()=>s.thenMap(o.dfPosixRaw(!0),e=>e.map(e=>e.mountpoint)),{maxRetries:2,timeoutMs:l.cmdTimeoutMs,priorResultTtlMs:l.longTtlMs});t.dfPosix=r.keyedLazy("dfPosix",u.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=yield o.dfPosixRaw(!1);if(null!=e)return yield s.thenMap(c(),t=>{e.forEach(e=>{e.remote=!t.includes(e.mountpoint)})}),(yield a.isGioSupported())&&(yield s.thenMap(a.gioVolumes(),t=>e.push(...t))),e}))}),{maxRetries:2,timeoutMs:l.cmdTimeoutMs,priorResultTtlMs:l.dfTtlMs})},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(0),o=n(5),a=n(50),u=n(20),l=n(13),c=n(4),d=n(39),h=n(9),f=n(232),p=n(35),m=n(157),g=n(25),y=c.mkLogger("DfWin");function v(){return i(this,void 0,void 0,(function*(){const e=yield d.PowerShell.instance().executeJsonToA(t.LocalAndNetCmd).catch(e=>{u.onError("_localAndNet(): PowerShell failed, trying wmic",e)});return null==e?f._localAndNet():e.map(e=>Object.assign({mountpoint:e.Root,filesystem:"",label:e.Description,size:e.Used+e.Free,used:e.Used,available:e.Free,remote:r.notBlank(e.DisplayRoot)},s.map(m.parseRemoteName(e.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))))}))}function b(){return i(this,void 0,void 0,(function*(){const e=yield d.PowerShell.instance().executeJsonToA(t.LocalCmd);return null==e?f._local():e.filter(e=>r.notBlank(e.DriveLetter)&&(r.notBlankAnd(e.HealthStatus,e=>h.equalsIgnoreCase(e,"Healthy"))||r.notBlankAnd(e.OperationalStatus,e=>h.equalsIgnoreCase(e,"OK")))).map(e=>({mountpoint:e.DriveLetter+":\\",filesystem:e.FileSystem,label:e.FileSystemLabel,size:e.Size,used:e.Size-e.SizeRemaining,available:e.SizeRemaining,remote:!1}))}))}t.dfWin=a.keyedLazy("dfWin",p.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){return(yield v().catch(e=>(y.warn("_localAndNet timed out, using local volumes.",e),b()))).filter(e=>r.notBlank(e.mountpoint)&&o.gt0(e.size))}))}),{maxRetries:2,timeoutMs:g.cmdTimeoutMs,priorResultTtlMs:g.dfTtlMs}),l.onClearCache(()=>t.dfWin.clear()),t.LocalAndNetCmd="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free",t._localAndNet=v,t.LocalCmd="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus",t._local=b},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(5),o=n(12),a=n(50),u=n(17),l=n(71),c=n(63),d=n(4),h=n(14),f=n(9),p=n(35),m=n(25);t.REMOVABLE_DISK=2,t.LOCAL_DISK=3,t.NETWORK_DRIVE=4;const g=d.mkLogger("DfWinWmic");t.dfWin=a.keyedLazy("dfWin",p.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){return(yield v().catch(e=>(g.warn("_localAndNet timed out, using local volumes.",e),w()))).filter(e=>o.allNotBlank([e.mountpoint,e.filesystem])&&e.size>0)}))}),{maxRetries:2,timeoutMs:m.cmdTimeoutMs,priorResultTtlMs:m.dfTtlMs});const y="LOGICALDISK get DeviceID,DriveType,FileSystem,FreeSpace,Size,VolumeName /format:table".split(" ");function v(){return i(this,void 0,void 0,(function*(){const e=c.wmic(),n=yield u.stdout(e,y,{timeout:m.cmdTimeoutMs});return S(l.parseFixed(["DeviceID","DriveType","FileSystem","FreeSpace","Size","VolumeName"],n,!1).map(e=>{const n=r.mapNotBlank(e.DeviceID,e=>f.ensureSuffix(e,"\\")),i=e.FileSystem,o=e.VolumeName,a=s.toInt(e.Size,{defaultValue:0}),u=s.toInt(e.FreeSpace,{defaultValue:0});return{mountpoint:n,filesystem:i,label:o,size:a,used:a-u,available:u,remote:s.toInt(e.DriveType,{defaultValue:t.LOCAL_DISK})===t.NETWORK_DRIVE}}))}))}t._localAndNet=v;const b="VOLUME get Capacity,DriveLetter,FileSystem,FreeSpace,Label /format:table".split(" ");function w(){return i(this,void 0,void 0,(function*(){const e=c.wmic(),t=yield u.stdout(e,b,{timeout:m.cmdTimeoutMs});return S(l.parseFixed(["Capacity","DriveLetter","FileSystem","FreeSpace","Label"],t,!1).map(e=>{const t=r.mapNotBlank(e.DriveLetter,e=>f.ensureSuffix(e,"\\")),n=e.FileSystem,i=e.Label,o=s.toInt(e.Capacity,{defaultValue:0}),a=s.toInt(e.FreeSpace,{defaultValue:0});return{mountpoint:t,filesystem:n,label:i,size:o,used:o-a,available:a,remote:!1}}))}))}function S(e){return e.filter(e=>o.allNotBlank(e.mountpoint,e.filesystem)&&h.gte(e.size,0))}t._local=w},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(0),o=n(50),a=n(17),u=n(75),l=n(9),c=n(35),d=n(25);t.addLocalVolumeInfoMac=function(e){return i(this,void 0,void 0,(function*(){const n=yield t.mnt2uuidMac();if(null!=n)return e.forEach(e=>{s.map(n.get(e.mountpoint),t=>{e.uuid=t.uuid,e.label=t.label})}),e}))},t.mnt2uuidMac=o.keyedLazy("mnt2uuidMac",c.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=(yield a.stdout("diskutil",["info","-all"],{timeout:d.cmdTimeoutMs})).split(/^\s*\*{3,}\s*$/m);return u.toMap(e,e=>{const t=u.toMap(e.split(/\s*\n+\s*/),e=>{const[t,n]=e.split(":").map(e=>e.trim());return l.includesIgnoreCase(["not applicable","no file system"],n)?void 0:[t.toLowerCase(),n]}),n=t.get("mount point"),i=t.get("volume name"),s=t.get("volume uuid");return r.blank(n)?void 0:[n,{label:i,uuid:s}]})}))}),{maxRetries:2,timeoutMs:d.cmdTimeoutMs,priorResultTtlMs:d.longTtlMs})},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(0),o=n(7),a=n(50),u=n(17),l=n(235),c=n(35),d=n(25);t.addLocalVolumeInfoPosix=function(e){return i(this,void 0,void 0,(function*(){const t=yield h();if(null!=t)return e.forEach(e=>{t.ignorablePaths.includes(e.mountpoint)?e.ignorable=!0:s.map(t.mnt2info.get(e.mountpoint),t=>{e.uuid=t.uuid,e.label=t.label})}),e}))};const h=a.keyedLazy("volumeInfoLinux",c.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=yield u.stdout("lsblk",["-P","--output","mountpoint,label,uuid"],{timeout:d.cmdTimeoutMs}),t=new Map,n=[];return e.split(/[\r\n]+/).forEach(e=>{s.map(l.parseEnvTokens(e),e=>{o.toS(e.mountpoint).startsWith("/")&&(r.blank(e.uuid)?n.push(e.mountpoint):t.set(e.mountpoint,e))})}),{mnt2info:t,ignorablePaths:n}}))}),{maxRetries:2,timeoutMs:d.cmdTimeoutMs,priorResultTtlMs:d.longTtlMs})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseEnvTokens=function(e){const t=/([a-z]+)="(.*?)"/gi,n={};let i;for(;null!=(i=t.exec(e));){const[,e,t]=i;n[e.toLowerCase()]=t}return n}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(6),o=n(0),a=n(50),u=n(17),l=n(13),c=n(63),d=n(75),h=n(39),f=n(9),p=n(35),m=n(25);function g(){return i(this,void 0,void 0,(function*(){const e=yield c.fsutil(),t=yield u.stdout(e,["volume","list"],{timeout:7*s.secondMs}),n=new Map;let i;const r=/^\\\\.+\{([a-z0-9-]+)\}\\[\r\n]+([a-z]:\\)/gim;for(;null!=(i=r.exec(t));){const e=i[1],t=i[2];n.set(t,e)}return n}))}t.addLocalVolumeInfoWin=function(e){return i(this,void 0,void 0,(function*(){const t=yield y();if(null!=t)return e.forEach(e=>{o.map(t.get(e.mountpoint),t=>{e.remote=!1,e.uuid=t})}),e}))},t.UuidCmd="Get-Partition | Select-Object -Property DriveLetter,Guid,IsOffline",t._mnt2uuidWinFsutil=g;const y=a.keyedLazy("mnt2uuidWin",p.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=yield h.PowerShell.instance().executeJsonToA(t.UuidCmd);return null==e?g():d.toMap(e.filter(e=>r.notBlank(e.DriveLetter)&&!e.IsOffline&&r.notBlank(e.Guid)),e=>[e.DriveLetter+":\\",f.stripPreSuff(e.Guid,"{","}")])}))}),{maxRetries:2,timeoutMs:m.cmdTimeoutMs,priorResultTtlMs:m.longTtlMs});l.onClearCache(()=>y.clear())},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),s=n(7),o=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i;t.addRemoteVolumeInfoPosix=function(e){return i(this,void 0,void 0,(function*(){return e.filter(e=>e.remote).forEach(e=>{r.map(o.exec(s.toS(e.filesystem)),t=>{e.remoteHost=t[1],e.remoteShare=t[2]})}),e}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(2),o=n(8),a=n(23),u=n(29),l=n(4),c=n(239),d=s.lazy(()=>l.mkLogger("VolumeUUID"));t.volumeUUID=function(e){return i(this,void 0,void 0,(function*(){if(a.isTrue(e.ignorable))return d().info("volumeUUID(): ignorable is true for "+e.mountpoint),e.uuid;if(a.isFalse(e.remoteOK))return d().info("volumeUUID(): remoteOK is false for "+e.mountpoint),e.uuid;const t=u.PosixFile.for(e.mountpoint).join(".uuid");if(yield t.isNonEmptyFile(32)){const n=yield o.thenMap(t.readFile(),e=>e.toString().trim());if(r.notBlank(n))return d().info("readUuid(): Got UUID for "+e.mountpoint+" from "+t,{uuid:n}),e.uuid=n,n}const n=r.notBlankOr(e.uuid,c.mkuuid);return(yield t.writeTxt(n))?(e.uuid=n,d().info("volumeUUID(): Saved new UUID for "+e.mountpoint,{uuid:n})):d().warn("volumeUUID(): Failed to save new UUID for "+e.mountpoint),e.uuid}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(112),r=n(2);t.mkuuid=function(){const e=i.randomBytes(16);e[6]=15&e[6]|64;const t=e.toString("hex");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20)].join("-")},t.UUIDRegExp=r.lazy(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(10),s=n(7),o=n(23),a=n(60);function u({logger:e,name:t,result:n}){const i=null==n?"warn":"debug";e.enabled(i)&&e.log(i,a.darkGrey(t)+": "+(!0===n?a.green:a.red)(s.toS(n)))}t.orLogged=function(e,t){return e.some(e=>r.keys(e).some(n=>o.isTrue(r.tap(e[n](),e=>u({logger:t,name:n,result:e})))))},t.orLoggedAsync=function(e,t){return i(this,void 0,void 0,(function*(){for(const n of e)for(const e of r.keys(n)){const i=yield n[e]();if(u({logger:t,name:e,result:i}),i)return i}return!1}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(45),s=n(0),o=n(12);t.SetSet=class{constructor(){this.store=new Map}add(e,...t){r.getOrSet(this.store,e,()=>new Set).add(t)}find(e){for(let t=0;t<e.length-1;t++){const n=s.map(this.store.get(e[t]),n=>{const r=e.slice(t+1),s=[...n].filter(e=>i.startsWith(r,e));return o.greatestBy(s,e=>e.length)});if(i.isNotEmpty(n))return[e[t],...n]}}has(e){return null!=this.find(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(9);t.seemsRecursive=function(e,t=7){return i.compactBlanks(e).some(n=>i.count(e,e=>r.equalsIgnoreCase(n,e))>t)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6),s=n(2),o=n(19),a=n(133),u=n(17),l=n(71),c=n(4),d=n(16),h=n(27),f=c.mkLogger("Snap");t.ignorableSnapDir=a.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){if(!d.isLinux||!(yield t.hasSnap()))return!1;const n=h.pathnames(e.nativePath).indexOf("snap");return!(n<0)&&o.toA(yield t.snaps()).includes(h.pathnames[n+1])}))),t.hasSnap=s.lazy(()=>i(void 0,void 0,void 0,(function*(){try{return yield u.stdout("snap",["--version"],{timeout:10*r.secondMs}),!0}catch(e){return!1}}))),t.snaps=s.lazy(()=>i(void 0,void 0,void 0,(function*(){try{return yield l.parseFixed(["Name","Version"],yield u.stdout("snap",["list"],{timeout:10*r.secondMs})).map(e=>e.Name)}catch(e){return f.warn("snap failed",e),[]}})),30*r.secondMs)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(6),r=n(19),s=n(13),o=new(n(201).TTLMultiMap)(10*i.minuteMs);function a(e){return[e.toString(),...r.toA(o.get(e.toString()))]}s.onFileCopied((e,t)=>{o.add(e,t),o.add(t,e)}),t.sameNativePaths=a,t.getOrSetByNativePath=function(e,t,n){for(const t of a(e)){const e=n.get(t);if(null!=e)return e}const i=t(e);return n.set(e.toString(),i),i}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6),s=n(2),o=n(87),a=n(8),u=n(17),l=n(13),c=n(134),d=n(4),h=n(16),f=n(125),p=h.isWin?"NUL":"/dev/null",m=s.lazy(()=>d.mkLogger("jpegtran"));function g(e,t,n){return i(this,void 0,void 0,(function*(){const i=yield c.jpegtranNativePath();if(!o.isRotation(n))throw new Error("refusing to rotate("+e+", "+n+")");yield u.stdout(i,["-copy","all","-trim","-rotate",n.toFixed(0),"-outfile",t.nativePath,e.nativePath],{timeout:r.minuteMs})}))}t.validJpeg=function(e){return i(this,void 0,void 0,(function*(){const t=yield c.jpegtranNativePath();yield u.stdoutResult(t,["-outfile",p,e.nativePath],{timeout:30*r.secondMs})}))},t.rotateInPlace=function(e,t){return i(this,void 0,void 0,(function*(){const n=e.wip();m().info("rotateInPlace("+e+")",t),yield g(e,n,t),yield n.unwip(),l.emitFileChanged(e.nativePath)}))},t.rotate=g,t.rotateToImgTmp=function(e,t){return i(this,void 0,void 0,(function*(){return null==t||0===t?e:a.thenMap(f.cachedImgFile(e,"r"+t,e.ext),n=>n.applyIfEmpty(n=>g(e,n,t)))}))}},function(e,t){e.exports=require("net")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),s=n(176),o=n(20),a=n(13),u=n(31),l=n(114),c=n(42),d=n(4),h=n(16),f=n(39),p=n(65),m=n(11),g=n(92),y=n(86),v=n(1),b=n(3),w=n(6),S=n(28),M=n(2),P=n(83),E=n(19),x=n(36),_=n(74),F=n(145),T=n(146),O=d.mkLogger("LibraryHealthChecks");function A(e){return i(this,void 0,void 0,(function*(){const t=E.toA(yield u.BaseFile.for(l.ProjectPath.Public()).join("images").children()).find(e=>e.name.startsWith("splash"));if(null==t)return O.throw("copyExampleImageToLibraryDir(): missing validation image");const n=e.join(".tmp-"+P.randomChars(6)),i=n.join("test.jpg");try{if(yield t.copyFile(i),(yield t.sha())!==(yield i.sha()))return O.throw("Failed to copy sample file to library. Is "+e+" writable?");O.debug(`Library root directory, ${e}, is writable`)}finally{yield n.remove()}}))}m.Settings.libraryPath.addListener(()=>{t.libraryHealthChecks.clear()}),a.onVolumesChanged(()=>t.libraryHealthChecks.refresh()),a.onSettingsChanged(()=>t.libraryHealthChecks.refresh()),a.onNonFatal(e=>o.isHealthCheckError(e)?void 0:t.libraryHealthChecks.refresh()),t.libraryHealthChecks=M.lazy((function(){return i(this,void 0,void 0,(function*(){if(_.dbRpc()||p.isMainService())return{};if(!m.Settings.libraryPath.hasValue()&&!g.libraryHasSettings.refresh())return{ok:["Library isn't set up yet"]};const e=T.Library.instance();if(null==e)return g.libraryHasSettings.refresh()?{fail:["Missing library at "+m.Settings.libraryPath.value]}:{};if(e.isPendingSetup){e.ready.then(()=>t.libraryHealthChecks.clear());const n=Date.now()-e.start;return n<30*w.secondMs?{ok:["Library is setting up..."]}:n<3*w.minuteMs?{warn:["Library is taking a long time to set up..."]}:{bad:["Library took too long time to set up."]}}try{yield e.ready}catch(e){return{fail:["Library setup failed: "+S.errorToS(e)]}}const i=[],a=[],u=[],l=yield y.volumes().catch(e=>(u.push("Cannot get volume information: "+S.errorToS(e)),[]));if(yield A(e.rootDir).catch(t=>u.push("Cannot write to "+e.rootDir+": "+t)),h.isWin)try{const e=yield f.PowerShell.instance().version();b.blank(e)&&u.push("PowerShell isn't working (can't get version).")}catch(e){u.push(`PowerShell isn't working (${S.errorToS(e)}).`)}for(const t of yield e.requiredFiles())try{const e=yield t.file();if(null==e)continue;if(e.clear(),t.isDir&&!(yield e.isDirectory()))u.push(`${t.desc}, ${e}, is missing`+o.FatalErrorFlag);else if(v.isNotEmpty(l)){const n=y.bestVolume(l,e.nativePath);O.debug("checkDir()",{dir:e.nativePath,desc:t.desc,bestVolume:n,vols:l.map(e=>e.mountpoint)}),null==n?u.push(`${t.desc}, ${e}, doesn't seem to have a mountpoint (?!)`):n.available<m.Settings.minDiskFreeGb.valueOrDefault*x.GB&&a.push(`Only ${x.fmtBytes(n.available)} are available on ${n.mountpoint}.`)}}catch(e){u.push("Failed to check "+t.desc+": "+e)}v.isEmpty(u)&&v.isEmpty(a)&&i.push("Library and support directories are OK"),b.notBlank(r.env.TEST_FAIL)&&u.unshift(...r.env.TEST_FAIL.split(",")),b.notBlank(r.env.TEST_WARN)&&a.unshift(...r.env.TEST_WARN.split(","));try{yield e.modelDb();const t=yield n(268).Heartbeat.ping();if(!c.nowish(t.updatedAt))throw new Error("Stale upsert in Model DB");i.push("Model DB is OK")}catch(e){O.error("Failed to validate DB",e),u.push("Failed to validate DB: "+S.errorToS(e))}return u.map(e=>o.onError(e+o.HealthCheckErrorFlag)),s.concatHealthChecks({ok:i,warn:a,bad:[],fail:u},F.syncSettingsCheck())}))}),7*w.secondMs),t.copyExampleImageToLibraryDir=A},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(160),s=n(80),o=n(88),a=n(0),u=n(5),l=n(8),c=n(27),d=n(4),h=n(14),f=n(9),p=n(100),m=d.mkLogger("extractPreviewInfo");function g(e,t,n,i){return`Download ${t} ${e.ext} ${n} (${s.dimToS(i)})`}t.extractPreviewInfo=function(e,t){const n=t.posixPathFrom(e).replace(/\//g,"").split("-"),i=u.toInt(n[0]),r=n[1],s=o.ReducerNames.validOrElse(r,void 0),a=h.extractInt(n[2]);return u.gt0(i)?{file:t,assetId:i,reducer:s,width:a}:void m.warn("Failed to extract preview info",{file:t,previewsRoot:e,arr:n,assetId:i,reducer:s,width:a})},t.previewToDownloadable=function(e,t){return i(this,void 0,void 0,(function*(){return a.map2(t.assetId,t.width,(n,i)=>l.thenMap(p.dimensions(t.file),a=>{const u=s.dimToSize(a);return{size:u,basename:`${f.stripSuffix(e,c.extname2(e))}-${u}${t.file.ext}`,title:g(t.file,u,"image",a),description:"Download "+u,href:new r.AssetUrls(n).imgLink(o.ReducerNames.fit,i)}}))}))},t.mkDownloadableTitle=g},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),s=n(1),o=n(3),a=n(6),u=n(2),l=n(0),c=n(10),d=n(64),h=n(8),f=n(17),p=n(16),m=n(39),g=n(9);function y(e=r.env){return l.firstDefined(e.LC_ALL,e.LC_MESSAGES,e.LANG,e.LANGUAGE)}t.defaultLocale="en",t.locale=u.lazy(()=>i(void 0,void 0,void 0,(function*(){return b(yield h.firstDefinedPromise([()=>y(),()=>p.isWin?w():void 0,()=>p.isMac?M():void 0,()=>p.isPosix?E():void 0]))})));const v=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function b(e){if(o.blank(e)||g.equalsIgnoreCase("c",e)||g.equalsIgnoreCase("posix",e))return t.defaultLocale;{const n=v.exec(e);return null==n?t.defaultLocale:s.compact([n[1],n[2]]).join("-")}}function w(){return h.thenMap(m.PowerShell.instance().executeJson("GET-WinSystemLocale | Select-Object -Property Name"),e=>e.Name)}t.lc2locale=b,t.winLocale=w;const S={timeout:10*a.secondMs};function M(){return d.thenOpt(f.stdout("defaults",["read","-globalDomain","AppleLocale"],S)).flatMap(b).get()}t.macLocale=M;const P=/^([a-z_]+)\s*=\s*"(.+)"$/i;function E(){return d.thenOpt(f.stdout("locale",[],S)).flatMap(e=>e.split("\n").map(e=>l.map(e.match(P),e=>[e[1],e[2]]))).flatMap(c.fromEntries).flatMap(y).flatMap(b).get()}t.posixLocale=E},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(23),r=n(4),s=n(9),o=n(1),a=n(3),u=n(10),l=n(15),c=new Map;function d(e){c.set(e.$ctor,e)}t.addModelClass=d;const h=([e,t])=>null!=e&&null!=t;function f(e,t,n=[]){const r=e.class();return u.keys(t).filter(e=>"$ctor"!=e).filter(e=>null!=t[e]).map(e=>{const a=t[e];return n.forEach(t=>e=s.stripPrefix(e,t)),o.includes(r.booleanFields,e)?[e,i.isTrue(a)]:[e,a]}).filter(h).forEach(([t,n])=>e[t]=n),e}t.fromJSON=function(e,t){if(null==t)throw new Error("json is null");if(null!=e&&a.notBlank(e.$ctor)&&!c.has(e.$ctor)&&d(e),t instanceof e)return t;const n=l.Opt(t.$ctor).flatMap(e=>c.get(e)).getOrElse(()=>e);if(t instanceof n)return t;const i=new n;return null==t?i:f(i,t,o.uniq([e.tableName+".",n.tableName+"."]))},t.assignFromJSON=f,t.toJSON=function e(t,n,i){if(null!=t)return Array.isArray(t)?t.map((t,r)=>e(t,n,`${i}[${r}]`)):"function"==typeof t.toJSON?t.toJSON():void r.mkLogger("ModelJSON.toJSON()").warn("Failed",{m:t,key:i,mc:n.$ctor})}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(2),o=n(15),a=n(46),u=n(281),l=n(9),c=n(47),d=n(27);function h(e){const t=s.lazy(()=>new Set(i.compactBlanks(a.tot(e).map(e=>l.ensurePrefix(e.toLowerCase().normalize(),".")))));return u.Filter.lift(e=>o.Opt(e).flatMap(e=>r.firstNotBlank(e.ext,e.base)).map(e=>t().has(e.toLowerCase().normalize())).getOrElse(()=>!1))}t.excludedPathFilter=function(e){const t=new Set(e.map(e=>e.toLowerCase()));return u.Filter.lift(e=>d.pathnames(e.nativePath).every(e=>!t.has(e.toLowerCase())))},t.extFilter=h,t.browserImgExtFilter=h(c.BrowserImgExts),t.browserExtFilter=h(c.BrowserExts),t.videoExtFilter=h(c.VideoExts)},function(e,t){e.exports=require("source-map-support")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(11),r=n(255);t.CommonArgs={beforeParse:e=>e.option("-v, --verbose",'Emit "info", "warn", and "error" messages to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--debug",'Emit "debug", "info", "warn", and "error" message to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--elapsed",'Prefix log entries with elapsed time since process start, rather than absolute time. Sets PS_LOG_ELAPSED_MS to "true"'),afterParse:e=>{e.elapsed&&(i.Settings.logElapsedMs.tmpValue=e.elapsed),r.isDaemon(e)?i.Settings.logStdout.tmpValue=!1:(e.verbose||e.debug)&&(i.Settings.logColor.tmpValue=!0,i.Settings.logStdout.tmpValue=!0,i.Settings.logLevel.tmpValue=e.debug?"debug":"info")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(18),r=n(23),s=n(3);t.isDaemon=function(e){return r.isTrue(i.env.__is_daemon)||r.isTrue(null==e?void 0:e.daemon)||!s.blank(null==e?void 0:e.pidfile)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(82),s=n(0),o=n(8),a=n(14);t.readFilePart=function(e,t=0,n){return i(this,void 0,void 0,(function*(){let i=-1;try{const u=yield s.orElse(n,()=>o.thenMap(r.stat(e),e=>e.size-t)),l=Buffer.alloc(u);return i=yield r.open(e,"r"),yield r.read(i,l,0,u,t)}finally{yield a.mapGte0(i,r.close)}}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),s=n(174),o=n(40),a=n(24),u=n(59),l=n(8),c=n(273),d=n(81),h=n(20),f=n(13),p=n(4),m=n(22),g=n(16),y=n(65),v=n(11),b=n(92),w=n(9),S=n(61),M=n(25),P=n(124),E=n(3),x=n(6),_=n(38),F=n(28),T=n(0),O=n(64),A=n(7),k=n(74),D=n(145),C=n(146),I=n(189),L=n(326),R=n(329),B=n(330),N=n(173);t.start=Date.now(),t.StartupTimeoutMs=M.cmdTimeoutMs;t.Service=class{constructor(e){this.opts=e,this.exitted=!1,this._ready=new u.Latch,this.onFatalHandlers=[],this.inputHandlers=new Map,y.setServiceName(this.name=this.opts.name),this.setupLogger(),v.Settings.logDir.addListener(()=>this.setupLogger()),this.logger=p.mkSafeLogger("Service("+this.name+")"),this.addDefaultInputHandlers(),l.thenOrTimeout(this.setup(),t.StartupTimeoutMs,()=>this.exit("setup timed out",13))}setupLogger(){p.setLoggerProcessName(this.name)}get ready(){return this._ready.promise}on(e,t){this.onFatalHandlers.push(t)}setTitle(){const e=o.App.getName()+(this.name===y.ServiceNames.main?"":" "+this.name);m.Try(()=>r.title=e)}setup(){return i(this,void 0,void 0,(function*(){try{yield b.readSystemSettings(),this.setTitle(),E.mapNotBlank(d.getEnv("PS_FATAL_"+this.name),e=>{throw new h.WrappedError({fatal:!0,message:e})}),E.mapNotBlank(d.getEnv("PS_CRASH_"+this.name),e=>{_.later(()=>{throw new h.WrappedError({message:e})},5*x.secondMs)}),this.logger.info("setup()",Object.assign({version:S.version,argv:r.argv,arch:r.arch,platform:r.platform,isDocker:g.isDocker(),isPacked:g.isPacked,isElectron:g.isElectron,versions:r.versions,settings:{logLevel:v.Settings.logLevel.valueOrDefault,httpPort:v.Settings.httpPort.valueOrDefault,rpcPort:v.Settings.rpcPort.valueOrDefault,libraryPath:v.Settings.libraryPath.valueOrDefault}},v.psenv())),yield this.setupStdin(),y.isMainService()||(L.setupModelJson(),k.setDbRpc(y.isDbRpcService()),y.isDbRpcService()?yield this.setupDbRpc():y.isDbService()&&(b.libraryHasSettings()&&(yield b.readLibrarySettings()),yield this.maybeUpgradeSystemSettings(),yield this.maybeUpgradeLibrarySettings(),b.libraryHasSettings.refresh()&&(yield O.thenOpt(C.Library.instance()).flatMap(e=>e.dbServer())))),yield this.setupErrorHandling(),this.logger.debug("set up error handling.");const e=this.exitted||a.ending();this.logger.debug("setup done.",{reject:e}),e?this._ready.reject():this._ready.resolve()}catch(e){return this._ready.reject(e),this.exit(w.ensureSuffix(this.name+" setup failed: "+e,h.FatalErrorFlag),14)}}))}maybeUpgradeSystemSettings(){return l.thenMap(b.systemSettingsVersion(),e=>i(this,void 0,void 0,(function*(){e!==S.version&&(yield b.writeSystemSettings())})))}maybeUpgradeLibrarySettings(){return i(this,void 0,void 0,(function*(){return l.thenMap(b.librarySettingsVersion(),e=>i(this,void 0,void 0,(function*(){e!==S.version&&(yield b.writeLibrarySettings())})))}))}setupErrorHandling(){return i(this,void 0,void 0,(function*(){f.onFatal((e,t)=>this.exit(e+T.map(t,e=>": "+F.errorToS(e)),12)),B.installSentry(this),r.on("unhandledRejection",e=>h.onError("unhandledRejection",e)),r.on("uncaughtException",e=>h.onError("uncaughtException",e)),r.on("SIGINT",()=>this.exit("SIGINT",0)),r.on("SIGTERM",()=>this.exit("SIGTERM",0)),r.on("disconnect",()=>this.exit("disconnect",0)),r.stdin.on("close",()=>this.exit("stdin.close",0)),r.stdin.on("error",e=>this.logger.warn("stdin.error: "+e)),r.stdin.on("disconnect",()=>this.exit("stdin.disconnect",0)),r.stdout.on("disconnect",()=>this.exit("stdout.disconnect",0)),r.stdout.on("error",e=>this.logger.warn("stdout.error: "+e)),r.stderr.on("disconnect",()=>this.exit("stderr.disconnect",0)),r.stderr.on("error",e=>this.logger.warn("stderr.error: "+e))}))}setupStdin(){s.createInterface({input:r.stdin}).on("line",e=>this.onLine(A.toS(e)))}setupDbRpc(){return i(this,void 0,void 0,(function*(){if(!y.isDbRpcService())return;const e=yield R.remoteLibraryPath();if(E.blank(e))throw new Error("Could not get libraryPath from remote");e!==v.Settings.libraryPath.value&&this.logger.error("Saved library path doesn't match db. Using remote.",{local:v.Settings.libraryPath.value,remote:e}),v.Settings.libraryPath.tmpValue=e,I.installLibraryUriSupport()}))}exit(e,t){return i(this,void 0,void 0,(function*(){if(!this.exitted){if(this.exitted=!0,this.logger.info("exit()",{status:t,reason:e,ending:a.ending()}),yield this.logger.flush(),0!==t){yield Promise.all(this.onFatalHandlers.map(t=>t(e)));const n={fatal:!0,exit:!0,status:t,pid:r.pid,ppid:r.ppid};n.error=e,m.Try(()=>N.stdoutWrite(n,!1))}return yield a.endEndables(),r.exit(t)}}))}setInputHandler(e,t){this.inputHandlers.set(e.trim().toLowerCase(),t)}addDefaultInputHandlers(){this.setInputHandler("--version",()=>i(this,void 0,void 0,(function*(){return N.stdoutWrite({version:S.version})}))),this.setInputHandler("--quit",()=>this.exit("--quit from stdin",0)),this.setInputHandler(c.ChildServiceExitCommand,()=>this.exit(c.ChildServiceExitCommand+" from stdin",0)),this.setInputHandler("--pause",()=>(P.pause(),N.stdoutWrite({paused:P.isPaused()}))),this.setInputHandler("--resume",()=>(P.resume(),N.stdoutWrite({paused:P.isPaused()}))),this.setInputHandler("--status",()=>i(this,void 0,void 0,(function*(){const e=yield D.healthChecks();return this.logger.info("--status",e),N.stdoutWrite({healthChecks:e})}))),this.setInputHandler("--boom",f.emitBoom)}onLine(e){return i(this,void 0,void 0,(function*(){if(this.logger.debug("onLine",e),e.trim().startsWith("--")){const t=e.split(" ",1)[0],n=this.inputHandlers.get(t);null==n?console.warn("unknown command "+e):yield n(e.substr(t.length).trim())}else try{yield T.map(this.opts.stdinReceiver,t=>t(e))}catch(t){this.logger.error("onLine(): failed to process",{line:e,error:t})}}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(2),s=n(40),o=n(8),a=n(21),u=n(54),l=n(61),c=n(306),d=n(29);class h{constructor(e){this.rootDir=e,this.jfs=new c.JsonFileStore(e.join("uid.json"),()=>this.mkUid())}readUid(){return i(this,void 0,void 0,(function*(){return this.jfs.read()}))}mkUid(){return i(this,void 0,void 0,(function*(){return{uid:u.GeoRadix.safeRandomUid(20),version:l.version,createdAtIso:a.isoNow()}}))}}t.UIDStore=h,t.SystemUIDStore=r.lazy(()=>new h(d.PosixFile.for(s.App.userData()))),s.App.userData.onChange(()=>t.SystemUIDStore.clear()),t.systemUID=function(){return o.thenMapOr(t.SystemUIDStore().readUid(),e=>e.uid,()=>"missing!").catch(e=>"Failed to fetch System UID: "+e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(5);function s(e){return i.map(e,e=>r.isNumber(e)?e:e.id)}t.id2id=s,t.idEql=function(e,t){return i.map2Or(s(e),s(t),(e,t)=>e===t,()=>!1)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(42),s=n(249),o=n(14),a=n(11),u=n(129),l=n(32),c=n(1),d=n(2),h=n(0),f=n(64),p=n(7),m=n(102),g=d.lazy(()=>i(void 0,void 0,void 0,(function*(){return new Intl.DateTimeFormat(yield s.locale(),{month:"short"})}))),y=d.lazy(()=>i(void 0,void 0,void 0,(function*(){const e=yield g();return c.range(0,12,t=>e.format(new Date(2016,t)))})));function v(e){return 1e4-e}function b(e){return 13-e}function w(e){return 33-e}function S(e){return o.mapGt0(e,e=>({name:p.toS(e),ordinal:v(e)}))}function M(e){return i(this,void 0,void 0,(function*(){if(o.within(1,12,e))return h.map((yield y())[e-1],t=>({name:t,ordinal:b(e)}))}))}function P(e){return o.mapGt0(e,e=>({name:p.toS(e),ordinal:w(e)}))}function E(e){return i(this,void 0,void 0,(function*(){const t=p.toS(a.Settings.tagDate.valueOrDefault).toLowerCase();if(""===t)return;const n=[m.When];if(t.startsWith("y")){const t=h.map(r.getYear(e),S);if(null==t)return;n.push(t)}if(t.startsWith("ym")){const t=yield h.map(r.getMonth(e),M);if(null==t)return n;n.push(t)}if(t.startsWith("ymd")){const t=h.map(r.getDay(e),P);if(null==t)return n;n.push(t)}return n}))}t.yearToOrdinal=v,t.monthToOrdinal=b,t.dayToOrdinal=w,t.yearTagRef=S,t.monthTagRef=M,t.dayTagRef=P,t.dateTag=E,t.dateTagFile=function(e,t=[]){return i(this,void 0,void 0,(function*(){return f.thenOpt(l.readTags(e)).flatMap(e=>u.bestCapturedAt([e.capturedAt,...t])).flatMap(e=>E(e.date)).get()}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(19),r=n(7);function s(e){return r.toS(e).normalize().toLowerCase()}class o{constructor(e){this.delegate=new Set,this.keys=this.values.bind(this),i.toA(e).forEach(e=>this.add(e))}get size(){return this.delegate.size}add(e){return this.delegate.add(s(e)),this}addAll(e){return i.toA(e).forEach(e=>this.delegate.add(s(e))),this}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(s(e))}forEach(e,t){for(const[t]of this.delegate)e(t,t,this)}has(e){return this.delegate.has(s(e))}values(){const e=this;return function*(){for(const t of e.delegate.keys())yield t}()}entries(){const e=this;return function*(){for(const t of e.delegate.keys())yield[t,t]}()}toA(){return[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}}t.CISet=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(0),o=n(5),a=n(12),u=n(14),l=n(41);function c(e){return"number"==typeof e&&e<t.b64charset.length?t.b64charset[e]:Buffer.from(e.toString(16),"hex").toString("base64")}function d(e){return BigInt("0x0"+Buffer.from(e,"base64").toString("hex"))}function h(e){if(null==e||0===e.length)return-1;const n=e.split("");let i=0;for(const r of n){const n=t.b64charset.indexOf(r);if(-1===n)return-1;if(i>Math.pow(2,46))throw new Error("b64decodeSmall("+e+"): overflow");i=64*i+n}return i}function f(e,t=6){const n=t/6;return i.stepRange(0,e.length,n,t=>h(e.substr(t,n)))}t.hex2b64=function(e){return Buffer.from(e,"hex").toString("base64")},t.b64charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t.b64encode=c,t.b64decode=d,t.b64hammRatio=function(e,t){return r.mapNotBlank(e,e=>r.mapNotBlank(t,t=>u.hammRatioBigInt(d(e),d(t))))},t.b64decodeSmall=h,t.uint8toB64=function(e){return Buffer.from(Uint8ClampedArray.from(e).buffer).toString("base64")},t.uint6toB64=function(e){return e.map(e=>t.b64charset[63&e]).join("")},t.uint12toB64=function(e){const t=[];return e.forEach(e=>{t.push(c(e>>6&63)),t.push(c(63&e))}),t.join("")},t.b64corr=function(e,t,n=6){if(e===t)return 1;const i=f(e,n),r=f(t,n),s=Math.pow(2,n-1);return l.cosineSimilarity(i.map(e=>e-s),r.map(e=>e-s))},t.b64diff=function(e,t,n=6){return e===t?0:a.zip(f(e,n),f(t,n)).reduce((e,t)=>s.orElse(o.absdiff(t[0],t[1]),0)+e,0)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(3),s=n(2),o=n(0),a=n(5),u=n(10),l=n(7),c=n(164),d=n(4),h=n(199);t.zeroesRe=/^[\s0]*$/;const f=s.lazy(()=>d.mkLogger("ExifUid"));function p(e){return null==e||a.isNumber(e)?0===e:null!=t.zeroesRe.exec(l.toS(e))}function m(e){return null!=e&&r.notBlank(e)&&!p(e)}t.compactZeroes=function(e){return u.mapFields(e,(e,t)=>p(t)?void 0:[e,t])},t.present=m,t.normalizeExposureSettings=function(e){if(null==e)return;const t={focalLength:o.map(e.focalLength,e=>l.toS(e).trim()),aperture:a.mapNumeric(e.aperture,e=>a.sigFigs(e,2)),shutterSpeed:o.map(e.shutterSpeed,e=>{return t=e,n="/",l.toS(t).split(n).map(e=>a.mapIntOr(e,e=>l.toS(a.sigFigs(e,2)),()=>e)).join(n);var t,n}),iso:a.mapInt(e.iso,e=>a.sigFigs(e,2))};return f().debug("normalizeExposureSettings("+l.toS(e.FileName)+")",t),u.reqValuedOrElse(t)},t.cameraId=function(e){return o.map(u.pickFirst(e,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"],e=>r.notBlank(e)&&!p(e)),l.toS)},t.lensId=function(e){return o.map(h.extractLensMakeModel(e),({lensMake:e,lensModel:t})=>`${e.toLowerCase()}/${t.toLowerCase()}`)},t.imageId=function(e){return u.pickFirst(e,i.compact(["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"]),m)},t.uidGeoHash=function(e,t){return c.geohash(a.toFixed(e,4),a.toFixed(t,4))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),s=n(21),o=n(6),a=n(321);t.sqliteFiles=function(e){return r.asyncFilter([e,...a.SqliteSuffixes.map(t=>e.sibling(e.base+t))],e=>e.exists())};const u=["-wal","-journal"];t.isDbOpen=function(e,t=2*o.minuteMs){return i(this,void 0,void 0,(function*(){const n=n=>i(this,void 0,void 0,(function*(){return r.thenMapOr(e.sibling(e.base+n).clear().maxStatMs(),e=>s.isRecentMs(e,t),()=>!1)}));return(yield e.clear().isNonEmptyFile())&&((yield n("-wal"))||(yield n("-journal")))}))},t.unlinkJournalFiles=function(e){return i(this,void 0,void 0,(function*(){yield u.map(t=>e.sibling(e.base+t).unlink("info"))}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(296),s=n(21),o=n(31),a=n(114),u=n(4),l=n(11),c=n(2),d=n(36),h=n(180),f=n(322),p=n(190),m=u.mkLogger("DbSetup");function g(e,t){return i(this,void 0,void 0,(function*(){const n=new r(e.nativePath,{memory:!1,fileMustExist:!1,readonly:!1,timeout:l.Settings.dbTimeoutMs.valueOrDefault});return y(n),new f.Migration(o.BaseFile.for(a.ProjectPath.Migrations()).join(t),n,e)}))}function y(e){return e.pragma('encoding = "UTF-8"'),e.pragma("threads = 2"),e.pragma("foreign_keys = ON"),e.pragma("page_size = "+16*d.KiB),e.pragma("cache_size = -"+l.Settings.dbCacheSizeMb.valueOrDefault*d.MiB),e.pragma("locking_mode = NORMAL"),e.pragma("journal_mode = WAL"),e.pragma("synchronous = NORMAL"),e.pragma("case_sensitive_like = ON"),e.pragma("auto_vacuum = INCREMENTAL"),e}t.mkMigration=g,t.dbSetup=function(e,t){return i(this,void 0,void 0,(function*(){const n=h.pathToDb(e,t);if(null==(yield n.ensureFile()))throw new Error("Cannot create dbFile "+n);const r=yield g(n,t),o=c.lazy(()=>i(this,void 0,void 0,(function*(){try{if(yield n.notExists())return;const e=yield n.parent().join("version-backup",s.filestamp()+"-"+n.base).ensureNew();yield p.backupDb(n,e)}catch(e){m.error("Failed to back up "+n,e)}})));return yield r.apply(o),r.db}))},t.setPragmas=y},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(43),s=n(24),o=n(22),a=n(38),u=n(0),l=["wal_checkpoint(PASSIVE)","incremental_vacuum","optimize"];t.SqliteJanitor=class{constructor(e,t){this.db=t,this.ended=!1,this.name="SqliteJanitor("+e+")",s.addDbEndable(this)}setInterval(e){u.map(this.timer,e=>r.clearInterval(e)),this.timer=r.setInterval(()=>this.run(),e)}run(){return i(this,void 0,void 0,(function*(){for(const e of l)yield a.later(()=>this.db.transaction(()=>this.db.pragma(e))())}))}end(){this.ended||(this.ended=!0,null!=this.db&&this.db.open&&(o.Try(()=>this.db.exec("VACUUM")),this.db.close())),u.map(this.timer,e=>r.clearInterval(e)),this.timer=void 0}}},function(e,t,n){"use strict";let i;Object.defineProperty(t,"__esModule",{value:!0}),t.statsDb=function(){return i},t.setStatsDb=function(e){i=e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(147),r=n(148),s=n(85);class o extends s.TimestampedModel{static ping(e="ping"){return i.tx(r.modelDb(),e,()=>this.ops().upsertOne({name:"ping"}))}}t.Heartbeat=o,o.tableName="Heartbeat",o.uniqueColumnName="name"},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(30),s=n(40),o=n(8),a=n(90),u=n(29),l=n(127),c=n(4),d=n(54),h=n(137),f=n(11),p=n(1),m=n(2),g=n(0),y=n(28),v=m.lazy(()=>c.mkLogger("CacheDir"));function b(){return o.thenMapOr(u.PosixFile.for(s.App.getPath("userData")).children(),e=>e.filter(e=>e.name.startsWith(t.CacheDirPrefix)),()=>[])}function w(){return i(this,void 0,void 0,(function*(){const e=[f.Settings.libraryPath,...f.persistedLibrarySettings()].map(e=>[e.key,e.valueOrDefault]);e.push(["ASSET_FILE_VERSION",h.AssetFileVersion]),e.push(["ASSET_VERSION",h.AssetVersion]),e.push(["TRANSCODE",yield l.isVideoTranscodingSupported()]);const n=p.sortBy(e,([e])=>e),i=a.shortStringSha(JSON.stringify(n),9,d.GeoRadix),o=(yield u.PosixFile.for(s.App.getPath("userData")).mkNoMedia()).join(t.CacheDirPrefix+i);return yield o.mkdirp(),yield o.join("README.txt").applyIfEmpty(e=>e.writeTxt(`\nThis folder is a library synchronization cache for\n\n${f.Settings.libraryPath.value}\n\nIf you delete or modify the contents of this directory, you will need to\nrestart PhotoStructure, and the next sync will need to rescan all your drives.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSettings used by this cache: \n\n`+r.inspect(n,{colors:!1,breakLength:80}))).catch(e=>{v().warn("Failed to write README to "+o+": "+y.errorToS(e))}),v().info("Set up cache dir"+o),o}))}function S(e){return i(this,void 0,void 0,(function*(){const n=g.orElse(e,yield w());if(!n.name.startsWith(t.CacheDirPrefix))throw new Error("Refusing to remove directory "+n);yield n.remove()}))}t.cacheDirs=b,t.CacheDirPrefix="ps-cache-",t.cacheDir=w,t.clearCacheDir=S,t.vacuumCacheDirs=function(){return i(this,void 0,void 0,(function*(){const e=yield w();for(const t of yield b())t.eql(e)||(yield S(t))}))},t.clearCacheDirs=function(){return i(this,void 0,void 0,(function*(){for(const e of yield b())yield S(e)}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(3),o=n(6),a=n(2),u=n(0),l=n(5),c=n(10),d=n(7),h=n(78),f=n(27),p=n(4),m=n(9),g=n(47),y=n(100),v=a.lazy(()=>p.mkLogger("AssetFileSorter")),b=[h.PS_NETWORK_FILESYSTEM_PROTOCOL,"file:",h.PS_LOCAL_FILE_PROTOCOL,h.PS_LIBRARY_PROTOCOL];function w(e){return u.map(e,e=>l.map2Numeric(e.width,e.height,(e,t)=>Math.ceil(Math.pow(e*t,.15))))}function S(e){return Math.round(e/(2*o.minuteMs))}function M(e){const t=w(e),[n,i]=d.toS(e.uri).split("://");if(s.blank(n)||s.blank(i)||null==e.mtime)return void v().debug("assetFileSortCriteriaPojo(): skipping",{af:e,protocol:n,pathname:i});const r=b.indexOf(m.ensureSuffix(n,":").toLowerCase());if(-1===r)return void v().debug("assetFileSortCriteriaPojo(): skipping",{af:e,schemeIdx:r,protocol:n});const o=f.parsePosixPath(i),a=o.base.toLowerCase().includes("cover"),l=g.isBrowserExt(o.ext),c=u.orElse(f.countFromName(o.base),0);return{resolution:t,mtime:S(e.mtime),schemeIdx:r,isCover:a,count:c,isBrowserSupported:l,uri:e.uri}}t.dim2sort=w,t.mtime2sort=S,t.file2sortableAssetFile=function(e){return i(this,void 0,void 0,(function*(){return c.reqValuedOrElse(Object.assign({uri:yield e.uri(),mtime:yield e.thisOrSidecareMaxMtimeMs(),sha:yield e.sha()},yield y.dimensions(e)))}))},t.sortAssetFiles=function(e){for(const t of r.uniq(e.map(e=>e.sha))){const n=e.filter(e=>e.sha===t),i=Math.max(...r.compact(n.map(e=>e.mtime)));n.forEach(e=>e.mtime=i)}const t=r.compact(e.map(e=>u.map(M(e),t=>u.map(function(e){const t=c.values(e);return t.some(e=>null==e)?void v().debug("pojoToCriteria(): skipping",{pojo:e}):t}(t),n=>({f:e,crit:n,pojo:t}))))),n=r.sortBy(t,({crit:e})=>e);return r.mapNotEmpty(n,e=>e.map(e=>e.f))},t.assetFileSortCriteriaPojo=M},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(83);t.primesPerBin=6,t.SeedCount=Math.pow(t.primesPerBin,6),t.prngSeed=function(){return i.randomInt(0,t.SeedCount)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(70),r=n(3),s=n(6),o=n(2),a=n(0),u=n(55),l=n(85);t.ProgressRateMs=o.lazy(()=>s.secondMs*(i.maxCpus()<=2?5:2));class c extends l.TimestampedModel{toSyncState(){return{volume:this.volume,uri:this.uri,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return a.orElse(r.mapNotBlank(this.dekJSON,()=>JSON.parse(this.dekJSON)),()=>[])}set dek(e){this.dekJSON=JSON.stringify(e)}afterUpsert(){c.recentProgressByVolume.set(this.volume,this)}static findByUri(e){return c.ops().findOne(this.query().where({uri:e}))}}t.Progress=c,c.recentProgressByVolume=new u.TTLMap(2*s.minuteMs),c.tableName="Progress",c.uniqueColumnName="uri"},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),s=n(43),o=n(1),a=n(3),u=n(6),l=n(28),c=n(2),d=n(0),h=n(10),f=n(33),p=n(19),m=n(7),g=n(40),y=n(12),v=n(48),b=n(24),w=n(52),S=n(58),M=n(20),P=n(31),E=n(4),x=n(16),_=n(11),F=n(9),T=n(25),O=n(17),A=n(176),k=n(175);t.ChildServiceExitCommand="--exit";const D=c.lazy(()=>E.mkLogger("ChildService"));function C(e){return i(this,void 0,void 0,(function*(){const t=F.ensureSuffix(e,".js"),n=P.BaseFile.projectRoot(),s=P.BaseFile.for(r.cwd()),o=x.isPacked?[n.join("bin",t),n.join("app.asar",t)]:[s.join("dist","library",t),s.join("dist","js","library",t)];o.push(s.join("dist","app",t));const a=y.firstAsync(o,e=>i(this,void 0,void 0,(function*(){return(yield e.isNonEmpty(101))?e:void 0})));return D().info("pathToService()",{cmdBase:e,result:a,dirs:o.map(m.toS)}),a}))}t.pathToService=C;let I=0;function L(e){switch(e){case"main":return 9222;case"web":case"db":return 9223;case"sync":return 9224;case"sync-file":return 9225+I++%20}}function R(e){const t=[];return _.Settings.inspect.valueOrDefault&&t.push("--inspect="+L(e)),t}t.inspectPort=L,t.nodeArgs=R;class B{constructor(e,n,r){this.cmd=n,this.opts=r,this.restartCount=0,this.healthCheck=w.serially("ChildService.healthCheck",()=>i(this,void 0,void 0,(function*(){if(b.ending()||this.ended)return;if(this.logger.debug("healthCheck(): running..."),f.isFunction(this.opts.healthy)){if(!1===(yield this.opts.healthy()))return M.onError("healthCheck for "+this.name+": !healthy(), restarting."),void(yield this.restart())}const e=this._lastStatus=new v.Deferred(this.name+" healthCheck at "+new Date).setTimeout(T.cmdTimeoutMs);e.promise.catch(e=>(M.onError("healthCheck for "+this.name+": failed",e),this.restart())),(yield this.write("--status"))||e.resolve(A.fullhc({fail:["write --status failed"]}));try{const t=yield e.promise;return A.hasBad(t)||A.hasFail(t)?(M.onError("healthCheck for "+this.name+": unhealthy, restarting."),void(yield this.restart())):(this.logger.debug("healthCheck: all is well",t),t)}catch(e){return void this.logger.warn("healthCheck: failed: "+l.errorToS(e))}}))),this.name="ChildService("+e+")",this.logger=E.mkLogger(this.name);const s=[...p.toA(r.nodeArgs),n.nativePath];o.isNotEmpty(r.args)&&s.push(...r.args);const a=h.pick(this.opts,"argv0","cwd","detached","env","gid","shell","stdio","timeout","uid","windowsHide","windowsVerbatimArguments");this.wc=new k.WatchedChild(Object.assign({name:e,childFactory:()=>i(this,void 0,void 0,(function*(){return this.restartCount>0&&null!=this.opts.onPreRestart&&(yield this.opts.onPreRestart()),this.restartCount++,O.spawn(g.App.getPath("exe"),s,-1,a)})),endableRank:b.EndableRanks.service,onStdout:this.onStdout.bind(this),onError:d.orElse(this.opts.onError,()=>e=>!M.isIgnorableError(e)),ignoreStopErrors:!1,exitCommand:t.ChildServiceExitCommand},r)),this.healthCheckTimer=S.setUnrefInterval(()=>this.healthCheck(),30*u.secondMs),b.addFirstEndable(this)}static mk(e,t={}){return i(this,void 0,void 0,(function*(){const n=d.orElse(t.pathToService,yield C(e));if(a.blank(n))throw new Error("Failed to find path to "+e);return t.nodeArgs=[...R(e),...p.toA(t.nodeArgs)],new B(e,n,t)}))}get startMs(){return this.wc.startMs}onStdout(e){return i(this,void 0,void 0,(function*(){if(!a.blank(e))try{const t=JSON.parse(e);if(a.notBlank(t.fatal))this.wc.onError(this.name+".onStdout()",t.error);else if(null!=t.healthChecks){const e=this._lastStatus;null!=e&&e.pending?e.resolve(Object.assign(Object.assign({},t.healthChecks),{ts:Date.now()})):this.logger.warn("unrequested healthChecks:",t.healthChecks)}else null!=this.opts.onData&&this.opts.onData(t)}catch(t){console.log(e)}}))}start(){return this.wc.start()}stop(){return this.wc.stop()}restart(){return this.wc.restart()}get ended(){return this.wc.ended}end(){return i(this,void 0,void 0,(function*(){return s.clearInterval(this.healthCheckTimer),this.wc.ended||(yield this.write("--quit")),this.wc.end()}))}get pid(){return this.wc.pid}get msSinceLastStart(){return this.wc.msSinceLastStart}running(){return this.wc.running()}notRunning(){return this.wc.notRunning()}write(e,t=2){return i(this,void 0,void 0,(function*(){if(t<0)return this.logger.warn("write(): no more retries",{toStdin:e}),!1;try{const t=this.wc.proc;return null!=t&&null!=t.stdin&&t.stdin.writable?t.stdin.write(F.ensureSuffix(e,"\n")):(this.logger.warn("write(): childProc isn't open, ignoring",{toStdin:e}),!1)}catch(n){return this.logger.warn("write(): caught "+n),yield this.wc.onError("onStdout()",n),this.write(e,t-1)}}))}}t.ChildService=B},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(7),s=n(12),o=n(14);t.extractBitrateKbps=function(e){return s.first(["AvgBitrate","MaxDataRate"],t=>{return n=e[t],i.map(o.extractFloat(n),e=>{const t=r.toS(n).toLowerCase();return i.map(s.first(a,e=>t.includes(e.pat)?e.fac:void 0),t=>e*t)});var n})};const a=[{pat:"mb/s",fac:1024},{pat:"mbps",fac:1024},{pat:"kb/s",fac:1},{pat:"kbps",fac:1}]},function(e,t){e.exports=require("file-type")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(8);t.emitSafely=function(e,t,n,o=1e3){return i(this,void 0,void 0,(function*(){const i=yield s.until(()=>r.isNotEmpty(e.listeners(t)),o);return i&&e.emit(t,n),i}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(23);!function(e){e.and=function(...e){return i(this,void 0,void 0,(function*(){for(const t of e)if(!r.isTrue(yield t()))return!1;return!0}))},e.or=function(...e){return i(this,void 0,void 0,(function*(){for(const t of e)if(r.isTrue(yield t()))return!0;return!1}))}}(t.Later||(t.Later={})),t.laterPromise=function(e){let t,n;return{promise:new Promise((e,i)=>{t=e,n=i}),later:()=>i(this,void 0,void 0,(function*(){try{const n=yield e();return t(n),n}catch(e){throw n(e),e}}))}},t.firstDefinedLater=function(...e){return i(this,void 0,void 0,(function*(){if(null!=e)for(const t of e){if(null==t)continue;const e=yield t();if(null!=e)return e}}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(279),r=n(88),s=n(2),o=n(37),a=n(4),u=n(11),l=n(128);t.SharpFits=o.strEnum("cover","contain","fill","inside","outside"),function(e){e.name=r.ReducerNames.sq,e.fit="cover",e.reduce=function(e,t){const n=t.width!==t.height;if(l.ltBoth(e,t))return n?Object.assign(Object.assign({},e),{fit:"cover",position:u.Settings.squareThumbStrategy.valueOrDefault}):e}}(t.Square||(t.Square={})),t.fitInsideToAspectRatio=function(e,t){return e.width/e.height>=t?{width:Math.floor(e.height*t),height:e.height}:{width:e.width,height:Math.floor(e.width/t)}},function(e){const t=s.lazy(()=>a.mkLogger("Reducers.Fit"));e.name=r.ReducerNames.fit,e.fit="inside",e.reduce=function(e,n){if(!l.ltBoth(n,e))return i.fitInside(n,e);t().debug("reduce(): input is too small for max",{input:n,max:e})}}(t.Fit||(t.Fit={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fitInside=function(e,t){const n=e.width/e.height;if(n>=t.width/t.height){const i=Math.min(t.width,e.width);return{width:i,height:Math.ceil(i/n)}}{const i=Math.min(t.height,e.height);return{width:Math.ceil(t.height*n),height:i}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(6);t.StatTimeoutMs=25*i.secondMs},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(133);class s{static lift(e){return new class extends s{apply(t){return e(t)}}}and(e){return s.lift(t=>this.apply(t)&&e.apply(t))}or(e){return s.lift(t=>this.apply(t)||e.apply(t))}filter(e){return e.filter(e=>this.apply(e))}asAsync(){return r.AsyncFilter.lift(e=>Promise.resolve(this.apply(e)))}}t.Filter=s,t.definedFilter=s.lift(i.defined),t.trueFilter=s.lift(()=>!0)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(3),r=n(10),s=n(4),o=n(14),a=s.mkLogger("ExposureSettings");t.extractExposureSettings=function(e){const t={focalLength:e.FocalLength,iso:o.firstNonZero(e.ISO,e.ISOSpeed,e.SonyISO),aperture:o.firstNonZero(e.FNumber,e.Fnumber,e.ApertureValue,e.SonyFNumber),shutterSpeed:i.firstNotBlank(e.ExposureTime,e.ShutterSpeed,e.SonyExposureTime)};return a.debug("extracted from "+e.FileName,{exposureSettings:t}),r.reqValuedOrElse(t)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(95),s=n(79),o=n(3),a=n(5),u=n(15),l=n(4).mkLogger("JsonSidecar");function c(e,t,n){for(const i of t)if(e&&e[i]&&a.isNumber(e[i][n]))return e[i][n]}t.readJsonSidecar=function(e){return i(this,void 0,void 0,(function*(){const t=yield e.readJSON(),n=null==t?void 0:{DateTimeOriginal:u.Opt(t.photoTakenTime).flatMap(e=>e.timestamp).flatMap(a.toInt).filter(a.gt0).flatMap(e=>r.ExifDateTime.fromDateTime(s.DateTime.fromMillis(1e3*e))).get(),GPSLatitude:c(t,["geoDataExif","geoData"],"latitude"),GPSLongitude:c(t,["geoDataExif","geoData"],"longitude"),GPSAltitude:c(t,["geoDataExif","geoData"],"altitude"),Title:o.ifNotBlank(t.title),Description:o.ifNotBlank(t.description)};return null!=n&&l.debug("read "+e,n),n}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),s=n(68),o=n(3),a=n(6),u=n(38),l=n(0),c=n(7),d=n(55),h=n(24),f=n(8),p=n(52),m=n(66),g=n(20),y=n(13),v=n(97),b=n(67),w=n(4),S=n(105),M=n(26),P=n(14),E=n(65),x=n(138),_=n(285),F=a.minuteMs,T=5*a.secondMs,O={requestTTL:F,retriesPerRequest:5,delayBetweenRetries:M.isTest?100:T,maxPendingRequests:10,ee:y.eventEmitter};let A=0;t.Client=class{constructor(e,t,n={}){this.streamFactory=t,this._ended=!1,this.mkStreamRate=new S.Rate(a.minuteMs),this.times=new m.PromiseTimer,this.mkStream=p.oneRunAtATime(this.name+".mkStream",()=>i(this,void 0,void 0,(function*(){const e=this.needNewStream();if(this.logger.debug("mkStream()",{needNewStream:e}),e){this.mkStreamRate.onEvent(),this.logger.debug("Making new stream...");try{const e=yield this.streamFactory();if(null==e)throw new Error("streamFactory() returned null");this.logger.debug("Opened stream"),e.on("end",e=>this.onFinish("on(end)",e)),e.on("close",e=>this.onFinish("on(close)",e)),e.on("error",e=>this.onError("stream error",e)),v.onDataChunked(e,"\n",e=>this.onData(e)),this._stream=e}catch(e){return this._stream=void 0,this.onError("streamFactory rejection",e)}}}))),this.name="rpc.Client("+e+"#"+A+++")",this.logger=w.mkLogger(this.name),this.opts=Object.assign(Object.assign({},O),n),this.pending=new d.TTLMap(3*this.opts.requestTTL),h.addServiceEndable(this)}get ended(){return this._ended}get eventEmitter(){return this.opts.ee}end(){return this.logger.info("end()",{ending:h.ending(),timings:this.times.report(),pendingSize:this.pending.size}),this._ended=!0,this.pending.clear(),this.close()}ping(){return this.request("ping",{serviceName:E.serviceName(),pid:r.pid})}ready(e=2){return i(this,void 0,void 0,(function*(){if(this.ended)return this.logger.debug("ready(): false (ended)"),!1;const t=[...this.pending.values()],n=t.filter(e=>e.pending).length,i=t.filter(e=>e.rejected).length;return n>this.opts.maxPendingRequests||i>=e?(this.logger.warn("Client is not ready",{pendingReqCnt:n,recentErrCnt:i}),!1):null!=(yield this.stream())}))}request(e,t){return i(this,void 0,void 0,(function*(){if(this.ended)throw new g.WrappedError({message:"client is ending",fatal:h.ending()});return s.retryOnReject(()=>this.submit(e,t),{maxRetries:this.opts.retriesPerRequest,onRetryWaitUntil:e=>u.delay(this.opts.delayBetweenRetries*e).then(()=>f.until(()=>this.ready(),this.opts.requestTTL)),errorIsRetriable:e=>c.toS(e).includes("(retry)")})}))}submit(e,t){return i(this,void 0,void 0,(function*(){if(this.ended){if(h.ending())return;throw new Error("client is ending")}if(o.blank(e))throw new Error("method cannot be blank");const n=yield this.stream();if(null==n)throw this.logger.error("Stream is closed, cannot submit",{ended:this.ended,method:e,params:t}),new Error("closed stream");const i=x.uid(),r=new _.RequestResponse(i,e,t,this.times);return r.setTimeout(this.opts.requestTTL),this.pending.set(i,r),this.logger.debug("sending request",{id:i,method:e,params:t}),n.write(JSON.stringify({id:i,method:e,params:t})+"\n"),r.response}))}close(){this.logger.info("close()",{ended:this.ended});const e=this._stream;return this._stream=void 0,b.end(e)}onData(e){if(!o.blank(e))try{const t=JSON.parse(e);if(o.blank(t.sid))throw new Error("response is missing server id");if(this.sid!==t.sid&&(null!=this.sid&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:t.sid}),this.eventEmitter.emit("rpcServerChange")),this.sid=t.sid,h.ending()))return;if(null==t.id){if(o.notBlank(t.event))return this.logger.info("re-broadcasting event",t),void this.eventEmitter.emit(t.event,...l.orElse(t.args,[]));throw new Error("missing request id from response")}const n=this.pending.pop(t.id);null==n?this.logger.warn("unknown or stale request ID",{resp:t,pendingIds:[...this.pending.keys()]}):t.error?(n.reject(t.error.message||t.error),this.logger.warn("Rejected",{resp:t,rr:n})):(n.resolve(t.result),this.logger.debug("Resolved",t.result))}catch(t){this.logger.warn("invalid input: "+e,t)}}onError(e,t){return i(this,void 0,void 0,(function*(){this.logger.warn(e+" onError(): "+l.map(t,e=>e.stack||e)),yield this.close(),this.ended||!1!==(yield this.restart())||this.logger.warn("Too many recent errors, we'll try reconnecting again in a bit")}))}restart(){return i(this,void 0,void 0,(function*(){if(this.logger.info("restart()",{ended:this.ended}),this.ended)return!1;if(this.mkStreamRate.msSinceLastEvent<5*a.secondMs||P.gt(this.mkStreamRate.eventsPerMinute,10))return this.logger.warn("restart(): rate too high. Vetoing...",this.mkStreamRate),!1;if(this.close(),null!=(yield this.stream())){const e=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+e.length+" jobs now:"),e.forEach(e=>e.reject("restarting (retry)")),e.forEach(e=>e.d.promise.catch(()=>{})),!0}return this.logger.warn("restart(): no new stream."),!1}))}needNewStream(){return!this.ended&&null==this._stream}stream(){return i(this,void 0,void 0,(function*(){return this.needNewStream()&&(yield this.mkStream()),this._stream}))}onFinish(e,t){if(!this.ended)return this.logger.info("onFinish",{source:e,error:t}),null==t||!1===t?this.restart():this.onError(e,t)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(30),r=n(0),s=n(48);class o{constructor(e,t,n,i){this.id=e,this.method=t,this.params=n,this.timer=i;const r="rpc.RequestResponse("+t+")#"+e;this.d=new s.Deferred(r)}[i.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),r.map(this.d.settledMs,e=>this.timer.push(this.method,e)))}reject(e){this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}}t.RequestResponse=o},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(62),s=n(6),o=n(2),a=n(15),u=n(8),l=n(53),c=n(20),d=n(13),h=n(29),f=n(244),p=n(4),m=n(11),g=n(32),y=n(245),v=n(119),b=n(127),w=n(73),S=o.lazy(()=>p.mkLogger("ValidFile")),M=new l.BoundedMap(10*s.minuteMs,1024,!0);function P(e){return i(this,void 0,void 0,(function*(){if(m.Settings.validateJpegImages.valueOrDefault||m.Settings.validateVideos.valueOrDefault)return f.getOrSetByNativePath(e,E,M);S().debug("no validation for "+e,{validateJpegImages:m.Settings.validateJpegImages.valueOrDefault,validateVideos:m.Settings.validateVideos.valueOrDefault})}))}function E(e){return i(this,void 0,void 0,(function*(){const t=h.PosixFile.for(e);try{const e=yield g.mimetype(t);if(null==e)throw new Error("Cannot validate, no mimetype");if(w.isVideoMimeType(e))m.Settings.validateVideos.valueOrDefault&&(S().debug("validating "+t),yield b.validVideo(t));else{if(!e.startsWith("image/"))throw new Error("Unsupported mimetype, "+e);if("image/jpeg"===e){if(m.Settings.validateJpegImages.valueOrDefault)return yield y.validJpeg(t)}else if(m.Settings.validateRawImages.valueOrDefault){const e=yield v.sharpReadable(t);if(null==e)throw new Error("Cannot read");yield r(e.nativePath,{failOnError:!0}).tiff().toBuffer()}}}catch(e){throw new c.WrappedError({cause:e,message:"invalid file "+t,retriable:!1,ignorable:!0})}}))}d.onClearCache(()=>M.clear()),d.onFileChanged(e=>a.Opt(e).forEach(e=>{M.delete(e)}).orElse(()=>{M.clear()})),t.isValidFile=function(e){return i(this,void 0,void 0,(function*(){return u.resolved(P(e))}))},t.validFile=P},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(4),s=n(138),o=n(170),a=n(8);t.AdvisoryLock=class{constructor(e){this.name=e,this.locks=[],this.logger=r.mkLogger("AdvisoryLock("+this.name+")")}get idle(){return 0===this.locks.length}acquire(){const e=s.uid(),t=new o.AdvisoryLockRequest(e),n=[...this.locks];return this.locks.push(t),n.length>0&&this.logger.info("Waiting for "+n.length+" prior locks to complete..."),a.awaitAll(n.map(e=>e.released.promise)).then(()=>(this.logger.debug("acquired for "+e),e))}release(e){const t=this.locks.find(t=>t.id===e);if(null==t)return this.logger.error("release(): unknown UID",{id:e,currentLockIds:this.locks.map(e=>e.id)}),!1;const n=t.id===this.locks[0].id;return t.released.resolve(),i.filterInPlace(this.locks,t=>t.id!==e),n?this.logger.debug("released for "+e):this.logger.error("release(): premature release by "+e),n}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(62),s=n(2),o=n(5),a=n(10),u=n(87),l=n(12),c=n(8),d=n(4),h=n(76),f=n(203),p=n(14),m=n(32),g=n(135),y=n(119),v=s.lazy(()=>d.mkLogger("matchRotation"));function b(e){return r(e.nativePath).removeAlpha().trim().toColorspace("srgb").resize(Object.assign(Object.assign({},t.Dim),{fastShrinkOnLoad:!0,withoutEnlargement:!0,fit:"fill"}))}function w(e,t){const n=new h.Average;for(let i=0;i<Math.min(e.length,t.length);i+=3)n.push(g.diffCIE94(e.slice(i,i+3),t.slice(i,i+3)));return n}t.Dim={width:64,height:64,channels:3},t.matchRotation=function(e,n,r){return i(this,void 0,void 0,(function*(){const s=Date.now(),d=yield y.sharpReadable(e,t.Dim);if(null==d)return void v().warn("cannot read "+e.nativePath);let h=b(d);const S=u.normalizeRotation(yield c.thenOrElse(r,()=>m.readRotation(e)));p.mapGt0(S,e=>h=h.rotate(e));const M=yield h.raw().toBuffer({resolveWithObject:!0}),P=yield c.thenMap(y.sharpReadable(n,t.Dim),e=>i(this,void 0,void 0,(function*(){return b(e).raw().toBuffer({resolveWithObject:!0})})));if(null==P)return void v().warn("cannot read "+n.nativePath);const E=g.rgb2labs(M.data),x=new f.SquareMatrix(g.rgb2labs(P.data),3),_=[0,90,180,270].map((e,t)=>a.tap({rotation:e,diffCieAvg:w(E,x.m)},()=>t<3&&x.rotate(90)));return v().tap({msg:"matchRotation",meta:{a:e.nativePath,b:n.nativePath,maybe_aRotation:r,elapsedMs:Date.now()-s,arr:_},result:l.leastBy(_,e=>[o.round(e.diffCieAvg.avg),o.round(e.diffCieAvg.stdDev),o.round(e.diffCieAvg.max)])})}))},t.diffLab=w},function(e,t){e.exports=require("knex")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(4),r=n(3),s=n(10),o=n(107),a=n(103),u=i.mkLogger("mkUpsertSql");t.mkUpsertSql=function(e,t,n){if("id"===t&&null==n[t]){const t=a.toSqlQuery(o.knex(e).insert(n));return u.info("no ucn, using simple insert",t),t}if("id"!==t&&null==n[t])throw new Error("Invalid "+e+": missing UCN "+t);const i=s.keys(s.without(n,t,"id","createdAt")).map(e=>e+"=$"+e).join(","),l=s.keys(n),c=l.map(e=>"$"+e),d=["INSERT INTO `",e,"`(",l.join(","),") VALUES (",c.join(","),`) ON CONFLICT(${t}) DO `];return r.blank(i)?d.push("NOTHING "):d.push(`UPDATE SET ${i} WHERE ${t} = $${t}`),{sql:d.join(""),bindings:n}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),s=n(1),o=n(2),a=n(45),u=n(0),l=n(5),c=n(19),d=n(69),h=n(166),f=n(103),p=n(292),m=n(13);t.batchedUnion=function(e,t){return i(this,void 0,void 0,(function*(){const n=new h.DbRequestRemote,s=new g(e.model,n),o=[],a=t.map(e=>i(this,void 0,void 0,(function*(){return r.thenMap(e(s),e=>o.push(...c.toA(e)))})));return yield n.submit(),yield Promise.all(a),o}))},m.onClearCache(()=>g.instances.clear());class g{constructor(e,t){this.model=e,this._dbr=t,this.columnNames=o.lazy(()=>r.thenMap(d.dbClient().request("tableInfo",this.tableName),e=>e.map(e=>e.name)))}static forModel(e){const t=e;return a.getOrSet(this.instances,t.tableName,()=>new g(t))}get tableName(){return this.model.tableName}toModel(e){return r.thenMap(e,e=>this.model.fromJSON(e))}toModels(e){return e.then(e=>c.toA(e).map(e=>this.model.fromJSON(e)))}first(e,t){return h.dbr(t=>this.toModel(t.first(e)),u.orElse(t,this._dbr))}all(e,t){return h.dbr(t=>this.toModels(t.all(f.maybeLimit(e))),u.orElse(t,this._dbr))}findOne(e,t){return h.dbr(t=>this.toModel(t.first(e)),u.orElse(t,this._dbr))}findById(e,t){return this.findOne(this.model.query().where({id:e}),u.orElse(t,this._dbr))}findByIds(e){return this.toModels(d.dbClient().request("findByIds",{tableName:this.tableName,ids:e}))}findOneBy(e,t){return this.first(this.model.queryBy(e),u.orElse(t,this._dbr))}findBy(e,t){return this.all(this.model.queryBy(e),u.orElse(t,this._dbr))}rows(e){return this.count(this.model.query(),u.orElse(e,this._dbr))}count(e,t){return h.dbr(t=>t.pluckFirst(e),u.orElse(t,this._dbr))}insert(e){return this.toModel(d.dbClient().request("insert",{tableName:this.tableName,model:this.model.toDbJSON(e)}))}upsertOne(e){return this.upsert([e]).then(e=>e[0])}get ucn(){return this.model.uniqueColumnName}upsert(e){return i(this,void 0,void 0,(function*(){const t=yield this.columnNames();return this.toModels(d.dbClient().request("upsert",{tableName:this.tableName,models:e.map(e=>this.model.toDbJSON(e,t))}))}))}delete(e,t){return s.mapNotEmpty(e.filter(l.gt0),e=>h.dbr(t=>t.run(this.model.query().delete().whereIn("id",e)),t))}}t.ModelOpsRemote=g,g.instances=new Map,g.fetchTableInfo=o.lazy(()=>p.remoteTableInfo().then(e=>g.tableInfo=e))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(84),r=n(166);function s(e){const t=new i.MultiMap;return e.forEach(e=>t.add(e.tableName,{name:e.columnName,type:e.columnType})),t.entriesArray().map(([e,t])=>({tableName:e,columns:t}))}t.parseTableInfo=s;const o="SELECT \nm.tbl_name as tableName,\np.name AS columnName,\np.type AS columnType,\nFROM sqlite_master AS m\nLEFT JOIN pragma_table_info(m.name) AS p\nORDER BY m.tbl_name, p.cid";t.localTableInfo=function(e){return s(e.prepare(o).all())},t.remoteTableInfo=function(){return r.dbr(e=>e.all(o)).then(s)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(6),r=n(2),s=n(5),o=n(271),a=n(12),u=n(77),l=n(294);function c(e){return a.zip(t.primeLists(),l.digits(e,o.primesPerBin,6).reverse()).map(([e,t])=>e[t])}t.prngOrderByClause=function(e,n,i){const[r,s,o,a,u]=t.primes(e),l=`(${n}%${a})`;return`ROUND(${`(${r}*${l}*${l}+${s}*${l})`}*${`(${o}*${l}+${a})`}+${`${u}+${n}`})${i?"%"+i:""}`},t.prng=function(e,n,i){const[r,s,o,a,u]=t.primes(e),l=n%a,c=(r*l*l+s*l)*(o*l+a)+u+n;return Math.round(c)%i},t.primeLists=r.lazy(()=>[[21683,39301,45853,57427,58991,65543],[262139,314569,366997,419429,471871,524309],[1048573,1258291,1468079,1677811,1887539,2097257],[10392467,22222223,32457869,42638597,58947631,68956417,84619573],[353868013,472882027,573259391,694847533,756065159,899809343],[2147483647,3743895347,4295032837,5949670231,6607882123,8753196421]]),t.primeSeeds=c,t.primes=u.memoize(e=>{const[t,n,i,r,a,u]=c(e%o.SeedCount);return[...[i/t,r/n,a/i,u/r].map(e=>s.sigFigs(e,6)),i]},1*i.minuteMs,256)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.digits=function(e,t,n){const i=[];for(;e>0;){const n=e%t;i.push(n),e=Math.floor(e/t)}for(;null!=n&&i.length<n;)i.push(0);return i.reverse()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),r=n(78);t.TagUrls=class{constructor(e){this.id=e}nextAssetBatch(e){const t={};return i.map(e,e=>t.capturedAtLt=e.getTime()),r.joinQuery("/tag-gallery/"+this.id,t)}}},function(e,t){e.exports=require("better-sqlite3")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(29),r=n(0),s=n(107),o=n(191);class a extends o.StatsModel{static findByUri(e){return this.opsLocal().findOneBy({uri:e})}static getAggregate(e,t){const n=this.query().select({assetCount:s.knex.raw("sum(assetCount)"),fileCount:s.knex.raw("sum(fileCount)"),dirCount:s.knex.raw("count(id)")});t(n);const i=this.dbLocal().first(n);return r.map(i,t=>t.rootUri=e),i}static getPathAggregates(e){return this.getAggregate(e,t=>t.where("uri","like",e+"%"))}static getFullAggregates(){return this.getAggregate("",()=>{})}static touchSubpaths(e){return this.dbLocal().run(this.query().where("uri","like",e+"%").update({updatedAt:Date.now()}))}static allForRootUri(e){return this.ops().all(this.query().where("uri","like",e+"%").orderBy("id"))}static deleteStaleForRoot(e,t){return this.dbLocal().run(this.query().where("uri","like",e+"%").where("updatedAt","<",t).delete())}get posixFile(){return i.PosixFile.forUri(this.uri)}}t.DirStat=a,a.tableName="DirStat",a.uniqueColumnName="uri"},function(e,t){e.exports=require("@sentry/node")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(44),s=n(18),o=n(43),a=n(24),u=n(4),l=n(89),c=n(6),d=n(2).lazy(()=>u.mkLogger("OpenedBy"));function h(e){return e.join("opened-by.json")}t.OpenedByTimeout=10*c.minuteMs,t.openedByFile=h,t.readOpenedBy=function(e){var n,o;return i(this,void 0,void 0,(function*(){const i=h(e),a=yield i.readJSON();if(null==a)return;if((null!==(n=a.lastTouchedMs)&&void 0!==n?n:0)<Date.now()-t.OpenedByTimeout)return d().warn("readOpenedBy("+e+"): Cleaning up expired opened-by file",a),void(yield i.unlink());const u=s.pid===(null!==(o=a.pid)&&void 0!==o?o:-1);if(!u&&a.hostname===r.hostname()){if(!(yield l.pidExists(a.pid)))return d().warn("Cleaning up opened-by file (pid doesn't exist)",a),void(yield i.unlink());d().warn("library is still running locally",a)}return d().tap({msg:"readOpenedBy()",result:Object.assign(Object.assign({},a),{pidMatches:u})})}))};class f extends a.EndableWrapper{constructor(e){super("OpenedByWriter("+h(e)+")",()=>this.onEnd()),this.libraryDataDir=e,this.logger=u.mkLogger(this.name),this.file=h(e),this.timer=o.setInterval(()=>this.write(),.5*t.OpenedByTimeout),a.addLoggerEndable(this)}write(){return i(this,void 0,void 0,(function*(){return this.logger.tap({msg:"write()",level:"info",result:yield this.file.writeJSON({hostname:r.hostname(),pid:s.pid,lastTouchedISO:(new Date).toISOString(),lastTouchedMs:Date.now()},{spaces:2})})}))}onEnd(){return clearInterval(this.timer),this.file.unlink()}}t.OpenedByWriter=f},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),s=n(6),o=n(2),a=n(0),u=n(83);let l=0;t.rpcAllowed=function(e,t){return i(this,void 0,void 0,(function*(){return r.until(()=>0===l,a.orElse(e,()=>u.randomInt(5*s.secondMs,15*s.secondMs)),a.orElse(t,()=>u.randomInt(250,1e3)))}))},t.pauseRpc=function(e=s.secondMs){l++;const t=o.lazy(()=>l--);return setTimeout(t,e),t}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(126),s=n(13),o=n(42),a=n(4),u=n(11),l=n(32),c=n(1),d=n(0);function h(e){return e.toDateTime().toFormat(u.Settings.assetSubdirectoryDatestampFormat.valueOrDefault).split(/[\\/]/)}t.directoryForDate=h;t.AssetFileRepository=class{constructor(e,t){this.root=e,this.copyAssets=t,this.logger=a.mkLogger("AssetFileRepository")}directoryForDate(e){return this.root.join(...h(e))}importFile(e){return i(this,void 0,void 0,(function*(){if(!this.copyAssets())return e;if(yield e.isDescendantOf(this.root))return this.logger.debug("no-op: "+e+" already contained by "+this.root),e;this.logger.debug("importing "+e);const t=yield l.readTags(e);if(null==t)throw new Error(e.nativePath+" has no tags (so, no createdAt)");const n=d.map(t.capturedAt,e=>o.toFuzzyDate(e.date));if(null==n)throw new Error(e.nativePath+" has no capturedAt");if(null==n.year||null==n.month||null==n.day)throw new Error(e.nativePath+" capturedAt has insufficient precision: "+t.capturedAt);const i=this.directoryForDate(n);if(null==(yield i.mkdirp()))throw new Error("Cannot create destination directory, "+i.nativePath+" for "+e.nativePath);const s=yield i.children(),a=yield e.size(),u=yield r.filter(s,e=>e.size().then(e=>e===a)),c=yield e.sha();if(u.length>0){const t=yield r.filter(u,e=>e.sha().then(e=>e===c));if(t.length>0){const n=t[0];return this.logger.info(e+" matches "+n),this.handleSidecars(e,n)}}const h=yield i.join(e.base).ensureNew();this.logger.info("Copying...",{src:e.nativePath,dest:h.nativePath});const f=yield e.copyFile(h);return this.handleSidecars(e,f)}))}handleSidecars(e,t){return i(this,void 0,void 0,(function*(){const n=d.orElse(yield e.sidecars(),[]);for(const e of n)yield this.handleSidecar(e,t);return c.isNotEmpty(n)&&s.emitFileChanged(t.nativePath),t}))}handleSidecar(e,t){return i(this,void 0,void 0,(function*(){for(const n of d.orElse(yield t.sidecars(),[]))if(yield l.sidecarEql(e,n))return void this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:n,dest:t});const n=yield t.parent().join(t.name+e.ext).ensureNew({emptyIsNew:!0});return e.copyFile(n)}))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(191);class r extends i.StatsModel{}t.Queue=r,r.tableName="Queue",r.uniqueColumnName="name"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(191);class r extends i.StatsModel{}t.QueueItem=r,r.tableName="QueueItem",r.uniqueColumnName="contents"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(44),r=n(6),s=n(2),o=n(12);t.OS=s.lazy(()=>[i.platform(),i.release(),"on",i.arch()].join(" ")),t.CPUs=s.lazy(()=>o.uniqCount(i.cpus().map(e=>e.model)).map(e=>`${e.count} Ã ${e.t}`).join(", "),r.minuteMs)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(26),r=n(16),s=n(11),o=n(2);t.sentryEnabled=o.lazy(()=>i.isProd&&r.isPacked&&s.Settings.reportErrors.valueOrDefault),s.Settings.reportErrors.addListener(()=>t.sentryEnabled.clear())},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(2),s=n(8),o=n(22);t.JsonFileStore=class{constructor(e,t,n=o.identity,i=o.identity){this.file=e,this.onCreate=t,this.onRead=n,this.onWrite=i,this.prior=r.lazy(()=>s.thenAnd(this.file.exists(),()=>this.file.readJSON()))}read(){return i(this,void 0,void 0,(function*(){const e=yield this.prior();return null!=e?this.onRead(e):s.thenMap(this.onCreate(),e=>this.write(e))}))}write(e){return i(this,void 0,void 0,(function*(){return yield this.file.writeJSON(yield this.onWrite(e),{spaces:2}),this.prior.set(Promise.resolve(e)),e}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(259),s=n(6),o=n(5),a=n(55),u=n(308),l=n(311);t.Previews=class{constructor(e,t){this.root=e,this.alp=t,this.id2ap=new a.TTLMap(2*s.minuteMs)}build(e){return i(this,void 0,void 0,(function*(){return this.apb(e.assetId,e.assetFiles).build(e)}))}apb(e,t){return new u.AssetPreviewBuilder(this.ap(e),t)}ap(e){const t=this.id2ap.get(r.id2id(e));if(null!=t&&r.idEql(e,t.assetId))return t;{const t=new l.AssetPreviews(this.root,e,this.alp);return o.isNumber(e)||this.id2ap.set(r.id2id(e),t),t}}clearAssetId(e){this.id2ap.delete(e)}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(62),s=n(30),o=n(1),a=n(80),u=n(0),l=n(10),c=n(66),d=n(23),h=n(20),f=n(29),p=n(113),m=n(4),g=n(22),y=n(11),v=n(270),b=n(309),w=n(178),S=n(310),M=n(119),P=n(286);class E{constructor(e,t){this.ap=e,this.assetFiles=t,this.logger=m.mkLogger("AssetPreviewBuilder("+e.assetId+")")}[s.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build(e){return c.time("img.AssetPreviewBuilder.build()",()=>i(this,void 0,void 0,(function*(){const t=yield v.sortAssetFiles(yield this.assetFiles);for(;o.isNotEmpty(t);){const n=t.pop();try{return yield this._build(n,e)}catch(e){this.logger.warn("Failed to set shown file to "+n,e)}}return this.logger.error("no files built.",t),this.logger.throw("no valid files are available")})))}_build(e,t){return i(this,void 0,void 0,(function*(){if(null==e)return this.logger.throw("_build(): best was undefined");this.logger.info("_build("+e+")",t);const n=yield f.PosixFile.forUri(e.uri);if(null==n)return this.logger.throw("_build: failed to create PosixFile",{best:e});d.isTrue(t.validate)&&(yield P.validFile(n));const i=yield n.size(),s=yield n.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:i,mtime:s,best:e}),null==i||null==s)return this.logger.throw("IE build(): missing stat info for best file "+e);if(null==e.width||null==e.height||null==e.mimetype||null==e.sha)return this.logger.throw("IE build(): missing fields for best file "+n,e);const o=b.fitSizes(e,e.rotation,e.mimetype),c=Object.assign(Object.assign({assetFileId:e.id},l.pick(e,"assetId","uri","width","height","mimetype","sha","rotation")),{path:n.nativePath,mtime:s,filesize:i,fitSizes:o.map(([,e])=>e.name).join(",")});if(!d.isTrue(t.force)&&!y.Settings.forceSync.valueOrDefault){const t=yield this.ap.readInfo.refresh();if(null!=t){if(t.assetId!==c.assetId)throw new Error("IE build(): Mismatched asset IDs for "+e+": "+JSON.stringify({priorInfo:t,info:c}));if(null!=t.sha&&t.sha===c.sha&&t.rotation===c.rotation&&b.equivalentFitSizes(t.fitSizes.split(","),c.fitSizes.split(",")))return this.logger.debug("build(): no-op: SHA and rotation match.",{info:c,priorInfo:t}),yield this.ap.writeInfo(c),c}}const m=new p.PushProgressObserver({path:n.nativePath,op:"Building previews for"},w.ImageSize.sq().length+w.ImageSize.fit().length);if(this.logger.debug("Rebuilding all previews from "+e.uri,{assetId:e.assetId,best:e,info:c}),null==(yield this.ap.parent.mkdirp()))throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+e);const v=yield this.ap.existingFiles(),E=yield M.sharpReadable(n,w.ImageSize.largestFit().max);if(null==E)throw new h.WrappedError({message:"build(): "+e+" is not readable by sharp.",retriable:!1});const x=r(E.nativePath).toColorspace("srgb");e.mimetype.startsWith("image/")&&null!=e.rotation&&0!==e.rotation&&(x.rotate(e.rotation),this.logger.debug("build(): rotating "+e.rotation+"Â°")),E.name.toLowerCase().includes("thumbnail")&&g.Try(()=>x.trim(1));const _=[];let F,T;const O=l.pick(e,"width","height");{let e=x.clone(),t=O;for(const[n,i]of o){const r=Date.now(),s=t,o=this.ap.fileForWidth(i.reducer.name,n.width).wip();if(e=yield S.applyAndClone(i.resize(n,e)),t=n,null==T){null!=w.ImageSize.largestSq().outputSize(n)?(T=e.clone(),F=n):(T=x,F=O)}yield i.toJpeg({path:o.nativePath,sh:e.clone(),outputSize:n}),m.onProgress(),this.logger.debug("resize("+i.name+") "+a.dimToS(s)+" -> "+a.dimToS(n)+" in "+(Date.now()-r)+" ms"),_.push(o)}}null==T&&(T=x,F=O);for(const e of w.ImageSize.sq()){const t=Date.now(),n=F,i=e.outputSize(u.orElse(F,O));if(null==i)continue;const r=this.ap.fileForWidth(e.reducer.name,i.width).wip();T=yield S.applyAndClone(e.resize(i,T)),F=i,yield e.toJpeg({path:r.nativePath,sh:T.clone(),outputSize:i}),m.onProgress(),_.push(r),this.logger.debug("resize("+e.name+") "+a.dimToS(n)+" -> "+a.dimToS(i)+" in "+(Date.now()-t)+" ms")}return yield Promise.all(v.map(e=>e.unlink())),yield Promise.all(_.map(e=>e.unwip())),yield this.ap.writeInfo(c),c}))}}t.AssetPreviewBuilder=E},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(80),s=n(5),o=n(4),a=n(178),u=o.mkLogger("FitSizes");function l(e){return"qhd"===e?"wvga":"uhd"===e?"uhd4k":e}t.fitSizes=function(e,t,n){const i=a.ImageSize.fit();u.debug("fitSizes()",{dim:e,rotation:t,sizes:i});const o=i.map(t=>[t.outputSize(e),t]).filter(([e])=>null!=e);let l=e;return o.filter(([e],i)=>function(e,i){const o=r.dmegapixels(l)/r.dmegapixels(e),a=0===i&&("image/jpeg"!==n||s.gt0(t))||o>3||r.dmegapixels(e)-r.dmegapixels(l)>2.5;return a&&(l=e),a}(e,i))},t.equivalentFitSizes=function(e,t){return i.includesAll(i.compactBlanks(e).map(l),i.compactBlanks(t).map(l))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(62),s=n(10);function o(e,t){return r(e,{raw:s.pick(t,"width","height","channels")})}t.applyAndClone=function(e){return i(this,void 0,void 0,(function*(){const t=yield e.raw().toBuffer({resolveWithObject:!0});return o(t.data,t.info)}))},t.sharpFromBuffer=o},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(259),s=n(1),o=n(160),a=n(88),u=n(2),l=n(0),c=n(12),d=n(8),h=n(66),f=n(4),p=n(9),m=n(248);t.previewTimers=new h.PromiseTimer;t.AssetPreviews=class{constructor(e,t,n){this.previewsRoot=e,this.alp=n,this.readInfo=u.lazy(()=>this.infoJson().readJSON()),this.logger=f.mkLogger("AssetPreviews(assetId:"+r.id2id(t)+")"),this.assetId=r.id2id(t),this.urls=new o.AssetUrls(t);const i=p.leftPad(this.assetId,8,"0"),s=p.splitEvery(i,3);this.basename=s.pop()+"-",this.parent=e.join(...s)}existingFiles(){return d.thenOrElse(this.parent.childFiles(e=>e.base.startsWith(this.basename)),()=>[])}existingJpgs(){return d.thenOrElse(this.parent.childFiles(e=>e.base.startsWith(this.basename)&&".jpg"===e.ext),()=>[])}previews(){return i(this,void 0,void 0,(function*(){const e=yield this.existingFiles();return d.sortByAsync(s.compact(e.map(e=>m.extractPreviewInfo(this.previewsRoot,e))),e=>null==e?void 0:e.file.size())}))}deleteAll(){return i(this,void 0,void 0,(function*(){this.parent.clear();const e=yield this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return yield Promise.all(e.map(e=>e.unlink())),e}))}file(e){return this.parent.join(this.basename+e)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(e){return this.readInfo.clear(),this.infoJson().writeJSON(e,{spaces:2})}fileForWidth(e,t){return this.file(e+"-w"+t+".jpg")}filesForReducer(e){const t=this.basename+e+"-";return this.existingFiles().then(e=>e.filter(e=>e.base.startsWith(t)))}smallestFileForReducer(e){return i(this,void 0,void 0,(function*(){return c.leastBy(yield this.filesForReducer(e),e=>l.orElse(l.map(m.extractPreviewInfo(this.previewsRoot,e),e=>e.width),0))}))}largestFileForReducer(e){return i(this,void 0,void 0,(function*(){return c.greatestBy(yield this.filesForReducer(e),e=>l.orElse(l.map(m.extractPreviewInfo(this.previewsRoot,e),e=>e.width),0))}))}widths(e){return i(this,void 0,void 0,(function*(){const t=yield this.filesForReducer(e);return s.sort(s.compact(t.map(e=>l.map(m.extractPreviewInfo(this.previewsRoot,e),e=>e.width))))}))}posterLink(){return i(this,void 0,void 0,(function*(){const e=yield this.widths(a.ReducerNames.fit);return this.urls.imgLink(a.ReducerNames.fit,Math.max(...e))}))}imgAttrs(e,t=!1,n=!0){return i(this,void 0,void 0,(function*(){if(t||e!==a.ReducerNames.sq){const t=e===a.ReducerNames.fit?yield this.readInfo():void 0;return this.urls.imgAttrs(e,yield this.widths(e),n,t)}return this.urls.sqImgAttrs(n)}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(170),s=n(4),o=n(313),a=n(11),u=n(46),l=n(93),c=n(149),d=n(104),h=n(172),f=n(315),p=n(147),m=n(316);function g(e){const t=()=>u.tot(e),n=new h.DbRequestLocal(t),i=s.mkLogger("DbServer()");return{acquireAdvisoryLocks:e=>r.AdvisoryLocks.acquireAdvisoryLocks(e.names),releaseAdvisoryLocks:e=>r.AdvisoryLocks.releaseAdvisoryLocks(e.locks),truncate:()=>p.tx(t(),"truncate",()=>m.truncateTables(t())),tableInfo:e=>p.tx(t(),"tableInfo",()=>t().pragma(`table_info(${e})`)),tagRoots:()=>p.tx(t(),"tagRoot",()=>d.Tag.roots()),tagFindOrCreate:e=>p.tx(t(),"tagFindOrCreate",()=>d.Tag.findOrCreate(e)),assetAddTags:({assetId:e,tagPaths:n})=>p.tx(t(),"assetAddTags",()=>l.Asset.addTags(e,n)),assetRemoveTags:({assetId:e,tagPaths:n})=>p.tx(t(),"assetRemoveTags",()=>l.Asset.removeTags(e,n)),assetArchive:e=>p.tx(t(),"assetArchive",()=>l.Asset.archive(e)),findByIds:e=>p.tx(t(),"findByIds",()=>c.ModelOpsLocal.forTableName(e.tableName).findByIds(e.ids)),insert:e=>p.tx(t(),"insert",()=>c.ModelOpsLocal.forTableName(e.tableName).insert(e.model)),upsert:e=>p.tx(t(),"upsert",()=>c.ModelOpsLocal.forTableName(e.tableName).upsert(e.models)),batch:e=>{if(i.debug("batch()",{requests:e}),!Array.isArray(e))throw new Error("Missing batch.requests");return p.tx(t(),"batch",()=>h.execBatch(n,e))}}}t.mkDbServer=function({db:e,port:t=a.Settings.rpcPort.valueOrDefault,unref:n=!0}){return i(this,void 0,void 0,(function*(){const i=new o.Server(t,n);return i.addSimpleHandlers(g(e)),i.addSimpleHandlers(r.AdvisoryLockHandlers),i.addSimpleHandlers(f.RpcServiceHandlers),yield i.start(),i}))},t.mkDbHandlers=g},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(246),s=n(18),o=n(1),a=n(3),u=n(6),l=n(59),c=n(2),d=n(0),h=n(10),f=n(162),p=n(7),m=n(24),g=n(8),y=n(66),v=n(58),b=n(21),w=n(20),S=n(13),M=n(97),P=n(67),E=n(72),x=n(4),_=n(54),F=n(14),T=n(65),O=n(11),A=n(314),k=n(300),D=x.mkLogger("rpc.Server"),C=({params:e,conn:t})=>(a.mapNotBlank(e.serviceName,e=>{a.blank(t.serviceName)&&(t.serviceName=e)}),F.mapGt0(e.pid,e=>{a.blank(t.pid)&&(t.pid=e)}),`pong to ${t.serviceName}@${t.pid} from ${T.serviceName()}@${s.pid} at ${new Date}`);class I{constructor(e){this.socket=e}toString(){return a.blank(this.serviceName)?P.remoteDesc(this.socket):`${this.serviceName}@${this.pid}`}}t.ClientConnection=I;t.Server=class{constructor(e,t=!0){this.port=e,this.unref=t,this._ended=!1,this._ready=new l.Latch,this.connections=[],this.onPause=()=>this.broadcast("pause"),this.onResume=()=>this.broadcast("resume"),this.handlers=new Map,this.sid=c.lazy(()=>_.Radix58.randomChars(12)),this.start=f.throttle(()=>i(this,void 0,void 0,(function*(){if(!this.ended)return D.debug("start("+this.port+")"),this.server=r.createServer(this.onConnect.bind(this)),this.server.on("listening",()=>{this._ready.resolve()}),this.server.on("error",e=>i(this,void 0,void 0,(function*(){yield this.onError("createServer",e),v.setUnrefTimeout(()=>this.start(),5e3)}))),this.server.listen(this.port,O.Settings.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise})),5e3),this.end=c.lazy(()=>i(this,void 0,void 0,(function*(){this._ended=!0,S.eventEmitter.removeListener("pause",this.onPause),S.eventEmitter.removeListener("resume",this.onResume),yield this.closeAllConnections(),yield P.close(this.server)}))),this.name="Server:"+e,this.addHandler("ping",C),S.onPause(this.onPause),S.onResume(this.onResume),m.addFirstEndable(this),A.setBroadcaster(this)}serialize(e){return i(this,void 0,void 0,(function*(){return JSON.stringify(Object.assign({sid:this.sid()},e))+"\n"}))}addHandler(e,t){const n=this.handlers.get(e);null!=n&&D.warn("addHandler(): overwriting",{method:e,prior:n,newHandler:t}),this.handlers.set(e,t)}addSimpleHandler(e,t){this.addHandler(e,({params:e})=>t(e))}addSimpleHandlers(e){h.entries(e).forEach(([e,t])=>this.addSimpleHandler(e,t))}get ended(){return this._ended||m.ending()}get ready(){return this._ready.promise}closeAllConnections(){const e=this.connections.map(e=>P.end(e.socket));return this.connections.length=0,Promise.all(e)}broadcast(e,...t){return this.sendAll({event:e,args:t})}sendAll(e,t="write"){return i(this,void 0,void 0,(function*(){const n=yield this.serialize(e),i=[...this.connections];let r=i.length;D.debug("sendAll()",{pojo:e,method:t});for(const e of i)"end"===t?e.socket.end(()=>r--):e.socket.write(n,()=>r--);return g.until(()=>r<=0,1e3)}))}onConnect(e){D.info("Connection from "+P.remoteDesc(e)),this.unref&&e.unref();const t=new I(e);this.connections.push(t),e.on("end",()=>{D.info("Closing connection from "+P.remoteDesc(e)),o.filterInPlace(this.connections,t=>t.socket!==e)}),e.on("error",t=>i(this,void 0,void 0,(function*(){D.warn("on error from "+P.remoteDesc(e)+": "+t),yield this.onError("socket",t),e.end()})));try{M.onDataChunked(e,"\n",e=>this.onRequest(e,t))}catch(t){D.warn("Caught error from "+P.remoteDesc(e)+": "+t),e.end()}}onRequest(e,t){return i(this,void 0,void 0,(function*(){if(D.debug("onRequest()",e),a.blank(e))return;let n="missing",i="missing";try{const r=JSON.parse(e);return a.mapNotBlank(r.id,e=>n=e),a.mapNotBlank(r.method,e=>i=e),yield k.rpcAllowed(),yield y.time("rpc."+i,()=>this.handle(n,i,r.params,t))}catch(i){D.warn("invalid request",{line:e,error:i}),t.socket.write(yield this.serialize({id:n,error:d.orElse(i.message,()=>p.toS(i))}))}}))}handle(e,t,n,r){return i(this,void 0,void 0,(function*(){D.debug("handle() called",{method:t,params:n,conn:p.toS(r)});const i=this.handlers.get(t);if(null==i)throw D.warn("bad handler request",{method:t,params:n,supported:h.keys(this.handlers)}),new Error("No handler for "+t);const{elapsedMs:s,result:o}=yield b.elapsedAsync(()=>i({id:e,method:t,params:n,conn:r}));D.log(E.ms2level(s,u.secondMs),"handle()",{method:t,elapsedMs:s,id:e,params:n,result:o}),r.socket.write(yield this.serialize({id:e,result:o}))}))}onError(e,t){return i(this,void 0,void 0,(function*(){this.ended||w.onError(e,t)}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(2),s=n(4),o=r.lazy(()=>s.mkLogger("Broadcaster"));var a;!function(e){e.broadcast=function(e,...t){return i(this,void 0,void 0,(function*(){return o().warn("broadcast sent to no-op",{event:e,args:t}),!1}))}}(a=t.NoOpBroadcaster||(t.NoOpBroadcaster={}));let u=a;t.setBroadcaster=function(e){u=e},t.broadcast=function(e,...t){u.broadcast(e,t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(11),r=n(35),s=n(86),o=n(124),a=n(247);t.RpcServiceHandlers=Object.freeze({libraryPath:()=>i.Settings.libraryPath.value,healthChecks:()=>a.libraryHealthChecks(),mountpoints:()=>r.mountpoints(),volumes:()=>s.volumes(),paused:()=>o.isPaused()})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(13),r=n(4),s=n(26),o=n(1),a=r.mkLogger("truncateTables()");t.truncateTables=function(e,...t){if(s.isProd)throw new Error("rejecting attempt to truncate in prod");i.emitClearCache();const n=o.isNotEmpty(t)?t:["AssetFile","AssetTag","Example","Progress","Tag","Asset"];return a.warn("truncating",n),n.map(t=>e.exec("DELETE FROM "+t))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(40),s=n(29),o=n(2);t.localDbDir=o.lazy(()=>i(void 0,void 0,void 0,(function*(){const e=s.PosixFile.for(r.App.getPath("userData")).join("localdb");return yield e.join("README.txt").writeTxt("\nThis folder is only used when your library is on a slow remote filesystem.\n\nYou will corrupt your library if you remove this directory while PhotoStructure is\nrunning.\n\nIf you have any questions, please visit <https://support.photostructure.com/>."),e})))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(48),s=n(24),o=n(8),a=n(13),u=n(4),l=n(86),c=n(3),d=n(0),h=n(319),f=n(180),p=n(265),m=n(190),g=n(264),y=n(266),v=n(148);class b extends s.EndableWrapper{constructor(e,t){super("ModelDbJanitor("+e+")",()=>this.onEnd()),this.dataDir=e,this.localDbDir=t,this.logger=u.mkLogger(this.name),this.db=new r.Deferred(this.name+".db"),this.backup=new r.Deferred(this.name+".backup"),this.srcDbFile=f.pathToDb(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),this.archiveDir=this.backupDir.sibling("archive"),a.eventEmitter.on("modelArchive",this.archive.bind(this)),s.addDbEndable(this),this.setup()}static for(e,t){return i(this,void 0,void 0,(function*(){const n=new b(e,t);return yield n.db.promise,yield n.backup.promise,n}))}onEnd(){return a.eventEmitter.removeListener("modelArchive",this.archive.bind(this)),d.map(this.backup.value,e=>i(this,void 0,void 0,(function*(){yield e.end(),yield e.janitor.end()})))}archive(e){return i(this,void 0,void 0,(function*(){try{if(c.blank(e.$pk()))return void this.logger.info("Cannot archive model, missing PK",{model:e});const t=this.archiveDir.join(e.$tableName()).join(e.$pk()+".json");yield t.writeJSON(e.toJSON()),this.logger.info("Saved model to "+t,e)}catch(t){this.logger.info("Failed to save model",{err:t,model:e})}}))}setup(){return i(this,void 0,void 0,(function*(){try{yield this._setup(),v.setModelDb(this.db.value)}catch(e){throw this.logger.error("setup failed: "+e,{dataDir:this.dataDir.nativePath}),this.db.reject(e),this.backup.reject(e),e}}))}_setup(){return i(this,void 0,void 0,(function*(){const e=yield this.backupDir.mkdirp();if(null==e)throw new Error("Failed to create models DB backup dir for "+this.srcDbFile);const t=(yield this.srcDbFile.exists())&&(yield o.thenOrElse(o.thenMap(l.volumeFor(this.dataDir.nativePath),e=>e.remote),()=>!1)),n=t?yield this.srcDbFile.shaMs():void 0,i=t&&null!=n&&n>500?yield this.localDbDir():void 0;if(null!=i){if(this.logger.info("DB is on a slow remote drive. Setting up local db cache."),this.localDbFile=f.pathToDb(i,"models"),null==(yield this.localDbFile.parent().mkdirp()))throw new Error("Failed to make local db cache dir for "+this.localDbFile);const t=yield g.sqliteFiles(this.localDbFile);if(yield Promise.all(t.map(e=>e.unlink())),!(yield m.backupDb(this.srcDbFile,this.localDbFile)))throw new Error("Failed to copy remote db to a local drive");this.logger.info("Local models db set up at "+this.localDbFile);const n=yield p.dbSetup(i,"models"),r=new y.SqliteJanitor("models",n);this.backup.resolve(new h.DbBackup(r,this.localDbFile,e,this.srcDbFile.parent())),this.db.resolve(n)}else{const t=yield p.dbSetup(this.dataDir,"models"),n=new y.SqliteJanitor("models",t);this.backup.resolve(new h.DbBackup(n,this.srcDbFile,e)),this.db.resolve(t)}this.logger.info("Finished setup",this.db.value)}))}}t.ModelDbJanitor=b},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(43),s=n(24),o=n(58),a=n(21),u=n(320),l=n(4),c=n(14),d=n(11),h=n(6),f=n(2),p=n(0),m=n(190),g=n(264);t.DefaultBackupFrequencyMs=1*h.hourMs,t.DefaultRetentionCount=24,t.stamp=function(e=new Date){return"."+a.filestampUTC(e)+"-"};class y extends s.EndableWrapper{constructor(e,t,n,a,m=(()=>{})){super("DbBackup("+t+")",()=>this.onEnd()),this.janitor=e,this.srcDb=t,this.backupsDir=n,this.replaceDir=a,this.onBackupFinished=m,this.onEnd=f.lazy(()=>i(this,void 0,void 0,(function*(){p.map(this.timer,e=>r.clearInterval(e)),this.timer=void 0,yield this.backup()}))),c.mapGt0(d.Settings.dbBackupFrequencyMinutes.valueOrDefault*h.minuteMs,e=>this.timer=o.setUnrefInterval(()=>this.backup().catch(e=>this.logger.warn("backup failed",e)),e)),this.hanoi=new u.Hanoi(n,d.Settings.dbBackupsCount.valueOrDefault),this.logger=l.mkLogger("DbBackup("+this.srcDb.baseWithGrandparent+" -> "+this.backupsDir.baseWithGrandparent+")"),s.addCleanupEndable(this)}verifyDb(e=this.srcDb){return m.verifyDb(e)}backup(e=""){return i(this,void 0,void 0,(function*(){try{if(yield this.srcDb.clear().isEmpty())return this.logger.warn("backup(): srcDb is missing, giving up."),!1;this.logger.info("backup(): housekeeping...",{srcDb:this.srcDb.nativePath,backupsDir:this.backupsDir.nativePath}),yield this.janitor.run(),this.logger.info("backup(): starting backup...");const t=this.backupsDir.join(this.srcDb.base);if(!(yield m.backupDb(this.srcDb,t)))return!1;if(this.logger.info("backup(): backup taken. Verifying."),!(yield this.verifyDb(t)))return!1;this.logger.info("backup(): verified. Rotating files.");const n=yield g.sqliteFiles(t);if(null!=this.replaceDir)for(const e of n)yield e.copyFile(this.replaceDir);const i=(yield this.hanoi.next(e)).toFilename();for(const e of n){const t=yield e.mv(e.withPrefix(i));this.logger.debug("mv "+e+" "+t)}for(const e of yield this.hanoi.staleFiles())this.logger.info("backup(): removing stale backup "+e),yield e.unlink();return this.logger.info("backup(): finished successfully"),!0}catch(e){return this.logger.error("Failed to back up db: "+e),!1}}))}}t.DbBackup=y},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(0),o=n(5),a=n(21),u=n(41),l=n(84);class c{constructor(e,t,n,i=a.filestampUTC()){this.seq=e,this.set=t,this.name=n,this.stamp=i}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return this.fromBasename(e.base)}static fromBasename(e){return s.map(this.parseRe.exec(e),e=>new c(parseInt(e[2],10),parseInt(e[3],10),e[4],e[1]))}}t.HanoiFile=c,c.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;t.Hanoi=class{constructor(e,t=10){this.root=e,this.sets=t,this.seq=this.fsMaxSeq().then(e=>({max:e+1})),this.mods=o.times(t+1,e=>Math.pow(2,t-e))}set(e){return this.sets-this.mods.findIndex(t=>e%t==0)}fsMaxSeq(){return i(this,void 0,void 0,(function*(){const e=yield this.hanoiFiles();return u.max([0,...e.map(e=>e.seq)])}))}maxSeq(){return this.seq.then(e=>e.max)}next(e){return i(this,void 0,void 0,(function*(){const t=(yield this.seq).max++;return new c(t,this.set(t),e)}))}hanoiFiles(){return i(this,void 0,void 0,(function*(){const e=yield this.root.clear().childNames();return r.compact(s.orElse(e,[]).map(e=>c.fromBasename(e)))}))}staleHanoiFiles(){return i(this,void 0,void 0,(function*(){const e=[],t=new l.MultiMap;return yield this.hanoiFiles().then(e=>e.forEach(e=>t.add(e.set,e))),[...t.keys()].forEach(n=>{const i=t.get(n),r=u.max(i.map(e=>e.seq));i.filter(e=>e.seq<r).forEach(t=>e.push(t))}),e}))}staleFiles(){return i(this,void 0,void 0,(function*(){return this.staleHanoiFiles().then(e=>e.map(e=>e.toFile(this.root)))}))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqliteSuffixes=["-wal","-journal"]},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(323),s=n(4),o=n(1),a=n(3),u=n(6),l=n(28),c=n(2),d=n(0),h=n(33),f=n(7),p=n(324),m=5*u.minuteMs;t.Migration=class{constructor(e,t,n){this.migrationsDir=e,this.db=t,this.dbFile=n,this.fsMigrations=c.lazy(()=>this.migrationsDir.children(e=>".sql"===e.ext)),this.logger=s.mkLogger("Migration("+JSON.stringify({schema:e.base,db:n.nativePath})+")"),t.exec("\nCREATE TABLE IF NOT EXISTS migrations (\n  id integer NOT NULL PRIMARY KEY, \n  name varchar(255) NOT NULL, \n  migration_time integer NOT NULL \n)\n"),this.addMigrationName=t.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}apply(e){return i(this,void 0,void 0,(function*(){const t=yield r.withLock({file:this.dbFile,staleMs:m,timeoutMs:m},()=>this._apply(e));if(null==t)throw new Error("Cannot lock to apply migrations to "+this.dbFile);return t}))}_apply(e){return i(this,void 0,void 0,(function*(){const t=[],n=this.db.prepare("SELECT name from migrations").pluck().all(),i=yield this.fsMigrations();if(null==i)throw new Error("no migration files found for "+this.migrationsDir);this.logger.info("latest()",{currentNames:n,migrationFiles:i,migrationsDir:this.migrationsDir});for(const r of i)n.includes(r.name)?this.logger.info("latest(): already applied "+r.base):(yield d.map(e,e=>e(r)),yield this.applyMigration(r),t.push(r.base));return this.logger.info("up to latest!",{appliedMigrations:t}),t}))}applyMigration(e){return i(this,void 0,void 0,(function*(){console.log(JSON.stringify({migration:e.name}));try{const t=Date.now(),n=p.Migrations[e.name.replace(/^[\d_-]+/,"")],i=h.isFunction(n);return i?yield n.bind(p.Migrations)(this.db):yield this.applySqlMigration(e),this.logger.info("applyMigration() completed",{elapsedMs:Date.now()-t,codeMigration:i,migration:e.baseWithParent}),this.db.transaction(()=>{this.addMigrationName.run(e.name,Date.now())})()}catch(t){return this.logger.throw("Failed to apply migration "+e.baseWithParent,l.verboseErrorToS(t))}}))}applySqlMigration(e){return i(this,void 0,void 0,(function*(){const t=e.base.includes("_nofk");try{const n=f.toS(yield e.readFile());if(a.blank(n))return void this.logger.error("Empty migration: "+e);t&&this.db.pragma("foreign_keys = OFF"),this.db.transaction(()=>{if(n.split(";").map(e=>e.trim()).filter(a.notBlank).forEach(e=>this.db.exec(e)),t){const t=this.db.pragma("foreign_key_check");if(o.isNotEmpty(t))throw this.logger.error("foreign_key_check failed",t),new Error("Foreign key checks failed during migration "+e.name)}})()}finally{t&&this.db.pragma("foreign_keys = ON")}}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6),s=n(38),o=n(0),a=n(8),u=n(58),l=n(4),c=n(14),d=n(138);function h(e){return e.sibling("."+e.base+".lock")}t.lockdir=h;class f{constructor(e){this.opts=e,this.id=d.uid(),this._acquired=!1,this.refreshTimer=void 0,this.logger=l.mkLogger("FsLock("+e.file+")#"+this.id),this.lockdir=h(e.file),this.lockfile=this.lockdir.join(this.id)}get acquired(){return this._acquired}tryAcquire(){return i(this,void 0,void 0,(function*(){const e=o.orElse(yield this.lockdir.clear().children(),[]);if(this.logger.debug("tryAcquire()",{lockfiles:e.map(e=>e.base)}),e.length>0&&e[0].base===this.id)return this.logger.info("Acquired"),this._acquired=!0,!0;const t=Date.now()-this.opts.staleMs;for(const n of e)c.lt(yield n.mtimeMs(),t)&&(this.logger.warn("Child "+n.base+" is stale. unlinking."),yield n.unlink());return!1}))}acquire(){return i(this,void 0,void 0,(function*(){if(this._acquired)return!0;const e=()=>this.lockfile.touch().then(()=>this.logger.debug("Touched lockfile"));yield e(),this.refreshTimer=u.setUnrefInterval(e,this.opts.staleMs/2);const t=yield a.until(()=>this.tryAcquire(),this.opts.timeoutMs);return t||(yield this.release()),t}))}release(){return i(this,void 0,void 0,(function*(){this.logger.debug("release()"),this._acquired=!1,o.map(this.refreshTimer,e=>clearInterval(e)),this.refreshTimer=void 0;try{return yield this.lockfile.unlink(),s.later(()=>i(this,void 0,void 0,(function*(){(yield this.lockdir.rmdir("trace"))&&this.logger.debug("release() unlinking empty lockdir",{lockdir:this.lockdir.nativePath})})),1*r.secondMs),this.logger.info("Released"),!0}catch(e){return this.logger.warn("Lockfile cleanup failed, but we'll recover later."+e),!1}}))}withLock(e){return i(this,void 0,void 0,(function*(){if(this._acquired)return e(this);try{return(yield this.acquire())?yield e(this):void 0}finally{yield this.release()}}))}}t.FsLock=f,t.withLock=function(e,t){return i(this,void 0,void 0,(function*(){return new f(e).withLock(t)}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(21),s=n(42),o=n(135),a=n(165),u=n(4),l=n(159),c=n(14),d=n(11),h=n(92),f=n(9),p=n(2),m=n(0),g=n(5),y=n(15),v=n(78),b=p.lazy(()=>u.mkLogger("Migrations")),w=new RegExp(`^(${v.PS_NETWORK_FILESYSTEM_PROTOCOL}//.*?/)(.*)$`);function S(e,t){return c.mapGt0(e,()=>m.map(function(e,t=a.ModeBits){return l.splitBits(e,t).map(e=>o.unlabhash(e,t))}(e,6)[t],e=>o.labhash(e,a.ModeBits)))}t.lowercase_psnet_function=e=>y.Opt(e).filter(f.isString).flatMap(e=>w.exec(e)).map(e=>e[1].toLowerCase()+e[2]).getOrElse(()=>e),t.Migrations={lowercase_psnet_hostname:e=>{e.function("lowercase_psnet_hostname",{deterministic:!0},t.lowercase_psnet_function),e.transaction(()=>{e.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),e.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),e.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")})()},force_stable_channel:()=>i(void 0,void 0,void 0,(function*(){try{yield h.readSystemSettings();const e=d.Settings.updateChannel.value;"stable"!==e&&(d.Settings.updateChannel.value="stable",yield h.writeSystemSettings(),b().info("force_stable_channel(): reset updateChannel",{priorValue:e}))}catch(e){b().error("force_stable_channel(): failed: "+e)}})),numeric_captured_at:e=>{e.function("isoToLocal",{deterministic:!0},r.isoToLocal),e.function("isoToOffsetMinutes",{deterministic:!0},s.isoToOffsetMinutes),e.function("isoToPrecisionMs",{deterministic:!0},r.isoToPrecisionMs),e.transaction(()=>{e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),e.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),e.exec("DROP INDEX asset_captured_at_geohash_idx"),e.exec("DROP INDEX assetfile_exifuid_idx"),e.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")})()},spread_modes:e=>{e.function("plucklabmodeb6",{deterministic:!0},S),e.transaction(()=>{g.times(a.ModeCount,t=>e.exec(`ALTER TABLE AssetFile ADD COLUMN mode${t} integer`)),e.exec("UPDATE AssetFile SET "+g.times(a.ModeCount,e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`).join(", "))})()}},t.plucklabmodeb6=S},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(4),s=n(6),o=n(2),a=n(180),u=n(265),l=n(266),c=n(267),d=o.lazy(()=>r.mkLogger("StatsDbJanitor"));t.statsDbJanitor=function(e){return i(this,void 0,void 0,(function*(){d().info("Setting up "+e);const t=yield u.dbSetup(a.pathToDb(e,"stats"),"stats");c.setStatsDb(t);const n=new l.SqliteJanitor("stats",t);return n.setInterval(5*s.minuteMs),n}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(4),r=n(297),s=n(302),o=n(303),a=n(327),u=n(93),l=n(120),c=n(167),d=n(328),h=n(268),f=n(250),p=n(149),m=n(272),g=n(104);t.setupModelJson=function(){for(const e of[a.AdvisoryLock,u.Asset,l.AssetFile,h.Heartbeat,c.AssetTag,r.DirStat,d.Example,m.Progress,g.Tag,s.Queue,o.QueueItem])try{f.addModelClass(e),p.ModelOpsLocal.forModel(e,e.db)}catch(t){i.mkLogger("setupModelJson").throw(t,e)}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),s=n(21),o=n(138),a=n(6),u=n(171);t.CurrentLockHoldersSql="\nSELECT\n  al1.name,\n  al1.lockId\nFROM\n  AdvisoryLock AS al1\n  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name\n  AND al1.createdAt > al2.createdAt\nWHERE\n  al2.createdAt IS NULL\n".replace(/\s+/," ");class l extends u.Model{static vacuum(e=30*a.minuteMs){return this.tx("vacuum",t=>t.runf(t=>t.where("createdAt","<=",Date.now()-e).delete()))}static withLocks({lockNames:e,f:t,timeoutMs:n}){return i(this,void 0,void 0,(function*(){const a=Date.now(),u={},c=o.uid();this.logger().debug("withLocks()",{lockNames:e,lockId:c});const d=u.locks=e.map(e=>({name:e,lockId:c,createdAt:Date.now()}));yield this.tx("withAdvisoryLocks insert",e=>e.runf(e=>e.insert(d)));try{const o=yield r.until(()=>i(this,void 0,void 0,(function*(){try{return yield this.tx("withAdvisoryLocks acquire",e=>e.runf(e=>e.where({lockId:c}).update({acquired:1})),!0),!0}catch(e){return!1}})),n,250);if(this.logger().info("withLocks()",{lockNames:e,acquired:o}),o){u.acquireMs=Date.now()-a;const e=yield s.elapsedAsync(()=>i(this,void 0,void 0,(function*(){return t(c)})));u.result=e.result,u.runMs=e.elapsedMs}}finally{const e=yield s.elapsedAsync(()=>l.tx("withAdvisoryLocks cleanup",e=>e.runf(e=>e.where({lockId:c}).delete())));u.releaseMs=e.elapsedMs,u.released=!0}return u}))}}t.AdvisoryLock=l,l.tableName="AdvisoryLock",l.uniqueColumnName="requester"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(85);class r extends i.TimestampedModel{}t.Example=r,r.tableName="Example",r.uniqueColumnName="name",r.booleanFields=["isExample"]},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(4),s=n(2),o=n(49),a=n(69),u=r.mkLogger("RemoteLibraryPath");t.remoteLibraryPath=s.lazy(()=>i(void 0,void 0,void 0,(function*(){try{const e=a.dbClient()||a.dbClient.refresh();return yield o.thenTap(e.request("libraryPath"),e=>{u.info("received",{libraryPath:e})})}catch(e){return void u.error("Failed to get remote library path"+e)}})))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(298),s=n(331),o=n(44),a=n(18),u=n(24),l=n(20),c=n(13),d=n(332),h=n(258),f=n(188),p=n(202),m=n(249),g=n(72),y=n(4),v=n(26),b=n(304),w=n(16),S=n(65),M=n(11),P=n(9),E=n(61),x=n(1),_=n(3),F=n(6),T=n(28),O=n(0),A=n(15),k=n(36),D=n(145),C=n(146),I=n(305),L=n(257),R=y.mkLogger("Sentry"),B=Math.round(3*g.MaxRecentLogEntriesByLevel);t.installSentry=function(e){return i(this,void 0,void 0,(function*(){try{if(!I.sentryEnabled())return!1;const t=new N;return r.init({dsn:w.isElectron?"https://0652cdd351054fe9853ff944b1f54e2c@sentry.io/289071":"https://408e2f8d62c3494d8ed663d9e488d67a@sentry.io/1828379",shutdownTimeout:S.serviceShutdownTimeoutMs(e.name),release:E.release,environment:v.nodeEnv,maxBreadcrumbs:B,beforeSend:t.beforeSend,serverName:yield h.systemUID(),onFatalError:e=>l.onError("sentry.onFatalError",e)}),!0}catch(e){return R.warn("Failed to set up sentry: "+e),!1}}))};class N{constructor(){this.eventStore=new d.EventStore,this.beforeSend=(e,t)=>i(this,void 0,void 0,(function*(){if(!I.sentryEnabled())return R.error("Sentry.beforeSend(): not sending event",e),null;const n=M.Settings.email.value;_.notBlank(n)&&(null==e.user&&(e.user={}),e.user.email=n);const i=P.ellipsize(j(e,t),60);if(l.isIgnorableError(i))return R.info("Sentry.beforeSend(): ignorable event. vetoing",{event:e,hint:t,msg:i}),null;null==e.breadcrumbs&&(e.breadcrumbs=[]),e.breadcrumbs.push(...x.compact(g.recentLogEntries().slice(-B).map(q)));const r=O.orElse(e.extra,{});return r.msg=i,r.pid=a.pid,r.serviceName=S.serviceName(),r.serviceEnding=u.ending(),r.runtimeMs=Date.now()-L.start,r.version=E.version,r.os=b.OS(),r.isDocker=w.isDocker(),r.nodeVersion=a.versions.node,r.locale=yield m.locale(),r.cpus=b.CPUs(),r.memoryUsageBytes=D.memoryUsageBytes(),r.systemMemory=k.fmtBytes(o.freemem())+" / "+k.fmtBytes(o.totalmem()),r.ffmpeg=yield f.ffmpegVersionDescription(),r.vlc=yield p.vlcVersionDescription(),r.argv=JSON.stringify(a.argv),r.libraryUID=yield C.libraryUID(),e.extra=r,this.eventStore.maybeSendEvent(i,e)}));const e=(e,t)=>{l.isSendableError(t)?r.captureException(t):l.isSendableError(e)&&r.captureMessage(e)};c.onNonFatal(e),c.onFatal(e),c.onBoom(()=>r.captureMessage("User requested log dispatch")),u.addFirstEndable(new u.EndableWrapper("EventFilter",()=>this.end()))}end(){O.map(r.getCurrentHub().getClient(),e=>e.close(5*F.secondMs))}}function j(e,t){return A.Opt(e).flatMap(e=>e.message).filter(_.notBlank).orElse(()=>A.Opt(t).flatMap(e=>e.originalException).flatMap(T.errorToS).filter(_.notBlank)).orElse(()=>A.Opt(e.exception).flatMap(e=>e.values).flatMap(e=>e.map(z).find(_.notBlank)).filter(_.notBlank)).orElse(()=>"Unknown event").map(l.trimErrorMessage).get()}function z(e){return O.map(e,e=>x.compactBlanks([e.type,e.value]).join(": "))}function q(e){return O.map(V(e.level),t=>({timestamp:e.timestamp/F.secondMs,level:t,category:P.stripAnsiEsc(e.context),message:P.stripAnsiEsc(e.msg),data:"object"==typeof e.meta?e.meta:{value:P.isString(e.meta)?P.stripAnsiEsc(e.meta):e.meta}}))}function V(e){switch(e){case"error":return s.Severity.Error;case"warn":return s.Severity.Warning;case"info":return s.Severity.Info;case"debug":return s.Severity.Debug;default:return}}t.EventFilter=N,t.extractMessage=j,t.sentryExceptionToS=z,t.logEntryToBreadcrumb=q,t.logLevelToSeverity=V},function(e,t){e.exports=require("@sentry/types")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),s=n(6),o=n(2),a=n(40),u=n(24),l=n(8),c=n(20),d=n(31),h=n(90),f=n(4),p=n(54),m=n(11),g=o.lazy(()=>f.mkLogger("EventStore"));t.EventStore=class{constructor(e=d.BaseFile.for(a.App.userData()).join("events")){this.root=e}vacuum(){return i(this,void 0,void 0,(function*(){const e=Date.now()-s.dayMs;yield l.awaitAll(yield l.thenMap(this.root.clear().children(),t=>t.map(t=>i(this,void 0,void 0,(function*(){try{if(t.isHiddenPosix()||".json"!==t.ext)return;const n=yield l.thenMapOr(t.readJSON(),e=>e.eventTime,()=>t.mtimeMs());null!=n&&n<e&&(yield t.unlink())}catch(e){g().warn("vacuum(): failed to vacuum "+t+": "+e)}}))))),this.root.clear()}))}maybeSendEvent(e,t){return i(this,void 0,void 0,(function*(){if(u.ending())return g().error("maybeSendEvent(): REJECT: we're ending.",{msg:e,event:t}),null;r.blank(e)&&(e="UNKNOWN EVENT");try{yield l.thenOrTimeout(()=>this.vacuum(),5*s.secondMs);const n=yield l.thenMapOr(this.root.clear().children(),e=>e.length,()=>0);if(n>=m.Settings.maxErrorsPerDay.valueOrDefault+(c.isSendableError(e)?7:0))return g().error("maybeSendEvent(): REJECT: too many events sent in the last day.",{sentEventCount:n,maxErrorsPerDay:m.Settings.maxErrorsPerDay.valueOrDefault,event:t}),null;return null==(yield this.writeEvent({msg:e,event:t}))?(g().error("maybeSendEvent(): REJECT: event was already sent in the last day.",t),null):(g().error("maybeSendEvent(): ACCEPT",{sentEventCount:n,event:t}),t)}catch(e){return g().error("maybeSendEvent(): Failed to determine if we should squelch the event. Failing closed.",e),null}}))}writeEvent({msg:e,eventTime:t=Date.now(),event:n}){return i(this,void 0,void 0,(function*(){const i=this.msg2file(e),r={msg:e,eventTime:t,event:n},s=c.isSendableError(e)?m.Settings.maxErrorsPerDay.valueOrDefault-1:0;return l.thenMap(i.ensureNew({maxVersions:s,emptyIsNew:!1}).catch(()=>{}),e=>e.writeJSON(r))}))}msg2file(e){return this.root.join(h.shortStringSha(e,8,p.GeoRadix)+".json")}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(3),o=n(2),a=n(5),u=n(7),l=n(12),c=n(133),d=n(8),h=n(177),f=n(73),p=n(4),m=n(14),g=n(11),y=n(32),v=n(47),b=n(252),w=n(169);function S(e){return c.AsyncFilter.lift(t=>i(this,void 0,void 0,(function*(){return d.thenMapOr(y.readRawTags(t,!1),e,()=>!1)})))}function M(e){return S(t=>l.allNotBlank(...e.map(e=>t[e])))}t.onlyFiles=c.AsyncFilter.lift(e=>e.isFile()),t.onlyReadable=c.AsyncFilter.lift(e=>e.isReadable()),t.requiredTagsFilter=M,t.minDimensionsFilter=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){const t=yield y.mimetype(e);if(null==t||!t.startsWith("image/")&&!t.startsWith("video/"))return!1;const n=t.startsWith("video/")?g.Settings.minVideoDimension.valueOrDefault:g.Settings.minImageDimension.valueOrDefault;return d.thenMapOr(y.sizeInfo(e),e=>m.gte(e.ImageWidth,n)&&m.gte(e.ImageHeight,n),()=>!1)}))),t.hasMimeType=M(["MIMEType"]),t.hasMakeAndModel=M(["Make","Model"]),t.notRejected=S(e=>a.toInt(e.Rating,{defaultValue:0})>=0),t.hasBrowserImgMimetype=S(e=>r.includes(["image/jpeg","image/png"],u.toS(e.MIMEType))),t.imageFilter=S(e=>u.toS(e.MIMEType).startsWith("image/")),t.videoFilter=S(e=>u.toS(e.MIMEType).startsWith("video/"));const P=t.imageFilter.and(t.hasMakeAndModel).or(t.videoFilter),E=o.lazy(()=>new Set([...v.sharpSupportedMimeTypes(),...h.dcrawSupportedMimeTypes]));function x(e){return!s.blank(e)&&(f.isVideoMimeType(e)||E().has(e.toLowerCase()))}t.supportedMimeTypeFilter=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return d.thenMapOr(y.mimetype(e.nativePath),x,()=>!1)}))),t.exifExtFilter=b.extFilter(v.AssetFileExts),t.notHiddenCheap=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return!w.ignorablePath(e.nativePath)}))),t.fileSizeFilter=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return d.thenMapOr(e.size(),e=>m.within(g.Settings.minFileSizeBytes.valueOrDefault,g.Settings.maxFileSizeBytes.valueOrDefault,e),()=>!1)}))),t.noStatFileFilter=c.AsyncFilter.andLogged(p.mkLogger("noStatFileFilter"),{exifExtFilter:t.exifExtFilter},{notHiddenCheap:t.notHiddenCheap}),t.cheapFileFilter=c.AsyncFilter.andLogged(p.mkLogger("cheapFileFilter"),{exifExtFilter:t.exifExtFilter},{notHiddenCheap:t.notHiddenCheap},{fileSizeFilter:t.fileSizeFilter}),t.expensiveFileFilters=o.lazy(()=>r.compact([{exifExtFilter:t.exifExtFilter},{fileSizeFilter:t.fileSizeFilter},{notHiddenCheap:t.notHiddenCheap},{hasMimeType:t.hasMimeType},{supportedMimeTypeFilter:t.supportedMimeTypeFilter},g.Settings.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:P}:void 0,{notRejected:t.notRejected},{minDimensionsFilter:t.minDimensionsFilter}])),t.expensiveFileFilter=o.lazy(()=>c.AsyncFilter.andLogged(p.mkLogger("expensiveFileFilter"),...t.expensiveFileFilters())),t.extless=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return s.blank(e.ext)}))),t.onlyDirectories=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return e.isDirectory()}))),t.fileExtFilter=function(e){return c.AsyncFilter.and(b.extFilter(e),t.onlyFiles)},t.excludeDirnameFilter=function(e){return c.AsyncFilter.and(b.excludedPathFilter(e),t.onlyDirectories)}},,,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),s=n(4),o=n(1),a=n(93),u=n(346),l=n(260),c=n(347),d=n(349),h=n(102),f=n(350),p=n(11),m=s.mkLogger("AssetTagger");function g(e,t,n,s=[]){return i(this,void 0,void 0,(function*(){const i=[];p.Settings.tagCamera.valueOrDefault&&(yield r.thenMap(u.cameraTagFile(e),t=>{m.debug("Camera tag for "+e+": "+h.joinTagPath(t,"|")),i.push(t)})),p.Settings.tagLens.valueOrDefault&&(yield r.thenMap(d.lensTagFile(e),t=>{m.debug("Lens tag for "+e+": "+h.joinTagPath(t,"|")),i.push(t)})),yield r.thenMap(l.dateTagFile(e,s),t=>{m.debug("Date tag for "+e+": "+h.joinTagPath(t,"|")),i.push(t)}),yield r.thenMap(c.keywordTagFiles(e,...t),t=>{m.debug("Keyword tags for "+e+": "+t),i.push(...t)}),p.Settings.tagType.valueOrDefault&&(yield r.thenMap(f.typeTagFiles(e,...t),t=>{m.debug("Keyword tags for "+e+": "+t),i.push(...t)}));const a=h.tagDeltas(n,o.uniqBy(i),!0);return m.debug("tagAsset("+e+")",a),a}))}t.tagAndUpsertAsset=function(e,t){return i(this,void 0,void 0,(function*(){return r.thenMap(g(t,yield e.getPosixFiles(),yield e.getTagPaths(),yield e.getCapturedAt()),t=>i(this,void 0,void 0,(function*(){yield a.Asset.addTags(e.id,t.add),yield a.Asset.removeTags(e.id,t.remove),e.tags=void 0})))}))},t.tagAsset=g},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(21),r=n(57),s=n(338),o=n(14),a=n(22),u=n(263),l=n(351),c=n(1),d=n(3),h=n(6),f=n(0),p=n(5),m=n(10),g=n(37),y=n(46),v=g.strEnum("sha","mimetype","capturedAtSrc","capturedAtLocal","capturedAtPrecisionMs","make","model","cameraId","imageId","lensId","geohash",...l.ExposureSettingsProps,"meanHash","rightHash","mode0","mode1","mode2","mode3","mode4");function b(e,t,n,i=a.identity){const s=i(e[n]),o=i(t[n]);if(!d.blank(s)&&!d.blank(o))return r.eql(s,o)?void 0:`Different ${String(n)}: ${s} != ${o}`}function w(e){return d.mapNotBlank(e,e=>e.toLowerCase().trim())}function S(e,t){if(null==e)return"af1 was undefined";if(null==t)return"af2 was undefined";if(r.definedAndEql(e.sha,t.sha))return;const n=Math.max(...c.compact([e.capturedAtPrecisionMs,t.capturedAtPrecisionMs,1])),o=i.localToMs(e.capturedAtLocal),a=i.localToMs(t.capturedAtLocal);if(null==o)return"af1 missing capturedAtLocal";if(null==a)return"af2 missing capturedAtLocal";if(!("stat"===e.capturedAtSrc||"stat"===t.capturedAtSrc)&&!p.closeTo(o,a,n)){return"Different Captured-at times: "+[e,t].map(e=>`${e.capturedAtLocal}${"Â±"+i.fmtDuration(n)}`).join(" != ")}const l=f.map(e,u.normalizeExposureSettings),d=f.map(t,u.normalizeExposureSettings),h=y.firstDefinedThunk([()=>b(e,t,"make",w),()=>b(e,t,"model",w),()=>b(e,t,"cameraId"),()=>b(e,t,"imageId"),()=>b(e,t,"lensId"),()=>b(e,t,"geohash"),()=>r.definedAndNotEql(l,d)?`Different exposure settings: ${l} != ${d}`:void 0]);if(null!=h)return h;if(c.count([r.definedAndEql(e.cameraId,t.cameraId),r.definedAndEql(e.imageId,t.imageId),r.definedAndEql(e.lensId,t.lensId),r.definedAndEql(e.geohash,t.geohash),r.definedAndEql(l,d)],e=>e)>=2)return;const m=s.imageHashCompare(e,t);return s.isSimilarComparison(m)?void 0:"low image correlation"}t.MetadataFieldValues=v.values,t.isSimilar=function(e,t){return null==S(e,t)},t.whyNotSimilar=S,t.metadataQualityScore=function(e){return null==e?-100:m.entries(e).filter(([e,n])=>null!=n&&t.MetadataFieldValues.includes(e)).length+(o.gt(e.capturedAtPrecisionMs,h.hourMs)?-5:o.gt(e.capturedAtPrecisionMs,h.minuteMs)?-1:0)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),s=n(0),o=n(5),a=n(10),u=n(12),l=n(4),c=n(262),d=n(41),h=n(14),f=n(11),p=n(339),m=n(135),g=n(165),y=l.mkLogger("ImageHashComparison");function v(e){return s.map(e,e=>o.sigFigs(e,2))}t.labsCorr2=function(e,t){const n=u.diff(e,t),i=u.diff(t,e),s=r.sum(n,e=>m.diffCIE94Corr(e,m.closestLab(t,e)))+r.sum(i,t=>m.diffCIE94Corr(t,m.closestLab(e,t))),o=Math.max(e.length,t.length,s);return(o-s)/o};function b(e,t){return d.avgWeighted(e.map((e,n)=>{const i=m.closestLab(t,e);if(null==i)return 20;const r=t.indexOf(i),s=Math.abs(n-r),a=m.diffCIE94(e,i)+s;return o.clamp(0,1,1-(a-2.3)/20)}),[4,3,2,1])}function w(e,t){return d.avg([b(e,t),b(t,e)])}function S(e){return r.compact(r.compact(null==e?void 0:e.modes).map(e=>m.unlabhash(e,g.ModeBits)))}function M(e,t){if(null==e||null==t)return;const n={a:e,b:t,meanHamm:v(c.b64hammRatio(e.meanHash,t.meanHash)),rightHamm:v(c.b64hammRatio(e.rightHash,t.rightHash)),labModesCorr:w(S(e),S(t))};return y.debug("imageHashCompare()",n),a.reqValuedOrElse(n)}function P(e,t){return E(M(e,t))}function E(e){if(null==e)return!1;const t=f.Settings.minImageCorrPct.valueOrDefault/100,n=f.Settings.minColorCorrPct.valueOrDefault/100,i=h.gt(e.meanHamm,t),r=h.gt(e.rightHamm,t),s=h.gt(e.labModesCorr,n);return y.tap({level:"info",msg:"isSimilarComparison",result:(i||r)&&s,meta:Object.assign({goodMeanHamm:i,goodRightHamm:r,goodLabModes:s},e)})}function x(e){return null!=e&&(h.gte(e.meanHamm,.9)&&h.gte(e.rightHamm,.9)&&h.gte(e.labModesCorr,.9))}t.labsCorr=w,t.imageHashToModes=S,t.imageHashToColors=function(e){return r.uniqBy(S(e).map(e=>p.bestLabName(e,p.colorNames())),e=>e.rgb)},t.imageHashCompare=M,t.isSimilarImage=function(e,t,n,r="debug"){return i(this,void 0,void 0,(function*(){return y.tap({msg:`isSimilarImage(${e},${t})`,level:r,result:s.map2(yield g.imageHash(e,n),yield g.imageHash(t,n),P)})}))},t.isSimilarImageHash=P,t.isSimilarComparison=E,t.isVerySimilarImageHash=function(e,t){return x(M(e,t))},t.isVerySimilarComparison=x,t.imageHashSimilarity=function(e,t){return s.map(M(e,t),e=>d.avgMaybe(e.meanHamm,e.rightHamm))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(0),o=n(5),a=n(19),u=n(159),l=n(9),c=n(135),d=n(165);function h(e){const t=c.rgbhex2Lab(e.rgb);return Object.assign(Object.assign({},e),{name:l.capitalize(e.name),lab:t,labhash:c.labhash(t,d.ModeBits)})}function f(e,n=t.colorNames()){return a.toA(s.map(c.rgbhex2Lab(e),e=>g(e,n)))}function p(e,n=t.colorNames()){return g(e,n)[0]}t.colorNames=r.lazy(()=>[{name:"Acid green",rgb:"#B0BF1A"},{name:"Amaranth pink",rgb:"#F19CBB"},{name:"Amaranth purple",rgb:"#AB274F"},{name:"Amaranth red",rgb:"#D3212D"},{name:"Amaranth",rgb:"#E52B50"},{name:"Amethyst",rgb:"#9966CC"},{name:"Antique brass",rgb:"#CD9575"},{name:"Antique bronze",rgb:"#665D1E"},{name:"Antique fuchsia",rgb:"#915C83"},{name:"Apple green",rgb:"#8DB600"},{name:"Apricot",rgb:"#FBCEB1"},{name:"Aquamarine",rgb:"#7FFFD4"},{name:"Artichoke",rgb:"#8F9779"},{name:"Ash grey",rgb:"#B2BEB5"},{name:"Asparagus",rgb:"#87A96B"},{name:"Avocado",rgb:"#568203"},{name:"Azure",rgb:"#007FFF"},{name:"Beaver",rgb:"#9F8170"},{name:"Bistre",rgb:"#3D2B1F"},{name:"Black coffee",rgb:"#3B2F2F"},{name:"Black olive",rgb:"#3B3C36"},{name:"Black pearl",rgb:"#041322"},{name:"Black",rgb:"#000000"},{name:"Blond",rgb:"#FAF0BE"},{name:"Blood red",rgb:"#660000"},{name:"Blue bell",rgb:"#A2A2D0"},{name:"Blue sapphire",rgb:"#126180"},{name:"Blue-green",rgb:"#0D98BA"},{name:"Blue-violet",rgb:"#7366BD"},{name:"Blue",rgb:"#1F75FE"},{name:"Brandy",rgb:"#87413F"},{name:"Brick red",rgb:"#CB4154"},{name:"Bright green",rgb:"#66FF00"},{name:"Bright lilac",rgb:"#D891EF"},{name:"Brilliant rose",rgb:"#FF55A3"},{name:"Brink pink",rgb:"#FB607F"},{name:"Bronze",rgb:"#CD7F32"},{name:"Brown",rgb:"#88540B"},{name:"Brown",rgb:"#A52A2A"},{name:"Bud green",rgb:"#7BB661"},{name:"Burgundy",rgb:"#800020"},{name:"Burnished brown",rgb:"#A17A74"},{name:"Burnt orange",rgb:"#CC5500"},{name:"Burnt sienna",rgb:"#E97451"},{name:"Burnt umber",rgb:"#8A3324"},{name:"Byzantium",rgb:"#702963"},{name:"Cadet blue",rgb:"#5F9EA0"},{name:"Cadet",rgb:"#536872"},{name:"Cadmium green",rgb:"#006B3C"},{name:"Cadmium red",rgb:"#E30022"},{name:"Candy pink",rgb:"#E4717A"},{name:"Cardinal",rgb:"#C41E3A"},{name:"Caribbean green",rgb:"#00CC99"},{name:"Carmine",rgb:"#960018"},{name:"Carnelian",rgb:"#B31B1B"},{name:"Cerise",rgb:"#DE3163"},{name:"Cerulean blue",rgb:"#2A52BE"},{name:"Cerulean",rgb:"#007BA7"},{name:"Champagne",rgb:"#F3E5AB"},{name:"Charcoal",rgb:"#36454F"},{name:"Chartreuse",rgb:"#DFFF00"},{name:"Chestnut",rgb:"#954535"},{name:"Chocolate",rgb:"#7B3F00"},{name:"Cinnamon Satin",rgb:"#CD607E"},{name:"Citrine",rgb:"#E4D00A"},{name:"Citron",rgb:"#9FA91F"},{name:"Claret",rgb:"#7F1734"},{name:"Cobalt blue",rgb:"#0047AB"},{name:"Cocoa brown",rgb:"#D2691E"},{name:"Coffee",rgb:"#6F4E37"},{name:"Cool grey",rgb:"#8C92AC"},{name:"Copper red",rgb:"#CB6D51"},{name:"Copper rose",rgb:"#996666"},{name:"Copper",rgb:"#B87333"},{name:"Cornflower blue",rgb:"#6495ED"},{name:"Cosmic cobalt",rgb:"#2E2D88"},{name:"Cotton candy",rgb:"#FFBCD9"},{name:"Crimson",rgb:"#DC143C"},{name:"Cyan",rgb:"#00B7EB"},{name:"Cyclamen",rgb:"#F56FA1"},{name:"Cyprus",rgb:"#003E40"},{name:"Dark brown",rgb:"#654321"},{name:"Dark byzantium",rgb:"#5D3954"},{name:"Dark cornflower blue",rgb:"#26428B"},{name:"Dark cyan",rgb:"#008B8B"},{name:"Dark goldenrod",rgb:"#B8860B"},{name:"Dark green",rgb:"#006400"},{name:"Dark liver",rgb:"#534B4F"},{name:"Dark magenta",rgb:"#8B008B"},{name:"Dark moss green",rgb:"#4A5D23"},{name:"Dark olive green",rgb:"#556B2F"},{name:"Dark orange",rgb:"#FF8C00"},{name:"Dark orchid",rgb:"#9932CC"},{name:"Dark pastel green",rgb:"#03C03C"},{name:"Dark powder blue",rgb:"#003399"},{name:"Dark purple",rgb:"#301934"},{name:"Dark red",rgb:"#8B0000"},{name:"Dark salmon",rgb:"#E9967A"},{name:"Dark sea green",rgb:"#8FBC8F"},{name:"Dark sienna",rgb:"#3C1414"},{name:"Dark slate blue",rgb:"#483D8B"},{name:"Dark slate grey",rgb:"#2F4F4F"},{name:"Dark spring green",rgb:"#177245"},{name:"Dark turquoise",rgb:"#00CED1"},{name:"Dark violet",rgb:"#9400D3"},{name:"Deep blue",rgb:"#0066FF"},{name:"Deep chestnut",rgb:"#B94E48"},{name:"Deep saffron",rgb:"#FF9933"},{name:"Deep sky blue",rgb:"#00BFFF"},{name:"Deep space",rgb:"#000040"},{name:"Deep taupe",rgb:"#7E5E60"},{name:"Denim",rgb:"#1560BD"},{name:"Desert",rgb:"#C19A6B"},{name:"Dim grey",rgb:"#696969"},{name:"Drab",rgb:"#967117"},{name:"Earth yellow",rgb:"#E1A95F"},{name:"Ebony",rgb:"#555D50"},{name:"Eggplant",rgb:"#614051"},{name:"Eggshell",rgb:"#F0EAD6"},{name:"Elderberry",rgb:"#171828"},{name:"Electric blue",rgb:"#7DF9FF"},{name:"Electric purple",rgb:"#BF00FF"},{name:"Emerald",rgb:"#50C878"},{name:"English green",rgb:"#1B4D3E"},{name:"English lavender",rgb:"#B48395"},{name:"English red",rgb:"#AB4B52"},{name:"Fern green",rgb:"#4F7942"},{name:"Fire opal",rgb:"#E95C4B"},{name:"Firefly",rgb:"#0E2A30"},{name:"Flame",rgb:"#E25822"},{name:"Flax",rgb:"#EEDC82"},{name:"Forest green",rgb:"#014421"},{name:"French beige",rgb:"#A67B5B"},{name:"French blue",rgb:"#0072BB"},{name:"French lilac",rgb:"#86608E"},{name:"French sky blue",rgb:"#77B5FE"},{name:"Fuchsia purple",rgb:"#CC397B"},{name:"Fuchsia",rgb:"#FF00FF"},{name:"Gold",rgb:"#E6BE8A"},{name:"Golden brown",rgb:"#996515"},{name:"Golden yellow",rgb:"#FFDF00"},{name:"Goldenrod",rgb:"#DAA520"},{name:"Glacier blue",rgb:"#C8DDE8"},{name:"grey",rgb:"#808080"},{name:"Green-blue",rgb:"#2887C8"},{name:"Green-yellow",rgb:"#ADFF2F"},{name:"Green",rgb:"#00A000"},{name:"Harvest gold",rgb:"#DA9100"},{name:"Heliotrope grey",rgb:"#AA98A9"},{name:"Heliotrope",rgb:"#DF73FF"},{name:"Hot magenta",rgb:"#FF1DCE"},{name:"Hot pink",rgb:"#FF69B4"},{name:"Imperial red",rgb:"#ED2939"},{name:"Indigo dye",rgb:"#00416A"},{name:"Indigo",rgb:"#4B0082"},{name:"Iris",rgb:"#5A4FCF"},{name:"Jade",rgb:"#00A86B"},{name:"Jet",rgb:"#343434"},{name:"Jungle green",rgb:"#29AB87"},{name:"Kelly green",rgb:"#4CBB17"},{name:"Key lime",rgb:"#E8F48C"},{name:"Khaki",rgb:"#C3B091"},{name:"Lapis lazuli",rgb:"#26619C"},{name:"Laurel green",rgb:"#A9BA9D"},{name:"Lavender grey",rgb:"#C4C3D0"},{name:"Lavender",rgb:"#B57EDC"},{name:"Licorice",rgb:"#1A1110"},{name:"Light blue",rgb:"#ADD8E6"},{name:"Light coral",rgb:"#F08080"},{name:"Light grey",rgb:"#D3D3D3"},{name:"Light green",rgb:"#90EE90"},{name:"Light periwinkle",rgb:"#C5CBE1"},{name:"Light pink",rgb:"#FFB6C1"},{name:"Light salmon",rgb:"#FFA07A"},{name:"Light sea green",rgb:"#20B2AA"},{name:"Light steel blue",rgb:"#B0C4DE"},{name:"Light yellow",rgb:"#FFFFE0"},{name:"Lilac",rgb:"#C8A2C8"},{name:"Lime",rgb:"#BFFF00"},{name:"Linen",rgb:"#FAF0E6"},{name:"Magenta",rgb:"#FF0090"},{name:"Mahogany",rgb:"#C04000"},{name:"Malachite",rgb:"#0BDA51"},{name:"Mango",rgb:"#FDBE02"},{name:"Marigold",rgb:"#EAA221"},{name:"Maroon",rgb:"#C32148"},{name:"Mauve taupe",rgb:"#915F6D"},{name:"Mauve",rgb:"#E0B0FF"},{name:"Medium aquamarine",rgb:"#66DDAA"},{name:"Medium blue",rgb:"#0000CD"},{name:"Medium orchid",rgb:"#BA55D3"},{name:"Medium purple",rgb:"#9370DB"},{name:"Medium sea green",rgb:"#3CB371"},{name:"Medium slate blue",rgb:"#7B68EE"},{name:"Medium spring green",rgb:"#00FA9A"},{name:"Medium turquoise",rgb:"#48D1CC"},{name:"Middle blue green",rgb:"#8DD9CC"},{name:"Middle blue purple",rgb:"#8B72BE"},{name:"Middle blue",rgb:"#7ED4E6"},{name:"Middle green yellow",rgb:"#ACBF60"},{name:"Middle green",rgb:"#4D8C57"},{name:"Middle purple",rgb:"#D982B5"},{name:"Middle red purple",rgb:"#A55353"},{name:"Middle red",rgb:"#E58E73"},{name:"Midnight blue",rgb:"#003366"},{name:"Midnight green",rgb:"#004953"},{name:"Moss green",rgb:"#8A9A5B"},{name:"Mossy oak",rgb:"#887848"},{name:"Mulberry",rgb:"#C54B8C"},{name:"Mustard",rgb:"#FFDB58"},{name:"Myrtle green",rgb:"#317873"},{name:"Neon blue",rgb:"#4666FF"},{name:"Nickel",rgb:"#727472"},{name:"Ocean green",rgb:"#48BF91"},{name:"Ochre",rgb:"#CC7722"},{name:"Olive green",rgb:"#B5B35C"},{name:"Olive",rgb:"#808000"},{name:"Olivine",rgb:"#9AB973"},{name:"Orange-red",rgb:"#FF5349"},{name:"Orange",rgb:"#FF7F00"},{name:"Orange",rgb:"#FFAA1D"},{name:"Orchid pink",rgb:"#F2BDCD"},{name:"Orchid",rgb:"#DA70D6"},{name:"Pale cerulean",rgb:"#9BC4E2"},{name:"Pale pink",rgb:"#FADADD"},{name:"Pale purple",rgb:"#FAE6FA"},{name:"Pale silver",rgb:"#C9C0BB"},{name:"Pansy purple",rgb:"#78184A"},{name:"Pastel pink",rgb:"#DEA5A4"},{name:"Pastel yellow",rgb:"#FFFF99"},{name:"Peach",rgb:"#FFDAB9"},{name:"Pear",rgb:"#D1E231"},{name:"Periwinkle",rgb:"#CCCCFF"},{name:"Persimmon",rgb:"#EC5800"},{name:"Pesto",rgb:"#7C7631"},{name:"Pewter blue",rgb:"#8BA8B7"},{name:"Phthalo green",rgb:"#123524"},{name:"Pink",rgb:"#D74896"},{name:"Pistachio",rgb:"#93C572"},{name:"Powder Blue",rgb:"#BEEEEF"},{name:"Plum",rgb:"#8E4585"},{name:"Prune",rgb:"#701C1C"},{name:"Puce",rgb:"#CC8899"},{name:"Pumpkin",rgb:"#FF7518"},{name:"Purple navy",rgb:"#4E5180"},{name:"Purple",rgb:"#A020F0"},{name:"Raisin black",rgb:"#242124"},{name:"Raw sienna",rgb:"#D68A59"},{name:"Raw umber",rgb:"#826644"},{name:"Rebecca purple",rgb:"#663399"},{name:"Red-purple",rgb:"#E40078"},{name:"Red-violet",rgb:"#C71585"},{name:"Red",rgb:"#ED1C24"},{name:"Rosy brown",rgb:"#BC8F8F"},{name:"Royal blue dark",rgb:"#002366"},{name:"Royal purple",rgb:"#7851A9"},{name:"Rufous",rgb:"#A81C07"},{name:"Saffron",rgb:"#F4C430"},{name:"Salmon pink",rgb:"#FF91A4"},{name:"Salmon",rgb:"#FA8072"},{name:"Sand",rgb:"#C2B280"},{name:"Sandy brown",rgb:"#F4A460"},{name:"Sap green",rgb:"#507D2A"},{name:"Scarlet",rgb:"#FF2400"},{name:"Sea green",rgb:"#2E8B57"},{name:"Sepia",rgb:"#985E2B"},{name:"Sepia black",rgb:"#2B0202"},{name:"Sienna",rgb:"#882D17"},{name:"Sky blue",rgb:"#87CEEB"},{name:"Sky magenta",rgb:"#CF71AF"},{name:"Slate blue",rgb:"#6A5ACD"},{name:"Slate grey",rgb:"#708090"},{name:"Steel pink",rgb:"#CC33CC"},{name:"Straw",rgb:"#E4D96F"},{name:"Tan",rgb:"#D2B48C"},{name:"Tangerine",rgb:"#F28500"},{name:"Taupe grey",rgb:"#8B8589"},{name:"Taupe",rgb:"#483C32"},{name:"Tea green",rgb:"#D0F0C0"},{name:"Tea rose",rgb:"#F4C2C2"},{name:"Teal blue",rgb:"#367588"},{name:"Teal",rgb:"#008080"},{name:"Terra cotta",rgb:"#E2725B"},{name:"Thistle",rgb:"#D8BFD8"},{name:"Turquoise blue",rgb:"#00FFEF"},{name:"Turquoise green",rgb:"#A0D6B4"},{name:"Turquoise",rgb:"#40E0D0"},{name:"Turtle green",rgb:"#2A380B"},{name:"Ultra pink",rgb:"#FF6FFF"},{name:"Ultra red",rgb:"#FC6C85"},{name:"Ultramarine",rgb:"#3F00FF"},{name:"Umber",rgb:"#635147"},{name:"Umbra",rgb:"#202000"},{name:"Vermilion",rgb:"#E34234"},{name:"Violet-blue",rgb:"#324AB2"},{name:"Violet-red",rgb:"#F75394"},{name:"Violet",rgb:"#8F00FF"},{name:"Viridian",rgb:"#40826D"},{name:"Vivid burgundy",rgb:"#9F1D35"},{name:"Vivid sky blue",rgb:"#00CCFF"},{name:"Vivid blue",rgb:"#0D00E5"},{name:"Vivid cyan",rgb:"#10FFFF"},{name:"Vivid indigo",rgb:"#3A00E7"},{name:"Wheat",rgb:"#F5DEB3"},{name:"White",rgb:"#FFFFFF"},{name:"Wisteria",rgb:"#C9A0DC"},{name:"Yellow-green",rgb:"#9ACD32"},{name:"Yellow-orange",rgb:"#FFAE42"},{name:"Yellow",rgb:"#FFEF00"}].map(h)),t.colorToTuple=h,t.bestRgbName=function(e,n=t.colorNames()){return f(e,n)[0]},t.rgbNames=f,t.bestLabName=p;const m=.25*c.labhash([100,100,100],d.ModeBits);function g(e,n=t.colorNames()){const r=c.labhash(e,d.ModeBits),s=n.filter(e=>Math.abs(r-e.labhash)<m).map(t=>Object.assign(Object.assign({},t),{cieDiff:c.diffCIE94(e,t.lab)}));return i.sortBy(s,e=>e.cieDiff).slice(0,5)}t.labNames=g;const y=r.lazy(()=>[{index:0,name:"yellows",rgb:"#FFDF00"},{index:1,name:"greens",rgb:"#0BDA51"},{index:2,name:"blues",rgb:"#0000ff"},{index:3,name:"reds",rgb:"#ff0000"}].map(h));function v(e){return p(e,y())}function b(e){return[u.bitZip({dims:[{value:e[0],min:0,max:100},{value:e[1],min:-100,max:100},{value:e[2],min:-110,max:100}],bitDepth:9})]}t.rgbhexColorFamily=function(e){return v(c.rgbhex2Lab(e))},t.colorFamily=v,t.sortByRgbHex=function(e){return b(c.rgbhex2Lab(e))},t.sortByLab=b,t.sortByHSV=function(e){const[t,n,i]=c.rgbhex2hsv(e);return[Math.round(12*t/360),Math.round(4*i/100),Math.round(4*n/100)]},t.annealSort=function(e,t,n){const r=(e,t,n)=>n-t<2?0:i.sum(e.slice(t,n-1),(n,i)=>s.map2Or(n,e[t+i+1],(e,t)=>c.diffCIE94(e.lab,t.lab),()=>100));return o.times(t,()=>i.anneal({array:e,expense:r,allowedDelta:n})),e}},,,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(23),s=n(11),o=n(269);t.ForceArg={beforeParse:e=>e.option("--force","Delete prior cached sync results to force the paths to be re-imported"),afterParse:e=>i(void 0,void 0,void 0,(function*(){r.isTrue(e.force)&&(s.Settings.forceSync.tmpValue=!0,yield o.clearCacheDirs())}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(3),r=n(22);t.parseMaybe=function(e){return i.mapNotBlank(e,e=>r.Try(()=>JSON.parse(e)))}},,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(23),s=n(11);t.NoFilterArg={beforeParse:e=>e.option("--nofilter","Disables import filters. All paths will try to be imported, even if they are too small or are missing tags."),afterParse:e=>i(void 0,void 0,void 0,(function*(){r.isTrue(e.nofilter)&&(s.Settings.minFileSizeBytes.tmpValue=0,s.Settings.requireMakeModel.tmpValue=!1,s.Settings.minImageDimension.tmpValue=0,s.Settings.minVideoDimension.tmpValue=0)}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(8),r=n(32),s=n(3),o=n(0),a=n(102);function u(e){return o.map(e,e=>s.mapNotBlank(e.Make,t=>s.mapNotBlank(e.Model,e=>[a.Camera,t,e])))}t.cameraTag=u,t.cameraTagFile=function(e){return i.thenMap(r.readTags(e),u)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(348),s=n(12),o=n(8),a=n(261),u=n(4),l=n(11),c=n(9),d=n(111),h=n(32),f=n(1),p=n(3),m=n(2),g=n(0),y=n(10),v=n(7),b=n(102),w=m.lazy(()=>u.mkLogger("KeywordTagger")),S=m.lazy(()=>new RegExp(`[${l.Settings.keywordDelimiters.valueOrDefault}]`));function M(e){return f.compactBlanks(Array.isArray(e)?f.flatten(e.map(M)):e.split(S()))}l.Settings.keywordDelimiters.addListener(()=>S.clear());const P=m.lazy(()=>new RegExp(`[ /${l.Settings.keywordDelimiters.valueOrDefault}]`));l.Settings.keywordDelimiters.addListener(()=>P.clear());const E=m.lazy(()=>p.mapNotBlank(l.Settings.keywordPathSeparators.valueOrDefault,e=>new RegExp(`[${e}]`)));function x(e){return null==e||f.isEmpty(e.Category)?[]:[e._,...x(e.Category[0])]}function _(e){return i(this,void 0,void 0,(function*(){if(null==e)return[];const t=[];return yield o.thenMap(function(e){return i(this,void 0,void 0,(function*(){if(null!=e)try{const t=yield r.parseStringPromise(e),n=null==t?void 0:t.Categories;return null==n?void 0:n.map(x)}catch(e){return}}))}(e.Categories),e=>t.push(...e)),f.compactBlankish([e.HierarchicalSubject,e.TagsList,e.CatalogSets,e.Keywords,e.LastKeywordXMP,e.Subject,e.XPKeywords]).forEach(e=>t.push(...Array.isArray(e)?e:M(e))),w().tap({msg:"rawTagKeywords()",result:f.uniq(t),meta:y.pick(e,"Categories","HierarchicalSubject","TagsList","CatalogSets","Keywords","LastKeywordXMP","Subject","XPKeywords")})}))}function F(e){return w().tap({msg:"extractDashDashTags()",result:g.mapOr(v.toS(e).split("--")[1],e=>f.compactBlanks(e.split(P())),()=>[]),meta:{s:e}})}function T(e){return[...F(e.parent().posixPath),...F(e.name)]}function O(e){const t=[],n=E(),[i,r]=s.partition(f.uniq(f.flatten(e.map(e=>c.isString(e)?e.split(S()):e)).map(e=>c.isString(e)&&null!=n&&null!=e.match(n)?e.split(n):e).map(e=>Array.isArray(e)&&1==e.length?e[0]:e).map(e=>c.isString(e)?e.trim():e.map(e=>e.trim()))),Array.isArray),o=new a.CISet;for(const e of i)o.add(e[e.length-1]),1==e.length?t.push([b.Keywords,...e]):t.push([c.capitalize(e[0]),...e.slice(1)]);for(const e of r.filter(e=>!o.has(e)))t.push([b.Keywords,e]);return t}function A(e){return f.uniqBy(f.sortBy(e,e=>{const t=e.join("/");return[t.normalize().toLowerCase(),-1*d.lcdiff(t)]}),e=>JSON.stringify(e).normalize().toLowerCase())}l.Settings.keywordPathSeparators.addListener(()=>E.clear()),t.extractDashDashTags=F,t.extractPathnameTags=T,t.normalizeKeywordPaths=O,t.dedupeKeywordPaths=A,t.keywordTagFiles=function(...e){return i(this,void 0,void 0,(function*(){return A(O([...l.Settings.tagKeywordsFromPath.valueOrDefault?f.flatten(e.map(T)):[],...l.Settings.tagKeywordsFromMetadata.valueOrDefault?f.flatten(yield Promise.all(e.map(e=>o.thenMap(h.readRawTags(e),_)))):[]]))}))}},function(e,t){e.exports=require("xml2js")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(8),r=n(32),s=n(3),o=n(0),a=n(102);function u(e){return o.map(e,e=>s.mapNotBlank(e.lensMake,t=>s.mapNotBlank(e.lensModel,e=>[a.Lens,t,e])))}t.lensTag=u,t.lensTagFile=function(e){return i.thenMap(r.readTags(e),u)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(9),s=n(32),o=n(1),a=n(2),u=n(0),l=n(46),c=n(102);t.typeTagFiles=function(...e){return i(this,void 0,void 0,(function*(){return o.uniq(yield Promise.all(e.map(s.mimetype))).map(h)}))};const d=new Map(["M2TS","JPEG","QuickTime"].map(e=>[e.toLowerCase(),e]));function h(e){const t=e.split("/");return o.compactBlanks([c.Type,r.capitalize(t[0]),...p(t[1])])}t.mimetypeToTag=h;const f=a.lazy(()=>new Map([["m2ts",["MPEG-2"]],["mp4",["MPEG-4"]],["quicktime",["QuickTime"]],["x-adobe-dng",["Raw","DNG"]],["x-fuji-raf",["Raw","Fujifilm"]],["x-msvideo",["AVI"]]]));function p(e){return l.firstDefinedThunk([()=>f().get(e.trim().toLowerCase()),()=>u.map(e.match(/^\w{3,4}/),()=>[e.toUpperCase()]),()=>u.map(e.match(/^x-(\w{4,})-\w{3}/),e=>["Raw",r.capitalize(e[1])]),()=>[r.capitalize(r.stripPrefix(e,"x-").replace(/-/g," "))]])}t.friendlySubtype=p,t.fixCase=function(e){return e.match(/[a-z0-9]{3}/i)?e.toUpperCase():u.orElse(d.get(e.trim().toLowerCase()),()=>r.capitalize(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(7);t.ExposureSettingsProps=["focalLength","aperture","shutterSpeed","iso"],t.exposureSettingsDesc=function(e){return r.map(e,e=>i.compactBlanks([e.focalLength,r.map(e.aperture,e=>"Æ/"+e),s.toS(e.shutterSpeed),r.map(e.iso,e=>"ISO "+e)]).join(", "))}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){n(183),e.exports=n(414)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});try{n(253).install()}catch(e){}const r=n(212),s=n(254),o=n(342),a=n(345),u=n(415);!function(){i(this,void 0,void 0,(function*(){const e=yield new r.CLI("syncFile","[FILE ...]").add(s.CommonArgs,o.ForceArg,a.NoFilterArg).parse();new u.SyncFileService(e.args)}))}(),t.load=!0},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(133),s=n(24),o=n(8),a=n(52),u=n(23),l=n(20),c=n(13),d=n(181),h=n(121),f=n(29),p=n(333),m=n(343),g=n(4),y=n(11),v=n(32),b=n(25),w=n(1),S=n(3),M=n(28),P=n(5),E=n(69),x=n(145),_=n(146),F=n(257),T=n(173),O=n(416),A=n(418),k=n(419),D=g.mkLogger("SyncFileService");t.SyncFileService=class{constructor(e){this.argv=e,this.jobs=new a.Promises,this.service=new F.Service({name:"sync-file",stdinReceiver:this.stdinReceiver.bind(this)}),c.onRpcServerChange(()=>this.service.exit("rpcServerChange",0)),d.onProgressEvt(e=>T.stdoutWrite(e,!1)),this.start()}start(){return i(this,void 0,void 0,(function*(){(yield o.rejected(this.service.ready))?D.warn("setup(): service.ready was rejected, exitting."):(w.isNotEmpty(this.argv)&&(yield this.importFiles(this.argv).then(()=>this.service.exit("Processed files from argv",0))),s.addFirstEndable(new s.EndableWrapper("SyncFileService",()=>(w.mapNotEmpty(this.jobs.pendingNames(),e=>D.info("Waiting for "+e)),this.jobs.awaitAll()))))}))}checkup(){return i(this,void 0,void 0,(function*(){try{const e=v.exiftool().version();if(x.memoryUsageIsHigh())throw new Error("Memory usage is too high");return yield o.thenOrTimeout(E.dbClient().ping(),b.cmdTimeoutMs,()=>{throw new Error("Failed to ping RPC server")}),void(yield o.thenOrTimeout(e,b.cmdTimeoutMs,()=>{throw new Error("Failed to ping ExifTool")}))}catch(e){return l.onError("checkup() failed"+l.FatalErrorFlag,e)}}))}stdinReceiver(e){return i(this,void 0,void 0,(function*(){if(!s.ending()){yield this.checkup();for(const t of w.compactBlanks(h.splitLines(e))){if(S.blank(t))continue;const e=m.parseMaybe(t);null==e?yield this.importFile(f.PosixFile.for(t)):S.notBlank(e.file)?yield this.maybeForce(e.force,()=>this.importFile(f.PosixFile.for(e.file))):P.gt0(e.updateAssetFileId)?yield this.maybeForce(e.force,()=>this.updateAssetFile(e.updateAssetFileId)):P.gt0(e.updateAssetId)?yield this.maybeForce(e.force,()=>this.updateAsset(e.updateAssetId)):console.log(JSON.stringify({error:"Cannot parse "+t}))}}}))}maybeForce(e,t){return i(this,void 0,void 0,(function*(){u.isTrue(e)&&(y.Settings.forceSync.tmpValue=!0);try{return yield t()}finally{y.Settings.forceSync.clear()}}))}updateAssetFile(e){return this.jobs.serial(`SyncFileService.updateAssetFile(${e})`,()=>i(this,void 0,void 0,(function*(){try{const t=yield k.updateAssetFile(e);T.stdoutWrite(t)}catch(t){T.stdoutWrite({id:e,error:M.errorToS(t)})}})))}updateAsset(e){return this.jobs.serial(`SyncFileService.updateAsset(${e})`,()=>i(this,void 0,void 0,(function*(){try{yield A.updateAsset(e),T.stdoutWrite({id:e})}catch(t){T.stdoutWrite({id:e,error:M.errorToS(t)})}})))}importFiles(e){return i(this,void 0,void 0,(function*(){for(const t of e)yield this.checkup(),yield this.importFile(f.PosixFile.for(t))}))}importFile(e){return i(this,void 0,void 0,(function*(){const t=Date.now();e.clear(),D.info("importFile()",e);const n=yield this.importFileToResult(e);return D.info("importFile() finished in "+(Date.now()-t)+"ms",{importResult:n}),T.stdoutWrite(n),n}))}importFileToResult(e){return this.jobs.serial(`SyncFileService.importFileToResult(${e})`,()=>this._importFileToResult(e))}_importFileToResult(e){return i(this,void 0,void 0,(function*(){try{const t=_.Library.instance();if(null==t)return{path:e.nativePath,error:"Library is not set yet"};const n=y.envSkipFilters?{rejected:[]}:yield r.AsyncFilter.andExplain(e,p.expensiveFileFilters());if(w.isNotEmpty(n.rejected))return{path:e.nativePath,error:"rejected by "+n.rejected.join(", ")+" "+l.NonRetriableErrorFlag};{const n=new O.AssetFileImporter(e,t.assetFileRepository(),t.previews()),i=yield n.apply();if(null==i)throw new Error("empty result");return{path:i.uri,assetFileId:i.id,assetId:i.assetId}}}catch(t){return D.warn("Failed to import "+e+": "+t),{path:e.nativePath,error:M.errorToS(t)}}}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(48),s=n(21),o=n(29),a=n(122),u=n(127),l=n(4),c=n(137),d=n(11),h=n(2),f=n(0),p=n(5),m=n(336),g=n(182),y=n(120),v=n(417);t.AssetFileImporter=class{constructor(e,t,n){this.file=e,this.repo=t,this.previews=n,this.srcAssetFile=()=>this.assetFileFinder.apply(),this.assetFile=h.lazy(()=>i(this,void 0,void 0,(function*(){const e=yield this.srcAssetFile();if(this.logger.debug("srcAssetFile",e),null==e)return;const t=yield this.repoAssetFile();if(this.logger.debug("repoAssetFile",{repoAssetFile:t}),null==t)return this.logger.throw("got null assetFile from .assetRepoFile()",{srcAssetFile:e,repoAssetFile:t});const n=yield e.getAsset();return null==n?this.logger.throw("assetFile.getAsset() was null",{repoAssetFile:t}):null==n.id?this.logger.throw("repoAssetFile asset has null id",{asset:n}):(yield t.updateFromFile(),yield t.upsert(),t.uri!==e.uri&&(yield n.addAssetFile(t),yield e.updateFromFile(),yield e.upsert()),t)}))),this.repoAssetFile=h.lazy(()=>i(this,void 0,void 0,(function*(){const e=l.mkLogger(this.toString()+".repoAssetFile()"),t=yield this.srcAssetFile();if(null==t)return e.debug("srcAssetFile is undefined"),t;if(null==this.repo)return e.debug("this.repo is undefined"),t;const n=yield this.repo.importFile(this.file);if(e.info("repo.importFile() returned "+n,{srcAssetFile:t}),null==n||this.file.eql(n))return e.debug("this.repo isn't copying assets, returning srcAssetFile",t),t;const i=yield t.getAsset();if(null==i)return e.throw("INTERNAL ERROR, asset is null");const r=yield n.uri();if(null==r)return e.throw("INTERNAL ERROR, uri is null");const s=yield i.findAssetFileByUri(r);if(e.debug("by uri",{prior:s}),null!=s)return s;e.debug("Creating new assetFile");const o=new y.AssetFile;return yield o.setFile(n),i.addAssetFile(o)}))),this.logger=l.mkLogger(this.toString()),this.assetFileFinder=new v.AssetFileFinder(e)}toString(){return"AssetFileImporter("+this.file.nativePath+")"}newAssetFile(){return this.assetFileFinder.newAssetFile()}apply(){return i(this,void 0,void 0,(function*(){return null!=this.result?this.result.promise:(this.result=new r.Deferred("AssetFileImporter("+this.file+").apply"),this.result.observe(this._apply()).promise)}))}_apply(){return i(this,void 0,void 0,(function*(){if(null==(yield this.file.size()))return this.logger.throw("unreadable file");const e=yield a.syncFileTimeoutForFileMs(this.file);if(!p.gt0(e))return this.logger.throw("syncFileTimeoutForFile() returned undefined");f.map(this.result,t=>t.setTimeout(e)),this.logger.info("Setting timeout to "+s.fmtDuration(e));const t=yield this.assetFile();if(null==t)return this.logger.throw("_apply(): unexpected null assetFile");const n=yield t.getAsset();if(null==n)return this.logger.throw("_apply(): unexpected null asset");const r=n.id;return null==r||t.assetId!==n.id?this.logger.throw("_apply(): unexpected assetId",{asset_id:n.id,af_assetId:t.assetId,af_id:t.id}):(yield g.withAdvisoryLocks(["assetId:"+r],()=>i(this,void 0,void 0,(function*(){const e=yield this.buildPreviews(n);if(this.logger.debug("AssetPreviewInfo:",{assetId:r,info:e}),null!=e){const t=this.transcode(r,o.PosixFile.for(e.path));yield y.AssetFile.setShown(r,e.assetFileId),f.map(n.files,t=>t.forEach(t=>t.shown=t.id===e.assetFileId)),yield m.tagAndUpsertAsset(n,o.PosixFile.for(e.path)),yield t,n.shown=!0,n.version=c.AssetVersion,yield n.upsert()}}))),y.AssetFile.ops().findById(t.id))}))}buildPreviews(e){return i(this,void 0,void 0,(function*(){if(null!=this.previews){if(null==e)throw new Error("buildPreviews(): null asset");if(null==e.id)throw new Error("buildPreviews(): null asset.id");return this.logger.debug("buildPreviews()",{assetId:e.id}),this.previews.build({assetId:e.id,assetFiles:yield e.getFiles(),force:d.Settings.forceSync.valueOrDefault,validate:!1})}}))}transcode(e,t){return i(this,void 0,void 0,(function*(){return u.transcode(t,this.previews.ap(e).mp4())}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),s=n(66),o=n(21),a=n(132),u=n(165),l=n(286),c=n(4),d=n(11),h=n(32),f=n(179),p=n(1),m=n(3),g=n(6),y=n(2),v=n(64),b=n(74),w=n(182),S=n(93),M=n(120),P=n(337);t.AssetFileFinder=class{constructor(e){this.file=e,this.newAssetFile=y.lazy(()=>v.thenOpt((new M.AssetFile).updateFromFile(this.file)).getOrElse(()=>{throw new Error("Cannot update from file "+this.file)})),this.tags=y.lazy(()=>v.thenOpt(h.readTags(this.file)).getOrElse(()=>{throw new Error(this.file+" doesn't have metadata")})),this.capturedAt=y.lazy(()=>this.tags().then(e=>e.capturedAt)),this.imageHash=y.lazy(()=>d.Settings.useImageHashes.valueOrDefault?u.imageHash(this.file):void 0),this.capturedAtLocal=y.lazy(()=>v.thenOpt(this.capturedAt()).flatMap(e=>e.toLocal()).getOrElse(()=>{throw new Error(this.file+" doesn't have capturedAt local")})),this.mapSibling=e=>this.newAssetFileForAsset(r.thenMap(e,e=>e.getAsset())),this.apply=y.lazy(()=>s.time("sync-file.AssetFileFinder",()=>i(this,void 0,void 0,(function*(){if(m.blank(yield this.file.uri()))throw new Error("Cannot import, URI is blank");if(null==(yield this.tags()))throw new Error("Cannot import, tags are missing");if(null==(yield this.capturedAt()))throw new Error("Cannot import, capturedAt is null");{const e=yield this.byExistingAsset();if(null!=e)return this.logger.info("Found existing asset for file"),e}this.logger.info("No existing asset yet. Fetching advisory locks.");const e=yield this.newAssetFile(),t=p.uniq(p.compactBlanks(["bname:"+this.file.nameWithoutCount.toLowerCase(),"bname:"+f.bname(this.file),"at:"+e.capturedAtLocal/1e4,"sha:"+e.sha]));return w.withAdvisoryLocks(t,()=>i(this,void 0,void 0,(function*(){const t=yield this.byExistingAsset();if(null!=t)return this.logger.info("Found existing asset for file (after locks)"),t;const n=new S.Asset;if(n.capturedAtLocal=e.capturedAtLocal,yield n.addAssetFile(e),null==(yield n.insert()))throw new Error("Failed to insert new Asset for "+this.file);if(e.assetId=n.id,null==(yield e.insert()))throw new Error("Failed to insert new AssetFile for "+this.file);return e})))})))),this.logger=c.mkLogger("AssetFileFinder("+e+")")}newAssetFileForAsset(e){return i(this,void 0,void 0,(function*(){return r.thenMap(e,e=>i(this,void 0,void 0,(function*(){return e.addAssetFile(yield this.newAssetFile())})))}))}byExistingAsset(){return i(this,void 0,void 0,(function*(){const e=[{name:"byUri",f:()=>this.byUri()},{name:"byEqlUri",f:()=>this.byEqlUri()},{name:"bySha",f:()=>this.newAssetFileForAsset(this.assetBySha())},{name:"validFile",f:()=>l.validFile(this.file)},{name:"byCapturedAtOrImageHash",f:()=>this.newAssetFileForAsset(this.assetByCapturedAtOrImageHash())}];for(const{name:t,f:n}of e)try{const e=yield n();if(null!=e)return this.logger.info("apply(): "+t,{assetFileId:e.id,assetId:e.assetId}),e;this.logger.info("apply(): "+t+" is null")}catch(e){throw this.logger.info("apply(): "+t+" rejected: "+e),e}}))}byUri(){return r.thenMap(this.file.uri(),e=>M.AssetFile.ops().findOneBy({uri:e}))}byEqlUri(){return i(this,void 0,void 0,(function*(){return r.thenMap(this.file.uri(),e=>r.thenMap(this.file.sha(),t=>r.thenMap(M.AssetFile.ops().findBy({sha:t}),t=>i(this,void 0,void 0,(function*(){for(const n of t)if(yield a.uriEql(n.uri,e))return n})))))}))}assetBySha(){return r.thenMap(this.file.sha(),e=>S.Asset.findFirstByFile(t=>t.where("AssetFile.sha",e)))}assetByCapturedAtOrImageHash(){return i(this,void 0,void 0,(function*(){const e=yield this.capturedAtLocal(),t="stat"===(yield r.thenMap(this.capturedAt(),e=>e.src));return this.logger.info("assetByCapturedAt()",{dbRpc:b.dbRpc(),opsName:M.AssetFile.ops().constructor.name}),r.firstDefinedPromise([()=>M.AssetFile.ops().all(M.AssetFile.query().where("capturedAtLocal",e)),()=>M.AssetFile.ops().all(M.AssetFile.query().whereBetween("capturedAtLocal",[e-200,e+200])),()=>r.thenMap(this.imageHash(),t=>M.AssetFile.ops().all(M.AssetFile.query().where("capturedAtPrecisionMs",">",0).andWhereBetween("capturedAtLocal",[o.localPlusMs(e,-g.dayMs),o.localPlusMs(e,g.dayMs)]).andWhere(e=>e.where({meanHash:t.meanHash}).orWhere({rightHash:t.rightHash}).orWhere({searchHash:t.searchHash})))),()=>r.thenMap(this.imageHash(),e=>{let n=M.AssetFile.query().where({searchHash:e.searchHash});return t||(n=n.andWhere({capturedAtSrc:"stat"})),n.andWhere(t=>{t.whereIn("mode0",p.compact(e.modes.slice(0,4)))}).andWhere(t=>{t.whereIn("mode1",p.compact(e.modes.slice(0,4)))}),M.AssetFile.ops().all(n.limit(100))})],e=>this.firstSimilar(e))}))}firstSimilar(e){return i(this,void 0,void 0,(function*(){const t=yield this.newAssetFile(),n=yield this.capturedAtLocal();if(null==t)throw new Error("Failed to update from "+this.file);const i=p.sortBy(e,e=>[Math.abs(e.capturedAtLocal-n),e.id]);for(const e of i){const n=yield e.updateIfNeeded();if(null!=n){const e=P.whyNotSimilar(n,t);if(null==e)return this.logger.info("Found sibling AssetFile",n),S.Asset.ops().findById(n.assetId);this.logger.debug("Contemporary assetFile not similar: "+e,n)}}}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(12),s=n(8),o=n(52),a=n(23),u=n(21),l=n(20),c=n(29),d=n(270),h=n(286),f=n(4),p=n(137),m=n(70),g=n(1),y=n(6),v=n(0),b=n(19),w=n(336),S=n(146),M=n(93),P=n(120),E=n(337),x=n(182);function _(e){return i(this,void 0,void 0,(function*(){return x.withAdvisoryLocks(["assetId:"+e],()=>function(e){return i(this,void 0,void 0,(function*(){const t=f.mkLogger(`UpdateAsset(${e})`),n=S.Library.instance();if(null==n)return t.throw("null library"+l.NonRetriableErrorFlag);const x=[];t.info("starting");const F=yield M.Asset.ops().findById(e);if(null==F)return t.throw("no such asset");const T=yield F.getFiles(),O=[];for(const e of T)(yield e.isDeleted())?(t.info("AssetFile has been deleted. Deleting model object.",e),O.push(e.id)):t.debug("AssetFile is not deleted.",e);if(yield g.mapNotEmpty(O,e=>P.AssetFile.ops().delete(e)),g.filterInPlace(T,e=>!O.includes(e.id)),g.isEmpty(T))return t.info("Empty asset. Deleting.",F),void(yield M.Asset.ops().delete([e]));if(yield r.everyAsync(T,e=>e.notExists()))return void t.info("No existing files. Skipping for now.");yield o.withBoundedConcurrency({name:"AssetFile.updateIfNeeded",laters:T.map(e=>()=>e.updateIfNeeded()),maxConcurrent:m.maxCpus()}),yield function(e){return i(this,void 0,void 0,(function*(){const[t,n]=r.partition(e,e=>e.isUpdated());for(const e of n)yield v.map(t.find(t=>t.sha===e.sha),t=>e.updateFromShaSibling(t))}))}(T);const A=yield function(e){return i(this,void 0,void 0,(function*(){const t=f.mkLogger(`UpdateAsset.bestAssetFile(${e.map(e=>e.id)})`);for(const t of e)if(a.isTrue(t.shown)&&(yield t.exists()))return t;const n=yield d.sortAssetFiles(e);return t.tap({msg:"best result",meta:{uris:b.toA(n).map(e=>e.uri)},result:v.map(n,e=>e.pop())})}))}(T);if(null==A)return t.info("No existing files. Skipping for now.");if(!A.isUpdated())return void t.info("Best file needs update. Skipping for now.");const[k,D]=yield s.partitionAsync(T,e=>i(this,void 0,void 0,(function*(){return E.isSimilar(e,A)||(yield e.notExists())})));if(g.isNotEmpty(D)){const[e,n]=yield s.partitionAsync(D,e=>s.thenMapOr(e.posixFile(),e=>h.isValidFile(e),()=>!1));yield g.mapNotEmpty(n,e=>(t.warn("Asset files are invalid. Deleting.",e),P.AssetFile.ops().delete(e.map(e=>e.id))));const i=yield r.clusterStrictAsync(e,E.isSimilar);for(const e of i){const n=new M.Asset;n.capturedAtLocal=e[0].capturedAtLocal,n.version=0,yield n.upsert(),x.push(n.id),yield P.AssetFile.dbr(t=>t.run(P.AssetFile.query().update({assetId:n.id,shown:0}).whereIn("id",e.map(e=>e.id)))),t.info("Pushed rejected asset files into new asset",{rejectAsset:n,rejectCluster:e})}}function C(e){return g.uniq(k.map(t=>t[e]))}const I=C("capturedAtLocal"),L=g.uniq(k.map(e=>e.capturedAtPrecisionMs)),R=yield P.AssetFile.ops().all(P.AssetFile.query().distinct().where("assetId","!=",e).andWhere(e=>{e.whereIn("sha",C("sha")).orWhereIn("capturedAtLocal",I).orWhere(e=>e.whereBetween("capturedAtLocal",[u.localPlusMs(Math.min(...I),-Math.max(...L,1)),u.localPlusMs(Math.max(...I),Math.max(...L,1))])).orWhere(e=>e.where("capturedAtPrecisionMs",">",0).andWhereBetween("capturedAtLocal",[u.localPlusMs(Math.min(...I),-y.dayMs),u.localPlusMs(Math.max(...I),y.dayMs)]).andWhere(e=>e.whereIn("meanHash",C("meanHash")).orWhereIn("rightHash",C("rightHash"))))}));yield o.withBoundedConcurrency({name:"AssetFile.updateIfNeeded",laters:R.map(e=>()=>e.updateIfNeeded()),maxConcurrent:m.maxCpus()});const B=R.filter(e=>E.isSimilar(e,A));t.debug("fetched expansion",{retainAFs:k.map(e=>e.id),rejectAFs:D.map(e=>e.id),externalAssetFiles:R.length,similarAssetFiles:B.length}),B.forEach(e=>{a.isTrue(e.shown)&&x.push(e.assetId)});const N=[...k,...B];yield P.AssetFile.dbr(e=>e.run(P.AssetFile.query().update({assetId:F.id,shown:0}).whereIn("id",B.map(e=>e.id))));for(const e of N)e.assetId=F.id,e.shown=!1;const j=yield n.previews().build({assetId:e,assetFiles:N,validate:!0}),z=N.find(e=>e.uri===j.uri);if(null==z)return t.throw("invalid AssetPreviewInfo (failed to find best assetFile)",{assetPreviewInfo:j,assetFileURIs:N.map(e=>e.uri)});yield P.AssetFile.setShown(e,j.assetFileId),yield w.tagAndUpsertAsset(F,c.PosixFile.for(j.path)),F.capturedAtLocal=z.capturedAtLocal,F.version=p.AssetVersion,F.shown=!0,yield F.upsert();for(const e of x)yield _(e);return F}))}(e))}))}t.updateAsset=_},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(22),s=n(137),o=n(3),a=n(10),u=n(93),l=n(120),c=n(11);t.updateAssetFile=function(e){return i(this,void 0,void 0,(function*(){const t=yield l.AssetFile.ops().findById(e);if(null==t)throw new Error("no such AssetFile");if(yield t.isDeleted())return l.AssetFile.ops().delete([t.id]),Object.assign(Object.assign({},t),{deleted:!0});if(t.isUpdated()&&!c.Settings.forceSync.valueOrDefault)return t;if(yield t.matchesFile())return t;if(null!=(yield t.updateIfNeeded()))yield u.Asset.touch([t.assetId]);else if(o.notBlank(t.sha)){const e=yield l.AssetFile.ops().findOne(l.AssetFile.query().where({sha:t.sha,version:s.AssetFileVersion}));null!=e&&(r.assignMissingPrimitives(t,a.without(e,"id","sha","assetId","shown","uri","mountpoint","createdAt","updatedAt")),yield t.maybeUpdateStats(),yield t.upsert(),yield u.Asset.touch([t.assetId]))}return t}))}}]);
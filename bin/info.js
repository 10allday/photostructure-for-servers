#!/usr/bin/env node
/* Copyright Â© 2020, PhotoStructure Inc. <https://photostructure.com/eula> */
module.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=445)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nulled=t.denull=t.firstDefined=t.allDefined=t.defined=t.map2Or=t.mapOr=t.orElse=t.map3=t.map2=t.mapTry=t.map=void 0;const i=n(45),r=n(7);function o(e,t){return null==e?void 0:t(e)}function s(e,t,n){return null==e||null==t?void 0:n(e,t)}function a(e,t){return null!=e?e:i.tot(t)}function u(e){return null!=e}t.map=o,t.mapTry=function(e,t){try{return o(e(),t)}catch(e){return}},t.map2=s,t.map3=function(e,t,n,i){return null==e||null==t||null==n?void 0:i(e,t,n)},t.orElse=a,t.mapOr=function(e,t,n){return null==e?n():t(e)},t.map2Or=function(e,t,n,i){return a(s(e,t,n),i)},t.defined=u,t.allDefined=function(e){return null!=e&&e.every(u)},t.firstDefined=function(...e){return e.find(u)},t.denull=function(e){return null==e||"null"===r.toS(e)?void 0:e},t.nulled=function(e){return null==e?null:e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stepRange=t.range=t.anneal=t.commonPrefixLength=t.firstMatch=t.sum=t.count=t.clear=t.uniqBy=t.uniq=t.compactBlanks=t.compactBlankish=t.compact=t.insertUniq=t.insertAt=t.pushUniq=t.includesAll=t.indexOf=t.includes=t.move=t.filterInPlace=t.startsWith=t.arrayEql=t.deepSortBy=t.sortBy=t.sortedBy=t.sorted=t.sortUniqByInPlace=t.sortByInPlace=t.copyArrayTo=t.sort=t.flatten=t.mapNotEmpty=t.mapArray=t.isEmpty=t.isNotEmpty=void 0;const i=n(3),r=n(90),o=n(21),s=n(189),a=n(55),u=n(0),l=n(42),c=n(78),d=n(15),h=n(7);function f(e){return s.isList(e)&&e.length>0&&e.some(e=>null!=e)}function m(e){return!f(e)}function p(e){return l.isPrimitive(e)||l.isPrimitiveArray(e)?e:e.valueOf()}function g(e,t){for(let n=0;n<e.length;n++)t[n]=e[n];return t.length=e.length,t}function v(e,t){return g(y(e,t),e)}function y(e,t){return d.toA(e).filter(e=>null!=e).map((e,n)=>({item:e,cmp:u.map(t(e),e=>[e,n])})).filter(e=>null!=e.cmp).sort((e,t)=>l.cmp(e.cmp,t.cmp)).map(e=>e.item)}function b(e,t){return null!=e&&null!=t&&e.length===t.length&&e.every((e,n)=>e===t[n])}function S(e,t,n){if(t===n||t<0||n<0||t>=e.length||n>=e.length)return e;const i=e[t];return e.splice(t,1),e.splice(n,0,i),e}function w(e,t){if(null==e)return!1;for(const n of e)if(t.valueOf()===n.valueOf())return!0;return!1}function M(e){if(null==e)return[];const t=d.toA(e);return t.every(u.defined)?t:t.filter(u.defined)}t.isNotEmpty=f,t.isEmpty=m,t.mapArray=function(e,t){return Array.isArray(e)?t(e):void 0},t.mapNotEmpty=function(e,t){return f(e)?t(e):void 0},t.flatten=function(e,t=[]){if(null==e)return t;for(const n of e)null!=n&&(Array.isArray(n)?t.push(...M(n)):t.push(n));return t},t.sort=function(e){return v(M(e),p)},t.copyArrayTo=g,t.sortByInPlace=v,t.sortUniqByInPlace=function(e,t){const n=new Map;for(const i of e)a.getOrSet(n,o.stringify(t(i)),()=>i);return g(y(n.values(),t),e)},t.sorted=function(e){return e.every((t,n)=>0===n||t>e[n-1])},t.sortedBy=function(e,t){return e.every((n,i)=>0===i||t(n)>t(e[i-1]))},t.sortBy=y,t.deepSortBy=function e(t,n){return y(t,n).map(t=>r.isIterable(t)?e(t,n):t)},t.arrayEql=b,t.startsWith=function(e,t){return b(e.slice(0,t.length),t)},t.filterInPlace=function(e,t){for(let n=0;n<e.length;)t(e[n],n,e)?n++:e.splice(n,1);return e},t.move=S,t.includes=w,t.indexOf=function(e,t){if(null==e)return;let n=0;for(const i of e){if(t(i,n))return n;n++}},t.includesAll=function(e,t){return null!=e&&null!=t&&t.every(t=>w(e,t))},t.pushUniq=function(e,...t){if(e.length>100){const n=new Set(e);for(const i of t)n.has(i)||(e.push(i),n.add(i))}else for(const n of t)w(e,n)||e.push(n);return e},t.insertAt=function(e,t,...n){return e.splice(t,0,...n),e},t.insertUniq=function(e,t,n){for(let t=0;t<e.length-1;t++)if(n(e[t],e[t+1])>0)throw new Error("badly sorted array: "+e);for(let i=0;i<e.length;i++){const r=n(e[i],t);if(0===r)return e;if(r>0)return e.splice(i,0,t),e}return e.push(t),e},t.compact=M;const P=["","null","undefined"];function E(e,t=(e=>o.stringify(e))){if(m(e))return[];const n=new Map;return e.forEach(e=>u.map(e,i=>u.map(t(i),t=>a.getOrSet(n,t,()=>e)))),[...n.values()]}function x(e,t,n=1,i=(e=>e)){const r=[];if(e<t)for(let o=e;o<t;o+=n)r.push(i(o));else for(let o=e;o>t;o-=n)r.push(i(o));return r}t.compactBlankish=function(e){return d.toA(e).filter(e=>i.notBlank(e)&&!P.includes(h.toS(e).trim()))},t.compactBlanks=function(e){return null==e?[]:e.map(e=>h.toS(e).trim()).filter(e=>e.length>0)},t.uniq=function(e){return E(M(e),e=>o.stringify(e))},t.uniqBy=E,t.clear=function(e){return e.length=0,e},t.count=function(e,t){return e.reduce((e,n,i)=>e+(t(n,i)?1:0),0)},t.sum=function(e,t){return e.reduce((e,n,i)=>e+t(n,i),0)},t.firstMatch=function(e,t){for(const n of M(t)){const t=e.exec(n);if(null!=t)return t}},t.commonPrefixLength=function(e,t){if(null==e||null==t)return 0;if(e===t)return e.length;if("string"==typeof e&&(e=e.split("")),"string"==typeof t&&(t=t.split("")),b(e,t))return e.length;let n=0;for(;e[n]===t[n];)n++;return n},t.anneal=function({array:e,expense:t,allowedDelta:n}){const i=Math.round(n);if(i<2)return e;for(let n=0;n<e.length-1;n++){const r=c.randomInt(Math.max(0,n-i),Math.min(e.length,n+i),[n]);if(null==r)continue;const o=Math.max(0,Math.min(r,n)-1),s=Math.min(e.length,Math.max(r,n)+1),a=t(e,o,s);S(e,n,r);const u=t(e,o,s);l.lt(a,u)&&S(e,r,n)}return e},t.range=function(e,t,n=(e=>e)){return x(e,t,1,n)},t.stepRange=x},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazy=void 0;const i=n(0);t.lazy=function(e,t){let n,r=0;const o=[];function s(){r=0,n=void 0,o.forEach(e=>e(n))}function a(e){return r=Date.now(),n=e,o.forEach(e=>e(n)),n}function u(){return(0===r||null!=t&&r+t<=Date.now())&&a(e()),n}return u.set=e=>a(e),u.clear=()=>{const e=n;return s(),e},u.unset=()=>{s()},u.prior=()=>n,u.refresh=()=>a(e()),u.ttl=()=>t,u.setTTL=e=>t=e,u.onChange=e=>{o.push(e),i.map(n,e)},u.toJSON=()=>"(Lazy)",u.lastSetAgoMs=()=>Date.now()-r,u}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstNotBlank=t.mapNotBlankOr=t.mapNotBlank=t.notBlankAnd=t.notBlankOr=t.ifNotBlank=t.notBlank=t.blank=void 0;const i=n(0),r=n(45),o=n(15),s=n(7);function a(e){if(null==e)return!0;const t=s.toS(e);return 0===t.length||0===t.trim().length}function u(e){return!a(e)}function l(e,t){if(!1===e||null==e||""===e)return;const n=s.toS(e);return u(n)?t(n):void 0}t.blank=a,t.notBlank=u,t.ifNotBlank=function(e){if(null==e)return;const t=s.toS(e);return 0===t.length||0===t.trim().length?void 0:t},t.notBlankOr=function(e,t){if(null==e)return r.tot(t);const n=s.toS(e).trim();return n.length>0?n:r.tot(t)},t.notBlankAnd=function(e,t){return!a(e)&&t(e)},t.mapNotBlank=l,t.mapNotBlankOr=function(e,t,n){return i.orElse(l(e,t),n)},t.firstNotBlank=function(...e){return o.toA(e).find(e=>u(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitHMS=t.fmtDateShort=t.weekMs=t.dayMs=t.hourMs=t.minuteMs=t.secondMs=void 0;const i=n(2),r=n(18),o=n(0);t.secondMs=1e3,t.minuteMs=60*t.secondMs,t.hourMs=60*t.minuteMs,t.dayMs=24*t.hourMs,t.weekMs=7*t.dayMs;const s=i.lazy(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));t.fmtDateShort=function(e){return r.Opt(e).flatMap(e=>e instanceof Date?e.getTime():e).map(e=>s().format(e)).get()},t.splitHMS=function(e){return o.mapOr(/^[0:]{1,4}/.exec(e),t=>[t[0],e.substr(t[0].length)],()=>["",e])}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.times=t.clamp=t.base10Ceil=t.base2Ceil=t.sigFigs=t.toPrecision=t.toFixed=t.toPrecisionMaybe=t.round=t.numericOr=t.mapNumericOr=t.map2Numeric=t.mapNumeric=t.mapIntOr=t.id=t.mapFloat=t.mapInt=t.gte0=t.gtOrElse=t.gt0=t.toGt0=t.toFloat=t.toInt=t.isToNumber=t.trunc=t.closeTo=t.absdiff=t.diff=t.finiteOrElse=t.gte=t.gt=t.lte=t.lt=t.mapFinite=t.isNumber=void 0;const i=n(3),r=n(0),o=n(39),s=n(18),a=n(45),u=n(7);function l(e){return"number"==typeof e&&isFinite(e)}function c(e,t){return l(e)?t(e):void 0}t.isNumber=l,t.mapFinite=c;const d=e=>(t,n)=>l(t)&&l(n)&&e(t,n);function h(e){return b(e,e=>{const t=Math.trunc(e);return 0===t?Math.abs(t):t})}function f(e){return o.isFunction(e.toNumber)}function m(e,t){if(i.blank(e))return t.defaultValue;if(l(e))return t.nton(e);if(f(e))return t.nton(e.toNumber());try{const n=t.ston(u.toS(e));return l(n)?t.nton(n):t.defaultValue}catch(e){return t.defaultValue}}function p(e,t){return m(e,Object.assign({defaultValue:void 0,nton:e=>h(e),ston:parseInt},t))}function g(e,t){return m(e,Object.assign({defaultValue:void 0,nton:e=>e,ston:parseFloat},t))}function v(e){return l(e)&&e>0}function y(e,t){return s.Opt(e).flatMap(e=>p(e)).flatMap(t).get()}function b(e,t){return l(e)?t(e):void 0}function S(e){return e<0?-Math.round(-e):Math.round(e)}function w(e,t){if(null==e)return 0;const n=Math.pow(10,t);return S(e*n)/n}t.lt=d((e,t)=>e<t),t.lte=d((e,t)=>e<=t),t.gt=d((e,t)=>e>t),t.gte=d((e,t)=>e>=t),t.finiteOrElse=function(e,t){return l(e)?e:t},t.diff=function(e,t){return l(e)&&l(t)?e-t:void 0},t.absdiff=function(e,t){return l(e)&&l(t)?Math.abs(e-t):void 0},t.closeTo=function(e,t,n){return null!=e&&null!=t&&Math.abs(e-t)<n},t.trunc=h,t.isToNumber=f,t.toInt=p,t.toFloat=g,t.toGt0=function(e){const t=p(e);return null!=t&&t>0?t:void 0},t.gt0=v,t.gtOrElse=function(e,t){return l(e)&&l(t)&&e>t?e:void 0},t.gte0=function(e){return l(e)&&e>=0},t.mapInt=y,t.mapFloat=function(e,t){return s.Opt(e).flatMap(e=>g(e)).flatMap(t).get()},t.id=function(e){const t=p(e);return v(t)?String(t):void 0},t.mapIntOr=function(e,t,n){return r.orElse(y(e,t),n)},t.mapNumeric=b,t.map2Numeric=function(e,t,n){return b(e,e=>b(t,t=>n(e,t)))},t.mapNumericOr=function(e,t,n){return l(e)?t(e):n},t.numericOr=function(e,t){return l(e)?e:a.tot(t)},t.round=S,t.toPrecisionMaybe=function(e,t){return c(e,e=>w(e,t))},t.toFixed=function(e,t){try{return b(e,e=>S(e*Math.pow(10,t))/Math.pow(10,t))}catch(e){return}},t.toPrecision=w,t.sigFigs=function(e,t){if(0===e||0===t)return 0;const n=Math.pow(10,t-S(Math.ceil(Math.log10(Math.abs(e)))));return S(e*n)/n},t.base2Ceil=function(e){return Math.pow(2,Math.ceil(Math.log2(e)))},t.base10Ceil=function(e){return Math.pow(10,Math.ceil(Math.log10(e)))},t.clamp=function(e,t,n){if(e>t||!l(e)||!l(t))throw new Error(`invalid clamp(${e}, ${t}, ${n})`);return l(n)?n<e?e:n>t?t:n:S((e+t)/2)},t.times=function(e,t){if(!v(e))return[];const n=Math.round(e);return n<=0?[]:[...Array(n)].map((e,n)=>t(n))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkLogger=t.writeRecentLogEntries=t.setupLogger=t.currentFileLogger=void 0;const i=n(2),r=n(17),o=n(41),s=n(147),a=n(99),u=n(124),l=n(9),c=i.lazy(()=>[s.ConsoleLogger.instance()]);function d(){return c().find(e=>e instanceof u.LogWriter)}t.currentFileLogger=d,t.setupLogger=function(){const e=l.Settings.logDir.valueOrDefault;let t=d();null!=t&&t.logDir.eql(e)||(r.end(t),t=new u.LogWriter(o.BaseFile.for(e)));const n=[t];(l.Settings.logStdout.valueOrDefault||l.Settings.tailLogs.valueOrDefault)&&n.push(s.ConsoleLogger.instance()),c.set(n)},t.writeRecentLogEntries=function(){var e;return null===(e=d())||void 0===e?void 0:e.writeRecentLogEntries()},t.mkLogger=function(e){return new a.ContextualLogger(e,c)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toS=void 0,t.toS=function e(t){return null==t?"":"string"==typeof t?t:Array.isArray(t)?t.map(e).join(","):t.toString()}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sortByAsync=t.thenGreatest=t.untilDefined=t.firstTruePromise=t.firstResolvedDefinedPromise=t.firstDefinedPromise=t.first=t.thenOrElse=t.thenAnd=t.thenMap2Or=t.thenMapOr=t.thenMap2=t.thenNot=t.thenFinally=t.tryAll=t.DefaultTryAllTimeoutMs=t.thenOrTimeout=t.tryAsync=t.partitionAsync=t.asyncFilter=t.tuples=t.asyncFind=t.thenCompact=t.thenFlatten=t.awaitAll=t.allSerial=t.thenDefined=t.rejected=t.resolved=t.resolvedWithin=t.thenMapResolved=t.DefaultMaxConcurrent=void 0;const r=n(1),o=n(4),s=n(32),a=n(0),u=n(5),l=n(39),c=n(18),d=n(26),h=n(13),f=n(22),m=n(16),p=n(25),g=n(206),v=n(44);var y=n(26);function b(e){return i(this,void 0,void 0,(function*(){try{return yield e,!0}catch(e){return!1}}))}function S(e,n,r=t.DefaultMaxConcurrent){return i(this,void 0,void 0,(function*(){return(yield v.withBoundedConcurrency({name:"tuples",laters:e.map((e,t)=>()=>i(this,void 0,void 0,(function*(){return[yield n(e,t),e]}))),maxConcurrent:r})).filter(([e,t])=>null!=e&&null!=t)}))}function w(e,t,n=(()=>{}),r=(()=>{})){return i(this,void 0,void 0,(function*(){let i,o=!1,a=!1;return yield Promise.race([g.asPromise(e).then(e=>a?void 0:(i=e,o=!0,e)),s.unrefDelay(t).then(()=>{o||(a=!0)})]),o?yield r(i):yield n(),i}))}Object.defineProperty(t,"thenMap",{enumerable:!0,get:function(){return y.thenMap}}),Object.defineProperty(t,"until",{enumerable:!0,get:function(){return y.until}}),t.DefaultMaxConcurrent=8,t.thenMapResolved=function(e,t){return i(this,void 0,void 0,(function*(){if(null==e)return Promise.resolve(void 0);try{return d.thenMap(e,t)}catch(e){return}}))},t.resolvedWithin=function(e,t){return Promise.race([e,s.delay(t).then(()=>{})])},t.resolved=b,t.rejected=function(e){return i(this,void 0,void 0,(function*(){return!(yield b(e))}))},t.thenDefined=function(e){return i(this,void 0,void 0,(function*(){return null!=(yield e)}))},t.allSerial=function(e){return i(this,void 0,void 0,(function*(){const t=[];for(const n of r.compact(e))t.push(yield n());return r.compact(t)}))},t.awaitAll=function(e){return i(this,void 0,void 0,(function*(){const t=r.compact(e);r.isNotEmpty(t)&&(yield Promise.all(t))}))},t.thenFlatten=function(e){return i(this,void 0,void 0,(function*(){return null==e?[]:r.flatten(r.compact(yield Promise.all(e)))}))},t.thenCompact=function(e){return i(this,void 0,void 0,(function*(){const t=r.compact(yield e);return r.isEmpty(t)?[]:r.compact(yield Promise.all(t))}))},t.asyncFind=function(e,t){return i(this,void 0,void 0,(function*(){for(const n of e)if(yield t(n))return n}))},t.tuples=S,t.asyncFilter=function(e,n,o=t.DefaultMaxConcurrent){return i(this,void 0,void 0,(function*(){return(yield S(r.compact(e),n,o)).filter(([e])=>e).map(([,e])=>e)}))},t.partitionAsync=function(e,t){return i(this,void 0,void 0,(function*(){const n=yield S(e,t);return[n.filter(([e])=>f.isTrue(e)).map(([,e])=>e),n.filter(([e])=>!f.isTrue(e)).map(([,e])=>e)]}))},t.tryAsync=function(e){return i(this,void 0,void 0,(function*(){try{return yield e()}catch(e){return}}))},t.thenOrTimeout=w,t.DefaultTryAllTimeoutMs=30*o.secondMs,t.tryAll=function(e,n=(e=>console.error(e)),r=t.DefaultTryAllTimeoutMs){return i(this,void 0,void 0,(function*(){for(const t of e)try{yield w(t,r)}catch(e){n(e)}}))},t.thenFinally=function(e,t=(()=>{}),n=(()=>{})){return i(this,void 0,void 0,(function*(){let i,r=null;try{i=yield l.isFunction(e)?e():e}catch(e){r=e;try{yield t(e)}catch(e){}}try{yield n(null!=r?r:i)}catch(e){}if(null!=r)throw r;return i}))},t.thenNot=function(e,t=!0){return i(this,void 0,void 0,(function*(){if(null==e)return t;const n=yield e;return null==n?t:!f.isTrue(n)}))},t.thenMap2=function(e,t,n){return i(this,void 0,void 0,(function*(){const i=yield e;if(null==i)return;const r=yield t;return null!=r?n(i,r):void 0}))},t.thenMapOr=function(e,t,n){return i(this,void 0,void 0,(function*(){const i=yield e;if(null==i)return n();const r=yield t(i);return null==r?n():r}))},t.thenMap2Or=function(e,t,n,r){return i(this,void 0,void 0,(function*(){const i=yield e;if(null==i)return r();const o=yield t;if(null==o)return r();const s=yield n(i,o);return null==s?r():s}))},t.thenAnd=function(e,t){return i(this,void 0,void 0,(function*(){return null!=e&&f.isTrue(yield e)?t():void 0}))},t.thenOrElse=function(e,t){return i(this,void 0,void 0,(function*(){return a.orElse(yield e,t)}))},t.first=function(e,t){return i(this,void 0,void 0,(function*(){if(null!=e){let n=-1;for(const i of e){n++;try{if(null==i)continue;const e=yield t(i,n);if(null!=e)return e}catch(e){}}}}))},t.firstDefinedPromise=function(e,t=p.identity){return i(this,void 0,void 0,(function*(){for(const n of e){const e=yield n();if(null!=e){const n=yield t(e);if(null!=n)return n}}}))},t.firstResolvedDefinedPromise=function(e,t){return i(this,void 0,void 0,(function*(){for(const n of e)try{const e=yield n();if(null!=e)return e}catch(e){t(e)}}))},t.firstTruePromise=function(e,...t){return i(this,void 0,void 0,(function*(){for(const n of t)try{const t=yield n();if(null!=t&&!0===(yield e(t)))return t}catch(e){}}))},t.untilDefined=function(e,{timeoutMs:t,timeBetweenMs:n}){return i(this,void 0,void 0,(function*(){const i=m.mapGt0(t,e=>Date.now()+e),r=c.Opt(n).getOrElse(()=>a.orElse(t,3e4)/10),o=u.clamp(50,1e4,r);for(;null==i||Date.now()<i;){const t=yield e();if(null!=t)return t;yield s.delay(o)}}))},t.thenGreatest=function(e,t){return i(this,void 0,void 0,(function*(){return a.map(h.greatestBy(yield S(e,t),e=>e[0]),e=>e[1])}))},t.sortByAsync=function(e,t){return i(this,void 0,void 0,(function*(){return r.sortBy(yield S(e,t),e=>e[0]).map(e=>e[1])}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spawnOptions=t.childEnv=t.psenv=t.settingsForChildProcs=t.persistedLibrarySettings=t.persistedSystemSettings=t.pathWithDefaults=t.withDefaultPaths=t.DefaultPaths=t.envSkipFilters=t.envSkipFiltersKey=t.envSuggestedDirsKey=t.Settings=void 0;const i=n(50),r=n(31),o=n(19),s=n(1),a=n(3),u=n(4),l=n(165),c=n(2),d=n(0),h=n(11),f=n(35),m=n(48),p=n(13),g=n(22),v=n(202),y=n(203),b=n(28),S=n(204),w=n(14),M=n(138),P=n(49),E=n(139);function x(e){const n=(a.blank(e)?"":e).split(r.delimiter);if(w.isWin&&a.blank(o.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return n.push(...t.DefaultPaths),s.uniq(n).filter(a.notBlank).join(r.delimiter)}function T(e){const n={};t.settingsForChildProcs().forEach(e=>e.maybeAddToEnv(n));const i=h.compactValues(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},o.env),{NODE_ENV:b.nodeEnv}),w.isElectron?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}),{PATH:t.pathWithDefaults()}),n),d.orElse(e,{})));return t.Settings.logStdout.deleteFromEnv(i),t.Settings.tailLogs.deleteFromEnv(i),i}t.Settings={libraryPath:new E.MaybeStringSetting({name:"libraryPath",key:"PS_LIBRARY_PATH",alternateKeys:["PS_LIBRARY","PS_LIBRARY_DIR"],category:E.SettingCategories.System,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>b.isTest?"/home/test/Pictures":w.isDocker()?"/ps/library":m.App.getPath("pictures"),defaultValue:()=>w.isDocker()?"/ps/library":void 0,advanced:()=>!1}),pidfile:new E.MaybeStringSetting({name:"pidfile",key:"PIDFILE",category:E.SettingCategories.System,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),cacheDir:new E.StringSetting({name:"cacheDir",key:"PS_CACHE_DIR",category:E.SettingCategories.Logging,description:"Where would you like PhotoStructure's scratch file directory? This should be a fast, local disk with several gigabytes free.",exampleValue:()=>b.isTest?"/tmp/ps_cache_dir":v.cacheDir(),defaultValue:()=>v.cacheDir()}),logLevel:new E.StringSetting({name:"logLevel",key:"PS_LOG_LEVEL",alternateKeys:["PS_LOG","LOG"],category:E.SettingCategories.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc')",defaultValue:()=>b.isProd?"error":"info"}),logDir:new E.StringSetting({name:"logDir",key:"PS_LOG_DIR",category:E.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>y.defaultLogDir(),exampleValue:()=>b.isTest?"/var/log/photostructure":void 0}),logCompression:new E.BooleanSetting({name:"logCompression",key:"PS_LOG_COMPRESS",category:E.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>b.isProd}),logElapsedMs:new E.BooleanSetting({name:"logElapsedMs",key:"PS_LOG_ELAPSED_MS",category:E.SettingCategories.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new E.BooleanSetting({name:"logWebRequests",key:"PS_LOG_WEB_REQUESTS",category:E.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new E.MaybeStringSetting({name:"logWebDir",key:"PS_LOG_WEB_DIR",category:E.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new E.BooleanSetting({name:"logStdout",key:"PS_LOG_STDOUT",alternateKeys:["LOG_STDOUT","PS_STDOUT"],category:E.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new E.BooleanSetting({name:"tailLogs",key:"PS_TAIL_LOGS",category:E.SettingCategories.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new E.BooleanSetting({name:"logColor",key:"PS_LOG_COLOR",category:E.SettingCategories.Logging,description:"Output all logs with terminal escape codes to colorize output.",defaultValue:!0}),maxBusyDbMs:new E.IntegerSetting({name:"maxBusyDbMs",key:"PS_MAX_BUSY_DB_MS",category:E.SettingCategories.System,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 1 minute, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>u.minuteMs}),dbTimeoutMs:new E.IntegerSetting({name:"dbTimeoutMs",key:"PS_DB_TIMEOUT_MS",category:E.SettingCategories.System,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Setting this too low will cause all database queries to fail.",defaultValue:()=>500}),probationMs:new E.IntegerSetting({name:"probationMs",key:"PS_PROBATION_MS",category:E.SettingCategories.System,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*u.minuteMs}),minTimeBetweenServiceRestartsMs:new E.IntegerSetting({name:"minTimeBetweenServiceRestartsMs",key:"PS_MIN_TIME_BETWEEN_SERVICE_RESTARTS_MS",category:E.SettingCategories.System,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*u.secondMs}),fatalErrorRatePerMinute:new E.IntegerSetting({name:"fatalErrorRatePerMinute",key:"PS_FATAL_ERROR_RATE_PER_MINUTE",category:E.SettingCategories.System,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),autoLaunch:new E.BooleanSetting({name:"autoLaunch",key:"PS_AUTO_LAUNCH",category:E.SettingCategories.System,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!w.isElectron}),minDiskFreeGb:new E.IntegerSetting({name:"minDiskFreeGb",key:"PS_MIN_DISK_FREE_GB",category:E.SettingCategories.System,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new E.BoundedIntegerSetting({name:"cpuLoadPercent",key:"PS_CPU_LOAD_PERCENT",category:E.SettingCategories.System,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new E.StringEnumSetting({name:"processPriority",key:"PS_PROCESS_PRIORITY",category:E.SettingCategories.System,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>M.PriorityClasses.BelowNormal,validValues:M.PriorityClasses.values}),maxMemoryMb:new E.BoundedIntegerSetting({name:"maxMemoryMb",key:"PS_MAX_MEMORY_MB",category:E.SettingCategories.System,description:"PhotoStructure will restart services if their process consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:512,max:8e3}),pollIntervalMs:new E.IntegerSetting({name:"pollIntervalMs",key:"PS_POLL_INTERVAL_MS",category:E.SettingCategories.System,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>b.isProd?u.minuteMs:5*u.secondMs}),copyAssetsToLibrary:new E.BooleanSetting({name:"copyAssetsToLibrary",key:"PS_COPY_ASSETS",category:E.SettingCategories.System,description:"Should PhotoStructure copy photos and videos to your PhotoStructure Library?",defaultValue:!0,advanced:()=>!1}),scanAllDrives:new E.BooleanSetting({name:"scanAllDrives",key:"PS_SCAN_ALL_DRIVES",category:E.SettingCategories.System,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new E.BooleanSetting({name:"scanMyPictures",key:"PS_SCAN_MY_PICTURES",category:E.SettingCategories.System,description:"Should PhotoStructure only scan your system's 'Pictures' folder for photos and videos?",defaultValue:!1,advanced:()=>!1}),scanPaths:new E.StringArraySetting({name:"scanPaths",key:"PS_SCAN_PATHS",category:E.SettingCategories.System,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`',advanced:()=>!1,exampleValue:()=>b.isTest?["/path/one","/path/two"]:[m.App.getPath("pictures")]}),neverIgnored:new E.StringArraySetting({name:"neverIgnored",key:"PS_NEVER_IGNORED",category:E.SettingCategories.System,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),forceLocalDbReplica:new E.BooleanSetting({name:"forceLocalDbReplica",key:"PS_FORCE_LOCAL_DB_REPLICA",category:E.SettingCategories.System,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:!1}),dbBackupsCount:new E.IntegerSetting({name:"dbBackupsCount",key:"PS_DB_BACKUPS_COUNT",category:E.SettingCategories.Db,description:"How many prior backups should PhotoStructure retain? Note that backups use a towers of hanoi algorithm to retain an assortment of both recent and older backups.",defaultValue:24}),dbMaintenanceIntervalMinutes:new E.BoundedFloatSetting({name:"dbMaintenanceIntervalMinutes",key:"PS_DB_MAINTENANCE_INTERVAL_MINUTES",category:E.SettingCategories.Db,description:"How many minutes should elapse between database maintenance runs? Maintenance (calling OPTIMIZE and VACUUM) is required to keep the database performant, but pauses all processes. Default period is every 10 minutes.",min:b.isTest?.2:1,max:60,defaultValue:()=>b.isTest?.2:10}),dbBackupIntervalMinutes:new E.BoundedIntegerSetting({name:"dbBackupIntervalMinutes",key:"PS_DB_BACKUP_INTERVAL_MINUTES",category:E.SettingCategories.Db,description:"How many minutes should elapse between backups of your library database? You want this to be frequent enough such that data loss isn't too painful, but backups pause sync and can cause the webserver to be momentarily unresponsive. Default is every 3 hours. Set to 0 to disable backups.",min:b.isTest?1:5,max:360,defaultValue:()=>b.isTest?1:180}),dbCacheSizeMb:new E.IntegerSetting({name:"dbCacheSizeMb",key:"PS_DB_CACHE_SIZE_MB",category:E.SettingCategories.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:128}),ffmpegPath:new E.StringSetting({name:"ffmpegPath",key:"PS_FFMPEG_PATH",category:E.SettingCategories.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc.',defaultValue:"ffmpeg"}),vlcPath:new E.StringSetting({name:"vlcPath",key:"PS_VLC_PATH",category:E.SettingCategories.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),updateChannel:new E.StringEnumSetting({name:"updateChannel",key:"PS_UPDATE_CHANNEL",category:E.SettingCategories.Updates,description:'TL:DR; keep this on "latest." This controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds will not have been thoroughly tested. Please only consider changing this if customer support asks you to.',defaultValue:()=>S.channel(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new E.BooleanSetting({name:"updateOnLaunch",key:"PS_UPDATE_ON_LAUNCH",category:E.SettingCategories.Updates,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new E.IntegerSetting({name:"updateCheckMinutes",key:"PS_UPDATE_CHECK_MINUTES",category:E.SettingCategories.Updates,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:1440}),bounceMinutes:new E.IntegerSetting({name:"bounceMinutes",key:"PS_BOUNCE_MINUTES",category:E.SettingCategories.Updates,description:"PhotoStructure will bounce the web and sync processes periodically. The default is every 5 hours. Set to -1 to disable.",defaultValue:300}),email:new E.MaybeStringSetting({name:"email",key:"PS_EMAIL",category:E.SettingCategories.Reporting,description:"If set, this email will be added to error reports, so we can contact you to help debug the issue. It is not required.",exampleValue:()=>"email@example.com",advanced:()=>!1}),chatWidget:new E.BooleanSetting({name:"chatWidget",key:"PS_CHAT_WIDGET",category:E.SettingCategories.Reporting,description:"If you want to disable the chat widget on the about page for privacy concerns, set this to false. Defaults to true (enabled).",defaultValue:!0,advanced:()=>!1}),reportErrors:new E.BooleanSetting({name:"reportErrors",key:"PS_REPORT_ERRORS",category:E.SettingCategories.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new E.IntegerSetting({name:"maxErrorsPerDay",key:"PS_MAX_ERRORS_PER_DAY",category:E.SettingCategories.Reporting,description:"Set this to zero to remove all bugs in PhotoStructure.\n\nHUR HUR #DADJOKE\n\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3}),inspect:new E.BooleanSetting({name:"inspect",key:"PS_INSPECT",category:E.SettingCategories.System,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,advanced:()=>!0}),rpcPort:new E.IntegerSetting({name:"rpcPort",key:"PS_RPC_PORT",category:E.SettingCategories.Web,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),httpPort:new E.IntegerSetting({name:"httpPort",key:"PS_HTTP_PORT",category:E.SettingCategories.Web,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),sessionTimeoutHours:new E.BoundedIntegerSetting({name:"sessionTimeoutHours",key:"PS_SESSION_TIMEOUT_HOURS",category:E.SettingCategories.Web,description:"How long should unused HTTP sessions exist before requiring visitors to log back in? This defaults to 180 days, just to maximize convenience.",defaultValue:4320,max:8760,min:1}),exposeNetworkWithoutAuth:new E.BooleanSetting({name:"exposeNetworkWithoutAuth",key:"PS_EXPOSE_NETWORK_WITHOUT_AUTH",category:E.SettingCategories.Web,description:"Normally the web service is bound to loopback, so your PhotoStructure library is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network (if they know your PhotoStructure port). You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n\n**Don't enable this unless you know what you are doing.**",defaultValue:()=>w.isDocker()}),verifyFileCopies:new E.BooleanSetting({name:"verifyFileCopies",key:"PS_VERIFY_FILE_COPIES",category:E.SettingCategories.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new E.StringSetting({name:"assetSubdirectoryDatestampFormat",key:"PS_ASSET_SUBDIR_FORMAT",category:E.SettingCategories.Sync,description:"If you chose to copy assets into your library, they will be copied into <library directory>/<result of this pattern>/<original imagename>.\nSee <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.",defaultValue:"y/y-MM-dd"}),validateJpegImages:new E.BooleanSetting({name:"validateJpegImages",key:"PS_VALIDATE_JPEG_IMAGES",category:E.SettingCategories.Sync,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1}),validateRawImages:new E.BooleanSetting({name:"validateRawImages",key:"PS_VALIDATE_RAW_IMAGES",category:E.SettingCategories.Sync,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1}),validateVideos:new E.BooleanSetting({name:"validateVideos",key:"PS_VALIDATE_VIDEOS",category:E.SettingCategories.Sync,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!b.isTest,advanced:()=>!1}),transcodeVideos:new E.BooleanSetting({name:"transcodeVideos",key:"PS_TRANSCODE_VIDEOS",category:E.SettingCategories.Sync,description:"Should videos be transcoded during import? FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),doNotTranscodeMimetypes:new E.StringArraySetting({name:"doNotTranscodeMimetypes",key:"PS_DO_NOT_TRANSCODE_MIMETYPES",category:E.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "[\'video/quicktime\',\'video/mp4\']").',defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),statTimeoutSeconds:new E.BoundedIntegerSetting({name:"statTimeoutSeconds",key:"PS_STAT_TIMEOUT_SECONDS",category:E.SettingCategories.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new E.BooleanSetting({name:"startPaused",key:"PS_START_PAUSED",category:E.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray menu.",defaultValue:!1}),syncIntervalHours:new E.BoundedIntegerSetting({name:"syncIntervalHours",key:"PS_SYNC_INTERVAL_HOURS",category:E.SettingCategories.Sync,description:"This value controls both how often the sync process runs, and how often new files are discovered and imported. WARNING: Setting this value to a small value (say, less than 10) will mean PhotoStructure is constantly scanning your disks, which may reduce the lifespan of your storage media. Note that setting this and fileSyncIntervalHours to 0 will disable automatic scheduling of the sync process. This defaults to every day (to balance picking up new files automatically and trying to avoid unnecessary wear and tear on your storage media).",defaultValue:24,max:504,min:0}),fileSyncIntervalHours:new E.BoundedIntegerSetting({name:"fileSyncIntervalHours",key:"PS_FILE_SYNC_INTERVAL_HOURS",category:E.SettingCategories.Sync,description:"This value controls how often the files in your library are checked for changes. The `syncIntervalHours` setting, in contrast, controls how often *new* files are discovered. This defaults to every week (to try to balance picking up changes with wear and tear on your storage media)",defaultValue:168,max:1344,min:0}),rebuild:new E.BooleanSetting({name:"rebuild",key:"PS_REBUILD",category:E.SettingCategories.Sync,description:"When set, all files in your library will be re-imported (slow!)",defaultValue:!1,transient:!0}),forceSync:new E.BooleanSetting({name:"forceSync",key:"PS_FORCE_SYNC",category:E.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem",defaultValue:!1,transient:!0}),exitWhenDone:new E.BooleanSetting({name:"exitWhenDone",key:"PS_EXIT_WHEN_DONE",category:E.SettingCategories.Sync,description:"When set, the process will exit after jobs are completed",defaultValue:!1,transient:!0}),defaultSidecarType:new E.StringEnumSetting({name:"defaultSidecarType",key:"PS_DEFAULT_SIDECAR_TYPE",category:E.SettingCategories.Sync,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:P.SidecarExtsEnum.values}),writeMetadataToSidecarsIfImage:new E.BooleanSetting({name:"writeMetadataToSidecarsIfImage",key:"PS_WRITE_METADATA_TO_SIDECARS_IF_IMAGE",category:E.SettingCategories.Sync,description:"For non-video files, should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original?",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new E.BooleanSetting({name:"writeMetadataToSidecarsIfVideo",key:"PS_WRITE_METADATA_TO_SIDECARS_IF_VIDEO",category:E.SettingCategories.Sync,description:"For video files, should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original? This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new E.BooleanSetting({name:"overwriteOriginal",key:"PS_OVERWRITE_ORIGINAL",category:E.SettingCategories.Sync,description:"Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents.",defaultValue:!1}),useImageHashes:new E.BooleanSetting({name:"useImageHashes",key:"PS_USE_IMAGE_HASHES",category:E.SettingCategories.Sync,description:"Should image hashes be computed? This slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing",defaultValue:!0}),minImageCorrPct:new E.BoundedIntegerSetting({name:"minImageCorrPct",key:"PS_MIN_IMAGE_CORR_PCT",category:E.SettingCategories.Sync,description:"This is the minimum image hash correlation value for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 60% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>b.isTest?80:75,max:100,min:0}),minColorCorrPct:new E.BoundedIntegerSetting({name:"minColorCorrPct",key:"PS_MIN_COLOR_CORR_PCT",category:E.SettingCategories.Sync,description:"This is the minimum correlation found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 40% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>50,max:100,min:0}),skipAssetFileUpdates:new E.BooleanSetting({name:"skipAssetFileUpdates",key:"PS_SKIP_ASSET_FILE_UPDATES",category:E.SettingCategories.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests)",defaultValue:!1,transient:!0}),skipAssetUpdates:new E.BooleanSetting({name:"skipAssetUpdates",key:"PS_SKIP_ASSET_UPDATES",category:E.SettingCategories.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests)",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new E.BooleanSetting({name:"resyncAssetOnVisit",key:"PS_RESYNC_ASSET_ON_VISIT",category:E.SettingCategories.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>!!b.isTest||i.cpus().length>=8}),squareThumbStrategy:new E.StringEnumSetting({name:"squareThumbStrategy",key:"PS_SQUARE_THUMB_STRATEGY",category:E.SettingCategories.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new E.FloatSetting({name:"videoFrameAtSec",key:"PS_VIDEO_FRAME_AT_SEC",category:E.SettingCategories.Previews,description:"When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.\nNote that if a video is shorter than this value, the frame will be captured from the middle of the video.",defaultValue:1.5}),sharpen:new E.BooleanSetting({name:"sharpen",key:"PS_SHARPEN",category:E.SettingCategories.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new E.BooleanSetting({name:"progressive",key:"PS_PROGRESSIVE",category:E.SettingCategories.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new E.StringEnumsSetting({name:"previewResolutions",key:"PS_PREVIEW_RESOLUTIONS",category:E.SettingCategories.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:p.diff(l.FitSizeValues,["uhd8k","uhd5k","qqvga"]),validValues:l.FitSizeValues}),useEmbeddedPreviews:new E.BooleanSetting({name:"useEmbeddedPreviews",key:"PS_USE_EMBEDDED_PREVIEWS",category:E.SettingCategories.Previews,description:"Should embedded image previews be used when available? This speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.",defaultValue:!0}),useEmbeddedThumbnails:new E.BooleanSetting({name:"useEmbeddedThumbnails",key:"PS_USE_EMBEDDED_THUMBNAILS",category:E.SettingCategories.Previews,description:"Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.",defaultValue:!0}),requireMakeModel:new E.BooleanSetting({name:"requireMakeModel",key:"PS_REQUIRE_MAKE_MODEL",category:E.SettingCategories.Filters,description:"Normally PhotoStructure requires images to have an EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!0}),minImageDimension:new E.IntegerSetting({name:"minImageDimension",key:"PS_MIN_IMAGE_DIMENSION",category:E.SettingCategories.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new E.IntegerSetting({name:"minVideoDimension",key:"PS_MIN_VIDEO_DIMENSION",category:E.SettingCategories.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minAssetSizeBytes:new E.IntegerSetting({name:"minAssetSizeBytes",key:"PS_MIN_ASSET_SIZE_BYTES",alternateKeys:["PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:E.SettingCategories.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*f.KB}),maxFileSizeBytes:new E.IntegerSetting({name:"maxFileSizeBytes",key:"PS_MAX_ASSET_SIZE",category:E.SettingCategories.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library)",defaultValue:.5*f.GB}),tagCamera:new E.BooleanSetting({name:"tagCamera",key:"PS_TAG_CAMERA",category:E.SettingCategories.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new E.BooleanSetting({name:"tagLens",key:"PS_TAG_LENS",category:E.SettingCategories.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagDate:new E.StringEnumSetting({name:"tagDate",key:"PS_TAG_YMD",category:E.SettingCategories.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["","y","ym","ymd"]}),tagKeywordsFromPath:new E.BooleanSetting({name:"tagKeywordsFromPath",key:"PS_TAG_KEYWORDS_FROM_PATH",category:E.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new E.BooleanSetting({name:"tagKeywordsFromMetadata",key:"PS_TAG_KEYWORDS_FROM_METADATA",category:E.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new E.StringSetting({name:"keywordDelimiters",key:"PS_KEYWORD_DELIMITERS",category:E.SettingCategories.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be\n    interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new E.StringSetting({name:"keywordPathSeparators",key:"PS_KEYWORD_PATH_SEPARATORS",category:E.SettingCategories.Tagging,description:'PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "ObjectsâToolsâHammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don\'t want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.',defaultValue:"/|>â»â"}),tagType:new E.BooleanSetting({name:"tagType",key:"PS_TAG_TYPE",category:E.SettingCategories.Tagging,description:'Should assets be tagged with their filetype (like "Type/Image/JPEG")?',defaultValue:!0})},t.envSuggestedDirsKey="SUGGESTED_DIRS",t.envSkipFiltersKey="PS_SKIP_FILTERS",t.envSkipFilters=g.isTrue(o.env[t.envSkipFiltersKey]),t.DefaultPaths=Object.freeze(w.isWin?[o.env.SYSTEMROOT,r.join(o.env.SYSTEMROOT,"System32"),r.join(o.env.SYSTEMROOT,"System32","webm")]:["/usr/local/sbin","/usr/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),t.withDefaultPaths=x,t.pathWithDefaults=c.lazy(()=>x(o.env.PATH)),t.persistedSystemSettings=c.lazy(()=>h.values(t.Settings).filter(e=>!e.transient&&E.SystemCategories.includes(e.category))),t.persistedLibrarySettings=c.lazy(()=>h.values(t.Settings).filter(e=>!e.transient&&E.LibraryCategories.includes(e.category))),t.settingsForChildProcs=c.lazy(()=>h.values(t.Settings).filter(e=>e.hasValue())),t.psenv=function(){const e=h.values(t.Settings).map(e=>e.key);return h.sortedKeys(h.filter(o.env,t=>"nodeEnv"===t||e.includes(t)))},t.childEnv=T,t.spawnOptions=function(e){const t=d.orElse(e,{});return Object.assign(Object.assign({},t),{env:T(t.env),detached:!1,shell:!1})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stripEmoji=t.stripDiacritics=t.sortNatural=t.sortNaturalBy=t.joinEng=t.zipStrings=t.escapeRegExp=t.wbrPath=t.stripQuotes=t.dumbquote=t.stripAnsiEsc=t.longestPrefix=t.sortChars=t.localeSort=t.reverse=t.includesIgnoreCase=t.startsWithIgnoreCase=t.equalsIgnoreCase=t.capitalize=t.gist=t.ellipsize=t.stripPreSuff=t.stripSuffix=t.stripPrefixIgnoreCase=t.stripPrefix=t.removeCapture=t.splitWith=t.splitKeep=t.splitEvery=t.splitFirst=t.trim=t.mapParse=t.maybeToS=t.replaceAll=t.count=t.contains=t.padReplace=t.pad2=t.rightPad=t.leftPad=t.padding=t.isString=void 0;const i=n(1),r=n(3),o=n(0),s=n(5),a=n(7),u=n(13),l=n(201);var c=n(97);Object.defineProperty(t,"ensurePrefix",{enumerable:!0,get:function(){return c.ensurePrefix}}),Object.defineProperty(t,"ensureSuffix",{enumerable:!0,get:function(){return c.ensureSuffix}}),Object.defineProperty(t,"newlineRe",{enumerable:!0,get:function(){return c.newlineRe}}),Object.defineProperty(t,"wrap",{enumerable:!0,get:function(){return c.wrap}}),t.isString=function(e){return"string"==typeof e};const d={};function h(e,t){if(t<1)return"";for(null==d[e]&&(d[e]=e);t>d[e].length;)d[e]+=e;return d[e].substring(0,t)}function f(e,t,n){if(0===n.length)throw new Error("leftPad() given empty pad");if("number"==typeof e&&e<0)return"-"+f(String(-e),t-1,n);const i=String(e);return h(n,t-i.length)+i}function m(e,t){const n=[];let i,r=0;for(;null!=(i=t.exec(e));)i.index===t.lastIndex?t.lastIndex++:(n.push(e.substring(r,i.index)),n.push(i[0]),r=t.lastIndex=i[0].length+i.index);return r<e.length&&n.push(e.substring(r)),n}function p(e){return e.sort((e,t)=>e.valueOf().localeCompare(t.valueOf()))}t.padding=h,t.leftPad=f,t.rightPad=function(e,t,n){if(0===n.length)throw new Error("rightPad() given empty pad");const i=String(e);return i+h(n,t-i.length)},t.pad2=function(e){return f(e,2,"0")},t.padReplace=function(e,t,n,i){return e.substr(0,t)+h(i,n)+e.substr(t+n)},t.contains=function(e,t,n){return a.toS(e).indexOf(a.toS(t),n)>-1},t.count=function e(t,n,i=0){if(null==n||0===n.length)return 0;const r=t.indexOf(n,i);return-1===r?0:1+e(t,n,r+n.length)},t.replaceAll=function(e,t,n){return e.split(t).join(n)},t.maybeToS=function(e){return null==e?void 0:String(e)},t.mapParse=function(e,t){if(r.notBlank(e))try{return t(JSON.parse(e))}catch(e){}},t.trim=function(e){return e.map(a.toS).filter(e=>r.notBlank(e))},t.splitFirst=function(e,t){const n=e.indexOf(t);return-1===n?[e]:[e.slice(0,n),e.slice(n+t.length)]},t.splitEvery=function(e,t,n){const i=Math.min(Math.ceil(e.length/t),o.orElse(n,()=>e.length))-1;return i<=0?[e]:[...s.times(i,n=>e.slice(n*t,(n+1)*t)),e.slice(i*t)]},t.splitKeep=function(e,t,n=!0){const i=[];let r,o=0;for(;null!=(r=t.exec(e));)if(r.index===t.lastIndex)t.lastIndex++;else{t.lastIndex=r[0].length+r.index;const s=n?r.index:t.lastIndex;i.push(e.substring(o,s)),o=s}return o<e.length&&i.push(e.substring(o)),i},t.splitWith=m,t.removeCapture=function(e,t){const n=t.exec(e);if(null==n||null==n[1])return e;const i=n.index+n[0].length,r=i-n[1].length;return e.substr(0,r)+e.substr(i)},t.stripPrefix=function(e,t){const n=a.toS(e),i=a.toS(t);return i.length>0&&n.startsWith(i)?n.slice(i.length):n},t.stripPrefixIgnoreCase=function(e,t){const n=a.toS(e),i=a.toS(t);return i.length>0&&n.toLowerCase().startsWith(i.toLowerCase())?n.slice(i.length):n},t.stripSuffix=function(e,t){const n=a.toS(e),i=a.toS(t);return i.length>0&&n.endsWith(i)?n.slice(0,-i.length):n},t.stripPreSuff=function(e,t,n){return(e=a.toS(e)).endsWith(n)&&e.startsWith(t)?e.slice(t.length,-n.length):e},t.ellipsize=function(e,t=80){if(null==e)return"";const n=a.toS(e);return n.length<=t?n:n.slice(0,t-1)+"â¦"},t.gist=function(e,t=80,n=80){const i=a.toS(e),r=i.length-(t+n);return r<=0?i:i.slice(0,t).trim()+" â¦(+"+r+" chars)â¦"+i.slice(-n).trim()},t.capitalize=function(e){const t=(e=a.toS(e)).normalize().split("");return r.blank(e)?e:t[0].toLocaleUpperCase()+t.slice(1).join("")},t.equalsIgnoreCase=function(e,t){return null!=e&&null!=t&&a.toS(e).toLowerCase()===a.toS(t).toLowerCase()},t.startsWithIgnoreCase=function(e,t){return null!=e&&null!=t&&e.toLowerCase().normalize().startsWith(t.toLowerCase().normalize())},t.includesIgnoreCase=function(e,t){const n=a.toS(t).trim().toLowerCase().normalize();return!i.isEmpty(e)&&0!==n.length&&e.map(e=>a.toS(e).trim().toLowerCase().normalize()).filter(r.notBlank).some(e=>n.includes(e))},t.reverse=function(e){return null==e?e:e.split("").reverse().join("")},t.localeSort=p,t.sortChars=function(e){return p(e.split("")).join("")},t.longestPrefix=function(e,t){return u.greatestBy(t.filter(t=>e.startsWith(t)),e=>e.length)},t.stripAnsiEsc=function(e){return a.toS(e).replace(/\u001b\[[0-9;]+[a-z]/gi,"")};const g=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function v(e){return g.reduce((e,[t,n])=>e.replace(t,n),e).normalize()}t.dumbquote=v;const y=/^(['"]).+\1$/;function b(e,t=!0){return i.flatten(m(t?a.toS(e).toLowerCase():a.toS(e),/\S*\d*\S*/g).map(e=>m(e,/\d+/g))).filter(e=>null!=e&&e.length>0).map(e=>o.orElse(s.toInt(e),()=>e))}t.stripQuotes=function(e){return r.blank(e)||(e=a.toS(e).trim(),null!=y.exec(v(e))&&(e=e.slice(1,-1).trim())),e},t.wbrPath=function(e){return e.split(/(?<=[\\/_,:=-]+)/).map(e=>l.escape(e.normalize())).join("<wbr>")},t.escapeRegExp=function(e){return a.toS(e).replace(/[?.()[\]{}*^+|$]/g,"\\$&")},t.zipStrings=function(...e){let t="";const n=i.compactBlanks(e),r=Math.max(...n.map(e=>e.length));for(let e=0;e<r;e++)for(let i=0;i<n.length;i++)o.map(n[i],n=>o.map(n[e],e=>t+=e));return t},t.joinEng=function(e){return(e=i.compactBlanks(e)).length<2?e.join(""):e.slice(0,-1).join(", ")+" or "+e[e.length-1]},t.sortNaturalBy=b,t.sortNatural=function(e,t){return i.sortBy(e,e=>b(e,t))},t.stripDiacritics=function(e){return a.toS(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"")},t.stripEmoji=function(e){return a.toS(e).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstValueCaseInsensitive=t.maybeCall=t.allKeys=t.filter=t.sortedKeys=t.onlyReqValued=t.mapReqValued=t.reqValuedOrElse=t.isReqValued=t.without=t.pickFirst=t.pick=t.mapFields=t.compactValues=t.fromEntries=t.entries=t.values=t.emptyObj=t.keys=t.tap=void 0;const i=n(1),r=n(3),o=n(0),s=n(39),a=n(21);function u(e,t){return null!=t?t(e):"string"==typeof e?console.log(e):console.dir(e,{depth:3}),e}function l(e){return null==e||"object"!=typeof e?[]:Object.keys(e).filter(t=>"string"==typeof t&&(null==e.propertyIsEnumerable||!0===e.propertyIsEnumerable(t)))}function c(e){return l(e).map(t=>e[t])}function d(e){return l(e).map(t=>[t,e[t]])}function h(e,t={}){return"object"!=typeof t&&(t={}),i.compact(e).reduce((e,[t,n])=>u(e,()=>{null!=t&&null!=n&&(e[t]=n)}),t)}function f(e){return c(e).every(e=>null!=e)}t.tap=u,t.keys=l,t.emptyObj=function(e){return i.isEmpty(l(e))},t.values=c,t.entries=d,t.fromEntries=h,t.compactValues=function(e){if(null==e)return;const t=d(e).filter(([e,t])=>null!=e&&null!=t);return i.isEmpty(t)?void 0:h(t)},t.mapFields=function(e,t,n={}){return h(i.compact(d(e).sort(([e])=>e).map(([e,n])=>t(e,n))).filter(([e,t])=>null!=e&&null!=t),n)},t.pick=function(e,...t){if(null==e)return e;if(!t.every(e=>"string"==typeof e))throw new Error("bad keys: "+a.stringify(t));return i.isEmpty(t)?{}:t.reduce((t,n)=>u(t,()=>o.map(e[n],e=>t[n]=e)),{})},t.pickFirst=function(e,t,n=o.defined){if(null!=e)for(const i of t)if(n(e[i]))return e[i]},t.without=function(e,...t){if(null==e||t.every(t=>r.blank(e[t])))return e;const n=d(e).filter(([e])=>!t.includes(e));return i.isEmpty(n)?void 0:h(n)},t.isReqValued=f,t.reqValuedOrElse=function(e){return f(e)?e:void 0},t.mapReqValued=function(e,t){return f(e)?t(e):void 0},t.onlyReqValued=function(e){return e.filter(f)},t.sortedKeys=function(e){return h(i.sortBy(d(e),([e])=>e))},t.filter=function(e,t){return null==e?e:h(d(e).filter(([e,n])=>t(e,n)))},t.allKeys=function(e){const t=l(e);for(;null!=(e=Reflect.getPrototypeOf(e));)t.push(...Reflect.ownKeys(e).filter(e=>"string"==typeof e));return i.uniq(t)},t.maybeCall=function(e,t,...n){return null!=e&&s.isFunction(e[t])?e[t].bind(e)(...n):void 0},t.firstValueCaseInsensitive=function(e,t){if(r.blank(t))return;if(null!=e[t])return e[t];const n=t.toLocaleLowerCase().normalize();for(const t of l(e))if(n===t.toLocaleLowerCase().normalize()&&null!=e[t])return e[t]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onWriteRecentLogEntries=t.emitWriteRecentLogEntries=t.onVacuuming=t.emitVacuuming=t.onSettingsChanged=t.emitSettingsChanged=t.onVolumesChanged=t.emitVolumesChanged=t.onReadyToUpdate=t.emitReadyToUpdate=t.readyToUpdate=t.onRpcServerChange=t.emitRpcServerChange=t.onNonFatal=t.onFatal=t.onFocus=t.emitFocus=t.onFileChanged=t.emitFileCopied=t.onFileCopied=t.emitFileChanged=t.onResume=t.emitResume=t.onPause=t.emitPause=t.onMigration=t.emitMigration=t.onIdle=t.emitIdle=t.onClearCache=t.emitClearCache=t.useProductionEventEmitter=t.useTestEventEmitter=t.eventEmitter=void 0;const i=n(141),r=n(2),o=n(209),s=r.lazy(()=>new o.TestEventEmitter),a=r.lazy(()=>{const e=new i.EventEmitter;return e.setMaxListeners(50),e});t.eventEmitter=a(),t.useTestEventEmitter=function(){return t.eventEmitter=s()},t.useProductionEventEmitter=function(){return t.eventEmitter=a()},t.emitClearCache=function(){t.eventEmitter.emit("clearCache")},t.onClearCache=function(e){t.eventEmitter.on("clearCache",e)},t.emitIdle=function(){t.eventEmitter.emit("idle")},t.onIdle=function(e){t.eventEmitter.on("idle",e)},t.emitMigration=function(e){t.eventEmitter.emit("migration",e)},t.onMigration=function(e){t.eventEmitter.on("migration",e)},t.emitPause=function(){t.eventEmitter.emit("pause")},t.onPause=function(e){t.eventEmitter.on("pause",e)},t.emitResume=function(){t.eventEmitter.emit("resume")},t.onResume=function(e){t.eventEmitter.on("resume",e)},t.emitFileChanged=function(e){t.eventEmitter.emit("fileChanged",e)},t.onFileCopied=function(e){t.eventEmitter.on("fileCopied",e)},t.emitFileCopied=function(e,n){t.eventEmitter.emit("fileCopied",e,n)},t.onFileChanged=function(e){t.eventEmitter.on("fileChanged",e)},t.emitFocus=function(e,n){t.eventEmitter.emit("focus",e,n)},t.onFocus=function(e){t.eventEmitter.on("focus",e)},t.onFatal=function(e){t.eventEmitter.on("fatal",({message:t,error:n})=>e(t,n))},t.onNonFatal=function(e){t.eventEmitter.on("nonFatal",({message:t,error:n})=>e(t,n))},t.emitRpcServerChange=function(){t.eventEmitter.emit("rpcServerChange")},t.onRpcServerChange=function(e){t.eventEmitter.on("rpcServerChange",e)},t.readyToUpdate=!1,t.emitReadyToUpdate=function(){t.readyToUpdate=!0,t.eventEmitter.emit("readyToUpdate")},t.onReadyToUpdate=function(e){t.eventEmitter.on("readyToUpdate",e)},t.emitVolumesChanged=function(){t.eventEmitter.emit("volumesChanged")},t.onVolumesChanged=function(e){t.eventEmitter.on("volumesChanged",e)},t.emitSettingsChanged=function(){t.eventEmitter.emit("settingsChanged")},t.onSettingsChanged=function(e){t.eventEmitter.on("settingsChanged",e)},t.emitVacuuming=function(){t.eventEmitter.emit("settingsChanged")},t.onVacuuming=function(e){t.eventEmitter.on("vacuuming",e)},t.emitWriteRecentLogEntries=function(){t.eventEmitter.emit("writeRecentLogEntries")},t.onWriteRecentLogEntries=function(e){t.eventEmitter.on("writeRecentLogEntries",e)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.firstIndexNearest=t.everyAsync=t.someAsync=t.clusterAsync=t.clusterStrictAsync=t.contextFilter=t.batches=t.reverse=t.combinations=t.greatestBy=t.leastBy=t.greatestIndexBy=t.leastIndexBy=t.greatestIndex=t.max=t.leastIndex=t.min=t.ancestry=t.unzip=t.flatZip=t.zip=t.contextAround=t.retainFirstN=t.retainLastN=t.flatMap=t.toMapEntries=t.mapCompact=t.uniqCount=t.partition=t.uniqInPlace=t.removeFirst=t.eqlContents=t.diceCoeff=t.intersection=t.diff=t.moveIndexToEnd=t.moveToEnd=t.remove=t.concat=t.findLast=t.firstNonEmptyThunk=t.firstAsync=t.first=t.anyDefined=t.anyNotDefined=t.allNotBlank=t.allNotDefined=t.mapAll=t.mapAllDefined=t.allDefined=void 0;const r=n(34),o=n(1),s=n(3),a=n(21),u=n(0),l=n(5),c=n(11),d=n(39),h=n(42),f=n(46);function m(e){return u.defined(e)&&e.every(u.defined)}function p(e,...t){const n=e.length;return o.filterInPlace(e,e=>t.every(t=>!f.eql(e,t))),n!==e.length}t.allDefined=m,t.mapAllDefined=function(e,t){return m(e)?t(e):void 0},t.mapAll=function(e,t){return m(e)?t(e):void 0},t.allNotDefined=function(e){return null==e||e.every(e=>null==e)},t.allNotBlank=function(...e){return null!=e&&e.every(s.notBlank)},t.anyNotDefined=function(e){return null==e||e.some(e=>null==e)},t.anyDefined=function(e){return null!=e&&e.some(e=>null!=e)},t.first=function(e,t){if(null!=e)for(const n of o.compact(e)){const e=t(n);if(null!=e)return e}},t.firstAsync=function(e,t){return i(this,void 0,void 0,(function*(){if(null!=e){let n=-1;for(const i of e){n++;try{if(null==i)continue;const e=yield t(i,n);if(null!=e)return e}catch(e){}}}}))},t.firstNonEmptyThunk=function(...e){for(const t of e){const e=t();if(o.isNotEmpty(e))return e}},t.findLast=function(e,t){for(let n=e.length-1;n>=0;n--)if(t(e[n]))return e[n]},t.concat=function(...e){const t=[];for(const n of e)if(Array.isArray(n))for(const e of n)null!=e&&t.push(e);else null!=n&&t.push(n);return t},t.remove=p,t.moveToEnd=function(e,t){return p(e,t),e.push(t),e},t.moveIndexToEnd=function(e,t){const n=e[t];if(null==n)return e;e.push(n);for(let n=t;n<e.length-1;n++)e[n]=e[n+1];return e.length=e.length-1,e};const g=e=>{if(h.isPrimitive(e))return e;if(Array.isArray(e))return a.stringify(e);if(d.isFunction(e.valueOf))return e.valueOf();throw new Error("Cannot get primitive value for "+r.inspect(e))};function v(e,t,n=g){const i=new Set(t.map(n));return e.filter(e=>i.has(n(e)))}function y(...e){const t=Math.max(...e.map(e=>e.length));return l.times(t,t=>e.map(e=>e[t]))}function b(e){return w(e,e=>e.valueOf())}function S(e){return M(e,e=>e.valueOf())}function w(e,t){return P(e,t,(e,t)=>h.lt(e,t))}function M(e,t){return P(e,t,(e,t)=>h.gt(e,t))}function P(e,t,n){const i=e.map((e,n)=>({ea:e,index:n,v:u.map(e,t)})).filter(e=>null!=e&&null!=e.v);if(0===i.length)return-1;let r=0;for(let e=1;e<i.length;e++){const t=i[r].v;!0===n(i[e].v,t)&&(r=e)}return i[r].index}function E(e,t,n=!1){return i(this,void 0,void 0,(function*(){const i=[];e:for(const r of e){for(const e of i)if(n){if(yield T(e,e=>t(r,e))){e.push(r);continue e}}else if(yield x(e,e=>t(r,e))){e.push(r);continue e}i.push([r])}return i}))}function x(e,t){return i(this,void 0,void 0,(function*(){if(null!=e)for(let n=0;n<e.length;n++)if(yield t(e[n],n))return!0;return!1}))}function T(e,t){return i(this,void 0,void 0,(function*(){return o.isEmpty(e)||(yield Promise.all(e.map(t))).every(e=>e)}))}t.diff=function(e,t,n=g){const i=new Set(t.map(n));return e.filter(e=>!i.has(n(e)))},t.intersection=v,t.diceCoeff=function(e,t,n=g){return o.isEmpty(e)&&o.isEmpty(t)?1:2*v(e,t,n).length/(e.length+t.length)},t.eqlContents=function(e,t){return y(o.sort(e),o.sort(t)).every(([e,t])=>e===t)},t.removeFirst=function(e,t){const n=e.findIndex(t);return n>=0?e.splice(n,1)[0]:void 0},t.uniqInPlace=function(e,t=(e=>a.stringify(e))){o.copyArrayTo(o.uniqBy(e,t),e)},t.partition=function(e,t){const n=[],i=[];return e.forEach((e,r)=>(t(e,r)?n:i).push(e)),[n,i]},t.uniqCount=function(e){return function e(t){if(null==t||0===t.length)return[];const n=t[0],i=t.lastIndexOf(n);return[{t:n,count:i+1},...e(t.slice(i+1))]}(e.sort())},t.mapCompact=function(e,t){return o.compact(o.compact(e).map(t))},t.toMapEntries=function(e,t){return new Map(e.map(t).filter(u.defined))},t.flatMap=function(e,t){return e.reduce((e,n)=>e.concat(t(n)),[])},t.retainLastN=function(e,t){return e.length>t&&e.splice(0,e.length-t),e},t.retainFirstN=function(e,t){return e.length=Math.min(e.length,t),e},t.contextAround=function(e,t,n,i){const r=e.findIndex(i);if(-1!==r){return{before:0===r?[]:e.slice(Math.max(0,r-t),r),after:r===e.length-1?[]:e.slice(r+1,Math.min(r+1+n,e.length))}}},t.zip=y,t.flatZip=function(...e){const t=Math.max(...e.map(e=>e.length)),n=[];return l.times(t,t=>e.map(e=>n.push(e[t]))),n},t.unzip=function(e){return[e.map(([e])=>e),e.map(([,e])=>e)]},t.ancestry=function(e){return l.times(e.length,t=>e.slice(0,t+1))},t.min=function(e){return e[b(e)]},t.leastIndex=b,t.max=function(e){return e[S(e)]},t.greatestIndex=S,t.leastIndexBy=w,t.greatestIndexBy=M,t.leastBy=function(e,t){return e[w(e,t)]},t.greatestBy=function(e,t){return e[M(e,t)]},t.combinations=function*e(t,n){if(!(null==t||t.length<n))for(let i=0;i<t.length;i++)if(1===n)yield[t[i]];else for(const r of e(t.slice(i+1),n-1))yield[t[i],...r]},t.reverse=function(e){const t=[];for(let n=e.length-1;n>=0;n--)t.push(e[n]);return t},t.batches=function(e,t){return t<=0&&(t=1),o.stepRange(0,e.length,t,n=>e.slice(n,n+t))},t.contextFilter=function(e,t){let n;return e.filter((e,i)=>c.tap(t(e,i,n),t=>{t&&(n=e)}))},t.clusterStrictAsync=function(e,t){return i(this,void 0,void 0,(function*(){return E(e,t,!0)}))},t.clusterAsync=E,t.someAsync=x,t.everyAsync=T,t.firstIndexNearest=function({arr:e,fromIndex:t,pred:n,maxDelta:i}){for(let r=1;r<Math.min(i+1,e.length);r++){{const i=t-r;if(i>=0&&!0===u.map(e[i],e=>n(e,i)))return i}{const i=t+r;if(i<e.length&&n(e[i],i))return i}}}},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.platformName=t.procDeviceModel=t.isRaspberryPi=t.isDocker=t.isElectron=t.isPosix=t.isLinuxSnap=t.isLinuxAppImage=t.isLinux_arm=t.isArm=t.isLinux_x64=t.isLinux=t.isMac=t.isWinVm=t.isWinPortable=t.isWin=t.isPacked=t.inspectFlag=void 0;const i=n(47),r=n(50),o=n(19),s=n(3),a=n(2),u=n(0),l=n(7),c=n(22),d=r.platform();t.inspectFlag=o.argv.includes("--inspect")||c.isTrue(o.env.NODE_INSPECT),t.isPacked=!l.toS(e).includes("Platform"),t.isWin=d.startsWith("win"),t.isWinPortable=t.isWin&&s.notBlank(o.env.PORTABLE_EXECUTABLE_DIR),t.isWinVm=a.lazy(()=>t.isWin&&i.existsSync("C:\\Program Files\\Oracle\\VirtualBox Guest Additions")),t.isMac="darwin"===d,t.isLinux="linux"===d,t.isLinux_x64=t.isLinux&&"x64"===r.arch(),t.isArm="arm"===r.arch(),t.isLinux_arm=t.isLinux&&t.isArm,t.isLinuxAppImage=t.isLinux&&(s.notBlank(o.env.APPIMAGE)||s.notBlank(o.env.APPDIR)),t.isLinuxSnap=t.isLinux&&s.notBlank(o.env.SNAP_USER_DATA),t.isPosix=t.isMac||t.isLinux,t.isElectron=null!=o.versions.electron||c.isTrue(o.env.PS_IS_ELECTRON),t.isDocker=a.lazy(()=>{if(c.isTrue(o.env.PS_DOCKER))return!0;try{return!t.isElectron&&t.isLinux&&i.readFileSync("/proc/1/cgroup").toString().includes(":/docker/")}catch(e){return!1}}),t.isRaspberryPi=a.lazy(()=>t.isLinux_arm&&l.toS(t.procDeviceModel()).startsWith("Raspberry Pi")),t.procDeviceModel=a.lazy(()=>{try{return t.isLinux?u.map(i.readFileSync("/proc/device-tree/model"),l.toS):void 0}catch(e){return}}),t.platformName=t.isWin?"win":t.isMac?"mac":t.isLinux?"linux":d}).call(this,"/index.js")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toA=void 0;const i=n(90);t.toA=function(e){return null==e?[]:i.isIterable(e)?Array.from(e):Array.isArray(e)?e:[e]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.valuesToBigInt=t.hammRatioBigInt=t.hammingDistanceBigInt=t.Array2D=t.assertPositive=t.extractInt=t.extractFloat=t.within=t.mapGt0Or=t.mapGt0f=t.mapGt0=t.mapGte0f=t.mapGte0Or=t.mapGte0=t.firstNonZero=t.firstGt0=void 0;const i=n(1),r=n(3),o=n(0),s=n(5),a=n(10);function u(e,t){return s.mapInt(e,e=>e>=0?t(e):void 0)}function l(e,t){return s.mapInt(e,e=>e>0?t(e):void 0)}t.firstGt0=function(...e){return e.find(s.gt0)},t.firstNonZero=function(...e){for(const t of i.flatten(e)){const e=s.toFloat(t);if(null!=e&&0!==e)return e}},t.mapGte0=u,t.mapGte0Or=function(e,t,n){return o.orElse(u(e,t),n)},t.mapGte0f=function(e,t){return s.mapNumeric(e,e=>e>=0?t(e):void 0)},t.mapGt0=l,t.mapGt0f=function(e,t){return s.mapNumeric(e,e=>e>0?t(e):void 0)},t.mapGt0Or=function(e,t,n){return o.orElse(l(e,t),n)},t.within=function(e,t,n){return null!=n&&([e,t]=[Math.min(e,t),Math.max(e,t)],s.gte(n,e)&&s.lte(n,t))};const c=/[+-]?[0-9.]/;function d(e){if(s.isNumber(e))return e;if(r.blank(e))return;const t=String(e);return o.map(c.exec(t),e=>s.toFloat(t.substr(e.index)))}t.extractFloat=d,t.extractInt=function(e){return s.toInt(d(e))},t.assertPositive=function(e,t){if(null==t||t<=0)throw new Error(e+" must be positive")};function h(e,t){if(null==e||null==t)return;const n=[e,t].map(e=>e.toString(2)),i=Math.max(...n.map(e=>e.length));return n.map(e=>a.leftPad(e,i,"0"))}t.Array2D=class{constructor(e){this.columns=e,this.store=[]}get(e,t){return e<0||t<0?0:o.orElse(this.store[e*this.columns+t],()=>0)}set(e,t,n){this.store[e*this.columns+t]=n}},t.hammingDistanceBigInt=function(e,t){return o.map(h(e,t),([e,t])=>i.count(e.split(""),(e,n)=>e!==t.charAt(n)))},t.hammRatioBigInt=function(e,t){return null==e||null==t?0:o.map(h(e,t),([e,t])=>{const n=e.length;return i.count(e.split(""),(e,n)=>e===t.charAt(n))/n})},t.valuesToBigInt=function(e,t){return i.isEmpty(e)?BigInt(0):BigInt("0b0"+e.map(e=>a.leftPad(e.toString(2),t-1,"0")).join(""))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.endEndables=t.end=t.endAll=t.setEnding=t.ending=t.addEndable=t.addLoggerEndable=t.addPostDbEndable=t.addDbEndable=t.addPreDbEndable=t.addServiceEndable=t.addFirstEndable=t.EndableRanks=t.EndableWrapper=void 0;const r=n(1),o=n(4),s=n(2),a=n(0),u=n(36),l=n(75),c=n(6),d=n(100),h=n(28),f=n(16),m=n(25),p=n(8),g=n(64),v=s.lazy(()=>c.mkLogger(l.red("Endable")));t.EndableWrapper=class{constructor(e,t,n,i,r){this.name=e,this._isEnded=i,this.endTimeoutMs=r,this.onEnds=[],this._ended=!1,this.logger=c.mkLogger(e),this.onEnds.push(t),S(n,this)}get ended(){return a.mapOr(this._isEnded,e=>e(),()=>!1)||this._ended}end(){if(!this._ended)return this._ended=!0,p.awaitAll(this.onEnds.map(e=>e()))}};const y=new d.MultiMap;g.setUnrefInterval(()=>P(),1*o.minuteMs);const b=5*o.secondMs;function S(e,t){return y.add(e,t),t}t.EndableRanks=u.strEnum("first","service","predb","db","postdb","logger"),t.addFirstEndable=function(e){return S(t.EndableRanks.first,e)},t.addServiceEndable=function(e){return S(t.EndableRanks.service,e)},t.addPreDbEndable=function(e){return S(t.EndableRanks.predb,e)},t.addDbEndable=function(e){return S(t.EndableRanks.db,e)},t.addPostDbEndable=function(e){return S(t.EndableRanks.postdb,e)},t.addLoggerEndable=function(e){return S(t.EndableRanks.logger,e)},t.addEndable=S;let w=!1;function M(e,t){return i(this,void 0,void 0,(function*(){const n=yield e;if(null!=n&&!n.ended)return v().debug(l.magenta(n.name+" ending...")),p.thenOrTimeout(n.end(),f.firstGt0(t,n.endTimeoutMs,b),()=>v().warn(l.magenta(n.name+".end() timed out")),()=>v().debug(l.magenta(n.name+".end() completed"))).catch(e=>{m.Try(()=>v().warn(l.magenta(n.name+".end() rejected: ")+e))})}))}function P(){y.filterInPlace((e,t)=>!t.ended),v().debug("vacuumEndables()",y.entriesArray().map(([e,t])=>[e,t.map(e=>e.name)]))}t.ending=function(){return w},t.setEnding=function(e){if(!h.isTest)throw new Error("cannot set ending");w=e},t.endAll=function(...e){return Promise.all(e.map(e=>M(e)))},t.end=M,t.endEndables=s.lazy(()=>i(void 0,void 0,void 0,(function*(){const e=h.isSingleSpecTests?250:void 0;v().info("endEndables()",{isTest:h.isTest,isSingleSpecTests:h.isSingleSpecTests}),h.isTest||(w=!0),P();for(const n of t.EndableRanks.values){const t=a.orElse(y.get(n),[]);r.isNotEmpty(t)&&(v().debug(l.magenta("endEndables(): ending "+n)),yield Promise.all(t.map(t=>M(t,e))))}})))},function(e,t,n){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Opt=t.isOpt=t.Some=t.None=void 0,function(e){e.isDefined=!1,e.isEmpty=!0,e.get=()=>{},e.exists=()=>!1;const t=()=>e;e.map=t,e.flatMap=t,e.filter=t,e.forEach=t,e.getOrElse=e=>e(),e.orElse=e=>s(e()),e.zip1=t,e.zip2=t,e.zip3=t}(i||(i={})),t.None=i;class r{constructor(e){this.a=e,this.isDefined=!0,this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new r(e(this.a))}flatMap(e){const t=e(this.a);return o(t)?t:s(t)}filter(e){return s(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,t){return s(e).flatMap(e=>t(this.a,e))}zip2(e,t,n){return s(e).flatMap(e=>s(t).flatMap(t=>n(this.a,e,t)))}zip3(e,t,n,i){return s(e).flatMap(e=>s(t).flatMap(t=>s(n).flatMap(n=>i(this.a,e,t,n))))}}function o(e){return e instanceof r||e===t.None}function s(e){return o(e)?e:null!=e?new r(e):t.None}t.Some=r,t.isOpt=o,t.Opt=s},function(e,t){e.exports=require("process")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.execStdout=t.stdout=t.stdoutResult=t.execFile=t.spawn=t.niceable=t.endProcess=t.waitForExit=void 0;const r=n(156),o=n(19),s=n(54),a=n(59),u=n(3),l=n(4),c=n(32),d=n(21),h=n(2),f=n(0),m=n(5),p=n(11),g=n(39),v=n(7),y=n(58),b=n(8),S=n(24),w=n(62),M=n(6),P=n(25),E=n(101),x=n(14),T=n(143),O=n(9),F=n(10),_=h.lazy(()=>M.mkLogger("ChildProcess"));function D(e){return p.pick(e,"pid","killed","connected","exitCode","signalCode")}function C(e,t){return b.until(()=>b.thenNot(E.pidExists(e)),t)}function I(e,t=30*l.secondMs){return i(this,void 0,void 0,(function*(){if(null==e)return!1;const n=e.pid;if(_().debug("endProcess("+n+")",{killed:e.killed,connected:e.connected}),!e.killed){if(n<=0)return _().warn("endProcess(): asked to end invalid pid",D(e)),!1;if(n===o.pid)return _().warn("endProcess(): asked to end MY pid",D(e)),!1;P.Try(()=>e.kill())}return yield c.delay(250),yield w.closeStreams(e),e.connected&&P.Try(()=>e.disconnect()),P.Try(()=>e.unref()),(yield C(n,t))?(_().debug("endProcess(): exitted",D(e)),!0):(yield E.kill(n,!0).catch(e=>{_().warn("endProcess(): kill("+n+",true) failed: "+e)}),C(n,5e3))}))}function A(e,t){return"renice"!==e&&"which"!==e&&"where"!==e&&"sqlite3"!==e&&[e,...t].every(e=>!e.endsWith("web.js")&&!e.endsWith("db.js")&&!e.includes("sqlite3"))}function k(e,t,n,r){const a=new Date;let u=!1;e.on("exit",()=>u=!0);const c=A(t,n);return s.setTimeout(()=>i(this,void 0,void 0,(function*(){if(u)return;yield b.until(()=>m.gt0(e.pid),l.secondMs);const n=e.pid;return m.gt0(n)?(c&&(yield T.renice(n)),E.addPid({pid:n,cmd:t,maxAgeMs:r,ppid:o.pid},a)):void _().warn("newProc(): not writing pidfile, child_process has no pid",{cmd:t,cp:D(e)})})),x.isWin?500:250),e}function L(e,t,n,i){const o=O.spawnOptions(i);return k(r.execFile(e,t,o),e,t,n)}function B(e,t,n){return i(this,void 0,void 0,(function*(){return a.retryOnReject(()=>function(e,t,n){var r,o,a;return i(this,void 0,void 0,(function*(){const i=f.orElse(n.quiet,!1),u=f.orElse(n.ignoreStderr,!1),l=f.orElse(n.ignoreExitCode,!1);let c="";_().debug("stdoutResult(): execFile",{cmd:e,args:t});const h=yield L(e,t,n.timeout,p.without(n,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(!0===n.disconnect)return h.disconnect(),{result:"",pid:h.pid};const m=d.stringify({cmd:e,args:t}),b=new y.Deferred(m);s.setTimeout(()=>{b.pending&&_().warn("stdoutResult(): SLOW COMMAND",{cmd:e,args:t})},n.timeout/3).unref(),b.setTimeout(n.timeout);const M=(r,o)=>{S.isIgnorableError(o)||g.isFunction(n.isIgnorableError)&&n.isIgnorableError(o)?_().debug("stdoutResult(): ignorable error for "+r,{cmd:e,args:t,opts:n,error:o}):(null!=h.pid&&I(h),i||_().warn("stdoutResult(): "+r,{cmd:e,args:t,opts:n,error:o}),b.pending&&b.reject(o))};try{h.on("error",e=>M("on(error)",e)),h.on("close",n=>{const r=Date.now()-b.start,o=0!==n?"warn":"debug";i||_().log(o,"stdoutResult(): on(close)",{cmd:e,code:n,args:t,elapsedMs:r,result:F.gist(c,160,160)}),l||0===n?b.resolve({result:c,code:n,pid:h.pid}):b.reject(new Error("non-zero exit code: "+d.stringify({code:n,cmd:e,args:t})))}),w.end(h.stdin),null===(r=h.stdout)||void 0===r||r.on("data",e=>f.map(e,e=>{c+=e.toString()})),null===(o=h.stderr)||void 0===o||o.on("error",e=>M("stderr(error)",e)),null===(a=h.stderr)||void 0===a||a.on("data",e=>u?_().warn("stdoutResult(): stderr(data): "+v.toS(e)):M("stderr(data)",e))}catch(e){M("try/catch",e)}return yield b.promise}))}(e,t,n),{timeoutMs:n.timeout,maxRetries:f.orElse(n.maxRetries,3),onRetryWaitUntil:e=>c.delay(100*e),errorIsRetriable:n=>_().tap({msg:"stdoutResult.errorIsRetriable()",result:S.errorContains(n,/EPERM/),meta:{error:n,cmd:e,args:t}})})}))}t.waitForExit=C,t.endProcess=I,t.niceable=A,t.spawn=function(e,t,n,i){const o=O.spawnOptions(i);return _().debug("spawn()",{command:e,args:t,maxAgeMs:n,opts:o}),k(r.spawn(e,t,o),e,t,n)},t.execFile=L,t.stdoutResult=B,t.stdout=function(e,t,n){return B(e,t,n).then(e=>e.result)},t.execStdout=function(e){return new Promise((t,n)=>{r.exec(e,(e,i,r)=>null!=e?n(e):u.notBlank(r)?n(r):t(i))})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringify=void 0;const i=n(0);t.stringify=function(e,t,n,r){return JSON.stringify(e,function(e,t){const n=[],i=[],r=null!=t?t:(e,t)=>n[0]===t?"[Circular ~]":"[Circular ~."+i.slice(0,n.indexOf(t)).join(".")+"]";return function(t,o){if(n.length>0){const e=n.indexOf(this);e>=0?(n.splice(e+1),i.splice(e,1/0,t)):(n.push(this),i.push(t)),n.indexOf(o)>=0&&(o=r.call(this,t,o))}else n.push(o);return null==e?o:e.call(this,t,o)}}(t,r),i.denull(n))}},function(e,t,n){"use strict";function i(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e)return!0;const t=String(e).toLowerCase();return["true","1"].includes(t)}function r(e){if("boolean"==typeof e)return!e;if(null==e)return!1;if(0===e)return!0;const t=String(e).toLowerCase();return["false","0"].includes(t)}Object.defineProperty(t,"__esModule",{value:!0}),t.mapTrue=t.mapBoolean=t.and=t.or=t.isFalse=t.boolToInt=t.toBoolean=t.isTrue=t.isBoolean=void 0,t.isBoolean=function(e){return"boolean"==typeof e},t.isTrue=i,t.toBoolean=function(e){return!!i(e)||!r(e)&&void 0},t.boolToInt=function(e){return i(e)?1:0},t.isFalse=r,t.or=function(e){return e.some(e=>i(e))},t.and=function(e){return e.every(e=>i(e))},t.mapBoolean=function(e,t){return i(e)?t(!0):r(e)?t(!1):void 0},t.mapTrue=function(e,t){return i(e)?t():void 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeyedLazyVolumeOpts=t.MinIoRate=t.LongTtlMs=t.CmdTimeoutMs=t.LongMountpointsTtlMs=t.MountpointsTtlMs=void 0;const i=n(4),r=n(35);t.MountpointsTtlMs=15*i.secondMs,t.LongMountpointsTtlMs=5*i.minuteMs,t.CmdTimeoutMs=35*i.secondMs,t.LongTtlMs=1*i.hourMs,t.MinIoRate=i.secondMs/(2*r.MiB),t.KeyedLazyVolumeOpts={maxRetries:2,keyTtlMs:t.MountpointsTtlMs,timeoutMs:t.CmdTimeoutMs,priorResultTtlMs:t.LongTtlMs}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addMessage=t.onError=t.cleanError=t.errorToHumanString=t.trimErrorMessage=t.stack=t.throws=t.isIgnorableError=t.isDoNotSendError=t.isPleaseSendError=t.isRetriableError=t.isFatalErrorAllowed=t.isSqliteDisconnectedError=t.isSqliteBusyError=t.isFatalError=t.FatalErrorRe=t.errorContains=t.isHealthCheckError=t.hasErrorFlag=t.extractErrorFlags=t.removeErrorFlags=t.mapError=t.ifError=t.ErrorFlags=t.RetriableErrorFlag=t.DoNotSendErrorFlag=t.HealthCheckErrorFlag=t.PleaseSendErrorFlag=t.IgnorableErrorFlag=t.NonRetriableErrorFlag=t.FatalErrorFlag=void 0;const i=n(1),r=n(3),o=n(4),s=n(37),a=n(2),u=n(0),l=n(5),c=n(7),d=n(17),h=n(22),f=n(208),m=n(12),p=n(6),g=n(93),v=n(29),y=n(9),b=n(10),S=n(52),w=Date.now(),M=a.lazy(()=>p.mkLogger("Error")),P=new g.Rate(o.minuteMs),E=new g.Rate(o.minuteMs);t.FatalErrorFlag="Â¹",t.NonRetriableErrorFlag="Â²",t.IgnorableErrorFlag="Â³",t.PleaseSendErrorFlag="â´",t.HealthCheckErrorFlag="âµ",t.DoNotSendErrorFlag="â¶",t.RetriableErrorFlag="â·",t.ErrorFlags=[t.FatalErrorFlag,t.NonRetriableErrorFlag,t.IgnorableErrorFlag,t.PleaseSendErrorFlag,t.HealthCheckErrorFlag];const x=/[â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g,T=/[^â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g;function O(e){return e.replace(x,"")}function F(e){return e.replace(T,"")}function _(e){return null!=e&&(!!(e instanceof S.WrappedError&&e.fatal)||null!=t.FatalErrorRe.exec(s.errorToS(e)))}function D(){const e=Date.now()>w+y.Settings.probationMs.valueOrDefault,t=l.lt(E.eventsPerMinute,y.Settings.fatalErrorRatePerMinute.valueOrDefault);return M().tap({level:"info",msg:"isFatalErrorAllowed()",result:v.isMainService()&&e&&t,meta:{mainService:v.isMainService(),postProbation:e,lowErrorRate:t,fatalErrorRatePerMin:E.eventsPerMinute,errorRatePerMin:P.eventsPerMinute,fatalErrorRatePerMinuteSetting:y.Settings.fatalErrorRatePerMinute.valueOrDefault}})}function C(e){return s.errorToS(e).includes(t.PleaseSendErrorFlag)}t.ifError=function(e){return e instanceof Error?e:void 0},t.mapError=function(e,t){return e instanceof Error?t(e):void 0},t.removeErrorFlags=O,t.extractErrorFlags=F,t.hasErrorFlag=function(e){return t.ErrorFlags.some(t=>e.includes(t))},t.isHealthCheckError=function(e){return s.errorToS(e).includes(t.HealthCheckErrorFlag)},t.errorContains=function(e,t){return null!=t.exec(s.errorToS(e))},t.FatalErrorRe=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+t.FatalErrorFlag,"i"),t.isFatalError=_,t.isSqliteBusyError=function(e){return"SQLITE_BUSY"===e.code||s.errorToS(e).toUpperCase().includes("SQLITE_BUSY")},t.isSqliteDisconnectedError=function(e){return s.errorToS(e).toLowerCase().includes("database connection is not open")},t.isFatalErrorAllowed=D,t.isRetriableError=function(e){return!_(e)&&!s.errorToS(e).includes(t.NonRetriableErrorFlag)&&(!(e instanceof S.WrappedError)||e.retriable)},t.isPleaseSendError=C,t.isDoNotSendError=function(e){const n=s.errorToS(e);return n.includes(t.DoNotSendErrorFlag)||A(n)};const I=[t.IgnorableErrorFlag,"Warning:","Can't set headers after they are sent","0 output files created","Missing expected status message","Format error in file","Unexpected error while trimming. Try to lower the tolerance","called while not idle","onExit(exit) called end()","end() called before task completed","BatchCluster has ended, cannot enqueue","diskutil: interrupted","net::ERR_","ECONNRESET","This socket has been ended by the other party","debugger listening on","for help","https://nodejs.org/en/docs/inspector","debugger attached"].map(e=>e.toLowerCase());function A(e){const t=s.errorToS(e).toLowerCase(),n=I.some(e=>t.includes(e));return M().tap({msg:"isIgnorableError",result:d.ending()||!C(e)&&!_(e)&&n,meta:{err:s.errorToS(e),ending:d.ending(),isPleaseSend:C(e),isFatal:_(e),matchesIgnorable:n}})}t.isIgnorableError=A,t.throws=function(e){try{return e(),!1}catch(e){return!0}},t.stack=function e(){const t={};return Error.captureStackTrace(t,e),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)};const k=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function L(e){let t=O(b.stripAnsiEsc(e)),n=t;do{n=t,t=k.reduce((e,t)=>e.replace(t,""),t).trim()}while(n!==t);return i.compactBlanks(t.split(/\s+/).map(e=>{if(e.startsWith("E")){const n=f.describeError(e);return t.toLowerCase().includes(n.toLowerCase())?"":n+":"}return e})).join(" ")}t.trimErrorMessage=L,t.errorToHumanString=function(e,t=200){const n=s.errorToS(e),i=F(n);return b.ellipsize(L(n),t-i.length)+i},t.cleanError=function(e,t){return c.toS(e).split(/\r?\n/).map(e=>b.stripPrefix(e,t)).map(e=>e.replace(/: ?/,"")).filter(r.notBlank).join(", ")},t.onError=function(e,t,n){const i=s.errorToS(e)+s.errorToS(t)+s.errorToS(n),r=_(t)||_(i)||h.isTrue(null==n?void 0:n.fatal);if(!r&&A(i))return void M().info("onError(): ignorable: "+s.errorToS(t),Object.assign({message:e},n));u.map(p.currentFileLogger(),e=>e.writeRecentLogEntries()),P.onEvent(),r&&E.onEvent();const o=!r||D()?"nonFatal":"fatal";M().log("fatal"===o?"error":"warn","onError()",Object.assign({event:o,message:e,error:t},u.orElse(n,{}))),d.ending()||m.eventEmitter.emit(o,{message:e,error:t})},t.addMessage=function(e,t){return r.notBlank(t)&&(e.message.toLowerCase().includes(t.toLowerCase())||(e.message+=": "+t)),e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlSubset=t.mapEntries=t.pickMap=t.assignFields=t.assignMissingPrimitives=t.spread=t.primitiveEntries=t.hasKeys=t.ctor=t.identity=t.tryEach=t.Try=t.mapOrThrow=t.mapAnd=t.ornull=t.firstFieldLike=t.firstDefinedField=t.firstDefined=t.firstTrueThunk=t.firstThunk=t.definedThunks=void 0;const i=n(1),r=n(0),o=n(11),s=n(42),a=n(13),u=n(27),l=n(46);function c(e,t){try{return e()}catch(e){return null!=t?t(e):void 0}}function d(e){return o.keys(e).filter(t=>s.isPrimitive(e[t])||u.isDate(e[t])).map(t=>[t,e[t]])}t.definedThunks=function(...e){return e.every(e=>r.defined(e()))},t.firstThunk=function(...e){for(const t of e){const e=t();if(null!=e)return e}},t.firstTrueThunk=function(e,t){for(const n of e){const e=n();if(null!=e&&(null==t||t(e)))return e}},t.firstDefined=function(...e){return e.find(r.defined)},t.firstDefinedField=function(e,...t){return r.map(t.find(t=>null!=e[t]),t=>e[t])},t.firstFieldLike=function(e,t){return a.first(o.keys(e),n=>t(n,e[n])?e[n]:void 0)},t.ornull=function(e){return void 0===e?null:e},t.mapAnd=function(e,t){return null!=e&&t(e)},t.mapOrThrow=function(e,t,n){if(null!=e)return t(e);throw new Error(n)},t.Try=c,t.tryEach=function(e,t){[...e].forEach(e=>c(()=>t(e)))},t.identity=function(e){return e},t.ctor=function(e){return r.map(e.constructor,e=>e.name)},t.hasKeys=function(e){return Object.keys(e).some(t=>"string"==typeof t&&e.propertyIsEnumerable(t))},t.primitiveEntries=d,t.spread=function(e,...t){return Object.assign({},e,...i.compact(t))},t.assignMissingPrimitives=function(e,t){if(null==t)return e;for(const[n,i]of d(t))null==e[n]&&(e[n]=i);return e},t.assignFields=function(e,t){if(null==t)return e;for(const[n,i]of o.entries(t))null!=i&&(e[n]=i);return e},t.pickMap=function(e,t,n){const i={};for(const r of t)i[r]=n(r,e[r]);return i},t.mapEntries=function(e,t){const n={};for(const i of o.keys(e))r.map(t(i,e[i]),e=>n[i]=e);return n},t.eqlSubset=function(e,t){return null!=e&&o.keys(e).every(n=>l.eql(e[n],t[n]))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.until=t.PromiseStates=t.isPromise=t.thenTap=t.thenCollect=t.thenMap=void 0;const r=n(4),o=n(32),s=n(21),a=n(0),u=n(5),l=n(36),c=n(15);t.thenMap=function(e,t){return i(this,void 0,void 0,(function*(){const n=yield e;return null==n?void 0:t(n)}))},t.thenCollect=function(e,t){return i(this,void 0,void 0,(function*(){const n=[];for(const i of c.toA(yield e))if(null!=i){const e=yield i;if(null!=e){const i=yield t(e);null!=i&&n.push(i)}}return n}))},t.thenTap=function(e,t=console.dir.bind(console)){return i(this,void 0,void 0,(function*(){const n=yield e;return yield t(n),n}))},t.isPromise=function(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch},t.PromiseStates=l.strEnum("pending","resolved","rejected"),t.until=function(e,t,n){return i(this,void 0,void 0,(function*(){const i=Date.now(),l=null==t?void 0:t+i,c=a.orElse(n,()=>a.orElse(t,30*r.secondMs)/10),d=u.clamp(100,10*r.secondMs,c);for(;null==l||Date.now()<l;){const t=yield e();if(!0===t)return!0;if(null!=t&&!1!==t)throw new Error("f must return a boolean, but returned "+s.stringify(t));yield o.delay(d)}return!1}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.localPlusMs=t.tsToLocal=t.localToTs=t.localToDateTime=t.localToDateObject=t.isoToPrecisionMs=t.isoToLocal=t.dateTimeToLocalSec=t.dateTimeToLocal=t.agoLocal=t.nowLocal=t.isoToDateTime=t.MaxTzOffsetHours=t.pwshJsonDate=t.wmiDate=t.fmtDateShort=t.isoNow=t.fmtDateIso=t.fmtDateTime=t.fmtDuration=t.durationHMS=t.durationToPaddedHMS=t.fmtMs=t.filestampUTC=t.filestamp=t.datestampUTC=t.datestamp=t.thenElapsed=t.elapsedAsync=t.elapsed=t.isRecentMs=t.recent=t.closeTo=t.ago=t.unixtime=t.cmpDate=t.isDate=void 0;const r=n(74),o=n(1),s=n(3),a=n(4),u=n(55),l=n(0),c=n(5),d=n(18),h=n(42),f=n(35),m=n(116),p=n(53),g=n(16),v=n(25),y=n(10);function b(e){return e instanceof Date}function S(e,t=5*a.secondMs){return c.gt0(e)&&Date.now()-e<=t}function w(e,t,n){return e<1?void 0:f.plur(e,t,n)}function M(e,t=2,n){if(!c.gte0(e))return c.isNumber(e)?"-"+M(Math.abs(e),t):"";const i=[w(Math.floor(e/a.dayMs),"day","days"),w(Math.floor(e/a.hourMs)%24,"hour","hours"),w(Math.floor(e/a.minuteMs)%60,"minute","minutes"),w(Math.floor(e/a.secondMs)%60,"second","seconds")],r=i.findIndex(e=>null!=e),s=o.compact(i.slice(r,r+t));return o.isEmpty(s)?"":null!=n&&1===s.length&&s[0].startsWith("1 ")?s[0]+" "+n.plural:s.join(", ")+l.mapOr(n,e=>" "+e.singular,()=>"")}t.isDate=b,t.cmpDate=function(e,t){const n=l.mapOr(e,e=>e.getTime(),()=>0),i=l.mapOr(t,e=>e.getTime(),()=>0);return h.cmp(n,i)},t.unixtime=function(e){const t=b(e)?e.getTime():c.isNumber(e)?e:Date.now();return Math.floor(t/a.secondMs)},t.ago=function(e,t){return new Date(l.orElse(t,new Date).getTime()-e)},t.closeTo=function(e,t,n){return null!=e&&null!=t&&Math.abs(e.getTime()-t.getTime())<=n},t.recent=function(e,t=5*a.secondMs){return S(l.map(e,e=>p.datedToMillis(e)),t)},t.isRecentMs=S,t.elapsed=function(e){const t=Date.now(),n=e();return{elapsedMs:Date.now()-t,result:n}},t.elapsedAsync=function(e){return i(this,void 0,void 0,(function*(){const t=Date.now(),n=yield e();return{elapsedMs:Date.now()-t,result:n}}))},t.thenElapsed=function(e){return i(this,void 0,void 0,(function*(){const t=Date.now(),n=yield e;return{elapsedMs:Date.now()-t,result:n}}))},t.datestamp=function(e=new Date){return e.getFullYear()+"-"+y.pad2(e.getMonth()+1)+"-"+y.pad2(e.getDate())},t.datestampUTC=function(e=new Date){return e.getUTCFullYear()+"-"+y.pad2(e.getUTCMonth()+1)+"-"+y.pad2(e.getUTCDate())},t.filestamp=function(e=new Date){return[e.getFullYear(),y.pad2(e.getMonth()+1),y.pad2(e.getDate()),"-",y.pad2(e.getHours()),y.pad2(e.getMinutes()),y.pad2(e.getSeconds())].join("")},t.filestampUTC=function(e=new Date){return[e.getUTCFullYear(),y.pad2(e.getUTCMonth()+1),y.pad2(e.getUTCDate()),"-",y.pad2(e.getUTCHours()),y.pad2(e.getUTCMinutes()),y.pad2(e.getUTCSeconds())].join("")},t.fmtMs=function(e,t=2){return e<10*a.secondMs?Number(e).toLocaleString()+"ms":M(e,t)},t.durationToPaddedHMS=function(e){return r.Duration.fromMillis(e).toFormat("hhhh:mm:ss.SSS")},t.durationHMS=function(e){return r.Duration.fromMillis(c.round(e/a.secondMs)*a.secondMs).toFormat("h:mm:ss")},t.fmtDuration=M;const P=new Map;function E(e,t,n=r.DateTime.DATETIME_MED){return p.mapValidDate(e,e=>(s.mapNotBlank(t,t=>e=e.setLocale(t)),e.toLocaleString(n)))}t.fmtDateTime=E,t.fmtDateIso=function(e,t,n=r.DateTime.DATETIME_MED){return d.Opt(r.DateTime.fromISO(e,{setZone:!0})).filter(p.validDate).orElse(()=>l.map(m.DateInterval.fromISO(e),e=>e.middle.toDateTime())).map(e=>E(e,t,n)).getOrElse(()=>e)},t.isoNow=function(){return(new Date).toISOString()},t.fmtDateShort=function(e,t="en-US"){return u.getOrSet(P,t,()=>new Intl.DateTimeFormat(t,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(p.datedToMillis(e))};const x=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;t.wmiDate=function(e){const t=x.exec(e);if(null==t)return;const n=t.slice(1,8).map(e=>c.toInt(e));if(!l.allDefined(n))return;const[i,r,o,s,u,d,h]=n,f=c.toInt(t[8],{defaultValue:0});return new Date(Date.UTC(i,r-1,o,s,u,d,h/1e3)-f*a.minuteMs)};const T=/Date\((\d+)\)/;function O(e){if(!s.blank(e))return d.Opt(r.DateTime.fromISO(y.removeCapture(e,I),{setZone:!0})).filter(e=>e.isValid).orElse(()=>l.map(m.DateInterval.fromISO(e),e=>e.middle.toDateTime())).get()}function F(e){return _(r.DateTime.local().plus(-e))}function _(e){return l.map(D(e),t=>100*t+C(e.millisecond))}function D(e){return null!=e&&e.isValid?c.toInt(e.toFormat("yMMddHHmmss")):void 0}function C(e){return Math.floor(e/10)}t.pwshJsonDate=function(e){return d.Opt(e).flatMap(e=>T.exec(e)).flatMap(e=>e[1]).flatMap(c.toInt).filter(e=>g.within(0,Date.now()+a.dayMs,e)).map(e=>new Date(e)).get()},t.MaxTzOffsetHours=14,t.isoToDateTime=O,t.nowLocal=function(){return F(0)},t.agoLocal=F,t.dateTimeToLocal=_,t.dateTimeToLocalSec=D;const I=/\.\d\d\d(\d+)/;t.isoToLocal=function(e){return l.map(O(e),_)};const A=/^\d{1,4}-\d{2}-\d{2}$/;function k(e,t){if(null==e||e<0)return;let n=e;const i=()=>{const e=n%100;return n=Math.floor(n/100),e},o=10*i(),s=i(),a=i(),u=i(),c=i(),d=i();return{year:n,month:d,day:c,hour:u,minute:a,second:s,millisecond:o,zone:l.map(t,e=>r.Info.normalizeZone(e))}}function L(e,t){return l.map(k(e,t),e=>r.DateTime.fromObject(e))}t.isoToPrecisionMs=function(e){return s.mapNotBlank(e,e=>v.firstThunk(()=>l.map(m.DateInterval.fromISO(e),e=>e.intervalMs),()=>d.Opt(e.match(A)).flatMap(()=>r.DateTime.fromISO(e)).filter(p.validDate).map(()=>a.dayMs).get(),()=>d.Opt(r.DateTime.fromISO(e)).filter(p.validDate).map(()=>0).get()))},t.localToDateObject=k,t.localToDateTime=L,t.localToTs=function(e,t){return l.map(L(e,t),e=>e.toMillis())},t.tsToLocal=function(e){const t=new Date(e);return c.toInt([t.getFullYear(),...[t.getMonth()+1,t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),C(t.getUTCMilliseconds())].map(y.pad2)].join(""))},t.localPlusMs=function(e,t){return _(L(e).plus(t))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.start=t.isSingleSpecTests=t.isProd=t.isTest=t.isDev=t.nodeEnv=t._nodeEnv=void 0;const i=n(19),r=n(7),o=n(22);function s(){switch(r.toS(i.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return i.argv.some(e=>e.endsWith("mocha")||e.endsWith(".spec.js"))?"test":"production"}}t._nodeEnv=s,t.nodeEnv=(()=>{const e=s();return i.env.NODE_ENV=e,e})(),t.isDev="development"===t.nodeEnv,t.isTest="test"===t.nodeEnv,t.isProd="production"===t.nodeEnv,t.isSingleSpecTests=t.isTest&&o.isTrue(i.env.SINGLE_SPEC_TESTS),t.start=Date.now()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isStatsDbMigrator=t.isStatsDbClient=t.isWelcomeService=t.isSyncFileService=t.isSyncService=t.isRpcClient=t.isRpcServer=t.isWebService=t.isMainService=t.colorProcessName=t.processName=t.maybeSetServiceName=t.setServiceName=t.serviceName=t.serviceShutdownTimeoutMs=t.title=t.StatsDbServices=t.WelcomeServices=t.RpcServices=t.serviceNameIndex=t.ServiceNames=void 0;const i=n(19),r=n(1),o=n(3),s=n(4),a=n(2),u=n(36),l=n(7),c=n(48),d=n(75),h=n(6),f=n(28);t.ServiceNames=u.strEnum("main","web","sync","sync-file","info","test","logcat","logtail","ls"),t.serviceNameIndex=function(e){const n=t.ServiceNames.indexOf(e);return n<0?t.ServiceNames.length+1:n},t.RpcServices=["main","test"],t.WelcomeServices=["main","web","test"],t.StatsDbServices=["sync","sync-file"],t.title=function(e){return c.App.getName()+" "+e},t.serviceShutdownTimeoutMs=function(e){switch(e){case"main":case"web":return s.minuteMs;case"sync":case"sync-file":default:return 10*s.secondMs}};let m="";function p(){if(o.blank(m))throw Error("serviceName() is unset");return m}function g(e){if(!f.isTest&&e!==m&&""!==m)throw new Error("Cannot set service name twice");m=e,t.processName.unset(),h.setupLogger()}t.serviceName=p,t.setServiceName=g,t.maybeSetServiceName=function(e){if(!f.isTest)throw new Error("Only used by tests");o.blank(m)&&g(e)};const v=a.lazy(()=>[{re:/sync-file/,f:d.cyan},{re:/sync/,f:d.blue},{re:/web/,f:d.green},{re:/db/,f:d.magenta},{re:/main/,f:d.yellow},{re:/test/,f:d.red}]);function y(){return t.RpcServices.includes(p())}function b(){return"sync"===m}t.processName=a.lazy(()=>r.compactBlanks([m,l.toS(i.pid)]).join("-")),t.colorProcessName=function(e){const t=v().find(t=>e.match(t.re));return null!=t?d.bgBlack(t.f(e)):e},t.isMainService=function(){return m===t.ServiceNames.main},t.isWebService=function(){return m===t.ServiceNames.web},t.isRpcServer=y,t.isRpcClient=function(){return!y()},t.isSyncService=b,t.isSyncFileService=function(){return"sync-file"===m},t.isWelcomeService=function(){return t.WelcomeServices.includes(p())},t.isStatsDbClient=function(){return t.StatsDbServices.includes(p())},t.isStatsDbMigrator=a.lazy(()=>b())},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstExistingDirectory=t.isDirectorySync=t.addNameSuffix=t.countFromName=t.nameWithoutCount=t.posixPathFromGrandparent=t.posixPathFrom=t.pathnames=t.containedByNativePath=t.containedBy=t.extname2=t.basename=t.parseNativePath=t.parsePosixPath=t.resolve=t.native2posix=t.posix2native=void 0;const i=n(47),r=n(31),o=n(3),s=n(0),a=n(5),u=n(7),l=n(13),c=n(14),d=n(10),h=r.posix;function f(e,t){if(r.sep===h.sep)return e;const n=o.notBlank(t)?r.sep+r.sep+t+r.sep:"",i=e.split(h.sep);return d.equalsIgnoreCase(i[0],t)&&i.unshift(),n+i.join(r.sep)}function m(e){return r.sep===h.sep||h.sep===r.sep?e:e.split(r.sep).join(h.sep)}t.posix2native=f,t.native2posix=m;const p=/^([A-Z]:)[\\/]?(.*)$/i;function g(...e){const t=r.join(...e);return r.resolve(c.isWin?function(e){const t=p.exec(e);return null!=t?t[1].toUpperCase()+"\\"+t[2]:e}(t):t)}t.resolve=g;const v=/(\.?.*?)(\.[a-z]{1,10}\.(?:gz|z|xz|bz2))$/i;function y(e){const t=r.parse(e),n=b(t.base),i=d.stripSuffix(t.base,n);return Object.assign(Object.assign({},t),{ext:n,name:i})}function b(e){const t=v.exec(e);return null!=t&&o.notBlank(t[2])?t[2]:r.extname(e)}function S(e){return d.stripPrefix(e,r.sep).split(r.sep)}t.parsePosixPath=function(e){return y(f(e))},t.parseNativePath=y,t.basename=function(e){return d.stripSuffix(e,b(e))},t.extname2=b,t.containedBy=function(e,t){return o.notBlank(e)&&o.notBlank(t)&&(e===t||e.startsWith(d.ensureSuffix(t,h.sep)))},t.containedByNativePath=function(e,t){return o.notBlank(e)&&o.notBlank(t)&&(e===t||e.startsWith(d.ensureSuffix(t,r.sep)))},t.pathnames=S,t.posixPathFrom=function(e,t){return e.nativePath===t.nativePath?"":d.stripPrefix(m(t.nativePath),d.ensureSuffix(m(e.nativePath),"/"))},t.posixPathFromGrandparent=function(e){return S(e).slice(-3).join("/")};const w=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function M(e){return!!o.notBlank(e)&&i.statSync(e).isDirectory()}t.nameWithoutCount=function(e){return s.mapOr(u.toS(e).match(w),e=>e[1],()=>e)},t.countFromName=function(e){return s.map(u.toS(e).match(w),e=>l.first([e[2],e[3]],a.toInt))},t.addNameSuffix=function(e,t){const n=b(e);return`${d.stripSuffix(e,n)}${t}${n}`},t.isDirectorySync=M,t.firstExistingDirectory=function(e){for(const t of e)if(o.notBlank(t)){const e=g(t);if(M(e))return e}}},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.later=t.delayUntil=t.delay=t.unrefDelay=void 0;const i=n(54),r=n(5);function o(e){return s(e,!1)}function s(e,t){return new Promise(n=>{if(e<=0)n();else{const r=i.setTimeout(()=>n(),Math.ceil(e+.5));t&&r.unref()}})}t.unrefDelay=function(e){return s(e,!0)},t.delay=o,t.delayUntil=function(e){const t=(r.gt0(e)?e:e.getTime())-Date.now();if(t<0){if(t>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-t+"ms")}return o(t).then(()=>t)},t.later=function(e,t=1){return i.setTimeout(e,Math.max(1,Math.ceil(t)))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PosixFile=t.coalesce=t.groupByMountpoint=void 0;const r=n(31),o=n(120),s=n(1),a=n(3),u=n(4),l=n(2),c=n(0),d=n(5),h=n(18),f=n(69),m=n(15),p=n(13),g=n(63),v=n(8),y=n(20),b=n(27),S=n(12),w=n(6),M=n(60),P=n(100),E=n(14),x=n(9),T=n(10),O=n(110),F=n(49),_=n(38),D=n(41),C=n(152),I=n(148),A=n(68),k=n(170),L=n(171),B=n(153),R=n(30),N=new C.FileCache;t.groupByMountpoint=function(e,t){return P.groupBy(e,e=>c.map(e.bestMountpoint(t),e=>e.nativePath))},t.coalesce=function(e,t){const n=P.groupBy(e,e=>c.map(e.bestMountpoint(t),e=>e.nativePath));return s.sortBy(s.flatten(m.toA(n.values()).map(e=>p.contextFilter(s.sort(e),(e,t,n)=>null==n||!e.isDescendantOf(n)))),e=>e.pathnames)};class j extends D.BaseFile{constructor(e,t){super(e,t),this.nativePath=e,this.pflog=l.lazy(()=>w.mkLogger("PosixFile("+this.nativePath+")")),this.uriObject=l.lazy(()=>I.file2voluri(this)),this.uri=l.lazy(()=>v.thenMap(this.uriObject(),e=>o.format(e))),this.fileuri=l.lazy(()=>I.file2fileuri(this)),this.mountpoint=l.lazy(()=>v.thenMap(_.mountpoints(),e=>this.bestMountpoint(e.map(e=>this.for(e))))),this.etag=l.lazy(()=>v.thenMap(this.stat(),e=>[e.size,e.mtime.getTime()].map(e=>M.Radix58.encode(e)).join("-"))),this.ignorable=l.lazy(()=>i(this,void 0,void 0,(function*(){return(yield this.isDirectory())?L.ignorableDirectory(this):L.ignorableFile(this)}))),this.hidden=l.lazy(()=>k.hidden(this)),this.isMountpoint=l.lazy(()=>i(this,void 0,void 0,(function*(){return(yield this.isDirectory())&&(yield v.thenMapOr(_.mountpoints(),e=>e.includes(this.nativePath),()=>!1))}))),this.sidecars=l.lazy(()=>i(this,void 0,void 0,(function*(){if(this.isSidecar())return[];const e=yield this.dirEntSiblings(e=>e.filter(e=>F.isSidecarExt(e.ext)&&(e.name===this.name||e.name===this.base||R.nameWithoutCount(e.name)===R.nameWithoutCount(this.name))));return v.sortByAsync(m.toA(e),e=>e.mtimeMs())}))),this.shaWithSidecars=l.lazy(()=>i(this,void 0,void 0,(function*(){const e=[this,...yield this.sidecars()].map(e=>e.nativePath);return(yield A.fileSha(s.sort(e))).toString("base64")})),D.BaseFile.attrTTL)}static for(e,t){if(a.blank(e))throw new Error("unexpectedly empty path");if(e instanceof j)return e;if(e instanceof D.BaseFile)return this.for(e.nativePath,t);if(I.isUri(e))throw new Error("use forUri");const n=N.get(e);if(null!=n)return n;const i=R.resolve(e);return N.getOrSet(i,()=>new j(i,t))}static forPosix(e){return this.for(e.replace(/\//g,r.sep))}static forUri(e,t){return v.thenMap(I.uri2file(e,t),e=>this.for(R.posix2native(e.posixPath,e.hostname)))}static forUriOrPath(e,t){return g.firstDefinedLater(()=>this.forUri(e),()=>this.for(t))}for(e,t){return j.for(e,t)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.ignorable.unset(),this.hidden.unset(),this.sidecars.unset(),this}bestMountpoint(e){return p.greatestBy(e.filter(e=>this.isDescendantOf(e)),e=>h.Opt(s.commonPrefixLength(this.pathnames,e.pathnames)).filter(t=>t>=e.pathnames.length).get())}isDeleted(e,t=_.mountpoints){return i(this,void 0,void 0,(function*(){if(yield this.exists())return!1;if(!this.nativePath.startsWith(e))return this.pflog().error("isDeleted("+e+"): INTERNAL ERROR: prefix doesn't match",{result:!0}),!0;const n=yield t();if(s.isNotEmpty(n)&&(n.includes(e)||T.includesIgnoreCase(n,e)))return this.pflog().debug("isDeleted("+e+"): mountpoint exists but I don't.",{result:!0}),!0;for(const t of this.parents().filter(t=>t.nativePath.length>e.length))if(yield t.exists())return this.pflog().debug("isDeleted("+e+"): ancestor "+t+" exists but I don't.",{result:!0}),!0;return this.pflog().debug("isDeleted("+e+"): Can't say positively that I was deleted from my mountpoint.",{result:!1}),!1}))}httpHeaders(){return i(this,void 0,void 0,(function*(){return{ETag:yield this.etag(),"Last-Modified":yield this.lastModifiedUtc()}}))}hide(){return i(this,void 0,void 0,(function*(){const e=yield E.isWin?y.stdout("attrib",["+h",this.nativePath],{timeout:10*u.secondMs}).catch(e=>e):E.isMac?y.stdout("chflags",["hidden",this.nativePath],{timeout:10*u.secondMs}).catch(e=>e):"";return a.notBlank(e)?void this.pflog().warn("hide("+this.nativePath+") failed: "+e):this.clear()}))}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}mkNoMedia(){return this.join(".NoMedia").writeTxt("See <https://support.photostructure.com/no-media/>").then(()=>(S.emitFileChanged(this.nativePath),this)).catch(e=>{this.pflog().warn("Could not add .NoMedia file to "+this,e)})}hasNoMedia(){return i(this,void 0,void 0,(function*(){return B.hasNoMedia(yield this.directoryEntry())}))}ignorableCheap(){return L.ignorablePath(this.nativePath)}isSidecar(){return F.isSidecarExt(this.ext)}sidecar(){return i(this,void 0,void 0,(function*(){return f.thenOpt(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+F.asExt(x.Settings.defaultSidecarType.valueOrDefault).toLowerCase()))}))}jsonSidecar(){return i(this,void 0,void 0,(function*(){const e=yield this.dirEntSiblings(e=>e.filter(e=>T.equalsIgnoreCase(e.ext,".json")&&(e.name===this.name||e.name===this.base||R.nameWithoutCount(e.name)===R.nameWithoutCount(this.name)))),t=s.sortBy(m.toA(e),e=>-O.diceCoeff(this.name,e.name))[0];return this.pflog().debug("jsonSidecar(): "+t),t}))}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",()=>i(this,void 0,void 0,(function*(){const e=yield this.mtimeMs(),t=yield this.sidecars(),n=[e,...yield Promise.all(m.toA(t).map(e=>e.mtimeMs()))].filter(d.gt0);return s.mapNotEmpty(n,e=>Math.floor(Math.max(...e)))})))}thisOrSidecareMaxMtimeSec(){return v.thenMap(this.thisOrSidecareMaxMtimeMs(),e=>b.unixtime(e))}}t.PosixFile=j},function(e,t){e.exports=require("util")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.plur=t.pixels2size=t.SizeDescriptions=t.megapixels=t.MP=t.fmtMebi=t.fmtBytes=t.TiB=t.GiB=t.MiB=t.KiB=t.TB=t.GB=t.MB=t.KB=t.fmt=void 0;const i=n(5),r=n(36),o=new Intl.NumberFormat;function s(e){return o.format(e)}t.fmt=s,t.KB=1e3,t.MB=1e3*t.KB,t.GB=1e3*t.MB,t.TB=1e3*t.GB,t.KiB=1024,t.MiB=1024*t.KiB,t.GiB=1024*t.MiB,t.TiB=1024*t.GiB;const a=["B","KB","MB","GB","TB","PB"],u=["B","KiB","MiB","GiB","TiB","PiB"];t.fmtBytes=function(e,t=3){const n=Math.floor(Math.log10(e)),r=Math.floor(n/3),o=Math.pow(10,3*r),s=a[r];return i.sigFigs(e/o,t)+" "+s},t.fmtMebi=function(e,t=3){const n=Math.floor(Math.log2(e)),r=Math.floor(n/10),o=Math.pow(2,10*r),s=u[r];return i.sigFigs(e/o,t)+" "+s},t.MP=1e6,t.megapixels=function(e){return i.sigFigs(e/t.MP,2)},t.SizeDescriptions=r.strEnum("tiny","small","medium","large","original"),t.pixels2size=function(e){return e<76800?"tiny":e<345600?"small":e<2073600?"medium":"large"},t.plur=function(e,t,n=t+"s"){return s(e)+" "+(1===e?t:n)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.strEnum=void 0;const i=n(45);t.strEnum=function(...e){const t=Object.freeze(e),n={};for(const e of t)n[e]=e;const r=e=>null!=e&&t.includes(e);return Object.assign(Object.assign({},n),{values:t,length:t.length,has:r,indexOf:e=>null==e?-1:t.indexOf(e),validOrElse:(e,t)=>r(e)?e:i.tot(t),map:(e,t)=>r(e)?t(e):void 0})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isError=t.asError=t.errorToVerbose=t.errorToS=void 0;const i=n(1),r=n(3),o=n(0),s=n(7);function a(e){return e instanceof Error?i.compactBlanks([e.name,o.map(e.code,e=>"code "+e),e.message]).join(": "):s.toS(e)}t.errorToS=a,t.errorToVerbose=function(e){const t=a(e),n=s.toS(e.stack).split("\n").slice(0,6);return t!==n[0]&&n.unshift(t),n.join("\n")},t.asError=function(e){if(r.blank(e))throw new Error("undefined error");if(e instanceof Error)return e;if(Array.isArray(e)){const t=e[0];return t instanceof Error?(e.length>1&&(t.errors=e.slice(1)),t):new Error(e.map(e=>s.toS(e)).filter(r.notBlank).join(", "))}return new Error(s.toS(e))},t.isError=function(e){return"object"==typeof e&&e instanceof Error}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.findmntPoll=t.gioMountMonitor=t.diskUtilActivity=t.mountsCacheKey=t.mountpoints=t.localMountpointSetup=t.setRpcMountpointsImpl=t.nonRpcMountpoints=void 0;const r=n(1),o=n(59),s=n(4),a=n(32),u=n(2),l=n(17),c=n(63),d=n(8),h=n(20),f=n(192),m=n(236),p=n(24),g=n(12),v=n(6),y=n(14),b=n(29),S=n(121),w=n(238),M=n(239),P=n(23);let E;t.nonRpcMountpoints=()=>y.isWin?M.mountpointsWin():w.mountpointsPosix(),t.setRpcMountpointsImpl=function(e){E=e,t.localMountpointSetup()},t.localMountpointSetup=u.lazy(()=>i(void 0,void 0,void 0,(function*(){b.isRpcServer()?a.later(()=>i(void 0,void 0,void 0,(function*(){const e=v.mkLogger("Mountpoints.localMountpointSetup()");y.isMac?(e.info("Setting up Mac diskutil activity watcher"),t.mountpoints.setTTL(P.LongMountpointsTtlMs),t.diskUtilActivity()):y.isLinux&&((yield S.isGioSupported())?(e.info("Setting up Linux gio mount monitor"),t.mountpoints.setTTL(P.LongMountpointsTtlMs),t.gioMountMonitor()):(yield x())&&(e.info("Setting up Linux findmnt mount monitor"),t.mountpoints.setTTL(P.LongMountpointsTtlMs),t.findmntPoll()))})),30*s.secondMs).unref():yield d.awaitAll([l.end(t.diskUtilActivity.clear()),l.end(t.gioMountMonitor.clear()),l.end(t.findmntPoll.clear())])}))),t.mountpoints=u.lazy(()=>i(void 0,void 0,void 0,(function*(){return yield o.retryOnReject(()=>c.firstDefinedLater(E,t.nonRpcMountpoints),{maxRetries:3,onRetryWaitUntil:e=>a.delay(1500*e)}).catch(e=>{p.onError("mountpoints() failed",e)})})),P.MountpointsTtlMs),g.onClearCache(()=>t.mountpoints.unset()),t.mountsCacheKey=()=>i(void 0,void 0,void 0,(function*(){return d.thenMap(t.mountpoints(),e=>r.sort(e).join(":"))})),t.diskUtilActivity=u.lazy(()=>f.mkBasicWatchedChild({cmd:"diskutil",args:["activity"],onStdout:m.debounce(()=>t.mountpoints.unset(),1.5*s.secondMs)})),t.gioMountMonitor=u.lazy(()=>f.mkBasicWatchedChild({cmd:S.GioCommand,args:S.GioMountMonitorArgs,onStdout:m.debounce(()=>{S.gioVolumes.unset(),S.mtabEntries.unset(),t.mountpoints.unset()},1.5*s.secondMs)}));const x=u.lazy(()=>i(void 0,void 0,void 0,(function*(){if(!y.isLinux)return!1;try{return 0===(yield h.stdoutResult("findmnt",["--version"],{timeout:P.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}})));t.findmntPoll=u.lazy(()=>f.mkBasicWatchedChild({cmd:"findmnt",args:["--poll"],onStdout:m.debounce(()=>t.mountpoints.unset(),1.5*s.secondMs)}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.objectType=t.isObject=t.isFunction=t.isSymbol=t.ObjectType=void 0;const i=n(90),r=n(42);var o;function s(e){return"symbol"==typeof e}function a(e){return"function"==typeof e}function u(e){return null==e?o.Empty:s(e)?o.Symbol:r.isPrimitive(e)?o.Primitive:Array.isArray(e)?o.Array:i.isIterable(e)?o.Iterable:a(e)?o.Function:"object"==typeof e?e.constructor&&"Object"===e.constructor.name?o.Object:o.Instance:o.Unknown}!function(e){e[e.Empty=0]="Empty",e[e.Primitive=1]="Primitive",e[e.Symbol=2]="Symbol",e[e.Object=3]="Object",e[e.Array=4]="Array",e[e.Iterable=5]="Iterable",e[e.Instance=6]="Instance",e[e.Function=7]="Function",e[e.Unknown=8]="Unknown"}(o=t.ObjectType||(t.ObjectType={})),t.isSymbol=s,t.isFunction=a,t.isObject=function(e){return u(e)===o.Object},t.objectType=u},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.parseTags=t.readRawTags=t.writeTags=t.deleteAllTags=t.moveOriginal=t.sizeInfo=t.isMimetype=t.readRotation=t.mimetype=t.capturedAt=t.cachedTags=t.readTags=t.sidecarEql=t.clearTagsCache=t.rawTagsCache=t.extractBinaryTag=t.shutdownExiftool=t.exiftoolVersionMaybe=t.exiftoolVersion=t.exiftool=void 0;const r=n(98),o=n(31),s=n(1),a=n(3),u=n(4),l=n(37),c=n(76),d=n(2),h=n(0),f=n(11),m=n(15),p=n(7),g=n(48),v=n(17),y=n(63),b=n(8),S=n(70),w=n(157),M=n(56),P=n(27),E=n(46),x=n(12),T=n(176),O=n(33),F=n(177),_=n(178),D=n(220),C=n(118),I=n(81),A=n(6),k=n(14),L=n(9),B=n(23),R=n(67),N=n(136),j=n(221),V=n(305),z=n(49),W=n(306),q=n(226),U=n(227),G=n(129),H=n(134),K=n(194),J=n(307),$=d.lazy(()=>A.mkLogger("ExifTags")),Y=d.lazy(()=>{const e=R.maxCpus()>4?2:1;return w.observeBatchCluster(new r.ExifTool({maxProcs:e,maxIdleMsPerProcess:u.minuteMs,cleanupChildProcs:!1}),"exiftool",v.EndableRanks.service).bc});function Q(){const e=Y();return e.ended?Y.refresh():e}t.exiftool=Q,t.exiftoolVersion=function(){return b.thenOrTimeout(Q().version(),B.CmdTimeoutMs,()=>{throw new Error("ExifTool timed out")})},t.exiftoolVersionMaybe=function(){return h.map(Y.prior(),e=>e.ended?void 0:b.thenOrTimeout(e.version(),B.CmdTimeoutMs,()=>{throw new Error("ExifTool timed out")}))},t.shutdownExiftool=function(e=!1){return h.map(Y.clear(),t=>t.end(e))},x.onFileCopied((e,t)=>b.thenMap(ne(e),e=>{const n=O.PosixFile.for(t);return X.getOrSet(n.nativePath,()=>Promise.resolve(Object.assign(Object.assign({},e),{SourceFile:n.nativePath,FileName:n.base,Directory:n.dir})))})),t.extractBinaryTag=function(e,t,n){return Q().extractBinaryTag(e,t,n)};const X=new M.BoundedMap(7*u.minuteMs,1024,!0);function Z(){X.clear(),t.rawTagsCache.clear()}t.rawTagsCache=new M.BoundedMap(7*u.minuteMs,1024,!0),t.clearTagsCache=Z,x.onClearCache(Z),x.onFileChanged(e=>{a.blank(e)?Z():(X.deleteIf(t=>t.startsWith(e)),t.rawTagsCache.deleteIf(t=>t.startsWith(e)))});const ee=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];function te(e){return i(this,void 0,void 0,(function*(){if(null==e)return;const t=O.PosixFile.for(e);return(yield t.isEmpty())?void 0:X.getOrSet(t.nativePath,()=>S.time("tags.readTags",()=>i(this,void 0,void 0,(function*(){return b.thenMap(se(t),e=>ce(t,e))}))))}))}function ne(e){return i(this,void 0,void 0,(function*(){return X.get(String(e))}))}function ie(e){return i(this,void 0,void 0,(function*(){if(a.blank(e))return;const n=O.PosixFile.for(e);return y.firstDefinedLater(()=>b.thenMap(t.rawTagsCache.get(n.nativePath),e=>e.MIMEType),()=>b.thenMap(ne(n),e=>e.MIMEType),()=>b.thenMap(T.readFileType(n.nativePath),e=>"image/tiff"===e.mime?void 0:e.mime),()=>z.isExifExt(n.ext)?b.thenMap(se(n,!1),e=>e.MIMEType):void 0)}))}function re(e,t){return i(this,void 0,void 0,(function*(){const n=O.PosixFile.for(e),i=null==t||a.blank(t.ImageHeight)?yield se(n):t;if(null==i)return;const r=h.orElse(G.extractRotation(t),()=>G.extractRotation(i)),o=_.dcrawSupportedMimetype(i.MIMEType)?yield D.rawInfo(n).catch(e=>{$().warn("Failed to read raw info",{file:n.nativePath,err:l.errorToS(e)})}):void 0,s=H.extractSizeInfo(i,r,o);return null!=s?s:I.isVideoMimeType(i.MIMEType)?b.thenMap(C.extractVideoFrame(n,i.MIMEType),e=>re(e,i)):void 0}))}function oe(e,t="_original"){return i(this,void 0,void 0,(function*(){return e.sibling(e.base+t).saveIfNewOrDelete(e.name+t+e.ext)}))}function se(e,t=!0){return S.time("tags.readRawTags",()=>i(this,void 0,void 0,(function*(){const n=O.PosixFile.for(e);if(!(yield n.isFile()))return;const r=yield le(n.nativePath);if(null==r||!t)return r;const o=[],a=b.thenMap(n.jsonSidecar(),e=>i(this,void 0,void 0,(function*(){const t=yield W.readJsonSidecar(e);return null!=t&&o.push(e.base),t}))),u=b.thenMap(n.sidecars(),e=>b.tuples(e,e=>le(e.nativePath)));let l=Object.assign(Object.assign({},r),yield a);for(const[e,t]of m.toA(yield u))o.push(t.base),l=Object.assign(Object.assign({},l),f.compactValues(f.without(e,...ee)));return s.isNotEmpty(o)&&(l.sidecars=o),l})))}t.sidecarEql=function(e,t){return i(this,void 0,void 0,(function*(){const n=e=>b.thenMap(se(e,!1),e=>f.without(e,...ee));return(yield E.eqlAsync(e.clear().sha(),t.clear().sha()))||(yield E.eqlAsync(n(e),n(t)))}))},t.readTags=te,t.cachedTags=ne,t.capturedAt=function(e){return i(this,void 0,void 0,(function*(){return b.thenMap(te(e),e=>e.capturedAt)}))},t.mimetype=ie,t.readRotation=function(e){return i(this,void 0,void 0,(function*(){return b.thenMap(se(e,!0),G.extractRotation)}))},t.isMimetype=function(e,t){return i(this,void 0,void 0,(function*(){const n=yield ie(e);return $().tap({msg:"isMimetype",meta:{path:p.toS(e),mimeType:n},result:null!=n&&t.has(n)})}))},t.sizeInfo=re,t.moveOriginal=oe,t.deleteAllTags=function(e){return i(this,void 0,void 0,(function*(){yield Q().deleteAllTags(e.nativePath),yield e.sibling(e.base+"_original").unlink("trace")}))},t.writeTags=function(e,t,n){return S.time("tags.writeTags",()=>i(this,void 0,void 0,(function*(){const i=yield e.sidecar(),r=I.isVideoMimeType(n),o=r&&L.Settings.writeMetadataToSidecarsIfVideo.valueOrDefault||!r&&L.Settings.writeMetadataToSidecarsIfImage.valueOrDefault||(yield i.exists())?i:e;yield Q().write(o.nativePath,t,L.Settings.overwriteOriginal.valueOrDefault?["-overwrite_original"]:void 0);const a=yield oe(o);return s.uniq([e.nativePath,o.nativePath]).forEach(x.emitFileChanged),e.clearThisAndParent(),o.clearThisAndParent(),{original:a,dest:o}})))},t.readRawTags=se;const ae=new c.Latch,ue=new c.Latch;function le(e){return i(this,void 0,void 0,(function*(){return t.rawTagsCache.getOrSet(e,()=>i(this,void 0,void 0,(function*(){$().debug("_readRawTags("+e+") not cached, reading now.");const t=ae.pending;t?ae.resolve():yield ue.promise;const n=z.isVideoExt(o.extname(e))?[]:void 0,i=yield b.thenOrTimeout(P.thenElapsed(Q().read(e,n).catch(t=>{$().info("Failed to read "+e,t)})),30*u.secondMs);return t&&ue.resolve(),h.map(i,t=>($().debug("_readRawTags("+e+") in "+t.elapsedMs+"ms"),h.map(t.result,e=>{const n=s.compactBlanks([e.Error,...h.orElse(e.errors,[]),e.Warning].map(p.toS));return s.isNotEmpty(n)&&(e.problems=n),e.exiftoolMs=t.elapsedMs,e})))})))}))}function ce(e,t){return i(this,void 0,void 0,(function*(){if(null==t)return;const n=t.MIMEType,i=e.nativePath;if(a.blank(n))return void $().debug("No mimetype for "+e);const r=e.nativePath.startsWith(g.App.cache())||e.pathnames.includes(".photostructure");r||(yield K.inferMakeAndModel(e,t));const o=t;o.originalMake=t.Make,o.originalModel=t.Model,t.Make=U.make(t.Make),t.Model=U.model(t.Make,t.Model);const s=q.extractLensMakeModel(t),u=yield N.extractCapturedAt(e,t,r);if(null==u)return void $().info("No capturedAt for "+e);const l=V.extractExposureSettings(t),c=yield re(e,t);if(null==c)return void $().info("No size info for "+i);const d=Object.assign(Object.assign(Object.assign(Object.assign({mimetype:n,exposureSettings:l},J.extractTitleDescription(o)),s),c),{duration:n.startsWith("video/")?j.extractDurationSec(t):void 0,capturedAt:u,geohash:F.geohashNumeric(t.GPSLatitude,t.GPSLongitude),tz:t.tz});return $().debug("parsedTags",Object.assign(Object.assign({nativePath:i},d),{tzSource:t.tzSource,capturedAt:h.map(u,e=>({date:e.date,src:e.src}))})),Object.assign(Object.assign({},o),d)}))}k.isWin||(ae.resolve(),ue.resolve()),t.parseTags=ce},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.execDir=t.BaseFile=t.DefaultEnsureNewOptions=t.WipPrefix=void 0;const r=n(47),o=n(65),s=n(74),a=n(31),u=n(175),l=n(34),c=n(105),d=n(1),h=n(59),f=n(3),m=n(4),p=n(32),g=n(21),v=n(2),y=n(0),b=n(18),S=n(97),w=n(15),M=n(7),P=n(35),E=n(13),x=n(58),T=n(123),O=n(8),F=n(44),_=n(70),D=n(20),C=n(27),I=n(46),A=n(12),k=n(53),L=n(6),B=n(51),R=n(25),N=n(14),j=n(43),V=n(9),z=n(10),W=n(110),q=n(49),U=n(23),G=n(83),H=n(125),K=n(152),J=n(68),$=n(30),Y=n(111),Q=n(112),X=n(102),Z=n(62),ee=n(146),te=r.promises;t.WipPrefix=N.isWin?"wip-":".",t.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});const ne=new K.FileCache;class ie{constructor(e,t){if(this.dirent=t,this.bflog=v.lazy(()=>L.mkLogger("BaseFile("+this.nativePath+")")),this.dirents=v.lazy(()=>i(this,void 0,void 0,(function*(){return O.thenMap(this.directoryEntry(),e=>e.children())}))),this.stat=v.lazy(()=>this.trap("stat",()=>te.stat(this.nativePath).catch(()=>{})),ie.attrTTL),this.statSync=v.lazy(()=>this.trapSync("statSync",()=>R.Try(()=>r.statSync(this.nativePath))),ie.attrTTL),this.executable=v.lazy(()=>this.access(r.constants.R_OK|r.constants.X_OK)),this.shaResult=v.lazy(()=>i(this,void 0,void 0,(function*(){const e=yield this.size();if(0===e||null==e)return;const t=e>5*P.MiB?new Y.PushProgressObserver({op:"Computing SHA of",path:this.nativePath},e):void 0,n=yield C.elapsedAsync(()=>this.trap("sha",()=>J.fileSha([this.nativePath],{observer:t}))),i=y.map(n.result,e=>e.toString("base64"));return{elapsedMs:n.elapsedMs,buffer:n.result,b64:i}})),ie.attrTTL),null!=t)this.nativePath=t.nativePath,this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext;else{this.nativePath=$.resolve(e),this.nativePath.startsWith("\\\\")&&(this.hostname=this.nativePath.split("\\")[2]);const t=$.parseNativePath(this.nativePath);this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext}this.posixPath=$.native2posix(this.nativePath),ne.set(e,this)}toJSON(){return{ctor:this.constructor.name,nativePath:this.nativePath}}[l.inspect.custom](){return this.toJSON()}static withFastestAccess(e){return i(this,void 0,void 0,(function*(){const t=d.compact(e),n=yield Promise.all(t.map(e=>e.shaMs()));return t[E.leastIndex(n)]}))}static forPosix(e){return e instanceof ie?e:this.for(z.replaceAll(e,"/",a.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,t){if(e instanceof ie)return e;const n=ne.get(e);if(null!=n)return n;const i=$.resolve(e);return ne.getOrSet(i,()=>new ie(i,t))}static clear(e){A.emitFileChanged(e)}for(e,t){return ie.for(e,t)}clear(){return this.dirent=void 0,this.dirents.unset(),this.stat.unset(),this.statSync.unset(),this.executable.unset(),this.shaResult.unset(),this}clearThisAndParent(){return A.emitFileChanged(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return null!=e&&(e instanceof ie?this.nativePath===e.nativePath:this.nativePath===ie.for(e).nativePath)}isExt(...e){return d.compactBlanks(e).map(e=>S.ensurePrefix(e,".").toLowerCase()).includes(M.toS(this.ext).toLowerCase())}get normalizedExt(){return q.normalizeExt(this.ext).toLowerCase()}get baseWithParent(){return(this.isRoot?"":this.parent().base)+"/"+this.base}get baseWithGrandparent(){return(this.isRoot?"":this.parent().baseWithParent)+"/"+this.base}posixPathFrom(e){return $.posixPathFrom(e,this)}directoryEntry(){return i(this,void 0,void 0,(function*(){if(null==this.dirent){const e=yield this.isFile(),t=yield this.isDirectory(),n=yield this.isSymbolicLink(),i={name:this.base,isFile:()=>e,isDirectory:()=>t,isSymbolicLink:()=>n};this.dirent=new H.DirectoryEntry(this.dir,i)}return this.dirent}))}_child(e){return this.for(a.join(this.nativePath,e.base),e)}childNames(){return O.thenMap(this.dirents(),e=>e.map(e=>e.base))}children(e){return i(this,void 0,void 0,(function*(){return O.thenMap(this.dirents(),t=>i(this,void 0,void 0,(function*(){return d.compact(yield F.withBoundedConcurrency({name:"BaseFile.children",laters:t.map(t=>()=>T.apply(this._child(t),e))}))})))}))}childFiles(e){return i(this,void 0,void 0,(function*(){const t=[];for(const n of w.toA(yield this.dirents()))if(n.isFile()){const i=this._child(n);(null==e||e(i))&&t.push(i)}return t}))}childDirectories(e){return i(this,void 0,void 0,(function*(){return O.thenMap(this.dirents(),t=>O.thenCompact(t.filter(e=>e.isDirectory()).map(t=>i(this,void 0,void 0,(function*(){return T.apply(this._child(t),e)})))))}))}childrenSync(){return y.orElse(this.trapSync("childrenSync",()=>r.readdirSync(this.nativePath).map(e=>this.join(e))),[])}hasChildren(e){return i(this,void 0,void 0,(function*(){const t=yield this.childNames();return d.isNotEmpty(e)?d.includesAll(t,e):d.isNotEmpty(t)}))}hasNoChildren(){return i(this,void 0,void 0,(function*(){return(yield this.isFile())||d.isEmpty(yield this.childNames())}))}visitDescendants(e){return i(this,void 0,void 0,(function*(){return O.thenMap(this.children(),t=>i(this,void 0,void 0,(function*(){for(const n of t)yield n.visitDescendants(e),yield e(n)})))}))}descendants(e){return i(this,void 0,void 0,(function*(){const t=[];for(const n of w.toA(yield this.childFiles()))(yield e(n))&&t.push(n);const n=yield this.childDirectories();if(null!=n){for(const i of n)yield O.thenMap(i.descendants(e),e=>t.push(...e));return t}}))}ancestorWithChildren(e){return i(this,void 0,void 0,(function*(){return(yield this.hasChildren(e))?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}))}siblings(){return i(this,void 0,void 0,(function*(){return O.thenMapOr(this.selfAndSiblings(),e=>e.filter(e=>!this.eql(e)),()=>[])}))}dirEntSiblings(e){return i(this,void 0,void 0,(function*(){return O.thenMap(this.parent().dirents(),t=>e(t).map(e=>this.parent()._child(e)))}))}selfAndSiblings(){return i(this,void 0,void 0,(function*(){return this.parent().children()}))}firstExistingSelfOrAncestor(){return i(this,void 0,void 0,(function*(){return this.isRoot||(yield this.exists())?this:this.parent().firstExistingSelfOrAncestor()}))}get pathnames(){return this.nativePath.split(a.sep).filter(e=>null!=e&&""!==e)}get pathnamesWithoutDrive(){return N.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(N.isWin?1:0)}get isRoot(){return this.pathnames.length===(N.isWin?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return null!=e&&d.startsWith(e.pathnames,this.pathnames)}isDescendantOf(e){return null!=e&&d.startsWith(this.pathnames,e.pathnames)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){const e=this.parent();return this.isRoot?[]:[...e.parents(),e]}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return d.isEmpty(e)?this:this.for(a.join(this.nativePath,...e))}joinYMD(e=new Date){return y.map3(k.getYear(e),k.getMonth(e),k.getDay(e),(e,t,n)=>this.join(M.toS(e),z.pad2(t),z.pad2(n)))}child(...e){return d.isEmpty(e)?this:this.join(...$.native2posix(a.join(...e)).split("/").filter(e=>".."!==e))}trap(e,t,n="warn"){return i(this,void 0,void 0,(function*(){try{return yield _.time("fs."+e,t)}catch(t){return void this.bflog().log(n,`trap: ${e}() failed: ${t}`)}}))}trapOr(e,t,n="warn"){return i(this,void 0,void 0,(function*(){try{return this.bflog().trace(`trapOr ${e}()`),yield t(),!0}catch(t){return this.bflog().log(n,`trapOr: ${e}() failed: ${t}`),!1}}))}trapSync(e,t){try{return this.bflog().trace(`trapSync ${e}()`),t()}catch(t){return void this.bflog().warn(`trapSync: ${e}() failed: ${t}`)}}exists(){return i(this,void 0,void 0,(function*(){return null!=this.dirent||(yield O.thenDefined(this.stat()))}))}existsSync(){return null!=this.dirent||null!=this.statSync()}notExists(){return i(this,void 0,void 0,(function*(){return O.thenNot(this.exists())}))}mtime(){return O.thenMap(this.stat(),e=>e.mtime)}mtimeMs(){return O.thenMap(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return O.thenMap(this.stat(),e=>C.unixtime(e.mtime))}lastModifiedUtc(){return i(this,void 0,void 0,(function*(){return O.thenMap(this.stat(),e=>e.mtime.toUTCString())}))}statTimes(){return O.thenMap(this.stat(),e=>d.uniq([e.birthtimeMs,e.mtimeMs].filter(e=>null!=e&&0!==e)))}maxStatMs(){return O.thenMap(this.statTimes(),E.max)}maxStatDate(){return O.thenMap(this.maxStatMs(),e=>new Date(e))}minStatMs(){return O.thenMap(this.statTimes(),B.min)}minStatDate(){return O.thenMap(this.minStatMs(),e=>new Date(e))}size(){return O.thenMap(this.stat(),e=>e.size)}access(e){return this.trapOr("access("+e+")",()=>te.access(this.nativePath,e))}isReadable(){return this.access(r.constants.R_OK)}isHiddenPosix(){return this.base.startsWith(".")}isEmpty(e=0){return i(this,void 0,void 0,(function*(){if(yield this.isDirectory())return d.isNotEmpty(yield this.childNames());{const t=yield this.size();return null==t||t<=e}}))}isNonEmpty(e=1){return O.thenNot(this.isEmpty(e))}isNonEmptyFile(e=1){return i(this,void 0,void 0,(function*(){return(yield this.isFile())&&(yield this.isNonEmpty(e))}))}modifiedGTE(e){return i(this,void 0,void 0,(function*(){return O.thenMap(this.mtime(),t=>C.unixtime(t)>=C.unixtime(e))}))}modifiedCloseTo(e,t){return i(this,void 0,void 0,(function*(){return O.thenMap(this.mtimeMs(),n=>Math.abs(n-e)<=t)}))}modifiedGT(e){return i(this,void 0,void 0,(function*(){if(null!=e)return O.thenMap(this.mtime(),t=>C.unixtime(t)>C.unixtime(e))}))}isDirectory(){return i(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isDirectory():O.thenMapOr(this.stat(),e=>e.isDirectory(),()=>!1)}))}isNotDirectory(){return i(this,void 0,void 0,(function*(){return O.thenNot(this.isDirectory())}))}isDirectorySync(){return null!=this.dirent?this.dirent.isDirectory():y.mapOr(this.statSync(),e=>e.isDirectory(),()=>!1)}isSymbolicLink(){return i(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isSymbolicLink():O.thenMapOr(this.stat(),e=>e.isSymbolicLink(),()=>!1)}))}nearestDir(){return i(this,void 0,void 0,(function*(){return(yield this.isDirectory())?this:this.parent()}))}isFile(){return i(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isFile():this.stat().then(e=>b.Opt(e).map(e=>e.isFile()).getOrElse(()=>!1))}))}isFileSync(){return null!=this.dirent?this.dirent.isFile():b.Opt(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>te.rmdir(this.nativePath),e)}mkdirp(){return i(this,void 0,void 0,(function*(){return(yield this.clear().isDirectory())||this.isRoot?this:this.trap("mkdirp",()=>i(this,void 0,void 0,(function*(){try{yield o.mkdirp(this.nativePath)}catch(e){if("EEXIST"!==e.code)throw e}const e=2*m.secondMs;if(!1===(yield O.until(()=>this.clear().isDirectory(),e,200)))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()})))}))}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",()=>(o.mkdirpSync(this.nativePath),this.clearThisAndParent()))}sha(){return O.thenMap(this.shaResult(),e=>e.b64)}shaMs(){return O.thenMap(this.shaResult(),e=>e.elapsedMs)}writeStream(e,t){return i(this,void 0,void 0,(function*(){return yield Z.pipelineAsync(d.compact([e,y.map(null==t?void 0:t.onProgress,e=>new Z.ByteCounter(e)),o.createWriteStream(this.nativePath,t)])),this.clearThisAndParent()}))}writeJsonMaybe(e,t={}){return i(this,void 0,void 0,(function*(){return this.trap("writeJsonMaybe",()=>this.writeJSON(e,t))}))}writeJSON(e,t={}){return i(this,void 0,void 0,(function*(){return yield this.parent().mkdirp(),yield te.writeFile(this.nativePath,g.stringify(e,t.replacer,t.spaces),Object.assign({flag:"w"},t)),this.clearThisAndParent()}))}readJSON(e="warn"){return this.trap("readJSON",()=>h.retryOnReject(()=>o.readJSON(this.nativePath),{maxRetries:1,onRetryWaitUntil:()=>p.delay("warn"===e?250:25),errorIsRetriable:e=>-2!==e.errno}),e)}readJSONSync(){return this.trapSync("readJSONSync",()=>o.readJSONSync(this.nativePath))}readFile(e="warn"){return this.trap("readFile",()=>te.readFile(this.nativePath),e)}zReadFile(e){return i(this,void 0,void 0,(function*(){return ee.zReadFile(this.nativePath,e)}))}zcat(e){return i(this,void 0,void 0,(function*(){return this.trap("zcat",()=>O.thenMap(this.zReadFile(e),M.toS))}))}readLines(){return O.thenMap(this.readFile(),e=>G.splitLines(e.toString()))}readFileSync(){return R.Try(()=>y.map(r.readFileSync(this.nativePath),M.toS))}writeTxt(e){return this.writeFile(G.crlf(e))}writeFile(e){return i(this,void 0,void 0,(function*(){return yield this.parent().mkdirp(),yield o.writeFile(this.nativePath,e),this.clearThisAndParent()}))}wip(e=t.WipPrefix){return this.sibling(e+this.base)}unwip(e=t.WipPrefix){return i(this,void 0,void 0,(function*(){const t=this.sibling(z.stripPrefix(this.base,e));return this.mv(t,{overwrite:!0})}))}dest(e){return i(this,void 0,void 0,(function*(){const t=e.clear();return f.notBlank(this.ext)&&f.blank(t.ext)||(yield t.isDirectory())?t.join(this.base):t}))}copyFile(e){return _.time("fs.copyFile",()=>i(this,void 0,void 0,(function*(){const t=(yield this.dest(e)).clear();if(this.nativePath===t.nativePath)return this;if(null==(yield t.parent().mkdirp()))return this.bflog().throw("Cannot mkdirp "+t.dir);try{return yield this._copyFile(t)}catch(e){return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:t.nativePath,error:e}),yield this._nativeCopyFile(t)}finally{this.clearThisAndParent()}})))}_copyFile(e){return i(this,void 0,void 0,(function*(){let t;const n=yield this.stat(),r=y.map(n,e=>e.size);if(null==n||null==r)return this.bflog().throw("Can't copy missing files");if(V.Settings.verifyFileCopies.valueOrDefault&&null==(yield this.sha()))return this.bflog().throw("Can't copy file without SHA");const o=e.wip();try{const s=te.copyFile(this.nativePath,o.nativePath);r>5*P.MiB&&(t=new Y.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},r,()=>o.clear().size())),yield s;const a=yield O.until(()=>i(this,void 0,void 0,(function*(){return r===(yield o.clear().size())})),U.CmdTimeoutMs);if(V.Settings.verifyFileCopies.valueOrDefault){const e=a&&(yield O.until(()=>I.eqlAsync(this.sha(),o.clear().sha())));if(!e)return this.bflog().throw("copyFile() failed",{sizeMatches:a,shaMatches:e})}if(!a)return this.bflog().throw("copyFile() failed",{expectedSize:r,actualSize:yield o.clear().size()});const u=yield o.unwip();if(null==u)return this.bflog().throw("copyFile("+e+") failed: .unwip() was null");try{yield te.chmod(u.nativePath,n.mode)}catch(e){this.bflog().debug(`copyFile(${o.nativePath}) warning: couldn't chmod to ${n.mode}: ${e}`)}return yield te.utimes(u.nativePath,n.atime,n.mtime),this.bflog().debug(`copyFile(${e.nativePath}): success`),A.emitFileCopied(this.nativePath,e.nativePath),e}catch(t){throw this.bflog().warn(`copyFile(${o.nativePath}) failed: ${t}`),yield o.unlink(),yield e.unlink(),t}finally{y.map(t,e=>e.end())}}))}copyTimeoutMs(){return i(this,void 0,void 0,(function*(){return O.thenMapOr(this.size(),e=>Math.max(U.CmdTimeoutMs,e*U.MinIoRate),()=>U.CmdTimeoutMs)}))}_nativeCopyFile(e){return i(this,void 0,void 0,(function*(){let t;try{if(null==(yield e.parent().mkdirp()))return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});const n=yield this.stat(),i=y.map(n,e=>e.size);return null==n||null==i?this.bflog().throw("Can't copy missing files"):(i>5*P.MiB&&(t=new Y.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},i,()=>e.clear().size())),N.isWin?yield j.PowerShell.instance().execute(`Copy-Item -LiteralPath ${j.pwshQuote(this.nativePath)} -Destination ${j.pwshQuote(e.nativePath)}`,e=>e):yield D.stdout("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:yield this.copyTimeoutMs()}),A.emitFileCopied(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(t){return this.bflog().throw("_nativeCopyFile("+e+"): "+t)}finally{y.map(t,e=>e.end())}}))}touch(e=Date.now(),t){return i(this,void 0,void 0,(function*(){return this.trap("touch",()=>O.thenMap(this.ensureFile(),()=>this.utimes(e,t)))}))}utimes(e,t){return i(this,void 0,void 0,(function*(){const n=y.orElse(e,Date.now()),i=y.orElse(t,n);return this.trap("utimes",()=>te.utimes(this.nativePath,C.unixtime(i),C.unixtime(n)).then(()=>this.clearThisAndParent()))}))}unlink(e="warn"){return i(this,void 0,void 0,(function*(){return this.trap("unlink",()=>i(this,void 0,void 0,(function*(){return yield te.unlink(this.nativePath),this.clearThisAndParent()})),e)}))}rmrf(e="info"){return i(this,void 0,void 0,(function*(){return this.trap("rmrf",()=>i(this,void 0,void 0,(function*(){return this.bflog().log(e,"rmrf()"),yield o.remove(this.nativePath),this.clearThisAndParent()})))}))}unlock(){return i(this,void 0,void 0,(function*(){return N.isMac&&(yield this.clear().exists())&&(yield D.stdout("chflags",["nouchg",this.nativePath],{timeout:U.CmdTimeoutMs})),this}))}renameWithNameSuffix(e){return i(this,void 0,void 0,(function*(){return O.thenMap(this.withNameSuffix(e).ensureNew({emptyIsNew:!0}),e=>e.unlink("debug").then(()=>this.mv(e)))}))}mv(e,t={overwrite:!1}){return i(this,void 0,void 0,(function*(){const n=yield this.dest(e);return this.nativePath===n.nativePath?(this.bflog().warn("mv(): no-op",new Error("internal error")),this):(yield n.parent().mkdirp(),yield Promise.all([this.unlock(),n.unlock()]),this.bflog().debug("mv",n),yield o.move(this.nativePath,n.nativePath,t),yield n.unlock(),this.clearThisAndParent(),n.clearThisAndParent())}))}pipeTo(e,t){return i(this,void 0,void 0,(function*(){return this.trap("pipeTo("+e+")",()=>i(this,void 0,void 0,(function*(){const n=yield this.for(this.nativePath+S.ensurePrefix(e,".")).ensureNew();return yield Z.pipelineAsync([r.createReadStream(this.nativePath),t,r.createWriteStream(n.nativePath)]),yield this.unlink(),n})))}))}gzip(){return i(this,void 0,void 0,(function*(){return this.pipeTo(".gz",c.createGzip())}))}compressBrotli(){return i(this,void 0,void 0,(function*(){return this.pipeTo(".br",c.createBrotliCompress())}))}ensureFile(){return this.trap("ensureFile",()=>o.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync(){return o.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return $.nameWithoutCount(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}ensureNewNativePath(e){return i(this,void 0,void 0,(function*(){const n=Object.assign(Object.assign({},t.DefaultEnsureNewOptions),e);if(this.clear(),!n.requireNumber&&((yield this.notExists())||n.emptyIsNew&&(yield this.isEmpty())))return this.nativePath;const i=this.parent();yield i.mkdirp();for(let e=n.startIndex;e<=n.maxVersions;e++){const t=i.join(`${this.name}-${z.leftPad(e,n.leftPad,"0")}${this.ext}`);if(t.clear(),(yield t.notExists())||n.emptyIsNew&&(yield t.isEmpty()))return t.nativePath}throw new Error("There are already more than "+n.maxVersions+" of "+this)}))}ensureNew(e={}){return this.ensureNewNativePath(e).then(e=>this.for(e))}renameYMDHMS(e){return i(this,void 0,void 0,(function*(){if(yield this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");const t=yield O.thenMapOr(this.mtime(),e=>s.DateTime.fromJSDate(e),()=>s.DateTime.local()),n=C.dateTimeToLocalSec(t),i=y.mapOr(e,e=>this.parent().join(e),()=>this.parent());return this.mv(i.join(this.name+"-"+n+this.ext),{overwrite:!0})}))}saveIfNewOrDelete(e){return i(this,void 0,void 0,(function*(){if(yield this.clear().isEmpty())return void(yield this.unlink("trace"));const t=yield this.siblingWithSameContents();if(null!=t)return yield this.unlink(),t;const n=yield this.sibling(e).ensureNew();return this.mv(n)}))}chmod(e){return i(this,void 0,void 0,(function*(){return yield te.chmod(this.nativePath,e),this.clear()}))}zreadline(){return u.createInterface({input:r.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe(c.createGunzip()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)})})}siblingWithSameContents(){return i(this,void 0,void 0,(function*(){return this.parent().childWithSameContents(this)}))}childWithSameContents(e){return i(this,void 0,void 0,(function*(){return _.time("fs.childWithSameContents",()=>i(this,void 0,void 0,(function*(){if((yield this.notExists())||!(yield this.isDirectory()))return;const t=yield e.size(),n=yield this.children(),i=[];for(const r of w.toA(n))(yield r.size())!==t||e.eql(r)||i.push(r);if(d.isEmpty(i))return;const r=yield e.sha();for(const e of i.sort((e,t)=>W.diceCoeff(e.base,t.base)).reverse())if((yield e.sha())===r)return e})))}))}applyWip(e){return i(this,void 0,void 0,(function*(){const t=this.wip();try{yield t.parent().mkdirp(),yield t.unlink("debug");const n=yield e(t);if(yield t.clear().isEmpty())throw new Error("applyWip(): builder didn't write to dest");return yield t.unwip(),n}catch(e){throw yield O.tryAll([()=>t.unlink(),()=>this.unlink()]),e}}))}applyIfEmpty(e,t=0){return i(this,void 0,void 0,(function*(){return(yield this.clear().isNonEmpty(t))?(this.bflog().debug("applyIfEmpty(): non-empty"),this):(this.bflog().debug("applyIfEmpty(): empty, applying..."),yield this.applyWip(e),this)}))}firstMatchingLine(e){const t=new x.Deferred("firstMatchingLine("+this+")"),n=r.createReadStream(this.nativePath,{flags:"r"});return n.on("error",e=>{-2===e.errno||"ENOENT"===e.code?(t.maybeResolve(void 0),n.close()):t.maybeReject(e)}),n.on("close",()=>t.maybeResolve(void 0)),X.onDataChunked(n,S.newlineRe,i=>{const r=e.exec(i);null!=r&&(t.maybeResolve(r),n.close())}),t.promise}}t.BaseFile=ie,ie.attrTTL=3*m.minuteMs,ie.projectRoot=v.lazy(()=>{const e=Q.ProjectPath.Root();if(null==e)throw new Error("Cannot find project path");return ie.for(e)}),t.execDir=function(){return ie.for(process.execPath).parent()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cmpArr=t.gt=t.gte=t.lte=t.lt=t.cmp=t.isPrimitiveArray=t.mapPrimitiveOr=t.mapPrimitive=t.isPrimitive=void 0;const i=n(1),r=n(7),o=["number","string","boolean"];function s(e){return-1!==o.indexOf(typeof e)}t.isPrimitive=s,t.mapPrimitive=function(e,t){return s(e)?t(e):void 0},t.mapPrimitiveOr=function(e,t,n){return s(e)?t(e):n()},t.isPrimitiveArray=function(e){return Array.isArray(e)&&e.every(s)};const a=["boolean","number","bigint","symbol","string","object","function"];function u(e,t){if(null==e&&null==t)return 0;if(null==e)return-1;if(null==t)return 1;const n=typeof e,i=typeof t;return"string"!==n&&"symbol"!==n||"string"!==i&&"symbol"!==i?Array.isArray(e)&&Array.isArray(t)?l(e,t):n!==i?a.indexOf(n)-a.indexOf(i):e>t?1:e<t?-1:0:r.toS(e).localeCompare(r.toS(t))}function l(e,t){if(i.isEmpty(e)&&i.isEmpty(t))return 0;const n=Math.min(e.length,t.length);for(let i=0;i<n;i++){const n=u(e[i],t[i]);if(0!==n)return n}return u(e.length,t.length)}t.cmp=u,t.lt=function(e,t){return u(e,t)<0},t.lte=function(e,t){return u(e,t)<=0},t.gte=function(e,t){return u(e,t)>=0},t.gt=function(e,t){return u(e,t)>0},t.cmpArr=l},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PowerShell=t.pwshQuote=void 0;const r=n(94),o=n(3),s=n(4),a=n(2),u=n(0),l=n(17),c=n(8),d=n(157),h=n(20),f=n(27),m=n(12),p=n(99),g=n(6),v=n(28),y=n(10),b=n(23),S=n(67),w=10*s.minuteMs;m.onClearCache(()=>u.map(M.instance.prior(),e=>e.clearMockResults())),t.pwshQuote=function(e){return'"'+y.splitKeep(e,/['`"ââ#]/g,!0).join("`").replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v")+'"'};class M{constructor(){this.name="PowerShell",this.logger=g.mkLogger("PowerShell"),this.mockResults=new Map,this.pwsh=d.observeBatchCluster(new r.BatchCluster({processFactory:()=>h.execFile("powershell",[],w),versionCommand:'function prompt {"{ready}"}',pass:"{ready}",fail:"Error",exitCommand:"exit",maxProcs:S.maxCpus()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:b.CmdTimeoutMs,cleanupChildProcs:!1}),"PowerShell",l.EndableRanks.db).bc}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return c.thenMap(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,t){this.pushMockResult(y.ensureSuffix(e," | ConvertTo-Json -Compress"),t)}pushMockResult(e,t){this.mockResults.set(e,t)}clearMockResults(){this.mockResults.clear()}execute(e,t){return i(this,void 0,void 0,(function*(){if(this.pwsh.ended||l.ending())this.logger.warn("execute() failed (ended)",{cmd:e});else{if(v.isTest&&this.mockResults.has(e)){const n=this.mockResults.get(e);return t(n.stdout,n.stderr,n.passed)}try{this.logger.debug("execute()",{cmd:e});const n=yield f.elapsedAsync(()=>this.pwsh.enqueueTask(new r.Task(e,(n,i,r)=>t(u.map(n,t=>y.stripPrefix(t,e)),i,r))));return this.logger.log(p.ms2level(n.elapsedMs,7*s.secondMs),"execute()",{cmd:e,elapsedMs:n.elapsedMs}),n.result}catch(t){return void this.logger.warn("execute() failed: "+t,{cmd:e})}}}))}executeJson(e){return i(this,void 0,void 0,(function*(){const t=yield this.execute(y.ensureSuffix(e," | ConvertTo-Json -Compress"),(e,t,n)=>({stdout:e,stderr:t,passed:n}));if(null!=t)if(o.blank(t.stdout)||o.notBlank(t.stderr)||!t.passed)this.logger.warn("executeJson(): failed result",Object.assign({cmd:e},t));else try{return JSON.parse(t.stdout)}catch(e){const n=t.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:y.ellipsize(t.stdout),after:y.ellipsize(n)}),JSON.parse(n)}else this.logger.warn("executeJson(): null result",{cmd:e})}))}executeJsonToA(e){return i(this,void 0,void 0,(function*(){return c.thenMap(this.executeJson(e),e=>Array.isArray(e)?e:[e])}))}}t.PowerShell=M,M.instance=a.lazy(()=>new M)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withBoundedConcurrency=t.serially=t.maybeRun=t.oneRunAtATime=t.Promises=void 0;const r=n(1),o=n(76),s=n(39),a=n(79),u=n(67),l=n(58);class c{constructor(){this._pushCount=0,this._arr=[],this.nextSettledLatches=[],this.serialLatencyAvg=new a.Average}get arr(){return r.filterInPlace(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}push(e,t){this._pushCount++;const n=s.isFunction(t)?t():t;return this.arr.push(new l.Deferred(e).observeQuietly(n).finally(()=>this.emitSettled())),n}emitSettled(){this.nextSettledLatches.forEach(e=>e.resolve()),this.nextSettledLatches.length=0}awaitNextSettled(){const e=new o.Latch;return this.nextSettledLatches.push(e),e}serial(e,t){const n=Date.now();return this.push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-n),t())))}serialByName(e,t){const n=Date.now();return this.push(e,this.awaitAllByName(e).then(()=>(this.serialLatencyAvg.push(Date.now()-n),t())))}oneRunAtATime(e,t){return this.pending?this.awaitAll():this.serial(e,t)}maybeRun(e,t){return this.maybeRunConcurrent(e,t,1)}maybeRunConcurrent(e,t,n=u.maxCpus()){return this.pendingCount>=n?void 0:this.push(e,t)}get pendingCount(){return r.count(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return 0===this.arr.length}awaitAll(){return i(this,void 0,void 0,(function*(){yield Promise.all(this.arr.map(e=>i(this,void 0,void 0,(function*(){yield e.promise}))))}))}awaitAllByName(e){return i(this,void 0,void 0,(function*(){yield Promise.all(this.arr.filter(t=>t.name===e).map(e=>i(this,void 0,void 0,(function*(){yield e.promise}))))}))}}t.Promises=c,t.oneRunAtATime=function(e,t){const n=new c;return()=>n.oneRunAtATime(e,t)},t.maybeRun=function(e,t){const n=new c;return()=>n.maybeRun(e,t)},t.serially=function(e,t){const n=new c;return()=>n.serial(e,t)},t.withBoundedConcurrency=function({name:e,laters:t,maxConcurrent:n=u.maxCpus()}){return i(this,void 0,void 0,(function*(){const i=[],r=new c;for(const o of t){for(;r.pendingCount>=n;)yield r.awaitNextSettled();i.push(r.push(e,o))}return Promise.all(i)}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOp=t.firstDefinedThunk=t.tot=void 0;const i=n(39);t.tot=function(e){return i.isFunction(e)?e():e},t.firstDefinedThunk=function(e){for(const t of e){const e=t();if(null!=e)return e}},t.NoOp=()=>{}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.eqlAsyncPicked=t.eqlAsync=t.definedAndNotEql=t.definedAndEql=t.eql=void 0;const r=n(0),o=n(11),s=n(200);function a(e,t){return s(e,t)}t.eql=a,t.definedAndEql=function(e,t){return null!=e&&null!=t&&a(e,t)},t.definedAndNotEql=function(e,t){return null!=e&&null!=t&&!a(e,t)},t.eqlAsync=function(e,t){return i(this,void 0,void 0,(function*(){return r.map2Or(yield e,yield t,a,()=>!1)}))},t.eqlAsyncPicked=function(e,t,...n){return i(this,void 0,void 0,(function*(){return r.map2Or(yield e,yield t,(e,t)=>a(o.pick(e,...n),o.pick(t,...n)),()=>!1)}))}},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.App=t.AppPaths=void 0;const i=n(19),r=n(2),o=n(11),s=n(36),a=n(137),u=n(103),l=n(30),c=n(86),d=n(28),h=n(9);t.AppPaths=s.strEnum("exe","home","appData","userData","pictures","cache"),function(e){e.getName=()=>u.AppName,e.exe=r.lazy(()=>i.execPath),e.home=r.lazy(()=>c.homeDir()),e.appData=r.lazy(()=>a.appData()),e.appName=r.lazy(()=>u.AppName+(d.isProd?"":"-"+d.nodeEnv)),e.userData=r.lazy(()=>l.resolve(e.appData(),e.appName())),e.pictures=r.lazy(()=>l.resolve(e.home(),"Pictures")),e.cache=()=>h.Settings.cacheDir.valueOrDefault,e.getPath=t=>o.maybeCall(e,t),e.setPath=(t,n)=>{"cache"===t?h.Settings.cacheDir.tmpValue=n:e[t].set(l.resolve(n))}}(t.App||(t.App={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isMimetypeSupported=t.extractShortExt=t.extType=t.ExtTypes=t.isBrowserExt=t.BrowserExts=t.BrowserImgExts=t.isExifExt=t.AllExifExts=t.isAssetFileExt=t.AssetFileExts=t.isSidecarExt=t.SidecarExts=t.SidecarExtsEnum=t.isVideoExt=t.VideoExts=t.BaseVideoExts=t.isRawImageExt=t.RawImageExts=t.BaseRawImageExts=t.isSharpMimetype=t.sharpSupportedMimeTypes=t.isSharpExt=t.SharpImageExts=t.BaseSharpImageExts=t.isHeifEnabled=t.normalizeExt=t.asExt=t.fileExtsToDesc=void 0;const i=n(73),r=n(1),o=n(3),s=n(2),a=n(0),u=n(36),l=n(45),c=n(7),d=n(205),h=n(25),f=n(10);t.fileExtsToDesc=[[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["DNG"],"Digital Negative (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HEIC","HEIF"],"High Efficiency Image Format (QuickTime-based)"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PNG"],"Portable Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["THM"],"Thumbnail image (JPEG)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["XMP"],"Extensible Metadata Platform sidecar file"]];const m=t.fileExtsToDesc.map(([e])=>e),p=new Map(r.flatten(m.map(e=>e.map(t=>[v(t),v(e[0])]))));function g(e){return r.flatten(r.compact(e.map(e=>e.toUpperCase()).map(e=>m.find(t=>t.includes(e))))).map(v)}function v(e){return f.ensurePrefix(e,".").toUpperCase()}function y(e){return o.mapNotBlank(e,v)}function b(e){const t=s.lazy(()=>new Set(r.compactBlanks(l.tot(e).map(y))));return e=>a.orElse(a.map(y(e),e=>t().has(e)),!1)}t.asExt=v,t.normalizeExt=function(e){if(o.blank(e))return e;const t=v(e);return a.orElse(p.get(t),t)},t.isHeifEnabled=s.lazy(()=>h.mapAnd(i.format.heif,e=>e.input.file)),t.BaseSharpImageExts=s.lazy(()=>r.compact(["GIF",t.isHeifEnabled()?"HEIC":void 0,"JPEG","PNG","PPM","TIFF","THM","WEBP"])),t.SharpImageExts=s.lazy(()=>g(t.BaseSharpImageExts())),t.isSharpExt=b(t.SharpImageExts),t.sharpSupportedMimeTypes=s.lazy(()=>new Set(r.compact(["image/gif",...t.isHeifEnabled()?["image/heic","image/heif"]:[],"image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"]))),t.isSharpMimetype=function(e){return t.sharpSupportedMimeTypes().has(c.toS(e).toLowerCase())},t.BaseRawImageExts=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"],t.RawImageExts=g(t.BaseRawImageExts),t.isRawImageExt=b(t.RawImageExts),t.BaseVideoExts=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"],t.VideoExts=g(t.BaseVideoExts),t.isVideoExt=b(t.VideoExts),t.SidecarExtsEnum=u.strEnum("EXIF","EXV","MIE","XMP"),t.SidecarExts=g(t.SidecarExtsEnum.values),t.isSidecarExt=b(t.SidecarExts),t.AssetFileExts=s.lazy(()=>[...t.SharpImageExts(),...t.RawImageExts,...t.VideoExts].sort()),t.isAssetFileExt=b(t.AssetFileExts),t.AllExifExts=s.lazy(()=>[...t.AssetFileExts(),...t.SidecarExts].sort()),t.isExifExt=b(t.AllExifExts),t.BrowserImgExts=g(["JPEG","PNG"]),t.BrowserExts=g(["GIF","JPEG","MP4","PNG","WEBM","WEBP"]),t.isBrowserExt=b(t.BrowserExts),t.ExtTypes=u.strEnum("image","raw","video"),t.extType=function(e){return t.isSharpExt(e)?t.ExtTypes.image:t.isRawImageExt(e)?t.ExtTypes.raw:t.isVideoExt(e)?t.ExtTypes.video:void 0};const S=/\.[a-z0-9]{2,4}$/i;t.extractShortExt=function(e){return a.map(S.exec(c.toS(e)),e=>e[0])};const w=["image/gif","image/jpeg","image/pjpeg","image/png","image/webp"],M=["image/gif","image/jpeg","image/png"];t.isMimetypeSupported=function(e,t){return(d.isChrome(t)||d.isFirefox(t)?w:M).includes(c.toS(e))}},function(e,t){e.exports=require("os")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jaccard=t.cosineSimilarity=t.dot=t.l2norm=t.centroid=t.euclidean=t.avgWeighted=t.weightedAvg=t.stdDev=t.variance=t.avgMaybe=t.slope=t.avg=t.sum=t.mode=t.modes=t.deltas=t.max=t.min=void 0;const i=n(1),r=n(0),o=n(5),s=n(15),a=n(104),u=n(16),l=n(89);function c(e,t){const n=new a.CountingSet;return s.toA(e).forEach(e=>o.mapFinite(e,e=>n.incr(e))),n.topKeys(t)}function d(e){return s.toA(e).reduce((e,t)=>e+t,0)}function h(e){const t=s.toA(e);return i.isEmpty(t)?void 0:t.reduce((e,t,n)=>0===n?t:e*n/(n+1)+t/(n+1),0)}function f(e){return r.map(h(e),t=>h(e.map(e=>Math.pow(e-t,2))))}function m(e){return Math.sqrt(e.reduce((e,t)=>e+t*t,0))}function p(e,t){return e.reduce((e,n,i)=>e+n*t[i],0)}t.min=function(e){let t;for(const n of e)null!=n&&(null==t||n<t)&&(t=n);return t},t.max=function(e){let t;for(const n of e)null!=n&&(null==t||n>t)&&(t=n);return t},t.deltas=function(e){const t=s.toA(e);return null==e||t.length<=1?[]:t.slice(1).map((t,n)=>t-e[n])},t.modes=c,t.mode=function(e){return c(e,1)[0]},t.sum=d,t.avg=h,t.slope=function(e){const t=s.toA(e);return r.map(h(t),e=>{const n=(t.length-1)/2,i=d(t.map((t,i)=>(t-e)*(i-n))),r=d(t.map(t=>Math.pow(t-e,2)));return 0===r?0:i/r})},t.avgMaybe=function(...e){const t=i.compact(e);return i.isEmpty(t)?void 0:d(t)/t.length},t.variance=f,t.stdDev=function(e){return r.map(f(e),e=>Math.sqrt(e))},t.weightedAvg=function(e){let t;for(const n of e)t=null==t?n:(t+n)/2;return null==t?NaN:t},t.avgWeighted=function(e,t){let n=0;return e.reduce((e,i,r)=>{const o=u.mapGt0Or(t[r],e=>e,1);return n+=o,e+i*o},0)/n},t.euclidean=function(e,t){return Math.sqrt(s.toA(e).reduce((e,n,i)=>e+Math.pow(n-t[i],2),0))},t.centroid=function(e){return o.times(e[0].length,t=>h(e.map(e=>e[t])))},t.l2norm=m,t.dot=p,t.cosineSimilarity=function(e,t){return o.finiteOrElse(p(e,t)/(m(e)*m(t)),void 0)},t.jaccard=function(e,t){return i.isEmpty(e)&&i.isEmpty(t)?0:o.finiteOrElse(l.intersection(e,t).size/l.union(e,t).size,void 0)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WrappedError=void 0;const i=n(1),r=n(3),o=n(18),s=n(7),a=n(24),u=n(10);class l extends Error{constructor({cause:e,message:t,retriable:n=!0,ignorable:l=!1,fatal:c=!1}){super(function(e,t,n,l,c){const d=[e];o.Opt(t).flatMap(e=>e.message).flatMap(e=>u.stripPrefix(e,"Error: ")).forEach(e=>d.push(e));const h=i.compactBlanks(d).map(e=>s.toS(e).trim()).filter(r.notBlank).join(": "),f=[];return c||n||f.push(a.NonRetriableErrorFlag),l&&!c&&f.push(a.IgnorableErrorFlag),c&&f.push(a.FatalErrorFlag),i.isNotEmpty(f)&&f.unshift(" "),h+f.filter(e=>!h.includes(e)).join("")}(t,e,n,l,c)),this.cause=e,this.retriable=n,this.fatal=c}}t.WrappedError=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setZone=t.zoneToOffset=t.hasTime=t.dateBetween=t.nowish=t.gtDate=t.closeTo=t.diffMillis=t.sameDay=t.toFuzzyDate=t.datedToYMD=t.fromISO=t.datedToISO=t.datedToPrecisionMs=t.datedToOffsetMinutes=t.datedToMillis=t.toDate=t.toExifDateTime=t.toDateTime=t.parseExifDateTime=t.getZoneName=t.hasZone=t.zoneOffsetToName=t.getSecMs=t.hasSeconds=t.getMillisecond=t.getSecond=t.getMinute=t.getHour=t.getDay=t.getMonth=t.getYear=t.isDated=t.parseYMD=t.extractDateFromPath=t.clearIgnorableSubpaths=t.addIgnorableSubpath=t.FuzzyDateParser=t.parseDated=t.parseDateTime=t.agoMs=t.dateTimeBetween=t.isoToOffsetMinutes=t.FuzzyDate=t.validYMD=t.validDay=t.validMonth=t.validYear=t.maxMonth=t.maxYear=t.minYear=t.mapValidDate=t.validDate=void 0;const i=n(98),r=n(74),o=n(1),s=n(3),a=n(4),u=n(2),l=n(0),c=n(5),d=n(18),h=n(7),f=n(13),m=n(116),p=n(46),g=n(16),v=n(25),y=n(10),b=n(42);function S(e,t=2){return null==e?"":y.leftPad(e,t,"0")}function w(e){if(null==e||"string"==typeof e||0===e)return!1;const t=ie(e);return null!=t&&0!==t&&(!!x(W(e),q(e),U(e))&&(!ue(e)||l.mapOr(ee(e),e=>e.isValid,()=>!1)))}function M(e){return g.within(t.minYear,t.maxYear,e)}function P(e,n){return(!b.gte(n,t.maxYear)||!b.gt(e,t.maxMonth))&&g.within(1,12,e)}function E(e,t,n){return null!=n&&r.DateTime.fromObject({year:e,month:t,day:n}).isValid}function x(e,t,n){return M(e)&&(null==t||P(t,e)&&(null==n||E(e,t,n)))}t.validDate=w,t.mapValidDate=function(e,t){return w(e)?t(e):void 0},t.minYear=1826,t.maxYear=new Date(Date.now()+a.weekMs).getFullYear(),t.maxMonth=new Date(Date.now()+a.weekMs).getMonth()+1,t.validYear=M,t.validMonth=P,t.validDay=E,t.validYMD=x;class T{constructor(e,t,n){this.year=e,this.month=t,this.day=n}static for(e,t,n){return x(e,t,n)?new T(e,t,n):void 0}static localToday(){return se(new Date)}toString(){return o.compact([this.year,this.month,this.day]).map(e=>S(e)).join("-")}toISOString(){return this.toString()}toDateTime(){return r.DateTime.fromObject(this)}}t.FuzzyDate=T;class O{constructor(e,t,n,i,r){this.monthsToMonth=e,this.re=t,this.yearIndex=n,this.monthIndex=i,this.dayIndex=r}apply(e){const t=this.re.exec(e);if(null!=t){const e=parseInt(t[this.yearIndex],10),n=this.month(t),i=null==this.dayIndex?void 0:parseInt(t[this.dayIndex],10);return T.for(e,n,i)}}month(e){if(null==this.monthIndex)return;const t=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(t)?this.monthsToMonth.get(t):c.toInt(t)}}const F="((?:19|20)[0-9]{2})",_="([1-3][0-9]|0?[1-9])",D="([0-5][0-9])",C=D,I=D,A="([-\\.\\,:_/ |])?",k="(?:(Z)|(?:([+-])([01][0-9]):?([0-5][0-9])))",L=new RegExp("\\d\\d"+k+"(?:\\/|$)","i");function B(e,t){if(o.isEmpty(e))return t;const[n,i]=e.splice(0,2),[r,s]=e.splice(0,2).map(e=>c.toInt(e));return y.equalsIgnoreCase(n,"z")?0:f.anyNotDefined([i,r,s])?t:("-"===i?-1:1)*(60*r+s)}function R(e){return s.mapNotBlank(e,e=>v.firstTrueThunk([()=>i.ExifDateTime.fromEXIF(e),()=>X(e)],e=>w(e)))}t.isoToOffsetMinutes=function(e){return l.map(L.exec(e),e=>B(e.slice(1)))},t.dateTimeBetween=function(e,t){return e.until(t).divideEqually(2)[0].end},t.agoMs=function(e){return c.mapNumeric(ie(e),e=>Date.now()-e)},t.parseDateTime=R,t.parseDated=function(e){return s.mapNotBlank(e,e=>v.firstTrueThunk([()=>m.DateInterval.fromISO(e),()=>R(e),()=>i.ExifDate.fromEXIF(e),()=>V().parseYMD(e),()=>new Date(e)],e=>w(e)))};class N{constructor(e){this.locale=e,this.monthsToMonth=new Map,this.ymdPatterns=[],this.ymPatterns=[],this.setup()}parseYMD(e){return f.first(this.ymdPatterns,t=>t.apply(e))}addParser(e,t,n,i){const r=new O(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),t,n,i);null!=i&&null!=n?this.ymdPatterns.push(r):null!=n&&this.ymPatterns.push(r)}setup(){["short","long"].forEach(e=>{const t=new Intl.DateTimeFormat(this.locale,{month:e});c.times(12,e=>{const n=t.format(new Date(2017,e));this.monthsToMonth.set(n.toLowerCase(),e+1)})});const e="("+o.sort([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(F+A+"(1[0-2]|0?[1-9])\\2"+_,1,3,4),this.addParser(F+A+e+"\\2"+_,1,3,4),this.addParser(e+A+_+",?\\2"+F,4,1,3),this.addParser(_+A+e+",?\\2"+F,4,3,1),this.addParser(e+A+F,3,1),this.addParser(F+A+e,1,3)}extractDateFromPath(e){z.forEach(t=>{o.startsWith(e,t)&&e.splice(0,t.length)}),e=e.filter(t=>s.notBlank(t)&&null==e[0].match(j));const t=[...e].reverse();return v.firstThunk(()=>f.first(t,e=>this.parseYMD(e)),()=>this.parseYMD(t.join(" ")),()=>this.parseYMD(e.join(" ")),()=>f.first(this.ymPatterns,t=>t.apply(e.join(" "))),()=>f.first(this.ymPatterns,e=>e.apply(t.join(" "))))}}t.FuzzyDateParser=N;const j=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P)\d+)$/i,V=u.lazy(()=>new N(void 0)),z=[];function W(e){return l.map(e,e=>e instanceof Date?e.getFullYear():e.year)}function q(e){return l.map(e,e=>e instanceof Date?e.getMonth()+1:e.month)}function U(e){return l.map(e,e=>e instanceof Date?e.getDate():e.day)}function G(e){return ue(e)?e instanceof Date?e.getHours():e.hour:void 0}function H(e){return ue(e)?e instanceof Date?e.getMinutes():e.minute:void 0}function K(e){return ue(e)?e instanceof Date?e.getSeconds():e.second:void 0}function J(e){return ue(e)?e instanceof Date?e.getMilliseconds():e.millisecond:void 0}function $(e,t=!0){if(null==e)return;if(0===e)return t?"UTC":"";const n=e<0?"-":"+",i=15*c.round(e/15),r=Math.abs(i),o=Math.floor(r/60),s=Math.floor(Math.abs(r%60));return`${t?"UTC":""}${n}${S(o)}:${S(s)}`}function Y(e){return e instanceof i.ExifDateTime?e.hasZone:e instanceof r.DateTime&&(null!=e.zone&&"local"!==e.zone.type)}function Q(e){return e instanceof r.DateTime?l.map(e.zone,e=>e.name):e instanceof i.ExifDateTime?e.zone:void 0}function X(e,t=Z){const n=t.exec(e);if(null==n)return;const i=[...n.slice(1)],[o,s,a,u,l,h]=i.splice(0,6).map(e=>c.toInt(e)),f=c.clamp(0,999,1e3*c.toFloat(i.shift(),{defaultValue:0})),m=$(B(i));return d.Opt(r.DateTime.fromObject({year:o,month:s,day:a,hour:u,minute:l,second:h,millisecond:f,zone:m})).filter(e=>e.isValid).flatMap(e=>te(e,m)).get()}t.addIgnorableSubpath=function(e){z.push(e)},t.clearIgnorableSubpaths=function(){z.length=0},t.extractDateFromPath=function(e){return V().extractDateFromPath(e)},t.parseYMD=function(e){return V().parseYMD(e)},t.isDated=function(e){return null!=e&&(e instanceof T||e instanceof i.ExifDate||e instanceof i.ExifDateTime||e instanceof Date||e instanceof m.DateInterval||e instanceof r.DateTime||l.allDefined([e.year,e.month,e.day]))},t.getYear=W,t.getMonth=q,t.getDay=U,t.getHour=G,t.getMinute=H,t.getSecond=K,t.getMillisecond=J,t.hasSeconds=function(e){return ue(e)&&(c.gt0(H(e))||c.gt0(K(e))||c.gt0(J(e)))},t.getSecMs=function(e){return l.map(K(e),t=>{const n=l.orElse(J(e),0);let i=(t+n/1e3).toString();for(t<10&&(i="0"+i),0===n&&(i+=".");i.length<6;)i+="0";return i})},t.zoneOffsetToName=$,t.hasZone=Y,t.getZoneName=Q,t.parseExifDateTime=X;const Z=new RegExp([F,"(1[0-2]|0[1-9])","([1-3][0-9]|0[1-9])","(1[0-9]|2[0-3]|0[0-9])",C,I,"(?:(\\.[0-9]+))?"].join("[-:_ ]?")+k+"?","i");function ee(e){return e instanceof r.DateTime?e:e instanceof i.ExifDateTime?e.toDateTime():e instanceof m.DateInterval?e.middle.toDateTime():e instanceof Date?r.DateTime.fromJSDate(e):void 0}function te(e,t){if(null==e||!ue(e))return;if(e instanceof r.DateTime)return i.ExifDateTime.fromDateTime(e);const n=ie(e);if(null==n)return;const o=s.blank(t)?Y(e)?Q(e):void 0:t,a=s.mapNotBlank(o,e=>le(n,e));if(null!=t&&null==a)return;const u=l.map(W(e),t=>l.map(q(e),n=>l.map(U(e),r=>l.map(G(e),o=>new i.ExifDateTime(t,n,r,o,l.orElse(H(e),0),l.orElse(K(e),0),J(e),a,e.rawValue)))));return w(u)?u:void 0}function ne(e){if(null==e)return;if("number"==typeof e)return new Date(e);if(e instanceof Date)return e;if(e instanceof r.DateTime)return e.toJSDate();if(null!=e.toDate)return e.toDate();if(c.gt0(e.year)&&c.gt0(e.month)&&c.gt0(e.day))return new Date(e.year,l.orElse(e.month,1)-1,e.day,12);const t=h.toS(e);return s.notBlank(t)?l.map(re(t),ne):void 0}function ie(e){if(null!=e&&!y.isString(e))return c.isNumber(e)?e:e instanceof Date?e.getTime():e instanceof r.DateTime?e.toMillis():l.map(ne(e),e=>e.getTime())}function re(e,t){return"string"!=typeof e||s.blank(e)?void 0:d.Opt(i.ExifDateTime.fromISO(e,t)).orElse(()=>i.ExifDate.fromISO(e)).orElse(()=>i.ExifTime.fromEXIF(e)).get()}function oe(e,t="-"){return o.compact([W(e),q(e),U(e)]).map(e=>S(e)).join(t)}function se(e){return l.map(e,e=>l.map(W(e),t=>new T(t,q(e),U(e))))}function ae(e,t){const[n,i]=[e,t].map(ie);return null==n||null==i?void 0:n-i}function ue(e){return e instanceof Date||e instanceof i.ExifDateTime||e instanceof r.DateTime}function le(e,t){const n=r.Info.normalizeZone(t);return n.isValid?n.offset(e):void 0}t.toDateTime=ee,t.toExifDateTime=te,t.toDate=ne,t.datedToMillis=ie,t.datedToOffsetMinutes=function(e){return l.map(e,e=>e instanceof i.ExifDateTime?e.tzoffsetMinutes:e instanceof r.DateTime?e.offset:void 0)},t.datedToPrecisionMs=function(e){return l.map(e,e=>e instanceof r.DateTime||e instanceof i.ExifDateTime||e instanceof Date?0:e instanceof i.ExifDate?a.dayMs:e instanceof m.DateInterval?e.intervalMs:void 0)},t.datedToISO=function(e,t=!0){if(e instanceof m.DateInterval)return e.toString(t);const n=c.isNumber(e)?new Date(e):e;return ue(n)?l.map(te(n),e=>e.toISOString({includeOffset:t})):oe(n)},t.fromISO=re,t.datedToYMD=oe,t.toFuzzyDate=se,t.sameDay=function(e,t){return p.eql(se(e),se(t))},t.diffMillis=ae,t.closeTo=function(e,t,n){return l.mapOr(ae(e,t),e=>Math.abs(e)<n,()=>!1)},t.gtDate=function(e,t){const n=ie(e),i=ie(t);return null!=n&&null!=i&&n>i},t.nowish=function(e,t=2500){const n=ie(e),i=Date.now();return g.within(i-t,i+t,n)},t.dateBetween=function(e,t,n=1,i=1){if(null==ie(e)||null==ie(t))return;const[o,s]=[e,t].map(e=>ie(e)).sort(),a=(s-o)/(i+1),u=Q(e),l=u===Q(t)?u:void 0,c=r.DateTime.fromMillis(o+a*n,{zone:l});return[e,t].some(e=>!ue(e))?se(c):c},t.hasTime=ue,t.zoneToOffset=le,t.setZone=function(e,t){return e instanceof r.DateTime?e.setZone(t,{keepLocalTime:!0}):te(e,t)}},function(e,t){e.exports=require("timers")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrSet=void 0,t.getOrSet=function(e,t,n){if(null==t)throw new Error("null key");if(e.has(t))return e.get(t);{const i=n();return null!=i&&e.set(t,i),i}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedMap=void 0;const i=n(71),r=n(210);class o extends i.TTLMap{constructor(e,t,n){super(e,new r.MRUMap(t,n)),this.maxSize=t,this.fifo=n}}t.BoundedMap=o},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.keyedLazy=void 0;const r=n(59),o=n(4),s=n(32),a=n(2),u=n(71),l=n(24),c=n(6),d=n(58),h=n(8);t.keyedLazy=function(e,t,n,f){const m=a.lazy(()=>c.mkLogger("KeyedLazy("+e+")")),p=new u.TTLMap(f.priorResultTtlMs),g=a.lazy(()=>i(this,void 0,void 0,(function*(){try{return yield t()}catch(e){return void m().warn("key() failed: "+e)}})),f.keyTtlMs),v=Math.min(o.secondMs,f.timeoutMs/2,f.priorResultTtlMs/2),y=()=>h.thenMap(g(),t=>p.getOrSet(t,()=>{const i=new d.Deferred(e+":"+t).setTimeout(f.timeoutMs).observe(r.retryOnReject(n,{maxRetries:f.maxRetries,onRetryWaitUntil:e=>s.delay(e*v)}));return i.catch(n=>{l.onError(e+" failed",n),s.delay(v).then(()=>{p.get(t)===i.promise&&p.delete(t)})}),i.promise}));return y.clearKey=()=>{g.unset()},y.clear=()=>{g.unset(),p.clear()},y.prior=()=>h.thenMap(g.prior(),e=>p.get(e)),y.refresh=()=>(y.clear(),y()),y.set=e=>h.thenMap(g.refresh(),t=>{p.clear(),p.set(t,Promise.resolve(e))}),y}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0;const i=n(54),r=n(34),o=n(37),s=n(21),a=n(0),u=n(26),l=n(6),c=n(28),d=n(10),h=n(64);class f{constructor(e){this.name=e,this.start=Date.now(),this.state=u.PromiseStates.pending,this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t}),this.logger=l.mkLogger("Deferred("+this.toString()+")")}toString(){return d.isString(this.name)?this.name:s.stringify(this.name)}[r.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(e=>{this.resolve(e)}).catch(e=>{this.logger.log(c.isTest?"warn":"error","observeQuietly.reject()",e),this.resolve(void 0)}),this}observe(e){return e.then(e=>{this.maybeResolve(e)}).catch(e=>{this.maybeReject(e)}),this}setTimeout(e){return a.map(this.priorTimeout,i.clearTimeout),this.priorTimeout=h.setUnrefTimeout(()=>{if(this.pending){const e="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(e)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===u.PromiseStates.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==u.PromiseStates.pending}get resolved(){return this.state===u.PromiseStates.resolved}get rejected(){return this.state===u.PromiseStates.rejected}get settledMs(){return null==this.end?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=u.PromiseStates.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(c.isTest?"warn":"error",".reject()",e);const t=o.asError(e);return this.settle(()=>{this._error=t,this.state=u.PromiseStates.rejected,this._reject(t)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(t=>e(t))}settle(e){if(this.state===u.PromiseStates.pending){a.map(this.priorTimeout,i.clearTimeout),e(),this.end=Date.now();const t=this.settledMs;if(this.resolved&&t>5e3){const e=t>5e3?"info":"debug";this.logger.log(e,"Completed in "+t+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}}t.Deferred=f},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.retryOnReject=t.thenOrTimeout=void 0;const r=n(32),o=n(0),s=n(5),a=n(18);function u(e,t){return i(this,void 0,void 0,(function*(){let n;return Promise.race([e().then(e=>null==n?(n=!0,e):void 0),r.unrefDelay(t).then(()=>{if(null==n)throw n=!1,new Error("timeout")})])}))}t.thenOrTimeout=u,t.retryOnReject=function(e,t){return i(this,void 0,void 0,(function*(){const n=s.gt0(t.timeoutMs)?()=>u(e,t.timeoutMs):e;if(t.maxRetries<=0)return n();const l=a.Opt(t.errorIsRetriable).getOrElse(()=>()=>!0),c=a.Opt(t.onRetryWaitUntil).getOrElse(()=>e=>r.delay(250*o.orElse(e,1)));let d=0;const h=()=>i(this,void 0,void 0,(function*(){try{return yield n()}catch(e){if((yield l(e))&&d<t.maxRetries)return d++,yield c(d),h();throw e}}));return h()}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TokenRadix=t.GeoRadix=t.RadixAlphaNum=t.Radix58=t.Hex=t.Radix=void 0;const i=n(109),r=n(3),o=n(0),s=n(211),a=n(25),u=n(10),l=BigInt(0);class c{constructor(e,t,n=a.identity){this.name=e,this.numerals=t,this.decodePreparser=n,this.base=t.length}digitsToNumerals(e){return e.map(e=>this.numerals[e]).join("")}encode(e,t=0){const n=[],i=e<0;if(i&&t--,0===(e=Math.abs(e)))n.push(0);else for(;e>0;)n.push(e%this.base),e=Math.floor(e/this.base);for(;n.length<t;)n.push(0);return(i?"-":"")+this.digitsToNumerals(n.reverse())}encodeBigInt(e){if("bigint"!=typeof e)throw new Error("bad input");if(e===l)return this.numerals[0];const t=[],n=BigInt(this.base);let i=e;for(;i>l;)t.push(Number(i%n)),i/=n;return this.digitsToNumerals(t.reverse())}encodeBuffer(e){if(null==e||0===e.length)return"";const t=[0];for(let n of e)for(t.forEach((e,i)=>{n+=e<<8,t[i]=n%this.base,n=Math.floor(n/this.base)});n>0;)t.push(n%this.base),n=Math.floor(n/this.base);return this.digitsToNumerals(t.reverse())}decode(e){return o.map(this.decodeBigInt(e),t=>{if(t>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(t)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(null==e||r.blank(e))return;const t="-"===(e=this.decodePreparser(e))[0];t&&(e=e.slice(1));const n=BigInt(this.base);let i=BigInt(0);for(const t of e){const e=this.numerals.indexOf(t);if(e<0)return;i=i*n+BigInt(e)}return t?BigInt(-1)*i:i}randomChars(e){return this.encodeBuffer(i.randomBytes(e+3)).slice(1,e+1)}randomUid(e=20,t=5){return u.splitEvery(this.randomChars(e),t).join("-")}safeRandomUid(e,t=5){let n="";do{n=this.randomUid(e,t)}while(s.isCussy(n));return n}}t.Radix=c,t.Hex=new c("hex","0123456789abcdef",e=>e.toLowerCase()),t.Radix58=new c("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.RadixAlphaNum=new c("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",e=>e.toLowerCase()),t.GeoRadix=new c("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",e=>e.toLowerCase()),t.TokenRadix=new c("TokenRadix","0123456789abcdefghjkmnpqrtuvwxyz",e=>e.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[s]/g,"5"))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEnvTrue=t.getEnv=void 0;const i=n(19),r=n(11),o=n(22);function s(e){return r.firstValueCaseInsensitive(i.env,e)}t.getEnv=s,t.isEnvTrue=function(e){return o.isTrue(s(e))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ByteCounter=t.remoteDesc=t.pipelineAsync=t.closeStreams=t.onError=t.close=t.end=t.PassthroughStream=t.ReadableBuffer=void 0;const r=n(142),o=n(34),s=n(32),a=n(0),u=n(11),l=n(45),c=n(17),d=n(24),h=n(25);class f extends r.Readable{constructor(e){super(),this.push(e),this.push(null)}}t.ReadableBuffer=f;class m extends r.Duplex{_write(e,t){this.push(e,t)}}t.PassthroughStream=m,t.end=function(e){return i(this,void 0,void 0,(function*(){null!=e&&(h.Try(()=>u.maybeCall(e,"unref")),c.ending()?e.end(null):yield new Promise(t=>e.end(null,t)),yield s.delay(50),h.Try(()=>u.maybeCall(e,"destroy")))}))},t.close=function(e){return i(this,void 0,void 0,(function*(){null!=e&&(h.Try(()=>u.maybeCall(e,"unref")),c.ending()?e.close(l.NoOp):yield new Promise(t=>e.close(t)))}))},t.onError=function(e,t){[{name:"cp",ea:e},{name:"stdin",ea:e.stdin},{name:"stdout",ea:e.stdout},{name:"stderr",ea:e.stderr}].forEach(({name:e,ea:n})=>a.map(n,n=>n.on("error",n=>{d.isIgnorableError(n)||t(e,n)})))},t.closeStreams=function(e){null!=e&&[e.stdin,e.stdout,e.stderr].forEach(e=>h.Try(()=>a.map(e,e=>e.destroy())))},t.pipelineAsync=o.promisify(r.pipeline),t.remoteDesc=function(e){return e.destroyed?"destroyed":`${e.remoteFamily}:${e.remoteAddress}:${e.remotePort}`};class p extends r.Transform{constructor(e){super({transform:(e,t,n)=>{this.onProgress(this.bytes+=e.length),n(e)}}),this.onProgress=e,this.bytes=0}}t.ByteCounter=p},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.firstDefinedLater=t.laterPromise=t.Later=void 0;const r=n(22);!function(e){e.and=(...e)=>i(this,void 0,void 0,(function*(){for(const t of e)if(!r.isTrue(yield t()))return!1;return!0})),e.or=(...e)=>i(this,void 0,void 0,(function*(){for(const t of e)if(r.isTrue(yield t()))return!0;return!1}))}(t.Later||(t.Later={})),t.laterPromise=function(e){let t,n;return{promise:new Promise((e,i)=>{t=e,n=i}),later:()=>i(this,void 0,void 0,(function*(){try{const n=yield e();return t(n),n}catch(e){throw n(e),e}}))}},t.firstDefinedLater=function(...e){return i(this,void 0,void 0,(function*(){if(null!=e)for(const t of e){if(null==t)continue;const e=yield t();if(null!=e)return e}}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setUnrefInterval=t.setUnrefTimeout=void 0;const i=n(54),r=n(11);t.setUnrefTimeout=function(e,t,...n){return r.tap(i.setTimeout(e,Math.round(t),...n),e=>e.unref())},t.setUnrefInterval=function(e,t,...n){return r.tap(i.setInterval(e,Math.round(t),...n),e=>e.unref())}},function(e,t){e.exports=require("fs-extra")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gitDate=t.gitSha=t.release=t.version=void 0,t.version="0.8.0-beta.9",t.release="0.8.0-beta.9+20200622024342",t.gitSha="8683f60c7dee07d566906764813bd3d989ea811b",t.gitDate=new Date(1592793822e3)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.minPending=t.maxPending=t.maxCpus=void 0;const i=n(50),r=n(4),o=n(2),s=n(5),a=n(35),u=n(9);t.maxCpus=o.lazy(()=>{const e=(i.freemem()+i.totalmem())/2,t=1*a.GB,n=Math.max(1,Math.floor(e/t)),r=Math.floor(u.Settings.cpuLoadPercent.valueOrDefault/100*i.cpus().length);return s.clamp(1,n,r)},r.minuteMs),t.maxPending=o.lazy(()=>2*t.maxCpus()),t.maxCpus.onChange(()=>t.maxPending.unset()),t.minPending=function(){return s.round((t.maxCpus()+t.maxPending())/2)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.shortFsStringSha=t.shortStringSha=t.stringSha=t.fileSha=t.HashBits=void 0;const r=n(109),o=n(47),s=n(0),a=n(26),u=n(60);function l(e,n=t.HashBits){return r.createHash("sha512").update(e).digest().slice(0,n/8)}function c(e,t=9,n=u.Radix58,i=224){return n.encodeBuffer(l(e,i)).substring(0,t)}t.HashBits=192,t.fileSha=function(e,n){return i(this,void 0,void 0,(function*(){const i=r.createHash("sha512");let u=0;const l=s.orElse(null==n?void 0:n.msbits,t.HashBits)/8;return yield a.thenCollect(e,e=>new Promise((t,r)=>{const s=o.createReadStream(e,{autoClose:!0});s.on("error",e=>r(e)),s.on("data",e=>{var t;u+=e.length,null===(t=null==n?void 0:n.observer)||void 0===t||t.onProgress(u),i.update(e)}),s.on("end",()=>t())})),i.digest().slice(0,l)}))},t.stringSha=l,t.shortStringSha=c,t.shortFsStringSha=function(e,t=15,n=u.GeoRadix,i=224){return c(e,t,n,i)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.thenOpt=t.OptAsync=void 0;const r=n(0);class o{constructor(e){this.a=e}_map(e,t){return i(this,void 0,void 0,(function*(){const n=null!=this.a?yield this.a():void 0,i=s(n)?yield n.get():n;return null!=i?e(i):t()}))}isDefined(){return i(this,void 0,void 0,(function*(){return this._map(()=>!0,()=>!1)}))}isEmpty(){return i(this,void 0,void 0,(function*(){return this._map(()=>!1,()=>!0)}))}get(){return i(this,void 0,void 0,(function*(){return this._map(e=>e,()=>{})}))}getRequired(){return i(this,void 0,void 0,(function*(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}))}exists(e){return i(this,void 0,void 0,(function*(){return this._map(e,()=>!1)}))}map(e){return new o(()=>i(this,void 0,void 0,(function*(){return this._map(e,()=>{})})))}flatMap(e){return new o(()=>i(this,void 0,void 0,(function*(){return this._map(e,()=>{})})))}filter(e){return new o(()=>i(this,void 0,void 0,(function*(){return this._map(t=>i(this,void 0,void 0,(function*(){return(yield e(t))?t:void 0})),()=>{})})))}catch(e){return new o(()=>this.get().catch(t=>i(this,void 0,void 0,(function*(){return e(t)}))))}forEach(e){return new o(()=>i(this,void 0,void 0,(function*(){const t=yield this.get();return yield r.map(t,e),t})))}getOrElse(e){return i(this,void 0,void 0,(function*(){return r.orElse(yield this.get(),e)}))}orElse(e){return new o(()=>i(this,void 0,void 0,(function*(){const t=yield this.get(),n=null==t?yield e():t;return s(n)?n.get():n})))}}function s(e){return e instanceof o}t.OptAsync=o,t.thenOpt=function(e){return s(e)?e:new o(()=>e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timeStats=t.time=t.PromiseTimer=void 0;const i=n(1),r=n(2),o=n(55),s=n(5),a=n(11),u=n(18),l=n(26),c=n(104),d=n(207),h=n(6),f=n(79),m=n(17);class p{constructor(){this.errors=new c.CountingSet,this.times=new Map}time(e,t,n){const i=Date.now();return l.thenTap(t(),t=>{const r=Date.now()-i;this.push(e,r),null!=n&&n(t,r)}).catch(t=>{throw this.errors.incr(e),null!=n&&n(t,Date.now()-i),t})}stats(e){const t=[...this.times.entries()].filter(([t])=>t.startsWith(e)),n=t.reduce((e,t)=>f.Average.merge(t[1],e),new f.Average),i=t.map(([e,t])=>[e,t.stats()]);return a.fromEntries([["merged",n.stats()],...i])}mkElapsed(e){return new d.Elapsed(e,(e,t)=>this.push(e,t))}push(e,t){o.getOrSet(this.times,e,()=>new f.Average).push(t)}weightedAvg(e){return u.Opt(this.times.get(e)).map(e=>e.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[t,n])=>Object.assign(Object.assign({},e),{[t]:n.n}),{})}weightedAvgs(){return a.compactValues([...this.times.entries()].reduce((e,[t,n])=>Object.assign(Object.assign({},e),{[t]:s.mapFinite(n.weightedSampleAvg,s.round)}),{}))}report(){return i.sortBy([...this.times.entries()],([,e])=>-e.avg*e.n).reduce((e,[t,n])=>Object.assign(Object.assign({},e),{[t]:n.stats()}),{})}}t.PromiseTimer=p;const g=r.lazy(()=>a.tap(new p,e=>new m.EndableWrapper("PromiseTimer",()=>{const t=h.mkLogger("PromiseTimer");t.info("timings:\n",e.report()),i.mapNotEmpty(e.errorCounts(),e=>t.warn("error counts:\n",e))},m.EndableRanks.service)));t.time=function(e,t,n){return g().time(e,t,n)},t.timeStats=function(e){return g().stats(e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLMap=t.Entry=void 0;const i=n(0);class r{constructor(e){this.value=e,this.ctime=Date.now()}touch(){this.ctime=Date.now()}}t.Entry=r;class o{constructor(e,t=new Map){this.ttlMs=e,this.store=t,this.expireListeners=[]}get size(){return this.vacuum(),this.store.size}clear(){return this.store.clear(),this}delete(e){return this.store.delete(e)}deleteIf(e){this.store.forEach((t,n)=>{e(n,t.value)&&this.store.delete(n)})}entries(){const e=this;return function*(){for(const[t,n]of e.store.entries())e.expired(t,n)||(yield[t,n.value])}()}forEach(e){this.store.forEach((t,n)=>{this.expired(n,t)||e(t.value,n,this)})}get(e){return i.map(this.store.get(e),t=>this.expired(e,t)?void 0:t.value)}touch(e){i.map(this.store.get(e),e=>e.touch())}pop(e){const t=this.store.get(e);return this.store.delete(e),i.map(t,t=>this.expired(e,t)?void 0:t.value)}has(e){return!this.expired(e,this.store.get(e))}keys(){const e=this;return function*(){for(const[t,n]of e.store.entries())e.expired(t,n)||(yield t)}()}set(e,t){return i.map(this.store.get(e),t=>this.expireListeners.forEach(n=>n(e,t.value))),this.store.set(e,new r(t)),this}values(){const e=this;return function*(){for(const[t,n]of e.store.entries())e.expired(t,n)||(yield n.value)}()}[Symbol.iterator](){return this.entries()}getOrSet(e,t){const n=this.store.get(e);if(this.valid(e,n))return n.touch(),n.value;{const n=t();return this.set(e,n),n}}on(e,t){this.expireListeners.push(t)}valid(e,t){return!this.expired(e,t)}expired(e,t){return null!=t&&t.ctime+this.ttlMs<=Date.now()?(this.store.delete(e),this.expireListeners.forEach(n=>n(e,t.value)),!0):null==t}vacuum(){this.store.forEach((e,t)=>{this.expired(t,e)})}}t.TTLMap=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.arpWin=t.pingWin=t.nslookupWin=t.fsutil=t.wmic=void 0,t.wmic=()=>"wmic",t.fsutil=()=>"fsutil",t.nslookupWin=()=>"nslookup",t.pingWin=()=>"ping",t.arpWin=()=>"arp"},function(e,t){e.exports=require("sharp")},function(e,t){e.exports=require("luxon")},function(e,t,n){"use strict";function i(e,t){return n=>`[${e}m${n}[${t}m`}Object.defineProperty(t,"__esModule",{value:!0}),t.bgWhite=t.bgCyanBright=t.bgMagentaBright=t.bgBlueBright=t.bgYellowBright=t.bgGreenBright=t.bgRedBright=t.bgDarkGrey=t.bgLightGrey=t.bgCyan=t.bgMagenta=t.bgBlue=t.bgYellow=t.bgGreen=t.bgRed=t.bgBlack=t.white=t.cyanBright=t.magentaBright=t.blueBright=t.yellowBright=t.greenBright=t.redBright=t.darkGrey=t.lightGrey=t.cyan=t.magenta=t.blue=t.yellow=t.green=t.red=t.black=void 0,t.black=i(30,39),t.red=i(31,39),t.green=i(32,39),t.yellow=i(33,39),t.blue=i(34,39),t.magenta=i(35,39),t.cyan=i(36,39),t.lightGrey=i(37,39),t.darkGrey=i(90,39),t.redBright=i(91,39),t.greenBright=i(92,39),t.yellowBright=i(93,39),t.blueBright=i(94,39),t.magentaBright=i(95,39),t.cyanBright=i(96,39),t.white=i(97,39),t.bgBlack=i(40,49),t.bgRed=i(41,49),t.bgGreen=i(42,49),t.bgYellow=i(43,49),t.bgBlue=i(44,49),t.bgMagenta=i(45,49),t.bgCyan=i(46,49),t.bgLightGrey=i(47,49),t.bgDarkGrey=i(100,49),t.bgRedBright=i(101,49),t.bgGreenBright=i(102,49),t.bgYellowBright=i(103,49),t.bgBlueBright=i(104,49),t.bgMagentaBright=i(105,49),t.bgCyanBright=i(106,49),t.bgWhite=i(107,49)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Latch=void 0;t.Latch=class{constructor(e){this.id=e,this._state="pending",this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve()).catch(e=>this.reject(e)),this}observeQuietly(e){return e.then(()=>this.resolve()).catch(()=>this.resolve()),this}get pending(){return"pending"===this._state}get settled(){return!this.pending}get resolved(){return"resolved"===this._state}get rejected(){return"rejected"===this._state}get state(){return this._state}then(e){return this.promise.then(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFlushMs=t.dateForLog=void 0;const i=n(74),r=n(75),o=n(9),s=Date.now();t.dateForLog=function(e){const t=o.Settings.logElapsedMs.valueOrDefault?i.Duration.fromMillis(e-s).toFormat("hhhh:mm:ss.SSS"):new Date(e).toISOString();return o.Settings.logColor.valueOrDefault?o.Settings.logElapsedMs.valueOrDefault?r.yellow(t):r.darkGrey(t):t},t.DefaultLogFlushMs=500},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickWeightedRandom=t.sample=t.shuffle=t.pickRandom=t.randomChar=t.randomChars=t.RandomChars=t.randomFloat=t.randomInts=t.randomInt=void 0;const i=n(1),r=n(5);function o(e,t,n=[]){if(e=Math.ceil(e),t=Math.floor(t),i.isNotEmpty(n)&&n.length+10>t-e){const r=i.range(e,t).filter(e=>!n.includes(e));return i.mapNotEmpty(r,e=>e[o(0,r.length)])}const r=Math.floor(Math.random()*(t-e))+e;return n.includes(r)?o(e,t,n):r}function s(e,t){return Math.random()*(t-e)+e}function a(e=t.RandomChars){return e[o(0,e.length)]}function u(e){const t=Array(...e);for(let e=t.length-1;e>0;e-=1){const n=Math.floor(Math.random()*(e+1));e!==n&&([t[e],t[n]]=[t[n],t[e]])}return t}t.randomInt=o,t.randomInts=function(e,t,n){const i=[];for(;i.length<n;)i.push(o(e,t,i));return i},t.randomFloat=s,t.RandomChars="0123456789abcdefghijkmnopqrstuvwxyz",t.randomChars=function(e,n=t.RandomChars){let i="";for(let t=0;t<e;t++)i+=a(n);return i},t.randomChar=a,t.pickRandom=function(e){return e[o(0,e.length)]},t.shuffle=u,t.sample=function(e,t){if(t<e.length/10){const n=new Set;for(;n.size<t;)n.add(o(0,e.length));return[...n.keys()].map(t=>e[t])}return u([...e]).slice(0,t)},t.pickWeightedRandom=function(e){if(i.isEmpty(e))return;const t=e.filter(e=>r.gt0(e.priority));let n=s(0,i.sum(t,e=>e.priority));return t.find(e=>(n-=e.priority,n<=0))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Average=void 0;const i=n(34),r=n(1),o=n(0),s=n(5),a=n(11),u=n(13),l=n(140),c=n(104),d=n(16),h=n(51);class f{constructor(e=20){this.maxSamples=e,this._n=0,this._samples=new l.BoundedList(e)}static merge(e,t){if(0===e.n&&0===t.n)return new f(Math.max(e.maxSamples,t.maxSamples));if(0===e.n)return t.clone();if(0===t.n)return e.clone();if(e.n<=e.maxSamples){const n=t.clone();return n.pushAll(e.samples),n}if(t.n<=t.maxSamples){const n=e.clone();return n.pushAll(t.samples),n}{const n=new f(Math.max(e.maxSamples,t.maxSamples));n._n=e.n+t.n,n._avg=e._avg*e.n/n.n+t._avg*t.n/n.n,n._min=Math.min(e._min,t._min),n._max=Math.max(e._max,t._max),n._m=e._m*e.n/n.n+t._m*t.n/n.n,n._s=e._s*e.n/n.n+t._s*t.n/n.n;const i=r.flatten(u.zip(e.samples,t.samples));return n._samples.push(...i),n._weightedTotalAvg=h.weightedAvg([n._avg,...i]),n}}[i.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=null==this._min?e:Math.min(e,this._min),this._max=null==this._max?e:Math.max(e,this._max),1===this._n||null==this._m||null==this._s||null==this._avg||null==this._weightedTotalAvg)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{const t=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-t)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return a.tap(new f(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){e.forEach(e=>this.push(e))}stats(e=2){const t=t=>o.map(t,t=>s.sigFigs(t,e)),n={};return this.empty||(n.mean=t(this.avg),n.mode=t(this.sampleMode),n.sd=t(this.stdDev),n.max=t(this.max),n.min=t(this.min)),n.k=s.sigFigs(this.n,e),n}get empty(){return 0===this._n}get n(){return this._n}get avg(){return this.empty?void 0:s.sigFigs(this._avg,4)}get max(){return this._max}get min(){return this._min}get p84(){return d.mapGt0(this.avg,e=>d.mapGt0(this.stdDev,t=>e+t))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return o.map(this.variance,Math.sqrt)}get sampleMode(){return o.map(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;const t=new c.CountingSet;return this._samples.forEach(e=>t.incr(e)),t.topKeys(e)}get sampleStdDev(){return r.mapNotEmpty(this._samples,h.stdDev)}get sampleAvg(){return r.mapNotEmpty(this._samples,h.avg)}get sampleSlope(){return o.orElse(r.mapNotEmpty(this._samples,h.slope),0)}get samples(){return[...this._samples]}p(e){if(0===this._samples.length)return 0;const t=[...this._samples].sort((e,t)=>e-t);return t[Math.floor(t.length*(e/100))]}get weightedSampleAvg(){return r.mapNotEmpty(this._samples,e=>s.sigFigs(h.weightedAvg(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}}t.Average=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoize=void 0;const i=n(21),r=n(11),o=n(26),s=n(56);t.memoize=function(e,t,n){let a=0;const u=new s.BoundedMap(t,n,!0),l=t=>(a++,u.getOrSet(i.stringify(t),()=>r.tap(e(t),e=>{o.isPromise(e)&&e.catch(()=>l.clear())})));return l.clear=e=>null==e?u.clear():u.delete(i.stringify(e)),l.prior=()=>new Map(u.entries()),l.size=()=>u.size,l.callCount=()=>a,l}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isVideoMimeType=void 0;const i=n(3);t.isVideoMimeType=function(e){return i.notBlank(e)&&(e.startsWith("video/")||"application/mp4"==e||"application/ogg"==e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fixed=t.parseFixed=void 0;const i=n(1),r=n(3),o=n(2),s=n(0),a=n(5),u=n(11),l=n(15),c=n(7),d=n(6),h=n(89),f=n(10);class m{constructor(e){this.h=e,this.text=s.orElse(e.text,c.toS(e)),this.greedyLeft=s.orElse(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}}const p=o.lazy(()=>d.mkLogger("Fixed"));t.parseFixed=function(e,t,n=!0){return new g(e,t,n).entries};class g{constructor(e,t,n=!0){this.warnIfMissingHeaders=n;const o=t.split(/[\r\n]{1,2}/);this.headerRow=o[0],this.rows=o.slice(1);const s=Math.max(...this.rows.map(e=>e.length));this.col2blanks=new Map(a.times(s,e=>[e,i.count(this.rows,t=>r.blank(t[e]))])),this.headers=this.extractHeaders(e.map(e=>new m(e))),this.entries=this.rows.map(e=>this.headers.map(t=>t.toEntry(e))).map(e=>u.fromEntries(e)).filter(e=>u.values(e).some(r.notBlank))}extractHeaders(e){let t=this.headerRow;i.sortBy(e,e=>-e.text.length),e.forEach(e=>{const n=new RegExp(`\\b${e.text}\\b`,"i"),i=n.exec(t);null==i?this.warnIfMissingHeaders&&p().warn("extractHeaders(): Failed to find header!",{re:n,headerLine:t}):(e.indexOf=i.index,t=f.padReplace(t,i.index,e.text.length," "))});const n=e.filter(e=>null!=e.indexOf),r=i.sortBy(n,e=>e.indexOf);r.forEach((e,t)=>{const n=e.indexOf,i=r[t-1],o=0===t?0:i.indexOf+i.text.length-1,[a,u]=e.greedyLeft?[o,n]:[n,o];e.leftIdx=s.map(this.firstBlankColumn(a,u),e=>e+1),0===t&&null==e.leftIdx&&(e.leftIdx=0),null==e.leftIdx&&p().warn("no blank column for "+e.text+" between "+n+" and "+o)}),i.filterInPlace(r,e=>null!=e.leftIdx),r.slice(0,-1).forEach((e,t)=>{const n=r[t+1];e.rightIdx=n.leftIdx-1});const o=l.toA(h.diff(e.map(e=>e.text),r.map(e=>e.text)));return o.length>0&&p().warn("Missing headers",{missingHeaders:o}),r}firstBlankColumn(e,t){return i.range(e,t).find(e=>this.col2blanks.get(e)===this.rows.length)}}t.Fixed=g},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitLines=t.crlf=void 0;const i=n(1),r=n(14),o=n(10),s=n(7);t.crlf=function(e){const t=e+"\n";return r.isWin?t.replace(o.newlineRe,"\r\n"):t},t.splitLines=function(...e){return i.flatten(e.map(e=>s.toS(e).split(o.newlineRe)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dmegapixels=t.isPortrait=t.maybeFlipInPlace=t.maybeFlip=t.flip=t.dimToSize=t.dimToS=t.isDimensions=void 0;const i=n(5),r=n(108),o=n(35);function s(e){return{width:e.height,height:e.width}}t.isDimensions=function(e){return null!=e&&i.gt0(e.width)&&i.gt0(e.height)},t.dimToS=function(e){return`${e.width} Ã ${e.height}`},t.dimToSize=function(e){return o.pixels2size(e.width*e.height)},t.flip=s,t.maybeFlip=function(e,t){return r.flippable(t)?s(e):e},t.maybeFlipInPlace=function(e,t){r.flippable(t)&&([e.width,e.height]=[e.height,e.width])},t.isPortrait=function(e){return e.width/e.height<1},t.dmegapixels=function(e){return o.megapixels(e.width*e.height)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.inverse=t.getLike=t.pickKeys=t.filterInPlace=t.filter=t.toObj=t.toMapAsync=t.toMap=t.compactMap=t.flatMap=t.getOrSetAsync=t.hasAll=void 0;const r=n(1),o=n(0),s=n(15),a=n(13);function u(e){const t=r.compact(e).filter(([e,t])=>null!=e&&null!=t);return new Map(t)}function l(e,t){return new Map([...e.entries()].filter(([e,n])=>t(e,n)))}t.hasAll=function(e,t){return t.every(t=>e.has(t))},t.getOrSetAsync=function(e,t,n){return i(this,void 0,void 0,(function*(){const i=e.get(t);if(null!=i)return i;const r=Promise.resolve(n(t));return e.set(t,r),r.then(n=>{null==n?e.delete(t):e.set(t,n)}),r.catch(()=>{e.delete(t)}),r}))},t.flatMap=function(e,t){return new Map(a.concat(...e.map(e=>t(e))))},t.compactMap=u,t.toMap=function(e,t){return u(r.compact(e).map(t))},t.toMapAsync=function(e,t){return i(this,void 0,void 0,(function*(){if(null==e)return new Map;return u(yield Promise.all(r.compact(s.toA(e)).map(e=>t(e))))}))},t.toObj=function(e){const t={};for(const[n,i]of e)t[n]=i;return t},t.filter=l,t.filterInPlace=function(e,t){[...e.entries()].forEach(([n,i])=>t(n,i)||e.delete(n))},t.pickKeys=function(e,t){return l(e,e=>t.indexOf(e)>=0)},t.getLike=function(e,t){return o.map([...e.entries()].find(([e])=>t(e)),([,e])=>e)},t.inverse=function(e){return new Map([...e.entries()].map(([e,t])=>[t,e]))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.homeDir=void 0;const i=n(50),r=n(31),o=n(1),s=n(2),a=n(61),u=n(30),l=n(14);t.homeDir=s.lazy(()=>{const e=[];l.isWin?e.push(a.getEnv("HOMEPATH"),a.getEnv("USERPROFILE")):e.push(a.getEnv("HOME"));for(const t of o.compactBlanks(e)){const e=r.resolve(t);if(u.isDirectorySync(e))return e}return i.homedir()})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PS_NETWORK_FILESYSTEM_PROTOCOL=t.PS_LOCAL_FILE_PROTOCOL=t.PS_LIBRARY_PROTOCOL=t.parent=t.joinQuery=void 0;const i=n(31),r=n(1),o=n(11),s=n(7);t.joinQuery=function(e,t){if(null==t)return e;const n=o.entries(t).filter(([,e])=>null!=e);return r.isEmpty(n)?e:e+"?"+n.map(e=>e.map(s.toS).map(encodeURIComponent).join("=")).join("&")},t.parent=function(e){return i.posix.parse(e).dir},t.PS_LIBRARY_PROTOCOL="pslib:",t.PS_LOCAL_FILE_PROTOCOL="psfile:",t.PS_NETWORK_FILESYSTEM_PROTOCOL="psnet:"},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.nukeSettings=t.clearSettings=t.writeLibrarySettings=t.readLibrarySettings=t.writeSystemSettings=t.stringifyToml=t.currentVersion=t.libraryPathHasSettings=t.libraryHasSettings=t.librarySettingsVersion=t.systemSettingsVersion=t.savedLibraryPath=t.envOrSavedLibraryPath=t.readSystemSettings=t.libraryTxtFile=t.librarySettingsFile=t.systemSettingsFile=void 0;const r=n(235),o=n(1),s=n(3),a=n(37),u=n(21),l=n(2),c=n(0),d=n(11),h=n(15),f=n(7),m=n(48),p=n(13),g=n(8),v=n(46),y=n(12),b=n(83),S=n(33),w=n(6),M=n(10),P=n(66),E=n(91),x=n(139),T=n(9),O=w.mkLogger("SettingsIO");function F(){return S.PosixFile.for(m.App.getPath("userData")).join("settings.toml")}function _(e){return p.first([e,T.Settings.libraryPath.value],e=>s.mapNotBlank(e,e=>c.map(E.libraryDataDir(e),e=>e.join("settings.toml"))))}function D(){return S.PosixFile.for(m.App.getPath("userData")).join("library.txt")}function C(){return g.thenMap(j(F()),e=>e[T.Settings.libraryPath.name])}function I(e){const t=_(e);return O.tap({msg:"libraryPathHasSettings",result:c.orElse(null==t?void 0:t.existsSync(),!1),meta:{librarySettingsFile:null==t?void 0:t.nativePath}})}t.systemSettingsFile=F,t.librarySettingsFile=_,t.libraryTxtFile=D,t.readSystemSettings=function(e=F()){return i(this,void 0,void 0,(function*(){const n=yield g.thenOrElse(V(e),()=>[]);return s.blank(T.Settings.libraryPath.value)&&s.notBlank(yield function(){return i(this,void 0,void 0,(function*(){if(!t.libraryHasSettings()){const e=D().clear();if(yield e.isNonEmpty()){const t=f.toS(yield e.readFile());if(s.notBlank(t))return O.info("Importing old library.txt file",{priorPath:t,libraryTxt:e}),T.Settings.libraryPath.value=t,null!=(yield N())&&(yield e.renameWithNameSuffix("-obsolete")),t}}}))}())&&o.pushUniq(n,T.Settings.libraryPath),n}))},t.envOrSavedLibraryPath=function(){var e;return null!==(e=T.Settings.libraryPath.value)&&void 0!==e?e:C()},t.savedLibraryPath=C,t.systemSettingsVersion=function(){return i(this,void 0,void 0,(function*(){return k(F())}))},t.librarySettingsVersion=function(e){return i(this,void 0,void 0,(function*(){return c.map(_(e),e=>k(e))}))},t.libraryHasSettings=l.lazy(()=>I()),t.libraryPathHasSettings=I,T.Settings.libraryPath.addListener(()=>t.libraryHasSettings.unset()),y.onSettingsChanged(()=>t.libraryHasSettings.unset());const A=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;function k(e){return i(this,void 0,void 0,(function*(){return g.thenMap(e.firstMatchingLine(A),e=>e[1])}))}const L={maxLineLen:80,prefix:"# "};function B(e,n){return i(this,void 0,void 0,(function*(){const r=yield e.clear().isNonEmpty(),s=r?yield e.wip():e;O.info("maybeWriteFile(): writing settings",{file:e}),yield function(e,n,r){return i(this,void 0,void 0,(function*(){const i=c.orElse(yield j(r),{}),s=o.flatten(["","Hello!","","These are settings for PhotoStructure, and are formatted using TOML. See <https://github.com/toml-lang/toml>.","","NOTE: Please shut down PhotoStructure before editing this file.","",'Most settings have reasonable defaults, which are provided after the description. Remove the "#" from the beginning of the line to override the default. See <https://photostructure.com/getting-started/advanced-settings/#editing-toml> for details.',"","Thanks for using PhotoStructure! Visit <https://support.photostructure.com> or email <support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+t.currentVersion()].map(e=>M.wrap(e,L)));s.push("",""),n.forEach(e=>{const t=o.compactBlanks([e.key,...h.toA(e.opts.alternateKeys)]),n="# +"+M.padding("â",e.name.length+4)+"+",r=d.entries(Object.assign({env:1===t.length?t[0]:t},e.addToJSON())).map(([e,t])=>`${e}: ${u.stringify(t)}`).join(", ");s.push(...M.wrap([n,"|  "+e.name+"  |",n,"",""+e.opts.description,`(${r})`,""].join("\n"),L));const a=i[e.name],l={},c=e.valueToPersist(a);null!=c?(l[e.name]=c,s.push(...R(l))):(l[e.name]=e.exampleValue,s.push(...R(l).map(e=>"# "+e))),s.push("","")}),yield e.writeTxt("\n"+s.map(e=>e.trimRight()).join("\n")+"\n\n"),y.emitSettingsChanged()}))}(s,n,e),r&&((yield g.thenNot(v.eqlAsync(j(s),j(e))))&&(O.info("Archiving prior, different contents",{dest:s,file:e}),yield e.renameYMDHMS("old")),yield s.unwip())}))}function R(e){return b.splitLines(...d.entries(e).map(([e,t])=>e+" = "+u.stringify(t,void 0,2)))}function N(e=F()){return i(this,void 0,void 0,(function*(){return B(e,T.persistedSystemSettings())}))}function j(e){return i(this,void 0,void 0,(function*(){return g.thenMap(e.readFile(),t=>O.tap({msg:`read(${e})`,result:r.parse(M.dumbquote(t.toString()))}))}))}function V(e){return i(this,void 0,void 0,(function*(){const t=w.mkLogger("SettingsIO.importFileSettings("+e.nativePath+")");try{t.debug("ENV before",T.psenv());const n=yield j(e);if(null==n){if(yield e.isNonEmpty())throw new Error("Failed to read "+e);return[]}const i=new Map(d.entries(T.Settings).filter(([,e])=>e instanceof x.Setting&&!e.transient).map(([e,t])=>[e.toLowerCase(),t])),r=o.compact(d.entries(n).map(([e,n])=>{const r=i.get(f.toS(e).toLowerCase());return null==r?t.warn("Failed to import (no setting with this name)",{key:e}):r.importFromFile(n),r}));return t.info("loaded",{tomlMap:n,imported:r.map(e=>d.pick(e,"name","value","persist"))}),r}catch(e){return void t.error("Cannot read"+a.errorToVerbose(e))}}))}t.currentVersion=l.lazy(()=>P.version),t.stringifyToml=R,t.writeSystemSettings=N,t.readLibrarySettings=function(e){return i(this,void 0,void 0,(function*(){return c.map(_(e),e=>V(e))}))},t.writeLibrarySettings=function(e){return i(this,void 0,void 0,(function*(){yield E.setupLibraryDataDir(s.firstNotBlank(e,T.Settings.libraryPath.value));const n=_(e);return O.warn("writeLibrarySettings("+n+")"),yield c.map(n,e=>B(e,T.persistedLibrarySettings())),t.libraryHasSettings.clear(),n}))};const z=l.lazy(()=>new Set([T.Settings.logLevel,T.Settings.httpPort,T.Settings.rpcPort].map(e=>e.key)));function W(){d.values(T.Settings).filter(e=>!z().has(e.key)).forEach(e=>e.unset()),y.emitClearCache(),y.emitSettingsChanged()}t.clearSettings=W,t.nukeSettings=function(){return i(this,void 0,void 0,(function*(){yield F().unlink("debug"),yield c.map(_(),e=>e.unlink("debug")),W()}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.diff=t.intersection=t.union=t.getOrAdd=t.setEql=t.asSet=void 0;const i=n(15);function r(e){return e instanceof Set?e:new Set(i.toA(e))}t.asSet=r,t.setEql=function(e,t){return i.toA(e.keys()).every(e=>t.has(e))&&i.toA(t.keys()).every(t=>e.has(t))},t.getOrAdd=function(e,t,n){if(null==t)throw new Error("null key");return e.has(t)?void 0:(e.add(t),n())},t.union=function(e,t){return new Set([...e,...t])},t.intersection=function(e,t){const n=r(t);return new Set([...e].filter(e=>n.has(e)))},t.diff=function(e,t){const n=r(t);return new Set([...e].filter(e=>!n.has(e)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIterable=void 0,t.isIterable=function(e){return null!=e&&"string"!=typeof e&&"function"==typeof e[Symbol.iterator]}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setupLibraryDataDir=t.libraryDataDir=void 0;const r=n(3),o=n(33),s=n(66),a=n(9),u="\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n\nMoving or deleting any files here will cause problems using your library.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v"+s.version;function l(e=a.Settings.libraryPath.value){return r.mapNotBlank(e,e=>o.PosixFile.for(e).join(".photostructure"))}t.libraryDataDir=l,t.setupLibraryDataDir=function(e){return i(this,void 0,void 0,(function*(){const t=l(e);if(null==t)throw new Error("empty dataDir");if(null==(yield t.mkdirp()))throw new Error("Could not mkdirp "+t);yield t.mkNoMedia();const n=t.join("README.txt");return(yield n.size())!==u.length&&(yield n.writeTxt(u)),t}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toID=t.TimestampedModel=void 0;const i=n(16),r=n(0),o=n(5),s=n(185);class a extends s.Model{static touch(e){return this.dbr(t=>t.exec(this.query().whereIn("id",e).update("updatedAt",Date.now())))}toID(){return"updateCount"in this&&(this.updateCount=i.mapGt0Or(this.updateCount,e=>e,1)),u(this)}get createdAtDate(){return i.mapGt0(this.createdAt,e=>new Date(e))}get updatedAtDate(){return i.mapGt0(this.updatedAt,e=>new Date(e))}$beforeUpsert(){null==this.createdAt&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this&&(this.updateCount=i.mapGt0Or(this.updateCount,e=>e+1,1))}$beforeInsert(){this.$beforeUpsert()}$beforeUpdate(){this.$beforeUpsert()}}function u(e){return r.map(e,e=>({id:e.id,v:o.numericOr(e.updateCount,0)}))}t.TimestampedModel=a,t.toID=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rate=void 0;const i=n(34),r=n(4),o=n(5),s=n(16),a=n(190),u=n(51);class l{constructor(e){if(this.ttlMs=e,this._eventCount=0,this._lastEventTime=0,e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new a.TTLArray(e)}[i.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){const e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return s.mapGt0(this.eventDeltas.length,()=>u.weightedAvg(this.eventDeltas))}get msPerEvent(){return u.avg(this.eventDeltas)}get eventsPerMs(){return s.mapGte0f(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return s.mapGte0f(this.eventsPerMs,e=>o.sigFigs(r.secondMs*e,3))}get eventsPerMinute(){return s.mapGte0f(this.eventsPerMs,e=>o.sigFigs(r.minuteMs*e,3))}}t.Rate=l},function(e,t){e.exports=require("batch-cluster")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.bestRemoteVolume=t.remoteVolumeFor=t.bestVolume=t.volumeFor=t.rootVolume=t.rootPath=t.volumes=t.setRpcVolumesImpl=void 0;const r=n(1),o=n(3),s=n(4),a=n(2),u=n(0),l=n(18),c=n(13),d=n(57),h=n(63),f=n(8),m=n(22),p=n(61),g=n(46),v=n(24),y=n(12),b=n(30),S=n(6),w=n(168),M=n(14),P=n(10),E=n(243),x=n(244),T=n(246),O=n(247),F=n(248),_=n(38),D=n(249),C=n(169),I=n(23),A=n(250),k=a.lazy(()=>S.mkLogger("Volumes"));function L(){return i(this,void 0,void 0,(function*(){const e=yield M.isWin?x.dfWin():E.dfPosix();if(null==e)return void k().warn("df failed");e.some(e=>e.remote&&o.blank(e.remoteHost))&&(yield f.thenOrTimeout(M.isWin?C.addRemoteVolumeInfoWin(e):D.addRemoteVolumeInfoPosix(e),10*s.secondMs).catch(e=>{v.onError("Failed to get remote volume info",e)}));const t=u.orElse(yield M.isWin?F.addLocalVolumeInfoWin(e):M.isMac?T.addLocalVolumeInfoMac(e):O.addLocalVolumeInfoPosix(e),e);r.filterInPlace(t,e=>!m.isTrue(e.ignorable)&&!m.isFalse(e.remoteOK));for(const e of t)e.remote=m.isTrue(e.remote),o.mapNotBlank(e.remoteHost,t=>e.remoteHost=t.toLowerCase().normalize().trim());yield A.addVolumeUUIDs(t);const n=r.sortBy(t,e=>e.mountpoint);return k().debug("_volumes(): final result",{sorted:n}),Object.freeze(n)}))}let B;t.setRpcVolumesImpl=function(e){B=e};let R=[];function N(e){return i(this,void 0,void 0,(function*(){return f.thenMap(t.volumes(),t=>j(t,e))}))}function j(e,t){const n=e.filter(e=>b.containedByNativePath(t,e.mountpoint));return c.greatestBy(n,e=>r.commonPrefixLength(e.mountpoint,t))}function V(e,t,n){return i(this,void 0,void 0,(function*(){const s=n.filter(e=>P.equalsIgnoreCase(t,e.remoteShare));if(r.isEmpty(s))return;const a=s.find(t=>m.isTrue(t.remote)&&o.notBlank(t.remoteHost)&&P.equalsIgnoreCase(e,t.remoteHost));if(null!=a)return a;const u=yield w.friendlyname(e);return f.asyncFind(s,e=>i(this,void 0,void 0,(function*(){return P.equalsIgnoreCase(u,yield w.friendlyname(e.remoteHost))})))}))}t.volumes=d.keyedLazy("volumes",_.mountsCacheKey,()=>i(void 0,void 0,void 0,(function*(){try{const e=yield h.firstDefinedLater(B,L);return r.mapNotEmpty(e,e=>{const t=e.map(e=>e.mountpoint).sort();g.eql(R,t)||(y.emitVolumesChanged(),R=t)}),e}catch(e){return void v.onError("volumes() failed",e)}})),I.KeyedLazyVolumeOpts),y.onClearCache(()=>t.volumes.clear()),t.rootPath=a.lazy(()=>M.isWin?l.Opt(p.getEnv("SystemDrive")).filter(o.notBlank).orElse(()=>"C:").map(e=>P.ensureSuffix(e,"\\")).get():"/"),t.rootVolume=function(){return N(t.rootPath())},t.volumeFor=N,t.bestVolume=j,t.remoteVolumeFor=function(e,n){return i(this,void 0,void 0,(function*(){return f.thenMap(t.volumes(),t=>V(e,n,t))}))},t.bestRemoteVolume=V},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReducerNames=void 0;const i=n(36);t.ReducerNames=i.strEnum("fit","sq")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlStrings=t.wrap=t.leftIndexOf=t.newlineRe=t.ensureSuffix=t.ensurePrefix=void 0;const i=n(1),r=n(7);function o(e,t){return e=r.toS(e),t=r.toS(t),e.startsWith(t)?e:t+e}function s(e,t,n){null==n&&(n=e.length);for(let i=n;i>=0;i--)if(e.substr(i).startsWith(t))return i;return-1}t.ensurePrefix=o,t.ensureSuffix=function(e,t){return e=r.toS(e),t=r.toS(t),e.endsWith(t)?e:e+t},t.newlineRe=/\r?\n/gm,t.leftIndexOf=s,t.wrap=function e(n,a={maxLineLen:75,prefix:""}){if(n.includes("\n"))return i.flatten(n.split(t.newlineRe).map(t=>e(t,a)));if((n=o(r.toS(n).trim(),a.prefix).trim()).length<=a.maxLineLen)return[n];const u=s(n," ",a.maxLineLen);if(u>a.prefix.length)return[n.slice(0,u),...e(n.slice(u+1),a)];{const t=n.indexOf(" ",a.prefix.length+1);return t>0&&t<n.length-1?[n.slice(0,t),...e(n.slice(t+1),a)]:[n]}},t.eqlStrings=function(e,t){return null!=e&&null!=t&&e.normalize()==t.normalize()}},function(e,t){e.exports=require("exiftool-vendored")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ContextualLogger=t.safeLogger=t.NoOpLogger=t.ms2level=void 0;const r=n(34),o=n(37),s=n(0),a=n(45),u=n(7),l=n(25),c=n(52),d=n(106),h=n(145);function f(e){return i(this,void 0,void 0,(function*(){try{return yield e()}catch(e){return}}))}t.ms2level=function(e,t){return e>=t?"error":e>=t/2?"warn":e>=t/4?"info":"debug"},t.NoOpLogger={log:a.NoOp,flush:()=>Promise.resolve(),end:a.NoOp,error:a.NoOp,warn:a.NoOp,info:a.NoOp,debug:a.NoOp,trace:a.NoOp},t.safeLogger=function(e){return{log:(t,n,i,r)=>l.Try(()=>e.log(t,n,i,r)),flush:()=>f(()=>e.flush()),end:()=>f(()=>e.end())}};const m=/^[a-z]*/i;class p{constructor(e,t){this.context=e,this.loggers=t,this.error=(e,t)=>{this.log("error",e,t)},this.warn=(e,t)=>{this.log("warn",e,t)},this.info=(e,t)=>{this.log("info",e,t)},this.debug=(e,t)=>{this.log("debug",e,t)},this.trace=(e,t)=>{this.log("trace",e,t)},this.filterContext=s.mapOr(m.exec(u.toS(this.context)),e=>e[0],()=>this.context)}addContext(e){return new p(this.context+e,this.loggers)}throw(e,t){const n=new c.WrappedError({cause:o.asError(e),message:this.context+s.mapOr(t,r.inspect,()=>""),fatal:null==t?void 0:t.fatal});throw this.log("error",o.errorToVerbose(e),t),n}tap(e){return this.log(s.orElse(e.level,"debug"),e.msg,Object.assign({result:e.result},e.meta)),e.result}log(e,t,n){if(d.logFilter().enabled(e,this.context))for(const i of this.loggers())i.log(e,this.context,t,o.isError(n)?o.errorToS(n):n);else"trace"!==e&&h.addRecentLogEntry({ts:Date.now(),l:e,ctx:this.context,msg:t,meta:n})}flush(){return i(this,void 0,void 0,(function*(){for(const e of this.loggers())yield e.flush()}))}end(){return i(this,void 0,void 0,(function*(){for(const e of this.loggers())yield e.end()}))}}t.ContextualLogger=p},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupByValues=t.groupBy=t.MultiMap=void 0;const i=n(1),r=n(55),o=n(0),s=n(11),a=n(15),u=n(13),l=n(51);class c{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return l.sum([...this.store.values()].map(e=>e.length))}add(e,t){return s.tap(r.getOrSet(this.store,e,()=>[]),e=>e.push(t))}delete(e,t){if(null==t)return this.store.delete(e);{const n=this.store.get(e);if(null==n)return!1;{const i=u.remove(n,t);return i&&0===n.length&&this.store.delete(e),i}}}clear(){return this.store.clear(),this}keys(){const e=this;return function*(){for(const[t,n]of e.store.entries())n.length>0&&(yield t)}()}values(){const e=this;return function*(){for(const[,t]of e.store.entries())t.length>0&&(yield t)}()}flatValues(){const e=this;return function*(){for(const[,t]of e.store.entries())if(t.length>0)for(const e of t)yield e}()}entriesArray(){return[...this.store.entries()].filter(([,e])=>i.isNotEmpty(e))}entries(){const e=this;return function*(){for(const[t,n]of e.store.entries())n.length>0&&(yield[t,n])}()}tuples(){const e=this;return function*(){for(const[t,n]of e.store.entries())for(const e of a.toA(n))null!=e&&(yield[t,e])}()}filterInPlace(e){let t=!1;for(const[n,r]of this.store.entries()){const o=r.length;i.filterInPlace(r,t=>e(n,t)),t=t||o!==r.length}return t}}function d(e,t){const n=new c;return e.forEach(e=>o.map(t(e),t=>n.add(t,e))),n}t.MultiMap=c,t.groupBy=d,t.groupByValues=function(e,t){const n=d(e,t);return i.sortBy(a.toA(n.values()),e=>t(e[0]))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ProcCleaner=t.addPid=t.Pids=t.pidNotExists=t.pidExists=t.kill=void 0;const r=n(94),o=n(19),s=n(1),a=n(3),u=n(4),l=n(2),c=n(0),d=n(5),h=n(18),f=n(15),m=n(7),p=n(48),g=n(17),v=n(8),y=n(44),b=n(64),S=n(27),w=n(24),M=n(41),P=n(30),E=n(6),x=n(85),T=n(16),O=n(25),F=n(14),_=n(166),D=n(43),C=l.lazy(()=>E.mkLogger("Pids")),I=10*u.secondMs;function A(e,t){if(null==e||null==t)return!1;const n=c.map(t.start,e=>e.getTime()),i=e.startTime;return d.gt0(n)&&d.gt0(i)&&Math.abs(n-i)<I}function k(e,t){return i(this,void 0,void 0,(function*(){return null!=e&&null!=t&&(e.name===m.toS(t.pid)&&A(yield e.readJSON(),t))}))}function L(e,t=!1,n=!0){if(e===o.pid||e===o.ppid)throw new Error("cannot self-terminate");return t&&n&&R.instance().onKill(e),F.isWin?function(e,t=!1){return i(this,void 0,void 0,(function*(){if(g.ending()||D.PowerShell.instance().ended)return r.kill(e,t);try{const n=s.compact(["Stop-Process","-Id",d.toInt(e),t?"-Force":void 0]).join(" ");yield D.PowerShell.instance().execute(n,O.identity)}catch(n){C().warn("killWin(): pwsh error, using TASKKILL: "+n),r.kill(e,t)}}))}(e,t):function(e,t=!1){return i(this,void 0,void 0,(function*(){try{o.kill(e,t?"SIGKILL":"SIGTERM")}catch(e){if(!String(e).includes("ESRCH"))throw e}}))}(e,t)}function B(e){return i(this,void 0,void 0,(function*(){return null!=(yield _.pidInfo(e))}))}t.kill=L,t.pidExists=B,t.pidNotExists=function(e){return v.thenNot(B(e))};class R{constructor(e=M.BaseFile.for(p.App.userData()).join("pids")){this.pidsDir=e,this.p=new y.Promises,this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",()=>i(this,void 0,void 0,(function*(){const t=c.orElse(e.everything,!1),n=c.orElse(e.force,F.isWin),i=yield this.pidfiles(),r=yield x.toMapAsync(i,e=>v.thenMap(e.readJSON(),e=>[e.pid,e])),a=s.uniq(s.flatten(f.toA(r.values()).map(e=>[e.pid,e.ppid])));if(s.isEmpty(a))return C().debug("killOldProcs(): no pidfiles"),[];const u=yield _.pidInfos(a);if(C().debug("killOldProcs()",{pids:a,allEntries:u}),null==u)return void w.onError("Pids.killOldProcs(): failed to get process information");const l=new Set(u.map(e=>e.pid)),h=u.filter(e=>r.has(e.pid)),m=s.sortBy(s.compact(h.map(e=>c.map(r.get(e.pid),t=>A(t,e)?Object.assign(Object.assign({},t),e):void 0))),e=>e.pid).filter(e=>o.pid!==e.pid),p=t?m:m.filter(t=>!l.has(t.ppid)||!l.has(t.pid)||d.gt0(t.timeoutTime)&&Date.now()>=t.timeoutTime||null!=e.everythingBefore&&t.startTime<e.everythingBefore);C().debug("killOldProcs()",{trackedEntries:h,victims:p,pidfiles:f.toA(r.values())});for(const e of p)C().info("killOldProcs(): killing",{entry:e}),L(e.pid,n,!1);return yield this.vacuumPids(),s.sortBy(p,e=>e.pid)})))}addPid(e,t){return i(this,void 0,void 0,(function*(){if(null==e)throw new Error("undefined info");const n=e.pid;if(!d.gt0(n))throw new Error("undefined pid");const i=this.pidsDir.join(e.pid+".json"),r=h.Opt(O.Try(()=>P.parseNativePath(e.cmd).base)).filter(a.notBlank).getOrElse(()=>e.cmd),o=t.getTime(),s=T.mapGt0(e.maxAgeMs,e=>o+e),u=Object.assign(Object.assign({},e),{cmd:r,startTime:o,timeoutTime:s});if(null==(yield i.writeJsonMaybe(u)))throw new Error("Failed to write to "+i);return C().debug("addPid() wrote "+i,u),i}))}pidfiles(){return this.pidsDir.clear().children(e=>".json"===e.ext&&null!=d.toInt(e.name))}onKill(e){return i(this,void 0,void 0,(function*(){const t=this.pidsDir.join(e+".json");return v.thenMap(t.clear().readJSON(),t=>this.addPid(Object.assign(Object.assign({},t),{maxAgeMs:1}),S.ago(u.minuteMs)).catch(t=>{C().info("onKill(): failed to rewrite pidfile: "+t,{pid:e})}))}))}vacuumPids(){return i(this,void 0,void 0,(function*(){const e=yield this.pidfiles(),t=f.toA(e).map(e=>d.toInt(e.name)).filter(d.gt0);if(s.isEmpty(t))return;const n=yield _.pidInfos(t);if(null!=n){C().debug("vacuumPids",{pids:t,pidfiles:f.toA(e).map(e=>e.base),entries:n});for(const t of e){const e=n.find(e=>m.toS(e.pid)===t.name);null!=e&&(yield k(t,e))||(C().debug("vacuumPids(): Removing old pidfile "+t.base,{psEntry:e,pidfile:yield t.readFile().then(m.toS).catch(e=>"(failed to read file: "+e+")")}),yield t.unlink())}}else w.onError("Failed to get pidInfo for pids "+t)}))}}t.Pids=R,R.instance=l.lazy(()=>new R),t.addPid=function(e,t){return R.instance().addPid(e,t)},t.ProcCleaner=l.lazy(()=>{const e=[{everything:!1,force:!1,intervalMs:5*u.minuteMs},{everything:!1,force:!0,intervalMs:17*u.minuteMs}].map(e=>b.setUnrefInterval(()=>R.instance().killOldProcs(e),e.intervalMs));return new g.EndableWrapper("ProcCleaner",()=>(e.map(clearInterval),R.instance().killOldProcs()),g.EndableRanks.predb)})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunker=t.onDataChunked=void 0;const i=n(3),r=n(76);t.onDataChunked=function(e,t,n){new o(t,n,!0).read(e)};class o{constructor(e,t,n=!0){this.sep=e,this.onData=t,this.filterBlanks=n,this.incompleteChunk="",this.done=new r.Latch}onChunk(e){if(null==e)return;const t=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=t.pop(),t.forEach(e=>{this.filterBlanks&&!i.notBlank(e)||this.onData(e)})}clear(){this.onChunk(""),i.notBlank(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",e=>this.onChunk(e)),e.on("close",()=>{this.clear(),this.done.resolve()}),this}}t.Chunker=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppName=void 0,t.AppName="PhotoStructure"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CountingSet=void 0;const i=n(1),r=n(0),o=n(5),s=n(11),a=n(79);t.CountingSet=class{constructor(){this.m=new Map}incr(e,t=1){const n=this.get(e)+t;return 0===n?this.m.delete(e):this.m.set(e,n),this}get(e){return r.orElse(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){const e=new a.Average(0);for(const t of this.keys()){if(!o.isNumber(t))return;e.push(t)}return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){const e=this.keyAvg();return i.sortBy([...this.entries()],([t,n])=>[-n,o.mapNumericOr(e,e=>Math.abs(t-e),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(e=>e[0])}get averageCounts(){return s.tap(new a.Average(this.size),e=>[...this.m.values()].forEach(t=>e.push(t)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return i.sort([...this.keys()]).map(e=>e+" "+this.get(e)).join("\n")}}},function(e,t){e.exports=require("zlib")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withLogLevel=t.silentlyAsync=t.silently=t.logFilter=t.LogFilterImpl=t.PermissiveLogFilter=void 0;const r=n(1),o=n(3),s=n(2),a=n(7),u=n(28),l=n(9),c=n(107);!function(e){e.highlight=()=>!1,e.silent=!1,e.enabled=()=>!e.silent,e.defaultLevelIndex=c.levelIndex("trace")}(t.PermissiveLogFilter||(t.PermissiveLogFilter={}));const d=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i;class h{constructor(e){this.silent=!1,this.contexts=[];let t=c.levelIndex(l.Settings.logLevel.defaultValue);const n=o.notBlank(e)?e:l.Settings.logLevel.valueOrDefault;r.compactBlanks(n.split(",")).forEach(n=>{const i=d.exec(n.trim());if(null==i)u.isTest||console.error("LogFilterImpl: Ignoring '"+n+"' from "+e);else{const e=a.toS(i[1]).toLowerCase(),n=c.levelIndex(i[2]);o.blank(e)?t=n:this.contexts.push({prefix:e,levelIndex:n})}}),this.defaultLevelIndex=t}contextOverride(e){if(0===this.contexts.length&&o.blank(e))return;const t=a.toS(e).toLowerCase();return this.contexts.find(e=>t.startsWith(e.prefix))}enabled(e,t){if(this.silent)return!1;const n=c.levelIndex(e);if(n<=this.defaultLevelIndex)return!0;const i=this.contextOverride(t);return null!=i&&n<=i.levelIndex}highlight(e){const t=this.contextOverride(e);return null!=t&&t.levelIndex>=this.defaultLevelIndex}}t.LogFilterImpl=h,t.logFilter=s.lazy(()=>new h),l.Settings.logLevel.addListener(()=>t.logFilter.clear()),t.silently=function(e){try{return t.logFilter().silent=!0,e()}finally{t.logFilter().silent=!1}},t.silentlyAsync=function(e){return i(this,void 0,void 0,(function*(){try{return t.logFilter().silent=!0,yield e()}finally{t.logFilter().silent=!1}}))},t.withLogLevel=function(e,t){return i(this,void 0,void 0,(function*(){const n=l.Settings.logLevel.getState();l.Settings.logLevel.tmpValue=e;try{return yield t()}finally{l.Settings.logLevel.setState(n)}}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelIndex=t.LogLevels=void 0;const i=n(11),r=n(36);t.LogLevels=r.strEnum("error","warn","info","debug","trace");const o=i.fromEntries(t.LogLevels.values.map((e,t)=>[e,t]));t.levelIndex=function(e){var t;return null!==(t=o[e])&&void 0!==t?t:o.trace}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flippable=t.normalizeRotation=t.isRotation=void 0;const i=n(0),r=n(5);function o(e){return r.isNumber(e)&&[0,90,180,270].includes(e)}function s(e){const t=i.map(e,e=>r.round(e+360*Math.ceil(-e/360)));return o(t)?t:void 0}t.isRotation=o,t.normalizeRotation=s,t.flippable=function(e){const t=s(e);return 90===t||270===t}},function(e,t){e.exports=require("crypto")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lcdiff=t.str=t.radixDiff=t.lnsDiff=t.nonUniqIntersection=t.bigrams=t.diceCoeff=t.levenshtein=t.hamming=t.lcs=t.commonSubstringRatio=void 0;const i=n(1),r=n(3),o=n(4),s=n(5),a=n(7),u=n(56),l=n(60),c=n(16),d=n(25),h=n(89);function f(e,t){if(null==e)return t;if(null==t)return e;if((e=e.normalize())===(t=t.normalize())||t.includes(e))return e;if(e.includes(t))return t;const n=new c.Array2D(e.length);let i=0,r="";for(let o=0;o<e.length;o++)for(let s=0;s<t.length;s++)e[o]===t[s]&&(0===o||0===s?n.set(o,s,1):n.set(o,s,n.get(o-1,s-1)+1),n.get(o,s)>=i&&(i=n.get(o,s),r=e.substr(o-i+1,i)));return r}function m(e,t){if(null!=e&&null!=t)return e=e.normalize(),t=t.normalize(),e.length!==t.length?void 0:e.split("").reduce((e,n,i)=>n===t.charAt(i)?e:e+1,0)}t.commonSubstringRatio=function(e,t){return[e,t].some(r.blank)?0:f(e,t).length/Math.max(e.length,t.length)},t.lcs=f,t.hamming=m;const p=new u.BoundedMap(10*o.minuteMs,1e4,!0),g=String.fromCharCode(31);function v(e,t){return e=e.normalize(),t=t.normalize(),p.getOrSet(i.sort([e,t]).join(g),()=>{if(0===e.length)return t.length;if(0===t.length)return e.length;const n=e.charAt(e.length-1)===t.charAt(t.length-1)?0:1,i=e.slice(0,-1),r=t.slice(0,-1);return Math.min(v(i,t)+1,v(e,r)+1,v(i,r)+n)})}function y(e,t){const n=e.toUpperCase().normalize(),i=t.toUpperCase().normalize();return d.firstThunk(()=>n===i?1:void 0,()=>r.blank(e)!==r.blank(t)?0:void 0,()=>1===e.length&&1===t.length?0:void 0,()=>{const e=b(n),t=b(i);return 2*S(e,t).length/(e.length+t.length)})}function b(e){return null==e||0===e.length?[]:e.slice(0,-1).split("").map((t,n)=>t+e[n+1])}function S(e,t){const n=h.intersection(e,t),r=[];return n.forEach(n=>{const o=Math.min(i.count(e,e=>e===n),i.count(t,e=>e===n));s.times(o,()=>r.push(n))}),r}function w(e,t,n){const r=i.commonPrefixLength(e,t);return n(e.substr(r))-n(t.substr(r))}function M(e){const t=i.compactBlanks(a.toS(e).split(/[^\d]+/));return i.sortBy(t,e=>-e.length)[0]}function P(e,t){const[n,i]=[e,t].map(M).map(e=>r.blank(e)?"":e);return w(n,i,e=>s.toInt(e,{defaultValue:0}))}t.levenshtein=v,t.diceCoeff=y,t.bigrams=b,t.nonUniqIntersection=S,t.lnsDiff=P;const E=/[^0-9a-z]+/gi;function x(e,t){const[n,i]=[e,t].map(e=>a.toS(e).replace(E,"").toLowerCase());return w(n,i,e=>l.RadixAlphaNum.decode(e))}t.radixDiff=x,t.str=function(e,t){return{pref:i.commonPrefixLength(e,t),lev:v(e,t),ham:m(e,t),dice:y(e,t),lns:P(e,t),radixDiff:x(e,t)}},t.lcdiff=function(e){return i.count(e.normalize().split(""),e=>0!==e.toLowerCase().localeCompare(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PullProgressObserver=t.PushProgressObserver=void 0;const i=n(54),r=n(182),o=n(0),s=n(5),a=n(126),u=n(8),l=n(28).isTest?500:1e3;t.PushProgressObserver=class{constructor(e,t){this.context=e,this.total=t,this.start=Date.now(),this.emit=a.throttle(()=>{r.emitProgressEvt(Object.assign(Object.assign({},this.context),{pct:100*this.current/this.total,elapsedMs:Date.now()-this.start}))},l,!0)}onProgress(e){this.current=s.clamp(0,this.total,o.orElse(e,o.orElse(this.current,0)+1)),this.emit()}};t.PullProgressObserver=class{constructor(e,t,n){this.ctx=e,this.total=t,this.progress=n,this.start=Date.now(),this.onInterval=a.throttle(()=>u.thenMap(this.progress(),e=>this.emit(e)),l),this.timer=i.setInterval(()=>this.onInterval(),l)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){o.map(e,e=>r.emitProgressEvt(Object.assign(Object.assign({},this.ctx),{pct:100*s.clamp(0,this.total,e)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>l&&this.emit(this.total),this.end()}end(){o.map(this.timer,e=>i.clearInterval(e)),this.timer=void 0}}},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectPath=t.ancestorWithChildren=t.childrenSync=t.ancestors=t.execDir=void 0;const i=n(47),r=n(31),o=n(19),s=n(1),a=n(2),u=n(13),l=n(14);function c(e){const t=[];for(;e!==r.dirname(e);)e=r.dirname(e),t.push(e);return t}function d(e){try{return i.readdirSync(e)}catch(e){return[]}}function h(e,t){const n=d(e);return t.every(e=>n.includes(e))}t.execDir=a.lazy(()=>r.dirname(process.execPath)),t.ancestors=c,t.childrenSync=d,t.ancestorWithChildren=function(e,t){return c(e).find(e=>h(e,t))},function(n){n.Root=a.lazy(()=>{const n=["migrations","public","views"],i=[];l.isDocker()&&i.push("/ps/app"),l.isElectron&&i.push(r.join(t.execDir(),"resources"),r.join(t.execDir(),"..","Resources")),i.push(...s.compactBlanks([t.execDir(),o.cwd(),e])),u.uniqInPlace(i);for(const e of i){if(h(e,n))return e;for(const t of c(e).slice(0,4)){if(h(t,n))return t;const i=r.join(e,"node_modules","photostructure");if(h(i,n))return i}}throw new Error("Failed to find project root. Looked in "+i)});const i=e=>a.lazy(()=>r.join(n.Root(),e));n.Bin=i("bin"),n.Migrations=i("migrations"),n.Public=i("public"),n.Tools=i("tools"),n.Views=i("views")}(t.ProjectPath||(t.ProjectPath={}))}).call(this,"/")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sharpDimensions=t.sharpMetadata=t.dimensions=void 0;const r=n(73),o=n(4),s=n(5),a=n(71),u=n(63),l=n(8),c=n(222),d=n(40),h=n(49),f=new a.TTLMap(2*o.minuteMs);function m(e){return r(e.nativePath).metadata()}function p(e){return i(this,void 0,void 0,(function*(){return h.isSharpExt(e.ext)?l.thenMap(m(e),e=>{const t=[e.width,e.height];s.gt0(e.orientation)&&[5,6,7,8].includes(e.orientation)&&t.reverse();const[n,i]=t;return s.gt0(n)&&s.gt0(i)?{width:n,height:i}:void 0}):void 0}))}t.dimensions=function(e){return c.getOrSetByNativePath(e,()=>function(e){return u.firstDefinedLater(()=>l.thenMap(d.cachedTags(e),e=>e.dimensions),()=>p(e),()=>l.thenMap(d.sizeInfo(e.nativePath),e=>({width:e.ImageWidth,height:e.ImageHeight})))}(e),f)},t.sharpMetadata=m,t.sharpDimensions=p},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Asset=void 0;const r=n(8),o=n(22),s=n(27),a=n(85),u=n(25),l=n(154),c=n(1),d=n(173),h=n(96),f=n(2),m=n(0),p=n(11),g=n(26),v=n(15),y=n(281),b=n(115),S=n(119),w=n(232),M=n(181),P=n(132),E=n(92);class x extends E.TimestampedModel{constructor(){super(...arguments),this.attrs={},this.urls=f.lazy(()=>new d.AssetUrls(this.toID()))}static shownCount(){return this.ops().count(this.shownUnhidden())}static outdatedQuery(){return this.query().where("version","<",l.AssetVersion)}static shownUnhidden(e){return m.orElse(e,()=>x.query()).andWhere({shown:1,hidden:0})}static nextOutdated(e=u.identity){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=u.identity){return this.dbr(t=>t.pluckFirst(e(this.outdatedQuery()).count()))}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static addTags(e,t){return i(this,void 0,void 0,(function*(){const n=c.uniqBy(t.filter(c.isNotEmpty),e=>b.joinTagPath(e));return this.logger().debug("addTags()",{assetId:e,tagPaths:t,uniqTagPaths:n}),c.isEmpty(n)?void 0:x.tx(()=>i(this,void 0,void 0,(function*(){const t=(yield g.thenCollect(n,e=>P.Tag.findOrCreate(e))).map(e=>e.id);return M.AssetTag.addTagsToAsset(e,t)})))}))}static removeTags(e,t){return i(this,void 0,void 0,(function*(){if(c.isEmpty(t))return;const n=yield g.thenCollect(t,e=>P.Tag.findByPath(e));return this.logger().info("removeTags()",{assetId:e,tags:n.map(e=>p.pick(e,"id","path")),tagPaths:t}),M.AssetTag.removeTagsFromAsset(e,c.compact(n.map(e=>e.id)))}))}static unshownAssetIds(){return this.dbr(e=>e.pluckAll("\n        SELECT DISTINCT af1.assetId\n        FROM AssetFile af1\n          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 \n            ON af1.assetId = af2.assetId\n        WHERE af2.assetId IS NULL"))}static archive(e){return this.tx(()=>i(this,void 0,void 0,(function*(){null!=(yield x.ops().findById(e))&&(yield M.AssetTag.ops().exec(M.AssetTag.query().where({assetId:e}).delete()),yield S.AssetFile.ops().exec(S.AssetFile.query().where({assetId:e}).delete()),yield x.ops().delete([e]))})))}get capturedAt(){return s.localToDateObject(this.capturedAtLocal)}get capturedAtMs(){return s.localToTs(this.capturedAtLocal)}renderCaption(e){return m.map(this.capturedAtMs,t=>"Taken "+s.fmtDateShort(t,e))}whenTagPath(){return r.thenMap(y.dateTag(this.capturedAt),b.tagPathToStringArray)}addTagPaths(e){return x.addTags(this.id,e)}findAssetFileByUri(e){return i(this,void 0,void 0,(function*(){return yield this.getFiles(),this.files.find(t=>t.uri===e)}))}addAssetFile(e){return i(this,void 0,void 0,(function*(){return null==(yield this.findAssetFileByUri(e.uri))&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}))}static getTags(e){return P.Tag.ops().all(P.Tag.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}getTags(){return i(this,void 0,void 0,(function*(){return null==this.tags&&(this.tags=yield x.getTags(this.id)),this.tags}))}static getTagPaths(e){const t=P.Tag.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return P.Tag.dbr(e=>e.pluckAll(t))}tagPaths(){return i(this,void 0,void 0,(function*(){return(yield this.getTags()).map(e=>e.path.join("/")).sort()}))}getStreams(e){return i(this,void 0,void 0,(function*(){if(null==this.streams){const t=yield this.getTags();this.logger().info("getStreams(): fetched tags "+t,{limit:e});const n=yield g.thenCollect(t,t=>t.getAssetStream(this,e));this.streams=w.coalesceStreams(c.compact(n));for(const e of this.streams)for(const t of e.tags)yield t.getAncestors()}return this.streams}))}getBeforeAfterId(){return i(this,void 0,void 0,(function*(){const e=yield x.dbr(e=>e.all(x.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id")));this.afterId=m.map(e.find(e=>e.id>this.id),E.toID),this.beforeId=m.map(e.reverse().find(e=>e.id<this.id),E.toID),yield r.thenOrElse(this.beforeId,()=>this.getBeforeId()),yield r.thenOrElse(this.afterId,()=>this.getAfterId())}))}getBeforeId(){return i(this,void 0,void 0,(function*(){return r.thenMap(x.dbr(e=>e.first(x.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}]))),e=>this.beforeId=E.toID(e))}))}getAfterId(){return i(this,void 0,void 0,(function*(){return r.thenMap(x.dbr(e=>e.first(x.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}]))),e=>this.afterId=E.toID(e))}))}getTagPaths(){return i(this,void 0,void 0,(function*(){return(yield this.getTags()).map(e=>e.path)}))}getFiles(){return i(this,void 0,void 0,(function*(){if(null!=this.files)return this.files;if(null==this.id)return this.files=[];const e=yield S.AssetFile.ops().findBy({assetId:this.id});return this.files=c.sortBy(e,e=>[!o.isTrue(e.shown),-e.mtime])}))}getShown(){return i(this,void 0,void 0,(function*(){return null!=this.files?this.files.find(e=>o.isTrue(e.shown)):r.thenMap(S.AssetFile.ops().findOneBy({assetId:this.id,shown:1}),e=>p.tap(e,e=>e.asset=this))}))}getCapturedAt(){return i(this,void 0,void 0,(function*(){const e=yield this.getFiles();return r.thenCompact(v.toA(e).map(e=>e.toCapturedAt()))}))}link(){return"/asset/"+this.id}sqAttrs(e=!0){return Object.assign(Object.assign(Object.assign({},this.urls().sqImgAttrs(e)),{title:this.renderCaption()}),this.attrs)}getImgAttrs(e,t,n=!1){return i(this,void 0,void 0,(function*(){return null==this.imgAttrs&&(this.imgAttrs=new Map),yield a.getOrSetAsync(this.imgAttrs,t,()=>i(this,void 0,void 0,(function*(){const o=e.ap(this.toID());yield r.thenMap(o.readInfo(),e=>i(this,void 0,void 0,(function*(){e.mimetype.startsWith("video/")&&(this.poster=yield o.posterLink())})));return o.imgAttrs(t,!0,n)}))),this.imgAttrs}))}fitAttrs(){const e=m.map(this.imgAttrs,e=>e.get(h.ReducerNames.fit));if(null==e)throw new Error("fitAttrs() called before getImgAttrs()");return Object.assign(Object.assign({},e),this.attrs)}isVideo(){if(null==this.files)throw new Error(".video called before getFiles()");return this.files.some(e=>e.isVideo)}videoAttrs(){return Object.assign({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(null==this.existingFiles)throw new Error(".videoSources called before getExistingFiles()");const e=this.existingFiles.filter(e=>e.isVideo).map(e=>({src:this.urls().videoLink(e.id),type:e.mimetype})),t=c.uniqBy(e,e=>e.type);if(t.every(e=>"video/mp4"!==e.type)){const e=this.existingFiles[0];t.unshift({src:this.urls().videoLink(e.id)+".mp4",type:"video/mp4"})}return t}getPosixFiles(){return i(this,void 0,void 0,(function*(){const e=yield this.getFiles();return c.compact(yield Promise.all(e.map(e=>e.posixFile())))}))}getExistingAssetFiles(){return i(this,void 0,void 0,(function*(){return null==this.existingFiles&&(this.existingFiles=yield r.asyncFilter(yield this.getFiles(),e=>r.thenMapOr(e.posixFile(),e=>e.exists(),()=>!1))),this.existingFiles}))}findOrCreateByFile(e){return i(this,void 0,void 0,(function*(){const t=yield e.uri();if(null==t)return;const n=v.toA(yield S.AssetFile.findByAsset({id:this.id},{uri:t}))[0];return m.orElse(n,()=>i(this,void 0,void 0,(function*(){const t=new S.AssetFile;return t.asset=this,t.assetId=this.id,yield t.setFile(e),t})))}))}clear(){return this.files=void 0,this.tags=void 0,this.existingFiles=void 0,this}setHidden(e){return i(this,void 0,void 0,(function*(){return x.txOp(()=>(this.hidden=e,this.upsert()))}))}}t.Asset=x,x.tableName="Asset",x.uniqueColumnName="id",x.booleanFields=["shown","hidden","favorite"]},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagDeltas=t.tagDiff=t.tagPathEql=t.uniqTagPaths=t.joinTagPath=t.tagPathToStringArray=t.tagRefToS=t.RootTagSynonyms=t.WhatSynonyms=t.WhereSynonyms=t.Roots=t.Type=t.Keywords=t.Lens=t.Camera=t.When=t.TagSep=void 0;const i=n(282),r=n(89),o=n(1),s=n(0),a=n(15),u=n(7);function l(e){return s.map(e,e=>s.orElse(e.name,u.toS(e)))}function c(e){return e.map(l)}function d(e,n=t.TagSep){return c(e).join(n)}function h(e){return c(e).join(t.TagSep).toLowerCase()}function f(e,t){const n=new Set(o.compact(t).map(e=>h(e)));return o.compact(e).filter(e=>!n.has(h(e)))}function m(e){return l(a.toA(e)[0])}function p(e){return new Set(o.compact(a.toA(e).map(m)))}t.TagSep=String.fromCharCode(31),t.When="When",t.Camera="Camera",t.Lens="Lens",t.Keywords="Keywords",t.Type="Type",t.Roots=[{name:t.When,ordinal:1},{name:t.Camera,ordinal:5},{name:t.Lens,ordinal:6},{name:t.Keywords,ordinal:7},{name:t.Type,ordinal:8}],t.WhereSynonyms=new i.CISet(["country","el paÃ­s","emplacement","endroit","gps","les pays","location","ort","pays","place","places","platz","posiciÃ³n","region","rÃ©gion","site","sitio","stÃ¤tte","ubicaciÃ³n","where"]),t.WhatSynonyms=new i.CISet(["article","articles","item","items","le sujet","matiÃ¨re","object","objects","objet","objets","subject","subjects","subjekt","sujet","sujeta","sujeto","what"]),t.RootTagSynonyms=new i.CISet([...t.Roots.map(e=>e.name),...t.WhereSynonyms,...t.WhatSynonyms]),t.tagRefToS=l,t.tagPathToStringArray=c,t.joinTagPath=d,t.uniqTagPaths=function(e){return o.uniqBy(e,e=>o.isEmpty(e)?void 0:d(e))},t.tagPathEql=function(e,t){return null!=e&&null!=t&&h(e)===h(t)},t.tagDiff=f,t.tagDeltas=function(e,t,n=!0){const i=f(t,e),o=f(e,t),s=n?r.diff(p(o),p(i)):new Set;return{add:i,remove:o.filter(e=>!s.has(m(e)))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateInterval=void 0;const i=n(98),r=n(0),o=n(5),s=n(7),a=n(53),u=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/;class l{constructor(e,t,n,i=0,r=1){this.start=e,this.middle=t,this.end=n,this.index=i,this.splits=r,this.toISOString=this.toString.bind(this),this.year=a.getYear(this.middle),this.month=a.getMonth(this.middle),this.day=a.getDay(this.middle)}static fromISO(e){e=s.toS(e).trim();const t=u.exec(e);if(null==t)return;const n=i.ExifDateTime.fromISO(t[1]),r=i.ExifDateTime.fromISO(t[2]),a=o.toInt(t[3]),l=o.toInt(t[4]);return this.for(n,r,a,l)}static for(e,t,n=0,i=1){if(!a.validDate(e)||!a.validDate(t))return;const s=a.toExifDateTime(e),u=a.toExifDateTime(t);if(null==s||null==u)return;i=o.clamp(1,1e3,o.toInt(i,{defaultValue:1})),n=o.clamp(0,i-1,o.toInt(n,{defaultValue:0}));const c=r.map(s.toDateTime().until(u.toDateTime()).divideEqually(i+1)[n],e=>e.end);return null!=c?new l(s,a.toExifDateTime(c,r.orElse(s.zone,u.zone)),u,n,i):void 0}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return r.orElse(this.start.zone,this.end.zone)}get hasTimes(){return a.hasTime(this.start)&&a.hasTime(this.end)}toString(e=!0){return`${a.datedToISO(this.start,e)}/${a.datedToISO(this.end,e)}`+(0===this.index&&1===this.splits?"":`/${this.index}/${this.splits}`)}includes(e){if(null==e)return!1;const t=a.toExifDateTime(e);return null!=t?this.interval().contains(t.toDateTime()):this.year===a.getYear(e)&&this.month===a.getMonth(e)&&this.day===a.getDay(e)}}t.DateInterval=l},,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.validVideo=t.guessExpectedSize=t.transcode=t.isVideoTranscodingSupported=t.extractVideoFrame=t.bitrateKps=t.getVideoToolDetails=t.maxConcurrentVideoImports=t.MaxBitrateKbps=void 0;const r=n(50),o=n(4),s=n(2),a=n(0),u=n(5),l=n(35),c=n(63),d=n(8),h=n(70),f=n(22),m=n(111),p=n(6),g=n(219),v=n(16),y=n(9),b=n(10),S=n(303),w=n(221),M=n(40),P=n(129),E=n(134),x=n(257),T=n(113),O=n(130),F=n(224),_=n(161),D=n(81),C=n(258);function I(e,t,n){var r;return i(this,void 0,void 0,(function*(){if(!D.isVideoMimeType(t))return;const o=!f.isTrue(null==n?void 0:n.useVlc)&&f.isTrue(yield d.thenOrElse(null==n?void 0:n.useFfmpeg,()=>x.isFFmpegSupported())),s=!o&&f.isTrue(yield d.thenOrElse(null==n?void 0:n.useVlc,()=>C.isVlcSupported()));if(!o&&!s)return;const u=p.mkLogger("img/Video.extractVideoFrame("+e+")"),l=yield O.cachedImgFile(e,"frame",".jpg");u.debug("extractVideoFrame",{dest:l.nativePath,mimetype:t});const c=yield e.mtimeMs();if(null==c)return u.throw("null mtime");const h=yield M.readRawTags(e);if(null==h)return u.throw("no tags");const m=P.extractRotation(h);u.debug("video orientation:"+m);const g=null===(r=E.extractSizeInfo(h,m))||void 0===r?void 0:r.dimensions,v=yield l.stat(),b=yield a.map(v,()=>T.sharpDimensions(l));if(null!=v&&v.mtimeMs>c&&null!=b&&(null==g||b.height===g.height&&b.width===g.width))return u.debug("prior dest, "+l+" seems reasonable",{srcDim:g,destDim:b}),l;const S=w.extractDurationSec(h),_=Math.min(null!=S?S:0,y.Settings.videoFrameAtSec.valueOrDefault);return u.info("extracted metadata",{startAtSec:_,duration:S}),yield l.applyWip(t=>i(this,void 0,void 0,(function*(){const n=Object.assign({src:e,dest:t,startAtSec:_},g);yield o?x.ffmpegFrame(n):C.vlcFrame(n),yield M.deleteAllTags(t),s&&null!=m&&0!==m&&(u.info("rotating in place..."+t,{rot:m}),yield F.rotateInPlace(t,m))}))),l}))}function A(e,t,n){return Math.min(e,a.orElse(n,60)*a.orElse(t,1e3))}t.MaxBitrateKbps=18e3,t.maxConcurrentVideoImports=s.lazy(()=>i(void 0,void 0,void 0,(function*(){return r.totalmem()>16*l.GB&&(yield x.isFFmpegSupported())?2:1}))),t.getVideoToolDetails=function(e){return c.firstDefinedLater(()=>f.isTrue(null==e?void 0:e.ignoreffmpeg)?void 0:d.thenMap(x.checkFFmpegVersion(),e=>"FFmpeg "+e),()=>f.isTrue(null==e?void 0:e.ignorevlc)?void 0:d.thenMap(C.checkVlcInfo(),e=>"VLC "+e.version))},t.bitrateKps=e=>u.sigFigs(g.lerp2d({x:76800,y:800},{x:8294400,y:t.MaxBitrateKbps},e),2),t.extractVideoFrame=I,t.isVideoTranscodingSupported=function(){return i(this,void 0,void 0,(function*(){return y.Settings.transcodeVideos.valueOrDefault&&((yield x.isFFmpegSupported())||(yield C.isVlcSupported()))}))},t.transcode=function(e,n){return i(this,void 0,void 0,(function*(){const r=p.mkLogger("img/Video.transcode("+e+")");if(!y.Settings.transcodeVideos.valueOrDefault)return void r.debug("not transcoding (transcodeVideos is false)");const s=yield x.isFFmpegSupported(),l=!s&&(yield C.isVlcSupported());if(!s&&!l)return void r.debug("not transcoding (neither FFmpeg nor VLC are available)");const c=yield e.size();if(!u.gt0(c))throw new Error("transcode(): cannot read "+e);const d=yield M.readRawTags(e);if(null==d)throw new Error("Cannot transcode files that exiftool can't read");const f=d.MIMEType;if(!D.isVideoMimeType(f))return void r.debug("not transcoding (unsupported mimetype)",{mimetype:f});const g=y.Settings.doNotTranscodeMimetypes.values;if(!b.includesIgnoreCase(g,f))return h.time("Video.transcode()",()=>i(this,void 0,void 0,(function*(){const r=a.orElse(w.extractDurationSec(d),60),l=_.transcodeTimeout({bytes:c,durationMs:r*o.secondMs,ext:e.ext}),h=Object.assign({src:e,timeoutMs:l},function(e,n){const i=p.mkLogger("img/Video.dim("+e+")"),r=y.Settings.minVideoDimension.valueOrDefault,o=n.ImageWidth;if(null!=o&&!u.gte(o,r))return i.throw("invalid width: "+o);const s=n.ImageHeight;if(null!=s&&!u.gte(s,r))return i.throw("invalid height: "+s);const l=a.orElse(S.extractBitrateKbps(n),t.MaxBitrateKbps),c=v.mapGt0(o,e=>v.mapGt0(s,n=>u.clamp(0,l,t.bitrateKps(e*n)))),d={width:o,height:s,videoBitrateKbps:c};return i.debug("dim()",{src:e,result:d}),d}(e,d)),f=A(c,h.videoBitrateKbps,r),g=f/3,b=t=>i(this,void 0,void 0,(function*(){const r=Date.now(),o=new m.PullProgressObserver({path:e.nativePath,op:"Transcoding video"},f,()=>i(this,void 0,void 0,(function*(){const e=a.orElse(yield n.clear().size(),0),t=(Date.now()-r)/l*f;return Math.max(e,t)})));h.dest=t;const u=yield o.observe(s?x.ffmpegTranscode(h):C.vlcTranscode(h));if(0!==u.code)throw new Error("transcode failed with code "+u.code)}));return n.applyIfEmpty(e=>b(e),g)})));r.debug('not transcoding (mimetype is in "do not transcode")',{mimetype:f,doNotTranscodeMimetypes:g})}))},t.guessExpectedSize=A,t.validVideo=function(e,t){return i(this,void 0,void 0,(function*(){const n=p.mkLogger("img/Video.validVideo("+e+")");return null==(yield I(e,t))&&n.throw("Could not extract a video frame"),(yield x.isFFmpegSupported())?x.ffmpegValidVideo(e):void 0}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFile=void 0;const r=n(120),o=n(8),s=n(22),a=n(27),u=n(24),l=n(33),c=n(270),d=n(177),h=n(180),f=n(259),m=n(81),p=n(25),g=n(154),v=n(9),y=n(10),b=n(136),S=n(40),w=n(283),M=n(38),P=n(1),E=n(3),x=n(4),T=n(84),O=n(96),F=n(21),_=n(2),D=n(0),C=n(5),I=n(11),A=n(69),k=n(42),L=n(7),B=n(87),R=n(150),N=n(114),j=n(92);class V extends j.TimestampedModel{constructor(){super(...arguments),this.posixFile=_.lazy(()=>l.PosixFile.forUri(this.uri,this.mountpoint))}static recentAssetIdsByUriRoot(e,t,n=64){return i(this,void 0,void 0,(function*(){const i=Date.now()-t,r=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",i).andWhere("AssetFile.uri","like",e+"%").andWhere("Asset.shown",1).andWhere("Asset.hidden",0).orderBy("AssetFile.updatedAt","desc").limit(n);return this.logger().info("recentAssetIdsByUriRoot",r.toSQL()),this.dbLocal().pluckAll(r)}))}static assetCountByMimetype(e){let t=this.query().select(R.knex.raw("mimetype, count(*) as count"));return E.notBlank(e)&&(t=t.andWhere("uri","like",e+"%")),t=t.groupBy("mimetype").orderBy("mimetype"),this.dbr(e=>e.all(t))}static children(e,t){const n=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${y.escapeRegExp(e)}/[^/]+$}`);return this.ops().all(D.mapOr(t,e=>e(n),()=>n))}get capturedAtDateTime(){return a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return a.fmtDateTime(this.capturedAtDateTime,e)}static outdatedQuery(e){const t=this.query().where("version","<",g.AssetFileVersion).orderBy("id");return P.isEmpty(e)?t:t.andWhere(t=>t.whereIn("mountpoint",e).orWhereNull("mountpoint"))}static nextOutdated(e=p.identity){return i(this,void 0,void 0,(function*(){return this.ops().findOne(e(this.outdatedQuery(yield M.mountpoints())))}))}static outdatedCount(e=p.identity){return i(this,void 0,void 0,(function*(){const t=this.outdatedQuery(yield M.mountpoints());return this.dbr(n=>n.pluckFirst(e(t.count("id"))))}))}static setShown(e,t){return i(this,void 0,void 0,(function*(){if(this.logger().info("setShown()",{assetId:e,assetFileId:t}),!C.gt0(e)||!C.gt0(t))throw new Error("setShown(): invalid IDs: "+F.stringify({assetId:e,assetFileId:t}));yield this.dbr(t=>t.run(V.query().update("shown",0).where("assetId",e)));const n=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),i={assetId:e,assetFileId:t,updatedAt:Date.now()};return this.dbr(e=>e.run({sql:n,bindings:i}))}))}static findByAsset(e,t){return i(this,void 0,void 0,(function*(){const n=this.query().select("AssetFile.*");return D.map(I.compactValues(e),e=>n.join("Asset","Asset.id","AssetFile.assetId").where(I.mapFields(e,(e,t)=>["Asset."+e,t]))),D.map(I.compactValues(t),e=>n.where(I.mapFields(e,(e,t)=>["AssetFile."+e,t]))),this.ops().all(n)}))}get modes(){return P.compact(C.times(h.ModeCount,e=>this["mode"+e]))}set modes(e){C.times(h.ModeCount,t=>this["mode"+t]=e[t])}matchesFile(e){return i(this,void 0,void 0,(function*(){if(null==this.version||this.version<g.AssetFileVersion||v.Settings.forceSync.valueOrDefault)return!1;const t=yield this.fileFields(e);return p.eqlSubset(t,this)}))}fileFields(e){return A.thenOpt(e).orElse(()=>this.posixFile()).filter(e=>e.exists()).flatMap(e=>i(this,void 0,void 0,(function*(){return{uri:yield e.uri(),fileSize:yield e.size(),mtime:yield e.thisOrSidecareMaxMtimeMs()}}))).filter(I.isReqValued).get()}isVersionUpToDate(){return k.gte(this.version,g.AssetFileVersion)}updateIfNeeded(){return i(this,void 0,void 0,(function*(){return(yield this.matchesFile())&&C.gt0(this.id)?this:(yield this.notExists())?void 0:o.thenMap(this.updateFromFile(),()=>this.upsert())}))}maybeUpdateStats(e){return i(this,void 0,void 0,(function*(){return o.thenMap(this.fileFields(e),e=>p.assignFields(this,e))}))}updateFromFile(e){return i(this,void 0,void 0,(function*(){const t=Date.now(),n=this.logger().addContext(".updateFromFile()");if(n.debug("before",this),null!=this.id&&(yield this.matchesFile(e)))return void n.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");if(null!=e&&(yield this.setFile(e)),null==e&&(e=yield this.posixFile()),null==e||(yield e.notExists()))return void n.info("no-op, "+e+" is missing");if(null==this.mountpoint&&(yield o.thenMap(e.mountpoint(),e=>this.mountpoint=e.nativePath)),null==(yield this.maybeUpdateStats(e)))return void n.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});const i=e.sha(),r={},s=yield S.readTags(e);if(null==s)return n.throw("missing tags for "+e);if(E.blank(s.MIMEType))return n.throw("missing MIMEType for "+e);r.mimetype=s.MIMEType;const a=s.capturedAt,u=a.toLocal();if(null==u)return n.throw("bad CapturedAt",a);r.capturedAtLocal=u,r.capturedAtOffset=a.toOffset(),r.capturedAtPrecisionMs=a.toPrecisionMs(),r.capturedAtSrc=a.src,D.map(s.exposureSettings,e=>{r.focalLength=e.focalLength,r.aperture=e.aperture,r.shutterSpeed=e.shutterSpeed,r.iso=e.iso});const l=s.dimensions;if(r.width=l.width,r.height=l.height,r.rotation=s.rotation,r.make=s.Make,r.model=s.Model,r.cameraId=w.cameraId(s),r.imageId=D.map(w.imageId(s),L.toS),r.lensId=w.lensId(s),r.geohash=d.geohashNumericShort(s.GPSLatitude,s.GPSLongitude),r.durationMs=D.map(s.duration,e=>Math.round(1e3*e)),r.fps=D.map(s.VideoFrameRate,C.round),r.sha=yield i,null==r.sha)return void n.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri});v.Settings.useImageHashes.valueOrDefault&&(yield o.thenMap(h.imageHash(e),e=>{r.meanHash=e.meanHash,r.modes=e.modes})),p.assignFields(this,r),this.version=g.AssetFileVersion;const c=Date.now()-t;return n.log(c>x.secondMs?"info":"debug","after ("+c+"ms)",this),this}))}updateFromShaSibling(e){return i(this,void 0,void 0,(function*(){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:null==e.sha||!e.isVersionUpToDate()||null!=this.sha&&e.sha!==this.sha?this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e}):(p.assignFields(this,I.without(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt")),this)}))}getAsset(){return i(this,void 0,void 0,(function*(){return null==this.assetId||null!=this.asset?this.asset:this.asset=yield N.Asset.ops().findById(this.assetId)}))}exists(){return i(this,void 0,void 0,(function*(){return o.thenMapOr(this.posixFile(),e=>e.exists(),()=>!1)}))}notExists(){return i(this,void 0,void 0,(function*(){return o.thenNot(this.exists())}))}isDeleted(){return i(this,void 0,void 0,(function*(){if(this.uri.startsWith(B.PS_LIBRARY_PROTOCOL)){const e=v.Settings.libraryPath.value;if(E.blank(e))return this.logger().throw("isDeleted(): no set library path"+u.FatalErrorFlag,{uri:this.uri});const t=l.PosixFile.for(e);if(yield t.isNotDirectory())return this.logger().throw("isDeleted(): library path is missing"+u.FatalErrorFlag,{uri:this.uri,libraryPath:e});const n=yield this.posixFile();return null==n?this.logger().throw("isDeleted(): internal error: posixFile() is null",{uri:this.uri,libraryPath:e}):n.notExists()}return o.thenMapOr(this.posixFile(),e=>D.map(this.mountpoint,t=>e.isDeleted(t)),()=>!1)}))}isFiltered(){return i(this,void 0,void 0,(function*(){return A.thenOpt(this.posixFile()).filter(e=>e.exists()).flatMap(e=>c.expensiveFileFilter().apply(e)).map(e=>!e).getOrElse(()=>!1)}))}setFile(e){return i(this,void 0,void 0,(function*(){const t=yield e.uriObject();if(null==t)throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);const n=r.format(t);if(null==n)throw new Error(e+" had no URI");if(null!=this.uri&&n!==this.uri)throw new Error("Cannot reassign URIs");return this.uri=n,this.mountpoint=D.map(t.volume,e=>e.mountpoint),this.posixFile.set(Promise.resolve(e)),n}))}nativePath(){return o.thenMap(this.posixFile(),e=>e.nativePath)}toCapturedAt(){return D.map(a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset),e=>o.thenMap(this.posixFile(),t=>new b.CapturedAt(t,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}downloadables(e,t){return i(this,void 0,void 0,(function*(){try{const n=yield this.posixFile();if(null==n)return[];const i=e.ap(this.assetId),r=[];if((yield n.isNonEmpty())&&r.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:f.mkDownloadableTitle(n,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:n.base,description:"Download original",details:`(${T.dimToS(this)} ${n.ext})`}),this.isVideo)return r;if(!(s.isTrue(this.shown)||this.sha===t))return r;const o=P.compact(yield Promise.all([...yield i.previews()].reverse().filter(e=>e.reducer===O.ReducerNames.fit).map(e=>f.previewToDownloadable(n.base,e))));return r.push(...P.uniqBy(o,e=>e.size)),r}catch(e){return u.onError("AssetFile.downloadables failed",e,{context:this}),[]}}))}toApi(e,t){return i(this,void 0,void 0,(function*(){return o.thenMap(this.posixFile(),n=>i(this,void 0,void 0,(function*(){return I.reqValuedOrElse({assetId:this.assetId,assetFileId:this.id,nativePath:n.nativePath,wbrNativePath:y.wbrPath(n.nativePath),basename:n.base,exists:yield n.isNonEmpty(),mimetype:this.mimetype,shown:s.isTrue(this.shown),width:this.width,height:this.height,rotation:D.orElse(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:yield this.downloadables(e,t),createdAt:this.createdAt,updatedAt:this.updatedAt})})))}))}get isVideo(){return m.isVideoMimeType(this.mimetype)}}t.AssetFile=V,V.tableName="AssetFile",V.uniqueColumnName="uri",V.booleanFields=["shown"]},function(e,t){e.exports=require("url")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mtabEntries=t.gioVolumes=t.GioMountMonitorArgs=t.GioCommand=t.isGioSupported=void 0;const r=n(3),o=n(2),s=n(0),a=n(18),u=n(80),l=n(8),c=n(20),d=n(41),h=n(6),f=n(14),m=n(10),p=n(122),g=n(23);t.isGioSupported=o.lazy(()=>i(void 0,void 0,void 0,(function*(){if(!f.isLinux)return!1;try{return 0===(yield c.stdoutResult(t.GioCommand,["version"],{timeout:g.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}}))),t.GioCommand="gio",t.GioMountMonitorArgs=["mount","--monitor","--anonymous"];const v=o.lazy(()=>h.mkLogger("Gio.gioVolumes()"));t.gioVolumes=o.lazy(()=>l.thenOrTimeout(()=>i(void 0,void 0,void 0,(function*(){const e=yield function(){return i(this,void 0,void 0,(function*(){return(yield t.isGioSupported())?l.thenFlatten(yield l.thenMap(t.mtabEntries(),e=>e.map(e=>d.BaseFile.for(e).clear().childDirectories()))):[]}))}(),n=(yield l.thenFlatten(e.map(e=>i(void 0,void 0,void 0,(function*(){const t=yield p.dfPosixRaw(!1,e.nativePath).catch(t=>{v().warn("Failed to df "+e+": "+t)}),n=s.map(t,e=>e[0]);return s.map(n,t=>t.mountpoint=e.nativePath),n}))))).filter(e=>e.size>0);return Promise.all(n.map(e=>i(void 0,void 0,void 0,(function*(){return l.thenMapOr(b(e.mountpoint),t=>(e.remoteHost=t.remoteHost,e.remoteShare=t.remoteShare,e.label=t.displayName,e.remote=!0,e),()=>e)}))))})),g.MountpointsTtlMs,()=>h.mkLogger("Gio.gioVolumes").warn("timed out after "+g.MountpointsTtlMs+"ms")),g.LongMountpointsTtlMs);const y=h.mkLogger("Gio.getRemoteInfo()"),b=u.memoize(e=>i(void 0,void 0,void 0,(function*(){try{const n=(yield c.stdout(t.GioCommand,["info",e],{timeout:g.CmdTimeoutMs})).split(/[\n\r]+/),i=r.mapNotBlank(n.find(e=>e.startsWith("uri: ")),e=>new URL(m.stripPrefix(e,"uri: ")));return{displayName:s.map(n.find(e=>e.startsWith("display name: ")),e=>m.stripPrefix(e,"display name: ")),remoteHost:s.map(i,e=>e.hostname),remoteShare:a.Opt(i).flatMap(e=>e.pathname).flatMap(e=>m.stripPrefix(e,"/")).flatMap(e=>m.stripSuffix(e,"/")).flatMap(decodeURIComponent).filter(r.notBlank).get()}}catch(t){return void y.warn("gio info failed",{mountpoint:e,err:t})}})),g.LongMountpointsTtlMs,1e3);t.mtabEntries=o.lazy(()=>i(void 0,void 0,void 0,(function*(){return l.thenMap(d.BaseFile.for("/proc/mounts").readLines(),e=>e.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1]))})),g.LongMountpointsTtlMs)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosixRaw=void 0;const r=n(3),o=n(5),s=n(7),a=n(20),u=n(82),l=n(14),c=n(237),d=n(23);function h(e){return 1024*o.toInt(e,{defaultValue:0})}const f=l.isMac?["devfs"]:["udev","tmpfs","devtmpfs"],m=["/boot/efi"];t.dfPosixRaw=function(e,t){return i(this,void 0,void 0,(function*(){const n=l.isMac?yield c.ignorableMacFilesystems():[],i=["-k","-P"];e&&i.push("-l"),r.notBlank(t)&&i.push(t);const o=yield a.stdout("df",i,{timeout:d.CmdTimeoutMs});return u.parseFixed(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],o).map(e=>({filesystem:e.Filesystem,size:h(e["1024-blocks"]),used:h(e.Used),available:h(e.Available),mountpoint:e["Mounted on"]})).filter(e=>{const t=s.toS(e.filesystem),i=s.toS(e.mountpoint);return r.notBlank(i)&&!m.includes(i)&&r.notBlank(t)&&!n.includes(t)&&!f.includes(t)})}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.apply=t.filter=t.find=t.none=t.some=t.all=t.or=t.and=t.not=t.True=void 0;const r=n(1),o=n(0),s=n(8);t.True=()=>!0,t.not=function(e){return t=>!e(t)},t.and=function(...e){return t=>{for(const n of e)if(!n(t))return!1;return!0}},t.or=function(...e){return t=>{for(const n of e)if(n(t))return!0;return!1}},t.all=function(e,t){for(const n of e)if(!t(n))return!1;return!0},t.some=function(e,t){for(const n of e)if(t(n))return!0;return!1},t.none=function(e,t){for(const n of e)if(t(n))return!1;return!0},t.find=function(e,t){for(const n of e)if(t(n))return n},t.filter=function(e,t){return i(this,void 0,void 0,(function*(){return null==e||null==t?o.mapOr(e,r.compact,()=>[]):s.asyncFilter(e,t)}))},t.apply=function(e,t){return i(this,void 0,void 0,(function*(){return null==e||null==t||(yield t(e))?e:void 0}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readLogEntries=t.LogWriter=t.CaptureLogger=void 0;const r=n(47),o=n(54),s=n(1),a=n(4),u=n(32),l=n(21),c=n(2),d=n(0),h=n(26),f=n(17),m=n(44),p=n(64),g=n(27),v=n(83),y=n(30),b=n(62),S=n(146),w=n(191),M=n(29),P=n(9),E=n(10),x=n(147),T=n(77),O=n(145);t.CaptureLogger=class{constructor(){this.logEntries=[]}log(e,t,n,i){this.logEntries.push({ts:Date.now(),l:e,ctx:t,msg:n,meta:i})}enabled(){return!0}end(){}flush(){return i(this,void 0,void 0,(function*(){}))}};t.LogWriter=class{constructor(e,t={}){this.logDir=e,this.ended=!1,this.mutex=new m.Promises,this._linesSinceRotate=0,this.pendingWrites=[],this._startIndex=0,this.endTimeoutMs=15*a.secondMs,this.end=c.lazy(()=>i(this,void 0,void 0,(function*(){return this.ended=!0,d.map(this.flushInterval,o.clearInterval),this.flushInterval=void 0,yield this.flush(),this.mutex.serial("close",()=>this._closeCurrent())}))),this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",()=>this._flush()),this.shouldRotate=()=>null==this._stream||this._linesSinceRotate>=this.opts.maxLinesPerFile,this.name="LogWriter("+e+")",this.opts=Object.assign({maxLinesPerFile:25e4,errorLogger:x.ConsoleLogger.instance(),flushEveryMs:T.DefaultLogFlushMs,processName:M.processName},t),this.flushInterval=p.setUnrefInterval(()=>this.maybeFlush(),this.opts.flushEveryMs),f.addLoggerEndable(this)}log(e,t,n,i){if(this.ended&&"error"===e)this.opts.errorLogger.log(e,t,n,i);else{const r={ts:Date.now(),l:e,ctx:t,msg:n};null!=i&&(r.meta=i),this.pendingWrites.push(l.stringify(r)+"\n"),"error"===e&&this.writeRecentLogEntries()}}writeRecentLogEntries(){return this.pendingWrites.push(...O.recentLogEntries().map(e=>l.stringify(e)+"\n")),O.clearRecentLogEntries(),this.flush()}flush(){return i(this,void 0,void 0,(function*(){yield this.mutex.serial("flush",()=>this._flush())}))}_flush(){return i(this,void 0,void 0,(function*(){const e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&(yield this._rotate());const t=this._stream;if(null==t)return void this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const n=this.opts.maxLinesPerFile-this._linesSinceRotate,i=e.splice(0,n);this._linesSinceRotate+=i.length,t.write(i.join(""))}}))}errback(e){return t=>this.opts.errorLogger.log("error","Caught error from "+e,t)}_rotate(){return i(this,void 0,void 0,(function*(){yield this._closeCurrent(),this._currentFile=yield this.logDir.join(g.datestamp(),E.stripAnsiEsc(this.opts.processName())+".log").ensureNew({emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=r.createWriteStream(this._currentFile.nativePath).on("error",this.errback("file write stream"))}))}_closeCurrent(){return i(this,void 0,void 0,(function*(){const e=this._stream;this._stream=void 0,this._linesSinceRotate=0;const t=this._currentFile;this._currentFile=void 0,yield b.end(e),P.Settings.logCompression.valueOrDefault&&(yield u.delay(this.opts.flushEveryMs),yield d.map(t,e=>e.gzip()))}))}},t.readLogEntries=function(e,t){return i(this,void 0,void 0,(function*(){const n=y.nameWithoutCount(e.name);return h.thenMap(S.zcat(e.nativePath,t),e=>s.compact(s.compactBlanks(v.splitLines(e)).map(e=>w.mapParsed(e,e=>Object.assign(Object.assign({},e),{from:n})))))}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryEntry=void 0;const r=n(47),o=n(65),s=n(31),a=n(1),u=n(0),l=n(15),c=n(8),d=n(10),h=n(30);class f{constructor(e,t){this.dir=e,this.dirent=t,this.nativePath=s.join(this.dir,t.name)}static for(e){return i(this,void 0,void 0,(function*(){const t=h.parseNativePath(e);return o.stat(e).then(e=>new f(t.dir,{name:t.base,isFile:e.isFile.bind(e),isDirectory:e.isDirectory.bind(e),isSymbolicLink:e.isSymbolicLink.bind(e),size:e.size,mtimeMs:e.mtimeMs})).catch()}))}join(...e){return i(this,void 0,void 0,(function*(){return f.for(s.join(this.nativePath,...e))}))}get base(){return this.dirent.name}get ext(){return h.extname2(this.dirent.name)}get name(){return d.stripSuffix(this.base,this.ext)}get pathnames(){return this.nativePath.split(s.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile()}isDirectory(){return this.dirent.isDirectory()}isSymbolicLink(){return this.dirent.isSymbolicLink()}parent(){const e=h.parseNativePath(this.dir);return e.dir===this.dir?this:new f(e.dir,{name:e.base,isFile:function(){return!1},isDirectory:function(){return!0},isSymbolicLink:function(){return!1}})}children(){return this.isDirectory()?new Promise((e,t)=>{r.readdir(this.nativePath,{withFileTypes:!0},(n,i)=>{null!=n?t(n):e(u.map(i,e=>a.sortBy(e,e=>e.name.toLowerCase().normalize()).map(e=>new f(this.nativePath,e))))})}):void 0}visitDescendantFiles(e){return i(this,void 0,void 0,(function*(){for(const t of l.toA(yield this.children()))yield t.isFile()?e(t):t.isDirectory()?t.visitDescendantFiles(e):void 0}))}filterDescendantFiles(e){return i(this,void 0,void 0,(function*(){const t=[];return yield this.visitDescendantFiles(n=>i(this,void 0,void 0,(function*(){!0===(yield e(n))&&t.push(n)}))),t}))}stat(){return o.stat(this.nativePath).catch(()=>{})}size(){return i(this,void 0,void 0,(function*(){return c.thenOrElse(this.dirent.size,()=>c.thenMap(this.stat(),e=>e.size))}))}mtimeMs(){return i(this,void 0,void 0,(function*(){return c.thenOrElse(this.dirent.size,()=>c.thenMap(this.stat(),e=>e.mtimeMs))}))}}t.DirectoryEntry=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=void 0,t.throttle=function(e,t,n=!1){let i=n?Date.now()+t:0,r=0;const o=(...n)=>{const o=Date.now();return o>=i?(i=o+t,r++,e(...n)):void 0};return o.count=()=>r,o}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncFilter=void 0;const r=n(11),o=n(26),s=n(13),a=n(75),u=n(10),l=n(123);class c{constructor(e){this.apply=e}static lift(e){return new c(e)}static and(...e){return new c(t=>i(this,void 0,void 0,(function*(){for(const n of e){const e=yield n.apply(t);if(!e)return e}return!0})))}static or(...e){return new c(t=>i(this,void 0,void 0,(function*(){for(const n of e){const e=yield n.apply(t);if(e)return e}return!1})))}static andLogged(e,...t){return this.and(...s.flatMap(t,t=>r.entries(t).map(([t,n])=>n.asAsync().logged(e,t))))}static orLogged(e,...t){return this.or(...s.flatMap(t,t=>r.entries(t).map(([t,n])=>n.asAsync().logged(e,t))))}static andExplain(e,t){return i(this,void 0,void 0,(function*(){const n=[],i=[];for(const o of t)for(const[t,s]of r.entries(o))((yield s.apply(e))?n:i).push(t);return{accepted:n,rejected:i}}))}asAsync(){return this}and(...e){return c.and(this,...e)}not(){return c.lift(e=>this.apply(e).then(e=>!e))}or(e){return new c(t=>i(this,void 0,void 0,(function*(){return(yield this.apply(t))||(yield e.apply(t))})))}filter(e){return i(this,void 0,void 0,(function*(){return l.filter(e,e=>this.apply(e))}))}logged(e,t){return new c(n=>o.thenTap(this.apply(n),i=>{e.log(i?"debug":"info",[a.darkGrey(t),i?a.green("ACCEPT"):a.red("REJECT"),u.ellipsize(n)].join(" "))}))}}t.AsyncFilter=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.broadcast=t.setBroadcasterIfUnset=t.setBroadcaster=void 0;const i=n(296);let r=i.NoOpBroadcaster;t.setBroadcaster=function(e){r=e},t.setBroadcasterIfUnset=function(e){r===i.NoOpBroadcaster&&(r=e)},t.broadcast=function(e,t){r.broadcast(e,t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rotationToWriteTag=t.rotationToExifOrientation=t.orientationToRotation=t.extractRotation=void 0;const i=n(0),r=n(108),o=n(81),s=n(25);t.extractRotation=function(e){return i.map(e,e=>s.firstThunk(()=>u(e.Orientation),()=>u(e.CameraOrientation),()=>r.normalizeRotation(e.Rotation)))};const a=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function u(e){return i.map(e,e=>a.get(e))}t.orientationToRotation=u;const l=new Map([[0,1],[90,6],[180,3],[270,8]]);function c(e){return i.map(e,e=>l.get(e))}t.rotationToExifOrientation=c,t.rotationToWriteTag=function(e,t){return i.map(r.normalizeRotation(e),e=>o.isVideoMimeType(t)?{Rotation:e}:i.map(c(e),e=>({"Orientation#":e})))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.prepFileForBrowser=t.withImgCache=t.readableToFile=t.cachedImgFile=t.emptyImgCacheDir=t.imgCacheDir=void 0;const r=n(65),o=n(73),s=n(4),a=n(21),u=n(2),l=n(0),c=n(8),d=n(24),h=n(176),f=n(68),m=n(33),p=n(6),g=n(60),v=n(9),y=n(10),b=n(40),S=n(49),w=n(129),M=n(134),P=n(52),E=n(135),x=u.lazy(()=>p.mkLogger("ImgCache"));function T(){return i(this,void 0,void 0,(function*(){const e=yield O();if(null==e||(yield e.isNotDirectory())&&(yield e.clear().isNotDirectory()))throw new Error("Cannot mkdir "+v.Settings.cacheDir.valueOrDefault+d.FatalErrorFlag);return e}))}t.imgCacheDir=T;const O=u.lazy(()=>i(void 0,void 0,void 0,(function*(){return c.thenMap(m.PosixFile.for(v.Settings.cacheDir.valueOrDefault).join("imgcache").mkdirp(),e=>e.mkNoMedia())})),s.minuteMs);function F(e,t,n){return i(this,void 0,void 0,(function*(){const i=yield e.stat();if(null==i)throw new Error(`tmpImgFile(${e}): unreadable`);const r=yield T(),o=yield h.readFileType(e.nativePath);if(null==o)throw new Error("Cannot read filetype for "+e);const s=f.stringSha(a.stringify({basename:e.base.toLowerCase(),mimetype:o.mime,size:i.size})),u=g.GeoRadix.encodeBuffer(s).slice(0,24);n=y.ensurePrefix(n,".");const l=r.join(...y.splitEvery(u.slice(0,24),2,3),t+n);if(null==(yield l.parent().mkdirp()))throw new Error("Cannot make dest dir, "+l.parent());return x().info("tmpImgFile("+e.baseWithGrandparent+")",{desc:t,ext:n,result:l}),l}))}function _(e,t,n,r){return i(this,void 0,void 0,(function*(){try{return yield c.thenMap(F(e,t,n),e=>e.applyIfEmpty(r))}catch(t){throw x().warn("readableToFile("+e+"): "+t),t}}))}t.emptyImgCacheDir=function(){return i(this,void 0,void 0,(function*(){return c.thenMap(T(),e=>i(this,void 0,void 0,(function*(){yield r.remove(e.nativePath),O.unset()})))}))},t.cachedImgFile=F,t.readableToFile=function({src:e,desc:t,suffix:n,f:r}){return i(this,void 0,void 0,(function*(){try{return yield c.thenMap(F(e,t,n),e=>e.applyIfEmpty(e=>i(this,void 0,void 0,(function*(){return c.thenMap(r(),t=>e.writeStream(t))}))))}catch(e){throw new P.WrappedError({cause:e,message:"readableToFile() failed"})}}))},t.withImgCache=_,t.prepFileForBrowser=function(e,t){return i(this,void 0,void 0,(function*(){if(yield e.notExists())return;const n=yield b.readRawTags(e,!0),r=null==n?void 0:n.MIMEType,s=l.orElse(w.extractRotation(n),0),a=l.map(n,e=>M.extractSizeInfo(e,s)),u=l.orElse(null==a?void 0:a.dimensions,t);if(null==u)return void x().warn("prepFileForBrowser(): no file dimensions",{file:e,si:a,info:t});const d={width:u.width-32,height:u.height-32};return S.isMimetypeSupported(r,t.userAgent)&&0===s?e:(x().info("prepFileForBrowser(): non-browser-supported mimetype",{file:e,mt:r,info:t}),_(e,"web-"+s,".jpg",t=>i(this,void 0,void 0,(function*(){return c.thenMap(E.sharpReadable(e,d),e=>i(this,void 0,void 0,(function*(){return o(e.nativePath).rotate(s).toFile(t.nativePath)})))}))))}))}},,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Tag=t.DefaultRelatedAssetLimit=void 0;const r=n(13),o=n(8),s=n(12),a=n(85),u=n(315),l=n(16),c=n(1),d=n(3),h=n(4),f=n(2),m=n(0),p=n(5),g=n(18),v=n(42),y=n(317),b=n(71),S=n(35),w=n(115),M=n(114),P=n(232),E=n(181),x=n(92);const T=10*h.secondMs;function O(e){return i(this,void 0,void 0,(function*(){const t=yield e;return null!=t&&F.cacheTag(t),t}))}s.onClearCache(()=>F.clear()),t.DefaultRelatedAssetLimit=72;class F extends x.TimestampedModel{constructor(){super(...arguments),this.urls=f.lazy(()=>new y.TagUrls(this.id))}static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this.recentTagsByPath.clear(),this.tagById.clear(),this._assetCountById.clear(),this._assetFileCountById.clear()}static onAssetTagChange(){this._assetCountById.clear(),this._assetFileCountById.clear()}static cacheTags(e){return e.map(e=>this.cacheTag(e))}static cacheTag(e){return m.map(e,e=>(this.recentTagsByPath.set(e._path,e),m.map(e.id,t=>this.tagById.set(t,e)),e))}static newTag(e){const t=new F;t._path=w.joinTagPath(e);const n=e[e.length-1];return m.map(n.ordinal,e=>t.ordinal=e),t}static findByIdOrPath(e,t){return 0===e?F.root():p.gt0(e)?this.findById(e):this.findByPath(t)}static findById(e){return 0===e?F.root():a.getOrSetAsync(F.tagById,e,()=>O(this.ops().findById(e)))}static findByPath(e){const t=w.joinTagPath(e);return d.blank(t)?F.root():a.getOrSetAsync(F.recentTagsByPath,t,()=>O(this.ops().findOneBy({_path:t})))}static getPagedAssets(e,t){const n=new F;return n.id=e,n.getPagedAssets(t)}static findOrCreate(e){return i(this,void 0,void 0,(function*(){if(c.isEmpty(e))throw new Error("empty tagPath");const t=w.joinTagPath(e,"/"),n=yield this.findByPath(e);if(this.logger().debug("_findOrCreate("+t+")",{prior:n}),null!=n)return n;const i=this.newTag(e),r=i.depth<=1?void 0:yield this.findOrCreate(e.slice(0,-1));m.map(r,e=>i.parentId=e.id);const o=yield O(this.ops().upsertOne(i));return this.logger().debug("_findOrCreate("+t+") upserted",{newTag:i,result:o,parent:r}),o}))}set name(e){const t=null!=this.parent?this.parent.path:[];this._path=r.concat(t,[e]).join(w.TagSep)}get name(){const e=this.path;return e[e.length-1]}get path(){return d.mapNotBlankOr(this._path,e=>e.split(w.TagSep),[])}get isRoot(){return 0===this.id}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}$childrenQuery(){return F.query().where({parentId:this.id}).orderByRaw("COALESCE(ordinal, _path)")}$assetsQuery(){return M.Asset.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],m.map(this.parent,t=>t.setAncestors(e.slice(0,-1)))}toApiTag(){return i(this,void 0,void 0,(function*(){return{tagId:this.id,tagPath:this.path,assetCount:yield this.getAssetCount(),assetFileCount:yield this.getAssetFileCount()}}))}toStringId(){return"Tag("+this.path.join("/")+")"}getParent(){return i(this,void 0,void 0,(function*(){if(!this.isRoot)return null!=this.parentId&&null==this.parent?this.parent=yield F.findById(this.parentId):this.parent}))}getPagedChildren(e){if(0===this.id){const t=m.orElse(e.offset,0),n=t+m.orElse(e.limit,this.children.length);return[...this.children].slice(t,n)}const t=this.$childrenQuery();return l.mapGt0(e.offset,e=>{t.offset(e)}),l.mapGt0(e.limit,e=>{t.limit(e)}),F.ops().all(t)}getChildrenCount(){return i(this,void 0,void 0,(function*(){return null!=this.children?this.children.length:F.dbr(e=>e.pluckFirstf(e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count()))}))}getChildren(){return i(this,void 0,void 0,(function*(){return this.children=yield F.ops().all(this.$childrenQuery()),this.children.forEach(e=>{e.parent=this}),this.children}))}link(){return"/tag/"+this.path.join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}getAncestors(){return i(this,void 0,void 0,(function*(){if(null==this.ancestors){const e=r.ancestry(this.parentPath).map(e=>w.joinTagPath(e)),t=e.map(e=>F.recentTagsByPath.get(e));if(t.every(e=>null!=e))return this.ancestors=t;const n=F.query().whereIn("_path",e).orderBy("_path");this.ancestors=yield F.ops().all(n),F.cacheTags(this.ancestors),this.parent=m.orElse(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}))}getPagedAssets(e){let t=this.$assetsQuery(),n="desc";return l.mapGte0(e.capturedAtLt,e=>{t=t.where("capturedAtLocal","<",e)}),l.mapGte0(e.capturedAtGt,e=>{t=t.where("capturedAtLocal",">",e),n="asc"}),l.mapGte0(e.limit,e=>{t=t.limit(e)}),t=t.orderBy("capturedAtLocal",n),M.Asset.ops().all(t)}getAssets(){const e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return M.Asset.ops().all(e)}assetCountDesc(e){return i(this,void 0,void 0,(function*(){const t=yield this.getAssetCount();return(null==e||e.length===t||0===e.length?"":S.fmt(e.length)+" of ")+S.plur(t,"asset")}))}getDirectAssetCount(){return this._getAssetCountWithQuery(e=>e.where({tagId:this.id}))}getAssetCount(){return a.getOrSetAsync(F._assetCountById,this.id,()=>this._getAssetCountWithQuery(e=>e.join("Tag as t","t.id","AssetTag.tagId").join("Asset as a","a.id","AssetTag.assetId").where("t._path","like",this._path+"%").andWhere("a.shown",1).andWhere("a.hidden",0)))}getAssetFileCount(){return a.getOrSetAsync(F._assetFileCountById,this.id,()=>this._getAssetCountWithQuery(e=>e.join("Tag as t","t.id","AssetTag.tagId").join("Asset as a","a.id","AssetTag.assetId").join("AssetFile as af","af.assetId","a.id").where("t._path","like",this._path+"%").andWhere("a.shown",1).andWhere("a.hidden",0),"af.id"))}_getAssetCountWithQuery(e,t="AssetTag.assetId"){if(null==this.id)return 0;if(0===this.id)return M.Asset.shownCount();const n=E.AssetTag.query().countDistinct(t);return d.notBlank(this._path)&&e(n),o.thenOrElse(E.AssetTag.ops().count(n),()=>0)}$assetStreamQuery(e,t,n){return(this.path[0]===w.When?M.Asset.shownUnhidden():this.$assetsQuery()).orderBy("capturedAtLocal",n?"desc":"asc").where("capturedAtLocal",n?"<":">",e.capturedAtLocal).limit(t)}getAssetStream(e,t){return i(this,void 0,void 0,(function*(){t=p.gt0(t)?t:P.BeforeAfterLimit;const n=yield M.Asset.ops().all(this.$assetStreamQuery(e,t,!0)),i=yield M.Asset.ops().all(this.$assetStreamQuery(e,t,!1));return new P.AssetStream([this],n,i.reverse())}))}getRelatedAssetIds(e,n=t.DefaultRelatedAssetLimit){return i(this,void 0,void 0,(function*(){const t=E.AssetTag.query().distinct("Asset.id","Asset.capturedAtLocal","Asset.updatedAt").join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).orderByRaw(u.prngOrderByClause(e+m.orElse(this.id,0),"Asset.id",m.orElse(yield _(),Math.pow(2,20)))).limit(n),i=yield M.Asset.ops().all(t);return c.sortByInPlace(i,e=>g.Opt(e.capturedAtLocal).map(e=>-e).getOrElse(()=>0)),this.logger().debug(this.path+": Found "+i.length+" related assets"),i.map(e=>e.toID())}))}get attrs(){return{href:this.link(),title:this.name}}}t.Tag=F,F.tableName="Tag",F.uniqueColumnName="_path",F.recentTagsByPath=new b.TTLMap(T),F.tagById=new b.TTLMap(T),F._assetCountById=new b.TTLMap(10*h.secondMs),F._assetFileCountById=new b.TTLMap(10*h.secondMs),F.cmp=(e,t)=>v.cmp([m.orElse(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[m.orElse(t.ordinal,Number.MAX_SAFE_INTEGER),...t.path]),F.root=f.lazy(()=>i(void 0,void 0,void 0,(function*(){const e=new F;return e.id=0,e.name="",e._path="",e.parentId=void 0,e.children=yield F.roots(),e.ancestors=[],e.upsert=()=>{throw new Error("upsert not supported on root")},e})),T),F._upsertDefaultRoots=f.lazy(()=>F.ops().upsert(w.Roots.map(e=>({_path:e.name,ordinal:e.ordinal})))),F.roots=f.lazy(()=>i(void 0,void 0,void 0,(function*(){yield F._upsertDefaultRoots();const e=yield F.ops().all(F.query().whereNull("parentId").orderByRaw("coalesce(ordinal, _path)"));return e.forEach(e=>{e.parentId=void 0,e.ancestors=[],F.cacheTag(e)}),e})));const _=f.lazy(()=>i(void 0,void 0,void 0,(function*(){return p.base10Ceil(yield M.Asset.dbr(e=>e.pluckFirstf(e=>e.count("id"))))})),10*h.secondMs)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseDimensions=t.ltEither=t.ltBoth=t.tmegapixels=void 0;const i=n(1),r=n(84),o=n(5),s=n(7);t.tmegapixels=function(e){return null!=e.dimensions?r.dmegapixels(e.dimensions):o.gt0(e.Megapixels)?e.Megapixels:void 0},t.ltBoth=function(e,t){return o.lt(e.width,t.width)&&o.lt(e.height,t.height)},t.ltEither=function(e,t){return o.lt(e.width,t.width)||o.lt(e.height,t.height)},t.parseDimensions=function(e){const t=i.compact(s.toS(e).split(/[xÃ]/).map(e=>o.toInt(e)));return 2==t.length?{width:t[0],height:t[1]}:void 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractSizeInfo=void 0;const i=n(84),r=n(2),o=n(5),s=n(13),a=n(6),u=r.lazy(()=>a.mkLogger("SizeInfo"));t.extractSizeInfo=function(e,t,n){const r=s.first([null==n?void 0:n.ImageSize,{width:e.ImageWidth,height:e.ImageHeight}],e=>i.isDimensions(e)?e:void 0);if(u().debug("extractSizeInfo()",{filename:e.FileName,mimetype:e.MIMEType,rawInfo:n,fileDimensions:r}),null==r)return;const a=i.maybeFlip(r,t),l=o.sigFigs(a.width/a.height,5);return{ImageHeight:a.height,ImageWidth:a.width,aspectRatio:l,dimensions:a,rotation:t,fileDimensions:r}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.extractImageForThumbs=t.sharpReadable=t.imgFromExif=void 0;const r=n(73),o=n(59),s=n(3),a=n(2),u=n(0),l=n(8),c=n(70),d=n(178),h=n(6),f=n(9),m=n(40),p=n(49),g=n(129),v=n(134),y=n(67),b=n(133),S=n(113),w=n(130),M=n(220),P=n(118),E=n(81),x=h.mkLogger("SharpReadable");function T(e,t,n,r){return i(this,void 0,void 0,(function*(){return u.map(t,t=>u.map(t[n],()=>l.thenMap(F(e,n),t=>l.thenMap(S.dimensions(t),i=>x.tap({msg:"imgFromExif",meta:{src:e.baseWithGrandparent,tag:n,dim:i,minDim:r},result:b.ltBoth(r,i)?t:void 0})))))}))}t.imgFromExif=T;const O=a.lazy(()=>r.concurrency(y.maxCpus()));function F(e,t){const n=t.toLowerCase().endsWith("tiff")?".tiff":".jpg";return l.thenMap(w.cachedImgFile(e,t,n),n=>n.applyIfEmpty(n=>i(this,void 0,void 0,(function*(){try{return m.extractBinaryTag(t,e.nativePath,n.nativePath)}catch(n){return void x.warn("Failed to extract embedded "+t+" from "+e.nativePath+": "+n)}}))))}t.sharpReadable=function(e,t,n=!1){return c.time("sharpReadable "+e.normalizedExt,()=>function(e,t,n=!1){return i(this,void 0,void 0,(function*(){O();const r=!n,a=yield m.readRawTags(e,r),c=null==a?void 0:a.MIMEType;if(null==a||s.blank(c))throw new Error(e+" is not supported (missing mimetype)");const h=[],y=g.extractRotation(a),b=v.extractSizeInfo(a,y,d.dcrawSupportedMimetype(c)?yield M.rawInfo(e):void 0);if(null!=b){const i=u.orElse(t,{width:.95*b.dimensions.width,height:b.dimensions.height});if((n||null==y||0===y)&&!E.isVideoMimeType(c)){const n=f.Settings.useEmbeddedPreviews.valueOrDefault?["PreviewImage","PreviewTIFF","JpgFromRaw"]:[];f.Settings.useEmbeddedThumbnails.valueOrDefault&&null!=t&&t.width<=120&&t.height<=120&&n.unshift("ThumbnailImage","ThumbnailTIFF"),h.push(...n.map(t=>()=>T(e,a,t,i)))}}p.isSharpMimetype(c)&&h.push(()=>i(this,void 0,void 0,(function*(){return e}))),null!=b&&d.dcrawSupportedMimeTypes.has(c)&&h.push(()=>(x.info("sharpReadable() -> dcraw()",{src:e.nativePath,minDim:t}),w.readableToFile({src:e,desc:"Converting raw image",suffix:".tiff",f:()=>d.dcraw(e)}))),h.push(()=>o.retryOnReject(()=>P.extractVideoFrame(e,c),{maxRetries:1}));const S=[],F=yield l.firstResolvedDefinedPromise(h,t=>{x.warn("strategy failed for "+e+": "+t),S.push(t)});if(null==F)throw u.orElse(S[0],new Error("Cannot read "+e));return F}))}(e,t,n))},t.extractImageForThumbs=F},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.capturedAtFromTags=t.extractCapturedAt=t.addTzFromSibs=t.hasSubSecCapturedAt=t.capturedAtTags=t.bestCapturedAt=t.CapturedAt=t.capturedAtSrcFromTags=void 0;const r=n(74),o=n(1),s=n(4),a=n(21),u=n(2),l=n(0),c=n(15),d=n(7),h=n(13),f=n(63),m=n(8),p=n(27),g=n(53),v=n(25),y=n(194);function b(e){return d.toS(e).toLowerCase().startsWith("tags")}t.capturedAtSrcFromTags=b;class S{constructor(e,t,n,i,r){this.file=e,this.date=t,this.src=n,this.mtime=i,this.precisionMs=r,this.toISOString=u.lazy(()=>g.datedToISO(this.date))}spread(e){const t=Object.assign(Object.assign({},this),e);return new S(t.file,t.date,t.src,t.mtime)}toLocal(){return p.isoToLocal(this.toISOString())}toOffset(){return g.datedToOffsetMinutes(this.date)}get isFromTags(){return b(this.src)}toPrecisionMs(){return l.orElse(this.precisionMs,()=>g.datedToPrecisionMs(this.date))}toString(){return a.stringify({file:this.file.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return g.hasZone(this.date)}hasTime(){return g.hasTime(this.date)}}function w(e,t){return i(this,void 0,void 0,(function*(){if(!g.validDate(t))return;if(g.hasZone(t))return t;const n=yield y.nearestSiblingTzOffset(e);if(null!=n){const e=g.toExifDateTime(t,n);if(g.validDate(e))return e}return t}))}function M(e){return l.map(e,e=>h.first(["SubSecDateTimeOriginal","DateTimeOriginal","SubSecCreateDate","CreateDate","SubSecMediaCreateDate","MediaCreateDate","OriginalCreateDateTime","DateTimeCreated","DateTimeUTC","GPSDateTime"],t=>g.mapValidDate(e[t],e=>({date:e,src:t}))))}t.CapturedAt=S,t.bestCapturedAt=function(e){return i(this,void 0,void 0,(function*(){const t=o.sortBy(e,e=>-e.mtime.getTime());return v.firstThunk(()=>t.find(e=>e.src.startsWith("tags")),()=>t.find(e=>e.src.startsWith("bname+stat")),()=>t.find(e=>e.src.startsWith("bname")),()=>t.find(e=>e.src.startsWith("siblings")),()=>t.find(e=>e.src.startsWith("path")),()=>e[0])}))},t.capturedAtTags=function(e){return e=o.sortBy(c.toA(e),e=>-e.mtime),h.firstNonEmptyThunk(()=>e.filter(e=>e.src.startsWith("tags")),()=>e.filter(e=>e.src.startsWith("bname+stat")),()=>e.filter(e=>e.src.startsWith("bname")),()=>e.filter(e=>e.src.startsWith("siblings")),()=>e.filter(e=>e.src.startsWith("path")),()=>e.filter(e=>e.src.startsWith("stat")).slice(1,1),()=>[])},t.hasSubSecCapturedAt=function(e){return null!=e&&h.anyDefined([e.SubSecTime,e.SubSecTimeDigitized,e.SubSecTimeOriginal,e.SubSecCreateDate,e.SubSecDateTimeOriginal])},t.addTzFromSibs=w,t.extractCapturedAt=function(e,t,n){return i(this,void 0,void 0,(function*(){const a=yield e.mtime(),u=(s,u)=>i(this,void 0,void 0,(function*(){return m.thenMap(u,u=>m.thenMap(function(e,t,n,o){return i(this,void 0,void 0,(function*(){const i=yield n;if(g.validDate(i))return g.hasZone(i)?i:null!=t&&null!=t.tz&&r.Info.isValidIANAZone(t.tz)?g.setZone(i,t.tz):o?i:w(e,i)}))}(e,t,u.date,n),t=>new S(e,t,o.compactBlanks([s,u.src]).join(":"),a,u.precisionMs)))}));return f.firstDefinedLater(()=>u("tags",M(t)),()=>u("bname+stat",y.extractStatBname(e)),()=>n?void 0:u("siblings",y.inferCapturedAtFromSiblings(e)),()=>n?void 0:u("bname",l.map(g.parseDated(y.bname(e)),e=>({date:e,src:"",precisionMs:h.max([g.datedToPrecisionMs(e),s.secondMs])}))),()=>n?void 0:u("path",l.map(g.extractDateFromPath(e.pathnamesWithoutDrive),e=>({src:"",date:e}))),()=>u("stat",m.thenMap(e.minStatDate(),e=>({src:"",date:e}))))}))},t.capturedAtFromTags=M},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.appData=void 0;const i=n(31),r=n(3),o=n(61),s=n(86),a=n(14);t.appData=function(){const e=[o.getEnv("PS_CONFIG_DIR"),a.isDocker()?"/ps/config":void 0];a.isWin&&e.push(o.getEnv("APPDATA")),a.isPosix&&e.push(o.getEnv("XDG_DATA_HOME"),o.getEnv("XDG_CONFIG_HOME"));const t=r.firstNotBlank(...e);return r.notBlank(t)?t:a.isWin?i.resolve(s.homeDir(),"AppData","Roaming"):a.isMac?i.resolve(s.homeDir(),"Library","Application Support"):i.resolve(s.homeDir(),".config")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NiceLevel=t.PriorityClasses=void 0;const i=n(36);t.PriorityClasses=i.strEnum("AboveNormal","Normal","BelowNormal","Idle"),t.NiceLevel=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BooleanSetting=t.BoundedFloatSetting=t.BoundedIntegerSetting=t.FloatSetting=t.MaybeIntegerSetting=t.IntegerSetting=t.StringEnumsSetting=t.StringArraySetting=t.splitStringArray=t.StringEnumSetting=t.StringSetting=t.MaybeStringSetting=t.Setting=t.SystemCategories=t.LibraryCategories=t.SettingCategories=t.envAtStartup=void 0;const i=n(31),r=n(19),o=n(1),s=n(3),a=n(21),u=n(0),l=n(5),c=n(18),d=n(36),h=n(45),f=n(15),m=n(7),p=n(22),g=n(46),v=n(28);t.envAtStartup=c.Opt(Object.assign({},r.env)).map(e=>v.isProd?Object.freeze(e):e).get(),t.SettingCategories=d.strEnum("Logging","System","Tools","Updates","Db","Filters","Previews","Reporting","Sync","Tagging","Web"),t.LibraryCategories=Object.freeze([t.SettingCategories.Db,t.SettingCategories.Filters,t.SettingCategories.Previews,t.SettingCategories.Reporting,t.SettingCategories.Sync,t.SettingCategories.Tagging,t.SettingCategories.Web]),t.SystemCategories=Object.freeze(t.SettingCategories.values.filter(e=>!t.LibraryCategories.includes(e)));const y=e=>s.notBlank(e)&&"undefined"!==e?m.toS(e).trim():void 0;class b{constructor(e){this.opts=e,this._persist=!1,this.listeners=[],this.importFromEnv()}hasValue(){return null!=this._value}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){return c.Opt(e).orElse(()=>r.env).flatMap(e=>e[this.opts.key]).filter(s.notBlank).orElse(()=>c.Opt(this.opts.alternateKeys).map(e=>e.map(e=>r.env[e])).flatMap(e=>e.find(s.notBlank))).flatMap(this.opts.fromEnv).get()}importFromEnv(e=r.env){if(!this._persist)return u.map(this.readFromEnv(e),e=>this.setValue(e))}importFromFile(e){if(!this.hasValue()||this._persist)return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){o.filterInPlace(this.listeners,t=>t===e)}onChange(){const e=this.value;this.listeners.forEach(t=>t(e))}get name(){return this.opts.name}get persist(){return this._persist}get key(){return this.opts.key}get category(){return this.opts.category}get transient(){return!0===this.opts.transient}get advanced(){return u.mapOr(this.opts.advanced,e=>e(),()=>!0)}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}set tmpValue(e){this._persist=!1,this.addToEnv(r.env,e),this.setValue(e)}setValue(e){const t=this._value,n=this.opts.toEnv(e),i=this.opts.fromEnv(n);return this._value=i,g.eql(t,this._value)||this.onChange(),this._value}get defaultValue(){return h.tot(this.opts.defaultValue)}get exampleValue(){return c.Opt(this.opts.exampleValue).flatMap(e=>e()).filter(s.notBlank).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return null!=this.value?this.value:this.defaultValue}maybeAddToEnv(e,t){const n=u.orElse(e,r.env);return this.hasValue()&&(n[this.opts.key]=y(this.opts.toEnv(u.orElse(t,this.valueOrDefault)))),n}addToEnv(e,t){const n=u.orElse(e,r.env);return n[this.opts.key]=y(this.opts.toEnv(u.orElse(t,this.valueOrDefault))),n}deleteFromEnv(e){const t=u.orElse(e,r.env);return delete t[this.opts.key],u.map(this.opts.alternateKeys,e=>e.forEach(e=>{delete t[e]})),t}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),this}addToJSON(){return{}}toJSON(){return{key:this.opts.key,value:this.value,defaultValue:this.opts.defaultValue,description:this.opts.description}}}t.Setting=b;t.MaybeStringSetting=class extends b{constructor(e){super(Object.assign({toEnv:y,fromEnv:y,defaultValue:void 0},e))}hasValue(){return s.notBlank(this.value)}};function S(e,t){const n=m.toS(e).toLowerCase();return t.find(e=>e.toLowerCase()===n)}t.StringSetting=class extends b{constructor(e){super(Object.assign({toEnv:y,fromEnv:y},e))}hasValue(){return s.notBlank(this.value)}};function w(e){return s.mapNotBlank(m.toS(e).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return o.compactBlankish(f.toA(JSON.parse(e)))}catch(e){}for(const t of["Â¦",i.delimiter])if(e.includes(t))return o.compactBlankish(e.split(t));return[e]})}t.StringEnumSetting=class extends b{constructor(e){super(Object.assign({toEnv:t=>S(t,e.validValues),fromEnv:t=>S(t,e.validValues)},e)),this.validValues=e.validValues;if(null!=this.defaultValue&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}},t.splitStringArray=w;t.StringArraySetting=class extends b{constructor(e){super(Object.assign({defaultValue:[],fromEnv:w,toEnv:e=>c.Opt(f.toA(e)).map(o.compactBlanks).map(o.uniq).filter(o.isNotEmpty).map(e=>a.stringify(e)).get()},e))}get values(){return o.uniq(o.compactBlanks(this.valueOrDefault))}pushFromEnv(...e){this.tmpValue=o.uniq(o.compactBlanks(this.valueOrDefault.concat(...e)))}removeValueFromEnv(e){u.map(this.value,t=>this.tmpValue=t.filter(t=>t!==e))}};t.StringEnumsSetting=class extends b{constructor(e){super(Object.assign({fromEnv:e=>s.mapNotBlank(e,e=>{try{return this.asValidValues(JSON.parse(e))}catch(t){return this.asValidValues(e.split(i.delimiter))}}),toEnv:e=>u.map(e,e=>a.stringify(o.uniq(e)))},e)),this.validValues=e.validValues}asValidValues(e){return o.compactBlankish(f.toA(e).map(e=>S(m.toS(e),this.validValues)))}addToJSON(){return{validValues:this.validValues}}};t.IntegerSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:l.toInt}))}};t.MaybeIntegerSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:l.toInt,defaultValue:void 0}))}};t.FloatSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:l.toFloat}))}};t.BoundedIntegerSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:t=>c.Opt(t).flatMap(parseInt).map(t=>l.clamp(e.min,e.max,t)).get()})),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};t.BoundedFloatSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:t=>c.Opt(t).flatMap(parseFloat).map(t=>l.clamp(e.min,e.max,t)).get()})),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};t.BooleanSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:p.toBoolean}))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedList=void 0;const i=n(5);class r{constructor(e){if(this.maxLength=e,this._length=0,this._firstIndex=0,e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...i.times(e,()=>null))}mapIndex(e,t){return e<0||e>this._length-1?void 0:t((e+this._firstIndex+this.maxLength)%this.maxLength)}get(e){return this.mapIndex(e,e=>this.store[e])}set(e,t){return this.mapIndex(e,e=>this.store[e]=t)}get length(){return this._length}set length(e){this._length=i.clamp(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){const e=this;return function*(){for(let t=0;t<e.length;t++)yield e.mapIndex(t,t=>e.store[t])}()}push(...e){for(const t of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,e=>{this.store[e]=t});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(const t of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,e=>{this.store[e]=t,this._firstIndex=e});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}every(e){for(let t=0;t<this._length;t++)if(!e(this.get(t),t))return!1;return!0}some(e){for(let t=0;t<this._length;t++)if(e(this.get(t),t))return!0;return!1}forEach(e){for(let t=0;t<this._length;t++)e(this.get(t),t)}map(e){const t=[];for(let n=0;n<this._length;n++)t.push(e(this.get(n),n));return t}reduce(e,t){let n=t;for(let t=0;t<this._length;t++)n=e(n,this.get(t),t);return n}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,t=>{this.mapIndex(this._length-1-e,e=>{const n=this.store[e];this.store[e]=this.store[t],this.store[t]=n})});return this}toA(){return[...this]}slice(e,t){return[...this].slice(e,t)}}t.BoundedList=r},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("stream")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.renice=void 0;const r=n(4),o=n(2),s=n(0),a=n(7),u=n(20),l=n(12),c=n(6),d=n(16),h=n(14),f=n(138),m=n(43),p=n(9),g=n(144),v=o.lazy(()=>c.mkLogger("Renice")),y=new g.TTLSet(r.minuteMs);l.onClearCache(()=>y.clear()),t.renice=function(e,t){return i(this,void 0,void 0,(function*(){return y.addIfMissing(e,()=>i(this,void 0,void 0,(function*(){const n=f.PriorityClasses.validOrElse(t,()=>p.Settings.processPriority.valueOrDefault);return d.mapGt0(e,()=>i(this,void 0,void 0,(function*(){try{yield h.isWin?function(e,t){return i(this,void 0,void 0,(function*(){return d.mapGt0(e,n=>f.PriorityClasses.map(t,n=>m.PowerShell.instance().execute(`(Get-Process -Id ${e}).PriorityClass = "${t}"`,e=>e)))}))}(e,n):function(e,t=19){return i(this,void 0,void 0,(function*(){return u.stdoutResult("renice",[t,"-p",e].map(a.toS),{timeout:10*r.secondMs})}))}(e,s.orElse(f.NiceLevel[n],9)),v().info("Renice pid "+e+" to "+n)}catch(t){return void v().info("Failed to renice pid "+e,t)}})))})))}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLSet=void 0;const i=n(11);class r{constructor(e){this.ttlMs=e,this.expireListeners=[],this.delegate=new Map,this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,t=this.ttlMs){return this.delegate.set(e,Date.now()+(t-this.ttlMs)),this}addIfMissing(e,t){const n=this.delegate.get(e);return null==n||this.expired(e,n)?(this.add(e),t()):void 0}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(const[t,n]of this.delegate)this.expired(t,n)||e(t,t,this)}has(e){return!this.expired(e,this.delegate.get(e))}values(){const e=this;return function*(){for(const[t,n]of e.delegate.entries())e.expired(t,n)||(yield t)}()}entries(){const e=this;return function*(){for(const[t,n]of e.delegate.entries())e.expired(t,n)||(yield[t,t])}()}toA(){return this.vacuum(),[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}on(e,t){this.expireListeners.push(t)}expired(e,t){return i.tap(null==t||t+this.ttlMs<=Date.now(),n=>{null!=t&&n&&(this.expireListeners.forEach(t=>t(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,t)=>{this.expired(t,e)})}}t.TTLSet=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.recentLogEntries=t.addRecentLogEntry=t.clearRecentLogEntries=t.SentLogLevels=void 0;const i=n(1),r=n(2),o=n(55),s=n(13),a=n(140),u=n(107),l=new Map;t.SentLogLevels=r.lazy(()=>s.diff(u.LogLevels.values,["trace"]));t.clearRecentLogEntries=function(){l.clear()},t.addRecentLogEntry=function(e){var t;e.l!==u.LogLevels.trace&&(t=e.l,o.getOrSet(l,t,()=>new a.BoundedList(24))).push(e)},t.recentLogEntries=function(){const e=[];for(const t of l.values())e.push(...t.toA());return i.sortBy(e,e=>e.ts)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.zReadFile=t.zcat=void 0;const r=n(47),o=n(105),s=n(2),a=n(26),u=n(7),l=n(6),c=n(62),d=n(213),h=s.lazy(()=>l.mkLogger("zcat"));function f(e,t){return i(this,void 0,void 0,(function*(){const n=new d.WritableToBuffer,i=[r.createReadStream(e,Object.assign({autoClose:!0},t))];return e.toLowerCase().endsWith(".gz")?i.push(o.createGunzip()):e.toLowerCase().endsWith(".br")&&i.push(o.createBrotliDecompress()),i.push(n),yield c.pipelineAsync(i),n.buffer}))}t.zcat=function(e,t){return i(this,void 0,void 0,(function*(){try{return a.thenMap(f(e,t),u.toS)}catch(t){return void h().warn("zcat failed to read "+e,t)}}))},t.zReadFile=f},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const r=n(2),o=n(29),s=n(106),a=n(167);class u{log(e,t,n,i){a.pushLogEntries({ts:Date.now(),l:e,from:o.processName(),ctx:t,msg:n,meta:i})}enabled(e,t){return s.logFilter().enabled(e,t)}flush(){return i(this,void 0,void 0,(function*(){}))}end(){}}t.ConsoleLogger=u,u.instance=r.lazy(()=>new u)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.uri2protocol=t.toUrl=t.uri2file=t.addUriParser=t.FileUriToFile=t.PsnetUriToFile=t.PsfileUriToFile=t.uriToString=t.nativePath2uriString=t.file2voluri=t.file2fileuri=t.addUriFormatter=t.FileToPsUri=t.volumeURI=t.uriEql=t.uriEqlSync=t.volsha=t.FileToFileUri=t.isUri=void 0;const r=n(240),o=n(120),s=n(1),a=n(3),u=n(4),l=n(2),c=n(0),d=n(11),h=n(7),f=n(87),m=n(13),p=n(80),g=n(8),v=n(22),y=n(12),b=n(6),S=n(168),w=n(10),M=n(95),P=n(41),E=n(68),x=n(30),T=n(33),O=l.lazy(()=>b.mkLogger("FileURI")),F=["http:","https:","file:",f.PS_LOCAL_FILE_PROTOCOL,f.PS_NETWORK_FILESYSTEM_PROTOCOL].map(e=>e+"//");function _(e,t){try{return null!=e&&null!=t&&(e===t||decodeURI(h.toS(e)).normalize()===decodeURI(h.toS(t)).normalize())}catch(e){return!1}}function D(e,n,o=!0){return i(this,void 0,void 0,(function*(){const i=encodeURI(n.posixPathFrom(T.PosixFile.for(e.mountpoint)));return a.notBlank(e.uuid)?{protocol:f.PS_LOCAL_FILE_PROTOCOL,hostname:t.volsha(e.uuid),pathname:i,slashes:!0,volume:e}:v.isTrue(e.remote)&&a.notBlank(e.remoteHost)&&a.notBlank(e.remoteShare)?{protocol:f.PS_NETWORK_FILESYSTEM_PROTOCOL,hostname:r.toASCII(o?yield S.friendlyname(e.remoteHost):e.remoteHost),pathname:r.toASCII(e.remoteShare)+(a.blank(i)?i:"/"+i),slashes:!0,volume:e}:void 0}))}t.isUri=function(e){const t=h.toS(e).toLowerCase();return F.some(e=>t.startsWith(e))},t.FileToFileUri=e=>{if(null==e||a.blank(e.posixPath))return;const t=h.toS(e.hostname),n={pathname:encodeURI(w.stripPrefix(e.posixPath,"//"+t)),protocol:"file:",slashes:!0};return a.notBlank(t)&&(n.hostname=r.toASCII(t)),n},t.volsha=p.memoize(e=>d.tap(a.mapNotBlank(e,E.shortStringSha),t=>O().debug("volsha",{uuid:e,ea:t})),1*u.hourMs,128),y.onClearCache(()=>t.volsha.clear()),t.uriEqlSync=_,t.uriEql=function(e,t){return i(this,void 0,void 0,(function*(){if(null==e||null==t)return!1;if(_(e,t))return!0;const n=yield T.PosixFile.forUri(e);return null!=n&&n.eql(yield T.PosixFile.forUri(t))}))},t.volumeURI=D,t.FileToPsUri=e=>{const t=T.PosixFile.for(x.posix2native(e.posixPath));return g.thenMap(M.volumeFor(t.nativePath),e=>D(e,t))};const C=[t.FileToPsUri,t.FileToFileUri];function I(e){return i(this,void 0,void 0,(function*(){if(null!=e&&!a.blank(e.posixPath))return m.firstAsync(C,t=>t(e)).catch(t=>{O().warn("file2voluri failed",{file:e,err:t})})}))}t.addUriFormatter=function(e){-1===C.indexOf(e)&&C.unshift(e)},t.file2fileuri=function(e){return o.format(t.FileToFileUri(e))},t.file2voluri=I,t.nativePath2uriString=function(e){return g.thenMap(I({posixPath:x.native2posix(e)}),o.format)},t.uriToString=function(e){if(null==e||"string"==typeof e)return e;try{return o.format(e)}catch(t){return void O().warn("toString failed",{uri:e,err:t})}};const A=/^[a-z]+:\/\/([a-z0-9-.]+?)(?:\/(.+)?)?$/i;t.PsfileUriToFile=(e,n)=>i(void 0,void 0,void 0,(function*(){if(null==e||a.blank(n))return;if(!w.equalsIgnoreCase(e.protocol,f.PS_LOCAL_FILE_PROTOCOL))return;const i=yield M.volumes();if(s.isEmpty(i))return void O().warn("PsfileUriToFile(): volumes() was empty: Can't resolve "+n);const r=n.match(A);if(null==r)return void O().warn("PsfileUriToFile(): didn't match regex",{raw:n});const o=r[1];if(a.blank(o))return void O().warn("PsfileUriToFile(): no volsha",{raw:n});const u=w.stripSuffix(decodeURI(h.toS(r[2])),"/").split("/"),l=i.find(e=>!e.remote&&a.notBlank(e.uuid)&&o===t.volsha(e.uuid));if(null!=l)return{posixPath:P.BaseFile.for(l.mountpoint).join(...u).posixPath};{const e=i.filter(e=>null!=e.uuid).map(e=>t.volsha(e.uuid));O().warn("PsfileUriToFile(): no volume had matching volsha",{raw:n,volid:o,volshas:e})}})),t.PsnetUriToFile=e=>i(void 0,void 0,void 0,(function*(){if(null==e)return;if(!w.equalsIgnoreCase(e.protocol,f.PS_NETWORK_FILESYSTEM_PROTOCOL))return;if(a.blank(e.pathname)||a.blank(e.hostname))return;const t=r.toUnicode(h.toS(e.hostname)),n=w.stripPrefix(h.toS(e.pathname),"/").split("/"),i=r.toUnicode(n.shift());if(a.blank(i))return;const o=n.map(decodeURIComponent);return g.thenMap(M.remoteVolumeFor(t,i),e=>({posixPath:P.BaseFile.for(e.mountpoint).join(...o).posixPath}))})),t.FileUriToFile=e=>{if(null==e)return;if(!w.equalsIgnoreCase(e.protocol,"file:")||a.blank(e.pathname))return;const t=decodeURI(h.toS(e.hostname)),n=decodeURI(h.toS(e.pathname));return a.notBlank(t)?{hostname:t,posixPath:n}:{posixPath:null!=n.match(/^\/[A-Z]:\//i)?n.substring(1):n}};const k=[t.PsfileUriToFile,t.PsnetUriToFile,t.FileUriToFile];function L(e){if(null!=e){if("string"!=typeof e&&[e.protocol,e.pathname,e.hostname].every(a.notBlank))return e;try{return o.parse(h.toS(e),!0)}catch(t){return void O().warn("toUrl failed",{uri:e,err:t})}}}t.addUriParser=function(e){-1===k.indexOf(e)&&k.unshift(e)},t.uri2file=function(e,t){return i(this,void 0,void 0,(function*(){if(a.blank(e))return;const n=function(e){try{return o.parse(e,!1,!0)}catch(t){return void O().warn("bad URI",{uri:e,err:t})}}(e);return null!=n?m.firstAsync(k,t=>t(n,e)).catch(i=>{if(O().warn("uri2file failed",{uri:e,err:i}),a.notBlank(t)&&null!=n.pathname){const e=n.pathname.split("/").slice(1);return{posixPath:T.PosixFile.for(t).join(...e).posixPath}}}):void 0}))},t.toUrl=L,t.uri2protocol=function(e){return c.map(L(e),e=>c.denull(e.protocol))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sqliteNativePath=t.jpegtranNativePath=t.dcrawNativePath=t.systemPathToTool=t.pathToTool=t.pathTo=void 0;const r=n(50),o=n(3),s=n(2),a=n(0),u=n(63),l=n(20),c=n(24),d=n(28),h=n(14),f=n(23),m=n(41),p=n(112);function g(e){return i(this,void 0,void 0,(function*(){const t=h.isWin?"where":"which";try{const n=yield l.stdout(t,[e],{timeout:f.CmdTimeoutMs});return o.mapNotBlank(n,e=>e.trim())}catch(e){return}}))}function v(e){return i(this,void 0,void 0,(function*(){return h.isElectron||!h.isDocker()&&d.isTest?function(e){return i(this,void 0,void 0,(function*(){const t=a.map(p.ProjectPath.Tools(),e=>m.BaseFile.for(e));if(null==t||(yield t.isNotDirectory()))throw new Error("Cannot find project path for tools"+c.FatalErrorFlag);function n(n){return null==t?void 0:t.join(h.platformName+"-"+n,e,e+(h.isWin?".exe":""))}return u.firstDefinedLater(()=>y(n(r.arch())),()=>"x64"===r.arch()?y(n("ia32")):void 0,()=>b(e))}))}(e):b(e)}))}function y(e){return i(this,void 0,void 0,(function*(){return null!=e&&(yield e.exists())?e.nativePath:void 0}))}function b(e){return i(this,void 0,void 0,(function*(){return u.firstDefinedLater(()=>g(e),()=>{var t;return y(null===(t=m.BaseFile.for(p.ProjectPath.Bin()))||void 0===t?void 0:t.join(e))},()=>h.isDocker()?y(m.BaseFile.for("/ps/app/bin").join(e)):void 0,()=>{throw new Error("Cannot find path for "+e)})}))}t.pathTo=g,t.pathToTool=v,t.systemPathToTool=b,t.dcrawNativePath=s.lazy(()=>v("dcraw")),t.jpegtranNativePath=s.lazy(()=>v("jpegtran")),t.sqliteNativePath=s.lazy(()=>v("sqlite3"))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.firstMigratedAt=t.knex=void 0;const r=n(313),o=n(8),s=n(0),a=n(11);t.knex=r({client:"sqlite3",useNullAsDefault:!0}),t.firstMigratedAt=function(e){return i(this,void 0,void 0,(function*(){return o.thenMap(e("migrations").min("migration_time").first(),e=>s.map(a.values(e)[0],e=>new Date(e)))}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.tx=void 0;const r=n(17),o=n(24),s=n(6),a=n(9),u=n(59),l=n(4),c=n(32),d=n(37),h=n(2),f=n(26),m=n(78),p=n(155),g=n(163),v=h.lazy(()=>s.mkLogger("Transactions")),y=l.minuteMs;let b=!1;t.tx=function(e,t,n=!1,s=!1){return i(this,void 0,void 0,(function*(){if(null==e.db)throw new Error("tx(): null db");let l=!1;try{return n&&(b=!0),s||null==(yield f.until(()=>!g.isVacuuming(e),y,1e3))&&v().throw("Timeout while waiting for vacuum"),yield u.retryOnReject(()=>i(this,void 0,void 0,(function*(){return e.inTransaction?t(e.db):p.handleDbRetries(()=>e.db.transaction(()=>t(e.db)).deferred())})),{maxRetries:10,errorIsRetriable:t=>i(this,void 0,void 0,(function*(){return!n&&!b&&(l||!o.isSqliteDisconnectedError(t)||r.ending()||(v().warn("Trying to reopen the db "+e.dbfile+": "+d.errorToVerbose(t)),yield e.reopenDb(),l=!0),o.isSqliteBusyError(t)||o.isSqliteDisconnectedError(t))})),timeoutMs:a.Settings.maxBusyDbMs.valueOrDefault/10,onRetryWaitUntil:()=>c.delay(m.randomInt(10,a.Settings.maxBusyDbMs.valueOrDefault/10))})}catch(e){if(n||b)return;throw v().warn("tx(): raised",e),e}finally{n&&(b=!1)}}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FileCache=t.InstanceCacheMaxSize=t.InstanceCacheTTL=void 0;const i=n(4),r=n(0),o=n(56),s=n(12);t.InstanceCacheTTL=i.minuteMs,t.InstanceCacheMaxSize=500;class a extends o.BoundedMap{constructor(){super(t.InstanceCacheTTL,t.InstanceCacheMaxSize,!0),s.onFileChanged(e=>this.clearFromPath(e)),s.onClearCache(()=>this.clearEntries()),this.on("expire",(e,t)=>r.map(t,e=>e.clear()))}clearEntries(){for(const e of this.values())e.clear()}clearFromPath(e){for(const t of this.values())(null==e||t.nativePath.startsWith(e))&&t.clear()}}t.FileCache=a},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.hasNoMedia=t.isNoMediaName=void 0;const r=n(31),o=n(3),s=n(4),a=n(2),u=n(5),l=n(8),c=n(22),d=n(56),h=n(27),f=n(12),m=n(6),p=n(41),g=n(159),v=n(30),y=/^\.?NoMedia$/i;function b(e){return null!=y.exec(e)}t.isNoMediaName=b,f.onClearCache(()=>w.clear()),f.onFileChanged(e=>{if(o.blank(e))w.clear();else for(const t of w.keys())t.startsWith(e)&&w.delete(t)});const S=15*s.secondMs,w=new d.BoundedMap(3*s.minuteMs,2e3,!1),M=a.lazy(()=>m.mkLogger("hasNoMedia()"));t.hasNoMedia=function e(t){return i(this,void 0,void 0,(function*(){if(g.pathIsNeverIgnored(t.nativePath))return M().debug(t+" is never ignoed"),!1;if(t instanceof p.BaseFile)return e(yield t.directoryEntry());if(b(t.base))return M().debug(t+" basename is NoMedia"),!0;const n=v.pathnames(t.nativePath);if(n.some(b))return M().debug(t+" parent path is NoMedia"),!0;for(let e=n.length-1;e>0;e--){const i=n.slice(0,e).join(r.sep),o=w.get(i);if(!0===o)return M().debug(t+" ancestor is NoMedia, "+i),!0;if(!1!==o&&(u.isNumber(o)&&(yield l.until(()=>c.isBoolean(w.get(i)),S))&&!0===w.get(i)))return M().debug(t+" ancestor is NoMedia, "+i),!0}const i=w.get(t.nativePath);if(c.isBoolean(i))return M().debug(t+" returning cached result, "+i),i;const o=yield t.isDirectory();if(o){if(null!=i&&h.isRecentMs(i,S)&&(M().debug(t+" is a work-in-progress. Waiting for prior result."),yield l.until(()=>c.isBoolean(w.get(t.nativePath)),S)))return e(t);const n=Date.now();w.set(t.nativePath,n);const r=yield t.children();if(null==r)return M().debug(t+" is a directory but has no children.",{result:!1}),w.set(t.nativePath,!1),!1;if(r.some(e=>b(e.base)))return M().debug(t+" is a directory and has a noMedia child",{result:!0}),w.set(t.nativePath,!0),!0}const s=yield t.parent();if(null==s||t.nativePath===s.nativePath)return M().debug(t+" root",{result:!1}),w.set(t.nativePath,!1),!1;{const n=yield e(s);return o&&w.set(t.nativePath,n),M().debug(t+" from parent",{result:n}),n}}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetVersion=t.AssetFileVersion=void 0,t.AssetFileVersion=10,t.AssetVersion=2},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleDbRetriesSync=t.handleDbRetries=void 0;const r=n(17),o=n(24),s=n(6),a=n(79),u=n(93),l=n(9),c=n(4),d=n(32),h=n(78),f=new a.Average,m=new u.Rate(c.minuteMs);new r.EndableWrapper("DbRetries",()=>{s.mkLogger("DbRetries").info("db contention",{busyErrorRate:m.stats(),busyLatencyMs:f.stats()})},r.EndableRanks.first),t.handleDbRetries=function(e){return i(this,void 0,void 0,(function*(){const t=Date.now();let n=0;const i=t+l.Settings.maxBusyDbMs.valueOrDefault;try{for(;Date.now()<i;)try{return yield e()}catch(e){const t=o.isSqliteBusyError(e);if(t&&(m.onEvent(),n++),!t||Date.now()>=i)throw e;yield d.delay(h.randomInt(10,l.Settings.maxBusyDbMs.valueOrDefault/10))}throw new Error("handleDbRetries(): timeout after "+l.Settings.maxBusyDbMs.valueOrDefault+"ms")}finally{n>0&&f.push(Date.now()-t)}}))},t.handleDbRetriesSync=function(e,t=25){let n;for(let i=0;i<t;i++)try{return e()}catch(e){if(n=e,!o.isSqliteBusyError(e))throw e}throw n}},function(e,t){e.exports=require("child_process")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.observeBatchCluster=void 0;const r=n(94),o=n(19),s=n(4),a=n(0),u=n(17),l=n(24),c=n(6),d=n(101),h=n(143),f=n(23);class m{constructor(e,t){this.name=e,this.bc=t,this._ended=!1}get endTimeoutMs(){return"sync-file"===this.name?f.CmdTimeoutMs:s.secondMs}get ended(){return this.bc.ended||this._ended}end(){return i(this,void 0,void 0,(function*(){this._ended=!0,r.setLogger(r.NoLogger),this.bc.ended||(yield this.bc.end())}))}}t.observeBatchCluster=function(e,t,n=u.EndableRanks.service){const i=c.mkLogger(t),f=new m(t,e);r.setLogger(i);const p=(e,n)=>{f.ended||u.ending()||l.isIgnorableError(n)||l.onError(t+": "+e,n)};return e.on("childStart",n=>{i.info("Started child process "+t+":"+n.pid),h.renice(n.pid).catch(e=>l.onError("renice failed for "+t,e)),d.addPid({pid:n.pid,ppid:o.pid,cmd:t,maxAgeMs:e.options.maxProcAgeMillis+s.minuteMs},new Date).catch(e=>l.onError("addPid failed for "+t,e))}),e.on("startError",e=>p("failed to start",e)),e.on("taskError",(e,t)=>{p("failed to run "+a.map(t,e=>e.command),e)}),e.on("internalError",e=>{p("internal error",e)}),e.on("endError",e=>{i.error("observeBatchCluster.endError()",e)}),u.addEndable(n,f)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFormatter=void 0;const i=n(2),r=n(9),o=n(214),s=n(215);t.DefaultLogFormatter=i.lazy(()=>r.Settings.logColor.valueOrDefault?new o.ColoredLogFormatter({processName:()=>""}):new s.PlaintextLogFormatter),r.Settings.logColor.addListener(()=>t.DefaultLogFormatter.unset())},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathIsNeverIgnoredPredicate=t.neverIgnore=t.pathIsNeverIgnored=void 0;const i=n(1),r=n(2),o=n(12),s=n(6),a=n(9),u=n(41),l=r.lazy(()=>s.mkLogger("NeverIgnoredPaths")),c=r.lazy(()=>{a.Settings.neverIgnored.addListener(()=>{d.clear(),o.emitFileChanged(),l().info("Settings.neverIgnored changed",a.Settings.neverIgnored.value)}),a.Settings.scanPaths.addListener(()=>{d.clear(),o.emitFileChanged()}),o.onClearCache(()=>d.clear())}),d=r.lazy(()=>(c(),new Set(i.compactBlanks([...a.Settings.scanPaths.values,...a.Settings.neverIgnored.values]))));function h(e){return d().has(e)||d().has(e.toLowerCase())}t.pathIsNeverIgnored=h,t.neverIgnore=function(...e){a.Settings.neverIgnored.pushFromEnv(...i.compactBlanks(e.map(e=>u.BaseFile.for(e).nativePath)))},t.pathIsNeverIgnoredPredicate=function(e){return h(e)?{pathIsNeverIgnored:()=>!1}:void 0}},,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.syncFileTimeout=t.dcrawTimeout=t.syncFileTimeoutForFile=t.syncFileTimeoutForFileMs=t.transcodeTimeout=t.transcodeTimeoutForFile=t.DurationMultiplier=t.MaxSyncFileTimeoutMs=t.MinSyncFileTimeoutMs=void 0;const r=n(219),o=n(4),s=n(0),a=n(5),u=n(35),l=n(8),c=n(16),d=n(9),h=n(40),f=n(49),m=n(23);t.MinSyncFileTimeoutMs=m.CmdTimeoutMs,t.MaxSyncFileTimeoutMs=15*o.minuteMs,t.DurationMultiplier=10;const p={p0:{x:.8*u.MB,y:4*o.secondMs},p1:{x:20*u.MB,y:12*o.secondMs}},g={p0:{x:11*u.MB,y:12*o.secondMs},p1:{x:26*u.MB,y:24*o.secondMs}},v={p0:{x:7*u.MB,y:45*o.secondMs},p1:{x:32*u.MB,y:90*o.secondMs}};function y(e){return f.isVideoExt(e.ext)?Math.max(s.orElse(c.mapGt0(e.durationMs,e=>e*t.DurationMultiplier),0),r.lerp2d(v.p0,v.p1,e.bytes)):0}function b(e){return l.thenMap(S(e),w)}function S(e){return l.thenMap(e.size(),t=>i(this,void 0,void 0,(function*(){return{bytes:t,ext:e.ext,durationMs:f.isVideoExt(e.ext)?yield l.thenMap(h.readRawTags(e),e=>c.mapGt0(e.Duration,e=>e*o.secondMs)):void 0}})))}function w(e){const n=a.clamp(.5*u.MB,64*u.GB,e.bytes),i=5*o.secondMs,s=m.CmdTimeoutMs,l=2*n*m.MinIoRate,c=e=>r.lerp2d(e.p0,e.p1,a.clamp(.5*u.MB,50*u.MB,n)),h=c(p),v="raw"===f.extType(e.ext)?c(g):0,b=y(e),S=d.Settings.validateVideos.valueOrDefault?b:0;return{result:a.clamp(t.MinSyncFileTimeoutMs,t.MaxSyncFileTimeoutMs,Math.round(i+s+l+h+v+b+S)),dbMs:i,tagMs:s,copyMs:l,thumbMs:h,rawDecodeMs:v,transcodeMs:b,validateMs:S}}t.transcodeTimeoutForFile=function(e){return f.isVideoExt(e.ext)?l.thenMap(S(e),y):void 0},t.transcodeTimeout=y,t.syncFileTimeoutForFileMs=function(e){return l.thenMap(b(e),e=>e.result)},t.syncFileTimeoutForFile=b,t.dcrawTimeout=function(e){return r.lerp2d(g.p0,g.p1,a.clamp(11*u.MB,100*u.MB,s.orElse(e,0)))},t.syncFileTimeout=w},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.rpcClientEnd=t.rpcClientReady=t.rpcClient=void 0;const r=n(260),o=n(17),s=n(8),a=n(6),u=n(310),l=n(29),c=n(9),d=n(3),h=n(4),f=n(76),m=n(2),p=n(0),g=a.mkLogger("RpcClient");t.rpcClient=m.lazy(()=>{if(l.isRpcServer())return;const e=c.Settings.rpcPort.valueOrDefault;g.debug("Creating new RPC client to "+e);const n=new u.Client("db@localhost:"+e,()=>function(e){const t=new f.Latch,n=new r.Socket;return n.on("error",e=>t.reject(e)),n.connect(e,"localhost",()=>{g.debug("Connected to "+e),t.resolve()}),t.then(()=>n)}(e));return n.addChangeListener(()=>t.rpcClientReady.unset()),n}),t.rpcClientReady=m.lazy(()=>i(void 0,void 0,void 0,(function*(){try{if(l.isRpcServer())return!1;const e=yield s.thenOrTimeout(p.map(t.rpcClient(),e=>e.ping()),h.secondMs);return d.notBlank(e)}catch(e){return g.warn("rpcClientReady(): ping failed",e),!1}})),h.minuteMs),t.rpcClientEnd=function(){return o.end(t.rpcClient.clear())}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withVacuumEvent=t.checkRemoteVacuuming=t.isVacuuming=void 0;const r=n(22),o=n(12),s=n(6),a=n(128),u=n(2),l=n(0),c=n(26),d=n(262),h=n(162);let f;const m=u.lazy(()=>s.mkLogger("Vacuum"));t.isVacuuming=function(e){return(null==e||"models"===e.schema)&&r.isTrue(f)};const p=e=>i(void 0,void 0,void 0,(function*(){"boolean"!=typeof e&&m().throw("invalid setVacuuming argument",{value:e}),m().info("setVacuuming()",{value:e}),f=e}));o.onVacuuming(p),t.checkRemoteVacuuming=function(){var e;return i(this,void 0,void 0,(function*(){return c.thenMap(null===(e=h.rpcClient())||void 0===e?void 0:e.request("isVacuuming"),e=>(m().info("checkRemoteVacuuming() received RPC value",{value:e}),l.map(e,p)))}))},t.withVacuumEvent=function(e){return i(this,void 0,void 0,(function*(){if(yield d.isLockOwner()){m().info("db vacuum starting...");try{return f=!0,a.broadcast("vacuuming",!0),yield e()}finally{f=!1,a.broadcast("vacuuming",!1),m().info("db vacuum finished.")}}}))}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqWidths=t.SqSizes=t.FitSizeValues=t.FitSizes=void 0;const i=n(36);t.FitSizes=i.strEnum("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),t.FitSizeValues=t.FitSizes.values,t.SqSizes=i.strEnum("s480","s240","s120","s60"),t.SqWidths=[60,120,240,480]},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.psWinWmic=t.pidInfos=t.notExistingPids=t.existingPids=t.pidInfo=t.ps=void 0;const r=n(19),o=n(1),s=n(3),a=n(4),u=n(21),l=n(2),c=n(0),d=n(5),h=n(11),f=n(26),m=n(15),p=n(7),g=n(17),v=n(8),y=n(20),b=n(27),S=n(82),w=n(72),M=n(6),P=n(28),E=n(14),x=n(43),T=l.lazy(()=>M.mkLogger("Ps"));function O(e){return null!=e&&d.gt0(e.pid)&&null!=e.start&&s.notBlank(e.cmd)}function F(e){return i(this,void 0,void 0,(function*(){return o.isEmpty(e)||o.arrayEql([r.pid],e)?m.toA(e):v.thenMap(_(e),e=>e.map(e=>e.pid))}))}function _(e){return i(this,void 0,void 0,(function*(){const t=m.toA(e).filter(d.gt0);if(o.isEmpty(t))throw new Error("Invalid pids: "+u.stringify(e));return f.thenTap(v.thenMap(E.isWin?function(e){return i(this,void 0,void 0,(function*(){if(g.ending()||x.PowerShell.instance().ended)return B(e);const t=[C,"-Id",A(e),"-ErrorAction SilentlyContinue",I].join(" ");return v.thenMap(x.PowerShell.instance().executeJsonToA(t),e=>D(e))}))}(t):function(e){return i(this,void 0,void 0,(function*(){return R((yield y.stdoutResult("ps",["-p",A(e),"-wwwo","pid,lstart,command"],Object.assign(Object.assign({},k),{ignoreExitCode:!0}))).result)}))}(t),e=>e.filter(e=>O(e)&&t.includes(e.pid))),e=>T().debug("pidInfo()",{pids:t,result:e}))}))}function D(e){return e.map(e=>({pid:e.Id,start:b.pwshJsonDate(e.StartTime),cmd:e.ProcessName}))}t.ps=function(){return i(this,void 0,void 0,(function*(){const e=yield E.isWin?function(){return i(this,void 0,void 0,(function*(){if(x.PowerShell.instance().ended)return B();const e=yield x.PowerShell.instance().executeJsonToA([C,I].join(" "));return null==e?B():D(e)}))}():function(){return i(this,void 0,void 0,(function*(){return R(yield y.stdout("ps",["-ewwwo","pid,lstart,command"],k))}))}();return c.orElse(o.sortBy(e.filter(O),e=>e.pid),[])}))},t.pidInfo=function(e){return i(this,void 0,void 0,(function*(){return v.thenMap(_([e]),t=>m.toA(t).find(t=>t.pid===e))}))},t.existingPids=F,t.notExistingPids=function(e){return i(this,void 0,void 0,(function*(){return o.isEmpty(e)?[]:v.thenMap(F(e),t=>{const n=[r.pid,...t];return e.filter(e=>!n.includes(e))})}))},t.pidInfos=_;const C="Get-Process",I="| Select-Object -Property Id,ProcessName,StartTime";function A(e){return o.uniq([...e.filter(d.gt0),r.pid]).join(",")}const k={maxBuffer:1048576,timeout:15*a.secondMs,ignoreExitCode:!0,ignoreStderr:!0},L=["CommandLine","CreationDate","ProcessId"];function B(e){return i(this,void 0,void 0,(function*(){const t=["process"];if(o.isNotEmpty(e)){const n=o.uniq([...e.filter(d.gt0),r.pid]).map(e=>"ProcessId="+e).join(" or ");t.push("where",n)}t.push("get",L.join(","));const n=yield y.stdoutResult(w.wmic(),t,k),i=h.onlyReqValued(S.parseFixed(L,n.result).map(e=>({pid:d.toInt(e.ProcessId,{defaultValue:-1}),start:b.wmiDate(e.CreationDate),cmd:p.toS(e.CommandLine)})));return i.find(e=>e.pid===r.pid)||i.push({pid:r.pid,start:new Date(P.start),cmd:"node "+r.title}),i}))}function R(e){return S.parseFixed(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],e).map(e=>({pid:d.toInt(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:p.toS(e.COMMAND)}))}t.psWinWmic=B},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.popExpiredLogEntries=t.pushLogEntries=t.setLogTailEnabled=t.logTailEnabled=void 0;const i=n(9),r=n(158),o=n(77),s=n(199);let a=!1;t.logTailEnabled=function(){return a},t.setLogTailEnabled=function(e){a=e};const u=[];t.pushLogEntries=function(...e){if(i.Settings.tailLogs.valueOrDefault)u.push(...e);else for(const t of e)console.log(r.DefaultLogFormatter().formatLogEntry(t))},t.popExpiredLogEntries=function(e=4*o.DefaultLogFlushMs){if(0===u.length)return[];if(s.sortLogEntriesInPlace(u),e<=0)return u.splice(0);const t=Date.now()-e,n=u.findIndex(e=>e.ts>=t);return n>=0?u.splice(0,n):u.splice(0)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.nslookup=t.octets=t.isLoopback=t.friendlyname=void 0;const r=n(241),o=n(34),s=n(3),a=n(4),u=n(5),l=n(7),c=n(80),d=n(8),h=n(12),f=n(6),m=n(242),p=n(16),g=new RegExp("^"+m.ipv4Re.source+"$");t.friendlyname=c.memoize(e=>i(void 0,void 0,void 0,(function*(){const n=null==g.exec(e)?e:yield t.nslookup(e);return l.toS(n).toLowerCase().normalize()})),10*a.minuteMs,128);const v=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function y(e){return null!=v.exec(e)}function b(e){const t=e.split(".").map(e=>u.toInt(e)).filter(e=>p.within(0,255,e));return 4===t.length?t:void 0}t.isLoopback=y,t.octets=b;const S=o.promisify(r.reverse),w=o.promisify(r.resolve4),M=f.mkLogger("nslookup");t.nslookup=c.memoize(e=>i(void 0,void 0,void 0,(function*(){try{const t=yield d.thenOrTimeout(()=>y(e)?e.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=b(e)?S(e):w(e),10*a.secondMs);if(null==t)return M.info("nslookup("+e+"): timeout"),e;const n=t.find(s.notBlank);return null==n?(M.warn("No name found for "+e),e):n}catch(t){return M.warn("Failed to look up "+e+", using name.",t),e}})),10*a.minuteMs,256),h.onClearCache(()=>t.nslookup.clear())},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._netInfoWinWmic=t.parseRemoteName=t.NetInfoCmd=t.addRemoteVolumeInfoWin=void 0;const r=n(1),o=n(3),s=n(4),a=n(0),u=n(18),l=n(7),c=n(57),d=n(8),h=n(20),f=n(12),m=n(82),p=n(72),g=n(85),v=n(25),y=n(14),b=n(43),S=n(10),w=n(38),M=n(23);t.addRemoteVolumeInfoWin=function(e,t){return i(this,void 0,void 0,(function*(){if(!y.isWin)throw new Error("wtf");return yield d.thenMap(a.orElse(t,()=>_()),t=>{const n=g.toMap(t,e=>[e.mountpoint,e]);e.forEach(e=>{a.map(n.get(e.mountpoint),t=>{e.remote=!0,e.remoteHost=t.host,e.remoteShare=t.share,e.remoteOK=t.ok})})}),e}))};const P=["LocalName","RemoteName","Status"],E=["NETUSE","get",P.join(",")],x=/^\\\\(.+?)\\(.+)$/,T=/^[a-z]:\\?$/i;function O(e){if(!o.blank(e))return u.Opt(e).flatMap(e=>x.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>u.Opt(e).flatMap(e=>v.Try(()=>new URL(e))).filter(e=>o.notBlank(e.hostname)).map(e=>({host:e.hostname,share:u.Opt(e.pathname).filter(o.notBlank).getOrElse(()=>"/")}))).get()}function F(){return i(this,void 0,void 0,(function*(){const e=p.wmic(),t=yield h.stdout(e,E,{timeout:15*s.secondMs}),n=m.parseFixed(P,t);return r.compact(n.map(e=>a.map(x.exec(l.toS(e.RemoteName)),t=>a.map(T.exec(l.toS(e.LocalName)),n=>({mountpoint:S.ensureSuffix(n[0],"\\"),host:t[1],share:t[2],ok:"OK"===e.Status})))))}))}t.NetInfoCmd="Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status",t.parseRemoteName=O,t._netInfoWinWmic=F;const _=c.keyedLazy("netInfoWin",w.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=yield b.PowerShell.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return null==e?F():r.compact(e.filter(e=>o.notBlank(e.LocalName)).map(e=>a.map(O(e.RemoteName),({host:t,share:n})=>a.map(T.exec(l.toS(e.LocalName)),i=>({mountpoint:S.ensureSuffix(i[0],"\\"),host:t,share:n,ok:"OK"===e.Status&&"Connected"===e.ConnectionState})))))}))}),M.KeyedLazyVolumeOpts);f.onClearCache(()=>_.clear())},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.hidden=void 0;const r=n(3),o=n(4),s=n(5),a=n(18),u=n(20),l=n(14),c=n(43);t.hidden=function(e){return!!e.base.startsWith(".")||(l.isWin?function(e){return i(this,void 0,void 0,(function*(){const t=yield c.PowerShell.instance().executeJsonToA(["Get-Item -Force -LiteralPath",c.pwshQuote(e.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return a.Opt(t).flatMap(e=>e[0]).flatMap(e=>e.Mode).filter(r.notBlank).flatMap(e=>e.includes("h")||e.includes("s")).getOrElse(()=>!1)}))}(e):!!l.isMac&&function(e){return i(this,void 0,void 0,(function*(){try{const t=yield u.stdout("stat",["-f","%f",e.nativePath],{timeout:10*o.secondMs}),n=s.toInt(t);return null!=n&&(32768&n)>0}catch(e){return!1}}))}(e))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ignorableDirectory=t.ignorablePredicates=t.ignorableDirectoryPredicates=t.ignorableFile=t.ignorablePath=t.ignorablePathPredicates=t.Ignorable=void 0;const r=n(1),o=n(3),s=n(2),a=n(48),u=n(8),l=n(61),c=n(252),d=n(6),h=n(28),f=n(14),m=n(253),p=n(38),g=n(170),v=n(159),y=n(153),b=n(30),S=n(33),w=n(254),M=n(255);class P{constructor(e=h.isTest){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","var","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize())),this.ignorableDirectories=new Set(["__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Data","Application Support","Applications","arangodb","cache","caches","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","steamapps","System Volume Information","System32","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase())),this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/.*?\.photos?library\/(?!Masters?\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Smart Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i],this.systemDirs=r.uniq(r.compactBlanks([a.App.appData(),l.getEnv("APPDATA"),l.getEnv("SYSTEMROOT"),l.getEnv("ProgramFiles"),l.getEnv("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize())),this.ignorableSubdirs=new m.SetSet,f.isLinux&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);const t=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",t),this.addIgnorableSubdirs("cygwin",t),this.addIgnorableSubdirs("cygwin64",t),this.addIgnorableSubdirs("local",t),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...t]),this.addIgnorableSubdirs("var",["cache","crash","lib","local","log","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);const n=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",n),this.addIgnorableSubdirs("Perl64",n),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(l.getEnv("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),f.isWin&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,t){if(o.blank(e))return;const n=e.toLowerCase().normalize();r.compactBlanks(t).forEach(e=>this.ignorableSubdirs.add(n,e.toLowerCase().normalize()))}ignorablePathPredicates(e){const t=v.pathIsNeverIgnoredPredicate(e);if(null!=t)return t;const n=e.toLowerCase().normalize(),i=r.compactBlanks(b.pathnames(n));return{hiddenPosix:()=>i.some(e=>e.startsWith(".")),systemDir:()=>this.systemDirs.some(e=>n.startsWith(e)),ignorableRoot:()=>this.ignorableRootDirectories.has(i[0]),ignorableDirectory:()=>i.some(e=>this.ignorableDirectories.has(e)),ignorablePath:()=>this.ignorableSubdirs.has(i),ignorablePattern:()=>{const t=b.native2posix(e);return this.ignorableDirectoryPatterns.some(e=>e.test(t))}}}ignorablePath(e){return c.orLogged([this.ignorablePathPredicates(e)],e,d.mkLogger("ignorablePath()"))}}t.Ignorable=P;const E=s.lazy(()=>new P);function x(e){return Object.assign(Object.assign({},E().ignorablePathPredicates(e)),{notExists:()=>S.PosixFile.for(e).notExists()})}function T(e){return E().ignorablePath(e)}function O(e){const t=e.nativePath.toLowerCase().normalize();return v.pathIsNeverIgnored(e.nativePath)||v.pathIsNeverIgnored(t)?{pathIsNeverIgnored:()=>!1}:Object.assign(Object.assign({},x(e.nativePath)),{snapDirectory:()=>i(this,void 0,void 0,(function*(){return f.isLinux&&(yield M.ignorableSnapDir.apply(e))})),noMedia:()=>y.hasNoMedia(e),hidden:()=>g.hidden(e),seemsRecursive:()=>w.seemsRecursive(e.pathnames),mountpoint:()=>i(this,void 0,void 0,(function*(){return u.thenMapOr(p.mountpoints(),t=>t.includes(e.nativePath),()=>!1)}))})}t.ignorablePathPredicates=x,t.ignorablePath=T,t.ignorableFile=function(e){return T(e.nativePath)},t.ignorableDirectoryPredicates=O,t.ignorablePredicates=function(e){return i(this,void 0,void 0,(function*(){return(yield e.isDirectory())?O(e):x(e.nativePath)}))},t.ignorableDirectory=function(e){return i(this,void 0,void 0,(function*(){return c.orLoggedAsync([O(e)],e.nativePath,d.mkLogger("ignorableDirectory()"))}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bits=t.pop=t.bitsSet=t.bitUnzip=t.bitZip=t.diffConcattedBits=t.splitBits=t.concatBits=void 0;const i=n(1),r=n(0),o=n(5),s=n(13),a=n(51);function u(e,t){const n=Math.pow(2,t),i=[];for(;e>0;)i.unshift(e%n),e=Math.floor(e/n);return i}function l(e){return e.toString(2).split("").reverse().map((e,t)=>"1"===e?t:-1).filter(e=>-1!==e)}t.concatBits=function(e,t){const n=Math.pow(2,t);return e.reduce((e,t)=>e*n+o.clamp(0,n,o.toInt(t,{defaultValue:0})),0)},t.splitBits=u,t.diffConcattedBits=function(e,t,n){return r.map2(e,t,(e,t)=>i.sum(s.zip(u(e,n),u(t,n)),([e,t])=>o.absdiff(e,t)))},t.bitZip=function(e){e.dims.forEach(e=>e.value=o.clamp(e.min,e.max,e.value));let t=0;for(let n=0;n<e.bitDepth;n++){t*=2;const i=n%e.dims.length,r=e.dims[i],o=a.avg([r.min,r.max]);r.value>o?(t+=1,r.min=o):r.max=o}return t},t.bitUnzip=function(e,t){if(t.bitDepth>52||t.bitDepth<0)return;const n=l(e);for(let e=0;e<t.bitDepth;e++){const i=e%t.dims.length,r=t.dims[i],o=a.avg([r.min,r.max]);n.includes(t.bitDepth-e-1)?r.min=o:r.max=o}return t.dims.map(e=>a.avg([e.min,e.max]))},t.bitsSet=l,t.pop=function(e){return e=(e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135,e+=e>>8,63&(e+=e>>16)},t.bits=function(e,t){return i.sum(e,(n,i)=>t(n,i)?Math.pow(2,e.length-i-1):0)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetUrls=void 0;const i=n(1),r=n(96),o=n(165),s=n(0),a=n(5),u=n(7);class l{constructor(e,t=""){this.query="",this.query=t,this.assetId=a.isNumber(e)?e:e.id}static onNewPage(){this.pageImageCount=0}get unset(){return null==this.assetId||this.assetId<=0}assetUrl(){return this.unset?"":`/asset/${this.assetId}${this.query}`}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,t){return`/img/${this.assetId}/${e}/${t}${this.query}`}imgActualLink(e){return`/img/${i.compact([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e,t="m"){return Object.assign(Object.assign({},this.imgAttrs("sq",o.SqWidths,e)),{sizes:"s"==t?"120px":"m"==t?"240px":"480px"})}imgAttrs(e,t,n,i){if(this.unset)return{src:"/images/clear-64.png"};const o=Math.min(...t),a={width:u.toS(o)},d=this.imgLink(e,o);l.pageImageCount++,(n=s.orElse(n,()=>l.pageImageCount>72))?(a.src="/images/clear-64.png",a["data-src"]=d):a.src=d,e===r.ReducerNames.sq&&(a.height=u.toS(o));const h=t.map(t=>c(this.imgLink(e,t),t));return s.map(i,e=>h.push(c(this.imgActualLink(),e.width))),a[(n?"data-":"")+"srcSet"]=h.join(","),a}}function c(e,t){return e+" "+t+"w"}t.AssetUrls=l,l.pageImageCount=0},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathToDb=t.SqliteExt=void 0,t.SqliteExt=".sqlite3",t.pathToDb=function(e,n){return e.join(n,"db"+t.SqliteExt)}},function(e,t){e.exports=require("readline")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readFileType=void 0;const r=n(297),o=n(65),s=n(31),a=n(3),u=n(4),l=n(69),c=n(8),d=n(56),h=n(12),f=n(10),m=n(40),p=n(298),g=new d.BoundedMap(5*u.minuteMs,1024,!1);function v(e){return f.stripPrefix(s.extname(e),".")}h.onClearCache(()=>g.clear()),h.onFileChanged(e=>null==e?g.clear():g.delete(e)),t.readFileType=function(e){return i(this,void 0,void 0,(function*(){return g.getOrSet(e,()=>i(this,void 0,void 0,(function*(){const{buffer:t}=yield p.readFilePart(e,0,248);return l.thenOpt(r.fromBuffer(t)).filter(e=>"image/tiff"!==e.mime).orElse(()=>l.thenOpt(c.resolved(o.stat(e))).filter(e=>e).flatMap(()=>m.exiftool().readRaw(e,["-mimetype"])).flatMap(e=>e.MIMEType).filter(a.notBlank).map(t=>({ext:v(e),mime:t})).get()).get()})))}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ungeohash_num=t.ungeohash=t.geohashNumeric=t.geohashNumericShort=t.geohash=t.validLatLon=void 0;const i=n(0),r=n(172),o=n(60),s=n(16);function a(e,t){return s.within(-90,90,e)&&s.within(-180,180,t)&&0!==e&&0!==t}function u(e,t,n=50){return a(e,t)?r.bitZip({dims:[{min:-180,value:t,max:180},{min:-90,value:e,max:90}],bitDepth:n}):void 0}function l(e,t=52){return i.map(r.bitUnzip(e,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:t}),e=>e.reverse())}t.validLatLon=a,t.geohash=function(e,t,n=52){return i.map(u(e,t,n),e=>o.GeoRadix.encode(e))},t.geohashNumericShort=function(e,t){return u(e,t,30)},t.geohashNumeric=u,t.ungeohash=function(e,t=52){return i.map(o.GeoRadix.decode(e),e=>l(e,t))},t.ungeohash_num=l},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dcraw=t.dcrawSupportedMimetype=t.dcrawSupported=t.dcrawSupportedMimeTypes=void 0;const r=n(4),o=n(7),s=n(35),a=n(8),u=n(20),l=n(24),c=n(299),d=n(176),h=n(111),f=n(149),m=n(6),p=n(40),g=n(67),v=n(133),y=n(193),b=n(161);t.dcrawSupportedMimeTypes=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);const S=m.mkLogger("dcraw");function w(e){return S.tap({msg:"dcrawSupportedMimetype("+e+")",result:t.dcrawSupportedMimeTypes.has(o.toS(e).toLowerCase())})}t.dcrawSupported=function(e){return i(this,void 0,void 0,(function*(){try{return w(yield a.thenMap(d.readFileType(e.nativePath),e=>e.mime))}catch(e){return S.warn("dcrawSupported(): failed to read filetype",e),!1}}))},t.dcrawSupportedMimetype=w;const M=y.ImageSize.largestFit().megapixels();t.dcraw=function(e){return i(this,void 0,void 0,(function*(){const t=Date.now(),n=yield p.readTags(e.nativePath),o=v.tmegapixels(n),a=null!=o&&o>4*M?["-h"]:[],d=yield f.dcrawNativePath(),m=["-T","-c","-H","2","-w","-o","1",...a,"-t","0","-q","2",e.nativePath],y=5*r.minuteMs,w={encoding:"buffer",timeout:y,maxBuffer:250*s.MB};S.debug("dcraw()",{cmd:d,args:m,opts:w});const P=yield u.execFile(d,m,y,w),E=t=>i(this,void 0,void 0,(function*(){(yield c.emitSafely(P.stdout,"error","Problem from "+e+": "+l.cleanError(t,e.nativePath)))||S.error("No listeners for error when reading "+e,t),P.kill("SIGINT")}));P.on("error",E),P.stderr.on("data",E);const x=b.dcrawTimeout(yield e.size())/Math.sqrt(g.maxCpus()),T=new h.PullProgressObserver({path:e.nativePath,op:"Converting raw image"},x,()=>Date.now()-t);return P.on("close",()=>T.end()),P.stdout}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rgbhex2hsv=t.diffCIE94Corr=t.MaxCie=t.MinCie=t.closestLab=t.diffCIE94rgb=t.diffCIE94=t.diffCIE76=t.unlabhash=t.labhash=t.xyz2rgb=t.lab2xyz=t.xyz2lab=t.rgb2xyz=t.clampLab=t.clampRGB=t.lab2rgb=t.rgb2lab=t.rgb2labs=t.lab2rgbhex=t.rgbhex2Labhash=t.rgbhex2Lab=t.rgbhex2triplet=void 0;const i=n(0),r=n(5),o=n(7),s=n(13),a=n(172),u=n(231),l=n(10),c=n(1),d=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],h=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];function f(e){return i.map(o.toS(e).match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),e=>[e[1],e[2],e[3]].map(e=>parseInt(e,16)))}function m(e){return M(y(e))}function p(e){return g(E(P(e)))}function g(e){return[e[0],e[1],e[2]].map(e=>r.clamp(0,255,e))}function v(e){return[r.clamp(0,100,e[0]),r.clamp(-100,100,e[1]),r.clamp(-108,100,e[2])]}function y(e){const t=g(e).map(e=>e/255).map(e=>e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92);return u.matXvec(d,t)}t.rgbhex2triplet=f,t.rgbhex2Lab=function(e){return i.map(f(e),m)},t.rgbhex2Labhash=function(e,t){return i.map(f(e),e=>x(m(e),t))},t.lab2rgbhex=function(e){return"#"+p(e).map(e=>l.leftPad(e.toString(16),2,"0")).join("")},t.rgb2labs=function(e){const t=[];for(let n=0;n<e.length;n+=3)t.push(...m([e[n],e[n+1],e[n+2]]));return t},t.rgb2lab=m,t.lab2rgb=p,t.clampRGB=g,t.clampLab=v,t.rgb2xyz=y;const b=.95047,S=1,w=1.08883;function M(e){const[t,n,i]=u.vecXvec(e,[1/b,1/S,1/w]).map(e=>e>216/24389?Math.pow(e,1/3):(24389/27*e+16)/116);return[116*n-16,500*(t-n),200*(n-i)]}function P(e){const[t,n,i]=v(e),r=(t+16)/116,o=n/500+r,s=r-i/200,a=o*o*o,u=s*s*s,l=a>216/24389?a:(116*o-16)/(24389/27),c=t>8?Math.pow(r,3):t/(24389/27);return[l*b,c*S,(u>216/24389?u:(116*s-16)/(24389/27))*w]}function E(e){return u.matXvec(h,e).map(e=>{const t=e<0?-1:1,n=e*t;return r.round(255*t*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055))})}function x(e,t){return a.bitZip({dims:[{value:e[0],min:0,max:100},{value:e[1],min:-80,max:80},{value:e[2],min:-80,max:80}],bitDepth:t})}function T(e,t){if(c.arrayEql(e,t))return 0;const[n,i,o]=e,[s,a,u]=t,l=n-s,d=i-a,h=o-u,f=Math.sqrt(Math.pow(i,2)+Math.pow(o,2)),m=f-Math.sqrt(Math.pow(a,2)+Math.pow(u,2)),p=(g=Math.sqrt(Math.pow(d,2)+Math.pow(h,2)-Math.pow(m,2)),r.isNumber(g)?g:0);var g;const v=1+.045*f,y=1+.015*f;return Math.sqrt(Math.pow(l,2)+Math.pow(m/v,2)+Math.pow(p/y,2))}t.xyz2lab=M,t.lab2xyz=P,t.xyz2rgb=E,t.labhash=x,t.unlabhash=function(e,t){return a.bitUnzip(e,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:t})},t.diffCIE76=function(e,t){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))},t.diffCIE94=T,t.diffCIE94rgb=function(e,t){return T(m(e),m(t))},t.closestLab=function(e,t){return s.leastBy(e,e=>T(e,t))},t.MinCie=2,t.MaxCie=50,t.diffCIE94Corr=function(e,n){return null==e||null==n?1:r.clamp(0,t.MaxCie,T(e,n)-t.MinCie)/t.MaxCie},t.rgbhex2hsv=function(e){let t,n,i,r=0,o=0;const[s,a,u]=f(e).map(e=>e/255),l=Math.max(s,a,u),c=l-Math.min(s,a,u),d=e=>(l-e)/6/c+.5;return 0!==c&&(o=c/l,t=d(s),n=d(a),i=d(u),s===l?r=i-n:a===l?r=1/3+t-i:u===l&&(r=2/3+n-t),r<0?r+=1:r>1&&(r-=1)),[360*r,100*o,100*l]}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.imageHash=t.ModeDim=t.HashDim=t.maxPerBits=t.ModeCount=t.ModeBits=void 0;const r=n(73),o=n(1),s=n(3),a=n(4),u=n(21),l=n(0),c=n(5),d=n(108),h=n(8),f=n(70),m=n(56),p=n(27),g=n(12),v=n(99),y=n(6),b=n(278),S=n(231),w=n(290),M=n(51),P=n(40),E=n(179),x=n(113),T=n(135);t.ModeBits=12,t.ModeCount=7,t.maxPerBits=function(e){return Math.floor(52/e)};const O=y.mkLogger("ImageHash"),F=new m.BoundedMap(3e5,500,!0);function _(e,n=!0){return i(this,void 0,void 0,(function*(){const i=y.mkLogger("ImageHash("+e+")");try{const a=!n,u=yield T.sharpReadable(e,t.ModeDim,a);if(null==u)return void i.warn("Cannot build readable stream");if(null==(yield x.dimensions(e)))return void i.warn("Can't extract dimensions");let l=r(u.nativePath).removeAlpha().toColorspace("srgb").trim().resize(Object.assign(Object.assign({},t.ModeDim),{fit:"fill",kernel:"lanczos3",fastShrinkOnLoad:!0,withoutEnlargement:!0}));a||(yield h.thenMap(P.readRotation(e),e=>l=l.rotate(e)));const f=yield l.raw().toBuffer({resolveWithObject:!0}),m=r(f.data,{raw:Object.assign(Object.assign({},f.info),{channels:3})}),{data:p}=yield m.resize({width:t.HashDim,height:t.HashDim,fit:"fill"}).raw().toBuffer({resolveWithObject:!0}),g=function(e){const t=[[],[],[]];for(let n=0;n<e.length;n+=3){const i=E.rgb2lab([e[n],e[n+1],e[n+2]]);t[0].push(i[0]),t[1].push(i[1]),t[2].push(i[2])}return t}(p),v=c.times(3,e=>M.avg(g[e])),y=n?d.normalizeRotation(90*S.leastQuarter(g[0],{col:t.HashDim,row:t.HashDim})+180):0,O=g.map(e=>w.rotateSquareMatrix(e,y)).map((e,t)=>{const n=v[t];return e.map(e=>e>=n?1:0)}),F=(s=o.flatten(O),b.b64encode(BigInt("0b0"+s.map(e=>1===e?1:0).join("")))),{data:_}=yield f;return{meanHash:F,modes:function(e){const n=o.stepRange(0,e.length,3,t=>E.rgb2lab([e[t],e[t+1],e[t+2]]));return M.modes(n.map(e=>E.labhash(e,t.ModeBits)),t.ModeCount)}(_)}}catch(t){return void i.warn("Failed to imageHash("+e.nativePath+")",t)}var s}))}g.onClearCache(()=>F.clear()),g.onFileChanged(e=>s.notBlank(e)?F.delete(e):F.clear()),g.onFileCopied((e,t)=>l.map(F.get(e),e=>F.getOrSet(t,()=>e))),t.HashDim=8,t.ModeDim={width:96,height:96},t.imageHash=function(e,t=!0){return i(this,void 0,void 0,(function*(){const n=u.stringify({p:e.nativePath,rotationInvariant:t});return F.getOrSet(n,()=>p.elapsedAsync(()=>f.time("img.imageHash "+e.normalizedExt,()=>_(e,t))).then(({elapsedMs:t,result:n})=>O.tap({level:v.ms2level(t,5*a.secondMs),msg:"imageHash()",result:n,meta:{file:e.nativePath,elapsedMs:t}})))}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetTag=void 0;const i=n(12),r=n(223),o=n(1),s=n(4),a=n(0),u=n(5),l=n(11),c=n(185),d=n(132);i.onClearCache(()=>h.clear());class h extends c.Model{static clear(){this.assetId2tagIds.clear()}$pk(){return[a.orElse(this.assetId,()=>a.map(this.asset,e=>e.id)),a.orElse(this.tagId,()=>a.map(this.tag,e=>e.id))].join(":")}static addTagsToAsset(e,t){const n=u.id(e);if(null==n)return void this.logger().warn("addTagsToAsset(): got null assetId");const i=o.compact(t.map(u.id));if(o.isEmpty(i))return void this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:t});const r="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+i.map(e=>`(${n},${e})`).join(",");return d.Tag.onAssetTagChange(),t.forEach(t=>this.assetId2tagIds.add(e,t)),this.dbr(e=>e.run(r))}static removeTagsFromAsset(e,t){t=o.compact(t),d.Tag.onAssetTagChange();const n=this.query().whereIn("tagId",t).andWhere({assetId:e}).delete();return l.tap(this.dbr(e=>e.run(n)),()=>t.forEach(t=>this.assetId2tagIds.delete(e,t)))}}t.AssetTag=h,h.tableName="AssetTag",h.uniqueColumnName="assetId,tagId",h.assetId2tagIds=new r.TTLMultiMap(5*s.minuteMs)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeProgressEvtListener=t.onProgressEvt=t.emitProgressEvt=t.isProgressEvt=void 0;const i=n(3),r=n(5),o=n(16),s=n(12);function a(e){return null!=e&&i.notBlank(e.path)&&i.notBlank(e.op)&&o.within(0,100,e.pct)}t.isProgressEvt=a;t.emitProgressEvt=function(e){a(e)&&s.eventEmitter.emit("progress",Object.assign(Object.assign({},e),{pct:r.round(r.clamp(0,100,e.pct))}))},t.onProgressEvt=function(e){s.eventEmitter.on("progress",e)},t.removeProgressEvtListener=function(e){return s.eventEmitter.removeListener("progress",e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseEnvTokens=void 0,t.parseEnvTokens=function(e){const t=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+)/gim,n={};let i;for(;null!=(i=t.exec(e));){const[,e,,t]=i;n[e.toLowerCase()]=t.replace(/\\"/g,'"').replace(/\\'/g,"'")}return n}},,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Model=void 0;const r=n(34),o=n(22),s=n(6),a=n(28),u=n(312),l=n(1),c=n(3),d=n(0),h=n(11),f=n(42),m=n(26),p=n(7),g=n(228),v=n(150),y=n(151),b=n(197),S=n(263),w=n(264);class M{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return null==this._logger&&(this._logger=s.mkLogger(this.tableName)),this._logger}static query(){return v.knex(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static dbr(e){return e(this.dbLocal())}static dbLocal(){return null==this._dbLocal&&(this._dbLocal=new g.DbRequestLocal(this.db,this.tableName)),this._dbLocal}static txOp(e){return i(this,void 0,void 0,(function*(){return y.tx(this.db(),()=>e(this.ops()))}))}static tx(e,t=!1){return i(this,void 0,void 0,(function*(){return y.tx(this.db(),()=>e(this.dbLocal()),t)}))}static ops(){return w.ModelOpsLocal.forModel(this,this.db)}static op(e){return i(this,void 0,void 0,(function*(){return e(this.ops(),this.query())}))}static truncate(){if(a.isProd)throw new Error("rejecting attempt to truncate in prod");return this.dbr(e=>e.exec("DELETE FROM "+this.tableName))}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return p.toS(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${d.orElse(this.id,this[this.class().uniqueColumnName])})`}logger(){return s.mkLogger(p.toS(this.valueOf()))}[r.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return S.fromJSON(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}static toDbJSON(e,t){return this.fromJSON(e).$toDbJSON(t)}$toShallowJSON(){return this.$_toJSON(o.isTrue)}$toDbJSON(e){const t=this.$_toJSON(o.boolToInt,!1);return c.notBlank(e)?h.pick(t,...e):t}toJSON(){return this.$_toJSON(o.isTrue)}$_toJSON(e,t=!0){const n=this.class();return h.mapFields(this,(t,i)=>{if(null!=i&&f.isPrimitive(i))return l.includes(n.booleanFields,t)?[t,e(i)]:[t,i]},t?{$ctor:n.$ctor}:{})}insert(){return i(this,void 0,void 0,(function*(){return S.assignFromJSON(this,yield this.class().ops().insertOne(this))}))}update(e){return u.atap(this.class().dbr(t=>t.exec(this.class().query().where({id:this.id}).update(e))),()=>{S.assignFromJSON(this,e)})}upsert(){return i(this,void 0,void 0,(function*(){return S.assignFromJSON(this,yield this.class().ops().upsertOne(this))}))}$beforeUpsert(){}reload(){return i(this,void 0,void 0,(function*(){return m.thenMap(this.class().ops().findById(this.id),e=>S.assignFromJSON(this,e))}))}delete(){return d.map(this.id,e=>this.class().ops().delete([e]))}}t.Model=M,M.schema="models",M.db=b.modelDb},function(e,t){("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"0.8.0-beta.9+20200622024342"}},function(e,t){e.exports=require("commander")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addFooter=t.CliDesc=t.descriptionFooter=void 0;const i=n(19),r=n(97),o=(new Date).getFullYear();t.descriptionFooter=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.\n\nCopyright Â© 2017-${o}, PhotoStructure Inc.\n\nRunning this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,t.CliDesc={main:"PhotoStructure's main process manager. Kicks off web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",ls:"List all paths in a Library.",logcat:"Pretty-print a PhotoStructure logfile.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."},t.addFooter=function(e){return e.on("--help",()=>{var e;console.log("\n"+r.wrap(t.descriptionFooter,{maxLineLen:null!==(e=i.stdout.columns)&&void 0!==e?e:78,prefix:""}).join("\n")+"\n")})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isList=void 0;const i=n(39);t.isList=function(e){return null!=e&&(Array.isArray(e)||isFinite(e.length)&&i.isFunction(e[Symbol.iterator])&&i.isFunction(e.push)&&i.isFunction(e.pop)&&i.isFunction(e.forEach)&&i.isFunction(e.some))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLArray=void 0;const i=n(5);class r{constructor(e,t){this.ttlMs=e,this.maxLength=t,this.times=[],this.a=[]}[Symbol.iterator](){this.vacuum();const e=[...this.a];return function*(){for(const t of e)yield t}()}push(...e){i.times(e.length,()=>this.times.push(Date.now())),this.a.push(...e),null!=this.maxLength&&this.vacuum()}pushUniq(...e){e.forEach(e=>{this.includes(e)||this.push(e)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;if(null!=this.maxLength){const e=this.a.length-this.maxLength;this.times.splice(0,e),this.a.splice(0,e)}const e=Date.now()-this.ttlMs,t=this.times.findIndex(t=>t>e);-1===t?this.clear():t>0&&(this.times.splice(0,t),this.a.splice(0,t))}}t.TTLArray=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mapParsed=t.parseMaybe=void 0;const i=n(3),r=n(25);t.parseMaybe=function(e){return i.mapNotBlank(e,e=>r.Try(()=>JSON.parse(e)))},t.mapParsed=function(e,t){try{if(null==e)return;return t(JSON.parse(e))}catch(e){return}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.WatchedChild=t.mkBasicWatchedChild=void 0;const r=n(1),o=n(3),s=n(4),a=n(37),u=n(2),l=n(0),c=n(5),d=n(18),h=n(17),f=n(8),m=n(44),p=n(27),g=n(24),v=n(102),y=n(62),b=n(6),S=n(93),w=n(25),M=n(101),P=n(29),E=n(9),x=n(52),T=n(20);t.mkBasicWatchedChild=function(e){return new O(Object.assign({name:r.compact([e.cmd,...e.args]).join(" "),childFactory:()=>T.spawn(e.cmd,e.args,30*s.minuteMs),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},e))};class O{constructor(e){this.startMs=Date.now(),this._stopped=!1,this.logger=u.lazy(()=>b.mkLogger("WatchedChild("+r.compact([this.name,this.pid]).join(":")+")")),this.startRate=new S.Rate(2*s.minuteMs),this.mutex=new m.Promises,this._ended=!1,this.onError=(e,t)=>i(this,void 0,void 0,(function*(){const n=g.isFatalError(e)||g.isFatalError(t),i=new x.WrappedError({message:e+l.map(t,a.errorToS),cause:g.ifError(t)}),r=g.isIgnorableError(i),o={src:e,fatal:n,ignorable:r,errToS:a.errorToS(t)};if(this.logger().log(r?"warn":"error","onError()",o),this._ended||r)return;if(this.lastError=i,g.onError(e,i),n)return this.end();return this.opts.onError(e,t)?(this.logger().warn("onError requested restart",o),this._restart()):void 0})),this.name=e.name,this.opts=Object.assign({dataSep:"\n",maxErrorsPerMinute:3,endableRank:h.EndableRanks.first,exitCommand:"",restartOnExit:!0},e),this.endTimeoutMs=P.serviceShutdownTimeoutMs(this.name),h.addEndable(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}end(){return i(this,void 0,void 0,(function*(){return this._ended=!0,this._stop()}))}get proc(){return this.cp}get pid(){return l.map(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return l.mapOr(this.pid,e=>M.pidExists(e),()=>i(this,void 0,void 0,(function*(){return!1})))}notRunning(){return f.thenNot(this.running())}stop(){return i(this,void 0,void 0,(function*(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}))}_stop(){return i(this,void 0,void 0,(function*(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});const e=this.cp;return this.cp=void 0,null==e||this.stopChild(e)}))}stopChild(e){return i(this,void 0,void 0,(function*(){return yield d.Opt(this.opts.exitCommand).filter(o.notBlank).flatMap(t=>d.Opt(e).flatMap(e=>e.stdin).filter(e=>e.writable).forEach(e=>w.Try(()=>e.write(t+"\n"))).map(y.end).get()),T.endProcess(e,this.endTimeoutMs)}))}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:c.gt(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}restart(e=!1){return i(this,void 0,void 0,(function*(){return this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),!this._ended&&!h.ending()&&(!e&&this.startRate.msSinceLastEvent<E.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault?void this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:E.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault}):this.mutex.serial(`WatchedChild(${this.name}).restart`,()=>i(this,void 0,void 0,(function*(){return yield this._stop(),this._stopped=!1,this._start()}))))}))}start(){return i(this,void 0,void 0,(function*(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,()=>i(this,void 0,void 0,(function*(){return this._stopped=!1,this._start()})))}))}_restart(){return i(this,void 0,void 0,(function*(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,()=>i(this,void 0,void 0,(function*(){var e,t;return yield this._stop(),!this._stopped&&!this._ended&&(this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),p.isRecentMs(this.startMs,E.Settings.probationMs.valueOrDefault)&&g.onError("Can't restart "+this.name+", failure rate is too high."+g.FatalErrorFlag,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),null===(t=(e=this.opts).onRestart)||void 0===t||t.call(e),this._start()))})))}))}_start(){return i(this,void 0,void 0,(function*(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended)return!1;if(yield this.running())return!1;this.startRate.onEvent();const e=this.cp=yield this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);const t="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:e,desc:n})=>{l.map(e,e=>e.on("error",e=>this.onError(t+n+".on(error)",e)))}),l.map(this.cp.stdout,e=>v.onDataChunked(e,this.opts.dataSep,e=>{this.logger().trace("onDataChunked()",e),this.opts.onStdout(e)})),l.map(this.cp.stderr,e=>e.on("data",e=>{var n,i;e.toString().includes("Error: Cannot find module")&&g.onError("Failed to start "+this.name+g.FatalErrorFlag,new Error(e)),!0===(null===(i=(n=this.opts).onStderr)||void 0===i?void 0:i.call(n,e))&&this.onError(t+".stderr.on(data)",e)})),this.cp.on("exit",(e,t)=>{this.logger().info("onExit",{code:e,signal:t,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?this._restart():(this.logger().info("onExit(): this.opts.restartOnExit is false, so we're done."),this.end())}),this.logger().info("_start(): finished setting up new child "+this.pid),!0}))}}t.WatchedChild=O},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageSize=void 0;const i=n(34),r=n(84),o=n(2),s=n(35),a=n(13),u=n(9),l=n(300);class c{constructor(e,t,n,i,r=!0){this.name=e,this.maxWidth=t,this.maxHeight=n,this.reducer=i,this.rotational=r,this.megapixels=o.lazy(()=>s.megapixels(this.maxWidth*this.maxHeight)),this.max={width:t,height:n},c._Sizes.push(this)}static sq(){return this._Sizes.filter(e=>e.reducer===l.Square)}static largestSq(){return a.greatestBy(this.sq(),e=>e.megapixels())}static fit(){const e=u.Settings.previewResolutions.valueOrDefault;return this._Sizes.filter(t=>t.reducer===l.Fit&&e.includes(t.name))}static largestFit(){return a.greatestBy(this.fit(),e=>e.megapixels())}[i.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"Ã"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&r.isPortrait(e)?r.flip(this.max):this.max,e)}resize(e,t){return t=t.resize(Object.assign(Object.assign({},e),{fit:this.reducer.fit,withoutEnlargement:!0}))}toJpeg({path:e,sh:t,outputSize:n}){return(r.dmegapixels(n)<2||u.Settings.sharpen.valueOrDefault)&&(t=t.sharpen()),t.jpeg({quality:85,progressive:u.Settings.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}}t.ImageSize=c,c._Sizes=[],c.UHD8k=new c("uhd8k",7680,4320,l.Fit,!1),c.UHD5k=new c("uhd5k",5120,2880,l.Fit,!1),c.UHD=new c("uhd4k",4096,2160,l.Fit),c.QHD=new c("qhd",3120,1440,l.Fit),c.FHD=new c("fhd",1920,1080,l.Fit),c.HD=new c("hd",1280,720,l.Fit),c.WVGA=new c("wvga",720,480,l.Fit),c.QVGA=new c("qvga",320,240,l.Fit),c.QQVGA=new c("qqvga",160,120,l.Fit),c.S480=new c("s480",480,480,l.Square),c.S240=new c("s240",240,240,l.Square),c.S120=new c("s120",120,120,l.Square),c.S60=new c("s60",60,60,l.Square)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.extractStatBname=t.nearestSiblingTzOffset=t.nearestSiblings=t.bname=t.inferCapturedAtFromSiblings=t.inferMakeAndModel=void 0;const r=n(1),o=n(3),s=n(4),a=n(0),u=n(18),l=n(7),c=n(71),d=n(13),h=n(8),f=n(27),m=n(116),p=n(12),g=n(225),v=n(53),y=n(6),b=n(110),S=n(136),w=n(40),M=n(49),P=y.mkLogger("TagInference"),E=y.mkLogger("TagInference.inferMakeAndModel()");t.inferMakeAndModel=function(e,t){return i(this,void 0,void 0,(function*(){if(o.notBlank(t.Make)&&o.notBlank(t.Model))return;if(o.blank(t.Make)&&(l.toS(t.HandlerDescription)+l.toS(t.CompressorName)).includes("GoPro"))return void(t.Make="GoPro");const n=F(e),{younger:i,older:s}=yield C(e),a=r.compact(r.flatten(d.zip(i,s))).slice(0,50).filter(e=>b.diceCoeff(F(e),n)>.7).slice(0,10);P.info("inferMakeAndModel("+e+"): looking at nearby siblings",a.map(e=>e.base));for(const n of a){const i=yield w.readRawTags(n);if(null!=i&&d.allNotBlank(i.Make,i.Model))return E.info("Inferring Make and Model",{file:e.nativePath,sibling:n.base,Make:i.Make,Model:i.Model}),t.Make=i.Make,void(t.Model=i.Model)}}))};const x=y.mkLogger("TagInference.inferCapturedAtFromSiblings()");function T(e,t=7){return i(this,void 0,void 0,(function*(){return d.firstAsync(e.slice(0,t),(e,t)=>h.thenMap(w.readRawTags(e),e=>h.thenMap(S.capturedAtFromTags(e),e=>Object.assign(Object.assign({},e),{index:t}))))}))}t.inferCapturedAtFromSiblings=function(e){return i(this,void 0,void 0,(function*(){return h.thenMap(function(e){return O.getOrSet(e.nativePath,()=>i(this,void 0,void 0,(function*(){const{younger:t,older:n}=yield C(e),i=yield T(t),r=yield T(n);return null==i||null==r?void 0:{before:i,after:r,index:i.index,slots:i.index+r.index+1}})))}(e),({before:t,after:n,index:i,slots:r})=>{if(v.sameDay(t.date,n.date))return a.map(m.DateInterval.for(t.date,n.date,i,r),e=>({date:e,src:`before:${t.src},after:${n.src}`}));x.debug("rejecting, not same day",{file:e.nativePath,before:l.toS(t),after:l.toS(n)})})}))};const O=new c.TTLMap(2*s.minuteMs);function F(e){let t=e.name;return a.map(/(?:burst)(.{8,})$/i.exec(t),e=>t=e[1]),a.map(/^(?:(?:dsc[0f]?|img|mov|mvi|mvimg|vid|gpfr|gopro?|gp|gf|p|100)(?:[-_ ])?)(\S.+)$/i.exec(t),e=>t=e[1]),t.replace(/\s*-?\s*copy( \(?\d+\)?)?\s*$/i,"").replace(/\s*\((another |\d+[a-z]{2} )?copy\)\s*$/i,"").replace(/^[-0\s_]+/,"").replace(/[\s-_][\d\s]{0,4}$/,"").replace(/_cover$/i,"").toLowerCase().normalize()}p.onClearCache(()=>O.clear()),t.bname=F;const _=g.extFilter(M.AllExifExts),D=new c.TTLMap(2*s.minuteMs);function C(e,t=7){return i(this,void 0,void 0,(function*(){return D.getOrSet(e.nativePath,()=>i(this,void 0,void 0,(function*(){const n=F(e),i=(yield e.siblings()).filter(t=>!t.base.startsWith(".")&&_.apply(t)&&!M.isSidecarExt(t.ext)&&(b.diceCoeff(t.name,e.name)>.7||b.diceCoeff(F(t),n)>.7)),o=r.sortBy(i,e=>F(e)),[s,a]=d.partition(o,e=>F(e)<n);return s.reverse(),{younger:s.slice(0,t),older:a.slice(0,t)}})))}))}t.nearestSiblings=C,t.nearestSiblingTzOffset=function(e){return i(this,void 0,void 0,(function*(){const{younger:t,older:n}=yield C(e),r=d.flatZip(t,n).slice(0,10),o=yield h.thenMap(function(e,t=7){return i(this,void 0,void 0,(function*(){return d.firstAsync(e.slice(0,t),(e,t)=>h.thenMap(w.readRawTags(e),e=>h.thenMap(S.capturedAtFromTags(e),e=>u.Opt(e).filter(e=>v.hasZone(e.date)).flatMap(e=>v.getZoneName(e.date)).map(e=>({zoneName:e,index:t})).get())))}))}(r),e=>e.zoneName);return P.info("nearestSiblingTzOffset()",{f:e.baseWithGrandparent,result:o}),o}))},t.extractStatBname=function(e){return i(this,void 0,void 0,(function*(){const t=v.parseDateTime(F(e)),n=a.map(t,v.datedToMillis);if(null==t||null==n)return void P.debug("extractStatBname() bname isn't dated",{bname:F(e),fromName:t,fromNameMs:n});const i=yield e.stat();if(null!=i)return P.tap({msg:"extractStatBname()",result:d.first(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],e=>Math.abs(i[e]-n)<f.MaxTzOffsetHours?{src:e,date:t}:void 0),meta:{fromName:t,fromNameMs:n,stat:i}});P.debug("extractStatBname() no stat",{fromName:t,fromNameMs:n})}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.systemUID=t.SystemUIDStore=t.UIDStore=void 0;const r=n(1),o=n(2),s=n(48),a=n(8),u=n(12),l=n(60),c=n(308),d=n(66),h=n(52),f=n(309),m=n(33);class p{constructor(e){this.rootDir=e,this.read=o.lazy(()=>this.jfs.read()),this.jfs=new f.JsonFileStore(e.join("uid.json"),()=>this.mkUid())}mkUid(){return i(this,void 0,void 0,(function*(){return{uid:r.compactBlanks([c.fsSafeHostname().substr(0,6),l.TokenRadix.safeRandomUid(12,4)]).join("-"),version:d.version,createdAt:Date.now()}}))}}t.UIDStore=p,t.SystemUIDStore=o.lazy(()=>new p(m.PosixFile.for(s.App.userData()))),s.App.userData.onChange(()=>t.SystemUIDStore.unset()),t.systemUID=o.lazy(()=>a.thenMapOr(t.SystemUIDStore().read(),e=>e.uid,()=>"missing!").catch(e=>{throw new h.WrappedError({cause:e,fatal:!0,message:"Failed to read "+t.SystemUIDStore().rootDir})})),u.onClearCache(()=>{t.SystemUIDStore.unset(),t.systemUID.unset()})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.idEql=t.id2id=t.BlankID=void 0;const i=n(0),r=n(5);function o(e){return i.map(e,e=>r.isNumber(e)?e:e.id)}t.BlankID={id:-1,v:-1},t.id2id=o,t.idEql=function(e,t){return i.map2Or(o(e),o(t),(e,t)=>e===t,()=>!1)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localModelDbPath=t.libraryModelDbFile=t.setModelDb=t.modelDb=void 0;const i=n(22),r=n(91),o=n(0),s=n(174);let a;function u(){return o.map(r.libraryDataDir(),e=>s.pathToDb(e,"models"))}t.modelDb=()=>a,t.setModelDb=function(e){a=e},t.libraryModelDbFile=u,t.localModelDbPath=function(){return i.isFalse(null==a?void 0:a.datadir.eql(u()))?a.dbfile:void 0}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sortLogEntriesInPlace=void 0;const i=n(1);t.sortLogEntriesInPlace=function(e){i.sortByInPlace(e,e=>e.ts)}},function(e,t){e.exports=require("deep-eql")},function(e,t){e.exports=require("he")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cacheDir=void 0;const i=n(1),r=n(2),o=n(103),s=n(61),a=n(30),u=n(86),l=n(14);t.cacheDir=r.lazy(()=>{{const e=s.getEnv("PS_CACHE_DIR");if(a.isDirectorySync(e))return e}if(l.isDocker()&&a.isDirectorySync("/ps/cache"))return"/ps/cache";if(l.isWin)for(const e of i.compactBlanks([s.getEnv("TEMP"),s.getEnv("LOCALAPPDATA")]))if(a.isDirectorySync(e))return a.resolve(e,o.AppName);if(l.isMac){const e=a.resolve(u.homeDir(),"Library","Caches");if(a.isDirectorySync(e))return a.resolve(e,o.AppName)}return a.resolve(u.homeDir(),".cache",o.AppName.toLowerCase())})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultLogDir=void 0;const i=n(31),r=n(137),o=n(103),s=n(86),a=n(14);t.defaultLogDir=function(){return a.isDocker()?"/ps/logs":a.isMac?i.resolve(s.homeDir(),"Library","Logs",o.AppName):i.resolve(r.appData(),o.AppName,"logs")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.channel=t.isBetaVersion=t.isAlphaVersion=void 0;const i=n(2),r=n(66);t.isAlphaVersion=i.lazy(()=>r.version.includes("-alpha")),t.isBetaVersion=i.lazy(()=>r.version.includes("-beta")),t.channel=i.lazy(()=>t.isAlphaVersion()?"alpha":t.isBetaVersion()?"beta":"latest")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isFirefox=t.isChrome=t.isSafari=void 0;const i=n(7);t.isSafari=function(e){return i.toS(e).includes(" Safari/")},t.isChrome=function(e){return i.toS(e).includes(" Chrome/")},t.isFirefox=function(e){return i.toS(e).includes(" Firefox/")}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.asPromise=void 0;const r=n(39);t.asPromise=function(e){return i(this,void 0,void 0,(function*(){return r.isFunction(e)?e():e}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Elapsed=void 0;const i=n(0);t.Elapsed=class{constructor(e,t){this.l=e,this.listener=t,this.ts=Date.now()}elapsed(e){const t=Date.now(),n=t-this.ts;this.ts=t,i.map(this.listener,t=>t(e,n)),n>2&&this.l.log(n>500?"warn":n>100?"info":"debug",e,n)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeError=void 0;const i=n(0),r=n(7),o=n(10);t.describeError=function(e){const t=o.stripSuffix(r.toS(e).trim().toUpperCase(),":");return i.mapOr(s[t],e=>e.description,()=>e)};const s=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestEventEmitter=void 0;const i=n(141);class r extends i.EventEmitter{constructor(){super(...arguments),this.events=[]}emit(e,...t){return super.emit(e,...t),this.events.push({name:e,args:t}),!0}clear(){this.events.length=0}}t.TestEventEmitter=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MRUMap=void 0;const i=n(11);class r{constructor(e=1e3,t=!1){if(this.maxSize=e,this.fifo=t,this.delegate=new Map,this.expireListeners=[],e<1)throw new Error("maxSize must be positive")}get size(){return this.delegate.size}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}entries(){return this.delegate.entries()}forEach(e){this.delegate.forEach(e)}get(e){if(this.delegate.has(e)){const t=this.delegate.get(e);return this.fifo||(this.delegate.delete(e),this.delegate.set(e,t)),t}}getOrSet(e,t){return this.delegate.has(e)?this.get(e):i.tap(t(),t=>this.set(e,t))}has(e){return this.delegate.has(e)}keys(){return this.delegate.keys()}set(e,t){return this.delegate.set(e,t),this.vacuum(),this}values(){return this.delegate.values()}[Symbol.iterator](){return this.entries()}on(e,t){this.expireListeners.push(t)}vacuum(){if(this.delegate.size>this.maxSize)for(const[e,t]of this.delegate)if(this.delegate.delete(e),this.expireListeners.forEach(n=>n(e,t)),this.delegate.size<=this.maxSize)return}}t.MRUMap=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isCussy=t.getCuss=t.NaughtyWords=void 0;const i=n(105),r=n(2),o=n(212);function s(e){const n=e.toLowerCase().normalize();for(const e of[n.replace(/[^a-z]/gi,""),...o.unl33t(n)]){const n=t.NaughtyWords().find(t=>e.includes(t));if(null!=n)return n}}t.NaughtyWords=r.lazy(()=>i.brotliDecompressSync(Buffer.from(["G24yBdxY6FE9AIB56kZgVD0kUDeM0HozfcdOfRyH23FTwzDY8VIiYsefEhE7TvItgRvq8R21YMV","sIKayhmm2WwJHeT5Eqg1VmbLz8X2gMGSUgGmmbhBjio3LrYuisamIeSDtN5CY8f6Kqp4g89fo9E","ZscKID3kdlNi5dl4cjYtUGcY4/PYB8dNhXNtM2Cij4fUO0h+3dI4wDNuYjsKITiHdyFej7r6pVS","8pDOwMi5VnwUTbwH2UC/A6b+nJCdSFWIae6H+/lqmwO3t//7ey1jz9EKUV2/1caNPpJZBEIQREc","RISIQTxfEiVvf6Qecm5kOfnpbDG2UrZabJ+NXcruf/bHxr43btW5Mdy+J4PBwBg44/hhaDJ8MDw","ZozMyGSWMmtxJ7lHuSe6fHx5RHvXmycXTg6cfnmtxjM5Rk6MWRzlHJcefeBG89PAq5S8Hbw/evn","jvi39eTG6mJ9PBzGRmMbOZSea/m1mNWSezfnz+FZ9/i0VlEax8WG8BAfoHT/i88Xahk9M6dVw0l","c6gc9FL9H7z/f8/PzcuhIvJpUEk24nuRcztIObWidlFQEpgF4F6CKwg8BXBKwSHiXiJiE+In5S4","XyLu2yT+Jnlu8hgX6SHSadL/IlNDRkLGDjK7kqUmyw6ycoLKg4jDEOfowzlpnLMG56w356zk9BL","nqeQonaOKo4XjNo4RztXFmYgz+3Bmk2KEYn2ojFCVTnWaqnXqnwhlD0o7KC9TWy9ql6h5qJ9d1N","uN6IaIhogv4iNUEap01CFUO1C3od6JnmxkE7IZTTqOFE5/cJZwrHCvH+yeWBe+Cbw68Dw076K5R","OM7zbfoVNPplY6etDW03Wl70K7Qumm9aL3Tc9O/+vHGn5n0h2lcTJ8v83OKUEWQEPRFOk0+ceI2","cnWR2SSLIm83mxq262FtYm2L9RCrT3a2A0WBJWANwAy4gBDkPqDSoRLoO1B9g2WCR8D5gBrQBIb","BGLDjDTPBbMJy8FHDh4SPdfHxFF/65MsU35r51sLvp/innJ+H+Hk8/KzlDI1ZoCh4C8wCGmABvy","DNSAuiRsyIFXIJ8V+cNXHWHypCJehb6DvofND1g5pQM3oJvYxehfpCY6AZNCeUAfsFD8HXBU+F2","+Al6Bv0D8zgluC/tmHTmAqLgcWDpbA0lmH/ytjOxXmLc5mnJ4+bx6N8xHrbAAk0JWgINA6QBfQf","6BrQldD1ga4HeiX0emCsBeNPMP4MUx+YTpgr4eEBj5XwjELKhNRA/IJ8Ba8SeNWAV014VcI/v+D","fKrAksJRQxaFEUGIo6VBT8JUjxZDjjdiB+I7qD2oIdS3UXVH3gTZhqjCXcNXGPyVnzo/To5wfGa","U05XpT7k7t95vGOo2LVr7oXg/dc9F+v+mKwRcT3/Fnvknxwzo/9skv98Wl+nD5Ka7HvXMtE9abZ","5p3lSy/lrDs3lh2T1bcKyvrMGtSsfdLyt52seHuzLXE5naIzVPOIDWDtBgqxVDZGL52tuViH3dn","PKozTZ1MUz92qzi7/2TEaCcxEsQZJjyL+GkQv1uUuhalySjRJiWmKLdPqjRRj9PU9Qo1t0bNabL","YQUozOWSkKkg9Q5qdtK/JXR9yt4fcdpA7HzKmyFtN1yXpWk13pWjSRBt30ca9aLaL5kqaf0zzW7","SYD+35CMgmIE3guA2GHIyPwIiB10sgtgLPt8DzDRJDSAwjMQqJERzpC6d6x6nuOGUdJ6XhpBknO","3GSwlnN6E6htwq9tdBbA6U/cNjhyx2eGagxuOxw6wP9I+ifwF8CPl/hlgi3YuA7MjDZgkkM6xJM","E5hrYtEKe7Q5ioujuzi8P1xqKVfdw9msnOsV7lZO7kYP7n67uEmM2+XJl6SJL+VlviwNn22t+Pq","sfVZu/LcKN/5bnRuzOld3DDGSCD0LoWcQqRciR1BEiqJbQ4khlBhGiVEoMYIqzaiHHHU0o+4jqD","GMmlOoOY0eZ9Cz0kg9jfRPIXMamV8jbzO6sg3dSKFVOVqzo43zQbulY4rtGJNhbF+YmIX5quH4y","7j2DX5kO/7kVmwMY7+fYB85vtbgWz3xzdnwzWX8/ZPEqy/h9Rr85gpN+1c0739F8/6eNFtN81XQ","X6Wi+95F932Lbs7QLjmt9Yc27LSfT+h1Cb0YD/1bL9HvVZ1XaicPe4yHf8t4sTUzvLcwvHsYZpR","hSRmyi0mVMKlKJnUFk68bc2STsdkZX5+HMYYY79OZjWMwy76Yn7MGQXQRxEaQbsJRTjAbiR0i8b","dI12VS6w958g5xJok2DzI9i8x2kfmvyKIVWUyR5RR5c4W8949Y6p/YSDMb38MmXmG77GyXf6zHW","6zH26yqYA07612S9c6HXb3FrtnZDRm77ALmnwD9mcCSA8s/YMWAde+ANwH5z0B+HiATEElANAbx","XRDfDX8OO/w54lA7BLXcoPQHtClwm8BrGPQY6KuDtxp8voK7K+HuXfCdFOyYBYshWAzDYhQsRmA","5BcvZ+Chz8iF9goBwNhH+pIS/0UiGnWTcIhm3ScZdJOMOybwXqbRJau8QbxPxNpPlND2dpnA2Sq","Upy0S/fge0M0BtQE8DPQvYR8DGA2wWsPkAPwKiC6QMaTWRVw9ytiBqR/QSoknkykJ8GInNSNqRX","C/kiaFiQ6UJldqoDKGyAp12dPqH6rlQO4TaDHr9CL1+jPop9NmFR7/gWctQmqA0Q2mBb1eop6D+","Bl5W6J9AvwVzCndT4u5W3JUTqw7MtsKuH7H+9GKPvsXWy8HWRWy9H2z97pxiO8f24lx2HuGVFEv","nFMslxSrrYr3bUtZ79IP1GUNAUQGtAmhZwHoFsP0CfDOQMrjFBbd4oHkJmpeheRU0r0C7NEHLBr","p+Avp3g94qoScFjvHAkHUY7gmjUjAqJ8xcD8RGIDsfiG+C+GZIbIHkfcNrWYetaaj6EpTYoU4T1","GmG0jKkxpDLjvglJDSQ0ETix0jakZxGchby/xFKmlD9OFCjGeWHUH4JFdOoVKByCpXTqFsa6tFE","PdronA9GWjCqE2OHMDuE8T24NITL94ErZ8GVs+OKClc0uPIvrJBhRXuwYiz8K+uc487FGVqikE0","UrQrFcYpSaaJUWij5IUr3x5RLE+XSQjnnopzLqKxKqvRXVOmvafKf6a5odI+bXis7DvHjGvy4Jn","/GKvy51fw93g+PMsX7yq68VE1e7SNe7WNer5+Hp99iOT7DrFV3VnOuxsadncwlMTbV4gxfd2d8a","TyMVSyMty4x3ivEeK8Ik/w2u5MOokpE1ESI5m6E7XbCr0zCryQR35rEc3lQitkpxfyjHG8bZXYb","RcuKomWh2NdOiTVCR+1XdNR+TUd2FJ2EGrXk1qi10tTjfZo6FIOaXibFKfIoDfla1smzpMhzq0h","dLeR6lZH7mCK3VSd9t5KxNZOxtUHGsJP31CRvv01Xdoau8mu6ZZvo1pbQrdhCt56P6Eaa6Eaa6c","aa6K6cou9h/6WJU7Rx2GnjttHm+Iq2XmvR1rDRIiZaxEyLWNGr3Bq956gC6q0N6h0DIgsQuYEoB","URpIE4BcRpItwOJGQw1gaEWMJQCQ2kwlAWGMkD3tYGWGHilkN3NiCeNI4nhaHbjKKdxLJtwqtjE","qfIJTtXbOCXNOCWtcKrfjlOHHKeWHCfSghPrD072ZZxcdpzcZpwlTThLmnGWtMJZ1h+cdcnRraf","QrafRHT9Br6TxlJ6GI2n4rha4rupwa3XoSUHPE1xJF27FMG5iGHfJJtwlW7AiTVhJByZbK0xdHC","vvag/F67JTrKuSwrt/FN6rU/ySjWrbT1PdhyfluhyUu2VTXiWmrsbq1M1QUHfMLur1cT7U//Xt4","ublH3OxLTUX79POxWHfubHFJ1cOVa7an5V72ZLG/fc/fxHS5IguDsQ4kohUDPRX39ZC0bk1lLVn","oY6YUXdOo8a0o+asgR7ZYfQ8e3X0PPtjZKsmZKsWpJ5ypN9y5J230ZUdQVf5NboeH6Hr8TG6ia3","QWjWhtWpB71vdMPV0YPSliVkJYaLNwvyG//FRDOGjmIXrZww/2veJP4ph/Kl9H/gT2YQtuf2PLT","mMnX0Z9j7N2DuG8dVpxtfagm/ZEbxiM3iytcKTrS28fqvx1mXHvzo1+Nenhqa8umimu9MsLdH8u","TuNaxWN7zGaGFVofoeM/nJX0bGpk67t2bTtqE5rh53Wun+01qvT7mmn9Y9/9PonRu+Ydl4+8128","UjvFG/5d4WFzTB62peJhW1o8bEvDw1vLPBw5Nw/DMRn8ljN8TjmTKnuYfB2DWY6+CDW3Eo63nXC","8ywnH+zZBpwZBpyZhlZlgmibYPznBZpLgtyYhhy7C90+NHJkfcmRfkY7DTp6kjXyWniK+YyHavh","a5unOQHW85ee+fKixV34clp51NvMrY5F3GVvplVq0U6w47uyURu3VZgbosgEgESD0CzqICtCmBp","SZgjWzASgLYownYkwl4iQCPGfBYAX4rAF/vAJEUcC/dwE9p4PeKQUwWiMkNMaUgpjTElAUxZSC+","xSD50YTkvA1/SxXQmtug3XfB314+2TbxccVHBIOrDLGhe+7ql1IYZKCVdzHwUzNeDGQdT49UBYO","PUTFa99lv4awXSL1CeP95oGMb8zaJ3LuothTxGgI9Hhn4VGXUtoZ5nqIN055p/Rq6564tQK5yit","76wLEe43J64ufx6nmtqlneAm/yylHMnyVe9VqCTssuKDteuRJ+u5SHcIoYw5HgSh83YiR5MaiCK","9Qt9ALhcmFrEHlI2fUY8iEszleawvYPOdC6sKHBGP1zSNMaTM1CGr1uP0Q4NjBfYtqer/YlnC2A","zw+ZIuq3cU5jU7Zrokw11ENEM8Bkqhc8Zk/iVdzodopx/iZL9GWwrGMYQwDGqBjX8Kffz4mVuRc","sbA4KNsm5Sjgjn60wxXhJ3N3ChY2pC0x2jefLhW1SV6/B5w5TV3hq+Bx7syKb7NQCWae/cbavKH","fefwTSuluabsQ4ISfYn022aG55iAfyRK0z2UFnzf4hR8n8JDanVhJf4oOY1SQLG8iVuMy9gh1ru","wxlQ5w+JH94fp9+OTvV8jqvvDvGFNUBzVvfkEKTeTUEDf+FW7XAKlGRcHb5Vdg8VTAZOmRMh+la","agNDTITyNpJ+k7stTF2ZKhEuCdzFEJeiArjA8wN/qqZYJ8yb2+vPx8VnwHvNACMIZnLiiT4ux+W","QafJnvHXx+mX75uunCldmP0m3dNPWL6GdIny6xv0SWMf+Vft8rf6ijNE/5h8NN6S1L9ezym/i5y","GVX6mvGc0c8NpgVkuMC8ktVxaVcTZ9CIZ0IyfuF0OqN+HuP6b8JxmZQqrjJgpsle7wLWtVnXo/X","Soc4Um1Fd2qPuK/ouKS9cgmgyr+16Pys5988vlJx+e+Lj+ZzPoGlnvZ2DWiaXVhxa44xJE1lrwx","NjyyVkC/RV0GWMmTNa89JdxoUI774BPLPHqXg1Fyn0I+cRWPc7uVNrZ1STSkvZk8E/j9JkvVVlM","lPVVgT8Vr8Cmyto2ZMoC4dPl8aZJarp0OmuCk5JVdA5re/FSVBi5OvC05Lom4eXKywFQ1rLb0ZK","gqvjw87q7BEy44BkOc97JBHFVIcUmi/QDVp3WIfHlmPzQMHAm8vG0BjdDtYSMusfsU8zzNiWuWC","hrEyblJp+LtE8nZJu3y2RPvWKVe4pKwyk9xZftFjHRZwsnZJGuHS/jWyV4HjTttMeACbGB8sqx1","gTI2TvsV4lIPkocTYmmrZFmXda5C2gmnGDcF5RrlEZyCqpn2l7YXo4M0nskIFGzxmXw6tm5PvOY","9JEewmTk0m7y6JRLVzs/4rBJWknMTBJshMhkjUeGiXN2nbA13XNHgZEkGNqWsdRkflTWQlXBybo","IOyc4UoFRyc6PnC3RLvbn2ZMFTKBe7RpO+rtCBbTyA/6PQkcgpHvQrp8OAZF/dqh5lHVPpbYv0J","m1RVypqOS5RPr3mS1Wb4OBc9FUon344r5rxp8dJT1aOs0k1H+KhPbTuykX56m6kU9yVxfDOraKt","iP4lPkK4ZJfv/MdzSho/B+bkEttpnEQrT9a9bGx3IONnfOGrjo2azNQoHkOwlMKxUOmkiEu/yYV","3Dze1fTlsq2iXcHK2GS7ezMXSWrpm6aqKcISuToh72fiU3/KMI27yGdjAcy+c1yazdRgzX1SSFV","S97tappuMSq2esdamUg/ksfgSy5mrmJJcRuXgYanFsxt1KIf68wfGbLCV/SxKmA+VosSFKbKtgi","NdyiaEzOavBGQ/mU1XTgThfxnn3IuLV37IGVM2bzK7QeL6Jd/F5eGKDuNoc96VYed4d/XvVTjxT","gdd4jQ/0Tdt/6XFes3peEHcko8eVZ+sO4sYoiYu4qpnVK1ScThOZ6zCxYDR6cmn75uUU+5S8N7T","S+2ZnFzc6Lu7WRuWvQn+VLW3tvmpZs4L8pg+9VPlBfn1iPYCuBGxgZ3jfstwX0vthQQoyWifwyR","qFtmAUfqW33LcsHImHK1dgpEkuvAqcnJuEWY9oManu4Kk4MVp3MlUlAXXaUk9pDDJ9woN4u5KcW","OTqPlWtDo5rrxzthCGeR+viDzi5ecTYnx75Ed1ZCzyFrTs9Xdt6dfLa2AsueCqVFJ8JnJybhOKR","ARddrKfLNbD5UvYrkPUgrLEY/V7wtZL7uhFK9R0X22mc9IjIOHQm5VHDlqtnU/ZDXvXCOT7KlUd","ScqNnNKh02AaG/Ml1JlL2K8DJeG+CVh7vW24Vn7FBBif5ak+x47LXklqOC61T8zyWKutiikfbNh","ldAhucVo7H9fpUatMJ0V27buP8F83+Q8yxEQtxia0rFc5AJA7SlueTjFKicNBad8rlKRu4hsEa2","1W2g1A+JjxkPoxTJaQtUU/ltMYMBx3rEQzEf7yv1xp6BeOKlbgRS7TZ7LWOfoUZnLtsqJWwnpY7","nJxNlBq8TLHF/L/DR9xpObq7Qa2Ek7PJUcdpjL7gI8qq0J366GDiojO0fGZsfDK4lyYRL7PzvKY","tJNs1VKw95AQnkZZc5YqN1GtmNUl1CeZfi/2pFvYd7G1w/ArbYzBLv8qLHWyDL07ONviI770yXS","GMHHc57uJRveOx/tKff4i/LnIuiHR4eTrh1W9pBy8nb+RPjktbcWt+lKZ6ZeEKcLIu2gYjXQYYV","da9bFSD445UsLHInorrYIGnq7/g2mjYU/+SvoBT4/6yTlvKqq3Pv4KqfJqT1qtAgC3PWaeXNfnE","5Hf7Gub++RazGxqhu1JwQh1YFdutKv4lDi+9ftzXVtGevHURdyjR9YpUx4a4djvvlGv8/PkSDUm","sR/oh33LRwK4TZRV1s6qzaqt6YjwDjKpRfFsnsRbHiltouS7EV+OMd/ZkAw=="].join(""),"base64")).toString().split(",")),t.getCuss=s,t.isCussy=function(e){return null!=s(e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unl33t=t.l33t=void 0;const i=n(1);t.l33t=function(e){return e.replace(/o/g,"0").replace(/[il]/g,"1").replace(/e/g,"3").replace(/a/g,"4").replace(/s/g,"5").replace(/b/g,"6").replace(/t/g,"7").replace(/g/g,"9")},t.unl33t=function(e){return function e(t){const n=t.indexOf("1");if(-1===n)return[t];{const r=t.substr(0,n),o=e(t.substr(n+1));return i.flatten(o.map(e=>[r+"l"+e,r+"i"+e]))}}(e.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WritableToBuffer=void 0;const i=n(142),r=n(58);class o extends i.Writable{constructor(e){super(e),this.deferred=new r.Deferred("WritableToBuffer"),this._buf=[],this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",e=>{this.deferred.reject(e)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,t,n){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,t)),n()}}t.WritableToBuffer=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColoredLogFormatter=void 0;const i=n(34),r=n(1),o=n(37),s=n(0),a=n(7),u=n(75),l=n(28),c=n(29),d=n(77),h=n(106);class f{constructor(e={}){this.logLevels={trace:"trace",debug:u.darkGrey("debug"),info:u.cyan("info "),error:u.redBright("error"),warn:u.yellowBright("warn ")},this.inspectOptions=Object.assign(Object.assign({},f.defaultInspectOptions()),e),l.isTest&&(this.inspectOptions.breakLength=255)}formatMeta(e){return null==e?void 0:o.isError(e)?o.errorToVerbose(e):i.inspect(e,this.inspectOptions)}formatLogEntry(e){const t=h.logFilter().highlight(e.ctx)?u.yellow:u.blue;return r.compactBlanks([d.dateForLog(e.ts),c.colorProcessName(s.orElse(e.from,()=>this.inspectOptions.processName())),this.logLevels[e.l],t(e.ctx),e.msg,this.formatMeta(e.meta)]).map(e=>a.toS(e)).join(" ")}format(e,t,n,i){return this.formatLogEntry({ts:Date.now(),l:e,from:c.processName(),ctx:t,msg:n,meta:i})}}t.ColoredLogFormatter=f,f.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:25,processName:c.processName})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaintextLogFormatter=void 0;const i=n(34),r=n(1),o=n(0),s=n(11),a=n(7),u=n(29),l=n(10),c=n(77),d=n(107);t.PlaintextLogFormatter=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e,this.paddedLogLevels=s.fromEntries(d.LogLevels.values.map(e=>[e,l.rightPad(e,5," ")]))}formatLogEntry(e){return r.compactBlanks([c.dateForLog(e.ts),u.processName(),this.paddedLogLevels[e.l],l.stripAnsiEsc(e.ctx),l.stripAnsiEsc(e.msg),o.map(e.meta,e=>i.inspect(e,this.inspectOptions))]).map(e=>a.toS(e)).join(" ")}format(e,t,n,i){return this.formatLogEntry({ts:Date.now(),l:e,from:u.processName(),ctx:t,msg:n,meta:i})}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CLI=void 0;const r=n(187),o=n(19),s=n(29),a=n(66),u=n(3),l=n(0),c=n(188);t.CLI=class{constructor(e,t,n){this.serviceName=e,this.args=t,this.additionalDescription=n,this.plugins=[],s.setServiceName(e)}add(...e){return this.plugins.push(...e),this}parse(){return i(this,void 0,void 0,(function*(){let e=c.addFooter(r.program.version(a.version,"--version","Output the version number (spoiler: it's "+a.version+")").description(c.CliDesc[this.serviceName]+u.mapNotBlankOr(this.additionalDescription,e=>"\n\n"+e,()=>"")));l.map(this.args,t=>{e=e.arguments(t)});for(const t of this.plugins)e=t.beforeParse(e);e.parse(o.argv);for(const t of this.plugins)yield t.afterParse(e);return e}))}}},,,function(e,t,n){"use strict";function i(e,t,n=.5){return(1-n)*e+n*t}Object.defineProperty(t,"__esModule",{value:!0}),t.lerp2d_=t.lerp2d=t.lerp=void 0,t.lerp=i,t.lerp2d=function(e,t,n){const r=t.x-e.x,o=(n-e.x)/r;return i(e.y,t.y,o)},t.lerp2d_=function(e,t,n){return(e.y*(t.x-n)+t.y*(n-e.x))/(t.x-e.x)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.parseRawInfoOutput=t.rawInfo=void 0;const r=n(1),o=n(3),s=n(4),a=n(37),u=n(2),l=n(0),c=n(5),d=n(11),h=n(7),f=n(22),m=n(56),p=n(20),g=n(12),v=n(83),y=n(302),b=n(149),S=n(53),w=n(6),M=n(10),P=n(133),E=new m.BoundedMap(7*s.minuteMs,2048,!1);g.onClearCache(()=>E.clear()),g.onFileChanged(e=>null==e?E.clear():E.delete(e));const x=u.lazy(()=>w.mkLogger("DCRawInfo"));function T(e){const t=v.splitLines(e),n=r.compact(t.map(e=>{const[t,n]=M.splitFirst(e,":"),i=function(e){return h.toS(e).split(/\W+/).map(M.capitalize).join("")}(t);return l.map(function(e,t){return o.blank(t)||O.includes(e)?void 0:e.toLowerCase().includes("time")?l.orElse(S.parseDated(t),t):e.endsWith("Size")?P.parseDimensions(t):F.includes(e)?c.toInt(t):_.includes(e)?f.toBoolean(t):t}(i,h.toS(n).trim()),e=>[i,e])}));return x().tap({msg:"parseRawInfoOutput",result:d.fromEntries(n)})}t.rawInfo=function(e){return i(this,void 0,void 0,(function*(){return E.getOrSet(e.nativePath,()=>i(this,void 0,void 0,(function*(){try{const t=yield b.dcrawNativePath(),n=yield p.stdout(t,["-v","-i",e.nativePath],{timeout:y.StatTimeoutMs,ignoreExitCode:!0});return o.mapNotBlank(n,T)}catch(t){return void x().warn("rawInfo failed",{file:e.nativePath,error:a.errorToS(t)})}})))}))},t.parseRawInfoOutput=T;const O=["CameraMultipliers","DaylightMultipliers"],F=["RawColors","ISOSpeed","NumberOfRawImages"],_=["EmbeddedICCProfile"]},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.duration=t.extractDurationSec=void 0;const r=n(0),o=n(5),s=n(69),a=n(33),u=n(81),l=n(40);function c(e){return r.map(e,e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(o.gt0))}t.extractDurationSec=c,t.duration=function(e){return i(this,void 0,void 0,(function*(){const t=a.PosixFile.for(e);return s.thenOpt(l.mimetype(t)).filter(u.isVideoMimeType).flatMap(()=>l.readRawTags(t,!1)).flatMap(c).get()}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrSetByNativePath=t.sameNativePaths=void 0;const i=n(4),r=n(15),o=n(12),s=new(n(223).TTLMultiMap)(10*i.minuteMs);function a(e){return[e.toString(),...r.toA(s.get(e.toString()))]}o.onFileCopied((e,t)=>{s.add(e,t),s.add(t,e)}),t.sameNativePaths=a,t.getOrSetByNativePath=function(e,t,n){for(const t of a(e)){const e=n.get(t);if(null!=e)return e}const i=t(e);return n.set(e.toString(),i),i}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLMultiMap=void 0;const i=n(71),r=n(100);class o extends r.MultiMap{constructor(e){super(new i.TTLMap(e)),this.ttlMs=e,this.m=this.store}add(e,t){return this.m.touch(e),super.add(e,t)}}t.TTLMultiMap=o},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.rotateToImgTmp=t.rotate=t.rotateInPlace=t.validJpeg=void 0;const r=n(4),o=n(2),s=n(108),a=n(8),u=n(20),l=n(12),c=n(149),d=n(6),h=n(14),f=n(130),m=h.isWin?"NUL":"/dev/null",p=o.lazy(()=>d.mkLogger("jpegtran"));function g(e,t,n){return i(this,void 0,void 0,(function*(){const i=yield c.jpegtranNativePath();if(!s.isRotation(n))throw new Error("refusing to rotate("+e+", "+n+")");yield u.stdout(i,["-copy","all","-trim","-rotate",n.toFixed(0),"-outfile",t.nativePath,e.nativePath],{timeout:r.minuteMs})}))}t.validJpeg=function(e){return i(this,void 0,void 0,(function*(){const t=yield c.jpegtranNativePath();yield u.stdoutResult(t,["-outfile",m,e.nativePath],{timeout:30*r.secondMs})}))},t.rotateInPlace=function(e,t){return i(this,void 0,void 0,(function*(){const n=e.wip();p().info("rotateInPlace("+e+")",t),yield g(e,n,t),yield n.unwip(),l.emitFileChanged(e.nativePath)}))},t.rotate=g,t.rotateToImgTmp=function(e,t){return i(this,void 0,void 0,(function*(){return null==t||0===t?e:a.thenMap(f.cachedImgFile(e,"r"+t,e.ext),n=>n.applyIfEmpty(n=>g(e,n,t)))}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.videoExtFilter=t.browserExtFilter=t.browserImgExtFilter=t.extFilter=t.excludedPathFilter=void 0;const i=n(1),r=n(3),o=n(2),s=n(18),a=n(45),u=n(304),l=n(10),c=n(49),d=n(30);function h(e){const t=o.lazy(()=>new Set(i.compactBlanks(a.tot(e).map(e=>l.ensurePrefix(e.toLowerCase().normalize(),".")))));return u.Filter.lift(e=>s.Opt(e).flatMap(e=>r.firstNotBlank(e.ext,e.base)).map(e=>t().has(e.toLowerCase().normalize())).getOrElse(()=>!1))}t.excludedPathFilter=function(e){const t=new Set(e.map(e=>e.toLowerCase()));return u.Filter.lift(e=>d.pathnames(e.nativePath).every(e=>!t.has(e.toLowerCase())))},t.extFilter=h,t.browserImgExtFilter=h(c.BrowserImgExts),t.browserExtFilter=h(c.BrowserExts),t.videoExtFilter=h(c.VideoExts)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractLensMakeModel=void 0;const i=n(1),r=n(3),o=n(10),s=n(227);function a(e){return e.filter(e=>r.notBlank(e)&&"n/a"!==e.trim())}t.extractLensMakeModel=function(e){const t=s.make(e.LensMake),n=s.make(e.Make),u=a([t,e.LensMake,n,e.Make]),l=e=>u.reduce((e,t)=>o.stripPrefixIgnoreCase(e,t).trim(),e);if(r.notBlank(t)&&r.notBlank(e.LensModel))return{lensMake:t,lensModel:l(e.LensModel)};const c=a([e.LensID,e.LensType,e.LensInfo,e.LensModel]);for(const e of c){if(r.notBlank(t))return{lensMake:t,lensModel:l(e)};if(e.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:l(e)};for(const r of i.compactBlanks([t,n,"Canon","Carl Zeiss","Fujifilm","Konica","Leica","Olympus","Sigma","Sony"]))if(e.toLowerCase().includes(r.toLowerCase()))return u.unshift(r),{lensMake:r,lensModel:l(e)}}return i.isNotEmpty(u)&&i.isNotEmpty(c)?{lensMake:u[0],lensModel:o.stripPrefixIgnoreCase(c[0],"unknown").trim()}:void 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.model=t.make=t.companyCased=void 0;const i=n(3),r=n(0),o=n(10),s=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|"),a=new RegExp(`[\\s\\.,_-]*(?:${s})[\\s\\.,_-]*$`,"i");function u(e,t,n=""){const i=e.replace(t,n);return i===e?e:u(i,t,n)}function l(e){const t=e.trim();return"gopro"===t.toLowerCase()?"GoPro":"benq"===t.toLowerCase()?"BenQ":"oneplus"===t.toLowerCase()?"OnePlus":t.length<4?t:t.toLowerCase().replace(/(?:^|\s|-)\S/g,e=>e.toUpperCase())}t.companyCased=l,t.make=function(e){return i.mapNotBlank(e,e=>e=l(e=u(e=o.stripQuotes(e),a).replace("LGE","LG")))};const c=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i],d=new Map([["Samsung",[[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]]],["LG",[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]]],["OnePlus",[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]]]]);t.model=function(e,t){if(i.blank(e)||i.blank(t))return;let n=o.stripQuotes(t);const s=r.map(d.get(e),e=>e.find(([e])=>null!=n.match(e)));return null!=s?s[1]:("Sony"===e&&(n=n.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"Î±").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V")),"Olympus"===e&&(n=r.mapOr(/^(.+?\d)mark(i.+?)$/i.exec(n),e=>`${e[1]} Mark ${e[2]}`,()=>n)),"Canon"===e&&(n=n.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel")),c.forEach(e=>n=u(n,e).trim()),n=n.replace(new RegExp(`^${e}\\s+`,"i"),""),null!=e.match(/^HP|Hewlett.Packard$/i)&&null!=n.match(/^hp\b/i)&&(n=n.slice(2).trim()),n)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DbRequestLocal=void 0;const r=n(56),o=n(1),s=n(4),a=n(0),u=n(150),l=n(229),c=n(151);t.DbRequestLocal=class{constructor(e,t){this.db=e,this.tableName=t,this.cachedStatements=new r.BoundedMap(s.minuteMs,1e3,!0),e().addCloseListener(()=>this.cachedStatements.clear())}qb(){return u.knex(this.tableName)}exec(e){return i(this,void 0,void 0,(function*(){yield c.tx(this.db(),t=>t.exec(l.toSqlQuery(e).sql))}))}prep(e,t,n=!1){const i=l.toSqlQuery(t);return{sq:i,stmt:this.cachedStatements.getOrSet((!0===n?"pluck:":"")+i.sql,()=>{const t=e.prepare(i.sql);return!0===n?t.pluck():t})}}wrap({q:e,pluck:t,m:n}){return i(this,void 0,void 0,(function*(){return c.tx(this.db(),i=>{const{sq:r,stmt:o}=this.prep(i,e,t),s=o[n].bind(o);return a.mapOr(r.bindings,e=>s(e),()=>s())})}))}run(e){return this.wrap({q:e,m:"run"})}mapRun(e){return c.tx(this.db(),t=>e.map(e=>{const{sq:n,stmt:i}=this.prep(t,e);return a.mapOr(n.bindings,e=>i.run(e),()=>i.run())}))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}first(e){return this.wrap({q:e,m:"get"})}all(e){return this.wrap({q:e,m:"all"})}mapAll(e){return c.tx(this.db(),t=>o.flatten(e.map(e=>{const{sq:n,stmt:i}=this.prep(t,e);return a.mapOr(n.bindings,e=>i.all(e),()=>i.all())})))}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}pluckBatched(e){return i(this,void 0,void 0,(function*(){let t;do{t=yield this.wrap({q:e.qb(this.qb(),t).limit(5e3),pluck:!0,m:"all"}),o.isNotEmpty(t)&&(yield e.onResults(t))}while(o.isNotEmpty(t))}))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.wherein=t.maybeLimit=t.isQueryBuilder=t.hasLimit=t.toSqlQuery=t.isSqlQuery=void 0;const i=n(10),r=n(21),o=n(5),s=n(11),a=n(39),u=n(230);function l(e){return null!=e&&i.isString(e.sql)&&(null==e.bindings||u.isDbValued(e.bindings))}function c(e){if(null==e)throw new Error("null sql");if(l(e))return e;if(i.isString(e))return{sql:e};if(a.isFunction(e.toSQL))return s.without(e.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+r.stringify(e))}function d(e){return null!=/\blimit\b/i.exec(c(e).sql)}function h(e){return a.isFunction(e.where)&&a.isFunction(e.limit)}t.isSqlQuery=l,t.toSqlQuery=c,t.hasLimit=d,t.isQueryBuilder=h,t.maybeLimit=function(e,t=1e3){return h(e)&&!d(e)?e.limit(t):e},t.wherein=function(e){return"("+o.times(e,()=>"?").join(",")+")"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toDbValued=t.isDbValued=t.isDbValue=void 0;const i=n(53),r=n(1),o=n(11);function s(e){return r.includes(["number","string"],typeof e)}t.isDbValue=s,t.isDbValued=function(e){return null!=e&&o.entries(e).every(([,e])=>s(e))},t.toDbValued=function(e){return o.mapFields(e,(e,t)=>{if(!e.startsWith("$"))return"boolean"==typeof t?[e,t?1:0]:s(t)?[e,t]:i.isDated(t)?[e,i.datedToMillis(t)]:void 0})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.modeReduce=t.submatrixCollect=t.greatestHalf=t.leastQuarter=t.subMatrixMode=t.submatrixMagnitude=t.submatrixForEach=t.index1D=t.slice=t.matXvec=t.vecXvec=void 0;const i=n(1),r=n(5),o=n(13),s=n(79),a=n(51);function u(e,t,n,i){const r=Math.floor(Math.max(0,t.row)),o=Math.ceil(Math.min(e.row,n.row)),s=Math.floor(Math.max(0,t.col)),a=Math.ceil(Math.min(e.col,n.col));for(let t=r;t<o;t++)for(let n=s;n<a;n++)i(t*e.col+n)}function l(e,t,n,i){let o=0;return u(t,n,i,t=>r.mapFinite(e[t],e=>o+=e*e)),Math.sqrt(o)}function c(e,t,n,i){const o=[];return u(t,n,i,t=>r.mapFinite(e[t],e=>o.push(e))),a.mode(o)}t.vecXvec=function(e,t){return e.map((e,n)=>e*t[n])},t.matXvec=function(e,t){return e.map((e,n)=>{if(e.length!==t.length)throw new Error("misshaped matrix on row "+n);return a.sum(e.map((e,n)=>e*t[n]))})},t.slice=function(e,t,n){const r=Math.max(0,t.row),o=Math.min(e.length,n.row),s=Math.max(0,t.col),a=Math.min(e[0].length,n.col);return i.range(r,o,t=>e[t].slice(s,a))},t.index1D=function(e,t,n){return t*e.col+n},t.submatrixForEach=u,t.submatrixMagnitude=l,t.subMatrixMode=c,t.leastQuarter=function(e,t){const n=t.col,i=t.row,r=[l(e,t,{col:n/2,row:0},{col:n,row:i/2}),l(e,t,{col:0,row:0},{col:n/2,row:i/2}),l(e,t,{col:0,row:i/2},{col:n/2,row:i}),l(e,t,{col:n/2,row:i/2},{col:n,row:i})];return o.leastIndex(r)},t.greatestHalf=function(e,t){const n=t.col,i=t.row,r=[c(e,t,{col:0,row:0},{col:n,row:i/2}),c(e,t,{col:0,row:0},{col:n/2,row:i}),c(e,t,{col:0,row:i/2},{col:n,row:i}),c(e,t,{col:n/2,row:0},{col:n,row:i})];return o.greatestIndex(r)},t.submatrixCollect=function(e,t,n){const i=[];return u(e,t,n,e=>i.push(e)),i},t.modeReduce=function(e,t,n){const a=Math.floor(t.col/n.col),l=Math.floor(t.row/n.row),c=new s.Average(Math.ceil(a*l));return o.concat(...i.stepRange(0,t.row,l,n=>i.stepRange(0,t.col,a,i=>{c.clear();return u(t,{col:i,row:n},{col:i+a,row:n+l},t=>r.mapFinite(e[t],e=>c.push(e))),c.sampleMode})))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.coalesceStreams=t.AssetStream=t.cmpAssetDesc=t.cmpAssetAsc=t.BeforeAfterLimit=void 0;const r=n(13),o=n(6),s=n(51),a=n(196),u=n(1),l=n(55),c=n(0),d=n(5),h=n(42),f=n(26),m=n(132);t.BeforeAfterLimit=8;const p=new Map;function g(e){return e<=0?[]:l.getOrSet(p,e,()=>d.times(e,()=>a.BlankID))}function v(e){return[...e,...g(t.BeforeAfterLimit-e.length)]}t.cmpAssetAsc=(e,t)=>h.cmp([e.capturedAtLocal,e.id],[t.capturedAtLocal,t.id]),t.cmpAssetDesc=(e,t)=>h.cmp([t.capturedAtLocal,t.id],[e.capturedAtLocal,e.id]);t.AssetStream=class{constructor(e,t,n){this.tags=e,this.before=t,this.after=n,this.logger=()=>o.mkLogger("TaggedAssetStream("+this.toString()+")")}toString(){return this.tags.map(e=>e.path.join("")).join(",")}valueOf(){return this.toString()}mergeWith(e){e.tags.forEach(e=>u.insertUniq(this.tags,e,m.Tag.cmp)),this.before.push(...e.before),u.sortUniqByInPlace(this.before,e=>[e.capturedAtLocal,e.id]),r.retainFirstN(this.before,t.BeforeAfterLimit),this.after.push(...e.after),u.sortUniqByInPlace(this.before,e=>[-e.capturedAtLocal,e.id]),r.retainLastN(this.after,t.BeforeAfterLimit)}toApi(){return i(this,void 0,void 0,(function*(){return this.logger().tap({msg:"toApi()",level:"debug",result:{tags:yield f.thenCollect(this.tags,e=>e.toApiTag()),assetIdsAfter:(e=this.after.map(e=>e.toID()),[...g(t.BeforeAfterLimit-e.length),...e]),assetIdsBefore:v(this.before.map(e=>e.toID()))}});var e}))}streamCoeff(e){return this.logger().tap({level:"info",msg:"streamCoeff",meta:{this:this.tags.map(e=>e.path),tas:e.tags.map(e=>e.path)},result:s.avg([r.diceCoeff(this.before,e.before,e=>e.id),r.diceCoeff(this.after,e.after,e=>e.id)])})}},t.coalesceStreams=function(e){const t=[];for(const n of e)c.mapOr(r.greatestBy(t,e=>d.gtOrElse(e.streamCoeff(n),.6)),e=>{e.mergeWith(n)},()=>{t.push(n)});return t}},,,function(e,t){e.exports=require("@iarna/toml")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=void 0;const i=n(54),r=n(0),o=n(64);t.debounce=function(e,t){let n;t=Math.ceil(t);let s=[];const a=(...a)=>{s=a,r.map(n,i.clearTimeout),n=o.setUnrefTimeout(()=>e(...s),t)};return a.reset=()=>{r.map(n,i.clearTimeout),n=void 0},a.now=()=>{a.reset(),e()},a}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isInstallDmg=t.ignorableMacFilesystems=t.mounts=void 0;const r=n(1),o=n(2),s=n(0),a=n(8),u=n(20),l=n(46),c=n(41),d=n(23),h=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;function f(){return i(this,void 0,void 0,(function*(){const e=yield u.stdout("mount",[],{timeout:d.CmdTimeoutMs});return r.compact(e.split("\n").map(e=>s.map(h.exec(e),e=>{const[t,n,i]=e.slice(1);return{filesystem:t,mountpoint:n,options:i.split(",").map(e=>e.trim())}})))}))}function m(e){return i(this,void 0,void 0,(function*(){const t=c.BaseFile.for(e),n=yield a.thenMapOr(yield t.childNames(),e=>e.filter(e=>!e.startsWith(".")).map(e=>e.toLowerCase()).sort(),()=>[]);return l.eql(n,["applications","photostructure.app"])}))}t.mounts=f,t.ignorableMacFilesystems=o.lazy(()=>i(void 0,void 0,void 0,(function*(){return a.asyncFilter(yield f(),e=>i(void 0,void 0,void 0,(function*(){return e.options.includes("nobrowse")||e.options.includes("quarantine")||(yield m(e.mountpoint))}))).then(e=>e.map(e=>e.filesystem))})),d.MountpointsTtlMs),t.isInstallDmg=m},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsPosix=void 0;const r=n(1),o=n(0),s=n(8),a=n(122),u=n(121);t.mountpointsPosix=function(){return i(this,void 0,void 0,(function*(){const e=yield s.thenMap(a.dfPosixRaw(!1),e=>r.compactBlanks(e.map(e=>e.mountpoint)));return null!=e&&(yield u.isGioSupported())&&(yield s.thenMap(u.gioVolumes(),t=>e.push(...t.map(e=>e.mountpoint)))),o.map(e,e=>e.filter(e=>!e.startsWith("/snap/")&&"/dev"!==e))}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsWinFsutil=t.mountpointsWin=void 0;const r=n(1),o=n(4),s=n(69),a=n(20),u=n(72),l=n(43),c=/\s([A-Z]:\\)/g;t.mountpointsWin=()=>i(void 0,void 0,void 0,(function*(){return s.thenOpt(l.PowerShell.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(e=>e.map(e=>e.Root)).filter(r.isNotEmpty).orElse(()=>t.mountpointsWinFsutil()).map(e=>e.sort()).getRequired()})),t.mountpointsWinFsutil=()=>i(void 0,void 0,void 0,(function*(){const e=(yield a.stdout(yield u.fsutil(),["fsinfo","drives"],{timeout:10*o.secondMs})).trim(),t=[];let n;for(;null!==(n=c.exec(e));)t.push(n[1]);return t}))},function(e,t){e.exports=require("punycode")},function(e,t){e.exports=require("dns")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ipAddrFromPing=t.ipv4Re=t.ping=void 0;const r=n(3),o=n(4),s=n(5),a=n(18),u=n(7),l=n(80),c=n(20),d=n(72),h=n(14);t.ping=l.memoize(e=>i(void 0,void 0,void 0,(function*(){const t=h.isWin?yield d.pingWin():"ping";return c.stdout(t,[h.isWin?"-n":"-c","1",e],{timeout:5*o.secondMs})})),5*o.minuteMs,255),t.ipv4Re=new RegExp("\\b"+s.times(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),t.ipAddrFromPing=l.memoize(e=>i(void 0,void 0,void 0,(function*(){return a.Opt(yield t.ping(e).catch(e=>{console.warn("failed to ping: "+e)})).filter(r.notBlank).flatMap(e=>t.ipv4Re.exec(u.toS(e))).map(e=>e[0]).get()})),5*o.minuteMs,255)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosix=void 0;const r=n(57),o=n(8),s=n(122),a=n(121),u=n(38),l=n(23),c=r.keyedLazy("localMountpoints",u.mountsCacheKey,()=>o.thenMap(s.dfPosixRaw(!0),e=>e.map(e=>e.mountpoint)),l.KeyedLazyVolumeOpts);t.dfPosix=r.keyedLazy("dfPosix",u.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=yield s.dfPosixRaw(!1);if(null!=e)return yield o.thenMap(c(),t=>{e.forEach(e=>{e.remote=!t.includes(e.mountpoint)})}),(yield a.isGioSupported())&&(yield o.thenMap(a.gioVolumes(),t=>e.push(...t))),e}))}),l.KeyedLazyVolumeOpts)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._local=t.LocalCmd=t._localAndNet=t.LocalAndNetCmd=t.dfWin=void 0;const r=n(3),o=n(0),s=n(5),a=n(57),u=n(24),l=n(12),c=n(6),d=n(43),h=n(10),f=n(245),m=n(38),p=n(169),g=n(23),v=c.mkLogger("DfWin");function y(){return i(this,void 0,void 0,(function*(){const e=yield d.PowerShell.instance().executeJsonToA(t.LocalAndNetCmd).catch(e=>{u.onError("_localAndNet(): PowerShell failed, trying wmic",e)});return null==e?f._localAndNet():e.map(e=>Object.assign({mountpoint:e.Root,filesystem:"",label:e.Description,size:e.Used+e.Free,used:e.Used,available:e.Free,remote:r.notBlank(e.DisplayRoot)},o.map(p.parseRemoteName(e.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))))}))}function b(){return i(this,void 0,void 0,(function*(){const e=yield d.PowerShell.instance().executeJsonToA(t.LocalCmd);if(null==e)return f._local();return e.filter(e=>r.notBlank(e.DriveLetter)&&(r.notBlankAnd(e.HealthStatus,e=>h.equalsIgnoreCase(e,"Healthy"))||r.notBlankAnd(e.OperationalStatus,e=>h.equalsIgnoreCase(e,"OK")))).map(e=>({mountpoint:e.DriveLetter+":\\",filesystem:e.FileSystem,label:e.FileSystemLabel,size:e.Size,used:e.Size-e.SizeRemaining,available:e.SizeRemaining,remote:!1}))}))}t.dfWin=a.keyedLazy("dfWin",m.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){return(yield y().catch(e=>(v.warn("_localAndNet timed out, using local volumes.",e),b()))).filter(e=>r.notBlank(e.mountpoint)&&s.gt0(e.size))}))}),g.KeyedLazyVolumeOpts),l.onClearCache(()=>t.dfWin.clear()),t.LocalAndNetCmd="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free",t._localAndNet=y,t.LocalCmd="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus",t._local=b},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._local=t._localAndNet=t.dfWin=t.NETWORK_DRIVE=t.LOCAL_DISK=t.REMOVABLE_DISK=void 0;const r=n(3),o=n(5),s=n(13),a=n(57),u=n(20),l=n(82),c=n(72),d=n(6),h=n(10),f=n(38),m=n(23);t.REMOVABLE_DISK=2,t.LOCAL_DISK=3,t.NETWORK_DRIVE=4;const p=d.mkLogger("DfWinWmic");t.dfWin=a.keyedLazy("dfWin",f.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){return(yield v().catch(e=>(p.warn("_localAndNet timed out, using local volumes.",e),b()))).filter(e=>s.allNotBlank([e.mountpoint,e.filesystem])&&e.size>0)}))}),m.KeyedLazyVolumeOpts);const g="LOGICALDISK get DeviceID,DriveType,FileSystem,FreeSpace,Size,VolumeName /format:table".split(" ");function v(){return i(this,void 0,void 0,(function*(){const e=c.wmic(),n=yield u.stdout(e,g,{timeout:m.CmdTimeoutMs});return S(l.parseFixed(["DeviceID","DriveType","FileSystem","FreeSpace","Size","VolumeName"],n,!1).map(e=>{const n=r.mapNotBlank(e.DeviceID,e=>h.ensureSuffix(e,"\\")),i=e.FileSystem,s=e.VolumeName,a=o.toInt(e.Size,{defaultValue:0}),u=o.toInt(e.FreeSpace,{defaultValue:0});return{mountpoint:n,filesystem:i,label:s,size:a,used:a-u,available:u,remote:o.toInt(e.DriveType,{defaultValue:t.LOCAL_DISK})===t.NETWORK_DRIVE}}))}))}t._localAndNet=v;const y="VOLUME get Capacity,DriveLetter,FileSystem,FreeSpace,Label /format:table".split(" ");function b(){return i(this,void 0,void 0,(function*(){const e=c.wmic(),t=yield u.stdout(e,y,{timeout:m.CmdTimeoutMs});return S(l.parseFixed(["Capacity","DriveLetter","FileSystem","FreeSpace","Label"],t,!1).map(e=>{const t=r.mapNotBlank(e.DriveLetter,e=>h.ensureSuffix(e,"\\")),n=e.FileSystem,i=e.Label,s=o.toInt(e.Capacity,{defaultValue:0}),a=o.toInt(e.FreeSpace,{defaultValue:0});return{mountpoint:t,filesystem:n,label:i,size:s,used:s-a,available:a,remote:!1}}))}))}function S(e){return e.filter(e=>s.allNotBlank(e.mountpoint,e.filesystem)&&o.gte(e.size,0))}t._local=b},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mnt2uuidMac=t.addLocalVolumeInfoMac=void 0;const r=n(3),o=n(0),s=n(26),a=n(57),u=n(20),l=n(85),c=n(10),d=n(38),h=n(23);t.addLocalVolumeInfoMac=function(e){return i(this,void 0,void 0,(function*(){return s.thenMap(t.mnt2uuidMac(),t=>e.map(e=>o.mapOr(t.get(e.mountpoint),t=>Object.assign(Object.assign({},e),t),()=>e)))}))},t.mnt2uuidMac=a.keyedLazy("mnt2uuidMac",d.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=(yield u.stdout("diskutil",["info","-all"],{timeout:h.CmdTimeoutMs})).split(/^\s*\*{3,}\s*$/m);return l.toMap(e,e=>{const t=l.toMap(e.split(/\s*\n+\s*/),e=>{const[t,n]=e.split(":").map(e=>e.trim());return c.includesIgnoreCase(["not applicable","no file system"],n)?void 0:[t.toLowerCase(),n]}),n=t.get("mount point"),i=t.get("volume name"),o=t.get("volume uuid");return r.blank(n)?void 0:[n,{label:i,uuid:o}]})}))}),h.KeyedLazyVolumeOpts)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.addLocalVolumeInfoPosix=void 0;const r=n(1),o=n(0),s=n(26),a=n(7),u=n(57),l=n(20),c=n(183),d=n(83),h=n(38),f=n(23);t.addLocalVolumeInfoPosix=function(e){return i(this,void 0,void 0,(function*(){return s.thenMap(yield m(),t=>e.map(e=>o.mapOr(t.find(t=>t.mountpoint===e.mountpoint),t=>Object.assign(Object.assign({},e),t),()=>e)))}))};const m=u.keyedLazy("volumeInfoLinux",h.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const e=yield l.stdout("lsblk",["-P","--output","mountpoint,label,uuid"],{timeout:f.CmdTimeoutMs});return r.compact(d.splitLines(e).map(e=>o.map(c.parseEnvTokens(e),e=>a.toS(e.mountpoint).startsWith("/")?Object.assign(Object.assign({},e),{ignorable:e.mountpoint.startsWith("/snap/")||e.mountpoint.startsWith("/boot")}):void 0)))}))}),f.KeyedLazyVolumeOpts)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.FsutilVolumeList=t.addLocalVolumeInfoWin=void 0;const r=n(4),o=n(0),s=n(11),a=n(26),u=n(7),l=n(57),c=n(8),d=n(44),h=n(20),f=n(12),m=n(72),p=n(43),g=n(38),v=n(23);function y(e){const t=new Map;let n;const i=/^\\.+\{([a-z0-9-]+)\}\\(?:\r?\n)([a-z]:\\)/gim;for(;null!=(n=i.exec(e));){const e=n[1],i=n[2];t.set(i,e)}return t}t.addLocalVolumeInfoWin=function(e){return i(this,void 0,void 0,(function*(){const t=yield a.thenMap(P(),t=>e.map(e=>Object.assign(Object.assign({},e),s.compactValues(t.find(t=>t.mountpoint===e.mountpoint)))));return a.thenMap(b(),n=>o.orElse(t,e).map(e=>o.mapOr(n.get(e.mountpoint),t=>Object.assign(Object.assign({},e),{uuid:t}),()=>e)))}))},t.FsutilVolumeList="fsutil volume list";const b=l.keyedLazy("mnt2uuidWin",g.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){return p.PowerShell.instance().ended?y(yield h.stdout(yield m.fsutil(),["volume","list"],{timeout:7*r.secondMs})):p.PowerShell.instance().execute(t.FsutilVolumeList,y)}))}),v.KeyedLazyVolumeOpts);const S=/^[a-z]{1,2}/i,w=/Volume in drive [A-Z] is (.*)[\r\n]/im,M=/Volume Serial Number is ([A-Z0-9-]+)/i;const P=l.keyedLazy("mnt2info",g.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){return c.thenCompact(a.thenMap(g.mountpoints(),e=>d.withBoundedConcurrency({name:"_mnt2info",laters:e.map(e=>()=>function(e){return i(this,void 0,void 0,(function*(){return o.map((t=e,o.map(u.toS(t).match(S),e=>e[0]+":")),t=>i(this,void 0,void 0,(function*(){const n=yield h.execStdout("vol "+t),i=w.exec(n),r=M.exec(n);return{mountpoint:e,label:null==i?void 0:i[1],serialNumber:null==r?void 0:r[1]}})));var t}))}(e)),maxConcurrent:3})))}))}),v.KeyedLazyVolumeOpts);f.onClearCache(()=>{b.clear(),P.clear()})},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.addRemoteVolumeInfoPosix=void 0;const r=n(0),o=n(7),s=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i;t.addRemoteVolumeInfoPosix=function(e){return i(this,void 0,void 0,(function*(){return e.filter(e=>e.remote).forEach(e=>{r.map(s.exec(o.toS(e.filesystem)),t=>{e.remoteHost=t[1],e.remoteShare=t[2]})}),e}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readVolumeUUID=t.addVolumeUUIDs=t.VolumeUuidTimeoutMs=void 0;const r=n(59),o=n(3),s=n(2),a=n(0),u=n(69),l=n(57),c=n(44),d=n(22),h=n(12),f=n(33),m=n(6),p=n(251),g=n(38),v=n(23),y=s.lazy(()=>m.mkLogger("VolumeUUID"));t.VolumeUuidTimeoutMs=v.MountpointsTtlMs/2;const b=l.keyedLazy("VolumeUUID",g.mountsCacheKey,()=>i(void 0,void 0,void 0,(function*(){return new Map})),v.KeyedLazyVolumeOpts);function S(e){return i(this,void 0,void 0,(function*(){const n=f.PosixFile.for(e.mountpoint).join(".uuid");{const i=yield r.thenOrTimeout(()=>u.thenOpt(n.readFile("debug")).map(e=>e.toString().trim()).filter(o.notBlank).get(),t.VolumeUuidTimeoutMs);if(null!=i&&i.length>7)return y().info("Serving UUID from .uuid",{uuid:i,mountpoint:e.mountpoint}),i}if("/"===e.mountpoint)return a.orElse(e.uuid,e.serialNumber);const i=o.notBlankOr(e.uuid,p.mkuuid);try{return yield n.writeTxt(i),y().info("volumeUUID(): Saved new UUID for "+e.mountpoint,{uuid:i}),i}catch(t){return y().warn("volumeUUID(): Failed to save new UUID for "+e.mountpoint,t),a.orElse(e.uuid,e.serialNumber)}}))}h.onClearCache(()=>b.clear()),t.addVolumeUUIDs=function(e){return i(this,void 0,void 0,(function*(){const n=yield b();yield c.withBoundedConcurrency({name:"addVolumeUUIDs",laters:e.map(e=>()=>function(e,n){return i(this,void 0,void 0,(function*(){if(d.isTrue(e.ignorable))y().info("volumeUUID(): ignorable is true for "+e.mountpoint);else if(d.isFalse(e.remoteOK))y().info("volumeUUID(): remoteOK is false for "+e.mountpoint);else{{const t=yield null==n?void 0:n.get(e.mountpoint);if(null!=t)return void(e.uuid=t)}{const i=r.thenOrTimeout(()=>S(e),t.VolumeUuidTimeoutMs);a.map(n,t=>t.set(e.mountpoint,i));const o=yield i;if(null!=o)return void(e.uuid=o)}}}))}(e,n))})}))},t.readVolumeUUID=S},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UUIDRegExp=t.mkuuid=void 0;const i=n(109),r=n(2);t.mkuuid=function(){const e=i.randomBytes(16);e[6]=15&e[6]|64;const t=e.toString("hex");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20)].join("-")},t.UUIDRegExp=r.lazy(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.orLoggedAsync=t.orLogged=void 0;const r=n(0),o=n(11);function s(e,t,n){const i=null==n?"warn":"debug";e.log(i,t,n)}t.orLogged=function(e,t,n){const i={};try{for(const t of e)for(const e of o.keys(t)){const n=t[e]();if(i[e]=r.orElse(n,!1),!0===n)return n}return!1}finally{s(n,t,i)}},t.orLoggedAsync=function(e,t,n){return i(this,void 0,void 0,(function*(){const i={};try{for(const t of e)for(const e of o.keys(t)){const n=yield t[e]();if(i[e]=n,n)return n}return!1}finally{s(n,t,i)}}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SetSet=void 0;const i=n(55),r=n(0),o=n(16);t.SetSet=class{constructor(){this.store=new Map}add(e,t){i.getOrSet(this.store,e,()=>new Set).add(t)}delete(e,t){r.map(this.store.get(e),n=>{n.delete(t),0===n.size&&this.store.delete(e)})}find(e){return o.mapGte0(e.findIndex((t,n)=>{var i;return null===(i=this.store.get(t))||void 0===i?void 0:i.has(e[n+1])}),t=>e.slice(t,t+2))}has(e){return null!=this.find(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.seemsRecursive=void 0;const i=n(1),r=n(10);t.seemsRecursive=function(e,t=7){return i.compactBlanks(e).some(n=>i.count(e,e=>r.equalsIgnoreCase(n,e))>t)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.snaps=t.hasSnap=t.ignorableSnapDir=void 0;const r=n(4),o=n(2),s=n(15),a=n(127),u=n(20),l=n(82),c=n(6),d=n(14),h=n(30),f=c.mkLogger("Snap");t.ignorableSnapDir=a.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){if(!d.isLinux||!(yield t.hasSnap()))return!1;const n=h.pathnames(e.nativePath).indexOf("snap");return!(n<0)&&s.toA(yield t.snaps()).includes(h.pathnames[n+1])}))),t.hasSnap=o.lazy(()=>i(void 0,void 0,void 0,(function*(){try{return yield u.stdout("snap",["--version"],{timeout:10*r.secondMs}),!0}catch(e){return!1}}))),t.snaps=o.lazy(()=>i(void 0,void 0,void 0,(function*(){try{return yield l.parseFixed(["Name","Version"],yield u.stdout("snap",["list"],{timeout:10*r.secondMs})).map(e=>e.Name)}catch(e){return f.warn("snap failed",e),[]}})),30*r.secondMs)},,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ffmpegValidVideo=t.ffmpegTranscode=t.ffmpegFrame=t.isFFmpegSupported=t.checkFFmpegVersion=t.ffmpegVersionDescription=t.ffmpegVersion=void 0;const r=n(1),o=n(3),s=n(4),a=n(37),u=n(2),l=n(0),c=n(5),d=n(18),h=n(7),f=n(8),m=n(20),p=n(6),g=n(16),v=n(9),y=n(23),b=n(67),S=n(161),w=u.lazy(()=>p.mkLogger("ffmpeg")),M=u.lazy(()=>c.clamp(1,8,c.round(b.maxCpus()/2))),P=/ffmpeg version (\S+)/i;t.ffmpegVersion=u.lazy(()=>i(void 0,void 0,void 0,(function*(){var e;try{const t=yield m.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,["-version"],{timeout:y.CmdTimeoutMs,ignoreStderr:!0,isIgnorableError:()=>!0}),n=null===(e=P.exec(t.result))||void 0===e?void 0:e[1];return w().info("ffmpegVersion",{version:n,code:t.code,stdout:t.result.split("\n",1)[0]}),0===t.code&&o.notBlank(n)?n:void 0}catch(e){return}}))),t.ffmpegVersionDescription=u.lazy(()=>f.thenMapOr(t.ffmpegVersion(),e=>"version "+e,()=>"(not found)")),t.checkFFmpegVersion=function(){return i(this,void 0,void 0,(function*(){return f.thenOrElse(t.ffmpegVersion.prior(),()=>t.ffmpegVersion.refresh())}))},t.isFFmpegSupported=function(){return i(this,void 0,void 0,(function*(){return null!=(yield t.ffmpegVersion())}))};const E=/corrupt|invalid|error|failed|nothing\b.*\boutput|partial file|Cannot determine format of input stream.*after EOF/i;function x(e){return w().tap({msg:"isIgnorableError",meta:{err:e},result:null==a.errorToS(e).match(E)})}t.ffmpegFrame=function(e){var t;return i(this,void 0,void 0,(function*(){return(yield e.dest.exists())&&(yield e.dest.isEmpty())&&(yield e.dest.unlink()),m.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,r.compact(["-loglevel","error","-i",e.src.nativePath,...null!==(t=g.mapGte0f(e.startAtSec,e=>["-ss",e.toFixed(1)]))&&void 0!==t?t:[],"-vframes","1","-f","singlejpeg","-y",e.dest.nativePath]),{timeout:s.minuteMs,isIgnorableError:x})}))},t.ffmpegTranscode=function(e){return i(this,void 0,void 0,(function*(){const t=d.Opt(e.videoBitrateKbps).filter(c.gt0).map(e=>c.sigFigs(e,2)).map(e=>["-b:v",e+"k","-maxrate",e+"k","-bufsize",c.sigFigs(e/2,2)+"k"]).getOrElse(()=>[]);return m.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,["-loglevel","error","-threads",h.toS(M()),"-i",e.src.nativePath,"-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high",...t,"-c:a","aac",e.dest.nativePath],{timeout:e.timeoutMs,isIgnorableError:x})}))},t.ffmpegValidVideo=function(e){return i(this,void 0,void 0,(function*(){return w().tap({msg:"ffmpegValidVideo",meta:{src:e.nativePath},result:yield m.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",h.toS(M()),"-i",e.nativePath,"-f","null","-"],{timeout:l.orElse(yield S.syncFileTimeoutForFileMs(e),2*s.minuteMs),isIgnorableError:x,ignoreExitCode:!0,quiet:!1})})}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.vlcTranscode=t.vlcFrame=t.vlcPath=t.isVlcSupported=t.checkVlcInfo=t.vlcInfo=t.vlcVersionDescription=void 0;const r=n(31),o=n(1),s=n(3),a=n(4),u=n(21),l=n(2),c=n(0),d=n(5),h=n(11),f=n(18),m=n(8),p=n(20),g=n(61),v=n(24),y=n(33),b=n(6),S=n(16),w=n(14),M=n(43),P=n(9),E=n(10),x=n(23),T=l.lazy(()=>b.mkLogger("vlc"));t.vlcVersionDescription=l.lazy(()=>m.thenMapOr(t.vlcInfo().catch(()=>{}),e=>"version "+e.version,()=>"(not found)"));const O=/VLC (?:version|media player) ([0-9.]+)/i,F=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"];function _(e){return i(this,void 0,void 0,(function*(){return m.thenMap(p.stdoutResult(e,[...F,"--version"],{timeout:x.CmdTimeoutMs,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),e=>f.Opt(e.result).filter(s.notBlank).map(e=>e.trim()).flatMap(e=>O.exec(e)).flatMap(e=>e[1]).get())}))}function D(e){return m.thenMap(M.PowerShell.instance().execute(`(Get-Item -path ${M.pwshQuote(e)}).VersionInfo.FileVersion`,e=>e).catch(t=>{T().warn("Failed to run vlcInfoWin: "+e+": "+t)}),e=>c.denull(e.trim()))}t.vlcInfo=l.lazy(()=>function(){return i(this,void 0,void 0,(function*(){const e=[];function t(...t){e.push(y.PosixFile.for(r.join(...t)))}if(w.isWin&&!P.Settings.vlcPath.hasValue()||e.push(P.Settings.vlcPath.valueOrDefault),w.isMac){const e="/Applications/VLC.app/Contents/MacOS/VLC";s.mapNotBlank(g.getEnv("HOME"),n=>t(n+e)),t(e)}if(w.isWin){const e=["VideoLAN","VLC","vlc.exe"];s.mapNotBlank(g.getEnv("LOCALAPPDATA"),n=>{t(n,"Apps",...e)}),s.mapNotBlank(g.getEnv("ProgramFiles"),n=>{t(n,...e)}),s.mapNotBlank(g.getEnv("ProgramFiles(x86)"),n=>{t(n,...e)})}for(const t of e)try{if(t instanceof y.PosixFile&&(yield t.clear().notExists()))continue;const e=t.toString(),n=yield w.isWin?D(e):_(e);if(s.blank(n)){T().info("vlcInfo(): no VLC version found for "+t);continue}return h.tap({path:e,version:n},e=>T().info("vlcInfo()",e))}catch(e){T().warn("vlcInfo(): err:"+e,{path:t})}}))}()),t.checkVlcInfo=function(){return i(this,void 0,void 0,(function*(){const e=yield t.vlcInfo.prior();return null!=(null==e?void 0:e.version)?e:yield t.vlcInfo.refresh()}))},t.isVlcSupported=function(){return i(this,void 0,void 0,(function*(){return!w.isArm&&(yield m.thenMapOr(t.vlcInfo(),e=>null!=e.version,()=>!1))}))},t.vlcPath=l.lazy(()=>m.thenMap(t.vlcInfo(),e=>null==e.version?void 0:e.path)),t.vlcFrame=function(e){var n;return i(this,void 0,void 0,(function*(){const i=yield t.vlcPath();if(s.blank(i))throw new Error(e.src+" is not supported (no vlc)");const r=E.stripPrefix(e.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(r))return T().throw("vlcFrame(): Invalid destination extension"+v.NonRetriableErrorFlag,{format:r,args:e});const l=null!==(n=e.startAtSec)&&void 0!==n?n:0,c=l+1,h=yield p.stdoutResult(i,o.compact([...F,"--avcodec-hw=none","--video-filter=scene","--scene-format="+r,"--scene-replace","--scene-ratio=500","--scene-path="+e.dest.dir,"--scene-prefix="+e.dest.name,"--start-time="+l.toFixed(1),"--stop-time="+c.toFixed(1),e.src.nativePath,"vlc://quit"]),{timeout:a.minuteMs,ignoreStderr:!0});if(e.dest.clear(),d.gt0(h.code))throw new Error("vlc failed: "+u.stringify(h));return h}))},t.vlcTranscode=function(e){return i(this,void 0,void 0,(function*(){const n=yield t.vlcPath();if(s.blank(n))throw new Error("vlc.transcode(): VLC is not installed, cannot transcode "+e.src);const i=o.compact(["vcodec=h264",S.mapGt0(e.videoBitrateKbps,e=>"vb="+e),S.mapGt0(e.width,e=>"width="+Math.floor(e)),S.mapGt0(e.height,e=>"height="+Math.floor(e)),"venc=x264{ref=2:me=hex:mixed_ref=0:chroma_qp_offset=0:b_adapt=1:direct=1:weightp=1:rc_lookahead=20}","acodec=mp4a","ab=128","channels=2","samplerate=44100","scodec=none","deinterlace"]).join(","),r=["access=file{overwrite}","mux=mp4","dst="+e.dest.base].join(",");return p.stdoutResult(n,[...F,"--no-repeat","--no-loop",e.src.fileuri(),`--sout=#transcode{${i}}:standard{${r}}`,"vlc://quit"],{cwd:e.dest.dir,timeout:e.timeoutMs,ignoreStderr:!0})}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mkDownloadableTitle=t.previewToDownloadable=t.extractPreviewInfo=void 0;const r=n(173),o=n(84),s=n(96),a=n(0),u=n(5),l=n(8),c=n(30),d=n(6),h=n(16),f=n(10),m=n(113),p=d.mkLogger("extractPreviewInfo");function g(e,t,n,i){return`Download ${t} ${e.ext} ${n} (${o.dimToS(i)})`}t.extractPreviewInfo=function(e,t){const n=t.posixPathFrom(e).replace(/\//g,"").split("-"),i=u.toInt(n[0]),r=n[1],o=s.ReducerNames.validOrElse(r,void 0),a=h.extractInt(n[2]);return u.gt0(i)?{file:t,assetId:i,reducer:o,width:a}:void p.warn("Failed to extract preview info",{file:t,previewsRoot:e,arr:n,assetId:i,reducer:o,width:a})},t.previewToDownloadable=function(e,t){return i(this,void 0,void 0,(function*(){return a.map2(t.assetId,t.width,(n,i)=>l.thenMap(m.dimensions(t.file),a=>{const u=o.dimToSize(a);return{size:u,basename:`${f.stripSuffix(e,c.extname2(e))}-${u}${t.file.ext}`,title:g(t.file,u,"image",a),description:"Download "+u,details:`(${o.dimToS(a)} ${t.file.ext})`,href:new r.AssetUrls(n).imgLink(s.ReducerNames.fit,i)}}))}))},t.mkDownloadableTitle=g},function(e,t){e.exports=require("net")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uid=void 0;const i=n(50),r=n(19),o=n(2),s=n(68),a=n(60);let u=0;const l=o.lazy(()=>s.shortStringSha(i.hostname()+r.pid)+"-");t.uid=function(){return l()+a.GeoRadix.encode(++u)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.OpenedByIO=t.currentLibraryLockOwner=t.expectedJson=t.isLockOwner=t.openedByFiles=t.StaleMs=void 0;const r=n(65),o=n(50),s=n(19),a=n(13),u=n(17),l=n(80),c=n(8),d=n(64),h=n(46),f=n(24),m=n(12),p=n(68),g=n(195),v=n(6),y=n(166),b=n(29),S=n(91),w=n(23),M=n(1),P=n(4),E=n(2),x=n(0),T=n(78);function O(e){return x.map(function(e){return x.map(e,e=>e.join("opened-by"))}(e),e=>e.children(e=>i(this,void 0,void 0,(function*(){return".json"===e.ext&&(yield e.isFile())}))))}t.StaleMs=P.hourMs,t.openedByFiles=O,t.isLockOwner=function(){return i(this,void 0,void 0,(function*(){return x.mapOr(S.libraryDataDir(),e=>i(this,void 0,void 0,(function*(){return h.eqlAsyncPicked(t.currentLibraryLockOwner(e),t.expectedJson(),"systemUID","pid")})),()=>i(this,void 0,void 0,(function*(){return!1})))}))},t.expectedJson=E.lazy(()=>i(void 0,void 0,void 0,(function*(){return{systemUID:yield g.systemUID(),pid:s.pid}}))),t.currentLibraryLockOwner=l.memoize(e=>i(void 0,void 0,void 0,(function*(){const n=!b.isSyncFileService(),r=v.mkLogger("currentLibraryLockOwner("+e+")"),o=yield g.systemUID(),s=yield O(e);if(M.isEmpty(s))return void r.warn("no opened-by files found.");const u=yield c.thenCompact(s.map(e=>i(void 0,void 0,void 0,(function*(){const t=yield e.readJSON();return n&&null==t&&!0!==(yield e.modifiedCloseTo(Date.now(),w.CmdTimeoutMs))?(r.warn("unlinking old empty json file: "+e),void(yield e.unlink("debug"))):Object.assign({file:e},t)})))),l=Date.now()-t.StaleMs,[d,h]=a.partition(u,e=>e.updatedAt>l);n&&M.isNotEmpty(h)&&(r.debug("Unlinking expired opened-by files:",{minUpdatedAt:l,staleJsons:h}),yield Promise.all(h.map(e=>{var t;return null===(t=e.file)||void 0===t?void 0:t.unlink("debug")})));const[f,m]=a.partition(d,e=>e.systemUID===o),p=f.map(e=>e.pid),S=x.orElse(yield y.existingPids(p),p),[P,E]=a.partition(f,e=>S.includes(e.pid));n&&M.isNotEmpty(E)&&(r.debug("Unlinking zombie opened-by files:",E),yield Promise.all(E.map(e=>{var t;return null===(t=e.file)||void 0===t?void 0:t.unlink()})));const T=[...P,...m];if(M.isEmpty(T))return void r.debug("No valid opened-by files.");const F=a.leastBy(T,e=>e.createdAt),_=T.filter(e=>e.systemUID===F.systemUID),D=a.leastBy(_,e=>[b.serviceNameIndex(e.serviceName),x.orElse(e.createdAt,()=>Date.now())]);return r.tap({msg:"currentLibraryLockOwner",level:"info",result:D})})),T.randomInt(7*P.secondMs,w.CmdTimeoutMs),3),m.onClearCache(()=>t.currentLibraryLockOwner.clear());class F extends u.EndableWrapper{constructor(e){super("OpenedByIO()",()=>this.onEnd(),u.EndableRanks.postdb),this.ldd=e,this.createdAt=Date.now(),this.watchers=[],this.intervalMs=t.StaleMs/4,this.file=E.lazy(()=>this.dir.join(p.shortFsStringSha(o.hostname(),7)+"-"+s.pid+".json")),this.json=E.lazy(()=>i(this,void 0,void 0,(function*(){return Object.assign({hostname:o.hostname(),serviceName:b.serviceName(),createdAt:this.createdAt,updatedAt:Date.now()},yield t.expectedJson())})),this.intervalMs/2),this.write=E.lazy(()=>i(this,void 0,void 0,(function*(){const e=yield this.json();return this.logger.tap({level:"info",msg:"write()",result:null!==(yield this.file().writeJsonMaybe(yield this.json())),meta:{file:this.file().nativePath,json:e}})})),this.intervalMs/2),this.setup=E.lazy(()=>i(this,void 0,void 0,(function*(){yield this.write(),yield this.watchers.push(...this.file().selfAndParents(4).map(e=>r.watch(e.nativePath,{persistent:!1,recursive:!1},()=>i(this,void 0,void 0,(function*(){u.ending()||(yield this.lockOwner.refresh())})))))}))),this.lockOwner=E.lazy(()=>i(this,void 0,void 0,(function*(){return yield this.setup(),t.currentLibraryLockOwner(this.ldd)})),7*P.secondMs),this.dir=e.join("opened-by"),this.timer=d.setUnrefInterval(()=>this.write(),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write.unset()}refresh(){return this.clear(),this.write()}onEnd(){return i(this,void 0,void 0,(function*(){this.watchers.forEach(e=>e.close()),this.watchers.length=0,x.map(this.timer,clearInterval),this.timer=void 0,yield this.file().unlink()}))}deleteAllLocks(e=!1){return i(this,void 0,void 0,(function*(){e?yield this.dir.rmrf():yield this.dir.visitDescendants(e=>e.eql(this.file())?void 0:e.unlink())}))}isLockOwner(){return i(this,void 0,void 0,(function*(){return h.eqlAsyncPicked(this.lockOwner(),t.expectedJson(),"systemUID","pid")}))}throwIfUnavailable(e){return i(this,void 0,void 0,(function*(){const t=yield this.lockOwner();if(null==t)return;const n=yield this.json(),i=n.systemUID;if(null!=t&&t.systemUID!==i)throw this.logger.warn("library is unavailable",{lockOwner:t,json:n}),new Error(`Library is already opened by ${t.hostname} (${t.serviceName}:${t.pid}) ${e}`+(b.isWebService()?"":f.FatalErrorFlag)+f.DoNotSendErrorFlag+f.NonRetriableErrorFlag)}))}}t.OpenedByIO=F},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toJSON=t.assignFromJSON=t.fromJSON=t.addModelClass=void 0;const i=n(22),r=n(6),o=n(10),s=n(1),a=n(3),u=n(11),l=n(18),c=new Map;function d(e){c.set(e.$ctor,e)}t.addModelClass=d;const h=([e,t])=>null!=e&&null!=t;function f(e,t,n=[]){const r=e.class();return u.keys(t).filter(e=>"$ctor"!==e).filter(e=>null!=t[e]).map(e=>{const a=t[e];return n.forEach(t=>e=o.stripPrefix(e,t)),s.includes(r.booleanFields,e)?[e,i.isTrue(a)]:[e,a]}).filter(h).forEach(([t,n])=>e[t]=n),e}t.fromJSON=function(e,t){if(null==t)throw new Error("json is null");if(null!=e&&a.notBlank(e.$ctor)&&!c.has(e.$ctor)&&d(e),t instanceof e)return t;const n=l.Opt(t.$ctor).flatMap(e=>c.get(e)).getOrElse(()=>e);if(t instanceof n)return t;const i=new n;return null==t?i:f(i,t,s.uniq([e.tableName+".",n.tableName+"."]))},t.assignFromJSON=f,t.toJSON=function e(t,n,i){if(null!=t)return Array.isArray(t)?t.map((t,r)=>e(t,n,`${i}[${r}]`)):"function"==typeof t.toJSON?t.toJSON():void r.mkLogger("ModelJSON.toJSON()").warn("Failed",{m:t,key:i,mc:n.$ctor})}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ModelOpsLocal=t.MaxBatchSize=void 0;const r=n(13),o=n(8),s=n(6),a=n(1),u=n(21),l=n(2),c=n(0),d=n(5),h=n(11),f=n(26),m=n(15),p=n(228),g=n(155),v=n(230),y=n(229),b=n(151);t.MaxBatchSize=99;class S{constructor(e,t){this.model=e,this.db=t,this.dbr=l.lazy(()=>new p.DbRequestLocal(this.db)),this.columnNames=l.lazy(()=>g.handleDbRetriesSync(()=>this.db().pragma(`table_info(${this.tableName})`).map(e=>e.name))),this.logger=s.mkLogger(`ModelOpsLocal(${e.tableName})`)}static forTableName(e){return this.instances.get(e)}static forModel(e,t){const n=e,i=new S(n,t);return this.instances.set(n.tableName,i),i}get dbOpen(){return c.mapOr(this.db(),e=>e.open,()=>!1)}get tableName(){return this.model.tableName}query(){return this.model.query()}toDbValued(e){const t=this.model.fromJSON(e),n=v.toDbValued(t);return h.pick(n,...this.columnNames())}exec(e){return this.dbr().exec(e)}run(e){return this.dbr().run(e)}fromJSON(e){return f.thenMap(e,e=>this.model.fromJSON(e))}fromJSONs(e){return i(this,void 0,void 0,(function*(){return(yield o.thenCompact(e)).map(e=>this.model.fromJSON(e))}))}first(e){return this.fromJSON(this.dbr().first(e))}all(e=this.query()){return this.fromJSONs(this.dbr().all(y.maybeLimit(e)))}allf(e){return this.all(e(this.query()))}findOne(e){return this.fromJSON(this.dbr().first(e.first()))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e){return this.findOneBy({id:e})}findByIds(e){return i(this,void 0,void 0,(function*(){const n=yield b.tx(this.db(),()=>i(this,void 0,void 0,(function*(){return f.thenCollect(r.batches(m.toA(e).filter(d.gt0),t.MaxBatchSize),e=>this.dbr().all(this.query().whereIn("id",e)))})));return a.sortBy(yield this.fromJSONs(a.flatten(n)),t=>e.indexOf(t.id))}))}findBy(e){return this.all(this.model.queryBy(e))}rows(){return this.count(this.model.query())}count(e){return o.thenOrElse(this.dbr().pluckFirst(e),()=>0)}insert(e){return i(this,void 0,void 0,(function*(){return b.tx(this.model.db(),()=>f.thenCollect(e,e=>this.insertOne(e)))}))}insertOne(e){return i(this,void 0,void 0,(function*(){const t=this.model.fromJSON(e);if(null!=t.id)throw new Error("insert called for "+u.stringify(e));t.$beforeUpsert();const n=t.$toDbJSON(this.columnNames()),i=yield this.run(this.model.query().insert(n));return yield this.findById(d.toInt(i.lastInsertRowid))}))}upsertOne(e){return i(this,void 0,void 0,(function*(){return(yield this.upsert([e]))[0]}))}get ucn(){return this.model.uniqueColumnName}get ucnConstraint(){return`(${this.ucn})`}upsert(e){return i(this,void 0,void 0,(function*(){const t=yield this.columnNames();return f.thenCollect(m.toA(e),e=>i(this,void 0,void 0,(function*(){const n=this.model.fromJSON(e);n.$beforeUpsert();const i=n.$toDbJSON(t);if(d.gt0(i.id)){const e=yield this.run(this.query().where({id:i.id}).update(i));return this.logger.debug("upsert(): update",{result:e,json:i}),n}if("id"===this.ucn){const e=yield this.run(this.query().insert(i));if(null==e||!d.gt0(e.lastInsertRowid))throw new Error("failed to insert "+u.stringify(i));return n.id=e.lastInsertRowid,n}{const e=this.query().insert(i).toSQL(),t=h.keys(i).filter(e=>"createdAt"!==e).map(e=>`${e}=excluded.${e}`).join(","),n={sql:`${e.sql} ON CONFLICT ${this.ucnConstraint} DO UPDATE SET ${t}`,bindings:e.bindings};return yield this.run(n),this.findOneBy(h.fromEntries(this.ucn.split(",").map(e=>[e,i[e]])))}})))}))}delete(e){return i(this,void 0,void 0,(function*(){return a.mapNotEmpty(e.filter(d.gt0),e=>this.run(this.model.query().delete().whereIn("id",e)))}))}}t.ModelOpsLocal=S,S.instances=new Map},,,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.posixLocale=t.macLocale=t.winLocale=t.lc2locale=t.locale=t.defaultLocale=void 0;const r=n(19),o=n(1),s=n(3),a=n(4),u=n(2),l=n(0),c=n(11),d=n(69),h=n(63),f=n(8),m=n(20),p=n(14),g=n(43),v=n(10);function y(e=r.env){return l.firstDefined(e.LC_ALL,e.LC_MESSAGES,e.LANG,e.LANGUAGE)}t.defaultLocale="en",t.locale=u.lazy(()=>i(void 0,void 0,void 0,(function*(){return S(yield h.firstDefinedLater(()=>y(),()=>p.isWin?w():void 0,()=>p.isMac?P():void 0,()=>p.isPosix?x():void 0))})));const b=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function S(e){if(s.blank(e)||v.equalsIgnoreCase("c",e)||v.equalsIgnoreCase("posix",e))return t.defaultLocale;{const n=b.exec(e);return null==n?t.defaultLocale:o.compact([n[1],n[2]]).join("-")}}function w(){return f.thenMap(g.PowerShell.instance().executeJson("GET-WinSystemLocale | Select-Object -Property Name"),e=>e.Name)}t.lc2locale=S,t.winLocale=w;const M={timeout:10*a.secondMs};function P(){return d.thenOpt(m.stdout("defaults",["read","-globalDomain","AppleLocale"],M)).flatMap(S).get()}t.macLocale=P;const E=/^([a-z_]+)\s*=\s*"(.+)"$/i;function x(){return d.thenOpt(m.stdout("locale",[],M)).flatMap(e=>e.split("\n").map(e=>l.map(e.match(E),e=>[e[1],e[2]]))).flatMap(c.fromEntries).flatMap(y).flatMap(S).get()}t.posixLocale=x},,,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.excludeDirnameFilter=t.fileExtFilter=t.onlyDirectories=t.extless=t.expensiveFileFilter=t.expensiveFileFilters=t.cheapFileFilter=t.noStatFileFilter=t.fileSizeFilter=t.notHiddenCheap=t.exifExtFilter=t.supportedMimeTypeFilter=t.videoFilter=t.imageFilter=t.hasBrowserImgMimetype=t.notRejected=t.hasMakeAndModel=t.hasMimeType=t.minDimensionsFilter=t.requiredTagsFilter=t.onlyReadable=t.onlyFiles=void 0;const r=n(1),o=n(3),s=n(2),a=n(5),u=n(7),l=n(13),c=n(127),d=n(8),h=n(178),f=n(81),m=n(6),p=n(16),g=n(9),v=n(40),y=n(49),b=n(225),S=n(171);function w(e){return c.AsyncFilter.lift(t=>i(this,void 0,void 0,(function*(){return d.thenMapOr(v.readRawTags(t,!1),e,()=>!1)})))}function M(e){return w(t=>l.allNotBlank(...e.map(e=>t[e])))}t.onlyFiles=c.AsyncFilter.lift(e=>e.isFile()),t.onlyReadable=c.AsyncFilter.lift(e=>e.isReadable()),t.requiredTagsFilter=M,t.minDimensionsFilter=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){const t=yield v.mimetype(e);if(null==t||!t.startsWith("image/")&&!t.startsWith("video/"))return!1;const n=t.startsWith("video/")?g.Settings.minVideoDimension.valueOrDefault:g.Settings.minImageDimension.valueOrDefault;return d.thenMapOr(v.sizeInfo(e),e=>a.gte(e.ImageWidth,n)&&a.gte(e.ImageHeight,n),()=>!1)}))),t.hasMimeType=M(["MIMEType"]),t.hasMakeAndModel=M(["Make","Model"]),t.notRejected=w(e=>a.toInt(e.Rating,{defaultValue:0})>=0),t.hasBrowserImgMimetype=w(e=>r.includes(["image/jpeg","image/png"],u.toS(e.MIMEType))),t.imageFilter=w(e=>u.toS(e.MIMEType).startsWith("image/")),t.videoFilter=w(e=>u.toS(e.MIMEType).startsWith("video/"));const P=t.imageFilter.and(t.hasMakeAndModel).or(t.videoFilter),E=s.lazy(()=>new Set([...y.sharpSupportedMimeTypes(),...h.dcrawSupportedMimeTypes]));function x(e){return!o.blank(e)&&(f.isVideoMimeType(e)||E().has(e.toLowerCase()))}t.supportedMimeTypeFilter=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return d.thenMapOr(v.mimetype(e.nativePath),x,()=>!1)}))),t.exifExtFilter=b.extFilter(y.AssetFileExts),t.notHiddenCheap=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return!S.ignorablePath(e.nativePath)}))),t.fileSizeFilter=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return d.thenMapOr(e.size(),e=>p.within(g.Settings.minAssetSizeBytes.valueOrDefault,g.Settings.maxFileSizeBytes.valueOrDefault,e),()=>!1)}))),t.noStatFileFilter=c.AsyncFilter.andLogged(m.mkLogger("noStatFileFilter"),{exifExtFilter:t.exifExtFilter},{notHiddenCheap:t.notHiddenCheap}),t.cheapFileFilter=c.AsyncFilter.andLogged(m.mkLogger("cheapFileFilter"),{exifExtFilter:t.exifExtFilter},{notHiddenCheap:t.notHiddenCheap},{fileSizeFilter:t.fileSizeFilter}),t.expensiveFileFilters=s.lazy(()=>r.compact([{exifExtFilter:t.exifExtFilter},{fileSizeFilter:t.fileSizeFilter},{notHiddenCheap:t.notHiddenCheap},{hasMimeType:t.hasMimeType},{supportedMimeTypeFilter:t.supportedMimeTypeFilter},g.Settings.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:P}:void 0,{notRejected:t.notRejected},{minDimensionsFilter:t.minDimensionsFilter}])),t.expensiveFileFilter=s.lazy(()=>c.AsyncFilter.andLogged(m.mkLogger("expensiveFileFilter"),...t.expensiveFileFilters())),t.extless=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return o.blank(e.ext)}))),t.onlyDirectories=c.AsyncFilter.lift(e=>i(void 0,void 0,void 0,(function*(){return e.isDirectory()}))),t.fileExtFilter=function(e){return c.AsyncFilter.and(b.extFilter(e),t.onlyFiles)},t.excludeDirnameFilter=function(e){return c.AsyncFilter.and(b.excludedPathFilter(e),t.onlyDirectories)}},,function(e,t){e.exports=require("source-map-support")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommonArgs=void 0;const i=n(22),r=n(9),o=n(274);t.CommonArgs={beforeParse:e=>e.option("--verbose","Verbose logging mode for all current processes; equals --info --tail").option("--tail","Emit log messages from both this process and all other concurrently running PhotoStructure processes on this host to stdout. This can be really helpful in seeing how PhotoStructure's processes are coordinating work. Caution: very noisy especially during imports. Sets PS_TAIL_LOGS to true. Ignored if daemonized.").option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--info",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.'),afterParse:e=>{if(i.isTrue(e.elapsed)&&(r.Settings.logElapsedMs.tmpValue=e.elapsed),o.isDaemon(e))r.Settings.logStdout.tmpValue=!1,r.Settings.tailLogs.tmpValue=!1;else{const t=i.isTrue(e.verbose),n=i.isTrue(e.debug),o=i.isTrue(e.info)||t,s=i.isTrue(e.warn),a=i.isTrue(e.tail)||t;s&&(r.Settings.logLevel.tmpValue="warn"),o&&(r.Settings.logLevel.tmpValue="info"),n&&(r.Settings.logLevel.tmpValue="debug"),(n||o||s)&&(r.Settings.logStdout.tmpValue=!0),a&&(r.Settings.tailLogs.tmpValue=!0)}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDaemon=void 0;const i=n(19),r=n(22),o=n(3);t.isDaemon=function(e){return r.isTrue(i.env.__is_daemon)||r.isTrue(null==e?void 0:e.daemon)||!o.blank(null==e?void 0:e.pidfile)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.validFile=t.isValidFile=void 0;const r=n(73),o=n(4),s=n(2),a=n(18),u=n(8),l=n(56),c=n(12),d=n(33),h=n(222),f=n(6),m=n(9),p=n(40),g=n(52),v=n(224),y=n(135),b=n(118),S=n(81),w=s.lazy(()=>f.mkLogger("ValidFile")),M=new l.BoundedMap(10*o.minuteMs,1024,!0);function P(e){return i(this,void 0,void 0,(function*(){if(m.Settings.validateJpegImages.valueOrDefault||m.Settings.validateVideos.valueOrDefault)return h.getOrSetByNativePath(e,E,M);w().debug("no validation for "+e,{validateJpegImages:m.Settings.validateJpegImages.valueOrDefault,validateVideos:m.Settings.validateVideos.valueOrDefault})}))}function E(e){return i(this,void 0,void 0,(function*(){const t=d.PosixFile.for(e);try{const e=yield p.mimetype(t);if(null==e)throw new Error("Cannot validate, no mimetype");if(S.isVideoMimeType(e))m.Settings.validateVideos.valueOrDefault&&(w().debug("validating "+t),yield b.validVideo(t,e));else{if(!e.startsWith("image/"))throw new Error("Unsupported mimetype, "+e);if("image/jpeg"===e){if(m.Settings.validateJpegImages.valueOrDefault)return yield v.validJpeg(t)}else if(m.Settings.validateRawImages.valueOrDefault){const e=yield y.sharpReadable(t);if(null==e)throw new Error("Cannot read");yield r(e.nativePath,{failOnError:!0}).tiff().toBuffer()}}}catch(e){throw new g.WrappedError({cause:e,message:"invalid file "+t,retriable:!1,ignorable:!0})}}))}c.onClearCache(()=>M.clear()),c.onFileChanged(e=>a.Opt(e).forEach(e=>{M.delete(e)}).orElse(()=>{M.clear()})),t.isValidFile=function(e){return i(this,void 0,void 0,(function*(){return u.resolved(P(e))}))},t.validFile=P},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.posixPathFromUri=t.uriFromLibraryPath=t.installLibraryUriSupport=void 0;const i=n(148),r=n(30),o=n(33),s=n(9),a=n(3),u=n(2),l=n(7),c=n(87);t.installLibraryUriSupport=u.lazy(()=>{i.addUriParser(f),i.addUriFormatter(h)});const d=()=>a.mapNotBlank(s.Settings.libraryPath.value,e=>o.PosixFile.for(e));function h(e){if(a.blank(e.posixPath))return;const t=d();if(null==t)return;const n=o.PosixFile.for(r.posix2native(e.posixPath));return n.isDescendantOf(t)?{pathname:encodeURI(n.posixPathFrom(t)),protocol:c.PS_LIBRARY_PROTOCOL,slashes:!0}:void 0}function f(e){if(null==e||l.toS(e.protocol).toLowerCase()!==c.PS_LIBRARY_PROTOCOL)return;const t=d();return null!=t?a.mapNotBlankOr(e.pathname,e=>t.join(decodeURIComponent(e)),()=>t):void 0}t.uriFromLibraryPath=h,t.posixPathFromUri=f},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.b64diff=t.b64corr=t.uint12toB64=t.uint6toB64=t.uint8toB64=t.b64decodeSmall=t.b64hammRatio=t.b64decode=t.b64encode=t.b64charset=t.hex2b64=void 0;const i=n(1),r=n(3),o=n(0),s=n(5),a=n(13),u=n(16),l=n(51);function c(e){return"number"==typeof e&&e<t.b64charset.length?t.b64charset[e]:Buffer.from(e.toString(16),"hex").toString("base64")}function d(e){return BigInt("0x0"+Buffer.from(e,"base64").toString("hex"))}function h(e){if(null==e||0===e.length)return-1;const n=e.split("");let i=0;for(const r of n){const n=t.b64charset.indexOf(r);if(-1===n)return-1;if(i>Math.pow(2,46))throw new Error("b64decodeSmall("+e+"): overflow");i=64*i+n}return i}function f(e,t=6){const n=t/6;return i.stepRange(0,e.length,n,t=>h(e.substr(t,n)))}t.hex2b64=function(e){return Buffer.from(e,"hex").toString("base64")},t.b64charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t.b64encode=c,t.b64decode=d,t.b64hammRatio=function(e,t){return r.mapNotBlank(e,e=>r.mapNotBlank(t,t=>u.hammRatioBigInt(d(e),d(t))))},t.b64decodeSmall=h,t.uint8toB64=function(e){return Buffer.from(Uint8ClampedArray.from(e).buffer).toString("base64")},t.uint6toB64=function(e){return e.map(e=>t.b64charset[63&e]).join("")},t.uint12toB64=function(e){const t=[];return e.forEach(e=>{t.push(c(e>>6&63)),t.push(c(63&e))}),t.join("")},t.b64corr=function(e,t,n=6){if(e===t)return 1;const i=f(e,n),r=f(t,n),o=Math.pow(2,n-1);return l.cosineSimilarity(i.map(e=>e-o),r.map(e=>e-o))},t.b64diff=function(e,t,n=6){return e===t?0:a.zip(f(e,n),f(t,n)).reduce((e,t)=>o.orElse(s.absdiff(t[0],t[1]),0)+e,0)}},,,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dateTagFile=t.dateTag=t.dayTagRef=t.monthTagRef=t.yearTagRef=t.dayToOrdinal=t.monthToOrdinal=t.yearToOrdinal=void 0;const r=n(53),o=n(267),s=n(16),a=n(9),u=n(136),l=n(40),c=n(1),d=n(2),h=n(0),f=n(69),m=n(7),p=n(115),g=d.lazy(()=>i(void 0,void 0,void 0,(function*(){return new Intl.DateTimeFormat(yield o.locale(),{month:"short"})}))),v=d.lazy(()=>i(void 0,void 0,void 0,(function*(){const e=yield g();return c.range(0,12,t=>e.format(new Date(2016,t)))})));function y(e){return 1e4-e}function b(e){return 13-e}function S(e){return 33-e}function w(e){return s.mapGt0(e,e=>({name:m.toS(e),ordinal:y(e)}))}function M(e){return i(this,void 0,void 0,(function*(){if(s.within(1,12,e))return h.map((yield v())[e-1],t=>({name:t,ordinal:b(e)}))}))}function P(e){return s.mapGt0(e,e=>({name:m.toS(e),ordinal:S(e)}))}function E(e){return i(this,void 0,void 0,(function*(){const t=m.toS(a.Settings.tagDate.valueOrDefault).toLowerCase();if(""===t)return;const n=[p.When];if(t.startsWith("y")){const t=h.map(r.getYear(e),w);if(null==t)return;n.push(t)}if(t.startsWith("ym")){const t=yield h.map(r.getMonth(e),M);if(null==t)return n;n.push(t)}if(t.startsWith("ymd")){const t=h.map(r.getDay(e),P);if(null==t)return n;n.push(t)}return n}))}t.yearToOrdinal=y,t.monthToOrdinal=b,t.dayToOrdinal=S,t.yearTagRef=w,t.monthTagRef=M,t.dayTagRef=P,t.dateTag=E,t.dateTagFile=function(e,t=[]){return i(this,void 0,void 0,(function*(){return f.thenOpt(l.readTags(e)).flatMap(e=>u.bestCapturedAt([e.capturedAt,...t])).flatMap(e=>E(e.date)).get()}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CISet=void 0;const i=n(15),r=n(7);function o(e){return r.toS(e).normalize().toLowerCase()}class s{constructor(e){this.delegate=new Set,this.keys=this.values.bind(this),i.toA(e).forEach(e=>this.add(e))}get size(){return this.delegate.size}add(e){return this.delegate.add(o(e)),this}addAll(e){return i.toA(e).forEach(e=>this.delegate.add(o(e))),this}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(o(e))}forEach(e,t){for(const[t]of this.delegate)e(t,t,this)}has(e){return this.delegate.has(o(e))}values(){const e=this;return function*(){for(const t of e.delegate.keys())yield t}()}entries(){const e=this;return function*(){for(const t of e.delegate.keys())yield[t,t]}()}toA(){return[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}}t.CISet=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uidGeoHash=t.imageId=t.lensId=t.cameraId=t.normalizeExposureSettings=t.present=t.compactZeroes=t.zeroesRe=void 0;const i=n(1),r=n(3),o=n(2),s=n(0),a=n(5),u=n(11),l=n(7),c=n(177),d=n(6),h=n(226);t.zeroesRe=/^[\s0]*$/;const f=o.lazy(()=>d.mkLogger("ExifUid"));function m(e){return null==e||a.isNumber(e)?0===e:null!=t.zeroesRe.exec(l.toS(e))}function p(e){return null!=e&&r.notBlank(e)&&!m(e)}t.compactZeroes=function(e){return u.mapFields(e,(e,t)=>m(t)?void 0:[e,t])},t.present=p,t.normalizeExposureSettings=function(e){if(null==e)return;const t={focalLength:s.map(e.focalLength,e=>l.toS(e).trim()),aperture:a.mapNumeric(e.aperture,e=>a.sigFigs(e,2)),shutterSpeed:s.map(e.shutterSpeed,e=>{return t=e,n="/",l.toS(t).split(n).map(e=>a.mapIntOr(e,e=>l.toS(a.sigFigs(e,2)),()=>e)).join(n);var t,n}),iso:a.mapInt(e.iso,e=>a.sigFigs(e,2))};return f().debug("normalizeExposureSettings("+l.toS(e.FileName)+")",t),u.reqValuedOrElse(t)},t.cameraId=function(e){return s.map(u.pickFirst(e,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"],e=>r.notBlank(e)&&!m(e)),l.toS)},t.lensId=function(e){return s.map(h.extractLensMakeModel(e),({lensMake:e,lensModel:t})=>`${e.toLowerCase()}/${t.toLowerCase()}`)},t.imageId=function(e){return u.pickFirst(e,i.compact(["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"]),p)},t.uidGeoHash=function(e,t){return c.geohash(a.toFixed(e,4),a.toFixed(t,4))}},,,,,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.assetFileSortCriteriaPojo=t.sortAssetFiles=t.file2sortableAssetFile=t.mtime2sort=t.dim2sort=void 0;const r=n(1),o=n(3),s=n(4),a=n(2),u=n(0),l=n(5),c=n(11),d=n(7),h=n(87),f=n(30),m=n(6),p=n(10),g=n(49),v=n(113),y=a.lazy(()=>m.mkLogger("AssetFileSorter")),b=[h.PS_NETWORK_FILESYSTEM_PROTOCOL,"file:",h.PS_LOCAL_FILE_PROTOCOL,h.PS_LIBRARY_PROTOCOL];function S(e){return u.map(e,e=>l.map2Numeric(e.width,e.height,(e,t)=>Math.ceil(Math.pow(e*t,.15))))}function w(e){return Math.round(e/(2*s.minuteMs))}function M(e){const t=S(e),[n,i]=d.toS(e.uri).split("://");if(o.blank(n)||o.blank(i)||null==e.mtime)return void y().debug("assetFileSortCriteriaPojo(): skipping",{af:e,protocol:n,pathname:i});const r=b.indexOf(p.ensureSuffix(n,":").toLowerCase());if(-1===r)return void y().debug("assetFileSortCriteriaPojo(): skipping",{af:e,schemeIdx:r,protocol:n});const s=f.parsePosixPath(i),a=s.base.toLowerCase().includes("cover"),l=g.isBrowserExt(s.ext),c=u.orElse(f.countFromName(s.name),0);return{resolution:t,mtime:w(e.mtime),schemeIdx:r,isCover:a,count:c,isBrowserSupported:l,uri:e.uri}}t.dim2sort=S,t.mtime2sort=w,t.file2sortableAssetFile=function(e){return i(this,void 0,void 0,(function*(){return c.reqValuedOrElse(Object.assign({uri:yield e.uri(),mtime:yield e.thisOrSidecareMaxMtimeMs(),sha:yield e.sha()},yield v.dimensions(e)))}))},t.sortAssetFiles=function(e){for(const t of r.uniq(e.map(e=>e.sha))){const n=e.filter(e=>e.sha===t),i=Math.max(...r.compact(n.map(e=>e.mtime)));n.forEach(e=>e.mtime=i)}const t=r.compact(e.map(e=>u.map(M(e),t=>u.map(function(e){const t=c.values(e);return t.some(e=>null==e)?void y().debug("pojoToCriteria(): skipping",{pojo:e}):t}(t),n=>({f:e,crit:n,pojo:t}))))),n=r.sortBy(t,({crit:e})=>e);return r.mapNotEmpty(n,e=>e.map(e=>e.f))},t.assetFileSortCriteriaPojo=M},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SquareMatrix=t.rotateSquareMatrix=void 0;const i=n(108);t.rotateSquareMatrix=function(e,t){return 0===i.normalizeRotation(t)?e:new r(e).rotate(t).m};class r{constructor(e,t=1){if(this.m=e,this.ary=t,this.rows=Math.sqrt(e.length/t),this.rows!==Math.floor(this.rows))throw new Error(`Only square tuple matrices are supported: ${1===this.ary?"":this.ary}(${this.rows}Ã${this.rows}) != ${e.length}`)}index(e,t){return this.ary*(t+e*this.rows)}swap(e,t){for(let n=0;n<this.ary;n++){const i=this.m[e+n];this.m[e+n]=this.m[t+n],this.m[t+n]=i}}transpose(){for(let e=0;e<this.rows;e++)for(let t=e+1;t<this.rows;t++)this.swap(this.index(e,t),this.index(t,e));return this}reverseRows(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(t,e),this.index(this.rows-1-t,e));return this}reverseCols(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(e,t),this.index(e,this.rows-1-t));return this}reverse(){const e=Math.pow(this.rows,2);for(let t=0;t<e/2;t++)this.swap(t,e-1-t);return this}rotate(e){switch(i.normalizeRotation(e)){case 0:break;case 90:this.transpose(),this.reverseCols();break;case 180:this.reverse();break;case 270:this.transpose(),this.reverseRows();break;default:throw new Error("unsupported rotate("+e+")")}return this}}t.SquareMatrix=r},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prngSeed=t.SeedCount=t.primesPerBin=void 0;const i=n(78);t.primesPerBin=6,t.SeedCount=Math.pow(t.primesPerBin,6),t.prngSeed=function(){return i.randomInt(0,t.SeedCount)}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CPUs=t.osNameWin=t.osNameLinux=t.OS=void 0;const i=n(156),r=n(47),o=n(50),s=n(4),a=n(2),u=n(0),l=n(13),c=n(183),d=n(6),h=a.lazy(()=>d.mkLogger("os"));function f(){switch(o.platform()){case"linux":return p();case"darwin":return function(){try{const e=i.execSync("sw_vers -productVersion").toString().trim();return u.mapOr(g.get(o.release().split(".",1)[0]),t=>`macOS ${t} (${e})`,m)}catch(e){return h().warn("Failed to get osNameMac",e),m()}}();case"win32":return y();default:return m()}}function m(){return o.platform()+" "+o.release()}function p(){try{const e=r.readFileSync("/etc/os-release").toString(),t=c.parseEnvTokens(e);return u.map2Or(t.name,t.version,(e,t)=>e+" "+t,m)}catch(e){return h().warn("Failed to fetch /etc/os-release",e),m()}}t.OS=a.lazy(()=>[f(),"on",o.arch()].join(" ")),t.osNameLinux=p;const g=new Map([["19","Catalina"],["18","Mojave"],["17","High Sierra"],["16","Sierra"],["15","El Capitan"],["14","Yosemite"],["13","Mavericks"],["12","Mountain Lion"],["11","Lion"],["10","Snow Leopard"]]);const v=[["10.0","10"],["6.3","8.1"],["6.2","8"],["6.1","7"],["6.0","Vista"],["5.2","Server 2003"],["5.1","XP"],["5.0","2000"],["4.9","ME"],["4.1","98"],["4.0","95"]];function y(e=o.release()){for(const[t,n]of v)if(e.startsWith(t))return`Windows ${n} (${e})`;return h().warn("osNameWin(): unknown release: "+e),`Windows (${e})`}t.osNameWin=y,t.CPUs=a.lazy(()=>l.uniqCount(o.cpus().map(e=>e.model)).map(e=>`${e.count} Ã ${e.t}`).join(", "),s.minuteMs)},,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpBroadcaster=void 0;const r=n(2),o=n(6),s=r.lazy(()=>o.mkLogger("Broadcaster"));var a;!function(e){e.broadcast=(e,t)=>i(this,void 0,void 0,(function*(){return s().warn("broadcast sent to no-op",{event:e,args:t}),!1}))}(a||(a={})),t.NoOpBroadcaster=a},function(e,t){e.exports=require("file-type")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readFilePart=void 0;const r=n(65),o=n(0),s=n(8),a=n(16);t.readFilePart=function(e,t=0,n){return i(this,void 0,void 0,(function*(){let i=-1;try{const u=yield o.orElse(n,()=>s.thenMap(r.stat(e),e=>e.size-t)),l=Buffer.alloc(u);return i=yield r.open(e,"r"),yield r.read(i,l,0,u,t)}finally{yield a.mapGte0(i,r.close)}}))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.emitSafely=void 0;const r=n(1),o=n(8);t.emitSafely=function(e,t,n,s=1e3){return i(this,void 0,void 0,(function*(){const i=yield o.until(()=>r.isNotEmpty(e.listeners(t)),s);return i&&e.emit(t,n),i}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Reducers=t.Fit=t.fitInsideToAspectRatio=t.Square=t.SharpFits=void 0;const i=n(84),r=n(301),o=n(96),s=n(2),a=n(36),u=n(6),l=n(9),c=n(133);var d,h;t.SharpFits=a.strEnum("cover","contain","fill","inside","outside"),function(e){e.name=o.ReducerNames.sq,e.fit="cover",e.reduce=(e,t)=>{const n=t.width!==t.height;if(c.ltBoth(e,t))return n?Object.assign(Object.assign({},e),{fit:"cover",position:l.Settings.squareThumbStrategy.valueOrDefault}):e}}(d=t.Square||(t.Square={})),t.fitInsideToAspectRatio=function(e,t){return e.width/e.height>=t?{width:Math.floor(e.height*t),height:e.height}:{width:e.width,height:Math.floor(e.width/t)}},function(e){const t=s.lazy(()=>u.mkLogger("Reducers.Fit"));e.name=o.ReducerNames.fit,e.fit="inside",e.reduce=(e,n)=>{if(!c.ltBoth(n,e))return r.fitInside(n,e);t().trace(`reduce(): input ${i.dimToS(n)} is too small for ${i.dimToS(e)}`)}}(h=t.Fit||(t.Fit={})),t.Reducers=[d,h]},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fitInside=void 0,t.fitInside=function(e,t){const n=e.width/e.height;if(n>=t.width/t.height){const i=Math.min(t.width,e.width);return{width:i,height:Math.ceil(i/n)}}{const i=Math.min(t.height,e.height);return{width:Math.ceil(t.height*n),height:i}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatTimeoutMs=void 0;const i=n(4);t.StatTimeoutMs=25*i.secondMs},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractBitrateKbps=void 0;const i=n(0),r=n(7),o=n(13),s=n(16);t.extractBitrateKbps=function(e){return o.first(["AvgBitrate","MaxDataRate"],t=>{return n=e[t],i.map(s.extractFloat(n),e=>{const t=r.toS(n).toLowerCase();return i.map(o.first(a,e=>t.includes(e.pat)?e.fac:void 0),t=>e*t)});var n})};const a=[{pat:"mb/s",fac:1024},{pat:"mbps",fac:1024},{pat:"kb/s",fac:1},{pat:"kbps",fac:1}]},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.trueFilter=t.definedFilter=t.Filter=void 0;const i=n(0),r=n(127);class o{static lift(e){return new class extends o{apply(t){return e(t)}}}and(e){return o.lift(t=>this.apply(t)&&e.apply(t))}or(e){return o.lift(t=>this.apply(t)||e.apply(t))}filter(e){return e.filter(e=>this.apply(e))}asAsync(){return r.AsyncFilter.lift(e=>Promise.resolve(this.apply(e)))}}t.Filter=o,t.definedFilter=o.lift(i.defined),t.trueFilter=o.lift(()=>!0)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractExposureSettings=void 0;const i=n(3),r=n(11),o=n(6),s=n(16),a=o.mkLogger("ExposureSettings");t.extractExposureSettings=function(e){const t={focalLength:e.FocalLength,iso:s.firstNonZero(e.ISO,e.ISOSpeed,e.SonyISO),aperture:s.firstNonZero(e.FNumber,e.Fnumber,e.ApertureValue,e.SonyFNumber),shutterSpeed:i.firstNotBlank(e.ExposureTime,e.ShutterSpeed,e.SonyExposureTime)};return a.debug("extracted from "+e.FileName,{exposureSettings:t}),r.reqValuedOrElse(t)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readJsonSidecar=void 0;const r=n(98),o=n(74),s=n(3),a=n(5),u=n(18),l=n(6).mkLogger("JsonSidecar");function c(e,t,n){for(const i of t)if(e&&e[i]&&a.isNumber(e[i][n]))return e[i][n]}t.readJsonSidecar=function(e){return i(this,void 0,void 0,(function*(){const t=yield e.readJSON(),n=null==t?void 0:{DateTimeOriginal:u.Opt(t.photoTakenTime).flatMap(e=>e.timestamp).flatMap(a.toInt).filter(a.gt0).flatMap(e=>r.ExifDateTime.fromDateTime(o.DateTime.fromMillis(1e3*e))).get(),GPSLatitude:c(t,["geoDataExif","geoData"],"latitude"),GPSLongitude:c(t,["geoDataExif","geoData"],"longitude"),GPSAltitude:c(t,["geoDataExif","geoData"],"altitude"),Title:s.ifNotBlank(t.title),Description:s.ifNotBlank(t.description)};return null!=n&&l.debug("read "+e,n),n}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractTitleDescription=void 0;const i=n(1),r=n(3),o=n(7),s=n(11);t.extractTitleDescription=function(e){const t=i.uniq(["OLYMPUS DIGITAL CAMERA",e.originalMake,e.originalModel,e.Model,e.Make,e.CameraID]).map(e=>r.mapNotBlank(e,e=>e.trim().toLowerCase().normalize())),n=(...n)=>{for(const i of n){const n=o.toS(e[i]).trim();if(r.notBlank(n)&&!t.includes(n.toLowerCase().normalize()))return n}};return s.compactValues({title:n("XPTitle","Title","ObjectName"),description:n("XPSubject","Description","ImageDescription","Caption-Abstract")})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fsSafeHostname=void 0;const i=n(50),r=n(10);t.fsSafeHostname=function(e=i.hostname()){return r.stripDiacritics(e).replace(/[^a-z0-9-\s]/gi,"").trim().replace(/\s+/g,"-").toLowerCase()}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.JsonFileStore=void 0;const r=n(2),o=n(8),s=n(6),a=n(25),u=n(52);t.JsonFileStore=class{constructor(e,t,n=a.identity,i=a.identity){this.file=e,this.onCreate=t,this.onRead=n,this.onWrite=i,this.prior=r.lazy(()=>this.file.readJSON("debug"))}read(){return i(this,void 0,void 0,(function*(){const e=yield this.prior();return s.mkLogger("JsonFileStore").debug("prior "+this.file,e),null!=e?this.onRead(e):o.thenMap(this.onCreate(),e=>this.write(e))}))}write(e){return i(this,void 0,void 0,(function*(){try{const t=yield this.onWrite(e);return yield this.file.writeJSON(t,{spaces:2}),s.mkLogger("JsonFileStore").info("wrote to "+this.file,t),yield this.prior.set(Promise.resolve(t)),t}catch(e){throw new u.WrappedError({cause:e,message:"Failed to write to "+this.file})}}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;const r=n(19),o=n(59),s=n(3),a=n(4),u=n(32),l=n(21),c=n(2),d=n(0),h=n(5),f=n(7),m=n(71),p=n(17),g=n(8),v=n(70),y=n(24),b=n(12),S=n(102),w=n(62),M=n(6),P=n(93),E=n(28),x=n(29),T=n(261),O=n(311),F=a.minuteMs,_=5*a.secondMs,D={requestTTL:F,retriesPerRequest:5,delayBetweenRetries:E.isTest?100:_,maxPendingRequests:10};let C=0;t.Client=class{constructor(e,t,n={}){this.streamFactory=t,this._ended=!1,this.mkStreamRate=new P.Rate(a.minuteMs),this.times=new v.PromiseTimer,this.changeListeners=[],this.stream=c.lazy(()=>i(this,void 0,void 0,(function*(){try{if(this.flapping)return this.onError("stream() is restarting too frequently (epm: "+this.mkStreamRate.eventsPerMinute+")");const e=yield this.streamFactory();return null==e?this.onError("streamFactory() returned null"):(this.changeListeners.forEach(e=>e()),this.logger.debug("Opened stream"),e.on("end",e=>this.onFinish("on(end)",e)),e.on("close",e=>this.onFinish("on(close)",e)),e.on("error",e=>this.onError("stream error",e)),S.onDataChunked(e,"\n",e=>this.onData(e)),e)}catch(e){return this.onError("streamFactory rejection",e)}}))),this.ping=c.lazy(()=>this.request("ping",{serviceName:x.serviceName(),pid:r.pid}),250),this.name="rpc.Client("+e+"#"+C+++")",this.logger=M.mkLogger(this.name),this.opts=Object.assign(Object.assign({},D),n),this.pending=new m.TTLMap(3*this.opts.requestTTL),p.addFirstEndable(this),this.stream()}get ended(){return this._ended}end(){return this.logger.info("end()",{ending:p.ending(),timings:this.times.report(),pendingSize:this.pending.size}),this._ended=!0,this.pending.clear(),this.close()}addChangeListener(e){this.changeListeners.push(e)}get flapping(){return this.mkStreamRate.msSinceLastEvent<5*a.secondMs||h.gt(this.mkStreamRate.eventsPerMinute,5)}broadcast(e,t){return this.request("broadcast",{event:e,args:t})}sendRecentLogs(){return this.request("sendRecentLogs")}ready(e=2){return i(this,void 0,void 0,(function*(){if(this.ended)return this.logger.debug("ready(): false (ended)"),!1;const t=[...this.pending.values()],n=t.filter(e=>e.pending).length,i=t.filter(e=>e.rejected).length;return n>this.opts.maxPendingRequests||i>=e?(this.logger.warn("Client is not ready",{pendingReqCnt:n,recentErrCnt:i}),!1):null!=(yield this.stream())}))}request(e,t){return i(this,void 0,void 0,(function*(){if(this.ended){if(p.ending())return;throw new Error("client is ending")}if(s.blank(e))throw new Error("method cannot be blank");return o.retryOnReject(()=>this.submit(e,t),{maxRetries:this.opts.retriesPerRequest,onRetryWaitUntil:e=>u.delay(this.opts.delayBetweenRetries*e).then(()=>g.until(()=>this.ready(),this.opts.requestTTL)),errorIsRetriable:e=>f.toS(e).includes(y.RetriableErrorFlag)})}))}submit(e,t){return i(this,void 0,void 0,(function*(){const n=yield this.stream();if(null==n)return this.onError("submit("+e+"): stream is closed");const i=T.uid(),r=new O.RequestResponse(i,e,t,this.times);return r.setTimeout(this.opts.requestTTL),this.pending.set(i,r),this.logger.trace("sending request",{id:i,method:e,params:t}),n.write(l.stringify({id:i,method:e,params:t})+"\n"),r.response}))}close(){return this.logger.info("close()",{ended:this.ended}),g.thenMap(this.stream.clear(),w.end)}onData(e){if(!s.blank(e))try{this.logger.trace("onData",{req:e});const t=JSON.parse(e);if(s.blank(t.sid))throw new Error("response is missing server id");if(this.sid!==t.sid&&(null!=this.sid&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:t.sid}),b.eventEmitter.emit("rpcServerChange")),this.sid=t.sid,p.ending()))return;if(null==t.id){if(s.notBlank(t.event))return this.logger.debug("re-broadcasting event",t),void b.eventEmitter.emit(t.event,t.args);throw new Error("missing request id from response")}const n=this.pending.pop(t.id);null==n?this.logger.warn("unknown or stale request ID",{resp:t,pendingIds:[...this.pending.keys()]}):null!=t.error?(n.reject(d.orElse(t.error.message,t.error)),this.logger.warn("Rejected",{resp:t,rr:n})):(n.resolve(t.result),this.logger.debug("Resolved",t.result))}catch(t){this.logger.warn("invalid input: "+e,t)}}onError(e,t){return i(this,void 0,void 0,(function*(){this.logger.info(e+" onError(): "+d.map(t,e=>d.orElse(e.stack,e))),yield y.onError(e,t),yield this.restart()}))}restart(){return i(this,void 0,void 0,(function*(){if(this.logger.info("restart()",{ended:this.ended,flapping:this.flapping}),yield this.close(),this.changeListeners.forEach(e=>e()),this.flapping)this.logger.warn("restart(): Too many recent errors, we'll try reconnecting again in a bit",{errPerMin:this.mkStreamRate.eventsPerMinute});else{if(!this.ended&&!p.ending()){if(null!=(yield this.stream())){const e=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+e.length+" jobs now."),e.forEach(e=>e.reject("restarting"+y.RetriableErrorFlag)),e.forEach(e=>e.d.promise.catch(()=>{})),!0}return this.logger.warn("restart(): stream() returned null"),!1}this.logger.warn("restart(): Ending. Rejecting new connection.")}}))}onFinish(e,t){if(this.ended)return;const n=null==t||!1===t;return this.logger.info("onFinish",{source:e,error:t,restarting:n}),n?this.restart():this.onError(e,t)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestResponse=void 0;const i=n(34),r=n(0),o=n(58);class s{constructor(e,t,n,i){this.id=e,this.method=t,this.params=n,this.timer=i;const r="rpc.RequestResponse("+t+")#"+e;this.d=new o.Deferred(r)}[i.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),r.map(this.d.settledMs,e=>this.timer.push(this.method,e)))}reject(e){this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}}t.RequestResponse=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.awaitAll=t.amap=t.atap=void 0;const i=n(11),r=n(26);t.atap=function(e,t){return r.isPromise(e)?r.thenTap(e,t):i.tap(e,t)},t.amap=function(e,t){return r.isPromise(e)?e.then(e=>t(e)):t(e)},t.awaitAll=function(e){return e.some(e=>r.isPromise(e))?Promise.all(e):e}},function(e,t){e.exports=require("knex")},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.primes=t.primeSeeds=t.primeLists=t.prng=t.prngOrderByClause=void 0;const i=n(4),r=n(2),o=n(5),s=n(292),a=n(13),u=n(80),l=n(316);function c(e){return a.zip(t.primeLists(),l.digits(e,s.primesPerBin,6).reverse()).map(([e,t])=>e[t])}t.prngOrderByClause=function(e,n,i){const[r,o,s,a,u]=t.primes(e),l=`(${n}%${a})`;return`ROUND(${`(${r}*${l}*${l}+${o}*${l})`}*${`(${s}*${l}+${a})`}+${`${u}+${n}`})${i?"%"+i:""}`},t.prng=function(e,n,i){const[r,o,s,a,u]=t.primes(e),l=n%a,c=(r*l*l+o*l)*(s*l+a)+u+n;return Math.round(c)%i},t.primeLists=r.lazy(()=>[[21683,39301,45853,57427,58991,65543],[262139,314569,366997,419429,471871,524309],[1048573,1258291,1468079,1677811,1887539,2097257],[10392467,22222223,32457869,42638597,58947631,68956417,84619573],[353868013,472882027,573259391,694847533,756065159,899809343],[2147483647,3743895347,4295032837,5949670231,6607882123,8753196421]]),t.primeSeeds=c,t.primes=u.memoize(e=>{const[t,n,i,r,a,u]=c(e%s.SeedCount);return[...[i/t,r/n,a/i,u/r].map(e=>o.sigFigs(e,6)),i]},1*i.minuteMs,256)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.digits=void 0,t.digits=function(e,t,n){const i=[];for(;e>0;){const n=e%t;i.push(n),e=Math.floor(e/t)}for(;null!=n&&i.length<n;)i.push(0);return i.reverse()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagUrls=void 0;const i=n(0),r=n(87);t.TagUrls=class{constructor(e){this.id=e}nextAssetBatch(e){const t={};return i.map(e,e=>t.capturedAtLt=e.getTime()),r.joinQuery("/tag-gallery/"+this.id,t)}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.tagAsset=t.tagAndUpsertAsset=void 0;const r=n(8),o=n(6),s=n(1),a=n(114),u=n(362),l=n(281),c=n(363),d=n(365),h=n(115),f=n(366),m=n(9),p=o.mkLogger("AssetTagger");function g(e,t,n,o=[]){return i(this,void 0,void 0,(function*(){const i=[];m.Settings.tagCamera.valueOrDefault&&(yield r.thenMap(u.cameraTagFile(e),t=>{p.debug("Camera tag for "+e+": "+h.joinTagPath(t,"|")),i.push(t)})),m.Settings.tagLens.valueOrDefault&&(yield r.thenMap(d.lensTagFile(e),t=>{p.debug("Lens tag for "+e+": "+h.joinTagPath(t,"|")),i.push(t)})),yield r.thenMap(l.dateTagFile(e,o),t=>{p.debug("Date tag for "+e+": "+h.joinTagPath(t,"|")),i.push(t)}),yield r.thenMap(c.keywordTagFiles(e,...t),t=>{p.debug("Keyword tags for "+e+": "+t),i.push(...t)}),m.Settings.tagType.valueOrDefault&&(yield r.thenMap(f.typeTagFiles(e,...t),t=>{p.debug("MIME type tags for "+e+": "+t),i.push(...t)}));const a=h.tagDeltas(n,s.uniqBy(i),!0);return p.debug("tagAsset("+e+")",{result:a,priorTagPaths:n}),a}))}t.tagAndUpsertAsset=function(e,t){return i(this,void 0,void 0,(function*(){return r.thenMap(g(t,yield e.getPosixFiles(),yield e.getTagPaths(),yield e.getCapturedAt()),t=>i(this,void 0,void 0,(function*(){yield a.Asset.addTags(e.id,t.add),yield a.Asset.removeTags(e.id,t.remove),e.tags=void 0})))}))},t.tagAsset=g},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.metadataQualityScore=t.whyNotSimilar=t.isSimilar=t.MetadataFieldValues=void 0;const i=n(27),r=n(46),o=n(355),s=n(25),a=n(283),u=n(367),l=n(1),c=n(3),d=n(4),h=n(0),f=n(5),m=n(11),p=n(36),g=n(45),v=p.strEnum("sha","mimetype","capturedAtSrc","capturedAtLocal","capturedAtPrecisionMs","make","model","cameraId","imageId","lensId","geohash",...u.ExposureSettingsProps,"meanHash","mode0","mode1","mode2","mode3","mode4");function y(e,t,n,i=s.identity){const o=i(e[n]),a=i(t[n]);if(!c.blank(o)&&!c.blank(a))return r.eql(o,a)?void 0:`Different ${String(n)}: ${o} != ${a}`}function b(e){return c.mapNotBlank(e,e=>e.toLowerCase().trim())}function S(e,t){if(null==e)return"af1 was undefined";if(null==t)return"af2 was undefined";if(r.definedAndEql(e.sha,t.sha))return;const n=Math.max(...l.compact([e.capturedAtPrecisionMs,t.capturedAtPrecisionMs,1])),s=i.localToTs(e.capturedAtLocal),u=i.localToTs(t.capturedAtLocal);if(null==s)return"af1 missing capturedAtLocal";if(null==u)return"af2 missing capturedAtLocal";if(!("stat"===e.capturedAtSrc||"stat"===t.capturedAtSrc)&&!f.closeTo(s,u,n)){return"Different Captured-at times: "+[e,t].map(e=>`${e.capturedAtLocal}${"Â±"+i.fmtDuration(n)}`).join(" != ")}const c=h.map(e,a.normalizeExposureSettings),d=h.map(t,a.normalizeExposureSettings),m=g.firstDefinedThunk([()=>y(e,t,"make",b),()=>y(e,t,"model",b),()=>y(e,t,"cameraId"),()=>y(e,t,"imageId"),()=>y(e,t,"lensId"),()=>y(e,t,"geohash"),()=>r.definedAndNotEql(c,d)?`Different exposure settings: ${c} != ${d}`:void 0]);if(null!=m)return m;if(l.count([r.definedAndEql(e.cameraId,t.cameraId),r.definedAndEql(e.imageId,t.imageId),r.definedAndEql(e.lensId,t.lensId),r.definedAndEql(e.geohash,t.geohash),r.definedAndEql(c,d)],e=>e)>=2)return;const p=o.imageHashCompare(e,t);return o.isSimilarComparison(p)?void 0:"low image correlation"}t.MetadataFieldValues=v.values,t.isSimilar=function(e,t){return null==S(e,t)},t.whyNotSimilar=S,t.metadataQualityScore=function(e){return null==e?-100:m.entries(e).filter(([e,n])=>null!=n&&t.MetadataFieldValues.includes(e)).length+(f.gt(e.capturedAtPrecisionMs,d.hourMs)?-5:f.gt(e.capturedAtPrecisionMs,d.minuteMs)?-1:0)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.imageHashSimilarity=t.isVerySimilarComparison=t.isVerySimilarImageHash=t.isSimilarComparison=t.isSimilarImageHash=t.isSimilarImage=t.imageHashCompare=t.imageHashToColors=t.imageHashToModes=t.labsCorr=t.labsCorr2=void 0;const r=n(1),o=n(0),s=n(5),a=n(11),u=n(46),l=n(6),c=n(278),d=n(51),h=n(9),f=n(356),m=n(179),p=n(180),g=l.mkLogger("ImageHashComparison");t.labsCorr2=function(e,t){const n=r.sum(e,e=>m.diffCIE94Corr(e,m.closestLab(t,e)))+r.sum(t,t=>m.diffCIE94Corr(t,m.closestLab(e,t))),i=Math.max(e.length,t.length,n);return(i-n)/i};function v(e,t){return u.eql(e,t)?1:d.avgWeighted(e.map((e,n)=>{const i=m.closestLab(t,e);if(null==i)return 20;const r=t.indexOf(i),o=Math.abs(n-r),a=.66*m.diffCIE94(e,i)+o;return s.clamp(0,1,1-(a-2.3)/20)}),[4,3,2,1])}function y(e,t){return d.avg([v(e,t),v(t,e)])}function b(e){return r.compact(r.compact(null==e?void 0:e.modes).map(e=>m.unlabhash(e,p.ModeBits)))}function S(e,t){if(null==e||null==t)return;const n={a:e,b:t,meanHamm:(i=c.b64hammRatio(e.meanHash,t.meanHash),o.map(i,e=>s.sigFigs(e,2))),labModesCorr:y(b(e),b(t))};var i;return g.debug("imageHashCompare()",n),a.reqValuedOrElse(n)}function w(e,t){return M(S(e,t))}function M(e){if(null==e)return!1;const t=h.Settings.minImageCorrPct.valueOrDefault/100,n=(t+2)/3,i=h.Settings.minColorCorrPct.valueOrDefault/100,r=(i+2)/3,o=s.gt(e.meanHamm,t),a=s.gt(e.labModesCorr,i);return g.tap({level:"info",msg:"isSimilarComparison",result:o&&a,meta:Object.assign(Object.assign({goodMeanHamm:o,goodLabModes:a},e),{minImg:t,goodImg:n,minColor:i,goodColor:r})})}function P(e){return null!=e&&(s.gte(e.meanHamm,.9)&&s.gte(e.labModesCorr,.9))}t.labsCorr=y,t.imageHashToModes=b,t.imageHashToColors=function(e){return r.uniqBy(b(e).map(e=>f.bestLabName(e,f.colorNames())),e=>e.rgb)},t.imageHashCompare=S,t.isSimilarImage=function(e,t,n,r="debug"){return i(this,void 0,void 0,(function*(){return g.tap({msg:`isSimilarImage(${e},${t})`,level:r,result:o.map2(yield p.imageHash(e,n),yield p.imageHash(t,n),w)})}))},t.isSimilarImageHash=w,t.isSimilarComparison=M,t.isVerySimilarImageHash=function(e,t){return P(S(e,t))},t.isVerySimilarComparison=P,t.imageHashSimilarity=function(e,t){return o.map(S(e,t),e=>d.avgMaybe(e.meanHamm,e.labModesCorr))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.annealSort=t.sortByHSV=t.sortByLab=t.sortByRgbHex=t.colorFamily=t.rgbhexColorFamily=t.labNames=t.bestLabName=t.rgbNames=t.bestRgbName=t.colorToTuple=t.colorNames=void 0;const i=n(1),r=n(2),o=n(0),s=n(5),a=n(15),u=n(172),l=n(10),c=n(179),d=n(180);function h(e){const t=c.rgbhex2Lab(e.rgb);return Object.assign(Object.assign({},e),{name:l.capitalize(e.name),lab:t,labhash:c.labhash(t,d.ModeBits)})}function f(e,n=t.colorNames()){return a.toA(o.map(c.rgbhex2Lab(e),e=>g(e,n)))}function m(e,n=t.colorNames()){return g(e,n)[0]}t.colorNames=r.lazy(()=>[{name:"Acid green",rgb:"#B0BF1A"},{name:"Amaranth pink",rgb:"#F19CBB"},{name:"Amaranth purple",rgb:"#AB274F"},{name:"Amaranth red",rgb:"#D3212D"},{name:"Amaranth",rgb:"#E52B50"},{name:"Amethyst",rgb:"#9966CC"},{name:"Antique brass",rgb:"#CD9575"},{name:"Antique bronze",rgb:"#665D1E"},{name:"Antique fuchsia",rgb:"#915C83"},{name:"Apple green",rgb:"#8DB600"},{name:"Apricot",rgb:"#FBCEB1"},{name:"Aquamarine",rgb:"#7FFFD4"},{name:"Artichoke",rgb:"#8F9779"},{name:"Ash grey",rgb:"#B2BEB5"},{name:"Asparagus",rgb:"#87A96B"},{name:"Avocado",rgb:"#568203"},{name:"Azure",rgb:"#007FFF"},{name:"Beaver",rgb:"#9F8170"},{name:"Bistre",rgb:"#3D2B1F"},{name:"Black coffee",rgb:"#3B2F2F"},{name:"Black olive",rgb:"#3B3C36"},{name:"Black pearl",rgb:"#041322"},{name:"Black",rgb:"#000000"},{name:"Blond",rgb:"#FAF0BE"},{name:"Blood red",rgb:"#660000"},{name:"Blue bell",rgb:"#A2A2D0"},{name:"Blue sapphire",rgb:"#126180"},{name:"Blue-green",rgb:"#0D98BA"},{name:"Blue-violet",rgb:"#7366BD"},{name:"Blue",rgb:"#1F75FE"},{name:"Brandy",rgb:"#87413F"},{name:"Brick red",rgb:"#CB4154"},{name:"Bright green",rgb:"#66FF00"},{name:"Bright lilac",rgb:"#D891EF"},{name:"Brilliant rose",rgb:"#FF55A3"},{name:"Brink pink",rgb:"#FB607F"},{name:"Bronze",rgb:"#CD7F32"},{name:"Brown",rgb:"#88540B"},{name:"Brown",rgb:"#A52A2A"},{name:"Bud green",rgb:"#7BB661"},{name:"Burgundy",rgb:"#800020"},{name:"Burnished brown",rgb:"#A17A74"},{name:"Burnt orange",rgb:"#CC5500"},{name:"Burnt sienna",rgb:"#E97451"},{name:"Burnt umber",rgb:"#8A3324"},{name:"Byzantium",rgb:"#702963"},{name:"Cadet blue",rgb:"#5F9EA0"},{name:"Cadet",rgb:"#536872"},{name:"Cadmium green",rgb:"#006B3C"},{name:"Cadmium red",rgb:"#E30022"},{name:"Candy pink",rgb:"#E4717A"},{name:"Cardinal",rgb:"#C41E3A"},{name:"Caribbean green",rgb:"#00CC99"},{name:"Carmine",rgb:"#960018"},{name:"Carnelian",rgb:"#B31B1B"},{name:"Cerise",rgb:"#DE3163"},{name:"Cerulean blue",rgb:"#2A52BE"},{name:"Cerulean",rgb:"#007BA7"},{name:"Champagne",rgb:"#F3E5AB"},{name:"Charcoal",rgb:"#36454F"},{name:"Chartreuse",rgb:"#DFFF00"},{name:"Chestnut",rgb:"#954535"},{name:"Chocolate",rgb:"#7B3F00"},{name:"Cinnamon Satin",rgb:"#CD607E"},{name:"Citrine",rgb:"#E4D00A"},{name:"Citron",rgb:"#9FA91F"},{name:"Claret",rgb:"#7F1734"},{name:"Cobalt blue",rgb:"#0047AB"},{name:"Cocoa brown",rgb:"#D2691E"},{name:"Coffee",rgb:"#6F4E37"},{name:"Cool grey",rgb:"#8C92AC"},{name:"Copper red",rgb:"#CB6D51"},{name:"Copper rose",rgb:"#996666"},{name:"Copper",rgb:"#B87333"},{name:"Cornflower blue",rgb:"#6495ED"},{name:"Cosmic cobalt",rgb:"#2E2D88"},{name:"Cotton candy",rgb:"#FFBCD9"},{name:"Crimson",rgb:"#DC143C"},{name:"Cyan",rgb:"#00B7EB"},{name:"Cyclamen",rgb:"#F56FA1"},{name:"Cyprus",rgb:"#003E40"},{name:"Dark brown",rgb:"#654321"},{name:"Dark byzantium",rgb:"#5D3954"},{name:"Dark cornflower blue",rgb:"#26428B"},{name:"Dark cyan",rgb:"#008B8B"},{name:"Dark goldenrod",rgb:"#B8860B"},{name:"Dark green",rgb:"#006400"},{name:"Dark liver",rgb:"#534B4F"},{name:"Dark magenta",rgb:"#8B008B"},{name:"Dark moss green",rgb:"#4A5D23"},{name:"Dark olive green",rgb:"#556B2F"},{name:"Dark orange",rgb:"#FF8C00"},{name:"Dark orchid",rgb:"#9932CC"},{name:"Dark pastel green",rgb:"#03C03C"},{name:"Dark powder blue",rgb:"#003399"},{name:"Dark purple",rgb:"#301934"},{name:"Dark red",rgb:"#8B0000"},{name:"Dark salmon",rgb:"#E9967A"},{name:"Dark sea green",rgb:"#8FBC8F"},{name:"Dark sienna",rgb:"#3C1414"},{name:"Dark slate blue",rgb:"#483D8B"},{name:"Dark slate grey",rgb:"#2F4F4F"},{name:"Dark spring green",rgb:"#177245"},{name:"Dark turquoise",rgb:"#00CED1"},{name:"Dark violet",rgb:"#9400D3"},{name:"Deep blue",rgb:"#0066FF"},{name:"Deep chestnut",rgb:"#B94E48"},{name:"Deep saffron",rgb:"#FF9933"},{name:"Deep sky blue",rgb:"#00BFFF"},{name:"Deep space",rgb:"#000040"},{name:"Deep taupe",rgb:"#7E5E60"},{name:"Denim",rgb:"#1560BD"},{name:"Desert",rgb:"#C19A6B"},{name:"Dim grey",rgb:"#696969"},{name:"Drab",rgb:"#967117"},{name:"Earth yellow",rgb:"#E1A95F"},{name:"Ebony",rgb:"#555D50"},{name:"Eggplant",rgb:"#614051"},{name:"Eggshell",rgb:"#F0EAD6"},{name:"Elderberry",rgb:"#171828"},{name:"Electric blue",rgb:"#7DF9FF"},{name:"Electric purple",rgb:"#BF00FF"},{name:"Emerald",rgb:"#50C878"},{name:"English green",rgb:"#1B4D3E"},{name:"English lavender",rgb:"#B48395"},{name:"English red",rgb:"#AB4B52"},{name:"Fern green",rgb:"#4F7942"},{name:"Fire opal",rgb:"#E95C4B"},{name:"Firefly",rgb:"#0E2A30"},{name:"Flame",rgb:"#E25822"},{name:"Flax",rgb:"#EEDC82"},{name:"Forest green",rgb:"#014421"},{name:"French beige",rgb:"#A67B5B"},{name:"French blue",rgb:"#0072BB"},{name:"French lilac",rgb:"#86608E"},{name:"French sky blue",rgb:"#77B5FE"},{name:"Fuchsia purple",rgb:"#CC397B"},{name:"Fuchsia",rgb:"#FF00FF"},{name:"Gold",rgb:"#E6BE8A"},{name:"Golden brown",rgb:"#996515"},{name:"Golden yellow",rgb:"#FFDF00"},{name:"Goldenrod",rgb:"#DAA520"},{name:"Glacier blue",rgb:"#C8DDE8"},{name:"grey",rgb:"#808080"},{name:"Green-blue",rgb:"#2887C8"},{name:"Green-yellow",rgb:"#ADFF2F"},{name:"Green",rgb:"#00A000"},{name:"Harvest gold",rgb:"#DA9100"},{name:"Heliotrope grey",rgb:"#AA98A9"},{name:"Heliotrope",rgb:"#DF73FF"},{name:"Hot magenta",rgb:"#FF1DCE"},{name:"Hot pink",rgb:"#FF69B4"},{name:"Imperial red",rgb:"#ED2939"},{name:"Indigo dye",rgb:"#00416A"},{name:"Indigo",rgb:"#4B0082"},{name:"Iris",rgb:"#5A4FCF"},{name:"Jade",rgb:"#00A86B"},{name:"Jet",rgb:"#343434"},{name:"Jungle green",rgb:"#29AB87"},{name:"Kelly green",rgb:"#4CBB17"},{name:"Key lime",rgb:"#E8F48C"},{name:"Khaki",rgb:"#C3B091"},{name:"Lapis lazuli",rgb:"#26619C"},{name:"Laurel green",rgb:"#A9BA9D"},{name:"Lavender grey",rgb:"#C4C3D0"},{name:"Lavender",rgb:"#B57EDC"},{name:"Licorice",rgb:"#1A1110"},{name:"Light blue",rgb:"#ADD8E6"},{name:"Light coral",rgb:"#F08080"},{name:"Light grey",rgb:"#D3D3D3"},{name:"Light green",rgb:"#90EE90"},{name:"Light periwinkle",rgb:"#C5CBE1"},{name:"Light pink",rgb:"#FFB6C1"},{name:"Light salmon",rgb:"#FFA07A"},{name:"Light sea green",rgb:"#20B2AA"},{name:"Light steel blue",rgb:"#B0C4DE"},{name:"Light yellow",rgb:"#FFFFE0"},{name:"Lilac",rgb:"#C8A2C8"},{name:"Lime",rgb:"#BFFF00"},{name:"Linen",rgb:"#FAF0E6"},{name:"Magenta",rgb:"#FF0090"},{name:"Mahogany",rgb:"#C04000"},{name:"Malachite",rgb:"#0BDA51"},{name:"Mango",rgb:"#FDBE02"},{name:"Marigold",rgb:"#EAA221"},{name:"Maroon",rgb:"#C32148"},{name:"Mauve taupe",rgb:"#915F6D"},{name:"Mauve",rgb:"#E0B0FF"},{name:"Medium aquamarine",rgb:"#66DDAA"},{name:"Medium blue",rgb:"#0000CD"},{name:"Medium orchid",rgb:"#BA55D3"},{name:"Medium purple",rgb:"#9370DB"},{name:"Medium sea green",rgb:"#3CB371"},{name:"Medium slate blue",rgb:"#7B68EE"},{name:"Medium spring green",rgb:"#00FA9A"},{name:"Medium turquoise",rgb:"#48D1CC"},{name:"Middle blue green",rgb:"#8DD9CC"},{name:"Middle blue purple",rgb:"#8B72BE"},{name:"Middle blue",rgb:"#7ED4E6"},{name:"Middle green yellow",rgb:"#ACBF60"},{name:"Middle green",rgb:"#4D8C57"},{name:"Middle purple",rgb:"#D982B5"},{name:"Middle red purple",rgb:"#A55353"},{name:"Middle red",rgb:"#E58E73"},{name:"Midnight blue",rgb:"#003366"},{name:"Midnight green",rgb:"#004953"},{name:"Moss green",rgb:"#8A9A5B"},{name:"Mossy oak",rgb:"#887848"},{name:"Mulberry",rgb:"#C54B8C"},{name:"Mustard",rgb:"#FFDB58"},{name:"Myrtle green",rgb:"#317873"},{name:"Neon blue",rgb:"#4666FF"},{name:"Nickel",rgb:"#727472"},{name:"Ocean green",rgb:"#48BF91"},{name:"Ochre",rgb:"#CC7722"},{name:"Olive green",rgb:"#B5B35C"},{name:"Olive",rgb:"#808000"},{name:"Olivine",rgb:"#9AB973"},{name:"Orange-red",rgb:"#FF5349"},{name:"Orange",rgb:"#FF7F00"},{name:"Orange",rgb:"#FFAA1D"},{name:"Orchid pink",rgb:"#F2BDCD"},{name:"Orchid",rgb:"#DA70D6"},{name:"Pale cerulean",rgb:"#9BC4E2"},{name:"Pale pink",rgb:"#FADADD"},{name:"Pale purple",rgb:"#FAE6FA"},{name:"Pale silver",rgb:"#C9C0BB"},{name:"Pansy purple",rgb:"#78184A"},{name:"Pastel pink",rgb:"#DEA5A4"},{name:"Pastel yellow",rgb:"#FFFF99"},{name:"Peach",rgb:"#FFDAB9"},{name:"Pear",rgb:"#D1E231"},{name:"Periwinkle",rgb:"#CCCCFF"},{name:"Persimmon",rgb:"#EC5800"},{name:"Pesto",rgb:"#7C7631"},{name:"Pewter blue",rgb:"#8BA8B7"},{name:"Phthalo green",rgb:"#123524"},{name:"Pink",rgb:"#D74896"},{name:"Pistachio",rgb:"#93C572"},{name:"Powder Blue",rgb:"#BEEEEF"},{name:"Plum",rgb:"#8E4585"},{name:"Prune",rgb:"#701C1C"},{name:"Puce",rgb:"#CC8899"},{name:"Pumpkin",rgb:"#FF7518"},{name:"Purple navy",rgb:"#4E5180"},{name:"Purple",rgb:"#A020F0"},{name:"Raisin black",rgb:"#242124"},{name:"Raw sienna",rgb:"#D68A59"},{name:"Raw umber",rgb:"#826644"},{name:"Rebecca purple",rgb:"#663399"},{name:"Red-purple",rgb:"#E40078"},{name:"Red-violet",rgb:"#C71585"},{name:"Red",rgb:"#ED1C24"},{name:"Rosy brown",rgb:"#BC8F8F"},{name:"Royal blue dark",rgb:"#002366"},{name:"Royal purple",rgb:"#7851A9"},{name:"Rufous",rgb:"#A81C07"},{name:"Saffron",rgb:"#F4C430"},{name:"Salmon pink",rgb:"#FF91A4"},{name:"Salmon",rgb:"#FA8072"},{name:"Sand",rgb:"#C2B280"},{name:"Sandy brown",rgb:"#F4A460"},{name:"Sap green",rgb:"#507D2A"},{name:"Scarlet",rgb:"#FF2400"},{name:"Sea green",rgb:"#2E8B57"},{name:"Sepia",rgb:"#985E2B"},{name:"Sepia black",rgb:"#2B0202"},{name:"Sienna",rgb:"#882D17"},{name:"Sky blue",rgb:"#87CEEB"},{name:"Sky magenta",rgb:"#CF71AF"},{name:"Slate blue",rgb:"#6A5ACD"},{name:"Slate grey",rgb:"#708090"},{name:"Steel pink",rgb:"#CC33CC"},{name:"Straw",rgb:"#E4D96F"},{name:"Tan",rgb:"#D2B48C"},{name:"Tangerine",rgb:"#F28500"},{name:"Taupe grey",rgb:"#8B8589"},{name:"Taupe",rgb:"#483C32"},{name:"Tea green",rgb:"#D0F0C0"},{name:"Tea rose",rgb:"#F4C2C2"},{name:"Teal blue",rgb:"#367588"},{name:"Teal",rgb:"#008080"},{name:"Terra cotta",rgb:"#E2725B"},{name:"Thistle",rgb:"#D8BFD8"},{name:"Turquoise blue",rgb:"#00FFEF"},{name:"Turquoise green",rgb:"#A0D6B4"},{name:"Turquoise",rgb:"#40E0D0"},{name:"Turtle green",rgb:"#2A380B"},{name:"Ultra pink",rgb:"#FF6FFF"},{name:"Ultra red",rgb:"#FC6C85"},{name:"Ultramarine",rgb:"#3F00FF"},{name:"Umber",rgb:"#635147"},{name:"Umbra",rgb:"#202000"},{name:"Vermilion",rgb:"#E34234"},{name:"Violet-blue",rgb:"#324AB2"},{name:"Violet-red",rgb:"#F75394"},{name:"Violet",rgb:"#8F00FF"},{name:"Viridian",rgb:"#40826D"},{name:"Vivid burgundy",rgb:"#9F1D35"},{name:"Vivid sky blue",rgb:"#00CCFF"},{name:"Vivid blue",rgb:"#0D00E5"},{name:"Vivid cyan",rgb:"#10FFFF"},{name:"Vivid indigo",rgb:"#3A00E7"},{name:"Wheat",rgb:"#F5DEB3"},{name:"White",rgb:"#FFFFFF"},{name:"Wisteria",rgb:"#C9A0DC"},{name:"Yellow-green",rgb:"#9ACD32"},{name:"Yellow-orange",rgb:"#FFAE42"},{name:"Yellow",rgb:"#FFEF00"}].map(h)),t.colorToTuple=h,t.bestRgbName=function(e,n=t.colorNames()){return f(e,n)[0]},t.rgbNames=f,t.bestLabName=m;const p=.25*c.labhash([100,100,100],d.ModeBits);function g(e,n=t.colorNames()){const r=c.labhash(e,d.ModeBits),o=n.filter(e=>Math.abs(r-e.labhash)<p).map(t=>Object.assign(Object.assign({},t),{cieDiff:c.diffCIE94(e,t.lab)}));return i.sortBy(o,e=>e.cieDiff).slice(0,5)}t.labNames=g;const v=r.lazy(()=>[{index:0,name:"yellows",rgb:"#FFDF00"},{index:1,name:"greens",rgb:"#0BDA51"},{index:2,name:"blues",rgb:"#0000ff"},{index:3,name:"reds",rgb:"#ff0000"}].map(h));function y(e){return m(e,v())}function b(e){return[u.bitZip({dims:[{value:e[0],min:0,max:100},{value:e[1],min:-100,max:100},{value:e[2],min:-110,max:100}],bitDepth:9})]}t.rgbhexColorFamily=function(e){return y(c.rgbhex2Lab(e))},t.colorFamily=y,t.sortByRgbHex=function(e){return b(c.rgbhex2Lab(e))},t.sortByLab=b,t.sortByHSV=function(e){const[t,n,i]=c.rgbhex2hsv(e);return[Math.round(12*t/360),Math.round(4*i/100),Math.round(4*n/100)]},t.annealSort=function(e,t,n){const r=(e,t,n)=>n-t<2?0:i.sum(e.slice(t,n-1),(n,i)=>o.map2Or(n,e[t+i+1],(e,t)=>c.diffCIE94(e.lab,t.lab),()=>100));return s.times(t,()=>i.anneal({array:e,expense:r,allowedDelta:n})),e}},,function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.aboutInfo=void 0;const r=n(50),o=n(19),s=n(8),a=n(118),u=n(294),l=n(14),c=n(43),d=n(9),h=n(66),f=n(1),m=n(3),p=n(0),g=n(35);t.aboutInfo=function(e){return i(this,void 0,void 0,(function*(){return f.compact([{term:"Version",defn:`${h.version} (${d.Settings.updateChannel.valueOrDefault} channel)`},{term:"Library path",defn:p.orElse(d.Settings.libraryPath.value,"(unset)")},{term:"OS",defn:u.OS()},l.isWin?{term:"PowerShell",defn:yield c.PowerShell.instance().version()}:void 0,{term:"Node.js",defn:o.versions.node},{term:"Free memory",defn:g.fmtMebi(r.freemem(),2)+" / "+g.fmtMebi(r.totalmem(),2)},{term:"CPUs",defn:u.CPUs()},m.mapNotBlank(l.procDeviceModel(),e=>({term:"Device",defn:e})),{term:"Video support",defn:yield s.thenOrElse(a.getVideoToolDetails(e),()=>"-")},m.mapNotBlank(o.versions.electron,e=>({term:"Electron",defn:e}))]).filter(({term:e,defn:t})=>m.notBlank(e)&&m.notBlank(t))}))}},,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cameraTagFile=t.cameraTag=void 0;const i=n(8),r=n(40),o=n(3),s=n(0),a=n(115);function u(e){return s.map(e,e=>o.mapNotBlank(e.Make,t=>o.mapNotBlank(e.Model,e=>[a.Camera,t,e])))}t.cameraTag=u,t.cameraTagFile=function(e){return i.thenMap(r.readTags(e),u)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.keywordTagFiles=t.dedupeKeywordPaths=t.normalizeKeywordPaths=t.extractPathnameTags=t.extractDashDashTags=void 0;const r=n(364),o=n(13),s=n(8),a=n(282),u=n(6),l=n(9),c=n(10),d=n(110),h=n(40),f=n(1),m=n(3),p=n(21),g=n(2),v=n(0),y=n(11),b=n(7),S=n(115),w=g.lazy(()=>u.mkLogger("KeywordTagger")),M=g.lazy(()=>new RegExp(`[${l.Settings.keywordDelimiters.valueOrDefault}]`));function P(e){return f.compactBlanks(Array.isArray(e)?f.flatten(e.map(P)):e.split(M()))}l.Settings.keywordDelimiters.addListener(()=>M.clear());const E=g.lazy(()=>new RegExp(`[ /${l.Settings.keywordDelimiters.valueOrDefault}]`));l.Settings.keywordDelimiters.addListener(()=>E.clear());const x=g.lazy(()=>m.mapNotBlank(l.Settings.keywordPathSeparators.valueOrDefault,e=>new RegExp(`[${e}]`)));function T(e){return null==e||f.isEmpty(e.Category)?[]:[e._,...T(e.Category[0])]}function O(e){return i(this,void 0,void 0,(function*(){if(null==e)return[];const t=[];return yield s.thenMap(function(e){return i(this,void 0,void 0,(function*(){if(null!=e)try{const t=yield r.parseStringPromise(e),n=null==t?void 0:t.Categories;return null==n?void 0:n.map(T)}catch(e){return}}))}(e.Categories),e=>t.push(...e)),f.compactBlankish([e.CatalogSets,e.HierarchicalSubject,e.Keywords,e.LastKeywordXMP,e.Subject,e.TagsList,e.XPKeywords]).forEach(e=>t.push(...Array.isArray(e)?e:P(e))),w().tap({msg:"rawTagKeywords()",result:f.uniq(t),meta:y.pick(e,"CatalogSets","Categories","HierarchicalSubject","Keywords","LastKeywordXMP","Subject","TagsList","XPKeywords")})}))}function F(e){return w().tap({msg:"extractDashDashTags()",result:v.mapOr(b.toS(e).split("--")[1],e=>f.compactBlanks(e.split(E())),()=>[]),meta:{s:e}})}function _(e){return[...F(e.parent().posixPath),...F(e.name)]}function D(e){const t=[],n=x(),[i,r]=o.partition(f.uniq(f.flatten(e.map(e=>c.isString(e)?e.split(M()):e)).map(e=>c.isString(e)&&null!=n&&null!=e.match(n)?e.split(n):e).map(e=>Array.isArray(e)&&1===e.length?e[0]:e).map(e=>c.isString(e)?e.trim():e.map(e=>e.trim()))),Array.isArray),s=new a.CISet;for(const e of i)s.add(e[e.length-1]),1===e.length?t.push([S.Keywords,...e]):t.push([c.capitalize(e[0]),...e.slice(1)]);for(const e of r.filter(e=>!s.has(e)))t.push([S.Keywords,e]);return t}function C(e){return f.uniqBy(f.sortBy(e,e=>{const t=e.join("/");return[t.normalize().toLowerCase(),-1*d.lcdiff(t)]}),e=>p.stringify(e).normalize().toLowerCase())}l.Settings.keywordPathSeparators.addListener(()=>x.clear()),t.extractDashDashTags=F,t.extractPathnameTags=_,t.normalizeKeywordPaths=D,t.dedupeKeywordPaths=C,t.keywordTagFiles=function(...e){return i(this,void 0,void 0,(function*(){return C(D([...l.Settings.tagKeywordsFromPath.valueOrDefault?f.flatten(e.map(_)):[],...l.Settings.tagKeywordsFromMetadata.valueOrDefault?f.flatten(yield Promise.all(e.map(e=>s.thenMap(h.readRawTags(e),O)))):[]]))}))}},function(e,t){e.exports=require("xml2js")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lensTagFile=t.lensTag=void 0;const i=n(8),r=n(40),o=n(3),s=n(0),a=n(115);function u(e){return s.map(e,e=>o.mapNotBlank(e.lensMake,t=>o.mapNotBlank(e.lensModel,e=>[a.Lens,t,e])))}t.lensTag=u,t.lensTagFile=function(e){return i.thenMap(r.readTags(e),u)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.fixCase=t.friendlySubtype=t.mimetypeToTag=t.typeTagFiles=void 0;const r=n(6),o=n(10),s=n(40),a=n(1),u=n(3),l=n(2),c=n(0),d=n(45),h=n(115),f=l.lazy(()=>r.mkLogger("TypeTagger"));t.typeTagFiles=function(...e){return i(this,void 0,void 0,(function*(){const t=a.uniq(yield Promise.all(e.map(s.mimetype)));return a.compact(t.map(p))}))};const m=new Map(["M2TS","JPEG","QuickTime"].map(e=>[e.toLowerCase(),e]));function p(e){const[t,n]=e.split("/");if(!u.blank(t)&&!u.blank(n))return f().tap({msg:"mimetypeToTag("+e+")",result:c.map(v(n,e),e=>a.compactBlanks([h.Type,o.capitalize(t),...e]))})}t.mimetypeToTag=p;const g=l.lazy(()=>new Map([["image/x-adobe-dng",["Raw","DNG"]],["image/x-fuji-raf",["Raw","Fujifilm"]],["video/m2ts",["MPEG-2"]],["video/mp4",["MPEG-4"]],["video/quicktime",["QuickTime"]],["video/x-msvideo",["AVI"]]]));function v(e,t){return d.firstDefinedThunk([()=>g().get(t.trim().toLowerCase()),()=>c.map(e.match(/^x-(\w{4,})-\w{3}/),e=>["Raw",o.capitalize(e[1])]),()=>[y(e.replace(/^(x-)|(vnd\.)|(prs\.)/i,"").replace(/-/g," "))]])}function y(e){return null!=e.match(/[a-z0-9]{3,4}/i)?e.toUpperCase():c.orElse(m.get(e.trim().toLowerCase()),()=>o.capitalize(e))}t.friendlySubtype=v,t.fixCase=y},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exposureSettingsDesc=t.ExposureSettingsProps=void 0;const i=n(1),r=n(0),o=n(7);t.ExposureSettingsProps=["focalLength","aperture","shutterSpeed","iso"],t.exposureSettingsDesc=function(e){return r.map(e,e=>i.compactBlanks([e.focalLength,r.map(e.aperture,e=>"Æ/"+e),o.toS(e.shutterSpeed),r.map(e.iso,e=>"ISO "+e)]).join(", "))}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){n(186),e.exports=n(446)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});try{n(272).install()}catch(e){}const r=n(17),o=n(8),s=n(75),a=n(33),u=n(355),l=n(29),c=n(88),d=n(1),h=n(11),f=n(358),m=n(216),p=n(273),g=n(447),v=n(276),y=n(119),b=n(354);!function(){var e;i(this,void 0,void 0,(function*(){try{const t=(yield new m.CLI("info","[FILE...]",["* Omit any filenames to see configuration information.","* File paths should be absolute or relative to cwd.","* Provide 2 file paths to see why PhotoStructure may consider them variants of the same asset."].join("\n")).add(p.CommonArgs).parse()).args;if(l.setServiceName("info"),yield c.readSystemSettings(),yield c.readLibrarySettings(),v.installLibraryUriSupport(),d.isEmpty(t))return void console.table(h.fromEntries([...yield f.aboutInfo(),{term:"System settings",defn:c.systemSettingsFile().nativePath},{term:"Library settings",defn:null===(e=c.librarySettingsFile())||void 0===e?void 0:e.nativePath}].map(({term:e,defn:t})=>[e,t])));if(console.dir(yield Promise.all(t.map(g.info)),{colors:!0,depth:5}),2===t.length){const e=a.PosixFile.for(t[0]),n=a.PosixFile.for(t[1]);yield o.thenMap2((new y.AssetFile).updateFromFile(e),(new y.AssetFile).updateFromFile(n),(t,r)=>i(this,void 0,void 0,(function*(){yield u.isSimilarImage(e,n,!0,"info");const i=b.whyNotSimilar(t,r);console.log(null==i?s.green("â these files are similar"):s.yellow("These files differ: "+i),{af1:t,af2:r})})))}}finally{yield r.endEndables()}}))}()},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.info=void 0;const r=n(127),o=n(8),s=n(24),a=n(171),u=n(33),l=n(270),c=n(288),d=n(356),h=n(179),f=n(180),m=n(275),p=n(40),g=n(66),v=n(1),y=n(0),b=n(11),S=n(18),w=n(45),M=n(353);t.info=function(e){var t;return i(this,void 0,void 0,(function*(){const n=u.PosixFile.for(e),i=[];for(const[e,t]of b.entries(yield a.ignorablePredicates(n)))(yield t())&&i.push(e);if(yield n.notExists())return{nativePath:n.nativePath,ignoredBecause:i};const P=yield p.capturedAt(n),E=yield p.readTags(n),x=yield r.AsyncFilter.andExplain(n,l.expensiveFileFilters()),T=yield f.imageHash(n),O=v.uniq(null===(t=null==T?void 0:T.modes)||void 0===t?void 0:t.map(e=>S.Opt(h.unlabhash(e,f.ModeBits)).flatMap(d.bestLabName).map(e=>`${e.name} (${e.rgb})`).get())).join(", "),F=yield M.tagAsset(n,[],[]);return Object.assign(Object.assign({nativePath:n.nativePath,ignoredBecause:i,filters:x,validFile:yield m.validFile(n).then(()=>"OK").catch(e=>s.errorToHumanString(e)),mimetype:y.map(E,e=>e.mimetype),uri:yield n.uri(),sha:yield n.sha(),capturedAtLocalCs:y.map(P,e=>e.toLocal()),capturedAtOffset:y.map(P,e=>e.toOffset()),capturedAtSrc:y.map(P,e=>e.src),tags:y.map(F,e=>e.add),imageHash:T,dominantColors:O,tz:y.map(E,e=>e.tz),tzSource:y.map(E,e=>e.tzSource),fileSortCriteria:yield o.thenMap(c.file2sortableAssetFile(n),c.assetFileSortCriteriaPojo)},y.mapOr(E,e=>b.pick(e,"geohash","tz","tzSource","rotation","exposureSettings","dimensions","problems","errors","Error","Warning"),w.NoOp)),{release:g.release})}))}}]);
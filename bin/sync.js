#!/usr/bin/env node
/* Copyright Â© 2020, PhotoStructure Inc. <https://photostructure.com/eula> */
module.exports=function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=418)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nulled=t.denull=t.firstDefined=t.allDefined=t.defined=t.map2Or=t.mapOr=t.orElse=t.map3=t.map2=t.mapTry=t.map=void 0;const n=i(44),r=i(7);function s(e,t){return null==e?void 0:t(e)}function o(e,t,i){return null==e||null==t?void 0:i(e,t)}function a(e,t){return null!=e?e:n.tot(t)}function u(e){return null!=e}t.map=s,t.mapTry=function(e,t){try{return s(e(),t)}catch(e){return}},t.map2=o,t.map3=function(e,t,i,n){return null==e||null==t||null==i?void 0:n(e,t,i)},t.orElse=a,t.mapOr=function(e,t,i){return null==e?i():t(e)},t.map2Or=function(e,t,i,n){return a(o(e,t,i),n)},t.defined=u,t.allDefined=function(e){return null!=e&&e.every(u)},t.firstDefined=function(...e){return e.find(u)},t.denull=function(e){return null==e||"null"===r.toS(e)?void 0:e},t.nulled=function(e){return null==e?null:e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stepRange=t.range=t.anneal=t.commonPrefixLength=t.firstMatch=t.sum=t.count=t.clear=t.uniqBy=t.uniq=t.compactBlanks=t.compactBlankish=t.compact=t.insertUniq=t.insertAt=t.pushUniq=t.includesAll=t.indexOf=t.includes=t.move=t.filterInPlace=t.startsWith=t.arrayEql=t.deepSortBy=t.sortBy=t.sortedBy=t.sorted=t.sortUniqByInPlace=t.sortByInPlace=t.copyArrayTo=t.sort=t.flatten=t.mapNotEmpty=t.mapArray=t.isEmpty=t.isNotEmpty=void 0;const n=i(3),r=i(90),s=i(20),o=i(189),a=i(54),u=i(0),l=i(41),c=i(78),d=i(15),h=i(7);function f(e){return o.isList(e)&&e.length>0&&e.some(e=>null!=e)}function p(e){return!f(e)}function m(e){return l.isPrimitive(e)||l.isPrimitiveArray(e)?e:e.valueOf()}function g(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t.length=e.length,t}function v(e,t){return g(y(e,t),e)}function y(e,t){return d.toA(e).filter(e=>null!=e).map((e,i)=>({item:e,cmp:u.map(t(e),e=>[e,i])})).filter(e=>null!=e.cmp).sort((e,t)=>l.cmp(e.cmp,t.cmp)).map(e=>e.item)}function b(e,t){return null!=e&&null!=t&&e.length===t.length&&e.every((e,i)=>e===t[i])}function w(e,t,i){if(t===i||t<0||i<0||t>=e.length||i>=e.length)return e;const n=e[t];return e.splice(t,1),e.splice(i,0,n),e}function S(e,t){if(null==e)return!1;for(const i of e)if(t.valueOf()===i.valueOf())return!0;return!1}function P(e){if(null==e)return[];const t=d.toA(e);return t.every(u.defined)?t:t.filter(u.defined)}t.isNotEmpty=f,t.isEmpty=p,t.mapArray=function(e,t){return Array.isArray(e)?t(e):void 0},t.mapNotEmpty=function(e,t){return f(e)?t(e):void 0},t.flatten=function(e,t=[]){if(null==e)return t;for(const i of e)null!=i&&(Array.isArray(i)?t.push(...P(i)):t.push(i));return t},t.sort=function(e){return v(P(e),m)},t.copyArrayTo=g,t.sortByInPlace=v,t.sortUniqByInPlace=function(e,t){const i=new Map;for(const n of e)a.getOrSet(i,s.stringify(t(n)),()=>n);return g(y(i.values(),t),e)},t.sorted=function(e){return e.every((t,i)=>0===i||t>e[i-1])},t.sortedBy=function(e,t){return e.every((i,n)=>0===n||t(i)>t(e[n-1]))},t.sortBy=y,t.deepSortBy=function e(t,i){return y(t,i).map(t=>r.isIterable(t)?e(t,i):t)},t.arrayEql=b,t.startsWith=function(e,t){return b(e.slice(0,t.length),t)},t.filterInPlace=function(e,t){for(let i=0;i<e.length;)t(e[i],i,e)?i++:e.splice(i,1);return e},t.move=w,t.includes=S,t.indexOf=function(e,t){if(null==e)return;let i=0;for(const n of e){if(t(n,i))return i;i++}},t.includesAll=function(e,t){return null!=e&&null!=t&&t.every(t=>S(e,t))},t.pushUniq=function(e,...t){if(e.length>100){const i=new Set(e);for(const n of t)i.has(n)||(e.push(n),i.add(n))}else for(const i of t)S(e,i)||e.push(i);return e},t.insertAt=function(e,t,...i){return e.splice(t,0,...i),e},t.insertUniq=function(e,t,i){for(let t=0;t<e.length-1;t++)if(i(e[t],e[t+1])>0)throw new Error("badly sorted array: "+e);for(let n=0;n<e.length;n++){const r=i(e[n],t);if(0===r)return e;if(r>0)return e.splice(n,0,t),e}return e.push(t),e},t.compact=P;const M=["","null","undefined"];function E(e,t=(e=>s.stringify(e))){if(p(e))return[];const i=new Map;return e.forEach(e=>u.map(e,n=>u.map(t(n),t=>a.getOrSet(i,t,()=>e)))),[...i.values()]}function x(e,t,i=1,n=(e=>e)){const r=[];if(e<t)for(let s=e;s<t;s+=i)r.push(n(s));else for(let s=e;s>t;s-=i)r.push(n(s));return r}t.compactBlankish=function(e){return d.toA(e).filter(e=>n.notBlank(e)&&!M.includes(h.toS(e).trim()))},t.compactBlanks=function(e){return null==e?[]:e.map(e=>h.toS(e).trim()).filter(e=>e.length>0)},t.uniq=function(e){return E(P(e),e=>s.stringify(e))},t.uniqBy=E,t.clear=function(e){return e.length=0,e},t.count=function(e,t){return e.reduce((e,i,n)=>e+(t(i,n)?1:0),0)},t.sum=function(e,t){return e.reduce((e,i,n)=>e+t(i,n),0)},t.firstMatch=function(e,t){for(const i of P(t)){const t=e.exec(i);if(null!=t)return t}},t.commonPrefixLength=function(e,t){if(null==e||null==t)return 0;if(e===t)return e.length;if("string"==typeof e&&(e=e.split("")),"string"==typeof t&&(t=t.split("")),b(e,t))return e.length;let i=0;for(;e[i]===t[i];)i++;return i},t.anneal=function({array:e,expense:t,allowedDelta:i}){const n=Math.round(i);if(n<2)return e;for(let i=0;i<e.length-1;i++){const r=c.randomInt(Math.max(0,i-n),Math.min(e.length,i+n),[i]);if(null==r)continue;const s=Math.max(0,Math.min(r,i)-1),o=Math.min(e.length,Math.max(r,i)+1),a=t(e,s,o);w(e,i,r);const u=t(e,s,o);l.lt(a,u)&&w(e,r,i)}return e},t.range=function(e,t,i=(e=>e)){return x(e,t,1,i)},t.stepRange=x},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazy=void 0;const n=i(200),r=i(0);t.lazy=function(e,t){let i,s=0;const o=[];function a(){s=0,i=void 0,o.forEach(e=>e(i))}function u(e){return s=Date.now(),n.eql(i,e)||o.forEach(t=>t(e)),i=e}function l(){return(0===s||null!=t&&s+t<=Date.now())&&u(e()),i}return l.set=e=>u(e),l.clear=()=>{const e=i;return a(),e},l.unset=()=>{a()},l.prior=()=>i,l.refresh=()=>u(e()),l.ttl=()=>t,l.setTTL=e=>t=e,l.onChange=e=>{o.push(e),r.map(i,e)},l.toJSON=()=>"(Lazy)",l.lastSetAgoMs=()=>Date.now()-s,l}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstNotBlank=t.mapNotBlankOr=t.mapNotBlank=t.notBlankAnd=t.notBlankOr=t.ifNotBlank=t.notBlank=t.blank=void 0;const n=i(0),r=i(44),s=i(15),o=i(7);function a(e){if(null==e)return!0;const t=o.toS(e);return 0===t.length||0===t.trim().length}function u(e){return!a(e)}function l(e,t){if(!1===e||null==e||""===e)return;const i=o.toS(e);return u(i)?t(i):void 0}t.blank=a,t.notBlank=u,t.ifNotBlank=function(e){if(null==e)return;const t=o.toS(e);return 0===t.length||0===t.trim().length?void 0:t},t.notBlankOr=function(e,t){if(null==e)return r.tot(t);const i=o.toS(e).trim();return i.length>0?i:r.tot(t)},t.notBlankAnd=function(e,t){return!a(e)&&t(e)},t.mapNotBlank=l,t.mapNotBlankOr=function(e,t,i){return n.orElse(l(e,t),i)},t.firstNotBlank=function(...e){return s.toA(e).find(e=>u(e))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitHMS=t.fmtDateShort=t.weekMs=t.dayMs=t.hourMs=t.minuteMs=t.secondMs=void 0;const n=i(2),r=i(18),s=i(0);t.secondMs=1e3,t.minuteMs=60*t.secondMs,t.hourMs=60*t.minuteMs,t.dayMs=24*t.hourMs,t.weekMs=7*t.dayMs;const o=n.lazy(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));t.fmtDateShort=function(e){return r.Opt(e).flatMap(e=>e instanceof Date?e.getTime():e).map(e=>o().format(e)).get()},t.splitHMS=function(e){return s.mapOr(/^[0:]{1,4}/.exec(e),t=>[t[0],e.substr(t[0].length)],()=>["",e])}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.times=t.clamp=t.base10Ceil=t.base2Ceil=t.sigFigs=t.toPrecision=t.toFixed=t.toPrecisionMaybe=t.round=t.numericOr=t.mapNumericOr=t.map2Numeric=t.mapNumeric=t.mapIntOr=t.id=t.mapFloat=t.mapInt=t.gte0=t.gtOrElse=t.gt0=t.toGt0=t.toFloat=t.toInt=t.isToNumber=t.trunc=t.closeTo=t.absdiff=t.diff=t.finiteOrElse=t.gte=t.gt=t.lte=t.lt=t.mapFinite=t.isNumber=void 0;const n=i(3),r=i(0),s=i(38),o=i(18),a=i(44),u=i(7);function l(e){return"number"==typeof e&&isFinite(e)}function c(e,t){return l(e)?t(e):void 0}t.isNumber=l,t.mapFinite=c;const d=e=>(t,i)=>l(t)&&l(i)&&e(t,i);function h(e){return b(e,e=>{const t=Math.trunc(e);return 0===t?Math.abs(t):t})}function f(e){return s.isFunction(e.toNumber)}function p(e,t){if(n.blank(e))return t.defaultValue;if(l(e))return t.nton(e);if(f(e))return t.nton(e.toNumber());try{const i=t.ston(u.toS(e));return l(i)?t.nton(i):t.defaultValue}catch(e){return t.defaultValue}}function m(e,t){return p(e,Object.assign({defaultValue:void 0,nton:e=>h(e),ston:parseInt},t))}function g(e,t){return p(e,Object.assign({defaultValue:void 0,nton:e=>e,ston:parseFloat},t))}function v(e){return l(e)&&e>0}function y(e,t){return o.Opt(e).flatMap(e=>m(e)).flatMap(t).get()}function b(e,t){return l(e)?t(e):void 0}function w(e){return e<0?-Math.round(-e):Math.round(e)}function S(e,t){if(null==e)return 0;const i=Math.pow(10,t);return w(e*i)/i}t.lt=d((e,t)=>e<t),t.lte=d((e,t)=>e<=t),t.gt=d((e,t)=>e>t),t.gte=d((e,t)=>e>=t),t.finiteOrElse=function(e,t){return l(e)?e:t},t.diff=function(e,t){return l(e)&&l(t)?e-t:void 0},t.absdiff=function(e,t){return l(e)&&l(t)?Math.abs(e-t):void 0},t.closeTo=function(e,t,i){return null!=e&&null!=t&&Math.abs(e-t)<i},t.trunc=h,t.isToNumber=f,t.toInt=m,t.toFloat=g,t.toGt0=function(e){const t=m(e);return null!=t&&t>0?t:void 0},t.gt0=v,t.gtOrElse=function(e,t){return l(e)&&l(t)&&e>t?e:void 0},t.gte0=function(e){return l(e)&&e>=0},t.mapInt=y,t.mapFloat=function(e,t){return o.Opt(e).flatMap(e=>g(e)).flatMap(t).get()},t.id=function(e){const t=m(e);return v(t)?String(t):void 0},t.mapIntOr=function(e,t,i){return r.orElse(y(e,t),i)},t.mapNumeric=b,t.map2Numeric=function(e,t,i){return b(e,e=>b(t,t=>i(e,t)))},t.mapNumericOr=function(e,t,i){return l(e)?t(e):i},t.numericOr=function(e,t){return l(e)?e:a.tot(t)},t.round=w,t.toPrecisionMaybe=function(e,t){return c(e,e=>S(e,t))},t.toFixed=function(e,t){try{return b(e,e=>w(e*Math.pow(10,t))/Math.pow(10,t))}catch(e){return}},t.toPrecision=S,t.sigFigs=function(e,t){if(0===e||0===t)return 0;const i=Math.pow(10,t-w(Math.ceil(Math.log10(Math.abs(e)))));return w(e*i)/i},t.base2Ceil=function(e){return Math.pow(2,Math.ceil(Math.log2(e)))},t.base10Ceil=function(e){return Math.pow(10,Math.ceil(Math.log10(e)))},t.clamp=function(e,t,i){if(e>t||!l(e)||!l(t))throw new Error(`invalid clamp(${e}, ${t}, ${i})`);return l(i)?i<e?e:i>t?t:i:w((e+t)/2)},t.times=function(e,t){if(!v(e))return[];const i=Math.round(e);return i<=0?[]:[...Array(i)].map((e,i)=>t(i))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkLogger=t.writeRecentLogEntries=t.setupLogger=t.currentFileLogger=void 0;const n=i(2),r=i(17),s=i(40),o=i(146),a=i(99),u=i(124),l=i(9),c=n.lazy(()=>[o.ConsoleLogger.instance()]);function d(){return c().find(e=>e instanceof u.LogWriter)}t.currentFileLogger=d,t.setupLogger=function(){const e=l.Settings.logDir.valueOrDefault;let t=d();null!=t&&t.logDir.eql(e)||(r.end(t),t=new u.LogWriter(s.BaseFile.for(e)));const i=[t];(l.Settings.logStdout.valueOrDefault||l.Settings.tailLogs.valueOrDefault)&&i.push(o.ConsoleLogger.instance()),c.set(i)},t.writeRecentLogEntries=function(){var e;return null===(e=d())||void 0===e?void 0:e.writeRecentLogEntries()},t.mkLogger=function(e){return new a.ContextualLogger(e,c)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toS=void 0,t.toS=function e(t){return null==t?"":"string"==typeof t?t:Array.isArray(t)?t.map(e).join(","):t.toString()}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sortByAsync=t.thenGreatest=t.untilDefined=t.firstTruePromise=t.firstResolvedDefinedPromise=t.firstDefinedPromise=t.first=t.thenOrElse=t.thenAnd=t.thenMap2Or=t.thenMapOr=t.thenMap2=t.thenNot=t.thenFinally=t.tryAll=t.DefaultTryAllTimeoutMs=t.thenOrTimeout=t.tryAsync=t.partitionAsync=t.asyncFilter=t.tuples=t.asyncFind=t.thenCompact=t.thenFlatten=t.awaitAll=t.allSerial=t.thenDefined=t.rejected=t.resolved=t.resolvedWithin=t.thenMapResolved=t.DefaultMaxConcurrent=void 0;const r=i(1),s=i(4),o=i(34),a=i(0),u=i(5),l=i(38),c=i(18),d=i(25),h=i(12),f=i(22),p=i(16),m=i(24),g=i(207),v=i(43);var y=i(25);function b(e){return n(this,void 0,void 0,(function*(){try{return yield e,!0}catch(e){return!1}}))}function w(e,i,r=t.DefaultMaxConcurrent){return n(this,void 0,void 0,(function*(){return(yield v.withBoundedConcurrency({name:"tuples",laters:e.map((e,t)=>()=>n(this,void 0,void 0,(function*(){return[yield i(e,t),e]}))),maxConcurrent:r})).filter(([e,t])=>null!=e&&null!=t)}))}function S(e,t,i=(()=>{}),r=(()=>{})){return n(this,void 0,void 0,(function*(){let n,s=!1,a=!1;return yield Promise.race([g.asPromise(e).then(e=>a?void 0:(n=e,s=!0,e)),o.unrefDelay(t).then(()=>{s||(a=!0)})]),s?yield r(n):yield i(),n}))}Object.defineProperty(t,"thenMap",{enumerable:!0,get:function(){return y.thenMap}}),Object.defineProperty(t,"until",{enumerable:!0,get:function(){return y.until}}),t.DefaultMaxConcurrent=8,t.thenMapResolved=function(e,t){return n(this,void 0,void 0,(function*(){if(null==e)return Promise.resolve(void 0);try{return d.thenMap(e,t)}catch(e){return}}))},t.resolvedWithin=function(e,t){return Promise.race([e,o.delay(t).then(()=>{})])},t.resolved=b,t.rejected=function(e){return n(this,void 0,void 0,(function*(){return!(yield b(e))}))},t.thenDefined=function(e){return n(this,void 0,void 0,(function*(){return null!=(yield e)}))},t.allSerial=function(e){return n(this,void 0,void 0,(function*(){const t=[];for(const i of r.compact(e))t.push(yield i());return r.compact(t)}))},t.awaitAll=function(e){return n(this,void 0,void 0,(function*(){const t=r.compact(e);r.isNotEmpty(t)&&(yield Promise.all(t))}))},t.thenFlatten=function(e){return n(this,void 0,void 0,(function*(){return null==e?[]:r.flatten(r.compact(yield Promise.all(e)))}))},t.thenCompact=function(e){return n(this,void 0,void 0,(function*(){const t=r.compact(yield e);return r.isEmpty(t)?[]:r.compact(yield Promise.all(t))}))},t.asyncFind=function(e,t){return n(this,void 0,void 0,(function*(){for(const i of e)if(yield t(i))return i}))},t.tuples=w,t.asyncFilter=function(e,i,s=t.DefaultMaxConcurrent){return n(this,void 0,void 0,(function*(){return(yield w(r.compact(e),i,s)).filter(([e])=>e).map(([,e])=>e)}))},t.partitionAsync=function(e,t){return n(this,void 0,void 0,(function*(){const i=yield w(e,t);return[i.filter(([e])=>f.isTrue(e)).map(([,e])=>e),i.filter(([e])=>!f.isTrue(e)).map(([,e])=>e)]}))},t.tryAsync=function(e){return n(this,void 0,void 0,(function*(){try{return yield e()}catch(e){return}}))},t.thenOrTimeout=S,t.DefaultTryAllTimeoutMs=30*s.secondMs,t.tryAll=function(e,i=(e=>console.error(e)),r=t.DefaultTryAllTimeoutMs){return n(this,void 0,void 0,(function*(){for(const t of e)try{yield S(t,r)}catch(e){i(e)}}))},t.thenFinally=function(e,t=(()=>{}),i=(()=>{})){return n(this,void 0,void 0,(function*(){let n,r=null;try{n=yield l.isFunction(e)?e():e}catch(e){r=e;try{yield t(e)}catch(e){}}try{yield i(null!=r?r:n)}catch(e){}if(null!=r)throw r;return n}))},t.thenNot=function(e,t=!0){return n(this,void 0,void 0,(function*(){if(null==e)return t;const i=yield e;return null==i?t:!f.isTrue(i)}))},t.thenMap2=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield e;if(null==n)return;const r=yield t;return null!=r?i(n,r):void 0}))},t.thenMapOr=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield e;if(null==n)return i();const r=yield t(n);return null==r?i():r}))},t.thenMap2Or=function(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=yield e;if(null==n)return r();const s=yield t;if(null==s)return r();const o=yield i(n,s);return null==o?r():o}))},t.thenAnd=function(e,t){return n(this,void 0,void 0,(function*(){return null!=e&&f.isTrue(yield e)?t():void 0}))},t.thenOrElse=function(e,t){return n(this,void 0,void 0,(function*(){return a.orElse(yield e,t)}))},t.first=function(e,t){return n(this,void 0,void 0,(function*(){if(null!=e){let i=-1;for(const n of e){i++;try{if(null==n)continue;const e=yield t(n,i);if(null!=e)return e}catch(e){}}}}))},t.firstDefinedPromise=function(e,t=m.identity){return n(this,void 0,void 0,(function*(){for(const i of e){const e=yield i();if(null!=e){const i=yield t(e);if(null!=i)return i}}}))},t.firstResolvedDefinedPromise=function(e,t){return n(this,void 0,void 0,(function*(){for(const i of e)try{const e=yield i();if(null!=e)return e}catch(e){t(e)}}))},t.firstTruePromise=function(e,...t){return n(this,void 0,void 0,(function*(){for(const i of t)try{const t=yield i();if(null!=t&&!0===(yield e(t)))return t}catch(e){}}))},t.untilDefined=function(e,{timeoutMs:t,timeBetweenMs:i}){return n(this,void 0,void 0,(function*(){const n=p.mapGt0(t,e=>Date.now()+e),r=c.Opt(i).getOrElse(()=>a.orElse(t,3e4)/10),s=u.clamp(50,1e4,r);for(;null==n||Date.now()<n;){const t=yield e();if(null!=t)return t;yield o.delay(s)}}))},t.thenGreatest=function(e,t){return n(this,void 0,void 0,(function*(){return a.map(h.greatestBy(yield w(e,t),e=>e[0]),e=>e[1])}))},t.sortByAsync=function(e,t){return n(this,void 0,void 0,(function*(){return r.sortBy(yield w(e,t),e=>e[0]).map(e=>e[1])}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spawnOptions=t.childEnv=t.psenv=t.settingsForChildProcs=t.persistedLibrarySettings=t.persistedSystemSettings=t.pathWithDefaults=t.withDefaultPaths=t.DefaultPaths=t.envSkipFilters=t.envSkipFiltersKey=t.envSuggestedDirsKey=t.Settings=void 0;const n=i(49),r=i(31),s=i(19),o=i(1),a=i(3),u=i(4),l=i(165),c=i(2),d=i(0),h=i(11),f=i(35),p=i(47),m=i(12),g=i(22),v=i(203),y=i(204),b=i(28),w=i(205),S=i(14),P=i(137),M=i(48),E=i(138);function x(e){const i=(a.blank(e)?"":e).split(r.delimiter);if(S.isWin&&a.blank(s.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return i.push(...t.DefaultPaths),o.uniq(i).filter(a.notBlank).join(r.delimiter)}function _(e){const i={};t.settingsForChildProcs().forEach(e=>e.maybeAddToEnv(i));const n=h.compactValues(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},s.env),{NODE_ENV:b.nodeEnv}),S.isElectron?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}),{PATH:t.pathWithDefaults()}),i),d.orElse(e,{})));return t.Settings.logStdout.deleteFromEnv(n),t.Settings.tailLogs.deleteFromEnv(n),n}t.Settings={libraryPath:new E.MaybeStringSetting({name:"libraryPath",key:"PS_LIBRARY_PATH",alternateKeys:["PS_LIBRARY","PS_LIBRARY_DIR"],category:E.SettingCategories.System,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>b.isTest?"/home/test/Pictures":S.isDocker()?"/ps/library":p.App.getPath("pictures"),defaultValue:()=>S.isDocker()?"/ps/library":void 0,advanced:()=>!1}),pidfile:new E.MaybeStringSetting({name:"pidfile",key:"PIDFILE",category:E.SettingCategories.System,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),cacheDir:new E.StringSetting({name:"cacheDir",key:"PS_CACHE_DIR",category:E.SettingCategories.Logging,description:"Where would you like PhotoStructure's scratch file directory? This should be a fast, local disk with several gigabytes free.",exampleValue:()=>b.isTest?"/tmp/ps_cache_dir":v.cacheDir(),defaultValue:()=>v.cacheDir()}),logLevel:new E.StringSetting({name:"logLevel",key:"PS_LOG_LEVEL",alternateKeys:["PS_LOG","LOG"],category:E.SettingCategories.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc')",defaultValue:()=>b.isProd?"error":"info"}),logDir:new E.StringSetting({name:"logDir",key:"PS_LOG_DIR",category:E.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>y.defaultLogDir(),exampleValue:()=>b.isTest?"/var/log/photostructure":void 0}),logCompression:new E.BooleanSetting({name:"logCompression",key:"PS_LOG_COMPRESS",category:E.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>b.isProd}),logElapsedMs:new E.BooleanSetting({name:"logElapsedMs",key:"PS_LOG_ELAPSED_MS",category:E.SettingCategories.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new E.BooleanSetting({name:"logWebRequests",key:"PS_LOG_WEB_REQUESTS",category:E.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new E.MaybeStringSetting({name:"logWebDir",key:"PS_LOG_WEB_DIR",category:E.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new E.BooleanSetting({name:"logStdout",key:"PS_LOG_STDOUT",alternateKeys:["LOG_STDOUT","PS_STDOUT"],category:E.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new E.BooleanSetting({name:"tailLogs",key:"PS_TAIL_LOGS",category:E.SettingCategories.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new E.BooleanSetting({name:"logColor",key:"PS_LOG_COLOR",category:E.SettingCategories.Logging,description:"Output all logs with terminal escape codes to colorize output.",defaultValue:!0}),maxBusyDbMs:new E.IntegerSetting({name:"maxBusyDbMs",key:"PS_MAX_BUSY_DB_MS",category:E.SettingCategories.System,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 1 minute, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>u.minuteMs}),dbTimeoutMs:new E.IntegerSetting({name:"dbTimeoutMs",key:"PS_DB_TIMEOUT_MS",category:E.SettingCategories.System,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Setting this too low will cause all database queries to fail.",defaultValue:()=>500}),probationMs:new E.IntegerSetting({name:"probationMs",key:"PS_PROBATION_MS",category:E.SettingCategories.System,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*u.minuteMs}),minTimeBetweenServiceRestartsMs:new E.IntegerSetting({name:"minTimeBetweenServiceRestartsMs",key:"PS_MIN_TIME_BETWEEN_SERVICE_RESTARTS_MS",category:E.SettingCategories.System,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*u.secondMs}),fatalErrorRatePerMinute:new E.IntegerSetting({name:"fatalErrorRatePerMinute",key:"PS_FATAL_ERROR_RATE_PER_MINUTE",category:E.SettingCategories.System,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),autoLaunch:new E.BooleanSetting({name:"autoLaunch",key:"PS_AUTO_LAUNCH",category:E.SettingCategories.System,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!S.isElectron}),minDiskFreeGb:new E.IntegerSetting({name:"minDiskFreeGb",key:"PS_MIN_DISK_FREE_GB",category:E.SettingCategories.System,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new E.BoundedIntegerSetting({name:"cpuLoadPercent",key:"PS_CPU_LOAD_PERCENT",category:E.SettingCategories.System,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new E.StringEnumSetting({name:"processPriority",key:"PS_PROCESS_PRIORITY",category:E.SettingCategories.System,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>P.PriorityClasses.BelowNormal,validValues:P.PriorityClasses.values}),maxMemoryMb:new E.BoundedIntegerSetting({name:"maxMemoryMb",key:"PS_MAX_MEMORY_MB",category:E.SettingCategories.System,description:"PhotoStructure will restart services if their process consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:512,max:8e3}),pollIntervalMs:new E.IntegerSetting({name:"pollIntervalMs",key:"PS_POLL_INTERVAL_MS",category:E.SettingCategories.System,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>b.isProd?u.minuteMs:5*u.secondMs}),copyAssetsToLibrary:new E.BooleanSetting({name:"copyAssetsToLibrary",key:"PS_COPY_ASSETS",category:E.SettingCategories.System,description:"Should PhotoStructure copy photos and videos to your PhotoStructure Library?",defaultValue:!0,advanced:()=>!1}),scanAllDrives:new E.BooleanSetting({name:"scanAllDrives",key:"PS_SCAN_ALL_DRIVES",category:E.SettingCategories.System,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new E.BooleanSetting({name:"scanMyPictures",key:"PS_SCAN_MY_PICTURES",category:E.SettingCategories.System,description:"Should PhotoStructure only scan your system's 'Pictures' folder for photos and videos?",defaultValue:!1,advanced:()=>!1}),scanPaths:new E.StringArraySetting({name:"scanPaths",key:"PS_SCAN_PATHS",category:E.SettingCategories.System,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`',advanced:()=>!1,exampleValue:()=>b.isTest?["/path/one","/path/two"]:[p.App.getPath("pictures")]}),neverIgnored:new E.StringArraySetting({name:"neverIgnored",key:"PS_NEVER_IGNORED",category:E.SettingCategories.System,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),forceLocalDbReplica:new E.BooleanSetting({name:"forceLocalDbReplica",key:"PS_FORCE_LOCAL_DB_REPLICA",category:E.SettingCategories.System,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:!1}),dbBackupsCount:new E.IntegerSetting({name:"dbBackupsCount",key:"PS_DB_BACKUPS_COUNT",category:E.SettingCategories.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",defaultValue:20}),dbBackupIntervalMinutes:new E.BoundedFloatSetting({name:"dbBackupIntervalMinutes",key:"PS_DB_BACKUP_INTERVAL_MINUTES",category:E.SettingCategories.Db,description:"How many minutes should elapse between backing of your library database? Note that PhotoStructure vacuums and optimizes the database before a backup is taken. You want this period to be frequent enough such that data loss isn't too painful. Note that backups can cause the webserver to be momentarily unresponsive. Default is every hour.",min:b.isTest?.5:1,max:720,defaultValue:()=>b.isTest?.5:60}),dbCacheSizeMb:new E.IntegerSetting({name:"dbCacheSizeMb",key:"PS_DB_CACHE_SIZE_MB",category:E.SettingCategories.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:128}),ffmpegPath:new E.StringSetting({name:"ffmpegPath",key:"PS_FFMPEG_PATH",category:E.SettingCategories.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc.',defaultValue:"ffmpeg"}),vlcPath:new E.StringSetting({name:"vlcPath",key:"PS_VLC_PATH",category:E.SettingCategories.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),updateChannel:new E.StringEnumSetting({name:"updateChannel",key:"PS_UPDATE_CHANNEL",category:E.SettingCategories.Updates,description:'TL:DR; keep this on "latest." This controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds will not have been thoroughly tested. Please only consider changing this if customer support asks you to.',defaultValue:()=>w.channel(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new E.BooleanSetting({name:"updateOnLaunch",key:"PS_UPDATE_ON_LAUNCH",category:E.SettingCategories.Updates,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new E.IntegerSetting({name:"updateCheckMinutes",key:"PS_UPDATE_CHECK_MINUTES",category:E.SettingCategories.Updates,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:1440}),bounceMinutes:new E.IntegerSetting({name:"bounceMinutes",key:"PS_BOUNCE_MINUTES",category:E.SettingCategories.Updates,description:"PhotoStructure will bounce the web and sync processes periodically. The default is every 5 hours. Set to -1 to disable.",defaultValue:300}),email:new E.MaybeStringSetting({name:"email",key:"PS_EMAIL",category:E.SettingCategories.Reporting,description:"If set, this email will be added to error reports, so we can contact you to help debug the issue. It is not required.",exampleValue:()=>"email@example.com",advanced:()=>!1}),chatWidget:new E.BooleanSetting({name:"chatWidget",key:"PS_CHAT_WIDGET",category:E.SettingCategories.Reporting,description:"If you want to disable the chat widget on the about page for privacy concerns, set this to false. Defaults to true (enabled).",defaultValue:!0,advanced:()=>!1}),reportErrors:new E.BooleanSetting({name:"reportErrors",key:"PS_REPORT_ERRORS",category:E.SettingCategories.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new E.IntegerSetting({name:"maxErrorsPerDay",key:"PS_MAX_ERRORS_PER_DAY",category:E.SettingCategories.Reporting,description:"Set this to zero to remove all bugs in PhotoStructure.\n\nHUR HUR #DADJOKE\n\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3}),inspect:new E.BooleanSetting({name:"inspect",key:"PS_INSPECT",category:E.SettingCategories.System,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,advanced:()=>!0}),rpcPort:new E.IntegerSetting({name:"rpcPort",key:"PS_RPC_PORT",category:E.SettingCategories.Web,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),httpPort:new E.IntegerSetting({name:"httpPort",key:"PS_HTTP_PORT",category:E.SettingCategories.Web,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),sessionTimeoutHours:new E.BoundedIntegerSetting({name:"sessionTimeoutHours",key:"PS_SESSION_TIMEOUT_HOURS",category:E.SettingCategories.Web,description:"How long should unused HTTP sessions exist before requiring visitors to log back in? This defaults to 180 days, just to maximize convenience.",defaultValue:4320,max:8760,min:1}),exposeNetworkWithoutAuth:new E.BooleanSetting({name:"exposeNetworkWithoutAuth",key:"PS_EXPOSE_NETWORK_WITHOUT_AUTH",category:E.SettingCategories.Web,description:"Normally the web service is bound to loopback, so your PhotoStructure library is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network (if they know your PhotoStructure port). You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n\n**Don't enable this unless you know what you are doing.**",defaultValue:()=>S.isDocker()}),verifyFileCopies:new E.BooleanSetting({name:"verifyFileCopies",key:"PS_VERIFY_FILE_COPIES",category:E.SettingCategories.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new E.StringSetting({name:"assetSubdirectoryDatestampFormat",key:"PS_ASSET_SUBDIR_FORMAT",category:E.SettingCategories.Sync,description:"If you chose to copy assets into your library, they will be copied into <library directory>/<result of this pattern>/<original imagename>.\nSee <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.",defaultValue:"y/y-MM-dd"}),validateJpegImages:new E.BooleanSetting({name:"validateJpegImages",key:"PS_VALIDATE_JPEG_IMAGES",category:E.SettingCategories.Sync,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1}),validateRawImages:new E.BooleanSetting({name:"validateRawImages",key:"PS_VALIDATE_RAW_IMAGES",category:E.SettingCategories.Sync,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1}),validateVideos:new E.BooleanSetting({name:"validateVideos",key:"PS_VALIDATE_VIDEOS",category:E.SettingCategories.Sync,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!b.isTest,advanced:()=>!1}),transcodeVideos:new E.BooleanSetting({name:"transcodeVideos",key:"PS_TRANSCODE_VIDEOS",category:E.SettingCategories.Sync,description:"Should videos be transcoded during import? FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),doNotTranscodeMimetypes:new E.StringArraySetting({name:"doNotTranscodeMimetypes",key:"PS_DO_NOT_TRANSCODE_MIMETYPES",category:E.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "[\'video/quicktime\',\'video/mp4\']").',defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),statTimeoutSeconds:new E.BoundedIntegerSetting({name:"statTimeoutSeconds",key:"PS_STAT_TIMEOUT_SECONDS",category:E.SettingCategories.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new E.BooleanSetting({name:"startPaused",key:"PS_START_PAUSED",category:E.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray menu.",defaultValue:!1}),syncIntervalHours:new E.BoundedIntegerSetting({name:"syncIntervalHours",key:"PS_SYNC_INTERVAL_HOURS",category:E.SettingCategories.Sync,description:"This value controls both how often the sync process runs, and how often new files are discovered and imported. WARNING: Setting this value to a small value (say, less than 10) will mean PhotoStructure is constantly scanning your disks, which may reduce the lifespan of your storage media. Note that setting this and fileSyncIntervalHours to 0 will disable automatic scheduling of the sync process. This defaults to every day (to balance picking up new files automatically and trying to avoid unnecessary wear and tear on your storage media).",defaultValue:24,max:504,min:0}),fileSyncIntervalHours:new E.BoundedIntegerSetting({name:"fileSyncIntervalHours",key:"PS_FILE_SYNC_INTERVAL_HOURS",category:E.SettingCategories.Sync,description:"This value controls how often the files in your library are checked for changes. The `syncIntervalHours` setting, in contrast, controls how often *new* files are discovered. This defaults to every week (to try to balance picking up changes with wear and tear on your storage media)",defaultValue:168,max:1344,min:0}),rebuild:new E.BooleanSetting({name:"rebuild",key:"PS_REBUILD",category:E.SettingCategories.Sync,description:"When set, all files in your library will be re-imported (slow!)",defaultValue:!1,transient:!0}),forceSync:new E.BooleanSetting({name:"forceSync",key:"PS_FORCE_SYNC",category:E.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem",defaultValue:!1,transient:!0}),exitWhenDone:new E.BooleanSetting({name:"exitWhenDone",key:"PS_EXIT_WHEN_DONE",category:E.SettingCategories.Sync,description:"When set, the process will exit after jobs are completed",defaultValue:!1,transient:!0}),defaultSidecarType:new E.StringEnumSetting({name:"defaultSidecarType",key:"PS_DEFAULT_SIDECAR_TYPE",category:E.SettingCategories.Sync,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:M.SidecarExtsEnum.values}),writeMetadataToSidecarsIfImage:new E.BooleanSetting({name:"writeMetadataToSidecarsIfImage",key:"PS_WRITE_METADATA_TO_SIDECARS_IF_IMAGE",category:E.SettingCategories.Sync,description:"For non-video files, should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original?",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new E.BooleanSetting({name:"writeMetadataToSidecarsIfVideo",key:"PS_WRITE_METADATA_TO_SIDECARS_IF_VIDEO",category:E.SettingCategories.Sync,description:"For video files, should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original? This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new E.BooleanSetting({name:"overwriteOriginal",key:"PS_OVERWRITE_ORIGINAL",category:E.SettingCategories.Sync,description:"Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents.",defaultValue:!1}),useImageHashes:new E.BooleanSetting({name:"useImageHashes",key:"PS_USE_IMAGE_HASHES",category:E.SettingCategories.Sync,description:"Should image hashes be computed? This slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing",defaultValue:!0}),minImageCorrPct:new E.BoundedIntegerSetting({name:"minImageCorrPct",key:"PS_MIN_IMAGE_CORR_PCT",category:E.SettingCategories.Sync,description:"This is the minimum image hash correlation value for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 60% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>b.isTest?80:75,max:100,min:0}),minColorCorrPct:new E.BoundedIntegerSetting({name:"minColorCorrPct",key:"PS_MIN_COLOR_CORR_PCT",category:E.SettingCategories.Sync,description:"This is the minimum correlation found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 40% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>50,max:100,min:0}),skipAssetFileUpdates:new E.BooleanSetting({name:"skipAssetFileUpdates",key:"PS_SKIP_ASSET_FILE_UPDATES",category:E.SettingCategories.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests)",defaultValue:!1,transient:!0}),skipAssetUpdates:new E.BooleanSetting({name:"skipAssetUpdates",key:"PS_SKIP_ASSET_UPDATES",category:E.SettingCategories.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests)",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new E.BooleanSetting({name:"resyncAssetOnVisit",key:"PS_RESYNC_ASSET_ON_VISIT",category:E.SettingCategories.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>!!b.isTest||n.cpus().length>=8}),squareThumbStrategy:new E.StringEnumSetting({name:"squareThumbStrategy",key:"PS_SQUARE_THUMB_STRATEGY",category:E.SettingCategories.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new E.FloatSetting({name:"videoFrameAtSec",key:"PS_VIDEO_FRAME_AT_SEC",category:E.SettingCategories.Previews,description:"When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.\nNote that if a video is shorter than this value, the frame will be captured from the middle of the video.",defaultValue:1.5}),sharpen:new E.BooleanSetting({name:"sharpen",key:"PS_SHARPEN",category:E.SettingCategories.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new E.BooleanSetting({name:"progressive",key:"PS_PROGRESSIVE",category:E.SettingCategories.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new E.StringEnumsSetting({name:"previewResolutions",key:"PS_PREVIEW_RESOLUTIONS",category:E.SettingCategories.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:m.diff(l.FitSizeValues,["uhd8k","uhd5k","qqvga"]),validValues:l.FitSizeValues}),useEmbeddedPreviews:new E.BooleanSetting({name:"useEmbeddedPreviews",key:"PS_USE_EMBEDDED_PREVIEWS",category:E.SettingCategories.Previews,description:"Should embedded image previews be used when available? This speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.",defaultValue:!0}),useEmbeddedThumbnails:new E.BooleanSetting({name:"useEmbeddedThumbnails",key:"PS_USE_EMBEDDED_THUMBNAILS",category:E.SettingCategories.Previews,description:"Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.",defaultValue:!0}),requireMakeModel:new E.BooleanSetting({name:"requireMakeModel",key:"PS_REQUIRE_MAKE_MODEL",category:E.SettingCategories.Filters,description:"Normally PhotoStructure requires images to have an EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!0}),minImageDimension:new E.IntegerSetting({name:"minImageDimension",key:"PS_MIN_IMAGE_DIMENSION",category:E.SettingCategories.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new E.IntegerSetting({name:"minVideoDimension",key:"PS_MIN_VIDEO_DIMENSION",category:E.SettingCategories.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minAssetSizeBytes:new E.IntegerSetting({name:"minAssetSizeBytes",key:"PS_MIN_ASSET_SIZE_BYTES",alternateKeys:["PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:E.SettingCategories.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*f.KB}),maxFileSizeBytes:new E.IntegerSetting({name:"maxFileSizeBytes",key:"PS_MAX_ASSET_SIZE",category:E.SettingCategories.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library)",defaultValue:.5*f.GB}),tagCamera:new E.BooleanSetting({name:"tagCamera",key:"PS_TAG_CAMERA",category:E.SettingCategories.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new E.BooleanSetting({name:"tagLens",key:"PS_TAG_LENS",category:E.SettingCategories.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagDate:new E.StringEnumSetting({name:"tagDate",key:"PS_TAG_YMD",category:E.SettingCategories.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["","y","ym","ymd"]}),tagKeywordsFromPath:new E.BooleanSetting({name:"tagKeywordsFromPath",key:"PS_TAG_KEYWORDS_FROM_PATH",category:E.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new E.BooleanSetting({name:"tagKeywordsFromMetadata",key:"PS_TAG_KEYWORDS_FROM_METADATA",category:E.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new E.StringSetting({name:"keywordDelimiters",key:"PS_KEYWORD_DELIMITERS",category:E.SettingCategories.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be\n    interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new E.StringSetting({name:"keywordPathSeparators",key:"PS_KEYWORD_PATH_SEPARATORS",category:E.SettingCategories.Tagging,description:'PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "ObjectsâToolsâHammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don\'t want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.',defaultValue:"/|>â»â"}),tagType:new E.BooleanSetting({name:"tagType",key:"PS_TAG_TYPE",category:E.SettingCategories.Tagging,description:'Should assets be tagged with their filetype (like "Type/Image/JPEG")?',defaultValue:!0})},t.envSuggestedDirsKey="SUGGESTED_DIRS",t.envSkipFiltersKey="PS_SKIP_FILTERS",t.envSkipFilters=g.isTrue(s.env[t.envSkipFiltersKey]),t.DefaultPaths=Object.freeze(S.isWin?[s.env.SYSTEMROOT,r.join(s.env.SYSTEMROOT,"System32"),r.join(s.env.SYSTEMROOT,"System32","webm")]:["/usr/local/sbin","/usr/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),t.withDefaultPaths=x,t.pathWithDefaults=c.lazy(()=>x(s.env.PATH)),t.persistedSystemSettings=c.lazy(()=>h.values(t.Settings).filter(e=>!e.transient&&E.SystemCategories.includes(e.category))),t.persistedLibrarySettings=c.lazy(()=>h.values(t.Settings).filter(e=>!e.transient&&E.LibraryCategories.includes(e.category))),t.settingsForChildProcs=c.lazy(()=>h.values(t.Settings).filter(e=>e.hasValue())),t.psenv=function(){const e=h.values(t.Settings).map(e=>e.key);return h.sortedKeys(h.filter(s.env,t=>"nodeEnv"===t||e.includes(t)))},t.childEnv=_,t.spawnOptions=function(e){const t=d.orElse(e,{});return Object.assign(Object.assign({},t),{env:_(t.env),detached:!1,shell:!1})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stripEmoji=t.stripDiacritics=t.sortNatural=t.sortNaturalBy=t.joinEng=t.zipStrings=t.escapeRegExp=t.wbrPath=t.stripQuotes=t.dumbquote=t.stripAnsiEsc=t.longestPrefix=t.sortChars=t.localeSort=t.reverse=t.includesIgnoreCase=t.startsWithIgnoreCase=t.equalsIgnoreCase=t.capitalize=t.gist=t.ellipsize=t.stripPreSuff=t.stripSuffix=t.stripPrefixIgnoreCase=t.stripPrefix=t.removeCapture=t.splitWith=t.splitKeep=t.splitEvery=t.splitFirst=t.trim=t.mapParse=t.maybeToS=t.replaceAll=t.count=t.contains=t.padReplace=t.pad2=t.rightPad=t.leftPad=t.padding=t.isString=void 0;const n=i(1),r=i(3),s=i(0),o=i(5),a=i(7),u=i(12),l=i(202);var c=i(97);Object.defineProperty(t,"ensurePrefix",{enumerable:!0,get:function(){return c.ensurePrefix}}),Object.defineProperty(t,"ensureSuffix",{enumerable:!0,get:function(){return c.ensureSuffix}}),Object.defineProperty(t,"newlineRe",{enumerable:!0,get:function(){return c.newlineRe}}),Object.defineProperty(t,"wrap",{enumerable:!0,get:function(){return c.wrap}}),t.isString=function(e){return"string"==typeof e};const d={};function h(e,t){if(t<1)return"";for(null==d[e]&&(d[e]=e);t>d[e].length;)d[e]+=e;return d[e].substring(0,t)}function f(e,t,i){if(0===i.length)throw new Error("leftPad() given empty pad");if("number"==typeof e&&e<0)return"-"+f(String(-e),t-1,i);const n=String(e);return h(i,t-n.length)+n}function p(e,t){const i=[];let n,r=0;for(;null!=(n=t.exec(e));)n.index===t.lastIndex?t.lastIndex++:(i.push(e.substring(r,n.index)),i.push(n[0]),r=t.lastIndex=n[0].length+n.index);return r<e.length&&i.push(e.substring(r)),i}function m(e){return e.sort((e,t)=>e.valueOf().localeCompare(t.valueOf()))}t.padding=h,t.leftPad=f,t.rightPad=function(e,t,i){if(0===i.length)throw new Error("rightPad() given empty pad");const n=String(e);return n+h(i,t-n.length)},t.pad2=function(e){return f(e,2,"0")},t.padReplace=function(e,t,i,n){return e.substr(0,t)+h(n,i)+e.substr(t+i)},t.contains=function(e,t,i){return a.toS(e).indexOf(a.toS(t),i)>-1},t.count=function e(t,i,n=0){if(null==i||0===i.length)return 0;const r=t.indexOf(i,n);return-1===r?0:1+e(t,i,r+i.length)},t.replaceAll=function(e,t,i){return e.split(t).join(i)},t.maybeToS=function(e){return null==e?void 0:String(e)},t.mapParse=function(e,t){if(r.notBlank(e))try{return t(JSON.parse(e))}catch(e){}},t.trim=function(e){return e.map(a.toS).filter(e=>r.notBlank(e))},t.splitFirst=function(e,t){const i=e.indexOf(t);return-1===i?[e]:[e.slice(0,i),e.slice(i+t.length)]},t.splitEvery=function(e,t,i){const n=Math.min(Math.ceil(e.length/t),s.orElse(i,()=>e.length))-1;return n<=0?[e]:[...o.times(n,i=>e.slice(i*t,(i+1)*t)),e.slice(n*t)]},t.splitKeep=function(e,t,i=!0){const n=[];let r,s=0;for(;null!=(r=t.exec(e));)if(r.index===t.lastIndex)t.lastIndex++;else{t.lastIndex=r[0].length+r.index;const o=i?r.index:t.lastIndex;n.push(e.substring(s,o)),s=o}return s<e.length&&n.push(e.substring(s)),n},t.splitWith=p,t.removeCapture=function(e,t){const i=t.exec(e);if(null==i||null==i[1])return e;const n=i.index+i[0].length,r=n-i[1].length;return e.substr(0,r)+e.substr(n)},t.stripPrefix=function(e,t){const i=a.toS(e),n=a.toS(t);return n.length>0&&i.startsWith(n)?i.slice(n.length):i},t.stripPrefixIgnoreCase=function(e,t){const i=a.toS(e),n=a.toS(t);return n.length>0&&i.toLowerCase().startsWith(n.toLowerCase())?i.slice(n.length):i},t.stripSuffix=function(e,t){const i=a.toS(e),n=a.toS(t);return n.length>0&&i.endsWith(n)?i.slice(0,-n.length):i},t.stripPreSuff=function(e,t,i){return(e=a.toS(e)).endsWith(i)&&e.startsWith(t)?e.slice(t.length,-i.length):e},t.ellipsize=function(e,t=80){if(null==e)return"";const i=a.toS(e);return i.length<=t?i:i.slice(0,t-1)+"â¦"},t.gist=function(e,t=80,i=80){const n=a.toS(e),r=n.length-(t+i);return r<=0?n:n.slice(0,t).trim()+" â¦(+"+r+" chars)â¦"+n.slice(-i).trim()},t.capitalize=function(e){const t=(e=a.toS(e)).normalize().split("");return r.blank(e)?e:t[0].toLocaleUpperCase()+t.slice(1).join("")},t.equalsIgnoreCase=function(e,t){return null!=e&&null!=t&&a.toS(e).toLowerCase()===a.toS(t).toLowerCase()},t.startsWithIgnoreCase=function(e,t){return null!=e&&null!=t&&e.toLowerCase().normalize().startsWith(t.toLowerCase().normalize())},t.includesIgnoreCase=function(e,t){const i=a.toS(t).trim().toLowerCase().normalize();return!n.isEmpty(e)&&0!==i.length&&e.map(e=>a.toS(e).trim().toLowerCase().normalize()).filter(r.notBlank).some(e=>i.includes(e))},t.reverse=function(e){return null==e?e:e.split("").reverse().join("")},t.localeSort=m,t.sortChars=function(e){return m(e.split("")).join("")},t.longestPrefix=function(e,t){return u.greatestBy(t.filter(t=>e.startsWith(t)),e=>e.length)},t.stripAnsiEsc=function(e){return a.toS(e).replace(/\u001b\[[0-9;]+[a-z]/gi,"")};const g=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function v(e){return g.reduce((e,[t,i])=>e.replace(t,i),e).normalize()}t.dumbquote=v;const y=/^(['"]).+\1$/;function b(e,t=!0){return n.flatten(p(t?a.toS(e).toLowerCase():a.toS(e),/\S*\d*\S*/g).map(e=>p(e,/\d+/g))).filter(e=>null!=e&&e.length>0).map(e=>s.orElse(o.toInt(e),()=>e))}t.stripQuotes=function(e){return r.blank(e)||(e=a.toS(e).trim(),null!=y.exec(v(e))&&(e=e.slice(1,-1).trim())),e},t.wbrPath=function(e){return e.split(/(?<=[\\/_,:=-]+)/).map(e=>l.escape(e.normalize())).join("<wbr>")},t.escapeRegExp=function(e){return a.toS(e).replace(/[?.()[\]{}*^+|$]/g,"\\$&")},t.zipStrings=function(...e){let t="";const i=n.compactBlanks(e),r=Math.max(...i.map(e=>e.length));for(let e=0;e<r;e++)for(let n=0;n<i.length;n++)s.map(i[n],i=>s.map(i[e],e=>t+=e));return t},t.joinEng=function(e){return(e=n.compactBlanks(e)).length<2?e.join(""):e.slice(0,-1).join(", ")+" or "+e[e.length-1]},t.sortNaturalBy=b,t.sortNatural=function(e,t){return n.sortBy(e,e=>b(e,t))},t.stripDiacritics=function(e){return a.toS(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"")},t.stripEmoji=function(e){return a.toS(e).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstValueCaseInsensitive=t.maybeCall=t.allKeys=t.filter=t.sortedKeys=t.onlyReqValued=t.mapReqValued=t.reqValuedOrElse=t.isReqValued=t.without=t.pickFirst=t.pick=t.mapFields=t.compactValues=t.fromEntries=t.entries=t.values=t.emptyObj=t.keys=t.tap=void 0;const n=i(1),r=i(3),s=i(0),o=i(38),a=i(20);function u(e,t){return null!=t?t(e):"string"==typeof e?console.log(e):console.dir(e,{depth:3}),e}function l(e){return null==e||"object"!=typeof e?[]:Object.keys(e).filter(t=>"string"==typeof t&&(null==e.propertyIsEnumerable||!0===e.propertyIsEnumerable(t)))}function c(e){return l(e).map(t=>e[t])}function d(e){return l(e).map(t=>[t,e[t]])}function h(e,t={}){return"object"!=typeof t&&(t={}),n.compact(e).reduce((e,[t,i])=>u(e,()=>{null!=t&&null!=i&&(e[t]=i)}),t)}function f(e){return c(e).every(e=>null!=e)}t.tap=u,t.keys=l,t.emptyObj=function(e){return n.isEmpty(l(e))},t.values=c,t.entries=d,t.fromEntries=h,t.compactValues=function(e){if(null==e)return;const t=d(e).filter(([e,t])=>null!=e&&null!=t);return n.isEmpty(t)?void 0:h(t)},t.mapFields=function(e,t,i={}){return h(n.compact(d(e).sort(([e])=>e).map(([e,i])=>t(e,i))).filter(([e,t])=>null!=e&&null!=t),i)},t.pick=function(e,...t){if(null==e)return e;if(!t.every(e=>"string"==typeof e))throw new Error("bad keys: "+a.stringify(t));return n.isEmpty(t)?{}:t.reduce((t,i)=>u(t,()=>s.map(e[i],e=>t[i]=e)),{})},t.pickFirst=function(e,t,i=s.defined){if(null!=e)for(const n of t)if(i(e[n]))return e[n]},t.without=function(e,...t){if(null==e||t.every(t=>r.blank(e[t])))return e;const i=d(e).filter(([e])=>!t.includes(e));return n.isEmpty(i)?void 0:h(i)},t.isReqValued=f,t.reqValuedOrElse=function(e){return f(e)?e:void 0},t.mapReqValued=function(e,t){return f(e)?t(e):void 0},t.onlyReqValued=function(e){return e.filter(f)},t.sortedKeys=function(e){return h(n.sortBy(d(e),([e])=>e))},t.filter=function(e,t){return null==e?e:h(d(e).filter(([e,i])=>t(e,i)))},t.allKeys=function(e){const t=l(e);for(;null!=(e=Reflect.getPrototypeOf(e));)t.push(...Reflect.ownKeys(e).filter(e=>"string"==typeof e));return n.uniq(t)},t.maybeCall=function(e,t,...i){return null!=e&&o.isFunction(e[t])?e[t].bind(e)(...i):void 0},t.firstValueCaseInsensitive=function(e,t){if(r.blank(t))return;if(null!=e[t])return e[t];const i=t.toLocaleLowerCase().normalize();for(const t of l(e))if(i===t.toLocaleLowerCase().normalize()&&null!=e[t])return e[t]}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.firstIndexNearest=t.everyAsync=t.someAsync=t.clusterAsync=t.clusterStrictAsync=t.contextFilter=t.batches=t.reverse=t.combinations=t.greatestBy=t.leastBy=t.greatestIndexBy=t.leastIndexBy=t.greatestIndex=t.max=t.leastIndex=t.min=t.ancestry=t.unzip=t.flatZip=t.zip=t.contextAround=t.retainFirstN=t.retainLastN=t.flatMap=t.toMapEntries=t.mapCompact=t.uniqCount=t.partition=t.uniqInPlace=t.removeFirst=t.eqlContents=t.diceCoeff=t.intersection=t.diff=t.moveIndexToEnd=t.moveToEnd=t.remove=t.concat=t.findLast=t.firstNonEmptyThunk=t.firstAsync=t.first=t.anyDefined=t.anyNotDefined=t.allNotBlank=t.allNotDefined=t.mapAll=t.mapAllDefined=t.allDefined=void 0;const r=i(33),s=i(1),o=i(3),a=i(20),u=i(0),l=i(5),c=i(11),d=i(38),h=i(41),f=i(45);function p(e){return u.defined(e)&&e.every(u.defined)}function m(e,...t){const i=e.length;return s.filterInPlace(e,e=>t.every(t=>!f.eql(e,t))),i!==e.length}t.allDefined=p,t.mapAllDefined=function(e,t){return p(e)?t(e):void 0},t.mapAll=function(e,t){return p(e)?t(e):void 0},t.allNotDefined=function(e){return null==e||e.every(e=>null==e)},t.allNotBlank=function(...e){return null!=e&&e.every(o.notBlank)},t.anyNotDefined=function(e){return null==e||e.some(e=>null==e)},t.anyDefined=function(e){return null!=e&&e.some(e=>null!=e)},t.first=function(e,t){if(null!=e)for(const i of s.compact(e)){const e=t(i);if(null!=e)return e}},t.firstAsync=function(e,t){return n(this,void 0,void 0,(function*(){if(null!=e){let i=-1;for(const n of e){i++;try{if(null==n)continue;const e=yield t(n,i);if(null!=e)return e}catch(e){}}}}))},t.firstNonEmptyThunk=function(...e){for(const t of e){const e=t();if(s.isNotEmpty(e))return e}},t.findLast=function(e,t){for(let i=e.length-1;i>=0;i--)if(t(e[i]))return e[i]},t.concat=function(...e){const t=[];for(const i of e)if(Array.isArray(i))for(const e of i)null!=e&&t.push(e);else null!=i&&t.push(i);return t},t.remove=m,t.moveToEnd=function(e,t){return m(e,t),e.push(t),e},t.moveIndexToEnd=function(e,t){const i=e[t];if(null==i)return e;e.push(i);for(let i=t;i<e.length-1;i++)e[i]=e[i+1];return e.length=e.length-1,e};const g=e=>{if(h.isPrimitive(e))return e;if(Array.isArray(e))return a.stringify(e);if(d.isFunction(e.valueOf))return e.valueOf();throw new Error("Cannot get primitive value for "+r.inspect(e))};function v(e,t,i=g){const n=new Set(t.map(i));return e.filter(e=>n.has(i(e)))}function y(...e){const t=Math.max(...e.map(e=>e.length));return l.times(t,t=>e.map(e=>e[t]))}function b(e){return S(e,e=>e.valueOf())}function w(e){return P(e,e=>e.valueOf())}function S(e,t){return M(e,t,(e,t)=>h.lt(e,t))}function P(e,t){return M(e,t,(e,t)=>h.gt(e,t))}function M(e,t,i){const n=e.map((e,i)=>({ea:e,index:i,v:u.map(e,t)})).filter(e=>null!=e&&null!=e.v);if(0===n.length)return-1;let r=0;for(let e=1;e<n.length;e++){const t=n[r].v;!0===i(n[e].v,t)&&(r=e)}return n[r].index}function E(e,t,i=!1){return n(this,void 0,void 0,(function*(){const n=[];e:for(const r of e){for(const e of n)if(i){if(yield _(e,e=>t(r,e))){e.push(r);continue e}}else if(yield x(e,e=>t(r,e))){e.push(r);continue e}n.push([r])}return n}))}function x(e,t){return n(this,void 0,void 0,(function*(){if(null!=e)for(let i=0;i<e.length;i++)if(yield t(e[i],i))return!0;return!1}))}function _(e,t){return n(this,void 0,void 0,(function*(){return s.isEmpty(e)||(yield Promise.all(e.map(t))).every(e=>e)}))}t.diff=function(e,t,i=g){const n=new Set(t.map(i));return e.filter(e=>!n.has(i(e)))},t.intersection=v,t.diceCoeff=function(e,t,i=g){return s.isEmpty(e)&&s.isEmpty(t)?1:2*v(e,t,i).length/(e.length+t.length)},t.eqlContents=function(e,t){return y(s.sort(e),s.sort(t)).every(([e,t])=>e===t)},t.removeFirst=function(e,t){const i=e.findIndex(t);return i>=0?e.splice(i,1)[0]:void 0},t.uniqInPlace=function(e,t=(e=>a.stringify(e))){s.copyArrayTo(s.uniqBy(e,t),e)},t.partition=function(e,t){const i=[],n=[];return e.forEach((e,r)=>(t(e,r)?i:n).push(e)),[i,n]},t.uniqCount=function(e){return function e(t){if(null==t||0===t.length)return[];const i=t[0],n=t.lastIndexOf(i);return[{t:i,count:n+1},...e(t.slice(n+1))]}(e.sort())},t.mapCompact=function(e,t){return s.compact(s.compact(e).map(t))},t.toMapEntries=function(e,t){return new Map(e.map(t).filter(u.defined))},t.flatMap=function(e,t){return e.reduce((e,i)=>e.concat(t(i)),[])},t.retainLastN=function(e,t){return e.length>t&&e.splice(0,e.length-t),e},t.retainFirstN=function(e,t){return e.length=Math.min(e.length,t),e},t.contextAround=function(e,t,i,n){const r=e.findIndex(n);if(-1!==r){return{before:0===r?[]:e.slice(Math.max(0,r-t),r),after:r===e.length-1?[]:e.slice(r+1,Math.min(r+1+i,e.length))}}},t.zip=y,t.flatZip=function(...e){const t=Math.max(...e.map(e=>e.length)),i=[];return l.times(t,t=>e.map(e=>i.push(e[t]))),i},t.unzip=function(e){return[e.map(([e])=>e),e.map(([,e])=>e)]},t.ancestry=function(e){return l.times(e.length,t=>e.slice(0,t+1))},t.min=function(e){return e[b(e)]},t.leastIndex=b,t.max=function(e){return e[w(e)]},t.greatestIndex=w,t.leastIndexBy=S,t.greatestIndexBy=P,t.leastBy=function(e,t){return e[S(e,t)]},t.greatestBy=function(e,t){return e[P(e,t)]},t.combinations=function*e(t,i){if(!(null==t||t.length<i))for(let n=0;n<t.length;n++)if(1===i)yield[t[n]];else for(const r of e(t.slice(n+1),i-1))yield[t[n],...r]},t.reverse=function(e){const t=[];for(let i=e.length-1;i>=0;i--)t.push(e[i]);return t},t.batches=function(e,t){return t<=0&&(t=1),s.stepRange(0,e.length,t,i=>e.slice(i,i+t))},t.contextFilter=function(e,t){let i;return e.filter((e,n)=>c.tap(t(e,n,i),t=>{t&&(i=e)}))},t.clusterStrictAsync=function(e,t){return n(this,void 0,void 0,(function*(){return E(e,t,!0)}))},t.clusterAsync=E,t.someAsync=x,t.everyAsync=_,t.firstIndexNearest=function({arr:e,fromIndex:t,pred:i,maxDelta:n}){for(let r=1;r<Math.min(n+1,e.length);r++){{const n=t-r;if(n>=0&&!0===u.map(e[n],e=>i(e,n)))return n}{const n=t+r;if(n<e.length&&i(e[n],n))return n}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onWriteRecentLogEntries=t.emitWriteRecentLogEntries=t.onVacuuming=t.emitVacuuming=t.onSettingsChanged=t.emitSettingsChanged=t.onVolumesChanged=t.emitVolumesChanged=t.onReadyToUpdate=t.emitReadyToUpdate=t.readyToUpdate=t.onRpcServerChange=t.emitRpcServerChange=t.onNonFatal=t.onFatal=t.onFocus=t.emitFocus=t.onFileChanged=t.emitFileCopied=t.onFileCopied=t.emitFileChanged=t.onResume=t.emitResume=t.onPause=t.emitPause=t.onMigration=t.emitMigration=t.onIdle=t.emitIdle=t.onClearCache=t.emitClearCache=t.useProductionEventEmitter=t.useTestEventEmitter=t.eventEmitter=void 0;const n=i(140),r=i(2),s=i(210),o=r.lazy(()=>new s.TestEventEmitter),a=r.lazy(()=>{const e=new n.EventEmitter;return e.setMaxListeners(50),e});t.eventEmitter=a(),t.useTestEventEmitter=function(){return t.eventEmitter=o()},t.useProductionEventEmitter=function(){return t.eventEmitter=a()},t.emitClearCache=function(){t.eventEmitter.emit("clearCache")},t.onClearCache=function(e){t.eventEmitter.on("clearCache",e)},t.emitIdle=function(){t.eventEmitter.emit("idle")},t.onIdle=function(e){t.eventEmitter.on("idle",e)},t.emitMigration=function(e){t.eventEmitter.emit("migration",e)},t.onMigration=function(e){t.eventEmitter.on("migration",e)},t.emitPause=function(){t.eventEmitter.emit("pause")},t.onPause=function(e){t.eventEmitter.on("pause",e)},t.emitResume=function(){t.eventEmitter.emit("resume")},t.onResume=function(e){t.eventEmitter.on("resume",e)},t.emitFileChanged=function(e){t.eventEmitter.emit("fileChanged",e)},t.onFileCopied=function(e){t.eventEmitter.on("fileCopied",e)},t.emitFileCopied=function(e,i){t.eventEmitter.emit("fileCopied",e,i)},t.onFileChanged=function(e){t.eventEmitter.on("fileChanged",e)},t.emitFocus=function(e,i){t.eventEmitter.emit("focus",e,i)},t.onFocus=function(e){t.eventEmitter.on("focus",e)},t.onFatal=function(e){t.eventEmitter.on("fatal",({message:t,error:i})=>e(t,i))},t.onNonFatal=function(e){t.eventEmitter.on("nonFatal",({message:t,error:i})=>e(t,i))},t.emitRpcServerChange=function(){t.eventEmitter.emit("rpcServerChange")},t.onRpcServerChange=function(e){t.eventEmitter.on("rpcServerChange",e)},t.readyToUpdate=!1,t.emitReadyToUpdate=function(){t.readyToUpdate=!0,t.eventEmitter.emit("readyToUpdate")},t.onReadyToUpdate=function(e){t.eventEmitter.on("readyToUpdate",e)},t.emitVolumesChanged=function(){t.eventEmitter.emit("volumesChanged")},t.onVolumesChanged=function(e){t.eventEmitter.on("volumesChanged",e)},t.emitSettingsChanged=function(){t.eventEmitter.emit("settingsChanged")},t.onSettingsChanged=function(e){t.eventEmitter.on("settingsChanged",e)},t.emitVacuuming=function(){t.eventEmitter.emit("settingsChanged")},t.onVacuuming=function(e){t.eventEmitter.on("vacuuming",e)},t.emitWriteRecentLogEntries=function(){t.eventEmitter.emit("writeRecentLogEntries")},t.onWriteRecentLogEntries=function(e){t.eventEmitter.on("writeRecentLogEntries",e)}},function(e,t,i){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.platformName=t.procDeviceModel=t.isRaspberryPi=t.isDocker=t.isElectron=t.isPosix=t.isLinuxSnap=t.isLinuxAppImage=t.isLinux_arm=t.isArm=t.isLinux_x64=t.isLinux=t.isMac=t.isWinVm=t.isWinPortable=t.isWin=t.isPacked=t.inspectFlag=void 0;const n=i(46),r=i(49),s=i(19),o=i(3),a=i(2),u=i(0),l=i(7),c=i(22),d=r.platform();t.inspectFlag=s.argv.includes("--inspect")||c.isTrue(s.env.NODE_INSPECT),t.isPacked=!l.toS(e).includes("Platform"),t.isWin=d.startsWith("win"),t.isWinPortable=t.isWin&&o.notBlank(s.env.PORTABLE_EXECUTABLE_DIR),t.isWinVm=a.lazy(()=>t.isWin&&n.existsSync("C:\\Program Files\\Oracle\\VirtualBox Guest Additions")),t.isMac="darwin"===d,t.isLinux="linux"===d,t.isLinux_x64=t.isLinux&&"x64"===r.arch(),t.isArm="arm"===r.arch(),t.isLinux_arm=t.isLinux&&t.isArm,t.isLinuxAppImage=t.isLinux&&(o.notBlank(s.env.APPIMAGE)||o.notBlank(s.env.APPDIR)),t.isLinuxSnap=t.isLinux&&o.notBlank(s.env.SNAP_USER_DATA),t.isPosix=t.isMac||t.isLinux,t.isElectron=null!=s.versions.electron||c.isTrue(s.env.PS_IS_ELECTRON),t.isDocker=a.lazy(()=>{if(c.isTrue(s.env.PS_DOCKER))return!0;try{return!t.isElectron&&t.isLinux&&n.readFileSync("/proc/1/cgroup").toString().includes(":/docker/")}catch(e){return!1}}),t.isRaspberryPi=a.lazy(()=>t.isLinux_arm&&l.toS(t.procDeviceModel()).startsWith("Raspberry Pi")),t.procDeviceModel=a.lazy(()=>{try{return t.isLinux?u.map(n.readFileSync("/proc/device-tree/model"),l.toS):void 0}catch(e){return}}),t.platformName=t.isWin?"win":t.isMac?"mac":t.isLinux?"linux":d}).call(this,"/index.js")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toA=void 0;const n=i(90);t.toA=function(e){return null==e?[]:n.isIterable(e)?Array.from(e):Array.isArray(e)?e:[e]}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.valuesToBigInt=t.hammRatioBigInt=t.hammingDistanceBigInt=t.Array2D=t.assertPositive=t.extractInt=t.extractFloat=t.within=t.mapGt0Or=t.mapGt0f=t.mapGt0=t.mapGte0f=t.mapGte0Or=t.mapGte0=t.firstNonZero=t.firstGt0=void 0;const n=i(1),r=i(3),s=i(0),o=i(5),a=i(10);function u(e,t){return o.mapInt(e,e=>e>=0?t(e):void 0)}function l(e,t){return o.mapInt(e,e=>e>0?t(e):void 0)}t.firstGt0=function(...e){return e.find(o.gt0)},t.firstNonZero=function(...e){for(const t of n.flatten(e)){const e=o.toFloat(t);if(null!=e&&0!==e)return e}},t.mapGte0=u,t.mapGte0Or=function(e,t,i){return s.orElse(u(e,t),i)},t.mapGte0f=function(e,t){return o.mapNumeric(e,e=>e>=0?t(e):void 0)},t.mapGt0=l,t.mapGt0f=function(e,t){return o.mapNumeric(e,e=>e>0?t(e):void 0)},t.mapGt0Or=function(e,t,i){return s.orElse(l(e,t),i)},t.within=function(e,t,i){return null!=i&&([e,t]=[Math.min(e,t),Math.max(e,t)],o.gte(i,e)&&o.lte(i,t))};const c=/[+-]?[0-9.]/;function d(e){if(o.isNumber(e))return e;if(r.blank(e))return;const t=String(e);return s.map(c.exec(t),e=>o.toFloat(t.substr(e.index)))}t.extractFloat=d,t.extractInt=function(e){return o.toInt(d(e))},t.assertPositive=function(e,t){if(null==t||t<=0)throw new Error(e+" must be positive")};function h(e,t){if(null==e||null==t)return;const i=[e,t].map(e=>e.toString(2)),n=Math.max(...i.map(e=>e.length));return i.map(e=>a.leftPad(e,n,"0"))}t.Array2D=class{constructor(e){this.columns=e,this.store=[]}get(e,t){return e<0||t<0?0:s.orElse(this.store[e*this.columns+t],()=>0)}set(e,t,i){this.store[e*this.columns+t]=i}},t.hammingDistanceBigInt=function(e,t){return s.map(h(e,t),([e,t])=>n.count(e.split(""),(e,i)=>e!==t.charAt(i)))},t.hammRatioBigInt=function(e,t){return null==e||null==t?0:s.map(h(e,t),([e,t])=>{const i=e.length;return n.count(e.split(""),(e,i)=>e===t.charAt(i))/i})},t.valuesToBigInt=function(e,t){return n.isEmpty(e)?BigInt(0):BigInt("0b0"+e.map(e=>a.leftPad(e.toString(2),t-1,"0")).join(""))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.endEndables=t.end=t.endAll=t.setEnding=t.ending=t.addEndable=t.addLoggerEndable=t.addPostDbEndable=t.addDbEndable=t.addPreDbEndable=t.addServiceEndable=t.addFirstEndable=t.EndableRanks=t.EndableWrapper=void 0;const r=i(1),s=i(4),o=i(2),a=i(0),u=i(36),l=i(74),c=i(6),d=i(100),h=i(28),f=i(16),p=i(24),m=i(8),g=i(63),v=o.lazy(()=>c.mkLogger(l.magenta("Endable")));t.EndableWrapper=class{constructor(e,t,i,n,r){this.name=e,this._isEnded=n,this.endTimeoutMs=r,this.onEnds=[],this._ended=!1,this.logger=c.mkLogger(e),this.onEnds.push(t),w(i,this)}get ended(){return a.mapOr(this._isEnded,e=>e(),()=>!1)||this._ended}end(){if(!this._ended)return this._ended=!0,m.awaitAll(this.onEnds.map(e=>e()))}};const y=new d.MultiMap;g.setUnrefInterval(()=>M(),1*s.minuteMs);const b=5*s.secondMs;function w(e,t){return y.add(e,t),t}t.EndableRanks=u.strEnum("first","service","predb","db","postdb","logger"),t.addFirstEndable=function(e){return w(t.EndableRanks.first,e)},t.addServiceEndable=function(e){return w(t.EndableRanks.service,e)},t.addPreDbEndable=function(e){return w(t.EndableRanks.predb,e)},t.addDbEndable=function(e){return w(t.EndableRanks.db,e)},t.addPostDbEndable=function(e){return w(t.EndableRanks.postdb,e)},t.addLoggerEndable=function(e){return w(t.EndableRanks.logger,e)},t.addEndable=w;let S=!1;function P(e,t){return n(this,void 0,void 0,(function*(){const i=yield e;if(null!=i&&!i.ended)return v().debug(l.magenta(i.name+" ending...")),m.thenOrTimeout(i.end(),f.firstGt0(t,i.endTimeoutMs,b),()=>v().warn(l.magenta(i.name+".end() timed out")),()=>v().debug(l.magenta(i.name+".end() completed"))).catch(e=>{p.Try(()=>v().warn(l.magenta(i.name+".end() rejected: ")+e))})}))}function M(){y.filterInPlace((e,t)=>!t.ended),v().debug("vacuumEndables()",y.entriesArray().map(([e,t])=>[e,t.map(e=>e.name)]))}t.ending=function(){return S},t.setEnding=function(e){if(!h.isTest)throw new Error("cannot set ending");S=e},t.endAll=function(...e){return Promise.all(e.map(e=>P(e)))},t.end=P,t.endEndables=o.lazy(()=>n(void 0,void 0,void 0,(function*(){const e=h.isSingleSpecTests?250:void 0;v().info("endEndables()",{isTest:h.isTest,isSingleSpecTests:h.isSingleSpecTests}),h.isTest||(S=!0),M();for(const i of t.EndableRanks.values){const t=a.orElse(y.get(i),[]);r.isNotEmpty(t)&&(v().debug(l.magenta("endEndables(): ending "+i)),yield Promise.all(t.map(t=>P(t,e))))}})))},function(e,t,i){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.Opt=t.isOpt=t.Some=t.None=void 0,function(e){e.isDefined=!1,e.isEmpty=!0,e.get=()=>{},e.exists=()=>!1;const t=()=>e;e.map=t,e.flatMap=t,e.filter=t,e.forEach=t,e.getOrElse=e=>e(),e.orElse=e=>o(e()),e.zip1=t,e.zip2=t,e.zip3=t}(n||(n={})),t.None=n;class r{constructor(e){this.a=e,this.isDefined=!0,this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new r(e(this.a))}flatMap(e){const t=e(this.a);return s(t)?t:o(t)}filter(e){return o(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,t){return o(e).flatMap(e=>t(this.a,e))}zip2(e,t,i){return o(e).flatMap(e=>o(t).flatMap(t=>i(this.a,e,t)))}zip3(e,t,i,n){return o(e).flatMap(e=>o(t).flatMap(t=>o(i).flatMap(i=>n(this.a,e,t,i))))}}function s(e){return e instanceof r||e===t.None}function o(e){return s(e)?e:null!=e?new r(e):t.None}t.Some=r,t.isOpt=s,t.Opt=o},function(e,t){e.exports=require("process")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringify=void 0;const n=i(0);t.stringify=function(e,t,i,r){return JSON.stringify(e,function(e,t){const i=[],n=[],r=null!=t?t:(e,t)=>i[0]===t?"[Circular ~]":"[Circular ~."+n.slice(0,i.indexOf(t)).join(".")+"]";return function(t,s){if(i.length>0){const e=i.indexOf(this);e>=0?(i.splice(e+1),n.splice(e,1/0,t)):(i.push(this),n.push(t)),i.indexOf(s)>=0&&(s=r.call(this,t,s))}else i.push(s);return null==e?s:e.call(this,t,s)}}(t,r),n.denull(i))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.execStdout=t.stdout=t.stdoutResult=t.execFile=t.spawn=t.niceable=t.endProcess=t.waitForExit=void 0;const r=i(154),s=i(19),o=i(53),a=i(56),u=i(3),l=i(4),c=i(34),d=i(20),h=i(2),f=i(0),p=i(5),m=i(11),g=i(38),v=i(7),y=i(60),b=i(8),w=i(23),S=i(61),P=i(6),M=i(24),E=i(101),x=i(14),_=i(142),T=i(9),D=i(10),O=h.lazy(()=>P.mkLogger("ChildProcess"));function F(e){return m.pick(e,"pid","killed","connected","exitCode","signalCode")}function I(e,t){return b.until(()=>b.thenNot(E.pidExists(e)),t)}function k(e,t=30*l.secondMs){return n(this,void 0,void 0,(function*(){if(null==e)return!1;const i=e.pid;if(O().debug("endProcess("+i+")",{killed:e.killed,connected:e.connected}),!e.killed){if(i<=0)return O().warn("endProcess(): asked to end invalid pid",F(e)),!1;if(i===s.pid)return O().warn("endProcess(): asked to end MY pid",F(e)),!1;M.Try(()=>e.kill())}return yield c.delay(250),yield S.closeStreams(e),e.connected&&M.Try(()=>e.disconnect()),M.Try(()=>e.unref()),(yield I(i,t))?(O().debug("endProcess(): exitted",F(e)),!0):(yield E.kill(i,!0).catch(e=>{O().warn("endProcess(): kill("+i+",true) failed: "+e)}),I(i,5e3))}))}function C(e,t){return"renice"!==e&&"which"!==e&&"where"!==e&&"sqlite3"!==e&&[e,...t].every(e=>!e.endsWith("web.js")&&!e.endsWith("db.js")&&!e.includes("sqlite3"))}function A(e,t,i,r){const a=new Date;let u=!1;e.on("exit",()=>u=!0);const c=C(t,i);return o.setTimeout(()=>n(this,void 0,void 0,(function*(){if(u)return;yield b.until(()=>p.gt0(e.pid),l.secondMs);const i=e.pid;return p.gt0(i)?(c&&(yield _.renice(i)),E.addPid({pid:i,cmd:t,maxAgeMs:r,ppid:s.pid},a)):void O().warn("newProc(): not writing pidfile, child_process has no pid",{cmd:t,cp:F(e)})})),x.isWin?500:250),e}function L(e,t,i,n){const s=T.spawnOptions(n);return A(r.execFile(e,t,s),e,t,i)}function R(e,t,i){return n(this,void 0,void 0,(function*(){return a.retryOnReject(()=>function(e,t,i){var r,s,a;return n(this,void 0,void 0,(function*(){const n=f.orElse(i.quiet,!1),u=f.orElse(i.ignoreStderr,!1),l=f.orElse(i.ignoreExitCode,!1);let c="";O().debug("stdoutResult(): execFile",{cmd:e,args:t});const h=yield L(e,t,i.timeout,m.without(i,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(!0===i.disconnect)return h.disconnect(),{result:"",pid:h.pid};const p=d.stringify({cmd:e,args:t}),b=new y.Deferred(p);o.setTimeout(()=>{b.pending&&O().warn("stdoutResult(): SLOW COMMAND",{cmd:e,args:t})},i.timeout/3).unref(),b.setTimeout(i.timeout);const P=(r,s)=>{w.isIgnorableError(s)||g.isFunction(i.isIgnorableError)&&i.isIgnorableError(s)?O().debug("stdoutResult(): ignorable error for "+r,{cmd:e,args:t,opts:i,error:s}):(null!=h.pid&&k(h),n||O().warn("stdoutResult(): "+r,{cmd:e,args:t,opts:i,error:s}),b.pending&&b.reject(s))};try{h.on("error",e=>P("on(error)",e)),h.on("close",i=>{const r=Date.now()-b.start,s=0!==i?"warn":"debug";n||O().log(s,"stdoutResult(): on(close)",{cmd:e,code:i,args:t,elapsedMs:r,result:D.gist(c,160,160)}),l||0===i?b.resolve({result:c,code:i,pid:h.pid}):b.reject(new Error("non-zero exit code: "+d.stringify({code:i,cmd:e,args:t})))}),S.end(h.stdin),null===(r=h.stdout)||void 0===r||r.on("data",e=>f.map(e,e=>{c+=e.toString()})),null===(s=h.stderr)||void 0===s||s.on("error",e=>P("stderr(error)",e)),null===(a=h.stderr)||void 0===a||a.on("data",e=>u?O().warn("stdoutResult(): stderr(data): "+v.toS(e)):P("stderr(data)",e))}catch(e){P("try/catch",e)}return yield b.promise}))}(e,t,i),{timeoutMs:i.timeout,maxRetries:f.orElse(i.maxRetries,3),onRetryWaitUntil:e=>c.delay(100*e),errorIsRetriable:i=>O().tap({msg:"stdoutResult.errorIsRetriable()",result:w.errorContains(i,/EPERM/),meta:{error:i,cmd:e,args:t}})})}))}t.waitForExit=I,t.endProcess=k,t.niceable=C,t.spawn=function(e,t,i,n){const s=T.spawnOptions(n);return O().debug("spawn()",{command:e,args:t,maxAgeMs:i,opts:s}),A(r.spawn(e,t,s),e,t,i)},t.execFile=L,t.stdoutResult=R,t.stdout=function(e,t,i){return R(e,t,i).then(e=>e.result)},t.execStdout=function(e){return new Promise((t,i)=>{r.exec(e,(e,n,r)=>null!=e?i(e):u.notBlank(r)?i(r):t(n))})}},function(e,t,i){"use strict";function n(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e)return!0;const t=String(e).toLowerCase();return["true","1"].includes(t)}function r(e){if("boolean"==typeof e)return!e;if(null==e)return!1;if(0===e)return!0;const t=String(e).toLowerCase();return["false","0"].includes(t)}Object.defineProperty(t,"__esModule",{value:!0}),t.mapTrue=t.mapBoolean=t.and=t.or=t.isFalse=t.boolToInt=t.toBoolean=t.isTrue=t.isBoolean=void 0,t.isBoolean=function(e){return"boolean"==typeof e},t.isTrue=n,t.toBoolean=function(e){return!!n(e)||!r(e)&&void 0},t.boolToInt=function(e){return n(e)?1:0},t.isFalse=r,t.or=function(e){return e.some(e=>n(e))},t.and=function(e){return e.every(e=>n(e))},t.mapBoolean=function(e,t){return n(e)?t(!0):r(e)?t(!1):void 0},t.mapTrue=function(e,t){return n(e)?t():void 0}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addMessage=t.onError=t.cleanError=t.errorToHumanString=t.trimErrorMessage=t.stack=t.throws=t.isIgnorableError=t.isDoNotSendError=t.isPleaseSendError=t.isRetriableError=t.isFatalErrorAllowed=t.isSqliteDisconnectedError=t.isSqliteBusyError=t.isFatalError=t.FatalErrorRe=t.errorContains=t.isHealthCheckError=t.hasErrorFlag=t.extractErrorFlags=t.removeErrorFlags=t.mapError=t.ifError=t.ErrorFlags=t.RetriableErrorFlag=t.DoNotSendErrorFlag=t.HealthCheckErrorFlag=t.PleaseSendErrorFlag=t.IgnorableErrorFlag=t.NonRetriableErrorFlag=t.FatalErrorFlag=void 0;const n=i(1),r=i(3),s=i(4),o=i(37),a=i(2),u=i(0),l=i(5),c=i(7),d=i(17),h=i(22),f=i(209),p=i(13),m=i(6),g=i(93),v=i(29),y=i(9),b=i(10),w=i(50),S=Date.now(),P=a.lazy(()=>m.mkLogger("Error")),M=new g.Rate(s.minuteMs),E=new g.Rate(s.minuteMs);t.FatalErrorFlag="Â¹",t.NonRetriableErrorFlag="Â²",t.IgnorableErrorFlag="Â³",t.PleaseSendErrorFlag="â´",t.HealthCheckErrorFlag="âµ",t.DoNotSendErrorFlag="â¶",t.RetriableErrorFlag="â·",t.ErrorFlags=[t.FatalErrorFlag,t.NonRetriableErrorFlag,t.IgnorableErrorFlag,t.PleaseSendErrorFlag,t.HealthCheckErrorFlag];const x=/[â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g,_=/[^â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g;function T(e){return e.replace(x,"")}function D(e){return e.replace(_,"")}function O(e){return null!=e&&(!!(e instanceof w.WrappedError&&e.fatal)||null!=t.FatalErrorRe.exec(o.errorToS(e)))}function F(){const e=Date.now()>S+y.Settings.probationMs.valueOrDefault,t=l.lt(E.eventsPerMinute,y.Settings.fatalErrorRatePerMinute.valueOrDefault);return P().tap({level:"info",msg:"isFatalErrorAllowed()",result:v.isMainService()&&e&&t,meta:{mainService:v.isMainService(),postProbation:e,lowErrorRate:t,fatalErrorRatePerMin:E.eventsPerMinute,errorRatePerMin:M.eventsPerMinute,fatalErrorRatePerMinuteSetting:y.Settings.fatalErrorRatePerMinute.valueOrDefault}})}function I(e){return o.errorToS(e).includes(t.PleaseSendErrorFlag)}t.ifError=function(e){return e instanceof Error?e:void 0},t.mapError=function(e,t){return e instanceof Error?t(e):void 0},t.removeErrorFlags=T,t.extractErrorFlags=D,t.hasErrorFlag=function(e){return t.ErrorFlags.some(t=>e.includes(t))},t.isHealthCheckError=function(e){return o.errorToS(e).includes(t.HealthCheckErrorFlag)},t.errorContains=function(e,t){return null!=t.exec(o.errorToS(e))},t.FatalErrorRe=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+t.FatalErrorFlag,"i"),t.isFatalError=O,t.isSqliteBusyError=function(e){return"SQLITE_BUSY"===e.code||o.errorToS(e).toUpperCase().includes("SQLITE_BUSY")},t.isSqliteDisconnectedError=function(e){return o.errorToS(e).toLowerCase().includes("database connection is not open")},t.isFatalErrorAllowed=F,t.isRetriableError=function(e){return!O(e)&&!o.errorToS(e).includes(t.NonRetriableErrorFlag)&&(!(e instanceof w.WrappedError)||e.retriable)},t.isPleaseSendError=I,t.isDoNotSendError=function(e){const i=o.errorToS(e);return i.includes(t.DoNotSendErrorFlag)||C(i)};const k=[t.IgnorableErrorFlag,"Warning:","Can't set headers after they are sent","0 output files created","Missing expected status message","Format error in file","Unexpected error while trimming. Try to lower the tolerance","called while not idle","onExit(exit) called end()","end() called before task completed","BatchCluster has ended, cannot enqueue","diskutil: interrupted","net::ERR_","ECONNRESET","This socket has been ended by the other party","debugger listening on","for help","https://nodejs.org/en/docs/inspector","debugger attached"].map(e=>e.toLowerCase());function C(e){const t=o.errorToS(e).toLowerCase(),i=k.some(e=>t.includes(e));return P().tap({msg:"isIgnorableError",result:d.ending()||!I(e)&&!O(e)&&i,meta:{err:o.errorToS(e),ending:d.ending(),isPleaseSend:I(e),isFatal:O(e),matchesIgnorable:i}})}t.isIgnorableError=C,t.throws=function(e){try{return e(),!1}catch(e){return!0}},t.stack=function e(){const t={};return Error.captureStackTrace(t,e),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)};const A=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function L(e){let t=T(b.stripAnsiEsc(e)),i=t;do{i=t,t=A.reduce((e,t)=>e.replace(t,""),t).trim()}while(i!==t);return n.compactBlanks(t.split(/\s+/).map(e=>{if(e.startsWith("E")){const i=f.describeError(e);return t.toLowerCase().includes(i.toLowerCase())?"":i+":"}return e})).join(" ")}t.trimErrorMessage=L,t.errorToHumanString=function(e,t=200){const i=o.errorToS(e),n=D(i);return b.ellipsize(L(i),t-n.length)+n},t.cleanError=function(e,t){return c.toS(e).split(/\r?\n/).map(e=>b.stripPrefix(e,t)).map(e=>e.replace(/: ?/,"")).filter(r.notBlank).join(", ")},t.onError=function(e,t,i){const n=o.errorToS(e)+o.errorToS(t)+o.errorToS(i),r=O(t)||O(n)||h.isTrue(null==i?void 0:i.fatal);if(!r&&C(n))return void P().info("onError(): ignorable: "+o.errorToS(t),Object.assign({message:e},i));u.map(m.currentFileLogger(),e=>e.writeRecentLogEntries()),M.onEvent(),r&&E.onEvent();const s=!r||F()?"nonFatal":"fatal";P().log("fatal"===s?"error":"warn","onError()",Object.assign({event:s,message:e,error:t},u.orElse(i,{}))),d.ending()||p.eventEmitter.emit(s,{message:e,error:t})},t.addMessage=function(e,t){return r.notBlank(t)&&(e.message.toLowerCase().includes(t.toLowerCase())||(e.message+=": "+t)),e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlSubset=t.mapEntries=t.pickMap=t.assignFields=t.assignMissingPrimitives=t.spread=t.primitiveEntries=t.hasKeys=t.ctor=t.identity=t.tryEach=t.Try=t.mapOrThrow=t.mapAnd=t.ornull=t.firstFieldLike=t.firstDefinedField=t.firstDefined=t.firstTrueThunk=t.firstThunk=t.definedThunks=void 0;const n=i(1),r=i(0),s=i(11),o=i(41),a=i(12),u=i(26),l=i(45);function c(e,t){try{return e()}catch(e){return null!=t?t(e):void 0}}function d(e){return s.keys(e).filter(t=>o.isPrimitive(e[t])||u.isDate(e[t])).map(t=>[t,e[t]])}t.definedThunks=function(...e){return e.every(e=>r.defined(e()))},t.firstThunk=function(...e){for(const t of e){const e=t();if(null!=e)return e}},t.firstTrueThunk=function(e,t){for(const i of e){const e=i();if(null!=e&&(null==t||t(e)))return e}},t.firstDefined=function(...e){return e.find(r.defined)},t.firstDefinedField=function(e,...t){return r.map(t.find(t=>null!=e[t]),t=>e[t])},t.firstFieldLike=function(e,t){return a.first(s.keys(e),i=>t(i,e[i])?e[i]:void 0)},t.ornull=function(e){return void 0===e?null:e},t.mapAnd=function(e,t){return null!=e&&t(e)},t.mapOrThrow=function(e,t,i){if(null!=e)return t(e);throw new Error(i)},t.Try=c,t.tryEach=function(e,t){[...e].forEach(e=>c(()=>t(e)))},t.identity=function(e){return e},t.ctor=function(e){return r.map(e.constructor,e=>e.name)},t.hasKeys=function(e){return Object.keys(e).some(t=>"string"==typeof t&&e.propertyIsEnumerable(t))},t.primitiveEntries=d,t.spread=function(e,...t){return Object.assign({},e,...n.compact(t))},t.assignMissingPrimitives=function(e,t){if(null==t)return e;for(const[i,n]of d(t))null==e[i]&&(e[i]=n);return e},t.assignFields=function(e,t){if(null==t)return e;for(const[i,n]of s.entries(t))null!=n&&(e[i]=n);return e},t.pickMap=function(e,t,i){const n={};for(const r of t)n[r]=i(r,e[r]);return n},t.mapEntries=function(e,t){const i={};for(const n of s.keys(e))r.map(t(n,e[n]),e=>i[n]=e);return i},t.eqlSubset=function(e,t){return null!=e&&s.keys(e).every(i=>l.eql(e[i],t[i]))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.until=t.PromiseStates=t.isPromise=t.thenTap=t.thenCollect=t.thenMap=void 0;const r=i(4),s=i(34),o=i(20),a=i(0),u=i(5),l=i(36),c=i(15);t.thenMap=function(e,t){return n(this,void 0,void 0,(function*(){const i=yield e;return null==i?void 0:t(i)}))},t.thenCollect=function(e,t){return n(this,void 0,void 0,(function*(){const i=[];for(const n of c.toA(yield e))if(null!=n){const e=yield n;if(null!=e){const n=yield t(e);null!=n&&i.push(n)}}return i}))},t.thenTap=function(e,t=console.dir.bind(console)){return n(this,void 0,void 0,(function*(){const i=yield e;return yield t(i),i}))},t.isPromise=function(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch},t.PromiseStates=l.strEnum("pending","resolved","rejected"),t.until=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=Date.now(),l=null==t?void 0:t+n,c=a.orElse(i,()=>a.orElse(t,30*r.secondMs)/10),d=u.clamp(100,10*r.secondMs,c);for(;null==l||Date.now()<l;){const t=yield e();if(!0===t)return!0;if(null!=t&&!1!==t)throw new Error("f must return a boolean, but returned "+o.stringify(t));yield s.delay(d)}return!1}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.localPlusMs=t.tsToLocal=t.localToTs=t.localToDateTime=t.localToDateObject=t.isoToPrecisionMs=t.isoToLocal=t.dateTimeToLocalSec=t.dateTimeToLocal=t.agoLocal=t.nowLocal=t.isoToDateTime=t.MaxTzOffsetHours=t.pwshJsonDate=t.wmiDate=t.fmtDateShort=t.isoNow=t.fmtDateIso=t.fmtDateTime=t.fmtDuration=t.durationHMS=t.durationToPaddedHMS=t.fmtMs=t.filestampUTC=t.filestamp=t.datestampUTC=t.datestamp=t.thenElapsed=t.elapsedAsync=t.elapsed=t.isRecentMs=t.recent=t.closeTo=t.ago=t.unixtime=t.cmpDate=t.isDate=void 0;const r=i(73),s=i(1),o=i(3),a=i(4),u=i(54),l=i(0),c=i(5),d=i(18),h=i(41),f=i(35),p=i(116),m=i(51),g=i(16),v=i(24),y=i(10);function b(e){return e instanceof Date}function w(e,t=5*a.secondMs){return c.gt0(e)&&Date.now()-e<=t}function S(e,t,i){return e<1?void 0:f.plur(e,t,i)}function P(e,t=2,i){if(!c.gte0(e))return c.isNumber(e)?"-"+P(Math.abs(e),t):"";const n=[S(Math.floor(e/a.dayMs),"day","days"),S(Math.floor(e/a.hourMs)%24,"hour","hours"),S(Math.floor(e/a.minuteMs)%60,"minute","minutes"),S(Math.floor(e/a.secondMs)%60,"second","seconds")],r=n.findIndex(e=>null!=e),o=s.compact(n.slice(r,r+t));return s.isEmpty(o)?"":null!=i&&1===o.length&&o[0].startsWith("1 ")?o[0]+" "+i.plural:o.join(", ")+l.mapOr(i,e=>" "+e.singular,()=>"")}t.isDate=b,t.cmpDate=function(e,t){const i=l.mapOr(e,e=>e.getTime(),()=>0),n=l.mapOr(t,e=>e.getTime(),()=>0);return h.cmp(i,n)},t.unixtime=function(e){const t=b(e)?e.getTime():c.isNumber(e)?e:Date.now();return Math.floor(t/a.secondMs)},t.ago=function(e,t){return new Date(l.orElse(t,new Date).getTime()-e)},t.closeTo=function(e,t,i){return null!=e&&null!=t&&Math.abs(e.getTime()-t.getTime())<=i},t.recent=function(e,t=5*a.secondMs){return w(l.map(e,e=>m.datedToMillis(e)),t)},t.isRecentMs=w,t.elapsed=function(e){const t=Date.now(),i=e();return{elapsedMs:Date.now()-t,result:i}},t.elapsedAsync=function(e){return n(this,void 0,void 0,(function*(){const t=Date.now(),i=yield e();return{elapsedMs:Date.now()-t,result:i}}))},t.thenElapsed=function(e){return n(this,void 0,void 0,(function*(){const t=Date.now(),i=yield e;return{elapsedMs:Date.now()-t,result:i}}))},t.datestamp=function(e=new Date){return e.getFullYear()+"-"+y.pad2(e.getMonth()+1)+"-"+y.pad2(e.getDate())},t.datestampUTC=function(e=new Date){return e.getUTCFullYear()+"-"+y.pad2(e.getUTCMonth()+1)+"-"+y.pad2(e.getUTCDate())},t.filestamp=function(e=new Date){return[e.getFullYear(),y.pad2(e.getMonth()+1),y.pad2(e.getDate()),"-",y.pad2(e.getHours()),y.pad2(e.getMinutes()),y.pad2(e.getSeconds())].join("")},t.filestampUTC=function(e=new Date){return[e.getUTCFullYear(),y.pad2(e.getUTCMonth()+1),y.pad2(e.getUTCDate()),"-",y.pad2(e.getUTCHours()),y.pad2(e.getUTCMinutes()),y.pad2(e.getUTCSeconds())].join("")},t.fmtMs=function(e,t=2){return e<10*a.secondMs?Number(e).toLocaleString()+"ms":P(e,t)},t.durationToPaddedHMS=function(e){return r.Duration.fromMillis(e).toFormat("hhhh:mm:ss.SSS")},t.durationHMS=function(e){return r.Duration.fromMillis(c.round(e/a.secondMs)*a.secondMs).toFormat("h:mm:ss")},t.fmtDuration=P;const M=new Map;function E(e,t,i=r.DateTime.DATETIME_MED){return m.mapValidDate(e,e=>(o.mapNotBlank(t,t=>e=e.setLocale(t)),e.toLocaleString(i)))}t.fmtDateTime=E,t.fmtDateIso=function(e,t,i=r.DateTime.DATETIME_MED){return d.Opt(r.DateTime.fromISO(e,{setZone:!0})).filter(m.validDate).orElse(()=>l.map(p.DateInterval.fromISO(e),e=>e.middle.toDateTime())).map(e=>E(e,t,i)).getOrElse(()=>e)},t.isoNow=function(){return(new Date).toISOString()},t.fmtDateShort=function(e,t="en-US"){return u.getOrSet(M,t,()=>new Intl.DateTimeFormat(t,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(m.datedToMillis(e))};const x=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;t.wmiDate=function(e){const t=x.exec(e);if(null==t)return;const i=t.slice(1,8).map(e=>c.toInt(e));if(!l.allDefined(i))return;const[n,r,s,o,u,d,h]=i,f=c.toInt(t[8],{defaultValue:0});return new Date(Date.UTC(n,r-1,s,o,u,d,h/1e3)-f*a.minuteMs)};const _=/Date\((\d+)\)/;function T(e){if(!o.blank(e))return d.Opt(r.DateTime.fromISO(y.removeCapture(e,k),{setZone:!0})).filter(e=>e.isValid).orElse(()=>l.map(p.DateInterval.fromISO(e),e=>e.middle.toDateTime())).get()}function D(e){return O(r.DateTime.local().plus(-e))}function O(e){return l.map(F(e),t=>100*t+I(e.millisecond))}function F(e){return null!=e&&e.isValid?c.toInt(e.toFormat("yMMddHHmmss")):void 0}function I(e){return Math.floor(e/10)}t.pwshJsonDate=function(e){return d.Opt(e).flatMap(e=>_.exec(e)).flatMap(e=>e[1]).flatMap(c.toInt).filter(e=>g.within(0,Date.now()+a.dayMs,e)).map(e=>new Date(e)).get()},t.MaxTzOffsetHours=14,t.isoToDateTime=T,t.nowLocal=function(){return D(0)},t.agoLocal=D,t.dateTimeToLocal=O,t.dateTimeToLocalSec=F;const k=/\.\d\d\d(\d+)/;t.isoToLocal=function(e){return l.map(T(e),O)};const C=/^\d{1,4}-\d{2}-\d{2}$/;function A(e,t){if(null==e||e<0)return;let i=e;const n=()=>{const e=i%100;return i=Math.floor(i/100),e},s=10*n(),o=n(),a=n(),u=n(),c=n(),d=n();return{year:i,month:d,day:c,hour:u,minute:a,second:o,millisecond:s,zone:l.map(t,e=>r.Info.normalizeZone(e))}}function L(e,t){return l.map(A(e,t),e=>r.DateTime.fromObject(e))}t.isoToPrecisionMs=function(e){return o.mapNotBlank(e,e=>v.firstThunk(()=>l.map(p.DateInterval.fromISO(e),e=>e.intervalMs),()=>d.Opt(e.match(C)).flatMap(()=>r.DateTime.fromISO(e)).filter(m.validDate).map(()=>a.dayMs).get(),()=>d.Opt(r.DateTime.fromISO(e)).filter(m.validDate).map(()=>0).get()))},t.localToDateObject=A,t.localToDateTime=L,t.localToTs=function(e,t){return l.map(L(e,t),e=>e.toMillis())},t.tsToLocal=function(e){const t=new Date(e);return c.toInt([t.getFullYear(),...[t.getMonth()+1,t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),I(t.getUTCMilliseconds())].map(y.pad2)].join(""))},t.localPlusMs=function(e,t){return O(L(e).plus(t))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MinIoRate=t.LongTtlMs=t.CmdTimeoutMs=t.LongMountpointsTtlMs=t.MountpointsTtlMs=void 0;const n=i(4),r=i(35);t.MountpointsTtlMs=15*n.secondMs,t.LongMountpointsTtlMs=5*n.minuteMs,t.CmdTimeoutMs=35*n.secondMs,t.LongTtlMs=1*n.hourMs,t.MinIoRate=n.secondMs/(2*r.MiB)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.start=t.isSingleSpecTests=t.isProd=t.isTest=t.isDev=t.nodeEnv=t._nodeEnv=void 0;const n=i(19),r=i(7),s=i(22);function o(){switch(r.toS(n.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return n.argv.some(e=>e.endsWith("mocha")||e.endsWith(".spec.js"))?"test":"production"}}t._nodeEnv=o,t.nodeEnv=(()=>{const e=o();return n.env.NODE_ENV=e,e})(),t.isDev="development"===t.nodeEnv,t.isTest="test"===t.nodeEnv,t.isProd="production"===t.nodeEnv,t.isSingleSpecTests=t.isTest&&s.isTrue(n.env.SINGLE_SPEC_TESTS),t.start=Date.now()},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isStatsDbMigrator=t.isStatsDbClient=t.isWelcomeService=t.isSyncFileService=t.isSyncService=t.isRpcClient=t.isRpcServer=t.isWebService=t.isMainService=t.colorProcessName=t.processName=t.maybeSetServiceName=t.setServiceName=t.serviceName=t.serviceShutdownTimeoutMs=t.title=t.StatsDbServices=t.WelcomeServices=t.RpcServices=t.serviceNameIndex=t.ServiceNames=void 0;const n=i(19),r=i(1),s=i(3),o=i(4),a=i(2),u=i(36),l=i(7),c=i(47),d=i(74),h=i(6),f=i(28);t.ServiceNames=u.strEnum("main","web","sync","sync-file","info","test","logcat","logtail","ls"),t.serviceNameIndex=function(e){const i=t.ServiceNames.indexOf(e);return i<0?t.ServiceNames.length+1:i},t.RpcServices=["main","test"],t.WelcomeServices=["main","web","test"],t.StatsDbServices=["sync","sync-file"],t.title=function(e){return c.App.getName()+" "+e},t.serviceShutdownTimeoutMs=function(e){switch(e){case"main":case"web":return o.minuteMs;case"sync":case"sync-file":default:return 10*o.secondMs}};let p="";function m(){if(s.blank(p))throw Error("serviceName() is unset");return p}function g(e){if(!f.isTest&&e!==p&&""!==p)throw new Error("Cannot set service name twice");p=e,t.processName.unset(),h.setupLogger()}t.serviceName=m,t.setServiceName=g,t.maybeSetServiceName=function(e){if(!f.isTest)throw new Error("Only used by tests");s.blank(p)&&g(e)};const v=a.lazy(()=>[{re:/sync-file/,f:d.cyan},{re:/sync/,f:d.blue},{re:/web/,f:d.green},{re:/db/,f:d.magenta},{re:/main/,f:d.yellow},{re:/test/,f:d.red}]);function y(){return t.RpcServices.includes(m())}function b(){return"sync"===p}t.processName=a.lazy(()=>r.compactBlanks([p,l.toS(n.pid)]).join("-")),t.colorProcessName=function(e){const t=v().find(t=>e.match(t.re));return null!=t?d.bgBlack(t.f(e)):e},t.isMainService=function(){return p===t.ServiceNames.main},t.isWebService=function(){return p===t.ServiceNames.web},t.isRpcServer=y,t.isRpcClient=function(){return!y()},t.isSyncService=b,t.isSyncFileService=function(){return"sync-file"===p},t.isWelcomeService=function(){return t.WelcomeServices.includes(m())},t.isStatsDbClient=function(){return t.StatsDbServices.includes(m())},t.isStatsDbMigrator=a.lazy(()=>b())},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstExistingDirectory=t.isDirectorySync=t.addNameSuffix=t.countFromName=t.nameWithoutCount=t.posixPathFromGrandparent=t.posixPathFrom=t.pathnames=t.containedByNativePath=t.containedBy=t.extname2=t.basename=t.parseNativePath=t.parsePosixPath=t.resolve=t.native2posix=t.posix2native=void 0;const n=i(46),r=i(31),s=i(3),o=i(0),a=i(5),u=i(7),l=i(12),c=i(14),d=i(10),h=r.posix;function f(e,t){if(r.sep===h.sep)return e;const i=s.notBlank(t)?r.sep+r.sep+t+r.sep:"",n=e.split(h.sep);return d.equalsIgnoreCase(n[0],t)&&n.unshift(),i+n.join(r.sep)}function p(e){return r.sep===h.sep||h.sep===r.sep?e:e.split(r.sep).join(h.sep)}t.posix2native=f,t.native2posix=p;const m=/^([A-Z]:)[\\/]?(.*)$/i;function g(...e){const t=r.join(...e);return r.resolve(c.isWin?function(e){const t=m.exec(e);return null!=t?t[1].toUpperCase()+"\\"+t[2]:e}(t):t)}t.resolve=g;const v=/(\.?.*?)(\.[a-z]{1,10}\.(?:gz|z|xz|bz2))$/i;function y(e){const t=r.parse(e),i=b(t.base),n=d.stripSuffix(t.base,i);return Object.assign(Object.assign({},t),{ext:i,name:n})}function b(e){const t=v.exec(e);return null!=t&&s.notBlank(t[2])?t[2]:r.extname(e)}function w(e){return d.stripPrefix(e,r.sep).split(r.sep)}t.parsePosixPath=function(e){return y(f(e))},t.parseNativePath=y,t.basename=function(e){return d.stripSuffix(e,b(e))},t.extname2=b,t.containedBy=function(e,t){return s.notBlank(e)&&s.notBlank(t)&&(e===t||e.startsWith(d.ensureSuffix(t,h.sep)))},t.containedByNativePath=function(e,t){return s.notBlank(e)&&s.notBlank(t)&&(e===t||e.startsWith(d.ensureSuffix(t,r.sep)))},t.pathnames=w,t.posixPathFrom=function(e,t){return e.nativePath===t.nativePath?"":d.stripPrefix(p(t.nativePath),d.ensureSuffix(p(e.nativePath),"/"))},t.posixPathFromGrandparent=function(e){return w(e).slice(-3).join("/")};const S=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function P(e){return!!s.notBlank(e)&&n.statSync(e).isDirectory()}t.nameWithoutCount=function(e){return o.mapOr(u.toS(e).match(S),e=>e[1],()=>e)},t.countFromName=function(e){return o.map(u.toS(e).match(S),e=>l.first([e[2],e[3]],a.toInt))},t.addNameSuffix=function(e,t){const i=b(e);return`${d.stripSuffix(e,i)}${t}${i}`},t.isDirectorySync=P,t.firstExistingDirectory=function(e){for(const t of e)if(s.notBlank(t)){const e=g(t);if(P(e))return e}}},function(e,t){e.exports=require("path")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PosixFile=t.coalesce=t.groupByMountpoint=void 0;const r=i(31),s=i(119),o=i(1),a=i(3),u=i(4),l=i(2),c=i(0),d=i(5),h=i(18),f=i(68),p=i(15),m=i(12),g=i(62),v=i(8),y=i(21),b=i(26),w=i(13),S=i(6),P=i(57),M=i(100),E=i(14),x=i(9),_=i(10),T=i(110),D=i(48),O=i(67),F=i(40),I=i(151),k=i(147),C=i(70),A=i(170),L=i(171),R=i(152),N=i(30),B=new I.FileCache;t.groupByMountpoint=function(e,t){return M.groupBy(e,e=>c.map(e.bestMountpoint(t),e=>e.nativePath))},t.coalesce=function(e,t){const i=M.groupBy(e,e=>c.map(e.bestMountpoint(t),e=>e.nativePath));return o.sortBy(o.flatten(p.toA(i.values()).map(e=>m.contextFilter(o.sort(e),(e,t,i)=>null==i||!e.isDescendantOf(i)))),e=>e.pathnames)};class j extends F.BaseFile{constructor(e,t){super(e,t),this.nativePath=e,this.pflog=l.lazy(()=>S.mkLogger("PosixFile("+this.nativePath+")")),this.uriObject=l.lazy(()=>k.file2voluri(this)),this.uri=l.lazy(()=>v.thenMap(this.uriObject(),e=>s.format(e))),this.fileuri=l.lazy(()=>k.file2fileuri(this)),this.mountpoint=l.lazy(()=>v.thenMap(O.mountpoints(),e=>this.bestMountpoint(e.map(e=>this.for(e))))),this.etag=l.lazy(()=>v.thenMap(this.stat(),e=>[e.size,e.mtime.getTime()].map(e=>P.Radix58.encode(e)).join("-"))),this.ignorable=l.lazy(()=>n(this,void 0,void 0,(function*(){return(yield this.isDirectory())?L.ignorableDirectory(this):L.ignorableFile(this)}))),this.hidden=l.lazy(()=>A.hidden(this)),this.isMountpoint=l.lazy(()=>n(this,void 0,void 0,(function*(){return(yield this.isDirectory())&&(yield v.thenMapOr(O.mountpoints(),e=>e.includes(this.nativePath),()=>!1))}))),this.sidecars=l.lazy(()=>n(this,void 0,void 0,(function*(){if(this.isSidecar())return[];const e=yield this.dirEntSiblings(e=>e.filter(e=>D.isSidecarExt(e.ext)&&(e.name===this.name||e.name===this.base||N.nameWithoutCount(e.name)===N.nameWithoutCount(this.name))));return v.sortByAsync(p.toA(e),e=>e.mtimeMs())}))),this.shaWithSidecars=l.lazy(()=>n(this,void 0,void 0,(function*(){const e=[this,...yield this.sidecars()].map(e=>e.nativePath);return(yield C.fileSha(o.sort(e))).toString("base64")})),F.BaseFile.attrTTL)}static for(e,t){if(a.blank(e))throw new Error("unexpectedly empty path");if(e instanceof j)return e;if(e instanceof F.BaseFile)return this.for(e.nativePath,t);if(k.isUri(e))throw new Error("use forUri");const i=B.get(e);if(null!=i)return i;const n=N.resolve(e);return B.getOrSet(n,()=>new j(n,t))}static forPosix(e){return this.for(e.replace(/\//g,r.sep))}static forUri(e,t){return v.thenMap(k.uri2file(e,t),e=>this.for(N.posix2native(e.posixPath,e.hostname)))}static forUriOrPath(e,t){return g.firstDefinedLater(()=>this.forUri(e),()=>this.for(t))}for(e,t){return j.for(e,t)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.ignorable.unset(),this.hidden.unset(),this.sidecars.unset(),this}bestMountpoint(e){return m.greatestBy(e.filter(e=>this.isDescendantOf(e)),e=>h.Opt(o.commonPrefixLength(this.pathnames,e.pathnames)).filter(t=>t>=e.pathnames.length).get())}isDeleted(e,t=O.mountpoints){return n(this,void 0,void 0,(function*(){if(yield this.exists())return!1;if(!this.nativePath.startsWith(e))return this.pflog().error("isDeleted("+e+"): INTERNAL ERROR: prefix doesn't match",{result:!0}),!0;const i=yield t();if(o.isNotEmpty(i)&&(i.includes(e)||_.includesIgnoreCase(i,e)))return this.pflog().debug("isDeleted("+e+"): mountpoint exists but I don't.",{result:!0}),!0;for(const t of this.parents().filter(t=>t.nativePath.length>e.length))if(yield t.exists())return this.pflog().debug("isDeleted("+e+"): ancestor "+t+" exists but I don't.",{result:!0}),!0;return this.pflog().debug("isDeleted("+e+"): Can't say positively that I was deleted from my mountpoint.",{result:!1}),!1}))}httpHeaders(){return n(this,void 0,void 0,(function*(){return{ETag:yield this.etag(),"Last-Modified":yield this.lastModifiedUtc()}}))}hide(){return n(this,void 0,void 0,(function*(){const e=yield E.isWin?y.stdout("attrib",["+h",this.nativePath],{timeout:10*u.secondMs}).catch(e=>e):E.isMac?y.stdout("chflags",["hidden",this.nativePath],{timeout:10*u.secondMs}).catch(e=>e):"";return a.notBlank(e)?void this.pflog().warn("hide("+this.nativePath+") failed: "+e):this.clear()}))}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}mkNoMedia(){return this.join(".NoMedia").writeTxt("See <https://support.photostructure.com/no-media/>").then(()=>(w.emitFileChanged(this.nativePath),this)).catch(e=>{this.pflog().warn("Could not add .NoMedia file to "+this,e)})}hasNoMedia(){return n(this,void 0,void 0,(function*(){return R.hasNoMedia(yield this.directoryEntry())}))}ignorableCheap(){return L.ignorablePath(this.nativePath)}isSidecar(){return D.isSidecarExt(this.ext)}sidecar(){return n(this,void 0,void 0,(function*(){return f.thenOpt(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+D.asExt(x.Settings.defaultSidecarType.valueOrDefault).toLowerCase()))}))}jsonSidecar(){return n(this,void 0,void 0,(function*(){const e=yield this.dirEntSiblings(e=>e.filter(e=>_.equalsIgnoreCase(e.ext,".json")&&(e.name===this.name||e.name===this.base||N.nameWithoutCount(e.name)===N.nameWithoutCount(this.name)))),t=o.sortBy(p.toA(e),e=>-T.diceCoeff(this.name,e.name))[0];return this.pflog().debug("jsonSidecar(): "+t),t}))}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",()=>n(this,void 0,void 0,(function*(){const e=yield this.mtimeMs(),t=yield this.sidecars(),i=[e,...yield Promise.all(p.toA(t).map(e=>e.mtimeMs()))].filter(d.gt0);return o.mapNotEmpty(i,e=>Math.floor(Math.max(...e)))})))}thisOrSidecareMaxMtimeSec(){return v.thenMap(this.thisOrSidecareMaxMtimeMs(),e=>b.unixtime(e))}}t.PosixFile=j},function(e,t){e.exports=require("util")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.later=t.delayUntil=t.delay=t.unrefDelay=void 0;const n=i(53),r=i(5);function s(e){return o(e,!1)}function o(e,t){return new Promise(i=>{if(e<=0)i();else{const r=n.setTimeout(()=>i(),Math.ceil(e+.5));t&&r.unref()}})}t.unrefDelay=function(e){return o(e,!0)},t.delay=s,t.delayUntil=function(e){const t=(r.gt0(e)?e:e.getTime())-Date.now();if(t<0){if(t>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-t+"ms")}return s(t).then(()=>t)},t.later=function(e,t=1){return n.setTimeout(e,Math.max(1,Math.ceil(t)))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.plur=t.pixels2size=t.SizeDescriptions=t.megapixels=t.MP=t.fmtMebi=t.fmtBytes=t.TiB=t.GiB=t.MiB=t.KiB=t.TB=t.GB=t.MB=t.KB=t.fmt=void 0;const n=i(5),r=i(36),s=new Intl.NumberFormat;function o(e){return s.format(e)}t.fmt=o,t.KB=1e3,t.MB=1e3*t.KB,t.GB=1e3*t.MB,t.TB=1e3*t.GB,t.KiB=1024,t.MiB=1024*t.KiB,t.GiB=1024*t.MiB,t.TiB=1024*t.GiB;const a=["B","KB","MB","GB","TB","PB"],u=["B","KiB","MiB","GiB","TiB","PiB"];t.fmtBytes=function(e,t=3){const i=Math.floor(Math.log10(e)),r=Math.floor(i/3),s=Math.pow(10,3*r),o=a[r];return n.sigFigs(e/s,t)+" "+o},t.fmtMebi=function(e,t=3){const i=Math.floor(Math.log2(e)),r=Math.floor(i/10),s=Math.pow(2,10*r),o=u[r];return n.sigFigs(e/s,t)+" "+o},t.MP=1e6,t.megapixels=function(e){return n.sigFigs(e/t.MP,2)},t.SizeDescriptions=r.strEnum("tiny","small","medium","large","original"),t.pixels2size=function(e){return e<76800?"tiny":e<345600?"small":e<2073600?"medium":"large"},t.plur=function(e,t,i=t+"s"){return o(e)+" "+(1===e?t:i)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.strEnum=void 0;const n=i(44);t.strEnum=function(...e){const t=Object.freeze(e),i={};for(const e of t)i[e]=e;const r=e=>null!=e&&t.includes(e);return Object.assign(Object.assign({},i),{values:t,length:t.length,has:r,indexOf:e=>null==e?-1:t.indexOf(e),validOrElse:(e,t)=>r(e)?e:n.tot(t),map:(e,t)=>r(e)?t(e):void 0})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isError=t.asError=t.errorToVerbose=t.errorToS=void 0;const n=i(1),r=i(3),s=i(0),o=i(7);function a(e){return e instanceof Error?n.compactBlanks([e.name,s.map(e.code,e=>"code "+e),e.message]).join(": "):o.toS(e)}t.errorToS=a,t.errorToVerbose=function(e){const t=a(e),i=o.toS(e.stack).split("\n").slice(0,6);return t!==i[0]&&i.unshift(t),i.join("\n")},t.asError=function(e){if(r.blank(e))throw new Error("undefined error");if(e instanceof Error)return e;if(Array.isArray(e)){const t=e[0];return t instanceof Error?(e.length>1&&(t.errors=e.slice(1)),t):new Error(e.map(e=>o.toS(e)).filter(r.notBlank).join(", "))}return new Error(o.toS(e))},t.isError=function(e){return"object"==typeof e&&e instanceof Error}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.objectType=t.isObject=t.isFunction=t.isSymbol=t.ObjectType=void 0;const n=i(90),r=i(41);var s;function o(e){return"symbol"==typeof e}function a(e){return"function"==typeof e}function u(e){return null==e?s.Empty:o(e)?s.Symbol:r.isPrimitive(e)?s.Primitive:Array.isArray(e)?s.Array:n.isIterable(e)?s.Iterable:a(e)?s.Function:"object"==typeof e?e.constructor&&"Object"===e.constructor.name?s.Object:s.Instance:s.Unknown}!function(e){e[e.Empty=0]="Empty",e[e.Primitive=1]="Primitive",e[e.Symbol=2]="Symbol",e[e.Object=3]="Object",e[e.Array=4]="Array",e[e.Iterable=5]="Iterable",e[e.Instance=6]="Instance",e[e.Function=7]="Function",e[e.Unknown=8]="Unknown"}(s=t.ObjectType||(t.ObjectType={})),t.isSymbol=o,t.isFunction=a,t.isObject=function(e){return u(e)===s.Object},t.objectType=u},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.parseTags=t.readRawTags=t.writeTags=t.deleteAllTags=t.moveOriginal=t.sizeInfo=t.isMimetype=t.readRotation=t.mimetype=t.capturedAt=t.cachedTags=t.readTags=t.sidecarEql=t.clearTagsCache=t.rawTagsCache=t.extractBinaryTag=t.shutdownExiftool=t.exiftoolVersionMaybe=t.exiftoolVersion=t.exiftool=void 0;const r=i(98),s=i(31),o=i(1),a=i(3),u=i(4),l=i(37),c=i(75),d=i(2),h=i(0),f=i(11),p=i(15),m=i(7),g=i(47),v=i(17),y=i(62),b=i(8),w=i(69),S=i(155),P=i(55),M=i(26),E=i(45),x=i(13),_=i(176),T=i(32),D=i(177),O=i(178),F=i(221),I=i(118),k=i(82),C=i(6),A=i(14),L=i(9),R=i(27),N=i(66),B=i(135),j=i(222),z=i(305),V=i(48),q=i(306),W=i(227),U=i(228),H=i(128),G=i(133),J=i(194),$=i(307),Q=d.lazy(()=>C.mkLogger("ExifTags")),K=d.lazy(()=>{const e=N.maxCpus()>4?2:1;return S.observeBatchCluster(new r.ExifTool({maxProcs:e,maxIdleMsPerProcess:u.minuteMs,cleanupChildProcs:!1}),"exiftool",v.EndableRanks.service).bc});function Y(){const e=K();return e.ended?K.refresh():e}t.exiftool=Y,t.exiftoolVersion=function(){return b.thenOrTimeout(Y().version(),R.CmdTimeoutMs,()=>{throw new Error("ExifTool timed out")})},t.exiftoolVersionMaybe=function(){return h.map(K.prior(),e=>e.ended?void 0:b.thenOrTimeout(e.version(),R.CmdTimeoutMs,()=>{throw new Error("ExifTool timed out")}))},t.shutdownExiftool=function(e=!1){return h.map(K.clear(),t=>t.end(e))},x.onFileCopied((e,t)=>b.thenMap(ie(e),e=>{const i=T.PosixFile.for(t);return X.getOrSet(i.nativePath,()=>Promise.resolve(Object.assign(Object.assign({},e),{SourceFile:i.nativePath,FileName:i.base,Directory:i.dir})))})),t.extractBinaryTag=function(e,t,i){return Y().extractBinaryTag(e,t,i)};const X=new P.BoundedMap(7*u.minuteMs,1024,!0);function Z(){X.clear(),t.rawTagsCache.clear()}t.rawTagsCache=new P.BoundedMap(7*u.minuteMs,1024,!0),t.clearTagsCache=Z,x.onClearCache(Z),x.onFileChanged(e=>{a.blank(e)?Z():(X.deleteIf(t=>t.startsWith(e)),t.rawTagsCache.deleteIf(t=>t.startsWith(e)))});const ee=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];function te(e){return n(this,void 0,void 0,(function*(){if(null==e)return;const t=T.PosixFile.for(e);return(yield t.isEmpty())?void 0:X.getOrSet(t.nativePath,()=>w.time("tags.readTags",()=>n(this,void 0,void 0,(function*(){return b.thenMap(oe(t),e=>ce(t,e))}))))}))}function ie(e){return n(this,void 0,void 0,(function*(){return X.get(String(e))}))}function ne(e){return n(this,void 0,void 0,(function*(){if(a.blank(e))return;const i=T.PosixFile.for(e);return y.firstDefinedLater(()=>b.thenMap(t.rawTagsCache.get(i.nativePath),e=>e.MIMEType),()=>b.thenMap(ie(i),e=>e.MIMEType),()=>b.thenMap(_.readFileType(i.nativePath),e=>"image/tiff"===e.mime?void 0:e.mime),()=>V.isExifExt(i.ext)?b.thenMap(oe(i,!1),e=>e.MIMEType):void 0)}))}function re(e,t){return n(this,void 0,void 0,(function*(){const i=T.PosixFile.for(e),n=null==t||a.blank(t.ImageHeight)?yield oe(i):t;if(null==n)return;const r=h.orElse(H.extractRotation(t),()=>H.extractRotation(n)),s=O.dcrawSupportedMimetype(n.MIMEType)?yield F.rawInfo(i).catch(e=>{Q().warn("Failed to read raw info",{file:i.nativePath,err:l.errorToS(e)})}):void 0,o=G.extractSizeInfo(n,r,s);return null!=o?o:k.isVideoMimeType(n.MIMEType)?b.thenMap(I.extractVideoFrame(i,n.MIMEType),e=>re(e,n)):void 0}))}function se(e,t="_original"){return n(this,void 0,void 0,(function*(){return e.sibling(e.base+t).saveIfNewOrDelete(e.name+t+e.ext)}))}function oe(e,t=!0){return w.time("tags.readRawTags",()=>n(this,void 0,void 0,(function*(){const i=T.PosixFile.for(e);if(!(yield i.isFile()))return;const r=yield le(i.nativePath);if(null==r||!t)return r;const s=[],a=b.thenMap(i.jsonSidecar(),e=>n(this,void 0,void 0,(function*(){const t=yield q.readJsonSidecar(e);return null!=t&&s.push(e.base),t}))),u=b.thenMap(i.sidecars(),e=>b.tuples(e,e=>le(e.nativePath)));let l=Object.assign(Object.assign({},r),yield a);for(const[e,t]of p.toA(yield u))s.push(t.base),l=Object.assign(Object.assign({},l),f.compactValues(f.without(e,...ee)));return o.isNotEmpty(s)&&(l.sidecars=s),l})))}t.sidecarEql=function(e,t){return n(this,void 0,void 0,(function*(){const i=e=>b.thenMap(oe(e,!1),e=>f.without(e,...ee));return(yield E.eqlAsync(e.clear().sha(),t.clear().sha()))||(yield E.eqlAsync(i(e),i(t)))}))},t.readTags=te,t.cachedTags=ie,t.capturedAt=function(e){return n(this,void 0,void 0,(function*(){return b.thenMap(te(e),e=>e.capturedAt)}))},t.mimetype=ne,t.readRotation=function(e){return n(this,void 0,void 0,(function*(){return b.thenMap(oe(e,!0),H.extractRotation)}))},t.isMimetype=function(e,t){return n(this,void 0,void 0,(function*(){const i=yield ne(e);return Q().tap({msg:"isMimetype",meta:{path:m.toS(e),mimeType:i},result:null!=i&&t.has(i)})}))},t.sizeInfo=re,t.moveOriginal=se,t.deleteAllTags=function(e){return n(this,void 0,void 0,(function*(){yield Y().deleteAllTags(e.nativePath),yield e.sibling(e.base+"_original").unlink("trace")}))},t.writeTags=function(e,t,i){return w.time("tags.writeTags",()=>n(this,void 0,void 0,(function*(){const n=yield e.sidecar(),r=k.isVideoMimeType(i),s=r&&L.Settings.writeMetadataToSidecarsIfVideo.valueOrDefault||!r&&L.Settings.writeMetadataToSidecarsIfImage.valueOrDefault||(yield n.exists())?n:e;yield Y().write(s.nativePath,t,L.Settings.overwriteOriginal.valueOrDefault?["-overwrite_original"]:void 0);const a=yield se(s);return o.uniq([e.nativePath,s.nativePath]).forEach(x.emitFileChanged),e.clearThisAndParent(),s.clearThisAndParent(),{original:a,dest:s}})))},t.readRawTags=oe;const ae=new c.Latch,ue=new c.Latch;function le(e){return n(this,void 0,void 0,(function*(){return t.rawTagsCache.getOrSet(e,()=>n(this,void 0,void 0,(function*(){Q().debug("_readRawTags("+e+") not cached, reading now.");const t=ae.pending;t?ae.resolve():yield ue.promise;const i=V.isVideoExt(s.extname(e))?[]:void 0,n=yield b.thenOrTimeout(M.thenElapsed(Y().read(e,i).catch(t=>{Q().info("Failed to read "+e,t)})),30*u.secondMs);return t&&ue.resolve(),h.map(n,t=>(Q().debug("_readRawTags("+e+") in "+t.elapsedMs+"ms"),h.map(t.result,e=>{const i=o.compactBlanks([e.Error,...h.orElse(e.errors,[]),e.Warning].map(m.toS));return o.isNotEmpty(i)&&(e.problems=i),e.exiftoolMs=t.elapsedMs,e})))})))}))}function ce(e,t){return n(this,void 0,void 0,(function*(){if(null==t)return;const i=t.MIMEType,n=e.nativePath;if(a.blank(i))return void Q().debug("No mimetype for "+e);const r=e.nativePath.startsWith(g.App.cache())||e.pathnames.includes(".photostructure");r||(yield J.inferMakeAndModel(e,t));const s=t;s.originalMake=t.Make,s.originalModel=t.Model,t.Make=U.make(t.Make),t.Model=U.model(t.Make,t.Model);const o=W.extractLensMakeModel(t),u=yield B.extractCapturedAt(e,t,r);if(null==u)return void Q().info("No capturedAt for "+e);const l=z.extractExposureSettings(t),c=yield re(e,t);if(null==c)return void Q().info("No size info for "+n);const d=Object.assign(Object.assign(Object.assign(Object.assign({mimetype:i,exposureSettings:l},$.extractTitleDescription(s)),o),c),{duration:i.startsWith("video/")?j.extractDurationSec(t):void 0,capturedAt:u,geohash:D.geohashNumeric(t.GPSLatitude,t.GPSLongitude),tz:t.tz});return Q().debug("parsedTags",Object.assign(Object.assign({nativePath:n},d),{tzSource:t.tzSource,capturedAt:h.map(u,e=>({date:e.date,src:e.src}))})),Object.assign(Object.assign({},s),d)}))}A.isWin||(ae.resolve(),ue.resolve()),t.parseTags=ce},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.execDir=t.BaseFile=t.DefaultEnsureNewOptions=t.WipPrefix=void 0;const r=i(46),s=i(64),o=i(73),a=i(31),u=i(175),l=i(33),c=i(105),d=i(1),h=i(56),f=i(3),p=i(4),m=i(34),g=i(20),v=i(2),y=i(0),b=i(18),w=i(97),S=i(15),P=i(7),M=i(35),E=i(12),x=i(60),_=i(123),T=i(8),D=i(43),O=i(69),F=i(21),I=i(26),k=i(45),C=i(13),A=i(51),L=i(6),R=i(52),N=i(24),B=i(14),j=i(42),z=i(9),V=i(10),q=i(110),W=i(48),U=i(27),H=i(84),G=i(125),J=i(151),$=i(70),Q=i(30),K=i(111),Y=i(112),X=i(102),Z=i(61),ee=i(145),te=r.promises;t.WipPrefix=B.isWin?"wip-":".",t.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});const ie=new J.FileCache;class ne{constructor(e,t){if(this.dirent=t,this.bflog=v.lazy(()=>L.mkLogger("BaseFile("+this.nativePath+")")),this.dirents=v.lazy(()=>n(this,void 0,void 0,(function*(){return T.thenMap(this.directoryEntry(),e=>e.children())}))),this.stat=v.lazy(()=>this.trap("stat",()=>te.stat(this.nativePath).catch(()=>{})),ne.attrTTL),this.statSync=v.lazy(()=>this.trapSync("statSync",()=>N.Try(()=>r.statSync(this.nativePath))),ne.attrTTL),this.executable=v.lazy(()=>this.access(r.constants.R_OK|r.constants.X_OK)),this.shaResult=v.lazy(()=>n(this,void 0,void 0,(function*(){const e=yield this.size();if(0===e||null==e)return;const t=e>5*M.MiB?new K.PushProgressObserver({op:"Computing SHA of",path:this.nativePath},e):void 0,i=yield I.elapsedAsync(()=>this.trap("sha",()=>$.fileSha([this.nativePath],{observer:t}))),n=y.map(i.result,e=>e.toString("base64"));return{elapsedMs:i.elapsedMs,buffer:i.result,b64:n}})),ne.attrTTL),null!=t)this.nativePath=t.nativePath,this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext;else{this.nativePath=Q.resolve(e),this.nativePath.startsWith("\\\\")&&(this.hostname=this.nativePath.split("\\")[2]);const t=Q.parseNativePath(this.nativePath);this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext}this.posixPath=Q.native2posix(this.nativePath),ie.set(e,this)}toJSON(){return{ctor:this.constructor.name,nativePath:this.nativePath}}[l.inspect.custom](){return this.toJSON()}static withFastestAccess(e){return n(this,void 0,void 0,(function*(){const t=d.compact(e),i=yield Promise.all(t.map(e=>e.shaMs()));return t[E.leastIndex(i)]}))}static forPosix(e){return e instanceof ne?e:this.for(V.replaceAll(e,"/",a.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,t){if(e instanceof ne)return e;const i=ie.get(e);if(null!=i)return i;const n=Q.resolve(e);return ie.getOrSet(n,()=>new ne(n,t))}static clear(e){C.emitFileChanged(e)}for(e,t){return ne.for(e,t)}clear(){return this.dirent=void 0,this.dirents.unset(),this.stat.unset(),this.statSync.unset(),this.executable.unset(),this.shaResult.unset(),this}clearThisAndParent(){return C.emitFileChanged(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return null!=e&&(e instanceof ne?this.nativePath===e.nativePath:this.nativePath===ne.for(e).nativePath)}isExt(...e){return d.compactBlanks(e).map(e=>w.ensurePrefix(e,".").toLowerCase()).includes(P.toS(this.ext).toLowerCase())}get normalizedExt(){return W.normalizeExt(this.ext).toLowerCase()}get baseWithParent(){return(this.isRoot?"":this.parent().base)+"/"+this.base}get baseWithGrandparent(){return(this.isRoot?"":this.parent().baseWithParent)+"/"+this.base}posixPathFrom(e){return Q.posixPathFrom(e,this)}directoryEntry(){return n(this,void 0,void 0,(function*(){if(null==this.dirent){const e=yield this.isFile(),t=yield this.isDirectory(),i=yield this.isSymbolicLink(),n={name:this.base,isFile:()=>e,isDirectory:()=>t,isSymbolicLink:()=>i};this.dirent=new G.DirectoryEntry(this.dir,n)}return this.dirent}))}_child(e){return this.for(a.join(this.nativePath,e.base),e)}childNames(){return T.thenMap(this.dirents(),e=>e.map(e=>e.base))}children(e){return n(this,void 0,void 0,(function*(){return T.thenMap(this.dirents(),t=>n(this,void 0,void 0,(function*(){return d.compact(yield D.withBoundedConcurrency({name:"BaseFile.children",laters:t.map(t=>()=>_.apply(this._child(t),e))}))})))}))}childFiles(e){return n(this,void 0,void 0,(function*(){const t=[];for(const i of S.toA(yield this.dirents()))if(i.isFile()){const n=this._child(i);(null==e||e(n))&&t.push(n)}return t}))}childDirectories(e){return n(this,void 0,void 0,(function*(){return T.thenMap(this.dirents(),t=>T.thenCompact(t.filter(e=>e.isDirectory()).map(t=>n(this,void 0,void 0,(function*(){return _.apply(this._child(t),e)})))))}))}childrenSync(){return y.orElse(this.trapSync("childrenSync",()=>r.readdirSync(this.nativePath).map(e=>this.join(e))),[])}hasChildren(e){return n(this,void 0,void 0,(function*(){const t=yield this.childNames();return d.isNotEmpty(e)?d.includesAll(t,e):d.isNotEmpty(t)}))}hasNoChildren(){return n(this,void 0,void 0,(function*(){return(yield this.isFile())||d.isEmpty(yield this.childNames())}))}visitDescendants(e){return n(this,void 0,void 0,(function*(){return T.thenMap(this.children(),t=>n(this,void 0,void 0,(function*(){for(const i of t)yield i.visitDescendants(e),yield e(i)})))}))}descendants(e){return n(this,void 0,void 0,(function*(){const t=[];for(const i of S.toA(yield this.childFiles()))(yield e(i))&&t.push(i);const i=yield this.childDirectories();if(null!=i){for(const n of i)yield T.thenMap(n.descendants(e),e=>t.push(...e));return t}}))}ancestorWithChildren(e){return n(this,void 0,void 0,(function*(){return(yield this.hasChildren(e))?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}))}siblings(){return n(this,void 0,void 0,(function*(){return T.thenMapOr(this.selfAndSiblings(),e=>e.filter(e=>!this.eql(e)),()=>[])}))}dirEntSiblings(e){return n(this,void 0,void 0,(function*(){return T.thenMap(this.parent().dirents(),t=>e(t).map(e=>this.parent()._child(e)))}))}selfAndSiblings(){return n(this,void 0,void 0,(function*(){return this.parent().children()}))}firstExistingSelfOrAncestor(){return n(this,void 0,void 0,(function*(){return this.isRoot||(yield this.exists())?this:this.parent().firstExistingSelfOrAncestor()}))}get pathnames(){return this.nativePath.split(a.sep).filter(e=>null!=e&&""!==e)}get pathnamesWithoutDrive(){return B.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(B.isWin?1:0)}get isRoot(){return this.pathnames.length===(B.isWin?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return null!=e&&d.startsWith(e.pathnames,this.pathnames)}isDescendantOf(e){return null!=e&&d.startsWith(this.pathnames,e.pathnames)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){const e=this.parent();return this.isRoot?[]:[...e.parents(),e]}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return d.isEmpty(e)?this:this.for(a.join(this.nativePath,...e))}joinYMD(e=new Date){return y.map3(A.getYear(e),A.getMonth(e),A.getDay(e),(e,t,i)=>this.join(P.toS(e),V.pad2(t),V.pad2(i)))}child(...e){return d.isEmpty(e)?this:this.join(...Q.native2posix(a.join(...e)).split("/").filter(e=>".."!==e))}trap(e,t,i="warn"){return n(this,void 0,void 0,(function*(){try{return yield O.time("fs."+e,t)}catch(t){return void this.bflog().log(i,`trap: ${e}() failed: ${t}`)}}))}trapOr(e,t,i="warn"){return n(this,void 0,void 0,(function*(){try{return this.bflog().trace(`trapOr ${e}()`),yield t(),!0}catch(t){return this.bflog().log(i,`trapOr: ${e}() failed: ${t}`),!1}}))}trapSync(e,t){try{return this.bflog().trace(`trapSync ${e}()`),t()}catch(t){return void this.bflog().warn(`trapSync: ${e}() failed: ${t}`)}}exists(){return n(this,void 0,void 0,(function*(){return null!=this.dirent||(yield T.thenDefined(this.stat()))}))}existsSync(){return null!=this.dirent||null!=this.statSync()}notExists(){return n(this,void 0,void 0,(function*(){return T.thenNot(this.exists())}))}mtime(){return T.thenMap(this.stat(),e=>e.mtime)}mtimeMs(){return T.thenMap(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return T.thenMap(this.stat(),e=>I.unixtime(e.mtime))}lastModifiedUtc(){return n(this,void 0,void 0,(function*(){return T.thenMap(this.stat(),e=>e.mtime.toUTCString())}))}statTimes(){return T.thenMap(this.stat(),e=>d.uniq([e.birthtimeMs,e.mtimeMs].filter(e=>null!=e&&0!==e)))}maxStatMs(){return T.thenMap(this.statTimes(),E.max)}maxStatDate(){return T.thenMap(this.maxStatMs(),e=>new Date(e))}minStatMs(){return T.thenMap(this.statTimes(),R.min)}minStatDate(){return T.thenMap(this.minStatMs(),e=>new Date(e))}size(){return T.thenMap(this.stat(),e=>e.size)}access(e){return n(this,void 0,void 0,(function*(){try{return yield s.access(this.nativePath,e),!0}catch(e){return!1}}))}isReadable(){return this.access(r.constants.R_OK)}isWritable(){return this.access(r.constants.R_OK|r.constants.W_OK)}isHiddenPosix(){return this.base.startsWith(".")}isEmpty(e=0){return n(this,void 0,void 0,(function*(){if(yield this.isDirectory())return d.isNotEmpty(yield this.childNames());{const t=yield this.size();return null==t||t<=e}}))}isNonEmpty(e=1){return T.thenNot(this.isEmpty(e))}isNonEmptyFile(e=1){return n(this,void 0,void 0,(function*(){return(yield this.isFile())&&(yield this.isNonEmpty(e))}))}modifiedGTE(e){return n(this,void 0,void 0,(function*(){return T.thenMap(this.mtime(),t=>I.unixtime(t)>=I.unixtime(e))}))}modifiedCloseTo(e,t){return n(this,void 0,void 0,(function*(){return T.thenMap(this.mtimeMs(),i=>Math.abs(i-e)<=t)}))}modifiedGT(e){return n(this,void 0,void 0,(function*(){if(null!=e)return T.thenMap(this.mtime(),t=>I.unixtime(t)>I.unixtime(e))}))}isDirectory(){return n(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isDirectory():T.thenMapOr(this.stat(),e=>e.isDirectory(),()=>!1)}))}isNotDirectory(){return n(this,void 0,void 0,(function*(){return T.thenNot(this.isDirectory())}))}isDirectorySync(){return null!=this.dirent?this.dirent.isDirectory():y.mapOr(this.statSync(),e=>e.isDirectory(),()=>!1)}isSymbolicLink(){return n(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isSymbolicLink():T.thenMapOr(this.stat(),e=>e.isSymbolicLink(),()=>!1)}))}nearestDir(){return n(this,void 0,void 0,(function*(){return(yield this.isDirectory())?this:this.parent()}))}isFile(){return n(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isFile():this.stat().then(e=>b.Opt(e).map(e=>e.isFile()).getOrElse(()=>!1))}))}isFileSync(){return null!=this.dirent?this.dirent.isFile():b.Opt(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>te.rmdir(this.nativePath),e)}mkdirp(){return n(this,void 0,void 0,(function*(){return(yield this.clear().isDirectory())||this.isRoot?this:this.trap("mkdirp",()=>n(this,void 0,void 0,(function*(){try{yield s.mkdirp(this.nativePath)}catch(e){if("EEXIST"!==e.code)throw e}const e=2*p.secondMs;if(!1===(yield T.until(()=>this.clear().isDirectory(),e,200)))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()})))}))}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",()=>(s.mkdirpSync(this.nativePath),this.clearThisAndParent()))}sha(){return T.thenMap(this.shaResult(),e=>e.b64)}shaMs(){return T.thenMap(this.shaResult(),e=>e.elapsedMs)}writeStream(e,t){return n(this,void 0,void 0,(function*(){return yield Z.pipelineAsync(d.compact([e,y.map(null==t?void 0:t.onProgress,e=>new Z.ByteCounter(e)),s.createWriteStream(this.nativePath,t)])),this.clearThisAndParent()}))}writeJsonMaybe(e,t={}){return n(this,void 0,void 0,(function*(){return this.trap("writeJsonMaybe",()=>this.writeJSON(e,t))}))}writeJSON(e,t={}){return n(this,void 0,void 0,(function*(){return yield this.parent().mkdirp(),yield te.writeFile(this.nativePath,g.stringify(e,t.replacer,t.spaces),Object.assign({flag:"w"},t)),this.clearThisAndParent()}))}readJSON(e="warn"){return this.trap("readJSON",()=>h.retryOnReject(()=>s.readJSON(this.nativePath),{maxRetries:1,onRetryWaitUntil:()=>m.delay("warn"===e?250:25),errorIsRetriable:e=>-2!==e.errno}),e)}readJSONSync(){return this.trapSync("readJSONSync",()=>s.readJSONSync(this.nativePath))}readFile(e="warn"){return this.trap("readFile",()=>te.readFile(this.nativePath),e)}zReadFile(e){return n(this,void 0,void 0,(function*(){return ee.zReadFile(this.nativePath,e)}))}zcat(e){return n(this,void 0,void 0,(function*(){return this.trap("zcat",()=>T.thenMap(this.zReadFile(e),P.toS))}))}readLines(){return T.thenMap(this.readFile(),e=>H.splitLines(e.toString()))}readFileSync(){return N.Try(()=>y.map(r.readFileSync(this.nativePath),P.toS))}writeTxt(e){return this.writeFile(H.crlf(e))}writeFile(e){return n(this,void 0,void 0,(function*(){return yield this.parent().mkdirp(),yield s.writeFile(this.nativePath,e),this.clearThisAndParent()}))}wip(e=t.WipPrefix){return this.sibling(e+this.base)}unwip(e=t.WipPrefix){return n(this,void 0,void 0,(function*(){const t=this.sibling(V.stripPrefix(this.base,e));return this.mv(t,{overwrite:!0})}))}dest(e){return n(this,void 0,void 0,(function*(){const t=e.clear();return f.notBlank(this.ext)&&f.blank(t.ext)||(yield t.isDirectory())?t.join(this.base):t}))}copyFile(e){return O.time("fs.copyFile",()=>n(this,void 0,void 0,(function*(){const t=(yield this.dest(e)).clear();if(this.nativePath===t.nativePath)return this;if(null==(yield t.parent().mkdirp()))return this.bflog().throw("Cannot mkdirp "+t.dir);try{return yield this._copyFile(t)}catch(e){return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:t.nativePath,error:e}),yield this._nativeCopyFile(t)}finally{this.clearThisAndParent()}})))}_copyFile(e){return n(this,void 0,void 0,(function*(){let t;const i=yield this.stat(),r=y.map(i,e=>e.size);if(null==i||null==r)return this.bflog().throw("Can't copy missing files");if(z.Settings.verifyFileCopies.valueOrDefault&&null==(yield this.sha()))return this.bflog().throw("Can't copy file without SHA");const s=e.wip();try{const o=te.copyFile(this.nativePath,s.nativePath);r>5*M.MiB&&(t=new K.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},r,()=>s.clear().size())),yield o;const a=yield T.until(()=>n(this,void 0,void 0,(function*(){return r===(yield s.clear().size())})),U.CmdTimeoutMs);if(z.Settings.verifyFileCopies.valueOrDefault){const e=a&&(yield T.until(()=>k.eqlAsync(this.sha(),s.clear().sha())));if(!e)return this.bflog().throw("copyFile() failed",{sizeMatches:a,shaMatches:e})}if(!a)return this.bflog().throw("copyFile() failed",{expectedSize:r,actualSize:yield s.clear().size()});const u=yield s.unwip();if(null==u)return this.bflog().throw("copyFile("+e+") failed: .unwip() was null");try{yield te.chmod(u.nativePath,i.mode)}catch(e){this.bflog().debug(`copyFile(${s.nativePath}) warning: couldn't chmod to ${i.mode}: ${e}`)}return yield te.utimes(u.nativePath,i.atime,i.mtime),this.bflog().debug(`copyFile(${e.nativePath}): success`),C.emitFileCopied(this.nativePath,e.nativePath),e}catch(t){throw this.bflog().warn(`copyFile(${s.nativePath}) failed: ${t}`),yield s.unlink(),yield e.unlink(),t}finally{y.map(t,e=>e.end())}}))}copyTimeoutMs(){return n(this,void 0,void 0,(function*(){return T.thenMapOr(this.size(),e=>Math.max(U.CmdTimeoutMs,e*U.MinIoRate),()=>U.CmdTimeoutMs)}))}_nativeCopyFile(e){return n(this,void 0,void 0,(function*(){let t;try{if(null==(yield e.parent().mkdirp()))return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});const i=yield this.stat(),n=y.map(i,e=>e.size);return null==i||null==n?this.bflog().throw("Can't copy missing files"):(n>5*M.MiB&&(t=new K.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},n,()=>e.clear().size())),B.isWin?yield j.PowerShell.instance().execute(`Copy-Item -LiteralPath ${j.pwshQuote(this.nativePath)} -Destination ${j.pwshQuote(e.nativePath)}`,e=>e):yield F.stdout("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:yield this.copyTimeoutMs()}),C.emitFileCopied(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(t){return this.bflog().throw("_nativeCopyFile("+e+"): "+t)}finally{y.map(t,e=>e.end())}}))}touch(e=Date.now(),t){return n(this,void 0,void 0,(function*(){return this.trap("touch",()=>T.thenMap(this.ensureFile(),()=>this.utimes(e,t)))}))}utimes(e,t){return n(this,void 0,void 0,(function*(){const i=y.orElse(e,Date.now()),n=y.orElse(t,i);return this.trap("utimes",()=>te.utimes(this.nativePath,I.unixtime(n),I.unixtime(i)).then(()=>this.clearThisAndParent()))}))}unlink(e="warn"){return n(this,void 0,void 0,(function*(){return this.trap("unlink",()=>n(this,void 0,void 0,(function*(){return yield te.unlink(this.nativePath),this.clearThisAndParent()})),e)}))}rmrf(e="info"){return n(this,void 0,void 0,(function*(){return this.trap("rmrf",()=>n(this,void 0,void 0,(function*(){return this.bflog().log(e,"rmrf()"),yield s.remove(this.nativePath),this.clearThisAndParent()})))}))}unlock(){return n(this,void 0,void 0,(function*(){return B.isMac&&(yield this.clear().exists())&&(yield F.stdout("chflags",["nouchg",this.nativePath],{timeout:U.CmdTimeoutMs})),this}))}renameWithNameSuffix(e){return n(this,void 0,void 0,(function*(){return T.thenMap(this.withNameSuffix(e).ensureNew({emptyIsNew:!0}),e=>e.unlink("debug").then(()=>this.mv(e)))}))}mv(e,t={overwrite:!1}){return n(this,void 0,void 0,(function*(){const i=yield this.dest(e);return this.nativePath===i.nativePath?(this.bflog().warn("mv(): no-op",new Error("internal error")),this):(yield i.parent().mkdirp(),yield Promise.all([this.unlock(),i.unlock()]),this.bflog().debug("mv",i),yield s.move(this.nativePath,i.nativePath,t),yield i.unlock(),this.clearThisAndParent(),i.clearThisAndParent())}))}pipeTo(e,t){return n(this,void 0,void 0,(function*(){return this.trap("pipeTo("+e+")",()=>n(this,void 0,void 0,(function*(){const i=yield this.for(this.nativePath+w.ensurePrefix(e,".")).ensureNew();return yield Z.pipelineAsync([r.createReadStream(this.nativePath),t,r.createWriteStream(i.nativePath)]),yield this.unlink(),i})))}))}gzip(){return n(this,void 0,void 0,(function*(){return this.pipeTo(".gz",c.createGzip())}))}compressBrotli(){return n(this,void 0,void 0,(function*(){return this.pipeTo(".br",c.createBrotliCompress())}))}ensureFile(){return this.trap("ensureFile",()=>s.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync(){return s.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return Q.nameWithoutCount(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}ensureNewNativePath(e){return n(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},t.DefaultEnsureNewOptions),e);if(this.clear(),!i.requireNumber&&((yield this.notExists())||i.emptyIsNew&&(yield this.isEmpty())))return this.nativePath;const n=this.parent();yield n.mkdirp();for(let e=i.startIndex;e<=i.maxVersions;e++){const t=n.join(`${this.name}-${V.leftPad(e,i.leftPad,"0")}${this.ext}`);if(t.clear(),(yield t.notExists())||i.emptyIsNew&&(yield t.isEmpty()))return t.nativePath}throw new Error("There are already more than "+i.maxVersions+" of "+this)}))}ensureNew(e={}){return this.ensureNewNativePath(e).then(e=>this.for(e))}renameYMDHMS(e){return n(this,void 0,void 0,(function*(){if(yield this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");const t=yield T.thenMapOr(this.mtime(),e=>o.DateTime.fromJSDate(e),()=>o.DateTime.local()),i=I.dateTimeToLocalSec(t),n=y.mapOr(e,e=>this.parent().join(e),()=>this.parent());return this.mv(n.join(this.name+"-"+i+this.ext),{overwrite:!0})}))}saveIfNewOrDelete(e){return n(this,void 0,void 0,(function*(){if(yield this.clear().isEmpty())return void(yield this.unlink("trace"));const t=yield this.siblingWithSameContents();if(null!=t)return yield this.unlink(),t;const i=yield this.sibling(e).ensureNew();return this.mv(i)}))}chmod(e){return n(this,void 0,void 0,(function*(){return yield te.chmod(this.nativePath,e),this.clear()}))}zreadline(){return u.createInterface({input:r.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe(c.createGunzip()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)})})}siblingWithSameContents(){return n(this,void 0,void 0,(function*(){return this.parent().childWithSameContents(this)}))}childWithSameContents(e){return n(this,void 0,void 0,(function*(){return O.time("fs.childWithSameContents",()=>n(this,void 0,void 0,(function*(){if((yield this.notExists())||!(yield this.isDirectory()))return;const t=yield e.size(),i=yield this.children(),n=[];for(const r of S.toA(i))(yield r.size())!==t||e.eql(r)||n.push(r);if(d.isEmpty(n))return;const r=yield e.sha();for(const e of n.sort((e,t)=>q.diceCoeff(e.base,t.base)).reverse())if((yield e.sha())===r)return e})))}))}applyWip(e){return n(this,void 0,void 0,(function*(){const t=this.wip();try{yield t.parent().mkdirp(),yield t.unlink("debug");const i=yield e(t);if(yield t.clear().isEmpty())throw new Error("applyWip(): builder didn't write to dest");return yield t.unwip(),i}catch(e){throw yield T.tryAll([()=>t.unlink(),()=>this.unlink()]),e}}))}applyIfEmpty(e,t=0){return n(this,void 0,void 0,(function*(){return(yield this.clear().isNonEmpty(t))?(this.bflog().debug("applyIfEmpty(): non-empty"),this):(this.bflog().debug("applyIfEmpty(): empty, applying..."),yield this.applyWip(e),this)}))}firstMatchingLine(e){const t=new x.Deferred("firstMatchingLine("+this+")"),i=r.createReadStream(this.nativePath,{flags:"r"});return i.on("error",e=>{-2===e.errno||"ENOENT"===e.code?(t.maybeResolve(void 0),i.close()):t.maybeReject(e)}),i.on("close",()=>t.maybeResolve(void 0)),X.onDataChunked(i,w.newlineRe,n=>{const r=e.exec(n);null!=r&&(t.maybeResolve(r),i.close())}),t.promise}}t.BaseFile=ne,ne.attrTTL=3*p.minuteMs,ne.projectRoot=v.lazy(()=>{const e=Y.ProjectPath.Root();if(null==e)throw new Error("Cannot find project path");return ne.for(e)}),t.execDir=function(){return ne.for(process.execPath).parent()}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cmpArr=t.gt=t.gte=t.lte=t.lt=t.cmp=t.isPrimitiveArray=t.mapPrimitiveOr=t.mapPrimitive=t.isPrimitive=void 0;const n=i(1),r=i(7),s=["number","string","boolean"];function o(e){return-1!==s.indexOf(typeof e)}t.isPrimitive=o,t.mapPrimitive=function(e,t){return o(e)?t(e):void 0},t.mapPrimitiveOr=function(e,t,i){return o(e)?t(e):i()},t.isPrimitiveArray=function(e){return Array.isArray(e)&&e.every(o)};const a=["boolean","number","bigint","symbol","string","object","function"];function u(e,t){if(null==e&&null==t)return 0;if(null==e)return-1;if(null==t)return 1;const i=typeof e,n=typeof t;return"string"!==i&&"symbol"!==i||"string"!==n&&"symbol"!==n?Array.isArray(e)&&Array.isArray(t)?l(e,t):i!==n?a.indexOf(i)-a.indexOf(n):e>t?1:e<t?-1:0:r.toS(e).localeCompare(r.toS(t))}function l(e,t){if(n.isEmpty(e)&&n.isEmpty(t))return 0;const i=Math.min(e.length,t.length);for(let n=0;n<i;n++){const i=u(e[n],t[n]);if(0!==i)return i}return u(e.length,t.length)}t.cmp=u,t.lt=function(e,t){return u(e,t)<0},t.lte=function(e,t){return u(e,t)<=0},t.gte=function(e,t){return u(e,t)>=0},t.gt=function(e,t){return u(e,t)>0},t.cmpArr=l},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PowerShell=t.pwshQuote=void 0;const r=i(94),s=i(3),o=i(4),a=i(2),u=i(0),l=i(17),c=i(8),d=i(155),h=i(21),f=i(26),p=i(13),m=i(99),g=i(6),v=i(28),y=i(10),b=i(27),w=i(66),S=10*o.minuteMs;p.onClearCache(()=>u.map(P.instance.prior(),e=>e.clearMockResults())),t.pwshQuote=function(e){return'"'+y.splitKeep(e,/['`"ââ#]/g,!0).join("`").replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v")+'"'};class P{constructor(){this.name="PowerShell",this.logger=g.mkLogger("PowerShell"),this.mockResults=new Map,this.pwsh=d.observeBatchCluster(new r.BatchCluster({processFactory:()=>h.execFile("powershell",[],S),versionCommand:'function prompt {"{ready}"}',pass:"{ready}",fail:"Error",exitCommand:"exit",maxProcs:w.maxCpus()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:b.CmdTimeoutMs,cleanupChildProcs:!1}),"PowerShell",l.EndableRanks.db).bc}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return c.thenMap(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,t){this.pushMockResult(y.ensureSuffix(e," | ConvertTo-Json -Compress"),t)}pushMockResult(e,t){this.mockResults.set(e,t)}clearMockResults(){this.mockResults.clear()}execute(e,t){return n(this,void 0,void 0,(function*(){if(this.pwsh.ended||l.ending())this.logger.warn("execute() failed (ended)",{cmd:e});else{if(v.isTest&&this.mockResults.has(e)){const i=this.mockResults.get(e);return t(i.stdout,i.stderr,i.passed)}try{this.logger.debug("execute()",{cmd:e});const i=yield f.elapsedAsync(()=>this.pwsh.enqueueTask(new r.Task(e,(i,n,r)=>t(u.map(i,t=>y.stripPrefix(t,e)),n,r))));return this.logger.log(m.ms2level(i.elapsedMs,7*o.secondMs),"execute()",{cmd:e,elapsedMs:i.elapsedMs}),i.result}catch(t){return void this.logger.warn("execute() failed: "+t,{cmd:e})}}}))}executeJson(e){return n(this,void 0,void 0,(function*(){const t=yield this.execute(y.ensureSuffix(e," | ConvertTo-Json -Compress"),(e,t,i)=>({stdout:e,stderr:t,passed:i}));if(null!=t)if(s.blank(t.stdout)||s.notBlank(t.stderr)||!t.passed)this.logger.warn("executeJson(): failed result",Object.assign({cmd:e},t));else try{return JSON.parse(t.stdout)}catch(e){const i=t.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:y.ellipsize(t.stdout),after:y.ellipsize(i)}),JSON.parse(i)}else this.logger.warn("executeJson(): null result",{cmd:e})}))}executeJsonToA(e){return n(this,void 0,void 0,(function*(){return c.thenMap(this.executeJson(e),e=>Array.isArray(e)?e:[e])}))}}t.PowerShell=P,P.instance=a.lazy(()=>new P)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withBoundedConcurrency=t.serially=t.maybeRun=t.oneRunAtATime=t.Promises=void 0;const r=i(1),s=i(75),o=i(38),a=i(80),u=i(66),l=i(60);class c{constructor(){this._pushCount=0,this._arr=[],this.nextSettledLatches=[],this.serialLatencyAvg=new a.Average}get arr(){return r.filterInPlace(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}push(e,t){this._pushCount++;const i=o.isFunction(t)?t():t;return this.arr.push(new l.Deferred(e).observeQuietly(i).finally(()=>this.emitSettled())),i}emitSettled(){this.nextSettledLatches.forEach(e=>e.resolve()),this.nextSettledLatches.length=0}awaitNextSettled(){const e=new s.Latch;return this.nextSettledLatches.push(e),e}serial(e,t){const i=Date.now();return this.push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-i),t())))}serialByName(e,t){const i=Date.now();return this.push(e,this.awaitAllByName(e).then(()=>(this.serialLatencyAvg.push(Date.now()-i),t())))}oneRunAtATime(e,t){return this.pending?this.awaitAll():this.serial(e,t)}maybeRun(e,t){return this.maybeRunConcurrent(e,t,1)}maybeRunConcurrent(e,t,i=u.maxCpus()){return this.pendingCount>=i?void 0:this.push(e,t)}get pendingCount(){return r.count(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return 0===this.arr.length}awaitAll(){return n(this,void 0,void 0,(function*(){yield Promise.all(this.arr.map(e=>n(this,void 0,void 0,(function*(){yield e.promise}))))}))}awaitAllByName(e){return n(this,void 0,void 0,(function*(){yield Promise.all(this.arr.filter(t=>t.name===e).map(e=>n(this,void 0,void 0,(function*(){yield e.promise}))))}))}}t.Promises=c,t.oneRunAtATime=function(e,t){const i=new c;return()=>i.oneRunAtATime(e,t)},t.maybeRun=function(e,t){const i=new c;return()=>i.maybeRun(e,t)},t.serially=function(e,t){const i=new c;return()=>i.serial(e,t)},t.withBoundedConcurrency=function({name:e,laters:t,maxConcurrent:i=u.maxCpus()}){return n(this,void 0,void 0,(function*(){const n=[],r=new c;for(const s of t){for(;r.pendingCount>=i;)yield r.awaitNextSettled();n.push(r.push(e,s))}return Promise.all(n)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOp=t.firstDefinedThunk=t.tot=void 0;const n=i(38);t.tot=function(e){return n.isFunction(e)?e():e},t.firstDefinedThunk=function(e){for(const t of e){const e=t();if(null!=e)return e}},t.NoOp=()=>{}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.eqlAsyncPicked=t.eqlAsync=t.definedAndNotEql=t.definedAndEql=t.eql=void 0;const r=i(0),s=i(11),o=i(201);function a(e,t){return o(e,t)}t.eql=a,t.definedAndEql=function(e,t){return null!=e&&null!=t&&a(e,t)},t.definedAndNotEql=function(e,t){return null!=e&&null!=t&&!a(e,t)},t.eqlAsync=function(e,t){return n(this,void 0,void 0,(function*(){return r.map2Or(yield e,yield t,a,()=>!1)}))},t.eqlAsyncPicked=function(e,t,...i){return n(this,void 0,void 0,(function*(){return r.map2Or(yield e,yield t,(e,t)=>a(s.pick(e,...i),s.pick(t,...i)),()=>!1)}))}},function(e,t){e.exports=require("fs")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.App=t.AppPaths=void 0;const n=i(19),r=i(2),s=i(11),o=i(36),a=i(136),u=i(103),l=i(30),c=i(86),d=i(28),h=i(9);t.AppPaths=o.strEnum("exe","home","appData","userData","pictures","cache"),function(e){e.getName=()=>u.AppName,e.exe=r.lazy(()=>n.execPath),e.home=r.lazy(()=>c.homeDir()),e.appData=r.lazy(()=>a.appData()),e.appName=r.lazy(()=>u.AppName+(d.isProd?"":"-"+d.nodeEnv)),e.userData=r.lazy(()=>l.resolve(e.appData(),e.appName())),e.pictures=r.lazy(()=>l.resolve(e.home(),"Pictures")),e.cache=()=>h.Settings.cacheDir.valueOrDefault,e.getPath=t=>s.maybeCall(e,t),e.setPath=(t,i)=>{"cache"===t?h.Settings.cacheDir.tmpValue=i:e[t].set(l.resolve(i))}}(t.App||(t.App={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isMimetypeSupported=t.extractShortExt=t.extType=t.ExtTypes=t.isBrowserExt=t.BrowserExts=t.BrowserImgExts=t.isExifExt=t.AllExifExts=t.isAssetFileExt=t.AssetFileExts=t.isSidecarExt=t.SidecarExts=t.SidecarExtsEnum=t.isVideoExt=t.VideoExts=t.BaseVideoExts=t.isRawImageExt=t.RawImageExts=t.BaseRawImageExts=t.isSharpMimetype=t.sharpSupportedMimeTypes=t.isSharpExt=t.SharpImageExts=t.BaseSharpImageExts=t.isHeifEnabled=t.normalizeExt=t.asExt=t.fileExtsToDesc=void 0;const n=i(72),r=i(1),s=i(3),o=i(2),a=i(0),u=i(36),l=i(44),c=i(7),d=i(206),h=i(24),f=i(10);t.fileExtsToDesc=[[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["DNG"],"Digital Negative (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HEIC","HEIF"],"High Efficiency Image Format (QuickTime-based)"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PNG"],"Portable Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["THM"],"Thumbnail image (JPEG)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["XMP"],"Extensible Metadata Platform sidecar file"]];const p=t.fileExtsToDesc.map(([e])=>e),m=new Map(r.flatten(p.map(e=>e.map(t=>[v(t),v(e[0])]))));function g(e){return r.flatten(r.compact(e.map(e=>e.toUpperCase()).map(e=>p.find(t=>t.includes(e))))).map(v)}function v(e){return f.ensurePrefix(e,".").toUpperCase()}function y(e){return s.mapNotBlank(e,v)}function b(e){const t=o.lazy(()=>new Set(r.compactBlanks(l.tot(e).map(y))));return e=>a.orElse(a.map(y(e),e=>t().has(e)),!1)}t.asExt=v,t.normalizeExt=function(e){if(s.blank(e))return e;const t=v(e);return a.orElse(m.get(t),t)},t.isHeifEnabled=o.lazy(()=>h.mapAnd(n.format.heif,e=>e.input.file)),t.BaseSharpImageExts=o.lazy(()=>r.compact(["GIF",t.isHeifEnabled()?"HEIC":void 0,"JPEG","PNG","PPM","TIFF","THM","WEBP"])),t.SharpImageExts=o.lazy(()=>g(t.BaseSharpImageExts())),t.isSharpExt=b(t.SharpImageExts),t.sharpSupportedMimeTypes=o.lazy(()=>new Set(r.compact(["image/gif",...t.isHeifEnabled()?["image/heic","image/heif"]:[],"image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"]))),t.isSharpMimetype=function(e){return t.sharpSupportedMimeTypes().has(c.toS(e).toLowerCase())},t.BaseRawImageExts=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"],t.RawImageExts=g(t.BaseRawImageExts),t.isRawImageExt=b(t.RawImageExts),t.BaseVideoExts=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"],t.VideoExts=g(t.BaseVideoExts),t.isVideoExt=b(t.VideoExts),t.SidecarExtsEnum=u.strEnum("EXIF","EXV","MIE","XMP"),t.SidecarExts=g(t.SidecarExtsEnum.values),t.isSidecarExt=b(t.SidecarExts),t.AssetFileExts=o.lazy(()=>[...t.SharpImageExts(),...t.RawImageExts,...t.VideoExts].sort()),t.isAssetFileExt=b(t.AssetFileExts),t.AllExifExts=o.lazy(()=>[...t.AssetFileExts(),...t.SidecarExts].sort()),t.isExifExt=b(t.AllExifExts),t.BrowserImgExts=g(["JPEG","PNG"]),t.BrowserExts=g(["GIF","JPEG","MP4","PNG","WEBM","WEBP"]),t.isBrowserExt=b(t.BrowserExts),t.ExtTypes=u.strEnum("image","raw","video"),t.extType=function(e){return t.isSharpExt(e)?t.ExtTypes.image:t.isRawImageExt(e)?t.ExtTypes.raw:t.isVideoExt(e)?t.ExtTypes.video:void 0};const w=/\.[a-z0-9]{2,4}$/i;t.extractShortExt=function(e){return a.map(w.exec(c.toS(e)),e=>e[0])};const S=["image/gif","image/jpeg","image/pjpeg","image/png","image/webp"],P=["image/gif","image/jpeg","image/png"];t.isMimetypeSupported=function(e,t){return(d.isChrome(t)||d.isFirefox(t)?S:P).includes(c.toS(e))}},function(e,t){e.exports=require("os")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WrappedError=void 0;const n=i(1),r=i(3),s=i(18),o=i(7),a=i(23),u=i(10);class l extends Error{constructor({cause:e,message:t,retriable:i=!0,ignorable:l=!1,fatal:c=!1}){super(function(e,t,i,l,c){const d=[e];s.Opt(t).flatMap(e=>e.message).flatMap(e=>u.stripPrefix(e,"Error: ")).forEach(e=>d.push(e));const h=n.compactBlanks(d).map(e=>o.toS(e).trim()).filter(r.notBlank).join(": "),f=[];return c||i||f.push(a.NonRetriableErrorFlag),l&&!c&&f.push(a.IgnorableErrorFlag),c&&f.push(a.FatalErrorFlag),n.isNotEmpty(f)&&f.unshift(" "),h+f.filter(e=>!h.includes(e)).join("")}(t,e,i,l,c)),this.cause=e,this.retriable=i,this.fatal=c}}t.WrappedError=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setZone=t.zoneToOffset=t.hasTime=t.dateBetween=t.nowish=t.gtDate=t.closeTo=t.diffMillis=t.sameDay=t.toFuzzyDate=t.datedToYMD=t.fromISO=t.datedToISO=t.datedToPrecisionMs=t.datedToOffsetMinutes=t.datedToMillis=t.toDate=t.toExifDateTime=t.toDateTime=t.parseExifDateTime=t.getZoneName=t.hasZone=t.zoneOffsetToName=t.getSecMs=t.hasSeconds=t.getMillisecond=t.getSecond=t.getMinute=t.getHour=t.getDay=t.getMonth=t.getYear=t.isDated=t.parseYMD=t.extractDateFromPath=t.clearIgnorableSubpaths=t.addIgnorableSubpath=t.FuzzyDateParser=t.parseDated=t.parseDateTime=t.agoMs=t.dateTimeBetween=t.isoToOffsetMinutes=t.FuzzyDate=t.validYMD=t.validDay=t.validMonth=t.validYear=t.maxMonth=t.maxYear=t.minYear=t.mapValidDate=t.validDate=void 0;const n=i(98),r=i(73),s=i(1),o=i(3),a=i(4),u=i(2),l=i(0),c=i(5),d=i(18),h=i(7),f=i(12),p=i(116),m=i(45),g=i(16),v=i(24),y=i(10),b=i(41);function w(e,t=2){return null==e?"":y.leftPad(e,t,"0")}function S(e){if(null==e||"string"==typeof e||0===e)return!1;const t=ne(e);return null!=t&&0!==t&&(!!x(q(e),W(e),U(e))&&(!ue(e)||l.mapOr(ee(e),e=>e.isValid,()=>!1)))}function P(e){return g.within(t.minYear,t.maxYear,e)}function M(e,i){return(!b.gte(i,t.maxYear)||!b.gt(e,t.maxMonth))&&g.within(1,12,e)}function E(e,t,i){return null!=i&&r.DateTime.fromObject({year:e,month:t,day:i}).isValid}function x(e,t,i){return P(e)&&(null==t||M(t,e)&&(null==i||E(e,t,i)))}t.validDate=S,t.mapValidDate=function(e,t){return S(e)?t(e):void 0},t.minYear=1826,t.maxYear=new Date(Date.now()+a.weekMs).getFullYear(),t.maxMonth=new Date(Date.now()+a.weekMs).getMonth()+1,t.validYear=P,t.validMonth=M,t.validDay=E,t.validYMD=x;class _{constructor(e,t,i){this.year=e,this.month=t,this.day=i}static for(e,t,i){return x(e,t,i)?new _(e,t,i):void 0}static localToday(){return oe(new Date)}toString(){return s.compact([this.year,this.month,this.day]).map(e=>w(e)).join("-")}toISOString(){return this.toString()}toDateTime(){return r.DateTime.fromObject(this)}}t.FuzzyDate=_;class T{constructor(e,t,i,n,r){this.monthsToMonth=e,this.re=t,this.yearIndex=i,this.monthIndex=n,this.dayIndex=r}apply(e){const t=this.re.exec(e);if(null!=t){const e=parseInt(t[this.yearIndex],10),i=this.month(t),n=null==this.dayIndex?void 0:parseInt(t[this.dayIndex],10);return _.for(e,i,n)}}month(e){if(null==this.monthIndex)return;const t=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(t)?this.monthsToMonth.get(t):c.toInt(t)}}const D="((?:19|20)[0-9]{2})",O="([1-3][0-9]|0?[1-9])",F="([0-5][0-9])",I=F,k=F,C="([-\\.\\,:_/ |])?",A="(?:(Z)|(?:([+-])([01][0-9]):?([0-5][0-9])))",L=new RegExp("\\d\\d"+A+"(?:\\/|$)","i");function R(e,t){if(s.isEmpty(e))return t;const[i,n]=e.splice(0,2),[r,o]=e.splice(0,2).map(e=>c.toInt(e));return y.equalsIgnoreCase(i,"z")?0:f.anyNotDefined([n,r,o])?t:("-"===n?-1:1)*(60*r+o)}function N(e){return o.mapNotBlank(e,e=>v.firstTrueThunk([()=>n.ExifDateTime.fromEXIF(e),()=>X(e)],e=>S(e)))}t.isoToOffsetMinutes=function(e){return l.map(L.exec(e),e=>R(e.slice(1)))},t.dateTimeBetween=function(e,t){return e.until(t).divideEqually(2)[0].end},t.agoMs=function(e){return c.mapNumeric(ne(e),e=>Date.now()-e)},t.parseDateTime=N,t.parseDated=function(e){return o.mapNotBlank(e,e=>v.firstTrueThunk([()=>p.DateInterval.fromISO(e),()=>N(e),()=>n.ExifDate.fromEXIF(e),()=>z().parseYMD(e),()=>new Date(e)],e=>S(e)))};class B{constructor(e){this.locale=e,this.monthsToMonth=new Map,this.ymdPatterns=[],this.ymPatterns=[],this.setup()}parseYMD(e){return f.first(this.ymdPatterns,t=>t.apply(e))}addParser(e,t,i,n){const r=new T(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),t,i,n);null!=n&&null!=i?this.ymdPatterns.push(r):null!=i&&this.ymPatterns.push(r)}setup(){["short","long"].forEach(e=>{const t=new Intl.DateTimeFormat(this.locale,{month:e});c.times(12,e=>{const i=t.format(new Date(2017,e));this.monthsToMonth.set(i.toLowerCase(),e+1)})});const e="("+s.sort([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(D+C+"(1[0-2]|0?[1-9])\\2"+O,1,3,4),this.addParser(D+C+e+"\\2"+O,1,3,4),this.addParser(e+C+O+",?\\2"+D,4,1,3),this.addParser(O+C+e+",?\\2"+D,4,3,1),this.addParser(e+C+D,3,1),this.addParser(D+C+e,1,3)}extractDateFromPath(e){V.forEach(t=>{s.startsWith(e,t)&&e.splice(0,t.length)}),e=e.filter(t=>o.notBlank(t)&&null==e[0].match(j));const t=[...e].reverse();return v.firstThunk(()=>f.first(t,e=>this.parseYMD(e)),()=>this.parseYMD(t.join(" ")),()=>this.parseYMD(e.join(" ")),()=>f.first(this.ymPatterns,t=>t.apply(e.join(" "))),()=>f.first(this.ymPatterns,e=>e.apply(t.join(" "))))}}t.FuzzyDateParser=B;const j=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P)\d+)$/i,z=u.lazy(()=>new B(void 0)),V=[];function q(e){return l.map(e,e=>e instanceof Date?e.getFullYear():e.year)}function W(e){return l.map(e,e=>e instanceof Date?e.getMonth()+1:e.month)}function U(e){return l.map(e,e=>e instanceof Date?e.getDate():e.day)}function H(e){return ue(e)?e instanceof Date?e.getHours():e.hour:void 0}function G(e){return ue(e)?e instanceof Date?e.getMinutes():e.minute:void 0}function J(e){return ue(e)?e instanceof Date?e.getSeconds():e.second:void 0}function $(e){return ue(e)?e instanceof Date?e.getMilliseconds():e.millisecond:void 0}function Q(e,t=!0){if(null==e)return;if(0===e)return t?"UTC":"";const i=e<0?"-":"+",n=15*c.round(e/15),r=Math.abs(n),s=Math.floor(r/60),o=Math.floor(Math.abs(r%60));return`${t?"UTC":""}${i}${w(s)}:${w(o)}`}function K(e){return e instanceof n.ExifDateTime?e.hasZone:e instanceof r.DateTime&&(null!=e.zone&&"local"!==e.zone.type)}function Y(e){return e instanceof r.DateTime?l.map(e.zone,e=>e.name):e instanceof n.ExifDateTime?e.zone:void 0}function X(e,t=Z){const i=t.exec(e);if(null==i)return;const n=[...i.slice(1)],[s,o,a,u,l,h]=n.splice(0,6).map(e=>c.toInt(e)),f=c.clamp(0,999,1e3*c.toFloat(n.shift(),{defaultValue:0})),p=Q(R(n));return d.Opt(r.DateTime.fromObject({year:s,month:o,day:a,hour:u,minute:l,second:h,millisecond:f,zone:p})).filter(e=>e.isValid).flatMap(e=>te(e,p)).get()}t.addIgnorableSubpath=function(e){V.push(e)},t.clearIgnorableSubpaths=function(){V.length=0},t.extractDateFromPath=function(e){return z().extractDateFromPath(e)},t.parseYMD=function(e){return z().parseYMD(e)},t.isDated=function(e){return null!=e&&(e instanceof _||e instanceof n.ExifDate||e instanceof n.ExifDateTime||e instanceof Date||e instanceof p.DateInterval||e instanceof r.DateTime||l.allDefined([e.year,e.month,e.day]))},t.getYear=q,t.getMonth=W,t.getDay=U,t.getHour=H,t.getMinute=G,t.getSecond=J,t.getMillisecond=$,t.hasSeconds=function(e){return ue(e)&&(c.gt0(G(e))||c.gt0(J(e))||c.gt0($(e)))},t.getSecMs=function(e){return l.map(J(e),t=>{const i=l.orElse($(e),0);let n=(t+i/1e3).toString();for(t<10&&(n="0"+n),0===i&&(n+=".");n.length<6;)n+="0";return n})},t.zoneOffsetToName=Q,t.hasZone=K,t.getZoneName=Y,t.parseExifDateTime=X;const Z=new RegExp([D,"(1[0-2]|0[1-9])","([1-3][0-9]|0[1-9])","(1[0-9]|2[0-3]|0[0-9])",I,k,"(?:(\\.[0-9]+))?"].join("[-:_ ]?")+A+"?","i");function ee(e){return e instanceof r.DateTime?e:e instanceof n.ExifDateTime?e.toDateTime():e instanceof p.DateInterval?e.middle.toDateTime():e instanceof Date?r.DateTime.fromJSDate(e):void 0}function te(e,t){if(null==e||!ue(e))return;if(e instanceof r.DateTime)return n.ExifDateTime.fromDateTime(e);const i=ne(e);if(null==i)return;const s=o.blank(t)?K(e)?Y(e):void 0:t,a=o.mapNotBlank(s,e=>le(i,e));if(null!=t&&null==a)return;const u=l.map(q(e),t=>l.map(W(e),i=>l.map(U(e),r=>l.map(H(e),s=>new n.ExifDateTime(t,i,r,s,l.orElse(G(e),0),l.orElse(J(e),0),$(e),a,e.rawValue)))));return S(u)?u:void 0}function ie(e){if(null==e)return;if("number"==typeof e)return new Date(e);if(e instanceof Date)return e;if(e instanceof r.DateTime)return e.toJSDate();if(null!=e.toDate)return e.toDate();if(c.gt0(e.year)&&c.gt0(e.month)&&c.gt0(e.day))return new Date(e.year,l.orElse(e.month,1)-1,e.day,12);const t=h.toS(e);return o.notBlank(t)?l.map(re(t),ie):void 0}function ne(e){if(null!=e&&!y.isString(e))return c.isNumber(e)?e:e instanceof Date?e.getTime():e instanceof r.DateTime?e.toMillis():l.map(ie(e),e=>e.getTime())}function re(e,t){return"string"!=typeof e||o.blank(e)?void 0:d.Opt(n.ExifDateTime.fromISO(e,t)).orElse(()=>n.ExifDate.fromISO(e)).orElse(()=>n.ExifTime.fromEXIF(e)).get()}function se(e,t="-"){return s.compact([q(e),W(e),U(e)]).map(e=>w(e)).join(t)}function oe(e){return l.map(e,e=>l.map(q(e),t=>new _(t,W(e),U(e))))}function ae(e,t){const[i,n]=[e,t].map(ne);return null==i||null==n?void 0:i-n}function ue(e){return e instanceof Date||e instanceof n.ExifDateTime||e instanceof r.DateTime}function le(e,t){const i=r.Info.normalizeZone(t);return i.isValid?i.offset(e):void 0}t.toDateTime=ee,t.toExifDateTime=te,t.toDate=ie,t.datedToMillis=ne,t.datedToOffsetMinutes=function(e){return l.map(e,e=>e instanceof n.ExifDateTime?e.tzoffsetMinutes:e instanceof r.DateTime?e.offset:void 0)},t.datedToPrecisionMs=function(e){return l.map(e,e=>e instanceof r.DateTime||e instanceof n.ExifDateTime||e instanceof Date?0:e instanceof n.ExifDate?a.dayMs:e instanceof p.DateInterval?e.intervalMs:void 0)},t.datedToISO=function(e,t=!0){if(e instanceof p.DateInterval)return e.toString(t);const i=c.isNumber(e)?new Date(e):e;return ue(i)?l.map(te(i),e=>e.toISOString({includeOffset:t})):se(i)},t.fromISO=re,t.datedToYMD=se,t.toFuzzyDate=oe,t.sameDay=function(e,t){return m.eql(oe(e),oe(t))},t.diffMillis=ae,t.closeTo=function(e,t,i){return l.mapOr(ae(e,t),e=>Math.abs(e)<i,()=>!1)},t.gtDate=function(e,t){const i=ne(e),n=ne(t);return null!=i&&null!=n&&i>n},t.nowish=function(e,t=2500){const i=ne(e),n=Date.now();return g.within(n-t,n+t,i)},t.dateBetween=function(e,t,i=1,n=1){if(null==ne(e)||null==ne(t))return;const[s,o]=[e,t].map(e=>ne(e)).sort(),a=(o-s)/(n+1),u=Y(e),l=u===Y(t)?u:void 0,c=r.DateTime.fromMillis(s+a*i,{zone:l});return[e,t].some(e=>!ue(e))?oe(c):c},t.hasTime=ue,t.zoneToOffset=le,t.setZone=function(e,t){return e instanceof r.DateTime?e.setZone(t,{keepLocalTime:!0}):te(e,t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jaccard=t.cosineSimilarity=t.dot=t.l2norm=t.centroid=t.euclidean=t.avgWeighted=t.weightedAvg=t.stdDev=t.variance=t.avgMaybe=t.slope=t.avg=t.sum=t.mode=t.modes=t.deltas=t.max=t.min=void 0;const n=i(1),r=i(0),s=i(5),o=i(15),a=i(104),u=i(16),l=i(89);function c(e,t){const i=new a.CountingSet;return o.toA(e).forEach(e=>s.mapFinite(e,e=>i.incr(e))),i.topKeys(t)}function d(e){return o.toA(e).reduce((e,t)=>e+t,0)}function h(e){const t=o.toA(e);return n.isEmpty(t)?void 0:t.reduce((e,t,i)=>0===i?t:e*i/(i+1)+t/(i+1),0)}function f(e){return r.map(h(e),t=>h(e.map(e=>Math.pow(e-t,2))))}function p(e){return Math.sqrt(e.reduce((e,t)=>e+t*t,0))}function m(e,t){return e.reduce((e,i,n)=>e+i*t[n],0)}t.min=function(e){let t;for(const i of e)null!=i&&(null==t||i<t)&&(t=i);return t},t.max=function(e){let t;for(const i of e)null!=i&&(null==t||i>t)&&(t=i);return t},t.deltas=function(e){const t=o.toA(e);return null==e||t.length<=1?[]:t.slice(1).map((t,i)=>t-e[i])},t.modes=c,t.mode=function(e){return c(e,1)[0]},t.sum=d,t.avg=h,t.slope=function(e){const t=o.toA(e);return r.map(h(t),e=>{const i=(t.length-1)/2,n=d(t.map((t,n)=>(t-e)*(n-i))),r=d(t.map(t=>Math.pow(t-e,2)));return 0===r?0:n/r})},t.avgMaybe=function(...e){const t=n.compact(e);return n.isEmpty(t)?void 0:d(t)/t.length},t.variance=f,t.stdDev=function(e){return r.map(f(e),e=>Math.sqrt(e))},t.weightedAvg=function(e){let t;for(const i of e)t=null==t?i:(t+i)/2;return null==t?NaN:t},t.avgWeighted=function(e,t){let i=0;return e.reduce((e,n,r)=>{const s=u.mapGt0Or(t[r],e=>e,1);return i+=s,e+n*s},0)/i},t.euclidean=function(e,t){return Math.sqrt(o.toA(e).reduce((e,i,n)=>e+Math.pow(i-t[n],2),0))},t.centroid=function(e){return s.times(e[0].length,t=>h(e.map(e=>e[t])))},t.l2norm=p,t.dot=m,t.cosineSimilarity=function(e,t){return s.finiteOrElse(m(e,t)/(p(e)*p(t)),void 0)},t.jaccard=function(e,t){return n.isEmpty(e)&&n.isEmpty(t)?0:s.finiteOrElse(l.intersection(e,t).size/l.union(e,t).size,void 0)}},function(e,t){e.exports=require("timers")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrSet=void 0,t.getOrSet=function(e,t,i){if(null==t)throw new Error("null key");if(e.has(t))return e.get(t);{const n=i();return null!=n&&e.set(t,n),n}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedMap=void 0;const n=i(79),r=i(211);class s extends n.TTLMap{constructor(e,t,i){super(e,new r.MRUMap(t,i)),this.maxSize=t,this.fifo=i}}t.BoundedMap=s},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.retryOnReject=t.thenOrTimeout=void 0;const r=i(34),s=i(0),o=i(5),a=i(18);function u(e,t){return n(this,void 0,void 0,(function*(){let i;return Promise.race([e().then(e=>null==i?(i=!0,e):void 0),r.unrefDelay(t).then(()=>{if(null==i)throw i=!1,new Error("timeout")})])}))}t.thenOrTimeout=u,t.retryOnReject=function(e,t){return n(this,void 0,void 0,(function*(){const i=o.gt0(t.timeoutMs)?()=>u(e,t.timeoutMs):e;if(t.maxRetries<=0)return i();const l=a.Opt(t.errorIsRetriable).getOrElse(()=>()=>!0),c=a.Opt(t.onRetryWaitUntil).getOrElse(()=>e=>r.delay(250*s.orElse(e,1)));let d=0;const h=()=>n(this,void 0,void 0,(function*(){try{return yield i()}catch(e){if((yield l(e))&&d<t.maxRetries)return d++,yield c(d),h();throw e}}));return h()}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TokenRadix=t.GeoRadix=t.RadixAlphaNum=t.Radix58=t.Hex=t.Radix=void 0;const n=i(109),r=i(3),s=i(0),o=i(212),a=i(24),u=i(10),l=BigInt(0);class c{constructor(e,t,i=a.identity){this.name=e,this.numerals=t,this.decodePreparser=i,this.base=t.length}digitsToNumerals(e){return e.map(e=>this.numerals[e]).join("")}encode(e,t=0){const i=[],n=e<0;if(n&&t--,0===(e=Math.abs(e)))i.push(0);else for(;e>0;)i.push(e%this.base),e=Math.floor(e/this.base);for(;i.length<t;)i.push(0);return(n?"-":"")+this.digitsToNumerals(i.reverse())}encodeBigInt(e){if("bigint"!=typeof e)throw new Error("bad input");if(e===l)return this.numerals[0];const t=[],i=BigInt(this.base);let n=e;for(;n>l;)t.push(Number(n%i)),n/=i;return this.digitsToNumerals(t.reverse())}encodeBuffer(e){if(null==e||0===e.length)return"";const t=[0];for(let i of e)for(t.forEach((e,n)=>{i+=e<<8,t[n]=i%this.base,i=Math.floor(i/this.base)});i>0;)t.push(i%this.base),i=Math.floor(i/this.base);return this.digitsToNumerals(t.reverse())}decode(e){return s.map(this.decodeBigInt(e),t=>{if(t>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(t)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(null==e||r.blank(e))return;const t="-"===(e=this.decodePreparser(e))[0];t&&(e=e.slice(1));const i=BigInt(this.base);let n=BigInt(0);for(const t of e){const e=this.numerals.indexOf(t);if(e<0)return;n=n*i+BigInt(e)}return t?BigInt(-1)*n:n}randomChars(e){return this.encodeBuffer(n.randomBytes(e+3)).slice(1,e+1)}randomUid(e=20,t=5){return u.splitEvery(this.randomChars(e),t).join("-")}safeRandomUid(e,t=5){let i="";do{i=this.randomUid(e,t)}while(o.isCussy(i));return i}}t.Radix=c,t.Hex=new c("hex","0123456789abcdef",e=>e.toLowerCase()),t.Radix58=new c("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.RadixAlphaNum=new c("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",e=>e.toLowerCase()),t.GeoRadix=new c("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",e=>e.toLowerCase()),t.TokenRadix=new c("TokenRadix","0123456789abcdefghjkmnpqrtuvwxyz",e=>e.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[s]/g,"5"))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazyFsAsync=void 0;const n=i(56),r=i(2),s=i(23),o=i(13),a=i(67),u=i(27);t.lazyFsAsync=function(e){const t=r.lazy(()=>n.retryOnReject(e,{maxRetries:2,timeoutMs:u.CmdTimeoutMs,errorIsRetriable:e=>s.isIgnorableError(e)}),u.LongTtlMs);return a.mountpoints.onChange(()=>t.unset()),o.onClearCache(()=>t.unset()),t}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEnvTrue=t.getEnv=void 0;const n=i(19),r=i(11),s=i(22);function o(e){return r.firstValueCaseInsensitive(n.env,e)}t.getEnv=o,t.isEnvTrue=function(e){return s.isTrue(o(e))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0;const n=i(53),r=i(33),s=i(37),o=i(20),a=i(0),u=i(25),l=i(6),c=i(28),d=i(10),h=i(63);class f{constructor(e){this.name=e,this.start=Date.now(),this.state=u.PromiseStates.pending,this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t}),this.logger=l.mkLogger("Deferred("+this.toString()+")")}toString(){return d.isString(this.name)?this.name:o.stringify(this.name)}[r.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(e=>{this.resolve(e)}).catch(e=>{this.logger.log(c.isTest?"warn":"error","observeQuietly.reject()",e),this.resolve(void 0)}),this}observe(e){return e.then(e=>{this.maybeResolve(e)}).catch(e=>{this.maybeReject(e)}),this}setTimeout(e){return a.map(this.priorTimeout,n.clearTimeout),this.priorTimeout=h.setUnrefTimeout(()=>{if(this.pending){const e="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(e)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===u.PromiseStates.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==u.PromiseStates.pending}get resolved(){return this.state===u.PromiseStates.resolved}get rejected(){return this.state===u.PromiseStates.rejected}get settledMs(){return null==this.end?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=u.PromiseStates.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(c.isTest?"warn":"error",".reject()",e);const t=s.asError(e);return this.settle(()=>{this._error=t,this.state=u.PromiseStates.rejected,this._reject(t)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(t=>e(t))}settle(e){if(this.state===u.PromiseStates.pending){a.map(this.priorTimeout,n.clearTimeout),e(),this.end=Date.now();const t=this.settledMs;if(this.resolved&&t>5e3){const e=t>5e3?"info":"debug";this.logger.log(e,"Completed in "+t+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}}t.Deferred=f},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ByteCounter=t.remoteDesc=t.pipelineAsync=t.closeStreams=t.onError=t.close=t.end=t.PassthroughStream=t.ReadableBuffer=void 0;const r=i(141),s=i(33),o=i(34),a=i(0),u=i(11),l=i(44),c=i(17),d=i(23),h=i(24);class f extends r.Readable{constructor(e){super(),this.push(e),this.push(null)}}t.ReadableBuffer=f;class p extends r.Duplex{_write(e,t){this.push(e,t)}}t.PassthroughStream=p,t.end=function(e){return n(this,void 0,void 0,(function*(){null!=e&&(h.Try(()=>u.maybeCall(e,"unref")),c.ending()?e.end(null):yield new Promise(t=>e.end(null,t)),yield o.delay(50),h.Try(()=>u.maybeCall(e,"destroy")))}))},t.close=function(e){return n(this,void 0,void 0,(function*(){null!=e&&(h.Try(()=>u.maybeCall(e,"unref")),c.ending()?e.close(l.NoOp):yield new Promise(t=>e.close(t)))}))},t.onError=function(e,t){[{name:"cp",ea:e},{name:"stdin",ea:e.stdin},{name:"stdout",ea:e.stdout},{name:"stderr",ea:e.stderr}].forEach(({name:e,ea:i})=>a.map(i,i=>i.on("error",i=>{d.isIgnorableError(i)||t(e,i)})))},t.closeStreams=function(e){null!=e&&[e.stdin,e.stdout,e.stderr].forEach(e=>h.Try(()=>a.map(e,e=>e.destroy())))},t.pipelineAsync=s.promisify(r.pipeline),t.remoteDesc=function(e){return e.destroyed?"destroyed":`${e.remoteFamily}:${e.remoteAddress}:${e.remotePort}`};class m extends r.Transform{constructor(e){super({transform:(e,t,i)=>{this.onProgress(this.bytes+=e.length),i(e)}}),this.onProgress=e,this.bytes=0}}t.ByteCounter=m},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.firstDefinedLater=t.laterPromise=t.Later=void 0;const r=i(22);!function(e){e.and=(...e)=>n(this,void 0,void 0,(function*(){for(const t of e)if(!r.isTrue(yield t()))return!1;return!0})),e.or=(...e)=>n(this,void 0,void 0,(function*(){for(const t of e)if(r.isTrue(yield t()))return!0;return!1}))}(t.Later||(t.Later={})),t.laterPromise=function(e){let t,i;return{promise:new Promise((e,n)=>{t=e,i=n}),later:()=>n(this,void 0,void 0,(function*(){try{const i=yield e();return t(i),i}catch(e){throw i(e),e}}))}},t.firstDefinedLater=function(...e){return n(this,void 0,void 0,(function*(){if(null!=e)for(const t of e){if(null==t)continue;const e=yield t();if(null!=e)return e}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setUnrefInterval=t.setUnrefTimeout=void 0;const n=i(53),r=i(11);t.setUnrefTimeout=function(e,t,...i){return r.tap(n.setTimeout(e,Math.round(t),...i),e=>e.unref())},t.setUnrefInterval=function(e,t,...i){return r.tap(n.setInterval(e,Math.round(t),...i),e=>e.unref())}},function(e,t){e.exports=require("fs-extra")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gitDate=t.gitSha=t.release=t.version=void 0,t.version="0.8.0-beta.10",t.release="0.8.0-beta.10+20200623202207",t.gitSha="260518948846075501743e5bc3c588d8fd2551df",t.gitDate=new Date(1592943727e3)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.minPending=t.maxPending=t.maxCpus=void 0;const n=i(49),r=i(4),s=i(2),o=i(5),a=i(35),u=i(9);t.maxCpus=s.lazy(()=>{const e=(n.freemem()+n.totalmem())/2,t=1*a.GB,i=Math.max(1,Math.floor(e/t)),r=Math.floor(u.Settings.cpuLoadPercent.valueOrDefault/100*n.cpus().length);return o.clamp(1,i,r)},r.minuteMs),t.maxPending=s.lazy(()=>2*t.maxCpus()),t.maxCpus.onChange(()=>t.maxPending.unset()),t.minPending=function(){return o.round((t.maxCpus()+t.maxPending())/2)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.findmntPoll=t.gioMountMonitor=t.diskUtilActivity=t.mountpoints=t.localMountpointSetup=t.setRpcMountpointsImpl=t.nonRpcMountpoints=void 0;const r=i(56),s=i(4),o=i(34),a=i(2),u=i(17),l=i(62),c=i(8),d=i(21),h=i(192),f=i(237),p=i(23),m=i(13),g=i(6),v=i(14),y=i(29),b=i(120),w=i(239),S=i(240),P=i(27);let M;t.nonRpcMountpoints=()=>v.isWin?S.mountpointsWin():w.mountpointsPosix(),t.setRpcMountpointsImpl=function(e){M=e,t.localMountpointSetup()},t.localMountpointSetup=a.lazy(()=>n(void 0,void 0,void 0,(function*(){y.isRpcServer()?o.later(()=>n(void 0,void 0,void 0,(function*(){const e=g.mkLogger("Mountpoints.localMountpointSetup()");v.isMac?(e.info("Setting up Mac diskutil activity watcher"),t.mountpoints.setTTL(P.LongMountpointsTtlMs),t.diskUtilActivity()):v.isLinux&&((yield b.isGioSupported())?(e.info("Setting up Linux gio mount monitor"),t.mountpoints.setTTL(P.LongMountpointsTtlMs),t.gioMountMonitor()):(yield E())&&(e.info("Setting up Linux findmnt mount monitor"),t.mountpoints.setTTL(P.LongMountpointsTtlMs),t.findmntPoll()))})),30*s.secondMs).unref():yield c.awaitAll([u.end(t.diskUtilActivity.clear()),u.end(t.gioMountMonitor.clear()),u.end(t.findmntPoll.clear())])}))),t.mountpoints=a.lazy(()=>n(void 0,void 0,void 0,(function*(){const e=yield r.retryOnReject(()=>l.firstDefinedLater(M,t.nonRpcMountpoints),{maxRetries:3,onRetryWaitUntil:e=>o.delay(1500*e)}).catch(e=>{p.onError("mountpoints() failed",e)});return null==e?void 0:e.sort()})),P.MountpointsTtlMs),m.onClearCache(()=>t.mountpoints.unset()),t.diskUtilActivity=a.lazy(()=>h.mkBasicWatchedChild({cmd:"diskutil",args:["activity"],onStdout:f.debounce(()=>t.mountpoints.unset(),1.5*s.secondMs)})),t.gioMountMonitor=a.lazy(()=>h.mkBasicWatchedChild({cmd:b.GioCommand,args:b.GioMountMonitorArgs,onStdout:f.debounce(()=>{b.gioVolumes.unset(),b.mtabEntries.unset(),t.mountpoints.unset()},1.5*s.secondMs)}));const E=a.lazy(()=>n(void 0,void 0,void 0,(function*(){if(!v.isLinux)return!1;try{return 0===(yield d.stdoutResult("findmnt",["--version"],{timeout:P.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}})));t.findmntPoll=a.lazy(()=>h.mkBasicWatchedChild({cmd:"findmnt",args:["--poll"],onStdout:f.debounce(()=>t.mountpoints.unset(),1.5*s.secondMs)}))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.thenOpt=t.OptAsync=void 0;const r=i(0);class s{constructor(e){this.a=e}_map(e,t){return n(this,void 0,void 0,(function*(){const i=null!=this.a?yield this.a():void 0,n=o(i)?yield i.get():i;return null!=n?e(n):t()}))}isDefined(){return n(this,void 0,void 0,(function*(){return this._map(()=>!0,()=>!1)}))}isEmpty(){return n(this,void 0,void 0,(function*(){return this._map(()=>!1,()=>!0)}))}get(){return n(this,void 0,void 0,(function*(){return this._map(e=>e,()=>{})}))}getRequired(){return n(this,void 0,void 0,(function*(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}))}exists(e){return n(this,void 0,void 0,(function*(){return this._map(e,()=>!1)}))}map(e){return new s(()=>n(this,void 0,void 0,(function*(){return this._map(e,()=>{})})))}flatMap(e){return new s(()=>n(this,void 0,void 0,(function*(){return this._map(e,()=>{})})))}filter(e){return new s(()=>n(this,void 0,void 0,(function*(){return this._map(t=>n(this,void 0,void 0,(function*(){return(yield e(t))?t:void 0})),()=>{})})))}catch(e){return new s(()=>this.get().catch(t=>n(this,void 0,void 0,(function*(){return e(t)}))))}forEach(e){return new s(()=>n(this,void 0,void 0,(function*(){const t=yield this.get();return yield r.map(t,e),t})))}getOrElse(e){return n(this,void 0,void 0,(function*(){return r.orElse(yield this.get(),e)}))}orElse(e){return new s(()=>n(this,void 0,void 0,(function*(){const t=yield this.get(),i=null==t?yield e():t;return o(i)?i.get():i})))}}function o(e){return e instanceof s}t.OptAsync=s,t.thenOpt=function(e){return o(e)?e:new s(()=>e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timeStats=t.time=t.PromiseTimer=void 0;const n=i(1),r=i(2),s=i(54),o=i(5),a=i(11),u=i(18),l=i(25),c=i(104),d=i(208),h=i(6),f=i(80),p=i(17);class m{constructor(){this.errors=new c.CountingSet,this.times=new Map}time(e,t,i){const n=Date.now();return l.thenTap(t(),t=>{const r=Date.now()-n;this.push(e,r),null!=i&&i(t,r)}).catch(t=>{throw this.errors.incr(e),null!=i&&i(t,Date.now()-n),t})}stats(e){const t=[...this.times.entries()].filter(([t])=>t.startsWith(e)),i=t.reduce((e,t)=>f.Average.merge(t[1],e),new f.Average),n=t.map(([e,t])=>[e,t.stats()]);return a.fromEntries([["merged",i.stats()],...n])}mkElapsed(e){return new d.Elapsed(e,(e,t)=>this.push(e,t))}push(e,t){s.getOrSet(this.times,e,()=>new f.Average).push(t)}weightedAvg(e){return u.Opt(this.times.get(e)).map(e=>e.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[t,i])=>Object.assign(Object.assign({},e),{[t]:i.n}),{})}weightedAvgs(){return a.compactValues([...this.times.entries()].reduce((e,[t,i])=>Object.assign(Object.assign({},e),{[t]:o.mapFinite(i.weightedSampleAvg,o.round)}),{}))}report(){return n.sortBy([...this.times.entries()],([,e])=>-e.avg*e.n).reduce((e,[t,i])=>Object.assign(Object.assign({},e),{[t]:i.stats()}),{})}}t.PromiseTimer=m;const g=r.lazy(()=>a.tap(new m,e=>new p.EndableWrapper("PromiseTimer",()=>{const t=h.mkLogger("PromiseTimer");t.info("timings:\n",e.report()),n.mapNotEmpty(e.errorCounts(),e=>t.warn("error counts:\n",e))},p.EndableRanks.service)));t.time=function(e,t,i){return g().time(e,t,i)},t.timeStats=function(e){return g().stats(e)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.shortFsStringSha=t.shortStringSha=t.stringSha=t.fileSha=t.HashBits=void 0;const r=i(109),s=i(46),o=i(0),a=i(25),u=i(57);function l(e,i=t.HashBits){return r.createHash("sha512").update(e).digest().slice(0,i/8)}function c(e,t=9,i=u.Radix58,n=224){return i.encodeBuffer(l(e,n)).substring(0,t)}t.HashBits=192,t.fileSha=function(e,i){return n(this,void 0,void 0,(function*(){const n=r.createHash("sha512");let u=0;const l=o.orElse(null==i?void 0:i.msbits,t.HashBits)/8;return yield a.thenCollect(e,e=>new Promise((t,r)=>{const o=s.createReadStream(e,{autoClose:!0});o.on("error",e=>r(e)),o.on("data",e=>{var t;u+=e.length,null===(t=null==i?void 0:i.observer)||void 0===t||t.onProgress(u),n.update(e)}),o.on("end",()=>t())})),n.digest().slice(0,l)}))},t.stringSha=l,t.shortStringSha=c,t.shortFsStringSha=function(e,t=15,i=u.GeoRadix,n=224){return c(e,t,i,n)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.arpWin=t.pingWin=t.nslookupWin=t.fsutil=t.wmic=void 0,t.wmic=()=>"wmic",t.fsutil=()=>"fsutil",t.nslookupWin=()=>"nslookup",t.pingWin=()=>"ping",t.arpWin=()=>"arp"},function(e,t){e.exports=require("sharp")},function(e,t){e.exports=require("luxon")},function(e,t,i){"use strict";function n(e,t){return i=>`[${e}m${i}[${t}m`}Object.defineProperty(t,"__esModule",{value:!0}),t.bgWhite=t.bgCyanBright=t.bgMagentaBright=t.bgBlueBright=t.bgYellowBright=t.bgGreenBright=t.bgRedBright=t.bgDarkGrey=t.bgLightGrey=t.bgCyan=t.bgMagenta=t.bgBlue=t.bgYellow=t.bgGreen=t.bgRed=t.bgBlack=t.white=t.cyanBright=t.magentaBright=t.blueBright=t.yellowBright=t.greenBright=t.redBright=t.darkGrey=t.lightGrey=t.cyan=t.magenta=t.blue=t.yellow=t.green=t.red=t.black=void 0,t.black=n(30,39),t.red=n(31,39),t.green=n(32,39),t.yellow=n(33,39),t.blue=n(34,39),t.magenta=n(35,39),t.cyan=n(36,39),t.lightGrey=n(37,39),t.darkGrey=n(90,39),t.redBright=n(91,39),t.greenBright=n(92,39),t.yellowBright=n(93,39),t.blueBright=n(94,39),t.magentaBright=n(95,39),t.cyanBright=n(96,39),t.white=n(97,39),t.bgBlack=n(40,49),t.bgRed=n(41,49),t.bgGreen=n(42,49),t.bgYellow=n(43,49),t.bgBlue=n(44,49),t.bgMagenta=n(45,49),t.bgCyan=n(46,49),t.bgLightGrey=n(47,49),t.bgDarkGrey=n(100,49),t.bgRedBright=n(101,49),t.bgGreenBright=n(102,49),t.bgYellowBright=n(103,49),t.bgBlueBright=n(104,49),t.bgMagentaBright=n(105,49),t.bgCyanBright=n(106,49),t.bgWhite=n(107,49)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Latch=void 0;t.Latch=class{constructor(e){this.id=e,this._state="pending",this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve()).catch(e=>this.reject(e)),this}observeQuietly(e){return e.then(()=>this.resolve()).catch(()=>this.resolve()),this}get pending(){return"pending"===this._state}get settled(){return!this.pending}get resolved(){return"resolved"===this._state}get rejected(){return"rejected"===this._state}get state(){return this._state}then(e){return this.promise.then(e)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.inverse=t.getLike=t.pickKeys=t.filterInPlace=t.filter=t.toObj=t.toMapAsync=t.toMap=t.compactMap=t.flatMap=t.getOrSetAsync=t.hasAll=void 0;const r=i(1),s=i(0),o=i(15),a=i(12);function u(e){const t=r.compact(e).filter(([e,t])=>null!=e&&null!=t);return new Map(t)}function l(e,t){return new Map([...e.entries()].filter(([e,i])=>t(e,i)))}t.hasAll=function(e,t){return t.every(t=>e.has(t))},t.getOrSetAsync=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=e.get(t);if(null!=n)return n;const r=Promise.resolve(i(t));return e.set(t,r),r.then(i=>{null==i?e.delete(t):e.set(t,i)}),r.catch(()=>{e.delete(t)}),r}))},t.flatMap=function(e,t){return new Map(a.concat(...e.map(e=>t(e))))},t.compactMap=u,t.toMap=function(e,t){return u(r.compact(e).map(t))},t.toMapAsync=function(e,t){return n(this,void 0,void 0,(function*(){if(null==e)return new Map;return u(yield Promise.all(r.compact(o.toA(e)).map(e=>t(e))))}))},t.toObj=function(e){const t={};for(const[i,n]of e)t[i]=n;return t},t.filter=l,t.filterInPlace=function(e,t){[...e.entries()].forEach(([i,n])=>t(i,n)||e.delete(i))},t.pickKeys=function(e,t){return l(e,e=>t.indexOf(e)>=0)},t.getLike=function(e,t){return s.map([...e.entries()].find(([e])=>t(e)),([,e])=>e)},t.inverse=function(e){return new Map([...e.entries()].map(([e,t])=>[t,e]))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFlushMs=t.dateForLog=void 0;const n=i(73),r=i(74),s=i(9),o=Date.now();t.dateForLog=function(e){const t=s.Settings.logElapsedMs.valueOrDefault?n.Duration.fromMillis(e-o).toFormat("hhhh:mm:ss.SSS"):new Date(e).toISOString();return s.Settings.logColor.valueOrDefault?s.Settings.logElapsedMs.valueOrDefault?r.yellow(t):r.darkGrey(t):t},t.DefaultLogFlushMs=500},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickWeightedRandom=t.sample=t.shuffle=t.pickRandom=t.randomChar=t.randomChars=t.RandomChars=t.randomFloat=t.randomInts=t.randomInt=void 0;const n=i(1),r=i(5);function s(e,t,i=[]){if(e=Math.ceil(e),t=Math.floor(t),n.isNotEmpty(i)&&i.length+10>t-e){const r=n.range(e,t).filter(e=>!i.includes(e));return n.mapNotEmpty(r,e=>e[s(0,r.length)])}const r=Math.floor(Math.random()*(t-e))+e;return i.includes(r)?s(e,t,i):r}function o(e,t){return Math.random()*(t-e)+e}function a(e=t.RandomChars){return e[s(0,e.length)]}function u(e){const t=Array(...e);for(let e=t.length-1;e>0;e-=1){const i=Math.floor(Math.random()*(e+1));e!==i&&([t[e],t[i]]=[t[i],t[e]])}return t}t.randomInt=s,t.randomInts=function(e,t,i){const n=[];for(;n.length<i;)n.push(s(e,t,n));return n},t.randomFloat=o,t.RandomChars="0123456789abcdefghijkmnopqrstuvwxyz",t.randomChars=function(e,i=t.RandomChars){let n="";for(let t=0;t<e;t++)n+=a(i);return n},t.randomChar=a,t.pickRandom=function(e){return e[s(0,e.length)]},t.shuffle=u,t.sample=function(e,t){if(t<e.length/10){const i=new Set;for(;i.size<t;)i.add(s(0,e.length));return[...i.keys()].map(t=>e[t])}return u([...e]).slice(0,t)},t.pickWeightedRandom=function(e){if(n.isEmpty(e))return;const t=e.filter(e=>r.gt0(e.priority));let i=o(0,n.sum(t,e=>e.priority));return t.find(e=>(i-=e.priority,i<=0))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLMap=t.Entry=void 0;const n=i(0);class r{constructor(e){this.value=e,this.ctime=Date.now()}touch(){this.ctime=Date.now()}}t.Entry=r;class s{constructor(e,t=new Map){this.ttlMs=e,this.store=t,this.expireListeners=[]}get size(){return this.vacuum(),this.store.size}clear(){return this.store.clear(),this}delete(e){return this.store.delete(e)}deleteIf(e){this.store.forEach((t,i)=>{e(i,t.value)&&this.store.delete(i)})}entries(){const e=this;return function*(){for(const[t,i]of e.store.entries())e.expired(t,i)||(yield[t,i.value])}()}forEach(e){this.store.forEach((t,i)=>{this.expired(i,t)||e(t.value,i,this)})}get(e){return n.map(this.store.get(e),t=>this.expired(e,t)?void 0:t.value)}touch(e){n.map(this.store.get(e),e=>e.touch())}pop(e){const t=this.store.get(e);return this.store.delete(e),n.map(t,t=>this.expired(e,t)?void 0:t.value)}has(e){return!this.expired(e,this.store.get(e))}keys(){const e=this;return function*(){for(const[t,i]of e.store.entries())e.expired(t,i)||(yield t)}()}set(e,t){return n.map(this.store.get(e),t=>this.expireListeners.forEach(i=>i(e,t.value))),this.store.set(e,new r(t)),this}values(){const e=this;return function*(){for(const[t,i]of e.store.entries())e.expired(t,i)||(yield i.value)}()}[Symbol.iterator](){return this.entries()}getOrSet(e,t){const i=this.store.get(e);if(this.valid(e,i))return i.touch(),i.value;{const i=t();return this.set(e,i),i}}on(e,t){this.expireListeners.push(t)}valid(e,t){return!this.expired(e,t)}expired(e,t){return null!=t&&t.ctime+this.ttlMs<=Date.now()?(this.store.delete(e),this.expireListeners.forEach(i=>i(e,t.value)),!0):null==t}vacuum(){this.store.forEach((e,t)=>{this.expired(t,e)})}}t.TTLMap=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Average=void 0;const n=i(33),r=i(1),s=i(0),o=i(5),a=i(11),u=i(12),l=i(139),c=i(104),d=i(16),h=i(52);class f{constructor(e=20){this.maxSamples=e,this._n=0,this._samples=new l.BoundedList(e)}static merge(e,t){if(0===e.n&&0===t.n)return new f(Math.max(e.maxSamples,t.maxSamples));if(0===e.n)return t.clone();if(0===t.n)return e.clone();if(e.n<=e.maxSamples){const i=t.clone();return i.pushAll(e.samples),i}if(t.n<=t.maxSamples){const i=e.clone();return i.pushAll(t.samples),i}{const i=new f(Math.max(e.maxSamples,t.maxSamples));i._n=e.n+t.n,i._avg=e._avg*e.n/i.n+t._avg*t.n/i.n,i._min=Math.min(e._min,t._min),i._max=Math.max(e._max,t._max),i._m=e._m*e.n/i.n+t._m*t.n/i.n,i._s=e._s*e.n/i.n+t._s*t.n/i.n;const n=r.flatten(u.zip(e.samples,t.samples));return i._samples.push(...n),i._weightedTotalAvg=h.weightedAvg([i._avg,...n]),i}}[n.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=null==this._min?e:Math.min(e,this._min),this._max=null==this._max?e:Math.max(e,this._max),1===this._n||null==this._m||null==this._s||null==this._avg||null==this._weightedTotalAvg)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{const t=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-t)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return a.tap(new f(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){e.forEach(e=>this.push(e))}stats(e=2){const t=t=>s.map(t,t=>o.sigFigs(t,e)),i={};return this.empty||(i.mean=t(this.avg),i.mode=t(this.sampleMode),i.sd=t(this.stdDev),i.max=t(this.max),i.min=t(this.min)),i.k=o.sigFigs(this.n,e),i}get empty(){return 0===this._n}get n(){return this._n}get avg(){return this.empty?void 0:o.sigFigs(this._avg,4)}get max(){return this._max}get min(){return this._min}get p84(){return d.mapGt0(this.avg,e=>d.mapGt0(this.stdDev,t=>e+t))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return s.map(this.variance,Math.sqrt)}get sampleMode(){return s.map(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;const t=new c.CountingSet;return this._samples.forEach(e=>t.incr(e)),t.topKeys(e)}get sampleStdDev(){return r.mapNotEmpty(this._samples,h.stdDev)}get sampleAvg(){return r.mapNotEmpty(this._samples,h.avg)}get sampleSlope(){return s.orElse(r.mapNotEmpty(this._samples,h.slope),0)}get samples(){return[...this._samples]}p(e){if(0===this._samples.length)return 0;const t=[...this._samples].sort((e,t)=>e-t);return t[Math.floor(t.length*(e/100))]}get weightedSampleAvg(){return r.mapNotEmpty(this._samples,e=>o.sigFigs(h.weightedAvg(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}}t.Average=f},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoize=void 0;const n=i(20),r=i(11),s=i(25),o=i(55);t.memoize=function(e,t,i){let a=0;const u=new o.BoundedMap(t,i,!0),l=t=>(a++,u.getOrSet(n.stringify(t),()=>r.tap(e(t),e=>{s.isPromise(e)&&e.catch(()=>l.clear())})));return l.clear=e=>null==e?u.clear():u.delete(n.stringify(e)),l.prior=()=>new Map(u.entries()),l.size=()=>u.size,l.callCount=()=>a,l}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isVideoMimeType=void 0;const n=i(3);t.isVideoMimeType=function(e){return n.notBlank(e)&&(e.startsWith("video/")||"application/mp4"==e||"application/ogg"==e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fixed=t.parseFixed=void 0;const n=i(1),r=i(3),s=i(2),o=i(0),a=i(5),u=i(11),l=i(15),c=i(7),d=i(6),h=i(89),f=i(10);class p{constructor(e){this.h=e,this.text=o.orElse(e.text,c.toS(e)),this.greedyLeft=o.orElse(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}}const m=s.lazy(()=>d.mkLogger("Fixed"));t.parseFixed=function(e,t,i=!0){return new g(e,t,i).entries};class g{constructor(e,t,i=!0){this.warnIfMissingHeaders=i;const s=t.split(/[\r\n]{1,2}/);this.headerRow=s[0],this.rows=s.slice(1);const o=Math.max(...this.rows.map(e=>e.length));this.col2blanks=new Map(a.times(o,e=>[e,n.count(this.rows,t=>r.blank(t[e]))])),this.headers=this.extractHeaders(e.map(e=>new p(e))),this.entries=this.rows.map(e=>this.headers.map(t=>t.toEntry(e))).map(e=>u.fromEntries(e)).filter(e=>u.values(e).some(r.notBlank))}extractHeaders(e){let t=this.headerRow;n.sortBy(e,e=>-e.text.length),e.forEach(e=>{const i=new RegExp(`\\b${e.text}\\b`,"i"),n=i.exec(t);null==n?this.warnIfMissingHeaders&&m().warn("extractHeaders(): Failed to find header!",{re:i,headerLine:t}):(e.indexOf=n.index,t=f.padReplace(t,n.index,e.text.length," "))});const i=e.filter(e=>null!=e.indexOf),r=n.sortBy(i,e=>e.indexOf);r.forEach((e,t)=>{const i=e.indexOf,n=r[t-1],s=0===t?0:n.indexOf+n.text.length-1,[a,u]=e.greedyLeft?[s,i]:[i,s];e.leftIdx=o.map(this.firstBlankColumn(a,u),e=>e+1),0===t&&null==e.leftIdx&&(e.leftIdx=0),null==e.leftIdx&&m().warn("no blank column for "+e.text+" between "+i+" and "+s)}),n.filterInPlace(r,e=>null!=e.leftIdx),r.slice(0,-1).forEach((e,t)=>{const i=r[t+1];e.rightIdx=i.leftIdx-1});const s=l.toA(h.diff(e.map(e=>e.text),r.map(e=>e.text)));return s.length>0&&m().warn("Missing headers",{missingHeaders:s}),r}firstBlankColumn(e,t){return n.range(e,t).find(e=>this.col2blanks.get(e)===this.rows.length)}}t.Fixed=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitLines=t.crlf=void 0;const n=i(1),r=i(14),s=i(10),o=i(7);t.crlf=function(e){const t=e+"\n";return r.isWin?t.replace(s.newlineRe,"\r\n"):t},t.splitLines=function(...e){return n.flatten(e.map(e=>o.toS(e).split(s.newlineRe)))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dmegapixels=t.isPortrait=t.maybeFlipInPlace=t.maybeFlip=t.flip=t.dimToSize=t.dimToS=t.isDimensions=void 0;const n=i(5),r=i(108),s=i(35);function o(e){return{width:e.height,height:e.width}}t.isDimensions=function(e){return null!=e&&n.gt0(e.width)&&n.gt0(e.height)},t.dimToS=function(e){return`${e.width} Ã ${e.height}`},t.dimToSize=function(e){return s.pixels2size(e.width*e.height)},t.flip=o,t.maybeFlip=function(e,t){return r.flippable(t)?o(e):e},t.maybeFlipInPlace=function(e,t){r.flippable(t)&&([e.width,e.height]=[e.height,e.width])},t.isPortrait=function(e){return e.width/e.height<1},t.dmegapixels=function(e){return s.megapixels(e.width*e.height)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.homeDir=void 0;const n=i(49),r=i(31),s=i(1),o=i(2),a=i(59),u=i(30),l=i(14);t.homeDir=o.lazy(()=>{const e=[];l.isWin?e.push(a.getEnv("HOMEPATH"),a.getEnv("USERPROFILE")):e.push(a.getEnv("HOME"));for(const t of s.compactBlanks(e)){const e=r.resolve(t);if(u.isDirectorySync(e))return e}return n.homedir()})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PS_NETWORK_FILESYSTEM_PROTOCOL=t.PS_LOCAL_FILE_PROTOCOL=t.PS_LIBRARY_PROTOCOL=t.parent=t.joinQuery=void 0;const n=i(31),r=i(1),s=i(11),o=i(7);t.joinQuery=function(e,t){if(null==t)return e;const i=s.entries(t).filter(([,e])=>null!=e);return r.isEmpty(i)?e:e+"?"+i.map(e=>e.map(o.toS).map(encodeURIComponent).join("=")).join("&")},t.parent=function(e){return n.posix.parse(e).dir},t.PS_LIBRARY_PROTOCOL="pslib:",t.PS_LOCAL_FILE_PROTOCOL="psfile:",t.PS_NETWORK_FILESYSTEM_PROTOCOL="psnet:"},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.nukeSettings=t.clearSettings=t.writeLibrarySettings=t.readLibrarySettings=t.writeSystemSettings=t.stringifyToml=t.currentVersion=t.libraryPathHasSettings=t.libraryHasSettings=t.librarySettingsVersion=t.systemSettingsVersion=t.savedLibraryPath=t.envOrSavedLibraryPath=t.readSystemSettings=t.libraryTxtFile=t.librarySettingsFile=t.systemSettingsFile=void 0;const r=i(236),s=i(1),o=i(3),a=i(37),u=i(20),l=i(2),c=i(0),d=i(11),h=i(15),f=i(7),p=i(47),m=i(12),g=i(8),v=i(45),y=i(13),b=i(84),w=i(32),S=i(6),P=i(10),M=i(65),E=i(91),x=i(138),_=i(9),T=S.mkLogger("SettingsIO");function D(){return w.PosixFile.for(p.App.getPath("userData")).join("settings.toml")}function O(e){return m.first([e,_.Settings.libraryPath.value],e=>o.mapNotBlank(e,e=>c.map(E.libraryDataDir(e),e=>e.join("settings.toml"))))}function F(){return w.PosixFile.for(p.App.getPath("userData")).join("library.txt")}function I(){return g.thenMap(j(D()),e=>e[_.Settings.libraryPath.name])}function k(e){const t=O(e);return T.tap({msg:"libraryPathHasSettings",result:c.orElse(null==t?void 0:t.existsSync(),!1),meta:{librarySettingsFile:null==t?void 0:t.nativePath}})}t.systemSettingsFile=D,t.librarySettingsFile=O,t.libraryTxtFile=F,t.readSystemSettings=function(e=D()){return n(this,void 0,void 0,(function*(){const i=yield g.thenOrElse(z(e),()=>[]);return o.blank(_.Settings.libraryPath.value)&&o.notBlank(yield function(){return n(this,void 0,void 0,(function*(){if(!t.libraryHasSettings()){const e=F().clear();if(yield e.isNonEmpty()){const t=f.toS(yield e.readFile());if(o.notBlank(t))return T.info("Importing old library.txt file",{priorPath:t,libraryTxt:e}),_.Settings.libraryPath.value=t,null!=(yield B())&&(yield e.renameWithNameSuffix("-obsolete")),t}}}))}())&&s.pushUniq(i,_.Settings.libraryPath),i}))},t.envOrSavedLibraryPath=function(){var e;return null!==(e=_.Settings.libraryPath.value)&&void 0!==e?e:I()},t.savedLibraryPath=I,t.systemSettingsVersion=function(){return n(this,void 0,void 0,(function*(){return A(D())}))},t.librarySettingsVersion=function(e){return n(this,void 0,void 0,(function*(){return c.map(O(e),e=>A(e))}))},t.libraryHasSettings=l.lazy(()=>k()),t.libraryPathHasSettings=k,_.Settings.libraryPath.addListener(()=>t.libraryHasSettings.unset()),y.onSettingsChanged(()=>t.libraryHasSettings.unset());const C=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;function A(e){return n(this,void 0,void 0,(function*(){return g.thenMap(e.firstMatchingLine(C),e=>e[1])}))}const L={maxLineLen:80,prefix:"# "};function R(e,i){return n(this,void 0,void 0,(function*(){const r=yield e.clear().isNonEmpty(),o=r?yield e.wip():e;T.info("maybeWriteFile(): writing settings",{file:e}),yield function(e,i,r){return n(this,void 0,void 0,(function*(){const n=c.orElse(yield j(r),{}),o=s.flatten(["","Hello!","","These are settings for PhotoStructure, and are formatted using TOML. See <https://github.com/toml-lang/toml>.","","NOTE: Please shut down PhotoStructure before editing this file.","",'Most settings have reasonable defaults, which are provided after the description. Remove the "#" from the beginning of the line to override the default. See <https://photostructure.com/getting-started/advanced-settings/#editing-toml> for details.',"","Thanks for using PhotoStructure! Visit <https://support.photostructure.com> or email <support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+t.currentVersion()].map(e=>P.wrap(e,L)));o.push("",""),i.forEach(e=>{const t=s.compactBlanks([e.key,...h.toA(e.opts.alternateKeys)]),i="# +"+P.padding("â",e.name.length+4)+"+",r=d.entries(Object.assign({env:1===t.length?t[0]:t},e.addToJSON())).map(([e,t])=>`${e}: ${u.stringify(t)}`).join(", ");o.push(...P.wrap([i,"|  "+e.name+"  |",i,"",""+e.opts.description,`(${r})`,""].join("\n"),L));const a=n[e.name],l={},c=e.valueToPersist(a);null!=c?(l[e.name]=c,o.push(...N(l))):(l[e.name]=e.exampleValue,o.push(...N(l).map(e=>"# "+e))),o.push("","")}),yield e.writeTxt("\n"+o.map(e=>e.trimRight()).join("\n")+"\n\n"),y.emitSettingsChanged()}))}(o,i,e),r&&((yield g.thenNot(v.eqlAsync(j(o),j(e))))&&(T.info("Archiving prior, different contents",{dest:o,file:e}),yield e.renameYMDHMS("old")),yield o.unwip())}))}function N(e){return b.splitLines(...d.entries(e).map(([e,t])=>e+" = "+u.stringify(t,void 0,2)))}function B(e=D()){return n(this,void 0,void 0,(function*(){return R(e,_.persistedSystemSettings())}))}function j(e){return n(this,void 0,void 0,(function*(){return g.thenMap(e.readFile(),t=>T.tap({msg:`read(${e})`,result:r.parse(P.dumbquote(t.toString()))}))}))}function z(e){return n(this,void 0,void 0,(function*(){const t=S.mkLogger("SettingsIO.importFileSettings("+e.nativePath+")");try{t.debug("ENV before",_.psenv());const i=yield j(e);if(null==i){if(yield e.isNonEmpty())throw new Error("Failed to read "+e);return[]}const n=new Map(d.entries(_.Settings).filter(([,e])=>e instanceof x.Setting&&!e.transient).map(([e,t])=>[e.toLowerCase(),t])),r=s.compact(d.entries(i).map(([e,i])=>{const r=n.get(f.toS(e).toLowerCase());return null==r?t.warn("Failed to import (no setting with this name)",{key:e}):r.importFromFile(i),r}));return t.info("loaded",{tomlMap:i,imported:r.map(e=>d.pick(e,"name","value","persist"))}),r}catch(e){return void t.error("Cannot read"+a.errorToVerbose(e))}}))}t.currentVersion=l.lazy(()=>M.version),t.stringifyToml=N,t.writeSystemSettings=B,t.readLibrarySettings=function(e){return n(this,void 0,void 0,(function*(){return c.map(O(e),e=>z(e))}))},t.writeLibrarySettings=function(e){return n(this,void 0,void 0,(function*(){yield E.setupLibraryDataDir(o.firstNotBlank(e,_.Settings.libraryPath.value));const i=O(e);return T.warn("writeLibrarySettings("+i+")"),yield c.map(i,e=>R(e,_.persistedLibrarySettings())),t.libraryHasSettings.clear(),i}))};const V=l.lazy(()=>new Set([_.Settings.logLevel,_.Settings.httpPort,_.Settings.rpcPort].map(e=>e.key)));function q(){d.values(_.Settings).filter(e=>!V().has(e.key)).forEach(e=>e.unset()),y.emitClearCache(),y.emitSettingsChanged()}t.clearSettings=q,t.nukeSettings=function(){return n(this,void 0,void 0,(function*(){yield D().unlink("debug"),yield c.map(O(),e=>e.unlink("debug")),q()}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.diff=t.intersection=t.union=t.getOrAdd=t.setEql=t.asSet=void 0;const n=i(15);function r(e){return e instanceof Set?e:new Set(n.toA(e))}t.asSet=r,t.setEql=function(e,t){return n.toA(e.keys()).every(e=>t.has(e))&&n.toA(t.keys()).every(t=>e.has(t))},t.getOrAdd=function(e,t,i){if(null==t)throw new Error("null key");return e.has(t)?void 0:(e.add(t),i())},t.union=function(e,t){return new Set([...e,...t])},t.intersection=function(e,t){const i=r(t);return new Set([...e].filter(e=>i.has(e)))},t.diff=function(e,t){const i=r(t);return new Set([...e].filter(e=>!i.has(e)))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIterable=void 0,t.isIterable=function(e){return null!=e&&"string"!=typeof e&&"function"==typeof e[Symbol.iterator]}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setupLibraryDataDir=t.libraryDataDir=void 0;const r=i(3),s=i(32),o=i(65),a=i(9),u="\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n\nMoving or deleting any files here will cause problems using your library.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v"+o.version;function l(e=a.Settings.libraryPath.value){return r.mapNotBlank(e,e=>s.PosixFile.for(e).join(".photostructure"))}t.libraryDataDir=l,t.setupLibraryDataDir=function(e){return n(this,void 0,void 0,(function*(){const t=l(e);if(null==t)throw new Error("empty dataDir");if(null==(yield t.mkdirp()))throw new Error("Could not mkdirp "+t);yield t.mkNoMedia();const i=t.join("README.txt");return(yield i.size())!==u.length&&(yield i.writeTxt(u)),t}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toID=t.TimestampedModel=void 0;const n=i(16),r=i(0),s=i(5),o=i(185);class a extends o.Model{static touch(e){return this.dbr(t=>t.exec(this.query().whereIn("id",e).update("updatedAt",Date.now())))}toID(){return"updateCount"in this&&(this.updateCount=n.mapGt0Or(this.updateCount,e=>e,1)),u(this)}get createdAtDate(){return n.mapGt0(this.createdAt,e=>new Date(e))}get updatedAtDate(){return n.mapGt0(this.updatedAt,e=>new Date(e))}$beforeUpsert(){null==this.createdAt&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this&&(this.updateCount=n.mapGt0Or(this.updateCount,e=>e+1,1))}$beforeInsert(){this.$beforeUpsert()}$beforeUpdate(){this.$beforeUpsert()}}function u(e){return r.map(e,e=>({id:e.id,v:s.numericOr(e.updateCount,0)}))}t.TimestampedModel=a,t.toID=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rate=void 0;const n=i(33),r=i(4),s=i(5),o=i(16),a=i(190),u=i(52);class l{constructor(e){if(this.ttlMs=e,this._eventCount=0,this._lastEventTime=0,e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new a.TTLArray(e)}[n.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){const e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return o.mapGt0(this.eventDeltas.length,()=>u.weightedAvg(this.eventDeltas))}get msPerEvent(){return u.avg(this.eventDeltas)}get eventsPerMs(){return o.mapGte0f(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return o.mapGte0f(this.eventsPerMs,e=>s.sigFigs(r.secondMs*e,3))}get eventsPerMinute(){return o.mapGte0f(this.eventsPerMs,e=>s.sigFigs(r.minuteMs*e,3))}}t.Rate=l},function(e,t){e.exports=require("batch-cluster")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.bestRemoteVolume=t.remoteVolumeFor=t.bestVolume=t.volumeFor=t.rootVolume=t.rootPath=t.volumes=t.setRpcVolumesImpl=void 0;const r=i(1),s=i(3),o=i(4),a=i(2),u=i(0),l=i(18),c=i(12),d=i(62),h=i(8),f=i(22),p=i(59),m=i(45),g=i(23),v=i(13),y=i(30),b=i(6),w=i(168),S=i(14),P=i(10),M=i(244),E=i(245),x=i(58),_=i(247),T=i(248),D=i(249),O=i(250),F=i(169),I=i(251),k=a.lazy(()=>b.mkLogger("Volumes"));function C(){return n(this,void 0,void 0,(function*(){const e=yield S.isWin?E.dfWin():M.dfPosix();if(null==e)return void k().warn("df failed");e.some(e=>e.remote&&s.blank(e.remoteHost))&&(yield h.thenOrTimeout(S.isWin?F.addRemoteVolumeInfoWin(e):O.addRemoteVolumeInfoPosix(e),10*o.secondMs).catch(e=>{g.onError("Failed to get remote volume info",e)}));const t=u.orElse(yield S.isWin?D.addLocalVolumeInfoWin(e):S.isMac?_.addLocalVolumeInfoMac(e):T.addLocalVolumeInfoPosix(e),e);r.filterInPlace(t,e=>!f.isTrue(e.ignorable)&&!f.isFalse(e.remoteOK));for(const e of t)e.remote=f.isTrue(e.remote),s.mapNotBlank(e.remoteHost,t=>e.remoteHost=t.toLowerCase().normalize().trim());yield I.addVolumeUUIDs(t);const i=r.sortBy(t,e=>e.mountpoint);return k().debug("_volumes(): final result",{sorted:i}),Object.freeze(i)}))}let A;t.setRpcVolumesImpl=function(e){A=e};let L=[];function R(e){return n(this,void 0,void 0,(function*(){return h.thenMap(t.volumes(),t=>N(t,e))}))}function N(e,t){const i=e.filter(e=>y.containedByNativePath(t,e.mountpoint));return c.greatestBy(i,e=>r.commonPrefixLength(e.mountpoint,t))}function B(e,t,i){return n(this,void 0,void 0,(function*(){const o=i.filter(e=>P.equalsIgnoreCase(t,e.remoteShare));if(r.isEmpty(o))return;const a=o.find(t=>f.isTrue(t.remote)&&s.notBlank(t.remoteHost)&&P.equalsIgnoreCase(e,t.remoteHost));if(null!=a)return a;const u=yield w.friendlyname(e);return h.asyncFind(o,e=>n(this,void 0,void 0,(function*(){return P.equalsIgnoreCase(u,yield w.friendlyname(e.remoteHost))})))}))}t.volumes=x.lazyFsAsync(()=>n(void 0,void 0,void 0,(function*(){try{const e=yield d.firstDefinedLater(A,C);return r.mapNotEmpty(e,e=>{const t=e.map(e=>e.mountpoint).sort();m.eql(L,t)||(v.emitVolumesChanged(),L=t)}),e}catch(e){return void g.onError("volumes() failed",e)}}))),t.rootPath=a.lazy(()=>S.isWin?l.Opt(p.getEnv("SystemDrive")).filter(s.notBlank).orElse(()=>"C:").map(e=>P.ensureSuffix(e,"\\")).get():"/"),t.rootVolume=function(){return R(t.rootPath())},t.volumeFor=R,t.bestVolume=N,t.remoteVolumeFor=function(e,i){return n(this,void 0,void 0,(function*(){return h.thenMap(t.volumes(),t=>B(e,i,t))}))},t.bestRemoteVolume=B},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReducerNames=void 0;const n=i(36);t.ReducerNames=n.strEnum("fit","sq")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlStrings=t.wrap=t.leftIndexOf=t.newlineRe=t.ensureSuffix=t.ensurePrefix=void 0;const n=i(1),r=i(7);function s(e,t){return e=r.toS(e),t=r.toS(t),e.startsWith(t)?e:t+e}function o(e,t,i){null==i&&(i=e.length);for(let n=i;n>=0;n--)if(e.substr(n).startsWith(t))return n;return-1}t.ensurePrefix=s,t.ensureSuffix=function(e,t){return e=r.toS(e),t=r.toS(t),e.endsWith(t)?e:e+t},t.newlineRe=/\r?\n/gm,t.leftIndexOf=o,t.wrap=function e(i,a={maxLineLen:75,prefix:""}){if(i.includes("\n"))return n.flatten(i.split(t.newlineRe).map(t=>e(t,a)));if((i=s(r.toS(i).trim(),a.prefix).trim()).length<=a.maxLineLen)return[i];const u=o(i," ",a.maxLineLen);if(u>a.prefix.length)return[i.slice(0,u),...e(i.slice(u+1),a)];{const t=i.indexOf(" ",a.prefix.length+1);return t>0&&t<i.length-1?[i.slice(0,t),...e(i.slice(t+1),a)]:[i]}},t.eqlStrings=function(e,t){return null!=e&&null!=t&&e.normalize()==t.normalize()}},function(e,t){e.exports=require("exiftool-vendored")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ContextualLogger=t.safeLogger=t.NoOpLogger=t.ms2level=void 0;const r=i(33),s=i(37),o=i(0),a=i(44),u=i(7),l=i(24),c=i(50),d=i(106),h=i(144);function f(e){return n(this,void 0,void 0,(function*(){try{return yield e()}catch(e){return}}))}t.ms2level=function(e,t){return e>=t?"error":e>=t/2?"warn":e>=t/4?"info":"debug"},t.NoOpLogger={log:a.NoOp,flush:()=>Promise.resolve(),end:a.NoOp,error:a.NoOp,warn:a.NoOp,info:a.NoOp,debug:a.NoOp,trace:a.NoOp},t.safeLogger=function(e){return{log:(t,i,n,r)=>l.Try(()=>e.log(t,i,n,r)),flush:()=>f(()=>e.flush()),end:()=>f(()=>e.end())}};const p=/^[a-z]*/i;class m{constructor(e,t){this.context=e,this.loggers=t,this.error=(e,t)=>{this.log("error",e,t)},this.warn=(e,t)=>{this.log("warn",e,t)},this.info=(e,t)=>{this.log("info",e,t)},this.debug=(e,t)=>{this.log("debug",e,t)},this.trace=(e,t)=>{this.log("trace",e,t)},this.filterContext=o.mapOr(p.exec(u.toS(this.context)),e=>e[0],()=>this.context)}addContext(e){return new m(this.context+e,this.loggers)}throw(e,t){const i=new c.WrappedError({cause:s.asError(e),message:this.context+o.mapOr(t,r.inspect,()=>""),fatal:null==t?void 0:t.fatal});throw this.log("error",s.errorToVerbose(e),t),i}tap(e){return this.log(o.orElse(e.level,"debug"),e.msg,Object.assign({result:e.result},e.meta)),e.result}log(e,t,i){if(d.logFilter().enabled(e,this.context))for(const n of this.loggers())n.log(e,this.context,t,s.isError(i)?s.errorToS(i):i);else"trace"!==e&&h.addRecentLogEntry({ts:Date.now(),l:e,ctx:this.context,msg:t,meta:i})}flush(){return n(this,void 0,void 0,(function*(){for(const e of this.loggers())yield e.flush()}))}end(){return n(this,void 0,void 0,(function*(){for(const e of this.loggers())yield e.end()}))}}t.ContextualLogger=m},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupByValues=t.groupBy=t.MultiMap=void 0;const n=i(1),r=i(54),s=i(0),o=i(11),a=i(15),u=i(12),l=i(52);class c{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return l.sum([...this.store.values()].map(e=>e.length))}add(e,t){return o.tap(r.getOrSet(this.store,e,()=>[]),e=>e.push(t))}delete(e,t){if(null==t)return this.store.delete(e);{const i=this.store.get(e);if(null==i)return!1;{const n=u.remove(i,t);return n&&0===i.length&&this.store.delete(e),n}}}clear(){return this.store.clear(),this}keys(){const e=this;return function*(){for(const[t,i]of e.store.entries())i.length>0&&(yield t)}()}values(){const e=this;return function*(){for(const[,t]of e.store.entries())t.length>0&&(yield t)}()}flatValues(){const e=this;return function*(){for(const[,t]of e.store.entries())if(t.length>0)for(const e of t)yield e}()}entriesArray(){return[...this.store.entries()].filter(([,e])=>n.isNotEmpty(e))}entries(){const e=this;return function*(){for(const[t,i]of e.store.entries())i.length>0&&(yield[t,i])}()}tuples(){const e=this;return function*(){for(const[t,i]of e.store.entries())for(const e of a.toA(i))null!=e&&(yield[t,e])}()}filterInPlace(e){let t=!1;for(const[i,r]of this.store.entries()){const s=r.length;n.filterInPlace(r,t=>e(i,t)),t=t||s!==r.length}return t}}function d(e,t){const i=new c;return e.forEach(e=>s.map(t(e),t=>i.add(t,e))),i}t.MultiMap=c,t.groupBy=d,t.groupByValues=function(e,t){const i=d(e,t);return n.sortBy(a.toA(i.values()),e=>t(e[0]))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ProcCleaner=t.addPid=t.Pids=t.pidNotExists=t.pidExists=t.kill=void 0;const r=i(94),s=i(19),o=i(1),a=i(3),u=i(4),l=i(2),c=i(0),d=i(5),h=i(18),f=i(15),p=i(7),m=i(47),g=i(17),v=i(8),y=i(43),b=i(63),w=i(26),S=i(23),P=i(40),M=i(30),E=i(6),x=i(76),_=i(16),T=i(24),D=i(14),O=i(166),F=i(42),I=l.lazy(()=>E.mkLogger("Pids")),k=10*u.secondMs;function C(e,t){if(null==e||null==t)return!1;const i=c.map(t.start,e=>e.getTime()),n=e.startTime;return d.gt0(i)&&d.gt0(n)&&Math.abs(i-n)<k}function A(e,t){return n(this,void 0,void 0,(function*(){return null!=e&&null!=t&&(e.name===p.toS(t.pid)&&C(yield e.readJSON(),t))}))}function L(e,t=!1,i=!0){if(e===s.pid||e===s.ppid)throw new Error("cannot self-terminate");return t&&i&&N.instance().onKill(e),D.isWin?function(e,t=!1){return n(this,void 0,void 0,(function*(){if(g.ending()||F.PowerShell.instance().ended)return r.kill(e,t);try{const i=o.compact(["Stop-Process","-Id",d.toInt(e),t?"-Force":void 0]).join(" ");yield F.PowerShell.instance().execute(i,T.identity)}catch(i){I().warn("killWin(): pwsh error, using TASKKILL: "+i),r.kill(e,t)}}))}(e,t):function(e,t=!1){return n(this,void 0,void 0,(function*(){try{s.kill(e,t?"SIGKILL":"SIGTERM")}catch(e){if(!String(e).includes("ESRCH"))throw e}}))}(e,t)}function R(e){return n(this,void 0,void 0,(function*(){return null!=(yield O.pidInfo(e))}))}t.kill=L,t.pidExists=R,t.pidNotExists=function(e){return v.thenNot(R(e))};class N{constructor(e=P.BaseFile.for(m.App.userData()).join("pids")){this.pidsDir=e,this.p=new y.Promises,this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",()=>n(this,void 0,void 0,(function*(){const t=c.orElse(e.everything,!1),i=c.orElse(e.force,D.isWin),n=yield this.pidfiles(),r=yield x.toMapAsync(n,e=>v.thenMap(e.readJSON(),e=>[e.pid,e])),a=o.uniq(o.flatten(f.toA(r.values()).map(e=>[e.pid,e.ppid])));if(o.isEmpty(a))return I().debug("killOldProcs(): no pidfiles"),[];const u=yield O.pidInfos(a);if(I().debug("killOldProcs()",{pids:a,allEntries:u}),null==u)return void S.onError("Pids.killOldProcs(): failed to get process information");const l=new Set(u.map(e=>e.pid)),h=u.filter(e=>r.has(e.pid)),p=o.sortBy(o.compact(h.map(e=>c.map(r.get(e.pid),t=>C(t,e)?Object.assign(Object.assign({},t),e):void 0))),e=>e.pid).filter(e=>s.pid!==e.pid),m=t?p:p.filter(t=>!l.has(t.ppid)||!l.has(t.pid)||d.gt0(t.timeoutTime)&&Date.now()>=t.timeoutTime||null!=e.everythingBefore&&t.startTime<e.everythingBefore);I().debug("killOldProcs()",{trackedEntries:h,victims:m,pidfiles:f.toA(r.values())});for(const e of m)I().info("killOldProcs(): killing",{entry:e}),L(e.pid,i,!1);return yield this.vacuumPids(),o.sortBy(m,e=>e.pid)})))}addPid(e,t){return n(this,void 0,void 0,(function*(){if(null==e)throw new Error("undefined info");const i=e.pid;if(!d.gt0(i))throw new Error("undefined pid");const n=this.pidsDir.join(e.pid+".json"),r=h.Opt(T.Try(()=>M.parseNativePath(e.cmd).base)).filter(a.notBlank).getOrElse(()=>e.cmd),s=t.getTime(),o=_.mapGt0(e.maxAgeMs,e=>s+e),u=Object.assign(Object.assign({},e),{cmd:r,startTime:s,timeoutTime:o});if(null==(yield n.writeJsonMaybe(u)))throw new Error("Failed to write to "+n);return I().debug("addPid() wrote "+n,u),n}))}pidfiles(){return this.pidsDir.clear().children(e=>".json"===e.ext&&null!=d.toInt(e.name))}onKill(e){return n(this,void 0,void 0,(function*(){const t=this.pidsDir.join(e+".json");return v.thenMap(t.clear().readJSON(),t=>this.addPid(Object.assign(Object.assign({},t),{maxAgeMs:1}),w.ago(u.minuteMs)).catch(t=>{I().info("onKill(): failed to rewrite pidfile: "+t,{pid:e})}))}))}vacuumPids(){return n(this,void 0,void 0,(function*(){const e=yield this.pidfiles(),t=f.toA(e).map(e=>d.toInt(e.name)).filter(d.gt0);if(o.isEmpty(t))return;const i=yield O.pidInfos(t);if(null!=i){I().debug("vacuumPids",{pids:t,pidfiles:f.toA(e).map(e=>e.base),entries:i});for(const t of e){const e=i.find(e=>p.toS(e.pid)===t.name);null!=e&&(yield A(t,e))||(I().debug("vacuumPids(): Removing old pidfile "+t.base,{psEntry:e,pidfile:yield t.readFile().then(p.toS).catch(e=>"(failed to read file: "+e+")")}),yield t.unlink())}}else S.onError("Failed to get pidInfo for pids "+t)}))}}t.Pids=N,N.instance=l.lazy(()=>new N),t.addPid=function(e,t){return N.instance().addPid(e,t)},t.ProcCleaner=l.lazy(()=>{const e=[{everything:!1,force:!1,intervalMs:5*u.minuteMs},{everything:!1,force:!0,intervalMs:17*u.minuteMs}].map(e=>b.setUnrefInterval(()=>N.instance().killOldProcs(e),e.intervalMs));return new g.EndableWrapper("ProcCleaner",()=>(e.map(clearInterval),N.instance().killOldProcs()),g.EndableRanks.predb)})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunker=t.onDataChunked=void 0;const n=i(3),r=i(75);t.onDataChunked=function(e,t,i){new s(t,i,!0).read(e)};class s{constructor(e,t,i=!0){this.sep=e,this.onData=t,this.filterBlanks=i,this.incompleteChunk="",this.done=new r.Latch}onChunk(e){if(null==e)return;const t=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=t.pop(),t.forEach(e=>{this.filterBlanks&&!n.notBlank(e)||this.onData(e)})}clear(){this.onChunk(""),n.notBlank(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",e=>this.onChunk(e)),e.on("close",()=>{this.clear(),this.done.resolve()}),this}}t.Chunker=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppName=void 0,t.AppName="PhotoStructure"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CountingSet=void 0;const n=i(1),r=i(0),s=i(5),o=i(11),a=i(80);t.CountingSet=class{constructor(){this.m=new Map}incr(e,t=1){const i=this.get(e)+t;return 0===i?this.m.delete(e):this.m.set(e,i),this}get(e){return r.orElse(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){const e=new a.Average(0);for(const t of this.keys()){if(!s.isNumber(t))return;e.push(t)}return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){const e=this.keyAvg();return n.sortBy([...this.entries()],([t,i])=>[-i,s.mapNumericOr(e,e=>Math.abs(t-e),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(e=>e[0])}get averageCounts(){return o.tap(new a.Average(this.size),e=>[...this.m.values()].forEach(t=>e.push(t)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return n.sort([...this.keys()]).map(e=>e+" "+this.get(e)).join("\n")}}},function(e,t){e.exports=require("zlib")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withLogLevel=t.silentlyAsync=t.silently=t.logFilter=t.LogFilterImpl=t.PermissiveLogFilter=void 0;const r=i(1),s=i(3),o=i(2),a=i(7),u=i(28),l=i(9),c=i(107);!function(e){e.highlight=()=>!1,e.silent=!1,e.enabled=()=>!e.silent,e.defaultLevelIndex=c.levelIndex("trace")}(t.PermissiveLogFilter||(t.PermissiveLogFilter={}));const d=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i;class h{constructor(e){this.silent=!1,this.contexts=[];let t=c.levelIndex(l.Settings.logLevel.defaultValue);const i=s.notBlank(e)?e:l.Settings.logLevel.valueOrDefault;r.compactBlanks(i.split(",")).forEach(i=>{const n=d.exec(i.trim());if(null==n)u.isTest||console.error("LogFilterImpl: Ignoring '"+i+"' from "+e);else{const e=a.toS(n[1]).toLowerCase(),i=c.levelIndex(n[2]);s.blank(e)?t=i:this.contexts.push({prefix:e,levelIndex:i})}}),this.defaultLevelIndex=t}contextOverride(e){if(0===this.contexts.length&&s.blank(e))return;const t=a.toS(e).toLowerCase();return this.contexts.find(e=>t.startsWith(e.prefix))}enabled(e,t){if(this.silent)return!1;const i=c.levelIndex(e);if(i<=this.defaultLevelIndex)return!0;const n=this.contextOverride(t);return null!=n&&i<=n.levelIndex}highlight(e){const t=this.contextOverride(e);return null!=t&&t.levelIndex>=this.defaultLevelIndex}}t.LogFilterImpl=h,t.logFilter=o.lazy(()=>new h),l.Settings.logLevel.addListener(()=>t.logFilter.clear()),t.silently=function(e){try{return t.logFilter().silent=!0,e()}finally{t.logFilter().silent=!1}},t.silentlyAsync=function(e){return n(this,void 0,void 0,(function*(){try{return t.logFilter().silent=!0,yield e()}finally{t.logFilter().silent=!1}}))},t.withLogLevel=function(e,t){return n(this,void 0,void 0,(function*(){const i=l.Settings.logLevel.getState();l.Settings.logLevel.tmpValue=e;try{return yield t()}finally{l.Settings.logLevel.setState(i)}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelIndex=t.LogLevels=void 0;const n=i(11),r=i(36);t.LogLevels=r.strEnum("error","warn","info","debug","trace");const s=n.fromEntries(t.LogLevels.values.map((e,t)=>[e,t]));t.levelIndex=function(e){var t;return null!==(t=s[e])&&void 0!==t?t:s.trace}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flippable=t.normalizeRotation=t.isRotation=void 0;const n=i(0),r=i(5);function s(e){return r.isNumber(e)&&[0,90,180,270].includes(e)}function o(e){const t=n.map(e,e=>r.round(e+360*Math.ceil(-e/360)));return s(t)?t:void 0}t.isRotation=s,t.normalizeRotation=o,t.flippable=function(e){const t=o(e);return 90===t||270===t}},function(e,t){e.exports=require("crypto")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lcdiff=t.str=t.radixDiff=t.lnsDiff=t.nonUniqIntersection=t.bigrams=t.diceCoeff=t.levenshtein=t.hamming=t.lcs=t.commonSubstringRatio=void 0;const n=i(1),r=i(3),s=i(4),o=i(5),a=i(7),u=i(55),l=i(57),c=i(16),d=i(24),h=i(89);function f(e,t){if(null==e)return t;if(null==t)return e;if((e=e.normalize())===(t=t.normalize())||t.includes(e))return e;if(e.includes(t))return t;const i=new c.Array2D(e.length);let n=0,r="";for(let s=0;s<e.length;s++)for(let o=0;o<t.length;o++)e[s]===t[o]&&(0===s||0===o?i.set(s,o,1):i.set(s,o,i.get(s-1,o-1)+1),i.get(s,o)>=n&&(n=i.get(s,o),r=e.substr(s-n+1,n)));return r}function p(e,t){if(null!=e&&null!=t)return e=e.normalize(),t=t.normalize(),e.length!==t.length?void 0:e.split("").reduce((e,i,n)=>i===t.charAt(n)?e:e+1,0)}t.commonSubstringRatio=function(e,t){return[e,t].some(r.blank)?0:f(e,t).length/Math.max(e.length,t.length)},t.lcs=f,t.hamming=p;const m=new u.BoundedMap(10*s.minuteMs,1e4,!0),g=String.fromCharCode(31);function v(e,t){return e=e.normalize(),t=t.normalize(),m.getOrSet(n.sort([e,t]).join(g),()=>{if(0===e.length)return t.length;if(0===t.length)return e.length;const i=e.charAt(e.length-1)===t.charAt(t.length-1)?0:1,n=e.slice(0,-1),r=t.slice(0,-1);return Math.min(v(n,t)+1,v(e,r)+1,v(n,r)+i)})}function y(e,t){const i=e.toUpperCase().normalize(),n=t.toUpperCase().normalize();return d.firstThunk(()=>i===n?1:void 0,()=>r.blank(e)!==r.blank(t)?0:void 0,()=>1===e.length&&1===t.length?0:void 0,()=>{const e=b(i),t=b(n);return 2*w(e,t).length/(e.length+t.length)})}function b(e){return null==e||0===e.length?[]:e.slice(0,-1).split("").map((t,i)=>t+e[i+1])}function w(e,t){const i=h.intersection(e,t),r=[];return i.forEach(i=>{const s=Math.min(n.count(e,e=>e===i),n.count(t,e=>e===i));o.times(s,()=>r.push(i))}),r}function S(e,t,i){const r=n.commonPrefixLength(e,t);return i(e.substr(r))-i(t.substr(r))}function P(e){const t=n.compactBlanks(a.toS(e).split(/[^\d]+/));return n.sortBy(t,e=>-e.length)[0]}function M(e,t){const[i,n]=[e,t].map(P).map(e=>r.blank(e)?"":e);return S(i,n,e=>o.toInt(e,{defaultValue:0}))}t.levenshtein=v,t.diceCoeff=y,t.bigrams=b,t.nonUniqIntersection=w,t.lnsDiff=M;const E=/[^0-9a-z]+/gi;function x(e,t){const[i,n]=[e,t].map(e=>a.toS(e).replace(E,"").toLowerCase());return S(i,n,e=>l.RadixAlphaNum.decode(e))}t.radixDiff=x,t.str=function(e,t){return{pref:n.commonPrefixLength(e,t),lev:v(e,t),ham:p(e,t),dice:y(e,t),lns:M(e,t),radixDiff:x(e,t)}},t.lcdiff=function(e){return n.count(e.normalize().split(""),e=>0!==e.toLowerCase().localeCompare(e))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PullProgressObserver=t.PushProgressObserver=void 0;const n=i(53),r=i(182),s=i(0),o=i(5),a=i(156),u=i(8),l=i(28).isTest?500:1e3;t.PushProgressObserver=class{constructor(e,t){this.context=e,this.total=t,this.start=Date.now(),this.emit=a.throttle(()=>{r.emitProgressEvt(Object.assign(Object.assign({},this.context),{pct:100*this.current/this.total,elapsedMs:Date.now()-this.start}))},l,!0)}onProgress(e){this.current=o.clamp(0,this.total,s.orElse(e,s.orElse(this.current,0)+1)),this.emit()}};t.PullProgressObserver=class{constructor(e,t,i){this.ctx=e,this.total=t,this.progress=i,this.start=Date.now(),this.onInterval=a.throttle(()=>u.thenMap(this.progress(),e=>this.emit(e)),l),this.timer=n.setInterval(()=>this.onInterval(),l)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){s.map(e,e=>r.emitProgressEvt(Object.assign(Object.assign({},this.ctx),{pct:100*o.clamp(0,this.total,e)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>l&&this.emit(this.total),this.end()}end(){s.map(this.timer,e=>n.clearInterval(e)),this.timer=void 0}}},function(e,t,i){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectPath=t.ancestorWithChildren=t.childrenSync=t.ancestors=t.execDir=void 0;const n=i(46),r=i(31),s=i(19),o=i(1),a=i(2),u=i(12),l=i(14);function c(e){const t=[];for(;e!==r.dirname(e);)e=r.dirname(e),t.push(e);return t}function d(e){try{return n.readdirSync(e)}catch(e){return[]}}function h(e,t){const i=d(e);return t.every(e=>i.includes(e))}t.execDir=a.lazy(()=>r.dirname(process.execPath)),t.ancestors=c,t.childrenSync=d,t.ancestorWithChildren=function(e,t){return c(e).find(e=>h(e,t))},function(i){i.Root=a.lazy(()=>{const i=["migrations","public","views"],n=[];l.isDocker()&&n.push("/ps/app"),l.isElectron&&n.push(r.join(t.execDir(),"resources"),r.join(t.execDir(),"..","Resources")),n.push(...o.compactBlanks([t.execDir(),s.cwd(),e])),u.uniqInPlace(n);for(const e of n){if(h(e,i))return e;for(const t of c(e).slice(0,4)){if(h(t,i))return t;const n=r.join(e,"node_modules","photostructure");if(h(n,i))return n}}throw new Error("Failed to find project root. Looked in "+n)});const n=e=>a.lazy(()=>r.join(i.Root(),e));i.Bin=n("bin"),i.Migrations=n("migrations"),i.Public=n("public"),i.Tools=n("tools"),i.Views=n("views")}(t.ProjectPath||(t.ProjectPath={}))}).call(this,"/")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sharpDimensions=t.sharpMetadata=t.dimensions=void 0;const r=i(72),s=i(4),o=i(5),a=i(79),u=i(62),l=i(8),c=i(223),d=i(39),h=i(48),f=new a.TTLMap(2*s.minuteMs);function p(e){return r(e.nativePath).metadata()}function m(e){return n(this,void 0,void 0,(function*(){return h.isSharpExt(e.ext)?l.thenMap(p(e),e=>{const t=[e.width,e.height];o.gt0(e.orientation)&&[5,6,7,8].includes(e.orientation)&&t.reverse();const[i,n]=t;return o.gt0(i)&&o.gt0(n)?{width:i,height:n}:void 0}):void 0}))}t.dimensions=function(e){return c.getOrSetByNativePath(e,()=>function(e){return u.firstDefinedLater(()=>l.thenMap(d.cachedTags(e),e=>e.dimensions),()=>m(e),()=>l.thenMap(d.sizeInfo(e.nativePath),e=>({width:e.ImageWidth,height:e.ImageHeight})))}(e),f)},t.sharpMetadata=p,t.sharpDimensions=m},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Asset=void 0;const r=i(8),s=i(22),o=i(26),a=i(76),u=i(24),l=i(163),c=i(1),d=i(173),h=i(96),f=i(2),p=i(0),m=i(11),g=i(25),v=i(15),y=i(282),b=i(115),w=i(122),S=i(233),P=i(181),M=i(131),E=i(92);class x extends E.TimestampedModel{constructor(){super(...arguments),this.attrs={},this.urls=f.lazy(()=>new d.AssetUrls(this.toID()))}static shownCount(){return this.ops().count(this.shownUnhidden())}static outdatedQuery(){return this.query().where("version","<",l.AssetVersion)}static shownUnhidden(e){return p.orElse(e,()=>x.query()).andWhere({shown:1,hidden:0})}static nextOutdated(e=u.identity){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=u.identity){return this.dbr(t=>t.pluckFirst(e(this.outdatedQuery()).count()))}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static addTags(e,t){return n(this,void 0,void 0,(function*(){const i=c.uniqBy(t.filter(c.isNotEmpty),e=>b.joinTagPath(e));return this.logger().debug("addTags()",{assetId:e,tagPaths:t,uniqTagPaths:i}),c.isEmpty(i)?void 0:x.tx(()=>n(this,void 0,void 0,(function*(){const t=(yield g.thenCollect(i,e=>M.Tag.findOrCreate(e))).map(e=>e.id);return P.AssetTag.addTagsToAsset(e,t)})))}))}static removeTags(e,t){return n(this,void 0,void 0,(function*(){if(c.isEmpty(t))return;const i=yield g.thenCollect(t,e=>M.Tag.findByPath(e));return this.logger().info("removeTags()",{assetId:e,tags:i.map(e=>m.pick(e,"id","path")),tagPaths:t}),P.AssetTag.removeTagsFromAsset(e,c.compact(i.map(e=>e.id)))}))}static unshownAssetIds(){return this.dbr(e=>e.pluckAll("\n        SELECT DISTINCT af1.assetId\n        FROM AssetFile af1\n          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 \n            ON af1.assetId = af2.assetId\n        WHERE af2.assetId IS NULL"))}static archive(e){return this.tx(()=>n(this,void 0,void 0,(function*(){null!=(yield x.ops().findById(e))&&(yield P.AssetTag.ops().exec(P.AssetTag.query().where({assetId:e}).delete()),yield w.AssetFile.ops().exec(w.AssetFile.query().where({assetId:e}).delete()),yield x.ops().delete([e]))})))}get capturedAt(){return o.localToDateObject(this.capturedAtLocal)}get capturedAtMs(){return o.localToTs(this.capturedAtLocal)}renderCaption(e){return p.map(this.capturedAtMs,t=>"Taken "+o.fmtDateShort(t,e))}whenTagPath(){return r.thenMap(y.dateTag(this.capturedAt),b.tagPathToStringArray)}addTagPaths(e){return x.addTags(this.id,e)}findAssetFileByUri(e){return n(this,void 0,void 0,(function*(){return yield this.getFiles(),this.files.find(t=>t.uri===e)}))}addAssetFile(e){return n(this,void 0,void 0,(function*(){return null==(yield this.findAssetFileByUri(e.uri))&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}))}static getTags(e){return M.Tag.ops().all(M.Tag.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}getTags(){return n(this,void 0,void 0,(function*(){return null==this.tags&&(this.tags=yield x.getTags(this.id)),this.tags}))}static getTagPaths(e){const t=M.Tag.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return M.Tag.dbr(e=>e.pluckAll(t))}tagPaths(){return n(this,void 0,void 0,(function*(){return(yield this.getTags()).map(e=>e.path.join("/")).sort()}))}getStreams(e){return n(this,void 0,void 0,(function*(){if(null==this.streams){const t=yield this.getTags();this.logger().info("getStreams(): fetched tags "+t,{limit:e});const i=yield g.thenCollect(t,t=>t.getAssetStream(this,e));this.streams=S.coalesceStreams(c.compact(i));for(const e of this.streams)for(const t of e.tags)yield t.getAncestors()}return this.streams}))}getBeforeAfterId(){return n(this,void 0,void 0,(function*(){const e=yield x.dbr(e=>e.all(x.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id")));this.afterId=p.map(e.find(e=>e.id>this.id),E.toID),this.beforeId=p.map(e.reverse().find(e=>e.id<this.id),E.toID),yield r.thenOrElse(this.beforeId,()=>this.getBeforeId()),yield r.thenOrElse(this.afterId,()=>this.getAfterId())}))}getBeforeId(){return n(this,void 0,void 0,(function*(){return r.thenMap(x.dbr(e=>e.first(x.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}]))),e=>this.beforeId=E.toID(e))}))}getAfterId(){return n(this,void 0,void 0,(function*(){return r.thenMap(x.dbr(e=>e.first(x.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}]))),e=>this.afterId=E.toID(e))}))}getTagPaths(){return n(this,void 0,void 0,(function*(){return(yield this.getTags()).map(e=>e.path)}))}getFiles(){return n(this,void 0,void 0,(function*(){if(null!=this.files)return this.files;if(null==this.id)return this.files=[];const e=yield w.AssetFile.ops().findBy({assetId:this.id});return this.files=c.sortBy(e,e=>[!s.isTrue(e.shown),-e.mtime])}))}getShown(){return n(this,void 0,void 0,(function*(){return null!=this.files?this.files.find(e=>s.isTrue(e.shown)):r.thenMap(w.AssetFile.ops().findOneBy({assetId:this.id,shown:1}),e=>m.tap(e,e=>e.asset=this))}))}getCapturedAt(){return n(this,void 0,void 0,(function*(){const e=yield this.getFiles();return r.thenCompact(v.toA(e).map(e=>e.toCapturedAt()))}))}link(){return"/asset/"+this.id}sqAttrs(e=!0){return Object.assign(Object.assign(Object.assign({},this.urls().sqImgAttrs(e)),{title:this.renderCaption()}),this.attrs)}getImgAttrs(e,t,i=!1){return n(this,void 0,void 0,(function*(){return null==this.imgAttrs&&(this.imgAttrs=new Map),yield a.getOrSetAsync(this.imgAttrs,t,()=>n(this,void 0,void 0,(function*(){const s=e.ap(this.toID());yield r.thenMap(s.readInfo(),e=>n(this,void 0,void 0,(function*(){e.mimetype.startsWith("video/")&&(this.poster=yield s.posterLink())})));return s.imgAttrs(t,!0,i)}))),this.imgAttrs}))}fitAttrs(){const e=p.map(this.imgAttrs,e=>e.get(h.ReducerNames.fit));if(null==e)throw new Error("fitAttrs() called before getImgAttrs()");return Object.assign(Object.assign({},e),this.attrs)}isVideo(){if(null==this.files)throw new Error(".video called before getFiles()");return this.files.some(e=>e.isVideo)}videoAttrs(){return Object.assign({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(null==this.existingFiles)throw new Error(".videoSources called before getExistingFiles()");const e=this.existingFiles.filter(e=>e.isVideo).map(e=>({src:this.urls().videoLink(e.id),type:e.mimetype})),t=c.uniqBy(e,e=>e.type);if(t.every(e=>"video/mp4"!==e.type)){const e=this.existingFiles[0];t.unshift({src:this.urls().videoLink(e.id)+".mp4",type:"video/mp4"})}return t}getPosixFiles(){return n(this,void 0,void 0,(function*(){const e=yield this.getFiles();return c.compact(yield Promise.all(e.map(e=>e.posixFile())))}))}getExistingAssetFiles(){return n(this,void 0,void 0,(function*(){return null==this.existingFiles&&(this.existingFiles=yield r.asyncFilter(yield this.getFiles(),e=>r.thenMapOr(e.posixFile(),e=>e.exists(),()=>!1))),this.existingFiles}))}findOrCreateByFile(e){return n(this,void 0,void 0,(function*(){const t=yield e.uri();if(null==t)return;const i=v.toA(yield w.AssetFile.findByAsset({id:this.id},{uri:t}))[0];return p.orElse(i,()=>n(this,void 0,void 0,(function*(){const t=new w.AssetFile;return t.asset=this,t.assetId=this.id,yield t.setFile(e),t})))}))}clear(){return this.files=void 0,this.tags=void 0,this.existingFiles=void 0,this}setHidden(e){return n(this,void 0,void 0,(function*(){return x.txOp(()=>(this.hidden=e,this.upsert()))}))}}t.Asset=x,x.tableName="Asset",x.uniqueColumnName="id",x.booleanFields=["shown","hidden","favorite"]},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagDeltas=t.tagDiff=t.tagPathEql=t.uniqTagPaths=t.joinTagPath=t.tagPathToStringArray=t.tagRefToS=t.RootTagSynonyms=t.WhatSynonyms=t.WhereSynonyms=t.Roots=t.Type=t.Keywords=t.Lens=t.Camera=t.When=t.TagSep=void 0;const n=i(283),r=i(89),s=i(1),o=i(0),a=i(15),u=i(7);function l(e){return o.map(e,e=>o.orElse(e.name,u.toS(e)))}function c(e){return e.map(l)}function d(e,i=t.TagSep){return c(e).join(i)}function h(e){return c(e).join(t.TagSep).toLowerCase()}function f(e,t){const i=new Set(s.compact(t).map(e=>h(e)));return s.compact(e).filter(e=>!i.has(h(e)))}function p(e){return l(a.toA(e)[0])}function m(e){return new Set(s.compact(a.toA(e).map(p)))}t.TagSep=String.fromCharCode(31),t.When="When",t.Camera="Camera",t.Lens="Lens",t.Keywords="Keywords",t.Type="Type",t.Roots=[{name:t.When,ordinal:1},{name:t.Camera,ordinal:5},{name:t.Lens,ordinal:6},{name:t.Keywords,ordinal:7},{name:t.Type,ordinal:8}],t.WhereSynonyms=new n.CISet(["country","el paÃ­s","emplacement","endroit","gps","les pays","location","ort","pays","place","places","platz","posiciÃ³n","region","rÃ©gion","site","sitio","stÃ¤tte","ubicaciÃ³n","where"]),t.WhatSynonyms=new n.CISet(["article","articles","item","items","le sujet","matiÃ¨re","object","objects","objet","objets","subject","subjects","subjekt","sujet","sujeta","sujeto","what"]),t.RootTagSynonyms=new n.CISet([...t.Roots.map(e=>e.name),...t.WhereSynonyms,...t.WhatSynonyms]),t.tagRefToS=l,t.tagPathToStringArray=c,t.joinTagPath=d,t.uniqTagPaths=function(e){return s.uniqBy(e,e=>s.isEmpty(e)?void 0:d(e))},t.tagPathEql=function(e,t){return null!=e&&null!=t&&h(e)===h(t)},t.tagDiff=f,t.tagDeltas=function(e,t,i=!0){const n=f(t,e),s=f(e,t),o=i?r.diff(m(s),m(n)):new Set;return{add:n,remove:s.filter(e=>!o.has(p(e)))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateInterval=void 0;const n=i(98),r=i(0),s=i(5),o=i(7),a=i(51),u=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/;class l{constructor(e,t,i,n=0,r=1){this.start=e,this.middle=t,this.end=i,this.index=n,this.splits=r,this.toISOString=this.toString.bind(this),this.year=a.getYear(this.middle),this.month=a.getMonth(this.middle),this.day=a.getDay(this.middle)}static fromISO(e){e=o.toS(e).trim();const t=u.exec(e);if(null==t)return;const i=n.ExifDateTime.fromISO(t[1]),r=n.ExifDateTime.fromISO(t[2]),a=s.toInt(t[3]),l=s.toInt(t[4]);return this.for(i,r,a,l)}static for(e,t,i=0,n=1){if(!a.validDate(e)||!a.validDate(t))return;const o=a.toExifDateTime(e),u=a.toExifDateTime(t);if(null==o||null==u)return;n=s.clamp(1,1e3,s.toInt(n,{defaultValue:1})),i=s.clamp(0,n-1,s.toInt(i,{defaultValue:0}));const c=r.map(o.toDateTime().until(u.toDateTime()).divideEqually(n+1)[i],e=>e.end);return null!=c?new l(o,a.toExifDateTime(c,r.orElse(o.zone,u.zone)),u,i,n):void 0}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return r.orElse(this.start.zone,this.end.zone)}get hasTimes(){return a.hasTime(this.start)&&a.hasTime(this.end)}toString(e=!0){return`${a.datedToISO(this.start,e)}/${a.datedToISO(this.end,e)}`+(0===this.index&&1===this.splits?"":`/${this.index}/${this.splits}`)}includes(e){if(null==e)return!1;const t=a.toExifDateTime(e);return null!=t?this.interval().contains(t.toDateTime()):this.year===a.getYear(e)&&this.month===a.getMonth(e)&&this.day===a.getDay(e)}}t.DateInterval=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.resume=t.pause=t.isPaused=void 0;const n=i(13);let r=!1;t.isPaused=function(){return r},t.pause=function(){r||(r=!0,n.emitPause())},t.resume=function(){r&&(r=!1,n.emitResume())}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.validVideo=t.guessExpectedSize=t.transcode=t.isVideoTranscodingSupported=t.extractVideoFrame=t.bitrateKps=t.getVideoToolDetails=t.maxConcurrentVideoImports=t.MaxBitrateKbps=void 0;const r=i(49),s=i(4),o=i(2),a=i(0),u=i(5),l=i(35),c=i(62),d=i(8),h=i(69),f=i(22),p=i(111),m=i(6),g=i(220),v=i(16),y=i(9),b=i(10),w=i(303),S=i(222),P=i(39),M=i(128),E=i(133),x=i(258),_=i(113),T=i(129),D=i(225),O=i(160),F=i(82),I=i(259);function k(e,t,i){var r;return n(this,void 0,void 0,(function*(){if(!F.isVideoMimeType(t))return;const s=!f.isTrue(null==i?void 0:i.useVlc)&&f.isTrue(yield d.thenOrElse(null==i?void 0:i.useFfmpeg,()=>x.isFFmpegSupported())),o=!s&&f.isTrue(yield d.thenOrElse(null==i?void 0:i.useVlc,()=>I.isVlcSupported()));if(!s&&!o)return;const u=m.mkLogger("img/Video.extractVideoFrame("+e+")"),l=yield T.cachedImgFile(e,"frame",".jpg");u.debug("extractVideoFrame",{dest:l.nativePath,mimetype:t});const c=yield e.mtimeMs();if(null==c)return u.throw("null mtime");const h=yield P.readRawTags(e);if(null==h)return u.throw("no tags");const p=M.extractRotation(h);u.debug("video orientation:"+p);const g=null===(r=E.extractSizeInfo(h,p))||void 0===r?void 0:r.dimensions,v=yield l.stat(),b=yield a.map(v,()=>_.sharpDimensions(l));if(null!=v&&v.mtimeMs>c&&null!=b&&(null==g||b.height===g.height&&b.width===g.width))return u.debug("prior dest, "+l+" seems reasonable",{srcDim:g,destDim:b}),l;const w=S.extractDurationSec(h),O=Math.min(null!=w?w:0,y.Settings.videoFrameAtSec.valueOrDefault);return u.info("extracted metadata",{startAtSec:O,duration:w}),yield l.applyWip(t=>n(this,void 0,void 0,(function*(){const i=Object.assign({src:e,dest:t,startAtSec:O},g);yield s?x.ffmpegFrame(i):I.vlcFrame(i),yield P.deleteAllTags(t),o&&null!=p&&0!==p&&(u.info("rotating in place..."+t,{rot:p}),yield D.rotateInPlace(t,p))}))),l}))}function C(e,t,i){return Math.min(e,a.orElse(i,60)*a.orElse(t,1e3))}t.MaxBitrateKbps=18e3,t.maxConcurrentVideoImports=o.lazy(()=>n(void 0,void 0,void 0,(function*(){return r.totalmem()>16*l.GB&&(yield x.isFFmpegSupported())?2:1}))),t.getVideoToolDetails=function(e){return c.firstDefinedLater(()=>f.isTrue(null==e?void 0:e.ignoreffmpeg)?void 0:d.thenMap(x.checkFFmpegVersion(),e=>"FFmpeg "+e),()=>f.isTrue(null==e?void 0:e.ignorevlc)?void 0:d.thenMap(I.checkVlcInfo(),e=>"VLC "+e.version))},t.bitrateKps=e=>u.sigFigs(g.lerp2d({x:76800,y:800},{x:8294400,y:t.MaxBitrateKbps},e),2),t.extractVideoFrame=k,t.isVideoTranscodingSupported=function(){return n(this,void 0,void 0,(function*(){return y.Settings.transcodeVideos.valueOrDefault&&((yield x.isFFmpegSupported())||(yield I.isVlcSupported()))}))},t.transcode=function(e,i){return n(this,void 0,void 0,(function*(){const r=m.mkLogger("img/Video.transcode("+e+")");if(!y.Settings.transcodeVideos.valueOrDefault)return void r.debug("not transcoding (transcodeVideos is false)");const o=yield x.isFFmpegSupported(),l=!o&&(yield I.isVlcSupported());if(!o&&!l)return void r.debug("not transcoding (neither FFmpeg nor VLC are available)");const c=yield e.size();if(!u.gt0(c))throw new Error("transcode(): cannot read "+e);const d=yield P.readRawTags(e);if(null==d)throw new Error("Cannot transcode files that exiftool can't read");const f=d.MIMEType;if(!F.isVideoMimeType(f))return void r.debug("not transcoding (unsupported mimetype)",{mimetype:f});const g=y.Settings.doNotTranscodeMimetypes.values;if(!b.includesIgnoreCase(g,f))return h.time("Video.transcode()",()=>n(this,void 0,void 0,(function*(){const r=a.orElse(S.extractDurationSec(d),60),l=O.transcodeTimeout({bytes:c,durationMs:r*s.secondMs,ext:e.ext}),h=Object.assign({src:e,timeoutMs:l},function(e,i){const n=m.mkLogger("img/Video.dim("+e+")"),r=y.Settings.minVideoDimension.valueOrDefault,s=i.ImageWidth;if(null!=s&&!u.gte(s,r))return n.throw("invalid width: "+s);const o=i.ImageHeight;if(null!=o&&!u.gte(o,r))return n.throw("invalid height: "+o);const l=a.orElse(w.extractBitrateKbps(i),t.MaxBitrateKbps),c=v.mapGt0(s,e=>v.mapGt0(o,i=>u.clamp(0,l,t.bitrateKps(e*i)))),d={width:s,height:o,videoBitrateKbps:c};return n.debug("dim()",{src:e,result:d}),d}(e,d)),f=C(c,h.videoBitrateKbps,r),g=f/3,b=t=>n(this,void 0,void 0,(function*(){const r=Date.now(),s=new p.PullProgressObserver({path:e.nativePath,op:"Transcoding video"},f,()=>n(this,void 0,void 0,(function*(){const e=a.orElse(yield i.clear().size(),0),t=(Date.now()-r)/l*f;return Math.max(e,t)})));h.dest=t;const u=yield s.observe(o?x.ffmpegTranscode(h):I.vlcTranscode(h));if(0!==u.code)throw new Error("transcode failed with code "+u.code)}));return i.applyIfEmpty(e=>b(e),g)})));r.debug('not transcoding (mimetype is in "do not transcode")',{mimetype:f,doNotTranscodeMimetypes:g})}))},t.guessExpectedSize=C,t.validVideo=function(e,t){return n(this,void 0,void 0,(function*(){const i=m.mkLogger("img/Video.validVideo("+e+")");return null==(yield k(e,t))&&i.throw("Could not extract a video frame"),(yield x.isFFmpegSupported())?x.ffmpegValidVideo(e):void 0}))}},function(e,t){e.exports=require("url")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mtabEntries=t.gioVolumes=t.GioMountMonitorArgs=t.GioCommand=t.isGioSupported=void 0;const r=i(3),s=i(2),o=i(0),a=i(18),u=i(81),l=i(8),c=i(21),d=i(40),h=i(6),f=i(14),p=i(10),m=i(121),g=i(27);t.isGioSupported=s.lazy(()=>n(void 0,void 0,void 0,(function*(){if(!f.isLinux)return!1;try{return 0===(yield c.stdoutResult(t.GioCommand,["version"],{timeout:g.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}}))),t.GioCommand="gio",t.GioMountMonitorArgs=["mount","--monitor","--anonymous"];const v=s.lazy(()=>h.mkLogger("Gio.gioVolumes()"));t.gioVolumes=s.lazy(()=>l.thenOrTimeout(()=>n(void 0,void 0,void 0,(function*(){const e=yield function(){return n(this,void 0,void 0,(function*(){return(yield t.isGioSupported())?l.thenFlatten(yield l.thenMap(t.mtabEntries(),e=>e.map(e=>d.BaseFile.for(e).clear().childDirectories()))):[]}))}(),i=(yield l.thenFlatten(e.map(e=>n(void 0,void 0,void 0,(function*(){const t=yield m.dfPosixRaw(!1,e.nativePath).catch(t=>{v().warn("Failed to df "+e+": "+t)}),i=o.map(t,e=>e[0]);return o.map(i,t=>t.mountpoint=e.nativePath),i}))))).filter(e=>e.size>0);return Promise.all(i.map(e=>n(void 0,void 0,void 0,(function*(){return l.thenMapOr(b(e.mountpoint),t=>(e.remoteHost=t.remoteHost,e.remoteShare=t.remoteShare,e.label=t.displayName,e.remote=!0,e),()=>e)}))))})),g.MountpointsTtlMs,()=>h.mkLogger("Gio.gioVolumes").warn("timed out after "+g.MountpointsTtlMs+"ms")),g.LongMountpointsTtlMs);const y=h.mkLogger("Gio.getRemoteInfo()"),b=u.memoize(e=>n(void 0,void 0,void 0,(function*(){try{const i=(yield c.stdout(t.GioCommand,["info",e],{timeout:g.CmdTimeoutMs})).split(/[\n\r]+/),n=r.mapNotBlank(i.find(e=>e.startsWith("uri: ")),e=>new URL(p.stripPrefix(e,"uri: ")));return{displayName:o.map(i.find(e=>e.startsWith("display name: ")),e=>p.stripPrefix(e,"display name: ")),remoteHost:o.map(n,e=>e.hostname),remoteShare:a.Opt(n).flatMap(e=>e.pathname).flatMap(e=>p.stripPrefix(e,"/")).flatMap(e=>p.stripSuffix(e,"/")).flatMap(decodeURIComponent).filter(r.notBlank).get()}}catch(t){return void y.warn("gio info failed",{mountpoint:e,err:t})}})),g.LongMountpointsTtlMs,1e3);t.mtabEntries=s.lazy(()=>n(void 0,void 0,void 0,(function*(){return l.thenMap(d.BaseFile.for("/proc/mounts").readLines(),e=>e.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1]))})),g.LongMountpointsTtlMs)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosixRaw=void 0;const r=i(3),s=i(5),o=i(7),a=i(21),u=i(83),l=i(14),c=i(238),d=i(27);function h(e){return 1024*s.toInt(e,{defaultValue:0})}const f=l.isMac?["devfs"]:["udev","tmpfs","devtmpfs"],p=["/boot/efi"];t.dfPosixRaw=function(e,t){return n(this,void 0,void 0,(function*(){const i=l.isMac?yield c.ignorableMacFilesystems():[],n=["-k","-P"];e&&n.push("-l"),r.notBlank(t)&&n.push(t);const s=yield a.stdout("df",n,{timeout:d.CmdTimeoutMs});return u.parseFixed(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],s).map(e=>({filesystem:e.Filesystem,size:h(e["1024-blocks"]),used:h(e.Used),available:h(e.Available),mountpoint:e["Mounted on"]})).filter(e=>{const t=o.toS(e.filesystem),n=o.toS(e.mountpoint);return r.notBlank(n)&&!p.includes(n)&&r.notBlank(t)&&!i.includes(t)&&!f.includes(t)})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFile=void 0;const r=i(119),s=i(8),o=i(22),a=i(26),u=i(23),l=i(32),c=i(271),d=i(177),h=i(180),f=i(260),p=i(82),m=i(24),g=i(163),v=i(9),y=i(10),b=i(135),w=i(39),S=i(284),P=i(67),M=i(1),E=i(3),x=i(4),_=i(85),T=i(96),D=i(20),O=i(2),F=i(0),I=i(5),k=i(11),C=i(68),A=i(41),L=i(7),R=i(87),N=i(149),B=i(114),j=i(92);class z extends j.TimestampedModel{constructor(){super(...arguments),this.posixFile=O.lazy(()=>l.PosixFile.forUri(this.uri,this.mountpoint))}static recentAssetIdsByUriRoot(e,t,i=64){return n(this,void 0,void 0,(function*(){const n=Date.now()-t,r=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",n).andWhere("AssetFile.uri","like",e+"%").andWhere("Asset.shown",1).andWhere("Asset.hidden",0).orderBy("AssetFile.updatedAt","desc").limit(i);return this.logger().info("recentAssetIdsByUriRoot",r.toSQL()),this.dbLocal().pluckAll(r)}))}static assetCountByMimetype(e){let t=this.query().select(N.knex.raw("mimetype, count(*) as count"));return E.notBlank(e)&&(t=t.andWhere("uri","like",e+"%")),t=t.groupBy("mimetype").orderBy("mimetype"),this.dbr(e=>e.all(t))}static children(e,t){const i=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${y.escapeRegExp(e)}/[^/]+$}`);return this.ops().all(F.mapOr(t,e=>e(i),()=>i))}get capturedAtDateTime(){return a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return a.fmtDateTime(this.capturedAtDateTime,e)}static outdatedQuery(e){const t=this.query().where("version","<",g.AssetFileVersion).orderBy("id");return M.isEmpty(e)?t:t.andWhere(t=>t.whereIn("mountpoint",e).orWhereNull("mountpoint"))}static nextOutdated(e=m.identity){return n(this,void 0,void 0,(function*(){return this.ops().findOne(e(this.outdatedQuery(yield P.mountpoints())))}))}static outdatedCount(e=m.identity){return n(this,void 0,void 0,(function*(){const t=this.outdatedQuery(yield P.mountpoints());return this.dbr(i=>i.pluckFirst(e(t.count("id"))))}))}static setShown(e,t){return n(this,void 0,void 0,(function*(){if(this.logger().info("setShown()",{assetId:e,assetFileId:t}),!I.gt0(e)||!I.gt0(t))throw new Error("setShown(): invalid IDs: "+D.stringify({assetId:e,assetFileId:t}));yield this.dbr(t=>t.run(z.query().update("shown",0).where("assetId",e)));const i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),n={assetId:e,assetFileId:t,updatedAt:Date.now()};return this.dbr(e=>e.run({sql:i,bindings:n}))}))}static findByAsset(e,t){return n(this,void 0,void 0,(function*(){const i=this.query().select("AssetFile.*");return F.map(k.compactValues(e),e=>i.join("Asset","Asset.id","AssetFile.assetId").where(k.mapFields(e,(e,t)=>["Asset."+e,t]))),F.map(k.compactValues(t),e=>i.where(k.mapFields(e,(e,t)=>["AssetFile."+e,t]))),this.ops().all(i)}))}get modes(){return M.compact(I.times(h.ModeCount,e=>this["mode"+e]))}set modes(e){I.times(h.ModeCount,t=>this["mode"+t]=e[t])}matchesFile(e){return n(this,void 0,void 0,(function*(){if(null==this.version||this.version<g.AssetFileVersion||v.Settings.forceSync.valueOrDefault)return!1;const t=yield this.fileFields(e);return m.eqlSubset(t,this)}))}fileFields(e){return C.thenOpt(e).orElse(()=>this.posixFile()).filter(e=>e.exists()).flatMap(e=>n(this,void 0,void 0,(function*(){return{uri:yield e.uri(),fileSize:yield e.size(),mtime:yield e.thisOrSidecareMaxMtimeMs()}}))).filter(k.isReqValued).get()}isVersionUpToDate(){return A.gte(this.version,g.AssetFileVersion)}updateIfNeeded(){return n(this,void 0,void 0,(function*(){return(yield this.matchesFile())&&I.gt0(this.id)?this:(yield this.notExists())?void 0:s.thenMap(this.updateFromFile(),()=>this.upsert())}))}maybeUpdateStats(e){return n(this,void 0,void 0,(function*(){return s.thenMap(this.fileFields(e),e=>m.assignFields(this,e))}))}updateFromFile(e){return n(this,void 0,void 0,(function*(){const t=Date.now(),i=this.logger().addContext(".updateFromFile()");if(i.debug("before",this),null!=this.id&&(yield this.matchesFile(e)))return void i.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");if(null!=e&&(yield this.setFile(e)),null==e&&(e=yield this.posixFile()),null==e||(yield e.notExists()))return void i.info("no-op, "+e+" is missing");if(null==this.mountpoint&&(yield s.thenMap(e.mountpoint(),e=>this.mountpoint=e.nativePath)),null==(yield this.maybeUpdateStats(e)))return void i.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});const n=e.sha(),r={},o=yield w.readTags(e);if(null==o)return i.throw("missing tags for "+e);if(E.blank(o.MIMEType))return i.throw("missing MIMEType for "+e);r.mimetype=o.MIMEType;const a=o.capturedAt,u=a.toLocal();if(null==u)return i.throw("bad CapturedAt",a);r.capturedAtLocal=u,r.capturedAtOffset=a.toOffset(),r.capturedAtPrecisionMs=a.toPrecisionMs(),r.capturedAtSrc=a.src,F.map(o.exposureSettings,e=>{r.focalLength=e.focalLength,r.aperture=e.aperture,r.shutterSpeed=e.shutterSpeed,r.iso=e.iso});const l=o.dimensions;if(r.width=l.width,r.height=l.height,r.rotation=o.rotation,r.make=o.Make,r.model=o.Model,r.cameraId=S.cameraId(o),r.imageId=F.map(S.imageId(o),L.toS),r.lensId=S.lensId(o),r.geohash=d.geohashNumericShort(o.GPSLatitude,o.GPSLongitude),r.durationMs=F.map(o.duration,e=>Math.round(1e3*e)),r.fps=F.map(o.VideoFrameRate,I.round),r.sha=yield n,null==r.sha)return void i.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri});v.Settings.useImageHashes.valueOrDefault&&(yield s.thenMap(h.imageHash(e),e=>{r.meanHash=e.meanHash,r.modes=e.modes})),m.assignFields(this,r),this.version=g.AssetFileVersion;const c=Date.now()-t;return i.log(c>x.secondMs?"info":"debug","after ("+c+"ms)",this),this}))}updateFromShaSibling(e){return n(this,void 0,void 0,(function*(){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:null==e.sha||!e.isVersionUpToDate()||null!=this.sha&&e.sha!==this.sha?this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e}):(m.assignFields(this,k.without(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt")),this)}))}getAsset(){return n(this,void 0,void 0,(function*(){return null==this.assetId||null!=this.asset?this.asset:this.asset=yield B.Asset.ops().findById(this.assetId)}))}exists(){return n(this,void 0,void 0,(function*(){return s.thenMapOr(this.posixFile(),e=>e.exists(),()=>!1)}))}notExists(){return n(this,void 0,void 0,(function*(){return s.thenNot(this.exists())}))}isDeleted(){return n(this,void 0,void 0,(function*(){if(this.uri.startsWith(R.PS_LIBRARY_PROTOCOL)){const e=v.Settings.libraryPath.value;if(E.blank(e))return this.logger().throw("isDeleted(): no set library path"+u.FatalErrorFlag,{uri:this.uri});const t=l.PosixFile.for(e);if(yield t.isNotDirectory())return this.logger().throw("isDeleted(): library path is missing"+u.FatalErrorFlag,{uri:this.uri,libraryPath:e});const i=yield this.posixFile();return null==i?this.logger().throw("isDeleted(): internal error: posixFile() is null",{uri:this.uri,libraryPath:e}):i.notExists()}return s.thenMapOr(this.posixFile(),e=>F.map(this.mountpoint,t=>e.isDeleted(t)),()=>!1)}))}isFiltered(){return n(this,void 0,void 0,(function*(){return C.thenOpt(this.posixFile()).filter(e=>e.exists()).flatMap(e=>c.expensiveFileFilter().apply(e)).map(e=>!e).getOrElse(()=>!1)}))}setFile(e){return n(this,void 0,void 0,(function*(){const t=yield e.uriObject();if(null==t)throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);const i=r.format(t);if(null==i)throw new Error(e+" had no URI");if(null!=this.uri&&i!==this.uri)throw new Error("Cannot reassign URIs");return this.uri=i,this.mountpoint=F.map(t.volume,e=>e.mountpoint),this.posixFile.set(Promise.resolve(e)),i}))}nativePath(){return s.thenMap(this.posixFile(),e=>e.nativePath)}toCapturedAt(){return F.map(a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset),e=>s.thenMap(this.posixFile(),t=>new b.CapturedAt(t,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}downloadables(e,t){return n(this,void 0,void 0,(function*(){try{const i=yield this.posixFile();if(null==i)return[];const n=e.ap(this.assetId),r=[];if((yield i.isNonEmpty())&&r.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:f.mkDownloadableTitle(i,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:i.base,description:"Download original",details:`(${_.dimToS(this)} ${i.ext})`}),this.isVideo)return r;if(!(o.isTrue(this.shown)||this.sha===t))return r;const s=M.compact(yield Promise.all([...yield n.previews()].reverse().filter(e=>e.reducer===T.ReducerNames.fit).map(e=>f.previewToDownloadable(i.base,e))));return r.push(...M.uniqBy(s,e=>e.size)),r}catch(e){return u.onError("AssetFile.downloadables failed",e,{context:this}),[]}}))}toApi(e,t){return n(this,void 0,void 0,(function*(){return s.thenMap(this.posixFile(),i=>n(this,void 0,void 0,(function*(){return k.reqValuedOrElse({assetId:this.assetId,assetFileId:this.id,nativePath:i.nativePath,wbrNativePath:y.wbrPath(i.nativePath),basename:i.base,exists:yield i.isNonEmpty(),mimetype:this.mimetype,shown:o.isTrue(this.shown),width:this.width,height:this.height,rotation:F.orElse(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:yield this.downloadables(e,t),createdAt:this.createdAt,updatedAt:this.updatedAt})})))}))}get isVideo(){return p.isVideoMimeType(this.mimetype)}}t.AssetFile=z,z.tableName="AssetFile",z.uniqueColumnName="uri",z.booleanFields=["shown"]},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.apply=t.filter=t.find=t.none=t.some=t.all=t.or=t.and=t.not=t.True=void 0;const r=i(1),s=i(0),o=i(8);t.True=()=>!0,t.not=function(e){return t=>!e(t)},t.and=function(...e){return t=>{for(const i of e)if(!i(t))return!1;return!0}},t.or=function(...e){return t=>{for(const i of e)if(i(t))return!0;return!1}},t.all=function(e,t){for(const i of e)if(!t(i))return!1;return!0},t.some=function(e,t){for(const i of e)if(t(i))return!0;return!1},t.none=function(e,t){for(const i of e)if(t(i))return!1;return!0},t.find=function(e,t){for(const i of e)if(t(i))return i},t.filter=function(e,t){return n(this,void 0,void 0,(function*(){return null==e||null==t?s.mapOr(e,r.compact,()=>[]):o.asyncFilter(e,t)}))},t.apply=function(e,t){return n(this,void 0,void 0,(function*(){return null==e||null==t||(yield t(e))?e:void 0}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readLogEntries=t.LogWriter=t.CaptureLogger=void 0;const r=i(46),s=i(53),o=i(1),a=i(4),u=i(34),l=i(20),c=i(2),d=i(0),h=i(25),f=i(17),p=i(43),m=i(63),g=i(26),v=i(84),y=i(30),b=i(61),w=i(145),S=i(191),P=i(29),M=i(9),E=i(10),x=i(146),_=i(77),T=i(144);t.CaptureLogger=class{constructor(){this.logEntries=[]}log(e,t,i,n){this.logEntries.push({ts:Date.now(),l:e,ctx:t,msg:i,meta:n})}enabled(){return!0}end(){}flush(){return n(this,void 0,void 0,(function*(){}))}};t.LogWriter=class{constructor(e,t={}){this.logDir=e,this.ended=!1,this.mutex=new p.Promises,this._linesSinceRotate=0,this.pendingWrites=[],this._startIndex=0,this.endTimeoutMs=15*a.secondMs,this.end=c.lazy(()=>n(this,void 0,void 0,(function*(){return this.ended=!0,d.map(this.flushInterval,s.clearInterval),this.flushInterval=void 0,yield this.flush(),this.mutex.serial("close",()=>this._closeCurrent())}))),this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",()=>this._flush()),this.shouldRotate=()=>null==this._stream||this._linesSinceRotate>=this.opts.maxLinesPerFile,this.name="LogWriter("+e+")",this.opts=Object.assign({maxLinesPerFile:25e4,errorLogger:x.ConsoleLogger.instance(),flushEveryMs:_.DefaultLogFlushMs,processName:P.processName},t),this.flushInterval=m.setUnrefInterval(()=>this.maybeFlush(),this.opts.flushEveryMs),f.addLoggerEndable(this)}log(e,t,i,n){if(this.ended&&"error"===e)this.opts.errorLogger.log(e,t,i,n);else{const r={ts:Date.now(),l:e,ctx:t,msg:i};null!=n&&(r.meta=n),this.pendingWrites.push(l.stringify(r)+"\n"),"error"===e&&this.writeRecentLogEntries()}}writeRecentLogEntries(){return this.pendingWrites.push(...T.recentLogEntries().map(e=>l.stringify(e)+"\n")),T.clearRecentLogEntries(),this.flush()}flush(){return n(this,void 0,void 0,(function*(){yield this.mutex.serial("flush",()=>this._flush())}))}_flush(){return n(this,void 0,void 0,(function*(){const e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&(yield this._rotate());const t=this._stream;if(null==t)return void this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const i=this.opts.maxLinesPerFile-this._linesSinceRotate,n=e.splice(0,i);this._linesSinceRotate+=n.length,t.write(n.join(""))}}))}errback(e){return t=>this.opts.errorLogger.log("error","Caught error from "+e,t)}_rotate(){return n(this,void 0,void 0,(function*(){yield this._closeCurrent(),this._currentFile=yield this.logDir.join(g.datestamp(),E.stripAnsiEsc(this.opts.processName())+".log").ensureNew({emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=r.createWriteStream(this._currentFile.nativePath).on("error",this.errback("file write stream"))}))}_closeCurrent(){return n(this,void 0,void 0,(function*(){const e=this._stream;this._stream=void 0,this._linesSinceRotate=0;const t=this._currentFile;this._currentFile=void 0,yield b.end(e),M.Settings.logCompression.valueOrDefault&&(yield u.delay(this.opts.flushEveryMs),yield d.map(t,e=>e.gzip()))}))}},t.readLogEntries=function(e,t){return n(this,void 0,void 0,(function*(){const i=y.nameWithoutCount(e.name);return h.thenMap(w.zcat(e.nativePath,t),e=>o.compact(o.compactBlanks(v.splitLines(e)).map(e=>S.mapParsed(e,e=>Object.assign(Object.assign({},e),{from:i})))))}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryEntry=void 0;const r=i(46),s=i(64),o=i(31),a=i(1),u=i(0),l=i(15),c=i(8),d=i(10),h=i(30);class f{constructor(e,t){this.dir=e,this.dirent=t,this.nativePath=o.join(this.dir,t.name)}static for(e){return n(this,void 0,void 0,(function*(){const t=h.parseNativePath(e);return s.stat(e).then(e=>new f(t.dir,{name:t.base,isFile:e.isFile.bind(e),isDirectory:e.isDirectory.bind(e),isSymbolicLink:e.isSymbolicLink.bind(e),size:e.size,mtimeMs:e.mtimeMs})).catch()}))}join(...e){return n(this,void 0,void 0,(function*(){return f.for(o.join(this.nativePath,...e))}))}get base(){return this.dirent.name}get ext(){return h.extname2(this.dirent.name)}get name(){return d.stripSuffix(this.base,this.ext)}get pathnames(){return this.nativePath.split(o.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile()}isDirectory(){return this.dirent.isDirectory()}isSymbolicLink(){return this.dirent.isSymbolicLink()}parent(){const e=h.parseNativePath(this.dir);return e.dir===this.dir?this:new f(e.dir,{name:e.base,isFile:function(){return!1},isDirectory:function(){return!0},isSymbolicLink:function(){return!1}})}children(){return this.isDirectory()?new Promise((e,t)=>{r.readdir(this.nativePath,{withFileTypes:!0},(i,n)=>{null!=i?t(i):e(u.map(n,e=>a.sortBy(e,e=>e.name.toLowerCase().normalize()).map(e=>new f(this.nativePath,e))))})}):void 0}visitDescendantFiles(e){return n(this,void 0,void 0,(function*(){for(const t of l.toA(yield this.children()))yield t.isFile()?e(t):t.isDirectory()?t.visitDescendantFiles(e):void 0}))}filterDescendantFiles(e){return n(this,void 0,void 0,(function*(){const t=[];return yield this.visitDescendantFiles(i=>n(this,void 0,void 0,(function*(){!0===(yield e(i))&&t.push(i)}))),t}))}stat(){return s.stat(this.nativePath).catch(()=>{})}size(){return n(this,void 0,void 0,(function*(){return c.thenOrElse(this.dirent.size,()=>c.thenMap(this.stat(),e=>e.size))}))}mtimeMs(){return n(this,void 0,void 0,(function*(){return c.thenOrElse(this.dirent.size,()=>c.thenMap(this.stat(),e=>e.mtimeMs))}))}}t.DirectoryEntry=f},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncFilter=void 0;const r=i(11),s=i(25),o=i(12),a=i(74),u=i(10),l=i(123);class c{constructor(e){this.apply=e}static lift(e){return new c(e)}static and(...e){return new c(t=>n(this,void 0,void 0,(function*(){for(const i of e){const e=yield i.apply(t);if(!e)return e}return!0})))}static or(...e){return new c(t=>n(this,void 0,void 0,(function*(){for(const i of e){const e=yield i.apply(t);if(e)return e}return!1})))}static andLogged(e,...t){return this.and(...o.flatMap(t,t=>r.entries(t).map(([t,i])=>i.asAsync().logged(e,t))))}static orLogged(e,...t){return this.or(...o.flatMap(t,t=>r.entries(t).map(([t,i])=>i.asAsync().logged(e,t))))}static andExplain(e,t){return n(this,void 0,void 0,(function*(){const i=[],n=[];for(const s of t)for(const[t,o]of r.entries(s))((yield o.apply(e))?i:n).push(t);return{accepted:i,rejected:n}}))}asAsync(){return this}and(...e){return c.and(this,...e)}not(){return c.lift(e=>this.apply(e).then(e=>!e))}or(e){return new c(t=>n(this,void 0,void 0,(function*(){return(yield this.apply(t))||(yield e.apply(t))})))}filter(e){return n(this,void 0,void 0,(function*(){return l.filter(e,e=>this.apply(e))}))}logged(e,t){return new c(i=>s.thenTap(this.apply(i),n=>{e.log(n?"debug":"info",[a.darkGrey(t),n?a.green("ACCEPT"):a.red("REJECT"),u.ellipsize(i)].join(" "))}))}}t.AsyncFilter=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.broadcast=t.setBroadcasterIfUnset=t.setBroadcaster=void 0;const n=i(296);let r=n.NoOpBroadcaster;t.setBroadcaster=function(e){r=e},t.setBroadcasterIfUnset=function(e){r===n.NoOpBroadcaster&&(r=e)},t.broadcast=function(e,t){r.broadcast(e,t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rotationToWriteTag=t.rotationToExifOrientation=t.orientationToRotation=t.extractRotation=void 0;const n=i(0),r=i(108),s=i(82),o=i(24);t.extractRotation=function(e){return n.map(e,e=>o.firstThunk(()=>u(e.Orientation),()=>u(e.CameraOrientation),()=>r.normalizeRotation(e.Rotation)))};const a=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function u(e){return n.map(e,e=>a.get(e))}t.orientationToRotation=u;const l=new Map([[0,1],[90,6],[180,3],[270,8]]);function c(e){return n.map(e,e=>l.get(e))}t.rotationToExifOrientation=c,t.rotationToWriteTag=function(e,t){return n.map(r.normalizeRotation(e),e=>s.isVideoMimeType(t)?{Rotation:e}:n.map(c(e),e=>({"Orientation#":e})))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.prepFileForBrowser=t.withImgCache=t.readableToFile=t.cachedImgFile=t.emptyImgCacheDir=t.imgCacheDir=void 0;const r=i(64),s=i(72),o=i(4),a=i(20),u=i(2),l=i(0),c=i(8),d=i(23),h=i(176),f=i(70),p=i(32),m=i(6),g=i(57),v=i(9),y=i(10),b=i(39),w=i(48),S=i(128),P=i(133),M=i(50),E=i(134),x=u.lazy(()=>m.mkLogger("ImgCache"));function _(){return n(this,void 0,void 0,(function*(){const e=yield T();if(null==e||(yield e.isNotDirectory())&&(yield e.clear().isNotDirectory()))throw new Error("Cannot mkdir "+v.Settings.cacheDir.valueOrDefault+d.FatalErrorFlag);return e}))}t.imgCacheDir=_;const T=u.lazy(()=>n(void 0,void 0,void 0,(function*(){return c.thenMap(p.PosixFile.for(v.Settings.cacheDir.valueOrDefault).join("imgcache").mkdirp(),e=>e.mkNoMedia())})),o.minuteMs);function D(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield e.stat();if(null==n)throw new Error(`tmpImgFile(${e}): unreadable`);const r=yield _(),s=yield h.readFileType(e.nativePath);if(null==s)throw new Error("Cannot read filetype for "+e);const o=f.stringSha(a.stringify({basename:e.base.toLowerCase(),mimetype:s.mime,size:n.size})),u=g.GeoRadix.encodeBuffer(o).slice(0,24);i=y.ensurePrefix(i,".");const l=r.join(...y.splitEvery(u.slice(0,24),2,3),t+i);if(null==(yield l.parent().mkdirp()))throw new Error("Cannot make dest dir, "+l.parent());return x().info("tmpImgFile("+e.baseWithGrandparent+")",{desc:t,ext:i,result:l}),l}))}function O(e,t,i,r){return n(this,void 0,void 0,(function*(){try{return yield c.thenMap(D(e,t,i),e=>e.applyIfEmpty(r))}catch(t){throw x().warn("readableToFile("+e+"): "+t),t}}))}t.emptyImgCacheDir=function(){return n(this,void 0,void 0,(function*(){return c.thenMap(_(),e=>n(this,void 0,void 0,(function*(){yield r.remove(e.nativePath),T.unset()})))}))},t.cachedImgFile=D,t.readableToFile=function({src:e,desc:t,suffix:i,f:r}){return n(this,void 0,void 0,(function*(){try{return yield c.thenMap(D(e,t,i),e=>e.applyIfEmpty(e=>n(this,void 0,void 0,(function*(){return c.thenMap(r(),t=>e.writeStream(t))}))))}catch(e){throw new M.WrappedError({cause:e,message:"readableToFile() failed"})}}))},t.withImgCache=O,t.prepFileForBrowser=function(e,t){return n(this,void 0,void 0,(function*(){if(yield e.notExists())return;const i=yield b.readRawTags(e,!0),r=null==i?void 0:i.MIMEType,o=l.orElse(S.extractRotation(i),0),a=l.map(i,e=>P.extractSizeInfo(e,o)),u=l.orElse(null==a?void 0:a.dimensions,t);if(null==u)return void x().warn("prepFileForBrowser(): no file dimensions",{file:e,si:a,info:t});const d={width:u.width-32,height:u.height-32};return w.isMimetypeSupported(r,t.userAgent)&&0===o?e:(x().info("prepFileForBrowser(): non-browser-supported mimetype",{file:e,mt:r,info:t}),O(e,"web-"+o,".jpg",t=>n(this,void 0,void 0,(function*(){return c.thenMap(E.sharpReadable(e,d),e=>n(this,void 0,void 0,(function*(){return s(e.nativePath).rotate(o).toFile(t.nativePath)})))}))))}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Library=t.libraryUID=void 0;const r=i(17),s=i(8),o=i(22),a=i(23),u=i(30),l=i(32),c=i(195),d=i(129),h=i(324),f=i(127),p=i(29),m=i(91),g=i(9),v=i(88),y=i(27),b=i(3),w=i(4),S=i(75),P=i(2),M=i(0),E=i(11),x=i(329),_=i(290),T=i(162),D=i(277),O=i(164),F=i(332),I=i(340),k=i(263),C=i(161),A=i(342),L=i(343),R=i(321);t.libraryUID=function(){return n(this,void 0,void 0,(function*(){return v.libraryHasSettings()?M.map(N.instance(),e=>s.thenMap(e.uid(),e=>e.uid)):void 0}))};class N extends r.EndableWrapper{constructor(e){super(`Library(${e})`,()=>this.onEnd(),r.EndableRanks.predb),this.start=Date.now(),this._ready=new S.Latch,this.setup=P.lazy(()=>n(this,void 0,void 0,(function*(){const e=()=>{if(this.ended||r.ending())throw new Error};try{if(this.logger.debug("setup()"),!v.libraryHasSettings.refresh()){if(!p.isWelcomeService())throw new Error("Cannot run "+p.serviceName()+" without a library"+a.FatalErrorFlag+a.DoNotSendErrorFlag);return void this.logger.warn("Library settings don't exist yet. Skipping setup.")}yield this.openedBy().throwIfUnavailable("(library setup)"),D.installLibraryUriSupport(),e(),yield m.setupLibraryDataDir(this.rootDir),yield v.readLibrarySettings(this.rootDir.nativePath),yield this.cacheDir(),yield d.imgCacheDir(),e(),f.setBroadcasterIfUnset(x.BroadcasterImpl),p.isRpcClient()&&(yield C.rpcClientReady())&&(yield T.checkRemoteVacuuming(),A.setupVolumeRpc()),e(),yield this.modelDb(),e(),p.isStatsDbClient()&&(yield this.statsDb()),yield I.setupModelJson()}catch(e){this.ended||r.ending()||(a.onError("Library.setup() failed"+(p.isWebService()?"":a.FatalErrorFlag),e),this._ready.reject(e))}finally{this._ready.pending&&this._ready.resolve()}}))),this.openedBy=P.lazy(()=>new k.OpenedByIO(this.dataDir)),this.uidStore=P.lazy(()=>new c.UIDStore(this.dataDir)),this.uid=P.lazy(()=>this.uidStore().read()),this.cacheDir=P.lazy(()=>_.cacheDir()),this.previews=P.lazy(()=>new h.Previews(this.dataDir.join("previews"),O.DbAdvisoryLockProvider)),this.assetFileRepository=P.lazy(()=>new R.AssetFileRepository(this.rootDir,()=>g.Settings.copyAssetsToLibrary.valueOrDefault)),this.modelDbJanitor=P.lazy(()=>n(this,void 0,void 0,(function*(){return F.ModelDbJanitor.for(this.dataDir,()=>this.openedBy().isLockOwner())}))),this.modelDb=P.lazy(()=>n(this,void 0,void 0,(function*(){return(yield this.modelDbJanitor()).db.promise}))),this.statsDb=P.lazy(()=>n(this,void 0,void 0,(function*(){return L.statsDbJanitor(yield this.cacheDir())}))),this.statsDbFile=P.lazy(()=>this.statsDb().then(e=>e.dbfile)),this.onEnd=P.lazy(()=>n(this,void 0,void 0,(function*(){for(const{ea:e,t:t}of[{ea:this.statsDb,t:y.CmdTimeoutMs},{ea:this.modelDbJanitor,t:w.minuteMs},{ea:this.openedBy,t:y.CmdTimeoutMs}])yield M.map(yield e.prior(),e=>r.end(e,t));this.logger.info("onEnd(): finished.")}))),this.rootDir=l.PosixFile.for(e),this.dataDir=m.libraryDataDir(this.rootDir),this.logger.info("new()")}static libraryPathChanged(){return M.map(g.Settings.libraryPath.value,u.resolve)!==M.map(this.priorInstance,e=>e.rootDir.nativePath)}static instance(){var e;const t=this.libraryPathChanged(),i=o.isTrue(null===(e=this.priorInstance)||void 0===e?void 0:e.ended);let s;return(t||i)&&(s=r.end(this.priorInstance,w.minuteMs),this.priorInstance=void 0,v.libraryHasSettings.clear()),null==this.priorInstance&&v.libraryHasSettings()&&(this.priorInstance=b.mapNotBlank(g.Settings.libraryPath.value,e=>E.tap(new N(e),e=>n(this,void 0,void 0,(function*(){return yield s,e.setup()}))))),this.priorInstance}static instanceRequired(){const e=N.instance();if(null==e)throw new Error("Library is undefined"+a.FatalErrorFlag);return e}get isPendingSetup(){return this._ready.pending}get ready(){return this._ready.promise}requiredFiles(){const e=[{desc:"System configuration directory",isDir:!0,file:()=>v.systemSettingsFile().parent()}];return this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library model DB",isDir:!1,file:()=>s.thenMap(this.modelDbJanitor(),e=>e.srcDbFile)},{desc:"Library model DB (local replica)",isDir:!1,file:()=>s.thenMap(this.modelDbJanitor(),e=>e.localDbReplica)}),e}}t.Library=N},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Tag=t.DefaultRelatedAssetLimit=void 0;const r=i(12),s=i(8),o=i(13),a=i(76),u=i(316),l=i(16),c=i(1),d=i(3),h=i(4),f=i(2),p=i(0),m=i(5),g=i(18),v=i(41),y=i(318),b=i(79),w=i(35),S=i(115),P=i(114),M=i(233),E=i(181),x=i(92);const _=10*h.secondMs;function T(e){return n(this,void 0,void 0,(function*(){const t=yield e;return null!=t&&D.cacheTag(t),t}))}o.onClearCache(()=>D.clear()),t.DefaultRelatedAssetLimit=72;class D extends x.TimestampedModel{constructor(){super(...arguments),this.urls=f.lazy(()=>new y.TagUrls(this.id))}static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this.recentTagsByPath.clear(),this.tagById.clear(),this._assetCountById.clear(),this._assetFileCountById.clear()}static onAssetTagChange(){this._assetCountById.clear(),this._assetFileCountById.clear()}static cacheTags(e){return e.map(e=>this.cacheTag(e))}static cacheTag(e){return p.map(e,e=>(this.recentTagsByPath.set(e._path,e),p.map(e.id,t=>this.tagById.set(t,e)),e))}static newTag(e){const t=new D;t._path=S.joinTagPath(e);const i=e[e.length-1];return p.map(i.ordinal,e=>t.ordinal=e),t}static findByIdOrPath(e,t){return 0===e?D.root():m.gt0(e)?this.findById(e):this.findByPath(t)}static findById(e){return 0===e?D.root():a.getOrSetAsync(D.tagById,e,()=>T(this.ops().findById(e)))}static findByPath(e){const t=S.joinTagPath(e);return d.blank(t)?D.root():a.getOrSetAsync(D.recentTagsByPath,t,()=>T(this.ops().findOneBy({_path:t})))}static getPagedAssets(e,t){const i=new D;return i.id=e,i.getPagedAssets(t)}static findOrCreate(e){return n(this,void 0,void 0,(function*(){if(c.isEmpty(e))throw new Error("empty tagPath");const t=S.joinTagPath(e,"/"),i=yield this.findByPath(e);if(this.logger().debug("_findOrCreate("+t+")",{prior:i}),null!=i)return i;const n=this.newTag(e),r=n.depth<=1?void 0:yield this.findOrCreate(e.slice(0,-1));p.map(r,e=>n.parentId=e.id);const s=yield T(this.ops().upsertOne(n));return this.logger().debug("_findOrCreate("+t+") upserted",{newTag:n,result:s,parent:r}),s}))}set name(e){const t=null!=this.parent?this.parent.path:[];this._path=r.concat(t,[e]).join(S.TagSep)}get name(){const e=this.path;return e[e.length-1]}get path(){return d.mapNotBlankOr(this._path,e=>e.split(S.TagSep),[])}get isRoot(){return 0===this.id}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}$childrenQuery(){return D.query().where({parentId:this.id}).orderByRaw("COALESCE(ordinal, _path)")}$assetsQuery(){return P.Asset.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],p.map(this.parent,t=>t.setAncestors(e.slice(0,-1)))}toApiTag(){return n(this,void 0,void 0,(function*(){return{tagId:this.id,tagPath:this.path,assetCount:yield this.getAssetCount(),assetFileCount:yield this.getAssetFileCount()}}))}toStringId(){return"Tag("+this.path.join("/")+")"}getParent(){return n(this,void 0,void 0,(function*(){if(!this.isRoot)return null!=this.parentId&&null==this.parent?this.parent=yield D.findById(this.parentId):this.parent}))}getPagedChildren(e){if(0===this.id){const t=p.orElse(e.offset,0),i=t+p.orElse(e.limit,this.children.length);return[...this.children].slice(t,i)}const t=this.$childrenQuery();return l.mapGt0(e.offset,e=>{t.offset(e)}),l.mapGt0(e.limit,e=>{t.limit(e)}),D.ops().all(t)}getChildrenCount(){return n(this,void 0,void 0,(function*(){return null!=this.children?this.children.length:D.dbr(e=>e.pluckFirstf(e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count()))}))}getChildren(){return n(this,void 0,void 0,(function*(){return this.children=yield D.ops().all(this.$childrenQuery()),this.children.forEach(e=>{e.parent=this}),this.children}))}link(){return"/tag/"+this.path.join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}getAncestors(){return n(this,void 0,void 0,(function*(){if(null==this.ancestors){const e=r.ancestry(this.parentPath).map(e=>S.joinTagPath(e)),t=e.map(e=>D.recentTagsByPath.get(e));if(t.every(e=>null!=e))return this.ancestors=t;const i=D.query().whereIn("_path",e).orderBy("_path");this.ancestors=yield D.ops().all(i),D.cacheTags(this.ancestors),this.parent=p.orElse(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}))}getPagedAssets(e){let t=this.$assetsQuery(),i="desc";return l.mapGte0(e.capturedAtLt,e=>{t=t.where("capturedAtLocal","<",e)}),l.mapGte0(e.capturedAtGt,e=>{t=t.where("capturedAtLocal",">",e),i="asc"}),l.mapGte0(e.limit,e=>{t=t.limit(e)}),t=t.orderBy("capturedAtLocal",i),P.Asset.ops().all(t)}getAssets(){const e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return P.Asset.ops().all(e)}assetCountDesc(e){return n(this,void 0,void 0,(function*(){const t=yield this.getAssetCount();return(null==e||e.length===t||0===e.length?"":w.fmt(e.length)+" of ")+w.plur(t,"asset")}))}getDirectAssetCount(){return this._getAssetCountWithQuery(e=>e.where({tagId:this.id}))}getAssetCount(){return a.getOrSetAsync(D._assetCountById,this.id,()=>this._getAssetCountWithQuery(e=>e.join("Tag as t","t.id","AssetTag.tagId").join("Asset as a","a.id","AssetTag.assetId").where("t._path","like",this._path+"%").andWhere("a.shown",1).andWhere("a.hidden",0)))}getAssetFileCount(){return a.getOrSetAsync(D._assetFileCountById,this.id,()=>this._getAssetCountWithQuery(e=>e.join("Tag as t","t.id","AssetTag.tagId").join("Asset as a","a.id","AssetTag.assetId").join("AssetFile as af","af.assetId","a.id").where("t._path","like",this._path+"%").andWhere("a.shown",1).andWhere("a.hidden",0),"af.id"))}_getAssetCountWithQuery(e,t="AssetTag.assetId"){if(null==this.id)return 0;if(0===this.id)return P.Asset.shownCount();const i=E.AssetTag.query().countDistinct(t);return d.notBlank(this._path)&&e(i),s.thenOrElse(E.AssetTag.ops().count(i),()=>0)}$assetStreamQuery(e,t,i){return(this.path[0]===S.When?P.Asset.shownUnhidden():this.$assetsQuery()).orderBy("capturedAtLocal",i?"desc":"asc").where("capturedAtLocal",i?"<":">",e.capturedAtLocal).limit(t)}getAssetStream(e,t){return n(this,void 0,void 0,(function*(){t=m.gt0(t)?t:M.BeforeAfterLimit;const i=yield P.Asset.ops().all(this.$assetStreamQuery(e,t,!0)),n=yield P.Asset.ops().all(this.$assetStreamQuery(e,t,!1));return new M.AssetStream([this],i,n.reverse())}))}getRelatedAssetIds(e,i=t.DefaultRelatedAssetLimit){return n(this,void 0,void 0,(function*(){const t=E.AssetTag.query().distinct("Asset.id","Asset.capturedAtLocal","Asset.updatedAt").join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).orderByRaw(u.prngOrderByClause(e+p.orElse(this.id,0),"Asset.id",p.orElse(yield O(),Math.pow(2,20)))).limit(i),n=yield P.Asset.ops().all(t);return c.sortByInPlace(n,e=>g.Opt(e.capturedAtLocal).map(e=>-e).getOrElse(()=>0)),this.logger().debug(this.path+": Found "+n.length+" related assets"),n.map(e=>e.toID())}))}get attrs(){return{href:this.link(),title:this.name}}}t.Tag=D,D.tableName="Tag",D.uniqueColumnName="_path",D.recentTagsByPath=new b.TTLMap(_),D.tagById=new b.TTLMap(_),D._assetCountById=new b.TTLMap(10*h.secondMs),D._assetFileCountById=new b.TTLMap(10*h.secondMs),D.cmp=(e,t)=>v.cmp([p.orElse(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[p.orElse(t.ordinal,Number.MAX_SAFE_INTEGER),...t.path]),D.root=f.lazy(()=>n(void 0,void 0,void 0,(function*(){const e=new D;return e.id=0,e.name="",e._path="",e.parentId=void 0,e.children=yield D.roots(),e.ancestors=[],e.upsert=()=>{throw new Error("upsert not supported on root")},e})),_),D._upsertDefaultRoots=f.lazy(()=>D.ops().upsert(S.Roots.map(e=>({_path:e.name,ordinal:e.ordinal})))),D.roots=f.lazy(()=>n(void 0,void 0,void 0,(function*(){yield D._upsertDefaultRoots();const e=yield D.ops().all(D.query().whereNull("parentId").orderByRaw("coalesce(ordinal, _path)"));return e.forEach(e=>{e.parentId=void 0,e.ancestors=[],D.cacheTag(e)}),e})));const O=f.lazy(()=>n(void 0,void 0,void 0,(function*(){return m.base10Ceil(yield P.Asset.dbr(e=>e.pluckFirstf(e=>e.count("id"))))})),10*h.secondMs)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseDimensions=t.ltEither=t.ltBoth=t.tmegapixels=void 0;const n=i(1),r=i(85),s=i(5),o=i(7);t.tmegapixels=function(e){return null!=e.dimensions?r.dmegapixels(e.dimensions):s.gt0(e.Megapixels)?e.Megapixels:void 0},t.ltBoth=function(e,t){return s.lt(e.width,t.width)&&s.lt(e.height,t.height)},t.ltEither=function(e,t){return s.lt(e.width,t.width)||s.lt(e.height,t.height)},t.parseDimensions=function(e){const t=n.compact(o.toS(e).split(/[xÃ]/).map(e=>s.toInt(e)));return 2==t.length?{width:t[0],height:t[1]}:void 0}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractSizeInfo=void 0;const n=i(85),r=i(2),s=i(5),o=i(12),a=i(6),u=r.lazy(()=>a.mkLogger("SizeInfo"));t.extractSizeInfo=function(e,t,i){const r=o.first([null==i?void 0:i.ImageSize,{width:e.ImageWidth,height:e.ImageHeight}],e=>n.isDimensions(e)?e:void 0);if(u().debug("extractSizeInfo()",{filename:e.FileName,mimetype:e.MIMEType,rawInfo:i,fileDimensions:r}),null==r)return;const a=n.maybeFlip(r,t),l=s.sigFigs(a.width/a.height,5);return{ImageHeight:a.height,ImageWidth:a.width,aspectRatio:l,dimensions:a,rotation:t,fileDimensions:r}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.extractImageForThumbs=t.sharpReadable=t.imgFromExif=void 0;const r=i(72),s=i(56),o=i(3),a=i(2),u=i(0),l=i(8),c=i(69),d=i(178),h=i(6),f=i(9),p=i(39),m=i(48),g=i(128),v=i(133),y=i(66),b=i(132),w=i(113),S=i(129),P=i(221),M=i(118),E=i(82),x=h.mkLogger("SharpReadable");function _(e,t,i,r){return n(this,void 0,void 0,(function*(){return u.map(t,t=>u.map(t[i],()=>l.thenMap(D(e,i),t=>l.thenMap(w.dimensions(t),n=>x.tap({msg:"imgFromExif",meta:{src:e.baseWithGrandparent,tag:i,dim:n,minDim:r},result:b.ltBoth(r,n)?t:void 0})))))}))}t.imgFromExif=_;const T=a.lazy(()=>r.concurrency(y.maxCpus()));function D(e,t){const i=t.toLowerCase().endsWith("tiff")?".tiff":".jpg";return l.thenMap(S.cachedImgFile(e,t,i),i=>i.applyIfEmpty(i=>n(this,void 0,void 0,(function*(){try{return p.extractBinaryTag(t,e.nativePath,i.nativePath)}catch(i){return void x.warn("Failed to extract embedded "+t+" from "+e.nativePath+": "+i)}}))))}t.sharpReadable=function(e,t,i=!1){return c.time("sharpReadable "+e.normalizedExt,()=>function(e,t,i=!1){return n(this,void 0,void 0,(function*(){T();const r=!i,a=yield p.readRawTags(e,r),c=null==a?void 0:a.MIMEType;if(null==a||o.blank(c))throw new Error(e+" is not supported (missing mimetype)");const h=[],y=g.extractRotation(a),b=v.extractSizeInfo(a,y,d.dcrawSupportedMimetype(c)?yield P.rawInfo(e):void 0);if(null!=b){const n=u.orElse(t,{width:.95*b.dimensions.width,height:b.dimensions.height});if((i||null==y||0===y)&&!E.isVideoMimeType(c)){const i=f.Settings.useEmbeddedPreviews.valueOrDefault?["PreviewImage","PreviewTIFF","JpgFromRaw"]:[];f.Settings.useEmbeddedThumbnails.valueOrDefault&&null!=t&&t.width<=120&&t.height<=120&&i.unshift("ThumbnailImage","ThumbnailTIFF"),h.push(...i.map(t=>()=>_(e,a,t,n)))}}m.isSharpMimetype(c)&&h.push(()=>n(this,void 0,void 0,(function*(){return e}))),null!=b&&d.dcrawSupportedMimeTypes.has(c)&&h.push(()=>(x.info("sharpReadable() -> dcraw()",{src:e.nativePath,minDim:t}),S.readableToFile({src:e,desc:"Converting raw image",suffix:".tiff",f:()=>d.dcraw(e)}))),h.push(()=>s.retryOnReject(()=>M.extractVideoFrame(e,c),{maxRetries:1}));const w=[],D=yield l.firstResolvedDefinedPromise(h,t=>{x.warn("strategy failed for "+e+": "+t),w.push(t)});if(null==D)throw u.orElse(w[0],new Error("Cannot read "+e));return D}))}(e,t,i))},t.extractImageForThumbs=D},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.capturedAtFromTags=t.extractCapturedAt=t.addTzFromSibs=t.hasSubSecCapturedAt=t.capturedAtTags=t.bestCapturedAt=t.CapturedAt=t.capturedAtSrcFromTags=void 0;const r=i(73),s=i(1),o=i(4),a=i(20),u=i(2),l=i(0),c=i(15),d=i(7),h=i(12),f=i(62),p=i(8),m=i(26),g=i(51),v=i(24),y=i(194);function b(e){return d.toS(e).toLowerCase().startsWith("tags")}t.capturedAtSrcFromTags=b;class w{constructor(e,t,i,n,r){this.file=e,this.date=t,this.src=i,this.mtime=n,this.precisionMs=r,this.toISOString=u.lazy(()=>g.datedToISO(this.date))}spread(e){const t=Object.assign(Object.assign({},this),e);return new w(t.file,t.date,t.src,t.mtime)}toLocal(){return m.isoToLocal(this.toISOString())}toOffset(){return g.datedToOffsetMinutes(this.date)}get isFromTags(){return b(this.src)}toPrecisionMs(){return l.orElse(this.precisionMs,()=>g.datedToPrecisionMs(this.date))}toString(){return a.stringify({file:this.file.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return g.hasZone(this.date)}hasTime(){return g.hasTime(this.date)}}function S(e,t){return n(this,void 0,void 0,(function*(){if(!g.validDate(t))return;if(g.hasZone(t))return t;const i=yield y.nearestSiblingTzOffset(e);if(null!=i){const e=g.toExifDateTime(t,i);if(g.validDate(e))return e}return t}))}function P(e){return l.map(e,e=>h.first(["SubSecDateTimeOriginal","DateTimeOriginal","SubSecCreateDate","CreateDate","SubSecMediaCreateDate","MediaCreateDate","OriginalCreateDateTime","DateTimeCreated","DateTimeUTC","GPSDateTime"],t=>g.mapValidDate(e[t],e=>({date:e,src:t}))))}t.CapturedAt=w,t.bestCapturedAt=function(e){return n(this,void 0,void 0,(function*(){const t=s.sortBy(e,e=>-e.mtime.getTime());return v.firstThunk(()=>t.find(e=>e.src.startsWith("tags")),()=>t.find(e=>e.src.startsWith("bname+stat")),()=>t.find(e=>e.src.startsWith("bname")),()=>t.find(e=>e.src.startsWith("siblings")),()=>t.find(e=>e.src.startsWith("path")),()=>e[0])}))},t.capturedAtTags=function(e){return e=s.sortBy(c.toA(e),e=>-e.mtime),h.firstNonEmptyThunk(()=>e.filter(e=>e.src.startsWith("tags")),()=>e.filter(e=>e.src.startsWith("bname+stat")),()=>e.filter(e=>e.src.startsWith("bname")),()=>e.filter(e=>e.src.startsWith("siblings")),()=>e.filter(e=>e.src.startsWith("path")),()=>e.filter(e=>e.src.startsWith("stat")).slice(1,1),()=>[])},t.hasSubSecCapturedAt=function(e){return null!=e&&h.anyDefined([e.SubSecTime,e.SubSecTimeDigitized,e.SubSecTimeOriginal,e.SubSecCreateDate,e.SubSecDateTimeOriginal])},t.addTzFromSibs=S,t.extractCapturedAt=function(e,t,i){return n(this,void 0,void 0,(function*(){const a=yield e.mtime(),u=(o,u)=>n(this,void 0,void 0,(function*(){return p.thenMap(u,u=>p.thenMap(function(e,t,i,s){return n(this,void 0,void 0,(function*(){const n=yield i;if(g.validDate(n))return g.hasZone(n)?n:null!=t&&null!=t.tz&&r.Info.isValidIANAZone(t.tz)?g.setZone(n,t.tz):s?n:S(e,n)}))}(e,t,u.date,i),t=>new w(e,t,s.compactBlanks([o,u.src]).join(":"),a,u.precisionMs)))}));return f.firstDefinedLater(()=>u("tags",P(t)),()=>u("bname+stat",y.extractStatBname(e)),()=>i?void 0:u("siblings",y.inferCapturedAtFromSiblings(e)),()=>i?void 0:u("bname",l.map(g.parseDated(y.bname(e)),e=>({date:e,src:"",precisionMs:h.max([g.datedToPrecisionMs(e),o.secondMs])}))),()=>i?void 0:u("path",l.map(g.extractDateFromPath(e.pathnamesWithoutDrive),e=>({src:"",date:e}))),()=>u("stat",p.thenMap(e.minStatDate(),e=>({src:"",date:e}))))}))},t.capturedAtFromTags=P},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.appData=void 0;const n=i(31),r=i(3),s=i(59),o=i(86),a=i(14);t.appData=function(){const e=[s.getEnv("PS_CONFIG_DIR"),a.isDocker()?"/ps/config":void 0];a.isWin&&e.push(s.getEnv("APPDATA")),a.isPosix&&e.push(s.getEnv("XDG_DATA_HOME"),s.getEnv("XDG_CONFIG_HOME"));const t=r.firstNotBlank(...e);return r.notBlank(t)?t:a.isWin?n.resolve(o.homeDir(),"AppData","Roaming"):a.isMac?n.resolve(o.homeDir(),"Library","Application Support"):n.resolve(o.homeDir(),".config")}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NiceLevel=t.PriorityClasses=void 0;const n=i(36);t.PriorityClasses=n.strEnum("AboveNormal","Normal","BelowNormal","Idle"),t.NiceLevel=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BooleanSetting=t.BoundedFloatSetting=t.BoundedIntegerSetting=t.FloatSetting=t.MaybeIntegerSetting=t.IntegerSetting=t.StringEnumsSetting=t.StringArraySetting=t.splitStringArray=t.StringEnumSetting=t.StringSetting=t.MaybeStringSetting=t.Setting=t.SystemCategories=t.LibraryCategories=t.SettingCategories=t.envAtStartup=void 0;const n=i(31),r=i(19),s=i(1),o=i(3),a=i(20),u=i(0),l=i(5),c=i(18),d=i(36),h=i(44),f=i(15),p=i(7),m=i(22),g=i(45),v=i(28);t.envAtStartup=c.Opt(Object.assign({},r.env)).map(e=>v.isProd?Object.freeze(e):e).get(),t.SettingCategories=d.strEnum("Logging","System","Tools","Updates","Db","Filters","Previews","Reporting","Sync","Tagging","Web"),t.LibraryCategories=Object.freeze([t.SettingCategories.Db,t.SettingCategories.Filters,t.SettingCategories.Previews,t.SettingCategories.Reporting,t.SettingCategories.Sync,t.SettingCategories.Tagging,t.SettingCategories.Web]),t.SystemCategories=Object.freeze(t.SettingCategories.values.filter(e=>!t.LibraryCategories.includes(e)));const y=e=>o.notBlank(e)&&"undefined"!==e?p.toS(e).trim():void 0;class b{constructor(e){this.opts=e,this._persist=!1,this.listeners=[],this.importFromEnv()}hasValue(){return null!=this._value}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){return c.Opt(e).orElse(()=>r.env).flatMap(e=>e[this.opts.key]).filter(o.notBlank).orElse(()=>c.Opt(this.opts.alternateKeys).map(e=>e.map(e=>r.env[e])).flatMap(e=>e.find(o.notBlank))).flatMap(this.opts.fromEnv).get()}importFromEnv(e=r.env){if(!this._persist)return u.map(this.readFromEnv(e),e=>this.setValue(e))}importFromFile(e){if(!this.hasValue()||this._persist)return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){s.filterInPlace(this.listeners,t=>t===e)}onChange(){const e=this.value;this.listeners.forEach(t=>t(e))}get name(){return this.opts.name}get persist(){return this._persist}get key(){return this.opts.key}get category(){return this.opts.category}get transient(){return!0===this.opts.transient}get advanced(){return u.mapOr(this.opts.advanced,e=>e(),()=>!0)}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}set tmpValue(e){this._persist=!1,this.addToEnv(r.env,e),this.setValue(e)}setValue(e){const t=this._value,i=this.opts.toEnv(e),n=this.opts.fromEnv(i);return this._value=n,g.eql(t,this._value)||this.onChange(),this._value}get defaultValue(){return h.tot(this.opts.defaultValue)}get exampleValue(){return c.Opt(this.opts.exampleValue).flatMap(e=>e()).filter(o.notBlank).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return null!=this.value?this.value:this.defaultValue}maybeAddToEnv(e,t){const i=u.orElse(e,r.env);return this.hasValue()&&(i[this.opts.key]=y(this.opts.toEnv(u.orElse(t,this.valueOrDefault)))),i}addToEnv(e,t){const i=u.orElse(e,r.env);return i[this.opts.key]=y(this.opts.toEnv(u.orElse(t,this.valueOrDefault))),i}deleteFromEnv(e){const t=u.orElse(e,r.env);return delete t[this.opts.key],u.map(this.opts.alternateKeys,e=>e.forEach(e=>{delete t[e]})),t}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),this}addToJSON(){return{}}toJSON(){return{key:this.opts.key,value:this.value,defaultValue:this.opts.defaultValue,description:this.opts.description}}}t.Setting=b;t.MaybeStringSetting=class extends b{constructor(e){super(Object.assign({toEnv:y,fromEnv:y,defaultValue:void 0},e))}hasValue(){return o.notBlank(this.value)}};function w(e,t){const i=p.toS(e).toLowerCase();return t.find(e=>e.toLowerCase()===i)}t.StringSetting=class extends b{constructor(e){super(Object.assign({toEnv:y,fromEnv:y},e))}hasValue(){return o.notBlank(this.value)}};function S(e){return o.mapNotBlank(p.toS(e).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return s.compactBlankish(f.toA(JSON.parse(e)))}catch(e){}for(const t of["Â¦",n.delimiter])if(e.includes(t))return s.compactBlankish(e.split(t));return[e]})}t.StringEnumSetting=class extends b{constructor(e){super(Object.assign({toEnv:t=>w(t,e.validValues),fromEnv:t=>w(t,e.validValues)},e)),this.validValues=e.validValues;if(null!=this.defaultValue&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}},t.splitStringArray=S;t.StringArraySetting=class extends b{constructor(e){super(Object.assign({defaultValue:[],fromEnv:S,toEnv:e=>c.Opt(f.toA(e)).map(s.compactBlanks).map(s.uniq).filter(s.isNotEmpty).map(e=>a.stringify(e)).get()},e))}get values(){return s.uniq(s.compactBlanks(this.valueOrDefault))}pushFromEnv(...e){this.tmpValue=s.uniq(s.compactBlanks(this.valueOrDefault.concat(...e)))}removeValueFromEnv(e){u.map(this.value,t=>this.tmpValue=t.filter(t=>t!==e))}};t.StringEnumsSetting=class extends b{constructor(e){super(Object.assign({fromEnv:e=>o.mapNotBlank(e,e=>{try{return this.asValidValues(JSON.parse(e))}catch(t){return this.asValidValues(e.split(n.delimiter))}}),toEnv:e=>u.map(e,e=>a.stringify(s.uniq(e)))},e)),this.validValues=e.validValues}asValidValues(e){return s.compactBlankish(f.toA(e).map(e=>w(p.toS(e),this.validValues)))}addToJSON(){return{validValues:this.validValues}}};t.IntegerSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:l.toInt}))}};t.MaybeIntegerSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:l.toInt,defaultValue:void 0}))}};t.FloatSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:l.toFloat}))}};t.BoundedIntegerSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:t=>c.Opt(t).flatMap(parseInt).map(t=>l.clamp(e.min,e.max,t)).get()})),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};t.BoundedFloatSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:t=>c.Opt(t).flatMap(parseFloat).map(t=>l.clamp(e.min,e.max,t)).get()})),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};t.BooleanSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:m.toBoolean}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedList=void 0;const n=i(5);class r{constructor(e){if(this.maxLength=e,this._length=0,this._firstIndex=0,e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...n.times(e,()=>null))}mapIndex(e,t){return e<0||e>this._length-1?void 0:t((e+this._firstIndex+this.maxLength)%this.maxLength)}get(e){return this.mapIndex(e,e=>this.store[e])}set(e,t){return this.mapIndex(e,e=>this.store[e]=t)}get length(){return this._length}set length(e){this._length=n.clamp(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){const e=this;return function*(){for(let t=0;t<e.length;t++)yield e.mapIndex(t,t=>e.store[t])}()}push(...e){for(const t of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,e=>{this.store[e]=t});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(const t of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,e=>{this.store[e]=t,this._firstIndex=e});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}every(e){for(let t=0;t<this._length;t++)if(!e(this.get(t),t))return!1;return!0}some(e){for(let t=0;t<this._length;t++)if(e(this.get(t),t))return!0;return!1}forEach(e){for(let t=0;t<this._length;t++)e(this.get(t),t)}map(e){const t=[];for(let i=0;i<this._length;i++)t.push(e(this.get(i),i));return t}reduce(e,t){let i=t;for(let t=0;t<this._length;t++)i=e(i,this.get(t),t);return i}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,t=>{this.mapIndex(this._length-1-e,e=>{const i=this.store[e];this.store[e]=this.store[t],this.store[t]=i})});return this}toA(){return[...this]}slice(e,t){return[...this].slice(e,t)}}t.BoundedList=r},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("stream")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.renice=void 0;const r=i(4),s=i(2),o=i(0),a=i(7),u=i(21),l=i(13),c=i(6),d=i(16),h=i(14),f=i(137),p=i(42),m=i(9),g=i(143),v=s.lazy(()=>c.mkLogger("Renice")),y=new g.TTLSet(r.minuteMs);l.onClearCache(()=>y.clear()),t.renice=function(e,t){return n(this,void 0,void 0,(function*(){return y.addIfMissing(e,()=>n(this,void 0,void 0,(function*(){const i=f.PriorityClasses.validOrElse(t,()=>m.Settings.processPriority.valueOrDefault);return d.mapGt0(e,()=>n(this,void 0,void 0,(function*(){try{yield h.isWin?function(e,t){return n(this,void 0,void 0,(function*(){return d.mapGt0(e,i=>f.PriorityClasses.map(t,i=>p.PowerShell.instance().execute(`(Get-Process -Id ${e}).PriorityClass = "${t}"`,e=>e)))}))}(e,i):function(e,t=19){return n(this,void 0,void 0,(function*(){return u.stdoutResult("renice",[t,"-p",e].map(a.toS),{timeout:10*r.secondMs})}))}(e,o.orElse(f.NiceLevel[i],9)),v().info("Renice pid "+e+" to "+i)}catch(t){return void v().info("Failed to renice pid "+e,t)}})))})))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLSet=void 0;const n=i(11);class r{constructor(e){this.ttlMs=e,this.expireListeners=[],this.delegate=new Map,this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,t=this.ttlMs){return this.delegate.set(e,Date.now()+(t-this.ttlMs)),this}addIfMissing(e,t){const i=this.delegate.get(e);return null==i||this.expired(e,i)?(this.add(e),t()):void 0}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(const[t,i]of this.delegate)this.expired(t,i)||e(t,t,this)}has(e){return!this.expired(e,this.delegate.get(e))}values(){const e=this;return function*(){for(const[t,i]of e.delegate.entries())e.expired(t,i)||(yield t)}()}entries(){const e=this;return function*(){for(const[t,i]of e.delegate.entries())e.expired(t,i)||(yield[t,t])}()}toA(){return this.vacuum(),[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}on(e,t){this.expireListeners.push(t)}expired(e,t){return n.tap(null==t||t+this.ttlMs<=Date.now(),i=>{null!=t&&i&&(this.expireListeners.forEach(t=>t(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,t)=>{this.expired(t,e)})}}t.TTLSet=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.recentLogEntries=t.addRecentLogEntry=t.clearRecentLogEntries=t.SentLogLevels=void 0;const n=i(1),r=i(2),s=i(54),o=i(12),a=i(139),u=i(107),l=new Map;t.SentLogLevels=r.lazy(()=>o.diff(u.LogLevels.values,["trace"]));t.clearRecentLogEntries=function(){l.clear()},t.addRecentLogEntry=function(e){var t;e.l!==u.LogLevels.trace&&(t=e.l,s.getOrSet(l,t,()=>new a.BoundedList(24))).push(e)},t.recentLogEntries=function(){const e=[];for(const t of l.values())e.push(...t.toA());return n.sortBy(e,e=>e.ts)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.zReadFile=t.zcat=void 0;const r=i(46),s=i(105),o=i(2),a=i(25),u=i(7),l=i(6),c=i(61),d=i(214),h=o.lazy(()=>l.mkLogger("zcat"));function f(e,t){return n(this,void 0,void 0,(function*(){const i=new d.WritableToBuffer,n=[r.createReadStream(e,Object.assign({autoClose:!0},t))];return e.toLowerCase().endsWith(".gz")?n.push(s.createGunzip()):e.toLowerCase().endsWith(".br")&&n.push(s.createBrotliDecompress()),n.push(i),yield c.pipelineAsync(n),i.buffer}))}t.zcat=function(e,t){return n(this,void 0,void 0,(function*(){try{return a.thenMap(f(e,t),u.toS)}catch(t){return void h().warn("zcat failed to read "+e,t)}}))},t.zReadFile=f},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const r=i(2),s=i(29),o=i(106),a=i(167);class u{log(e,t,i,n){a.pushLogEntries({ts:Date.now(),l:e,from:s.processName(),ctx:t,msg:i,meta:n})}enabled(e,t){return o.logFilter().enabled(e,t)}flush(){return n(this,void 0,void 0,(function*(){}))}end(){}}t.ConsoleLogger=u,u.instance=r.lazy(()=>new u)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.uri2protocol=t.toUrl=t.uri2file=t.addUriParser=t.FileUriToFile=t.PsnetUriToFile=t.PsfileUriToFile=t.uriToString=t.nativePath2uriString=t.file2voluri=t.file2fileuri=t.addUriFormatter=t.FileToPsUri=t.volumeURI=t.uriEql=t.uriEqlSync=t.volsha=t.FileToFileUri=t.isUri=void 0;const r=i(241),s=i(119),o=i(1),a=i(3),u=i(4),l=i(2),c=i(0),d=i(11),h=i(7),f=i(87),p=i(12),m=i(81),g=i(8),v=i(22),y=i(13),b=i(6),w=i(168),S=i(10),P=i(95),M=i(40),E=i(70),x=i(30),_=i(32),T=l.lazy(()=>b.mkLogger("FileURI")),D=["http:","https:","file:",f.PS_LOCAL_FILE_PROTOCOL,f.PS_NETWORK_FILESYSTEM_PROTOCOL].map(e=>e+"//");function O(e,t){try{return null!=e&&null!=t&&(e===t||decodeURI(h.toS(e)).normalize()===decodeURI(h.toS(t)).normalize())}catch(e){return!1}}function F(e,i,s=!0){return n(this,void 0,void 0,(function*(){const n=encodeURI(i.posixPathFrom(_.PosixFile.for(e.mountpoint)));return a.notBlank(e.uuid)?{protocol:f.PS_LOCAL_FILE_PROTOCOL,hostname:t.volsha(e.uuid),pathname:n,slashes:!0,volume:e}:v.isTrue(e.remote)&&a.notBlank(e.remoteHost)&&a.notBlank(e.remoteShare)?{protocol:f.PS_NETWORK_FILESYSTEM_PROTOCOL,hostname:r.toASCII(s?yield w.friendlyname(e.remoteHost):e.remoteHost),pathname:r.toASCII(e.remoteShare)+(a.blank(n)?n:"/"+n),slashes:!0,volume:e}:void 0}))}t.isUri=function(e){const t=h.toS(e).toLowerCase();return D.some(e=>t.startsWith(e))},t.FileToFileUri=e=>{if(null==e||a.blank(e.posixPath))return;const t=h.toS(e.hostname),i={pathname:encodeURI(S.stripPrefix(e.posixPath,"//"+t)),protocol:"file:",slashes:!0};return a.notBlank(t)&&(i.hostname=r.toASCII(t)),i},t.volsha=m.memoize(e=>d.tap(a.mapNotBlank(e,E.shortStringSha),t=>T().debug("volsha",{uuid:e,ea:t})),1*u.hourMs,128),y.onClearCache(()=>t.volsha.clear()),t.uriEqlSync=O,t.uriEql=function(e,t){return n(this,void 0,void 0,(function*(){if(null==e||null==t)return!1;if(O(e,t))return!0;const i=yield _.PosixFile.forUri(e);return null!=i&&i.eql(yield _.PosixFile.forUri(t))}))},t.volumeURI=F,t.FileToPsUri=e=>{const t=_.PosixFile.for(x.posix2native(e.posixPath));return g.thenMap(P.volumeFor(t.nativePath),e=>F(e,t))};const I=[t.FileToPsUri,t.FileToFileUri];function k(e){return n(this,void 0,void 0,(function*(){if(null!=e&&!a.blank(e.posixPath))return p.firstAsync(I,t=>t(e)).catch(t=>{T().warn("file2voluri failed",{file:e,err:t})})}))}t.addUriFormatter=function(e){-1===I.indexOf(e)&&I.unshift(e)},t.file2fileuri=function(e){return s.format(t.FileToFileUri(e))},t.file2voluri=k,t.nativePath2uriString=function(e){return g.thenMap(k({posixPath:x.native2posix(e)}),s.format)},t.uriToString=function(e){if(null==e||"string"==typeof e)return e;try{return s.format(e)}catch(t){return void T().warn("toString failed",{uri:e,err:t})}};const C=/^[a-z]+:\/\/([a-z0-9-.]+?)(?:\/(.+)?)?$/i;t.PsfileUriToFile=(e,i)=>n(void 0,void 0,void 0,(function*(){if(null==e||a.blank(i))return;if(!S.equalsIgnoreCase(e.protocol,f.PS_LOCAL_FILE_PROTOCOL))return;const n=yield P.volumes();if(o.isEmpty(n))return void T().warn("PsfileUriToFile(): volumes() was empty: Can't resolve "+i);const r=i.match(C);if(null==r)return void T().warn("PsfileUriToFile(): didn't match regex",{raw:i});const s=r[1];if(a.blank(s))return void T().warn("PsfileUriToFile(): no volsha",{raw:i});const u=S.stripSuffix(decodeURI(h.toS(r[2])),"/").split("/"),l=n.find(e=>!e.remote&&a.notBlank(e.uuid)&&s===t.volsha(e.uuid));if(null!=l)return{posixPath:M.BaseFile.for(l.mountpoint).join(...u).posixPath};{const e=n.filter(e=>null!=e.uuid).map(e=>t.volsha(e.uuid));T().warn("PsfileUriToFile(): no volume had matching volsha",{raw:i,volid:s,volshas:e})}})),t.PsnetUriToFile=e=>n(void 0,void 0,void 0,(function*(){if(null==e)return;if(!S.equalsIgnoreCase(e.protocol,f.PS_NETWORK_FILESYSTEM_PROTOCOL))return;if(a.blank(e.pathname)||a.blank(e.hostname))return;const t=r.toUnicode(h.toS(e.hostname)),i=S.stripPrefix(h.toS(e.pathname),"/").split("/"),n=r.toUnicode(i.shift());if(a.blank(n))return;const s=i.map(decodeURIComponent);return g.thenMap(P.remoteVolumeFor(t,n),e=>({posixPath:M.BaseFile.for(e.mountpoint).join(...s).posixPath}))})),t.FileUriToFile=e=>{if(null==e)return;if(!S.equalsIgnoreCase(e.protocol,"file:")||a.blank(e.pathname))return;const t=decodeURI(h.toS(e.hostname)),i=decodeURI(h.toS(e.pathname));return a.notBlank(t)?{hostname:t,posixPath:i}:{posixPath:null!=i.match(/^\/[A-Z]:\//i)?i.substring(1):i}};const A=[t.PsfileUriToFile,t.PsnetUriToFile,t.FileUriToFile];function L(e){if(null!=e){if("string"!=typeof e&&[e.protocol,e.pathname,e.hostname].every(a.notBlank))return e;try{return s.parse(h.toS(e),!0)}catch(t){return void T().warn("toUrl failed",{uri:e,err:t})}}}t.addUriParser=function(e){-1===A.indexOf(e)&&A.unshift(e)},t.uri2file=function(e,t){return n(this,void 0,void 0,(function*(){if(a.blank(e))return;const i=function(e){try{return s.parse(e,!1,!0)}catch(t){return void T().warn("bad URI",{uri:e,err:t})}}(e);return null!=i?p.firstAsync(A,t=>t(i,e)).catch(n=>{if(T().warn("uri2file failed",{uri:e,err:n}),a.notBlank(t)&&null!=i.pathname){const e=i.pathname.split("/").slice(1);return{posixPath:_.PosixFile.for(t).join(...e).posixPath}}}):void 0}))},t.toUrl=L,t.uri2protocol=function(e){return c.map(L(e),e=>c.denull(e.protocol))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sqliteNativePath=t.jpegtranNativePath=t.dcrawNativePath=t.systemPathToTool=t.pathToTool=t.pathTo=void 0;const r=i(49),s=i(3),o=i(2),a=i(0),u=i(62),l=i(21),c=i(23),d=i(28),h=i(14),f=i(27),p=i(40),m=i(112);function g(e){return n(this,void 0,void 0,(function*(){const t=h.isWin?"where":"which";try{const i=yield l.stdout(t,[e],{timeout:f.CmdTimeoutMs});return s.mapNotBlank(i,e=>e.trim())}catch(e){return}}))}function v(e){return n(this,void 0,void 0,(function*(){return h.isElectron||!h.isDocker()&&d.isTest?function(e){return n(this,void 0,void 0,(function*(){const t=a.map(m.ProjectPath.Tools(),e=>p.BaseFile.for(e));if(null==t||(yield t.isNotDirectory()))throw new Error("Cannot find project path for tools"+c.FatalErrorFlag);function i(i){return null==t?void 0:t.join(h.platformName+"-"+i,e,e+(h.isWin?".exe":""))}return u.firstDefinedLater(()=>y(i(r.arch())),()=>"x64"===r.arch()?y(i("ia32")):void 0,()=>b(e))}))}(e):b(e)}))}function y(e){return n(this,void 0,void 0,(function*(){return null!=e&&(yield e.exists())?e.nativePath:void 0}))}function b(e){return n(this,void 0,void 0,(function*(){return u.firstDefinedLater(()=>g(e),()=>{var t;return y(null===(t=p.BaseFile.for(m.ProjectPath.Bin()))||void 0===t?void 0:t.join(e))},()=>h.isDocker()?y(p.BaseFile.for("/ps/app/bin").join(e)):void 0,()=>{throw new Error("Cannot find path for "+e)})}))}t.pathTo=g,t.pathToTool=v,t.systemPathToTool=b,t.dcrawNativePath=o.lazy(()=>v("dcraw")),t.jpegtranNativePath=o.lazy(()=>v("jpegtran")),t.sqliteNativePath=o.lazy(()=>v("sqlite3"))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.firstMigratedAt=t.knex=void 0;const r=i(313),s=i(8),o=i(0),a=i(11);t.knex=r({client:"sqlite3",useNullAsDefault:!0}),t.firstMigratedAt=function(e){return n(this,void 0,void 0,(function*(){return s.thenMap(e("migrations").min("migration_time").first(),e=>o.map(a.values(e)[0],e=>new Date(e)))}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.tx=void 0;const r=i(17),s=i(23),o=i(6),a=i(9),u=i(56),l=i(4),c=i(34),d=i(37),h=i(2),f=i(25),p=i(78),m=i(153),g=i(162),v=h.lazy(()=>o.mkLogger("Transactions")),y=l.minuteMs;let b=!1;t.tx=function(e,t,i=!1,o=!1){return n(this,void 0,void 0,(function*(){if(null==e.db)throw new Error("tx(): null db");let l=!1;try{return i&&(b=!0),o||null==(yield f.until(()=>!g.isVacuuming(e),y,1e3))&&v().throw("Timeout while waiting for vacuum"),yield u.retryOnReject(()=>n(this,void 0,void 0,(function*(){return e.inTransaction?t(e.db):m.handleDbRetries(()=>e.db.transaction(()=>t(e.db)).deferred())})),{maxRetries:10,errorIsRetriable:t=>n(this,void 0,void 0,(function*(){return!i&&!b&&(l||!s.isSqliteDisconnectedError(t)||r.ending()||(v().warn("Trying to reopen the db "+e.dbfile+": "+d.errorToVerbose(t)),yield e.reopenDb(),l=!0),s.isSqliteBusyError(t)||s.isSqliteDisconnectedError(t))})),timeoutMs:a.Settings.maxBusyDbMs.valueOrDefault/10,onRetryWaitUntil:()=>c.delay(p.randomInt(10,a.Settings.maxBusyDbMs.valueOrDefault/10))})}catch(e){if(i||b)return;throw v().warn("tx(): raised",e),e}finally{i&&(b=!1)}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FileCache=t.InstanceCacheMaxSize=t.InstanceCacheTTL=void 0;const n=i(4),r=i(0),s=i(55),o=i(13);t.InstanceCacheTTL=n.minuteMs,t.InstanceCacheMaxSize=500;class a extends s.BoundedMap{constructor(){super(t.InstanceCacheTTL,t.InstanceCacheMaxSize,!0),o.onFileChanged(e=>this.clearFromPath(e)),o.onClearCache(()=>this.clearEntries()),this.on("expire",(e,t)=>r.map(t,e=>e.clear()))}clearEntries(){for(const e of this.values())e.clear()}clearFromPath(e){for(const t of this.values())(null==e||t.nativePath.startsWith(e))&&t.clear()}}t.FileCache=a},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.hasNoMedia=t.isNoMediaName=void 0;const r=i(31),s=i(3),o=i(4),a=i(2),u=i(5),l=i(8),c=i(22),d=i(55),h=i(26),f=i(13),p=i(6),m=i(40),g=i(158),v=i(30),y=/^\.?NoMedia$/i;function b(e){return null!=y.exec(e)}t.isNoMediaName=b,f.onClearCache(()=>S.clear()),f.onFileChanged(e=>{if(s.blank(e))S.clear();else for(const t of S.keys())t.startsWith(e)&&S.delete(t)});const w=15*o.secondMs,S=new d.BoundedMap(3*o.minuteMs,2e3,!1),P=a.lazy(()=>p.mkLogger("hasNoMedia()"));t.hasNoMedia=function e(t){return n(this,void 0,void 0,(function*(){if(g.pathIsNeverIgnored(t.nativePath))return P().debug(t+" is never ignoed"),!1;if(t instanceof m.BaseFile)return e(yield t.directoryEntry());if(b(t.base))return P().debug(t+" basename is NoMedia"),!0;const i=v.pathnames(t.nativePath);if(i.some(b))return P().debug(t+" parent path is NoMedia"),!0;for(let e=i.length-1;e>0;e--){const n=i.slice(0,e).join(r.sep),s=S.get(n);if(!0===s)return P().debug(t+" ancestor is NoMedia, "+n),!0;if(!1!==s&&(u.isNumber(s)&&(yield l.until(()=>c.isBoolean(S.get(n)),w))&&!0===S.get(n)))return P().debug(t+" ancestor is NoMedia, "+n),!0}const n=S.get(t.nativePath);if(c.isBoolean(n))return P().debug(t+" returning cached result, "+n),n;const s=yield t.isDirectory();if(s){if(null!=n&&h.isRecentMs(n,w)&&(P().debug(t+" is a work-in-progress. Waiting for prior result."),yield l.until(()=>c.isBoolean(S.get(t.nativePath)),w)))return e(t);const i=Date.now();S.set(t.nativePath,i);const r=yield t.children();if(null==r)return P().debug(t+" is a directory but has no children.",{result:!1}),S.set(t.nativePath,!1),!1;if(r.some(e=>b(e.base)))return P().debug(t+" is a directory and has a noMedia child",{result:!0}),S.set(t.nativePath,!0),!0}const o=yield t.parent();if(null==o||t.nativePath===o.nativePath)return P().debug(t+" root",{result:!1}),S.set(t.nativePath,!1),!1;{const i=yield e(o);return s&&S.set(t.nativePath,i),P().debug(t+" from parent",{result:i}),i}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleDbRetriesSync=t.handleDbRetries=void 0;const r=i(17),s=i(23),o=i(6),a=i(80),u=i(93),l=i(9),c=i(4),d=i(34),h=i(78),f=new a.Average,p=new u.Rate(c.minuteMs);new r.EndableWrapper("DbRetries",()=>{o.mkLogger("DbRetries").info("db contention",{busyErrorRate:p.stats(),busyLatencyMs:f.stats()})},r.EndableRanks.first),t.handleDbRetries=function(e){return n(this,void 0,void 0,(function*(){const t=Date.now();let i=0;const n=t+l.Settings.maxBusyDbMs.valueOrDefault;try{for(;Date.now()<n;)try{return yield e()}catch(e){const t=s.isSqliteBusyError(e);if(t&&(p.onEvent(),i++),!t||Date.now()>=n)throw e;yield d.delay(h.randomInt(10,l.Settings.maxBusyDbMs.valueOrDefault/10))}throw new Error("handleDbRetries(): timeout after "+l.Settings.maxBusyDbMs.valueOrDefault+"ms")}finally{i>0&&f.push(Date.now()-t)}}))},t.handleDbRetriesSync=function(e,t=25){let i;for(let n=0;n<t;n++)try{return e()}catch(e){if(i=e,!s.isSqliteBusyError(e))throw e}throw i}},function(e,t){e.exports=require("child_process")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.observeBatchCluster=void 0;const r=i(94),s=i(19),o=i(4),a=i(0),u=i(17),l=i(23),c=i(6),d=i(101),h=i(142),f=i(27);class p{constructor(e,t){this.name=e,this.bc=t,this._ended=!1}get endTimeoutMs(){return"sync-file"===this.name?f.CmdTimeoutMs:o.secondMs}get ended(){return this.bc.ended||this._ended}end(){return n(this,void 0,void 0,(function*(){this._ended=!0,r.setLogger(r.NoLogger),this.bc.ended||(yield this.bc.end())}))}}t.observeBatchCluster=function(e,t,i=u.EndableRanks.service){const n=c.mkLogger(t),f=new p(t,e);r.setLogger(n);const m=(e,i)=>{f.ended||u.ending()||l.isIgnorableError(i)||l.onError(t+": "+e,i)};return e.on("childStart",i=>{n.info("Started child process "+t+":"+i.pid),h.renice(i.pid).catch(e=>l.onError("renice failed for "+t,e)),d.addPid({pid:i.pid,ppid:s.pid,cmd:t,maxAgeMs:e.options.maxProcAgeMillis+o.minuteMs},new Date).catch(e=>l.onError("addPid failed for "+t,e))}),e.on("startError",e=>m("failed to start",e)),e.on("taskError",(e,t)=>{m("failed to run "+a.map(t,e=>e.command),e)}),e.on("internalError",e=>{m("internal error",e)}),e.on("endError",e=>{n.error("observeBatchCluster.endError()",e)}),u.addEndable(i,f)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=void 0,t.throttle=function(e,t,i=!1){let n=i?Date.now()+t:0,r=0;const s=(...i)=>{const s=Date.now();return s>=n?(n=s+t,r++,e(...i)):void 0};return s.count=()=>r,s}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFormatter=void 0;const n=i(2),r=i(9),s=i(215),o=i(216);t.DefaultLogFormatter=n.lazy(()=>r.Settings.logColor.valueOrDefault?new s.ColoredLogFormatter({processName:()=>""}):new o.PlaintextLogFormatter),r.Settings.logColor.addListener(()=>t.DefaultLogFormatter.unset())},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathIsNeverIgnoredPredicate=t.neverIgnore=t.pathIsNeverIgnored=void 0;const n=i(1),r=i(2),s=i(13),o=i(6),a=i(9),u=i(40),l=r.lazy(()=>o.mkLogger("NeverIgnoredPaths")),c=r.lazy(()=>{a.Settings.neverIgnored.addListener(()=>{d.clear(),s.emitFileChanged(),l().info("Settings.neverIgnored changed",a.Settings.neverIgnored.value)}),a.Settings.scanPaths.addListener(()=>{d.clear(),s.emitFileChanged()}),s.onClearCache(()=>d.clear())}),d=r.lazy(()=>(c(),new Set(n.compactBlanks([...a.Settings.scanPaths.values,...a.Settings.neverIgnored.values]))));function h(e){return d().has(e)||d().has(e.toLowerCase())}t.pathIsNeverIgnored=h,t.neverIgnore=function(...e){a.Settings.neverIgnored.pushFromEnv(...n.compactBlanks(e.map(e=>u.BaseFile.for(e).nativePath)))},t.pathIsNeverIgnoredPredicate=function(e){return h(e)?{pathIsNeverIgnored:()=>!1}:void 0}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.runvalve=t.doNotRun=t.healthChecks=t.syncSettingsCheck=t.memoryCheck=t.memoryUsageIsHigh=t.memoryUsageBytes=void 0;const r=i(19),s=i(17),o=i(8),a=i(184),u=i(13),l=i(6),c=i(28),d=i(29),h=i(9),f=i(117),p=i(1),m=i(3),g=i(4),v=i(37),y=i(2),b=i(35),w=i(257);function S(){const e=r.memoryUsage();return e.external+e.heapTotal}function P(){const e=h.Settings.maxMemoryMb.valueOrDefault,t=S(),i=Math.floor(t/b.MB),n=`Memory used by ${d.serviceName()} (${b.fmtBytes(t,2)})`;return i>e?(l.mkLogger("HealthChecks.memoryCheck()").warn(n),{bad:[n+" is high"]}):{ok:[n+" is OK"]}}function M(){return n(this,void 0,void 0,(function*(){if(f.isPaused()||s.ending())return!0;const e=yield t.healthChecks();return null==e||p.isNotEmpty(e.fail)||p.isNotEmpty(e.bad)||p.isNotEmpty(e.warn)}))}t.memoryUsageBytes=S,t.memoryUsageIsHigh=function(){return h.Settings.maxMemoryMb.valueOrDefault<S()/b.MB},t.memoryCheck=P,t.syncSettingsCheck=function(){return c.isTest||h.Settings.scanMyPictures.valueOrDefault||h.Settings.scanAllDrives.valueOrDefault||!p.isEmpty(h.Settings.scanPaths.values)?{}:{warn:["Nothing to scan: scanMyPictures and scanAllDrives are false and scanPaths is empty."]}},t.healthChecks=y.lazy(()=>n(void 0,void 0,void 0,(function*(){try{return a.concatHealthChecks(yield w.libraryHealthChecks(),P())}catch(e){return a.fullhc({fail:[m.notBlankOr(v.errorToS(e),"healthChecks failed")]})}})),7*g.secondMs),h.Settings.libraryPath.addListener(()=>t.healthChecks.clear()),u.onSettingsChanged(()=>t.healthChecks.clear()),t.doNotRun=M,t.runvalve=function(){return o.thenNot(M())}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.syncFileTimeout=t.dcrawTimeout=t.syncFileTimeoutForFile=t.syncFileTimeoutForFileMs=t.transcodeTimeout=t.transcodeTimeoutForFile=t.DurationMultiplier=t.MaxSyncFileTimeoutMs=t.MinSyncFileTimeoutMs=void 0;const r=i(220),s=i(4),o=i(0),a=i(5),u=i(35),l=i(8),c=i(16),d=i(9),h=i(39),f=i(48),p=i(27);t.MinSyncFileTimeoutMs=p.CmdTimeoutMs,t.MaxSyncFileTimeoutMs=15*s.minuteMs,t.DurationMultiplier=10;const m={p0:{x:.8*u.MB,y:4*s.secondMs},p1:{x:20*u.MB,y:12*s.secondMs}},g={p0:{x:11*u.MB,y:12*s.secondMs},p1:{x:26*u.MB,y:24*s.secondMs}},v={p0:{x:7*u.MB,y:45*s.secondMs},p1:{x:32*u.MB,y:90*s.secondMs}};function y(e){return f.isVideoExt(e.ext)?Math.max(o.orElse(c.mapGt0(e.durationMs,e=>e*t.DurationMultiplier),0),r.lerp2d(v.p0,v.p1,e.bytes)):0}function b(e){return l.thenMap(w(e),S)}function w(e){return l.thenMap(e.size(),t=>n(this,void 0,void 0,(function*(){return{bytes:t,ext:e.ext,durationMs:f.isVideoExt(e.ext)?yield l.thenMap(h.readRawTags(e),e=>c.mapGt0(e.Duration,e=>e*s.secondMs)):void 0}})))}function S(e){const i=a.clamp(.5*u.MB,64*u.GB,e.bytes),n=5*s.secondMs,o=p.CmdTimeoutMs,l=2*i*p.MinIoRate,c=e=>r.lerp2d(e.p0,e.p1,a.clamp(.5*u.MB,50*u.MB,i)),h=c(m),v="raw"===f.extType(e.ext)?c(g):0,b=y(e),w=d.Settings.validateVideos.valueOrDefault?b:0;return{result:a.clamp(t.MinSyncFileTimeoutMs,t.MaxSyncFileTimeoutMs,Math.round(n+o+l+h+v+b+w)),dbMs:n,tagMs:o,copyMs:l,thumbMs:h,rawDecodeMs:v,transcodeMs:b,validateMs:w}}t.transcodeTimeoutForFile=function(e){return f.isVideoExt(e.ext)?l.thenMap(w(e),y):void 0},t.transcodeTimeout=y,t.syncFileTimeoutForFileMs=function(e){return l.thenMap(b(e),e=>e.result)},t.syncFileTimeoutForFile=b,t.dcrawTimeout=function(e){return r.lerp2d(g.p0,g.p1,a.clamp(11*u.MB,100*u.MB,o.orElse(e,0)))},t.syncFileTimeout=S},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.rpcClientEnd=t.rpcClientReady=t.rpcClient=void 0;const r=i(261),s=i(17),o=i(8),a=i(6),u=i(310),l=i(29),c=i(9),d=i(3),h=i(4),f=i(75),p=i(2),m=i(0),g=a.mkLogger("RpcClient");t.rpcClient=p.lazy(()=>{if(l.isRpcServer())return;const e=c.Settings.rpcPort.valueOrDefault;g.debug("Creating new RPC client to "+e);const i=new u.Client("db@localhost:"+e,()=>function(e){const t=new f.Latch,i=new r.Socket;return i.on("error",e=>t.reject(e)),i.connect(e,"localhost",()=>{g.debug("Connected to "+e),t.resolve()}),t.then(()=>i)}(e));return i.addChangeListener(()=>t.rpcClientReady.unset()),i}),t.rpcClientReady=p.lazy(()=>n(void 0,void 0,void 0,(function*(){try{if(l.isRpcServer())return!1;const e=yield o.thenOrTimeout(m.map(t.rpcClient(),e=>e.ping()),h.secondMs);return d.notBlank(e)}catch(e){return g.warn("rpcClientReady(): ping failed",e),!1}})),h.minuteMs),t.rpcClientEnd=function(){return s.end(t.rpcClient.clear())}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withVacuumEvent=t.checkRemoteVacuuming=t.isVacuuming=void 0;const r=i(22),s=i(13),o=i(6),a=i(127),u=i(2),l=i(0),c=i(25),d=i(263),h=i(161);let f;const p=u.lazy(()=>o.mkLogger("Vacuum"));t.isVacuuming=function(e){return(null==e||"models"===e.schema)&&r.isTrue(f)};const m=e=>n(void 0,void 0,void 0,(function*(){"boolean"!=typeof e&&p().throw("invalid setVacuuming argument",{value:e}),p().debug("setVacuuming()",{value:e}),f=e}));s.onVacuuming(m),t.checkRemoteVacuuming=function(){var e;return n(this,void 0,void 0,(function*(){return c.thenMap(null===(e=h.rpcClient())||void 0===e?void 0:e.request("isVacuuming"),e=>(p().info("checkRemoteVacuuming() received RPC value",{value:e}),l.map(e,m)))}))},t.withVacuumEvent=function(e){return n(this,void 0,void 0,(function*(){if(yield d.isLockOwner()){p().info("db vacuum starting...");try{return f=!0,a.broadcast("vacuuming",!0),yield e()}finally{f=!1,a.broadcast("vacuuming",!1),p().info("db vacuum finished.")}}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetVersion=t.AssetFileVersion=void 0,t.AssetFileVersion=10,t.AssetVersion=2},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DbAdvisoryLockProvider=t.withAdvisoryLocks=t.AdvisoryLock=t.CurrentLockHoldersSql=void 0;const r=i(8),s=i(26),o=i(51),a=i(262),u=i(4),l=i(2),c=i(78),d=i(185);t.CurrentLockHoldersSql="\nSELECT\n  al1.name,\n  al1.lockId\nFROM\n  AdvisoryLock AS al1\n  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name\n  AND al1.createdAt > al2.createdAt\nWHERE\n  al2.createdAt IS NULL\n".replace(/\s+/," ");class h extends d.Model{static vacuum(e=30*u.minuteMs){return this.dbr(t=>t.runf(t=>t.where("createdAt","<=",Date.now()-e).delete()))}static currentAcquiredLocks(){return n(this,void 0,void 0,(function*(){return this.dbr(e=>e.pluckAllf(e=>e.select("name").where({acquired:1})))}))}static allLocks(){return n(this,void 0,void 0,(function*(){return this.dbr(e=>e.pluckAllf(e=>e.select("name")))}))}static withLocks({lockNames:e,f:t,timeoutMs:i}){return n(this,void 0,void 0,(function*(){const d=Date.now(),f={},p=a.uid();this.logger().debug("withLocks()",{lockNames:e,lockId:p});const m=f.locks=e.map(e=>({name:e,lockId:p,acquired:0,createdAt:Date.now()}));yield this.tx(e=>e.runf(e=>e.insert(m)));const g=l.lazy(()=>this.logger().warn("long wait time for",e));try{const a=yield r.until(()=>n(this,void 0,void 0,(function*(){const e=yield this.tx(e=>e.runf(e=>e.where({lockId:p}).update({acquired:1})),!0);return null!=e||o.nowish(d,5*u.secondMs)||g(),null!=e})),i,c.randomInt(10,250));if(this.logger().info("withLocks()",{lockNames:e,acquired:a}),a){f.acquireMs=Date.now()-d;const e=yield s.elapsedAsync(()=>n(this,void 0,void 0,(function*(){return t(p)})));f.result=e.result,f.runMs=e.elapsedMs}}finally{const e=yield s.elapsedAsync(()=>h.tx(e=>e.runf(e=>e.where({lockId:p}).delete())));f.releaseMs=e.elapsedMs,f.released=!0}return f}))}}t.AdvisoryLock=h,h.tableName="AdvisoryLock",h.uniqueColumnName="name,lockId",t.withAdvisoryLocks=(e,t)=>h.withLocks({lockNames:e,f:t,timeoutMs:u.minuteMs}).then(e=>e.result),t.DbAdvisoryLockProvider={withAdvisoryLocks:t.withAdvisoryLocks}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqWidths=t.SqSizes=t.FitSizeValues=t.FitSizes=void 0;const n=i(36);t.FitSizes=n.strEnum("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),t.FitSizeValues=t.FitSizes.values,t.SqSizes=n.strEnum("s480","s240","s120","s60"),t.SqWidths=[60,120,240,480]},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.psWinWmic=t.pidInfos=t.notExistingPids=t.existingPids=t.pidInfo=t.ps=void 0;const r=i(19),s=i(1),o=i(3),a=i(4),u=i(20),l=i(2),c=i(0),d=i(5),h=i(11),f=i(25),p=i(15),m=i(7),g=i(17),v=i(8),y=i(21),b=i(26),w=i(83),S=i(71),P=i(6),M=i(28),E=i(14),x=i(42),_=l.lazy(()=>P.mkLogger("Ps"));function T(e){return null!=e&&d.gt0(e.pid)&&null!=e.start&&o.notBlank(e.cmd)}function D(e){return n(this,void 0,void 0,(function*(){return s.isEmpty(e)||s.arrayEql([r.pid],e)?p.toA(e):v.thenMap(O(e),e=>e.map(e=>e.pid))}))}function O(e){return n(this,void 0,void 0,(function*(){const t=p.toA(e).filter(d.gt0);if(s.isEmpty(t))throw new Error("Invalid pids: "+u.stringify(e));return f.thenTap(v.thenMap(E.isWin?function(e){return n(this,void 0,void 0,(function*(){if(g.ending()||x.PowerShell.instance().ended)return R(e);const t=[I,"-Id",C(e),"-ErrorAction SilentlyContinue",k].join(" ");return v.thenMap(x.PowerShell.instance().executeJsonToA(t),e=>F(e))}))}(t):function(e){return n(this,void 0,void 0,(function*(){return N((yield y.stdoutResult("ps",["-p",C(e),"-wwwo","pid,lstart,command"],Object.assign(Object.assign({},A),{ignoreExitCode:!0}))).result)}))}(t),e=>e.filter(e=>T(e)&&t.includes(e.pid))),e=>_().debug("pidInfo()",{pids:t,result:e}))}))}function F(e){return e.map(e=>({pid:e.Id,start:b.pwshJsonDate(e.StartTime),cmd:e.ProcessName}))}t.ps=function(){return n(this,void 0,void 0,(function*(){const e=yield E.isWin?function(){return n(this,void 0,void 0,(function*(){if(x.PowerShell.instance().ended)return R();const e=yield x.PowerShell.instance().executeJsonToA([I,k].join(" "));return null==e?R():F(e)}))}():function(){return n(this,void 0,void 0,(function*(){return N(yield y.stdout("ps",["-ewwwo","pid,lstart,command"],A))}))}();return c.orElse(s.sortBy(e.filter(T),e=>e.pid),[])}))},t.pidInfo=function(e){return n(this,void 0,void 0,(function*(){return v.thenMap(O([e]),t=>p.toA(t).find(t=>t.pid===e))}))},t.existingPids=D,t.notExistingPids=function(e){return n(this,void 0,void 0,(function*(){return s.isEmpty(e)?[]:v.thenMap(D(e),t=>{const i=[r.pid,...t];return e.filter(e=>!i.includes(e))})}))},t.pidInfos=O;const I="Get-Process",k="| Select-Object -Property Id,ProcessName,StartTime";function C(e){return s.uniq([...e.filter(d.gt0),r.pid]).join(",")}const A={maxBuffer:1048576,timeout:15*a.secondMs,ignoreExitCode:!0,ignoreStderr:!0},L=["CommandLine","CreationDate","ProcessId"];function R(e){return n(this,void 0,void 0,(function*(){const t=["process"];if(s.isNotEmpty(e)){const i=s.uniq([...e.filter(d.gt0),r.pid]).map(e=>"ProcessId="+e).join(" or ");t.push("where",i)}t.push("get",L.join(","));const i=yield y.stdoutResult(S.wmic(),t,A),n=h.onlyReqValued(w.parseFixed(L,i.result).map(e=>({pid:d.toInt(e.ProcessId,{defaultValue:-1}),start:b.wmiDate(e.CreationDate),cmd:m.toS(e.CommandLine)})));return n.find(e=>e.pid===r.pid)||n.push({pid:r.pid,start:new Date(M.start),cmd:"node "+r.title}),n}))}function N(e){return w.parseFixed(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],e).map(e=>({pid:d.toInt(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:m.toS(e.COMMAND)}))}t.psWinWmic=R},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.popExpiredLogEntries=t.pushLogEntries=t.setLogTailEnabled=t.logTailEnabled=void 0;const n=i(9),r=i(157),s=i(77),o=i(199);let a=!1;t.logTailEnabled=function(){return a},t.setLogTailEnabled=function(e){a=e};const u=[];t.pushLogEntries=function(...e){if(n.Settings.tailLogs.valueOrDefault)u.push(...e);else for(const t of e)console.log(r.DefaultLogFormatter().formatLogEntry(t))},t.popExpiredLogEntries=function(e=4*s.DefaultLogFlushMs){if(0===u.length)return[];if(o.sortLogEntriesInPlace(u),e<=0)return u.splice(0);const t=Date.now()-e,i=u.findIndex(e=>e.ts>=t);return i>=0?u.splice(0,i):u.splice(0)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.nslookup=t.octets=t.isLoopback=t.friendlyname=void 0;const r=i(242),s=i(33),o=i(3),a=i(4),u=i(5),l=i(7),c=i(81),d=i(8),h=i(13),f=i(6),p=i(243),m=i(16),g=new RegExp("^"+p.ipv4Re.source+"$");t.friendlyname=c.memoize(e=>n(void 0,void 0,void 0,(function*(){const i=null==g.exec(e)?e:yield t.nslookup(e);return l.toS(i).toLowerCase().normalize()})),10*a.minuteMs,128);const v=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function y(e){return null!=v.exec(e)}function b(e){const t=e.split(".").map(e=>u.toInt(e)).filter(e=>m.within(0,255,e));return 4===t.length?t:void 0}t.isLoopback=y,t.octets=b;const w=s.promisify(r.reverse),S=s.promisify(r.resolve4),P=f.mkLogger("nslookup");t.nslookup=c.memoize(e=>n(void 0,void 0,void 0,(function*(){try{const t=yield d.thenOrTimeout(()=>y(e)?e.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=b(e)?w(e):S(e),10*a.secondMs);if(null==t)return P.info("nslookup("+e+"): timeout"),e;const i=t.find(o.notBlank);return null==i?(P.warn("No name found for "+e),e):i}catch(t){return P.warn("Failed to look up "+e+", using name.",t),e}})),10*a.minuteMs,256),h.onClearCache(()=>t.nslookup.clear())},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._netInfoWinWmic=t.parseRemoteName=t.NetInfoCmd=t.addRemoteVolumeInfoWin=void 0;const r=i(1),s=i(3),o=i(4),a=i(0),u=i(18),l=i(7),c=i(8),d=i(21),h=i(83),f=i(71),p=i(76),m=i(24),g=i(14),v=i(42),y=i(10),b=i(58);t.addRemoteVolumeInfoWin=function(e,t){return n(this,void 0,void 0,(function*(){if(!g.isWin)throw new Error("wtf");return yield c.thenMap(a.orElse(t,()=>_()),t=>{const i=p.toMap(t,e=>[e.mountpoint,e]);e.forEach(e=>{a.map(i.get(e.mountpoint),t=>{e.remote=!0,e.remoteHost=t.host,e.remoteShare=t.share,e.remoteOK=t.ok})})}),e}))};const w=["LocalName","RemoteName","Status"],S=["NETUSE","get",w.join(",")],P=/^\\\\(.+?)\\(.+)$/,M=/^[a-z]:\\?$/i;function E(e){if(!s.blank(e))return u.Opt(e).flatMap(e=>P.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>u.Opt(e).flatMap(e=>m.Try(()=>new URL(e))).filter(e=>s.notBlank(e.hostname)).map(e=>({host:e.hostname,share:u.Opt(e.pathname).filter(s.notBlank).getOrElse(()=>"/")}))).get()}function x(){return n(this,void 0,void 0,(function*(){const e=f.wmic(),t=yield d.stdout(e,S,{timeout:15*o.secondMs}),i=h.parseFixed(w,t);return r.compact(i.map(e=>a.map(P.exec(l.toS(e.RemoteName)),t=>a.map(M.exec(l.toS(e.LocalName)),i=>({mountpoint:y.ensureSuffix(i[0],"\\"),host:t[1],share:t[2],ok:"OK"===e.Status})))))}))}t.NetInfoCmd="Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status",t.parseRemoteName=E,t._netInfoWinWmic=x;const _=b.lazyFsAsync((function(){return n(this,void 0,void 0,(function*(){const e=yield v.PowerShell.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return null==e?x():r.compact(e.filter(e=>s.notBlank(e.LocalName)).map(e=>a.map(E(e.RemoteName),({host:t,share:i})=>a.map(M.exec(l.toS(e.LocalName)),n=>({mountpoint:y.ensureSuffix(n[0],"\\"),host:t,share:i,ok:"OK"===e.Status&&"Connected"===e.ConnectionState})))))}))}))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.hidden=void 0;const r=i(3),s=i(4),o=i(5),a=i(18),u=i(21),l=i(14),c=i(42);t.hidden=function(e){return!!e.base.startsWith(".")||(l.isWin?function(e){return n(this,void 0,void 0,(function*(){const t=yield c.PowerShell.instance().executeJsonToA(["Get-Item -Force -LiteralPath",c.pwshQuote(e.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return a.Opt(t).flatMap(e=>e[0]).flatMap(e=>e.Mode).filter(r.notBlank).flatMap(e=>e.includes("h")||e.includes("s")).getOrElse(()=>!1)}))}(e):!!l.isMac&&function(e){return n(this,void 0,void 0,(function*(){try{const t=yield u.stdout("stat",["-f","%f",e.nativePath],{timeout:10*s.secondMs}),i=o.toInt(t);return null!=i&&(32768&i)>0}catch(e){return!1}}))}(e))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ignorableDirectory=t.ignorablePredicates=t.ignorableDirectoryPredicates=t.ignorableFile=t.ignorablePath=t.ignorablePathPredicates=t.Ignorable=void 0;const r=i(1),s=i(3),o=i(2),a=i(47),u=i(8),l=i(59),c=i(253),d=i(6),h=i(28),f=i(14),p=i(254),m=i(67),g=i(170),v=i(158),y=i(152),b=i(30),w=i(32),S=i(255),P=i(256);class M{constructor(e=h.isTest){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","var","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize())),this.ignorableDirectories=new Set(["__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Data","Application Support","Applications","arangodb","cache","caches","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","steamapps","System Volume Information","System32","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase())),this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/.*?\.photos?library\/(?!Masters?\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Smart Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i],this.systemDirs=r.uniq(r.compactBlanks([a.App.appData(),l.getEnv("APPDATA"),l.getEnv("SYSTEMROOT"),l.getEnv("ProgramFiles"),l.getEnv("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize())),this.ignorableSubdirs=new p.SetSet,f.isLinux&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);const t=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",t),this.addIgnorableSubdirs("cygwin",t),this.addIgnorableSubdirs("cygwin64",t),this.addIgnorableSubdirs("local",t),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...t]),this.addIgnorableSubdirs("var",["cache","crash","lib","local","log","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);const i=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",i),this.addIgnorableSubdirs("Perl64",i),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(l.getEnv("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),f.isWin&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,t){if(s.blank(e))return;const i=e.toLowerCase().normalize();r.compactBlanks(t).forEach(e=>this.ignorableSubdirs.add(i,e.toLowerCase().normalize()))}ignorablePathPredicates(e){const t=v.pathIsNeverIgnoredPredicate(e);if(null!=t)return t;const i=e.toLowerCase().normalize(),n=r.compactBlanks(b.pathnames(i));return{hiddenPosix:()=>n.some(e=>e.startsWith(".")),systemDir:()=>this.systemDirs.some(e=>i.startsWith(e)),ignorableRoot:()=>this.ignorableRootDirectories.has(n[0]),ignorableDirectory:()=>n.some(e=>this.ignorableDirectories.has(e)),ignorablePath:()=>this.ignorableSubdirs.has(n),ignorablePattern:()=>{const t=b.native2posix(e);return this.ignorableDirectoryPatterns.some(e=>e.test(t))}}}ignorablePath(e){return c.orLogged([this.ignorablePathPredicates(e)],e,d.mkLogger("ignorablePath()"))}}t.Ignorable=M;const E=o.lazy(()=>new M);function x(e){return Object.assign(Object.assign({},E().ignorablePathPredicates(e)),{notExists:()=>w.PosixFile.for(e).notExists()})}function _(e){return E().ignorablePath(e)}function T(e){const t=e.nativePath.toLowerCase().normalize();return v.pathIsNeverIgnored(e.nativePath)||v.pathIsNeverIgnored(t)?{pathIsNeverIgnored:()=>!1}:Object.assign(Object.assign({},x(e.nativePath)),{snapDirectory:()=>n(this,void 0,void 0,(function*(){return f.isLinux&&(yield P.ignorableSnapDir.apply(e))})),noMedia:()=>y.hasNoMedia(e),hidden:()=>g.hidden(e),seemsRecursive:()=>S.seemsRecursive(e.pathnames),mountpoint:()=>n(this,void 0,void 0,(function*(){return u.thenMapOr(m.mountpoints(),t=>t.includes(e.nativePath),()=>!1)}))})}t.ignorablePathPredicates=x,t.ignorablePath=_,t.ignorableFile=function(e){return _(e.nativePath)},t.ignorableDirectoryPredicates=T,t.ignorablePredicates=function(e){return n(this,void 0,void 0,(function*(){return(yield e.isDirectory())?T(e):x(e.nativePath)}))},t.ignorableDirectory=function(e){return n(this,void 0,void 0,(function*(){return c.orLoggedAsync([T(e)],e.nativePath,d.mkLogger("ignorableDirectory()"))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bits=t.pop=t.bitsSet=t.bitUnzip=t.bitZip=t.diffConcattedBits=t.splitBits=t.concatBits=void 0;const n=i(1),r=i(0),s=i(5),o=i(12),a=i(52);function u(e,t){const i=Math.pow(2,t),n=[];for(;e>0;)n.unshift(e%i),e=Math.floor(e/i);return n}function l(e){return e.toString(2).split("").reverse().map((e,t)=>"1"===e?t:-1).filter(e=>-1!==e)}t.concatBits=function(e,t){const i=Math.pow(2,t);return e.reduce((e,t)=>e*i+s.clamp(0,i,s.toInt(t,{defaultValue:0})),0)},t.splitBits=u,t.diffConcattedBits=function(e,t,i){return r.map2(e,t,(e,t)=>n.sum(o.zip(u(e,i),u(t,i)),([e,t])=>s.absdiff(e,t)))},t.bitZip=function(e){e.dims.forEach(e=>e.value=s.clamp(e.min,e.max,e.value));let t=0;for(let i=0;i<e.bitDepth;i++){t*=2;const n=i%e.dims.length,r=e.dims[n],s=a.avg([r.min,r.max]);r.value>s?(t+=1,r.min=s):r.max=s}return t},t.bitUnzip=function(e,t){if(t.bitDepth>52||t.bitDepth<0)return;const i=l(e);for(let e=0;e<t.bitDepth;e++){const n=e%t.dims.length,r=t.dims[n],s=a.avg([r.min,r.max]);i.includes(t.bitDepth-e-1)?r.min=s:r.max=s}return t.dims.map(e=>a.avg([e.min,e.max]))},t.bitsSet=l,t.pop=function(e){return e=(e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135,e+=e>>8,63&(e+=e>>16)},t.bits=function(e,t){return n.sum(e,(i,n)=>t(i,n)?Math.pow(2,e.length-n-1):0)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetUrls=void 0;const n=i(1),r=i(96),s=i(165),o=i(0),a=i(5),u=i(7);class l{constructor(e,t=""){this.query="",this.query=t,this.assetId=a.isNumber(e)?e:e.id}static onNewPage(){this.pageImageCount=0}get unset(){return null==this.assetId||this.assetId<=0}assetUrl(){return this.unset?"":`/asset/${this.assetId}${this.query}`}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,t){return`/img/${this.assetId}/${e}/${t}${this.query}`}imgActualLink(e){return`/img/${n.compact([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e,t="m"){return Object.assign(Object.assign({},this.imgAttrs("sq",s.SqWidths,e)),{sizes:"s"==t?"120px":"m"==t?"240px":"480px"})}imgAttrs(e,t,i,n){if(this.unset)return{src:"/images/clear-64.png"};const s=Math.min(...t),a={width:u.toS(s)},d=this.imgLink(e,s);l.pageImageCount++,(i=o.orElse(i,()=>l.pageImageCount>72))?(a.src="/images/clear-64.png",a["data-src"]=d):a.src=d,e===r.ReducerNames.sq&&(a.height=u.toS(s));const h=t.map(t=>c(this.imgLink(e,t),t));return o.map(n,e=>h.push(c(this.imgActualLink(),e.width))),a[(i?"data-":"")+"srcSet"]=h.join(","),a}}function c(e,t){return e+" "+t+"w"}t.AssetUrls=l,l.pageImageCount=0},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathToDb=t.SqliteExt=void 0,t.SqliteExt=".sqlite3",t.pathToDb=function(e,i){return e.join(i,"db"+t.SqliteExt)}},function(e,t){e.exports=require("readline")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readFileType=void 0;const r=i(297),s=i(64),o=i(31),a=i(3),u=i(4),l=i(68),c=i(8),d=i(55),h=i(13),f=i(10),p=i(39),m=i(298),g=new d.BoundedMap(5*u.minuteMs,1024,!1);function v(e){return f.stripPrefix(o.extname(e),".")}h.onClearCache(()=>g.clear()),h.onFileChanged(e=>null==e?g.clear():g.delete(e)),t.readFileType=function(e){return n(this,void 0,void 0,(function*(){return g.getOrSet(e,()=>n(this,void 0,void 0,(function*(){const{buffer:t}=yield m.readFilePart(e,0,248);return l.thenOpt(r.fromBuffer(t)).filter(e=>"image/tiff"!==e.mime).orElse(()=>l.thenOpt(c.resolved(s.stat(e))).filter(e=>e).flatMap(()=>p.exiftool().readRaw(e,["-mimetype"])).flatMap(e=>e.MIMEType).filter(a.notBlank).map(t=>({ext:v(e),mime:t})).get()).get()})))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ungeohash_num=t.ungeohash=t.geohashNumeric=t.geohashNumericShort=t.geohash=t.validLatLon=void 0;const n=i(0),r=i(172),s=i(57),o=i(16);function a(e,t){return o.within(-90,90,e)&&o.within(-180,180,t)&&0!==e&&0!==t}function u(e,t,i=50){return a(e,t)?r.bitZip({dims:[{min:-180,value:t,max:180},{min:-90,value:e,max:90}],bitDepth:i}):void 0}function l(e,t=52){return n.map(r.bitUnzip(e,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:t}),e=>e.reverse())}t.validLatLon=a,t.geohash=function(e,t,i=52){return n.map(u(e,t,i),e=>s.GeoRadix.encode(e))},t.geohashNumericShort=function(e,t){return u(e,t,30)},t.geohashNumeric=u,t.ungeohash=function(e,t=52){return n.map(s.GeoRadix.decode(e),e=>l(e,t))},t.ungeohash_num=l},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dcraw=t.dcrawSupportedMimetype=t.dcrawSupported=t.dcrawSupportedMimeTypes=void 0;const r=i(4),s=i(7),o=i(35),a=i(8),u=i(21),l=i(23),c=i(299),d=i(176),h=i(111),f=i(148),p=i(6),m=i(39),g=i(66),v=i(132),y=i(193),b=i(160);t.dcrawSupportedMimeTypes=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);const w=p.mkLogger("dcraw");function S(e){return w.tap({msg:"dcrawSupportedMimetype("+e+")",result:t.dcrawSupportedMimeTypes.has(s.toS(e).toLowerCase())})}t.dcrawSupported=function(e){return n(this,void 0,void 0,(function*(){try{return S(yield a.thenMap(d.readFileType(e.nativePath),e=>e.mime))}catch(e){return w.warn("dcrawSupported(): failed to read filetype",e),!1}}))},t.dcrawSupportedMimetype=S;const P=y.ImageSize.largestFit().megapixels();t.dcraw=function(e){return n(this,void 0,void 0,(function*(){const t=Date.now(),i=yield m.readTags(e.nativePath),s=v.tmegapixels(i),a=null!=s&&s>4*P?["-h"]:[],d=yield f.dcrawNativePath(),p=["-T","-c","-H","2","-w","-o","1",...a,"-t","0","-q","2",e.nativePath],y=5*r.minuteMs,S={encoding:"buffer",timeout:y,maxBuffer:250*o.MB};w.debug("dcraw()",{cmd:d,args:p,opts:S});const M=yield u.execFile(d,p,y,S),E=t=>n(this,void 0,void 0,(function*(){(yield c.emitSafely(M.stdout,"error","Problem from "+e+": "+l.cleanError(t,e.nativePath)))||w.error("No listeners for error when reading "+e,t),M.kill("SIGINT")}));M.on("error",E),M.stderr.on("data",E);const x=b.dcrawTimeout(yield e.size())/Math.sqrt(g.maxCpus()),_=new h.PullProgressObserver({path:e.nativePath,op:"Converting raw image"},x,()=>Date.now()-t);return M.on("close",()=>_.end()),M.stdout}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rgbhex2hsv=t.diffCIE94Corr=t.MaxCie=t.MinCie=t.closestLab=t.diffCIE94rgb=t.diffCIE94=t.diffCIE76=t.unlabhash=t.labhash=t.xyz2rgb=t.lab2xyz=t.xyz2lab=t.rgb2xyz=t.clampLab=t.clampRGB=t.lab2rgb=t.rgb2lab=t.rgb2labs=t.lab2rgbhex=t.rgbhex2Labhash=t.rgbhex2Lab=t.rgbhex2triplet=void 0;const n=i(0),r=i(5),s=i(7),o=i(12),a=i(172),u=i(232),l=i(10),c=i(1),d=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],h=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];function f(e){return n.map(s.toS(e).match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),e=>[e[1],e[2],e[3]].map(e=>parseInt(e,16)))}function p(e){return P(y(e))}function m(e){return g(E(M(e)))}function g(e){return[e[0],e[1],e[2]].map(e=>r.clamp(0,255,e))}function v(e){return[r.clamp(0,100,e[0]),r.clamp(-100,100,e[1]),r.clamp(-108,100,e[2])]}function y(e){const t=g(e).map(e=>e/255).map(e=>e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92);return u.matXvec(d,t)}t.rgbhex2triplet=f,t.rgbhex2Lab=function(e){return n.map(f(e),p)},t.rgbhex2Labhash=function(e,t){return n.map(f(e),e=>x(p(e),t))},t.lab2rgbhex=function(e){return"#"+m(e).map(e=>l.leftPad(e.toString(16),2,"0")).join("")},t.rgb2labs=function(e){const t=[];for(let i=0;i<e.length;i+=3)t.push(...p([e[i],e[i+1],e[i+2]]));return t},t.rgb2lab=p,t.lab2rgb=m,t.clampRGB=g,t.clampLab=v,t.rgb2xyz=y;const b=.95047,w=1,S=1.08883;function P(e){const[t,i,n]=u.vecXvec(e,[1/b,1/w,1/S]).map(e=>e>216/24389?Math.pow(e,1/3):(24389/27*e+16)/116);return[116*i-16,500*(t-i),200*(i-n)]}function M(e){const[t,i,n]=v(e),r=(t+16)/116,s=i/500+r,o=r-n/200,a=s*s*s,u=o*o*o,l=a>216/24389?a:(116*s-16)/(24389/27),c=t>8?Math.pow(r,3):t/(24389/27);return[l*b,c*w,(u>216/24389?u:(116*o-16)/(24389/27))*S]}function E(e){return u.matXvec(h,e).map(e=>{const t=e<0?-1:1,i=e*t;return r.round(255*t*(i<=.0031308?12.92*i:1.055*Math.pow(i,1/2.4)-.055))})}function x(e,t){return a.bitZip({dims:[{value:e[0],min:0,max:100},{value:e[1],min:-80,max:80},{value:e[2],min:-80,max:80}],bitDepth:t})}function _(e,t){if(c.arrayEql(e,t))return 0;const[i,n,s]=e,[o,a,u]=t,l=i-o,d=n-a,h=s-u,f=Math.sqrt(Math.pow(n,2)+Math.pow(s,2)),p=f-Math.sqrt(Math.pow(a,2)+Math.pow(u,2)),m=(g=Math.sqrt(Math.pow(d,2)+Math.pow(h,2)-Math.pow(p,2)),r.isNumber(g)?g:0);var g;const v=1+.045*f,y=1+.015*f;return Math.sqrt(Math.pow(l,2)+Math.pow(p/v,2)+Math.pow(m/y,2))}t.xyz2lab=P,t.lab2xyz=M,t.xyz2rgb=E,t.labhash=x,t.unlabhash=function(e,t){return a.bitUnzip(e,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:t})},t.diffCIE76=function(e,t){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))},t.diffCIE94=_,t.diffCIE94rgb=function(e,t){return _(p(e),p(t))},t.closestLab=function(e,t){return o.leastBy(e,e=>_(e,t))},t.MinCie=2,t.MaxCie=50,t.diffCIE94Corr=function(e,i){return null==e||null==i?1:r.clamp(0,t.MaxCie,_(e,i)-t.MinCie)/t.MaxCie},t.rgbhex2hsv=function(e){let t,i,n,r=0,s=0;const[o,a,u]=f(e).map(e=>e/255),l=Math.max(o,a,u),c=l-Math.min(o,a,u),d=e=>(l-e)/6/c+.5;return 0!==c&&(s=c/l,t=d(o),i=d(a),n=d(u),o===l?r=n-i:a===l?r=1/3+t-n:u===l&&(r=2/3+i-t),r<0?r+=1:r>1&&(r-=1)),[360*r,100*s,100*l]}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.imageHash=t.ModeDim=t.HashDim=t.maxPerBits=t.ModeCount=t.ModeBits=void 0;const r=i(72),s=i(1),o=i(3),a=i(4),u=i(20),l=i(0),c=i(5),d=i(108),h=i(8),f=i(69),p=i(55),m=i(26),g=i(13),v=i(99),y=i(6),b=i(279),w=i(232),S=i(291),P=i(52),M=i(39),E=i(179),x=i(113),_=i(134);t.ModeBits=12,t.ModeCount=7,t.maxPerBits=function(e){return Math.floor(52/e)};const T=y.mkLogger("ImageHash"),D=new p.BoundedMap(3e5,500,!0);function O(e,i=!0){return n(this,void 0,void 0,(function*(){const n=y.mkLogger("ImageHash("+e+")");try{const a=!i,u=yield _.sharpReadable(e,t.ModeDim,a);if(null==u)return void n.warn("Cannot build readable stream");if(null==(yield x.dimensions(e)))return void n.warn("Can't extract dimensions");let l=r(u.nativePath).removeAlpha().toColorspace("srgb").trim().resize(Object.assign(Object.assign({},t.ModeDim),{fit:"fill",kernel:"lanczos3",fastShrinkOnLoad:!0,withoutEnlargement:!0}));a||(yield h.thenMap(M.readRotation(e),e=>l=l.rotate(e)));const f=yield l.raw().toBuffer({resolveWithObject:!0}),p=r(f.data,{raw:Object.assign(Object.assign({},f.info),{channels:3})}),{data:m}=yield p.resize({width:t.HashDim,height:t.HashDim,fit:"fill"}).raw().toBuffer({resolveWithObject:!0}),g=function(e){const t=[[],[],[]];for(let i=0;i<e.length;i+=3){const n=E.rgb2lab([e[i],e[i+1],e[i+2]]);t[0].push(n[0]),t[1].push(n[1]),t[2].push(n[2])}return t}(m),v=c.times(3,e=>P.avg(g[e])),y=i?d.normalizeRotation(90*w.leastQuarter(g[0],{col:t.HashDim,row:t.HashDim})+180):0,T=g.map(e=>S.rotateSquareMatrix(e,y)).map((e,t)=>{const i=v[t];return e.map(e=>e>=i?1:0)}),D=(o=s.flatten(T),b.b64encode(BigInt("0b0"+o.map(e=>1===e?1:0).join("")))),{data:O}=yield f;return{meanHash:D,modes:function(e){const i=s.stepRange(0,e.length,3,t=>E.rgb2lab([e[t],e[t+1],e[t+2]]));return P.modes(i.map(e=>E.labhash(e,t.ModeBits)),t.ModeCount)}(O)}}catch(t){return void n.warn("Failed to imageHash("+e.nativePath+")",t)}var o}))}g.onClearCache(()=>D.clear()),g.onFileChanged(e=>o.notBlank(e)?D.delete(e):D.clear()),g.onFileCopied((e,t)=>l.map(D.get(e),e=>D.getOrSet(t,()=>e))),t.HashDim=8,t.ModeDim={width:96,height:96},t.imageHash=function(e,t=!0){return n(this,void 0,void 0,(function*(){const i=u.stringify({p:e.nativePath,rotationInvariant:t});return D.getOrSet(i,()=>m.elapsedAsync(()=>f.time("img.imageHash "+e.normalizedExt,()=>O(e,t))).then(({elapsedMs:t,result:i})=>T.tap({level:v.ms2level(t,10*a.secondMs),msg:"imageHash()",result:i,meta:{file:e.nativePath,elapsedMs:t}})))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetTag=void 0;const n=i(13),r=i(224),s=i(1),o=i(4),a=i(0),u=i(5),l=i(11),c=i(185),d=i(131);n.onClearCache(()=>h.clear());class h extends c.Model{static clear(){this.assetId2tagIds.clear()}$pk(){return[a.orElse(this.assetId,()=>a.map(this.asset,e=>e.id)),a.orElse(this.tagId,()=>a.map(this.tag,e=>e.id))].join(":")}static addTagsToAsset(e,t){const i=u.id(e);if(null==i)return void this.logger().warn("addTagsToAsset(): got null assetId");const n=s.compact(t.map(u.id));if(s.isEmpty(n))return void this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:t});const r="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+n.map(e=>`(${i},${e})`).join(",");return d.Tag.onAssetTagChange(),t.forEach(t=>this.assetId2tagIds.add(e,t)),this.dbr(e=>e.run(r))}static removeTagsFromAsset(e,t){t=s.compact(t),d.Tag.onAssetTagChange();const i=this.query().whereIn("tagId",t).andWhere({assetId:e}).delete();return l.tap(this.dbr(e=>e.run(i)),()=>t.forEach(t=>this.assetId2tagIds.delete(e,t)))}}t.AssetTag=h,h.tableName="AssetTag",h.uniqueColumnName="assetId,tagId",h.assetId2tagIds=new r.TTLMultiMap(5*o.minuteMs)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeProgressEvtListener=t.onProgressEvt=t.emitProgressEvt=t.isProgressEvt=void 0;const n=i(3),r=i(5),s=i(16),o=i(13);function a(e){return null!=e&&n.notBlank(e.path)&&n.notBlank(e.op)&&s.within(0,100,e.pct)}t.isProgressEvt=a;t.emitProgressEvt=function(e){a(e)&&o.eventEmitter.emit("progress",Object.assign(Object.assign({},e),{pct:r.round(r.clamp(0,100,e.pct))}))},t.onProgressEvt=function(e){o.eventEmitter.on("progress",e)},t.removeProgressEvtListener=function(e){return o.eventEmitter.removeListener("progress",e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseEnvTokens=void 0,t.parseEnvTokens=function(e){const t=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+)/gim,i={};let n;for(;null!=(n=t.exec(e));){const[,e,,t]=n;i[e.toLowerCase()]=t.replace(/\\"/g,'"').replace(/\\'/g,"'")}return i}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.concatHealthChecks=t.uniqhc=t.fullhc=t.hasFail=t.hasBad=t.hasWarn=void 0;const n=i(1),r=i(15);t.hasWarn=function(e){return null!=e&&n.isNotEmpty(e.warn)},t.hasBad=function(e){return null!=e&&n.isNotEmpty(e.bad)},t.hasFail=function(e){return null!=e&&n.isNotEmpty(e.fail)},t.fullhc=function(e){return{ok:r.toA(e.ok),warn:r.toA(e.warn),bad:r.toA(e.bad),fail:r.toA(e.fail)}},t.uniqhc=function(...e){const t=n.compact(e);return{ok:n.uniq(n.flatten(t.map(e=>e.ok))),warn:n.uniq(n.flatten(t.map(e=>e.warn))),bad:n.uniq(n.flatten(t.map(e=>e.bad))),fail:n.uniq(n.flatten(t.map(e=>e.fail)))}},t.concatHealthChecks=function(...e){function t(t){return n.uniq(n.compact(n.flatten(e.map(t))))}return e=n.compact(e),{ok:t(e=>e.ok),warn:t(e=>e.warn),bad:t(e=>e.bad),fail:t(e=>e.fail)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Model=void 0;const r=i(33),s=i(22),o=i(6),a=i(28),u=i(312),l=i(1),c=i(3),d=i(0),h=i(11),f=i(41),p=i(25),m=i(7),g=i(229),v=i(149),y=i(150),b=i(197),w=i(264),S=i(265);class P{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return null==this._logger&&(this._logger=o.mkLogger(this.tableName)),this._logger}static query(){return v.knex(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static dbr(e){return e(this.dbLocal())}static dbLocal(){return null==this._dbLocal&&(this._dbLocal=new g.DbRequestLocal(this.db,this.tableName)),this._dbLocal}static txOp(e){return n(this,void 0,void 0,(function*(){return y.tx(this.db(),()=>e(this.ops()))}))}static tx(e,t=!1){return n(this,void 0,void 0,(function*(){return y.tx(this.db(),()=>e(this.dbLocal()),t)}))}static ops(){return S.ModelOpsLocal.forModel(this,this.db)}static op(e){return n(this,void 0,void 0,(function*(){return e(this.ops(),this.query())}))}static truncate(){if(a.isProd)throw new Error("rejecting attempt to truncate in prod");return this.dbr(e=>e.exec("DELETE FROM "+this.tableName))}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return m.toS(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${d.orElse(this.id,this[this.class().uniqueColumnName])})`}logger(){return o.mkLogger(m.toS(this.valueOf()))}[r.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return w.fromJSON(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}static toDbJSON(e,t){return this.fromJSON(e).$toDbJSON(t)}$toShallowJSON(){return this.$_toJSON(s.isTrue)}$toDbJSON(e){const t=this.$_toJSON(s.boolToInt,!1);return c.notBlank(e)?h.pick(t,...e):t}toJSON(){return this.$_toJSON(s.isTrue)}$_toJSON(e,t=!0){const i=this.class();return h.mapFields(this,(t,n)=>{if(null!=n&&f.isPrimitive(n))return l.includes(i.booleanFields,t)?[t,e(n)]:[t,n]},t?{$ctor:i.$ctor}:{})}insert(){return n(this,void 0,void 0,(function*(){return w.assignFromJSON(this,yield this.class().ops().insertOne(this))}))}update(e){return u.atap(this.class().dbr(t=>t.exec(this.class().query().where({id:this.id}).update(e))),()=>{w.assignFromJSON(this,e)})}upsert(){return n(this,void 0,void 0,(function*(){return w.assignFromJSON(this,yield this.class().ops().upsertOne(this))}))}$beforeUpsert(){}reload(){return n(this,void 0,void 0,(function*(){return p.thenMap(this.class().ops().findById(this.id),e=>w.assignFromJSON(this,e))}))}delete(){return d.map(this.id,e=>this.class().ops().delete([e]))}}t.Model=P,P.schema="models",P.db=b.modelDb},function(e,t){("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"0.8.0-beta.10+20200623202207"}},function(e,t){e.exports=require("commander")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addFooter=t.CliDesc=t.descriptionFooter=void 0;const n=i(19),r=i(97),s=(new Date).getFullYear();t.descriptionFooter=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.\n\nCopyright Â© 2017-${s}, PhotoStructure Inc.\n\nRunning this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,t.CliDesc={main:"PhotoStructure's main process manager. Kicks off web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",ls:"List all paths in a Library.",logcat:"Pretty-print a PhotoStructure logfile.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."},t.addFooter=function(e){return e.on("--help",()=>{var e;console.log("\n"+r.wrap(t.descriptionFooter,{maxLineLen:null!==(e=n.stdout.columns)&&void 0!==e?e:78,prefix:""}).join("\n")+"\n")})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isList=void 0;const n=i(38);t.isList=function(e){return null!=e&&(Array.isArray(e)||isFinite(e.length)&&n.isFunction(e[Symbol.iterator])&&n.isFunction(e.push)&&n.isFunction(e.pop)&&n.isFunction(e.forEach)&&n.isFunction(e.some))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLArray=void 0;const n=i(5);class r{constructor(e,t){this.ttlMs=e,this.maxLength=t,this.times=[],this.a=[]}[Symbol.iterator](){this.vacuum();const e=[...this.a];return function*(){for(const t of e)yield t}()}push(...e){n.times(e.length,()=>this.times.push(Date.now())),this.a.push(...e),null!=this.maxLength&&this.vacuum()}pushUniq(...e){e.forEach(e=>{this.includes(e)||this.push(e)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;if(null!=this.maxLength){const e=this.a.length-this.maxLength;this.times.splice(0,e),this.a.splice(0,e)}const e=Date.now()-this.ttlMs,t=this.times.findIndex(t=>t>e);-1===t?this.clear():t>0&&(this.times.splice(0,t),this.a.splice(0,t))}}t.TTLArray=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mapParsed=t.parseMaybe=void 0;const n=i(3),r=i(24);t.parseMaybe=function(e){return n.mapNotBlank(e,e=>r.Try(()=>JSON.parse(e)))},t.mapParsed=function(e,t){try{if(null==e)return;return t(JSON.parse(e))}catch(e){return}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.WatchedChild=t.mkBasicWatchedChild=void 0;const r=i(1),s=i(3),o=i(4),a=i(37),u=i(2),l=i(0),c=i(5),d=i(18),h=i(17),f=i(8),p=i(43),m=i(26),g=i(23),v=i(102),y=i(61),b=i(6),w=i(93),S=i(24),P=i(101),M=i(29),E=i(9),x=i(50),_=i(21);t.mkBasicWatchedChild=function(e){return new T(Object.assign({name:r.compact([e.cmd,...e.args]).join(" "),childFactory:()=>_.spawn(e.cmd,e.args,30*o.minuteMs),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},e))};class T{constructor(e){this.startMs=Date.now(),this._stopped=!1,this.logger=u.lazy(()=>b.mkLogger("WatchedChild("+r.compact([this.name,this.pid]).join(":")+")")),this.startRate=new w.Rate(2*o.minuteMs),this.mutex=new p.Promises,this._ended=!1,this.onError=(e,t)=>n(this,void 0,void 0,(function*(){const i=g.isFatalError(e)||g.isFatalError(t),n=new x.WrappedError({message:e+l.map(t,a.errorToS),cause:g.ifError(t)}),r=g.isIgnorableError(n),s={src:e,fatal:i,ignorable:r,errToS:a.errorToS(t)};if(this.logger().log(r?"warn":"error","onError()",s),this._ended||r)return;if(this.lastError=n,g.onError(e,n),i)return this.end();return this.opts.onError(e,t)?(this.logger().warn("onError requested restart",s),this._restart()):void 0})),this.name=e.name,this.opts=Object.assign({dataSep:"\n",maxErrorsPerMinute:3,endableRank:h.EndableRanks.first,exitCommand:"",restartOnExit:!0},e),this.endTimeoutMs=M.serviceShutdownTimeoutMs(this.name),h.addEndable(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}end(){return n(this,void 0,void 0,(function*(){return this._ended=!0,this._stop()}))}get proc(){return this.cp}get pid(){return l.map(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return l.mapOr(this.pid,e=>P.pidExists(e),()=>n(this,void 0,void 0,(function*(){return!1})))}notRunning(){return f.thenNot(this.running())}stop(){return n(this,void 0,void 0,(function*(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}))}_stop(){return n(this,void 0,void 0,(function*(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});const e=this.cp;return this.cp=void 0,null==e||this.stopChild(e)}))}stopChild(e){return n(this,void 0,void 0,(function*(){return yield d.Opt(this.opts.exitCommand).filter(s.notBlank).flatMap(t=>d.Opt(e).flatMap(e=>e.stdin).filter(e=>e.writable).forEach(e=>S.Try(()=>e.write(t+"\n"))).map(y.end).get()),_.endProcess(e,this.endTimeoutMs)}))}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:c.gt(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}restart(e=!1){return n(this,void 0,void 0,(function*(){return this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),!this._ended&&!h.ending()&&(!e&&this.startRate.msSinceLastEvent<E.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault?void this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:E.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault}):this.mutex.serial(`WatchedChild(${this.name}).restart`,()=>n(this,void 0,void 0,(function*(){return yield this._stop(),this._stopped=!1,this._start()}))))}))}start(){return n(this,void 0,void 0,(function*(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,()=>n(this,void 0,void 0,(function*(){return this._stopped=!1,this._start()})))}))}_restart(){return n(this,void 0,void 0,(function*(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,()=>n(this,void 0,void 0,(function*(){var e,t;return yield this._stop(),!this._stopped&&!this._ended&&(this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),m.isRecentMs(this.startMs,E.Settings.probationMs.valueOrDefault)&&g.onError("Can't restart "+this.name+", failure rate is too high."+g.FatalErrorFlag,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),null===(t=(e=this.opts).onRestart)||void 0===t||t.call(e),this._start()))})))}))}_start(){return n(this,void 0,void 0,(function*(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended)return!1;if(yield this.running())return!1;this.startRate.onEvent();const e=this.cp=yield this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);const t="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:e,desc:i})=>{l.map(e,e=>e.on("error",e=>this.onError(t+i+".on(error)",e)))}),l.map(this.cp.stdout,e=>v.onDataChunked(e,this.opts.dataSep,e=>{this.logger().trace("onDataChunked()",e),this.opts.onStdout(e)})),l.map(this.cp.stderr,e=>e.on("data",e=>{var i,n;e.toString().includes("Error: Cannot find module")&&g.onError("Failed to start "+this.name+g.FatalErrorFlag,new Error(e)),!0===(null===(n=(i=this.opts).onStderr)||void 0===n?void 0:n.call(i,e))&&this.onError(t+".stderr.on(data)",e)})),this.cp.on("exit",(e,t)=>{this.logger().info("onExit",{code:e,signal:t,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?this._restart():(this.logger().info("onExit(): this.opts.restartOnExit is false, so we're done."),this.end())}),this.logger().info("_start(): finished setting up new child "+this.pid),!0}))}}t.WatchedChild=T},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageSize=void 0;const n=i(33),r=i(85),s=i(2),o=i(35),a=i(12),u=i(9),l=i(300);class c{constructor(e,t,i,n,r=!0){this.name=e,this.maxWidth=t,this.maxHeight=i,this.reducer=n,this.rotational=r,this.megapixels=s.lazy(()=>o.megapixels(this.maxWidth*this.maxHeight)),this.max={width:t,height:i},c._Sizes.push(this)}static sq(){return this._Sizes.filter(e=>e.reducer===l.Square)}static largestSq(){return a.greatestBy(this.sq(),e=>e.megapixels())}static fit(){const e=u.Settings.previewResolutions.valueOrDefault;return this._Sizes.filter(t=>t.reducer===l.Fit&&e.includes(t.name))}static largestFit(){return a.greatestBy(this.fit(),e=>e.megapixels())}[n.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"Ã"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&r.isPortrait(e)?r.flip(this.max):this.max,e)}resize(e,t){return t=t.resize(Object.assign(Object.assign({},e),{fit:this.reducer.fit,withoutEnlargement:!0}))}toJpeg({path:e,sh:t,outputSize:i}){return(r.dmegapixels(i)<2||u.Settings.sharpen.valueOrDefault)&&(t=t.sharpen()),t.jpeg({quality:85,progressive:u.Settings.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}}t.ImageSize=c,c._Sizes=[],c.UHD8k=new c("uhd8k",7680,4320,l.Fit,!1),c.UHD5k=new c("uhd5k",5120,2880,l.Fit,!1),c.UHD=new c("uhd4k",4096,2160,l.Fit),c.QHD=new c("qhd",3120,1440,l.Fit),c.FHD=new c("fhd",1920,1080,l.Fit),c.HD=new c("hd",1280,720,l.Fit),c.WVGA=new c("wvga",720,480,l.Fit),c.QVGA=new c("qvga",320,240,l.Fit),c.QQVGA=new c("qqvga",160,120,l.Fit),c.S480=new c("s480",480,480,l.Square),c.S240=new c("s240",240,240,l.Square),c.S120=new c("s120",120,120,l.Square),c.S60=new c("s60",60,60,l.Square)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.extractStatBname=t.nearestSiblingTzOffset=t.nearestSiblings=t.bname=t.inferCapturedAtFromSiblings=t.inferMakeAndModel=void 0;const r=i(1),s=i(3),o=i(4),a=i(0),u=i(18),l=i(7),c=i(79),d=i(12),h=i(8),f=i(26),p=i(116),m=i(13),g=i(226),v=i(51),y=i(6),b=i(110),w=i(135),S=i(39),P=i(48),M=y.mkLogger("TagInference"),E=y.mkLogger("TagInference.inferMakeAndModel()");t.inferMakeAndModel=function(e,t){return n(this,void 0,void 0,(function*(){if(s.notBlank(t.Make)&&s.notBlank(t.Model))return;if(s.blank(t.Make)&&(l.toS(t.HandlerDescription)+l.toS(t.CompressorName)).includes("GoPro"))return void(t.Make="GoPro");const i=D(e),{younger:n,older:o}=yield I(e),a=r.compact(r.flatten(d.zip(n,o))).slice(0,50).filter(e=>b.diceCoeff(D(e),i)>.7).slice(0,10);M.info("inferMakeAndModel("+e+"): looking at nearby siblings",a.map(e=>e.base));for(const i of a){const n=yield S.readRawTags(i);if(null!=n&&d.allNotBlank(n.Make,n.Model))return E.info("Inferring Make and Model",{file:e.nativePath,sibling:i.base,Make:n.Make,Model:n.Model}),t.Make=n.Make,void(t.Model=n.Model)}}))};const x=y.mkLogger("TagInference.inferCapturedAtFromSiblings()");function _(e,t=7){return n(this,void 0,void 0,(function*(){return d.firstAsync(e.slice(0,t),(e,t)=>h.thenMap(S.readRawTags(e),e=>h.thenMap(w.capturedAtFromTags(e),e=>Object.assign(Object.assign({},e),{index:t}))))}))}t.inferCapturedAtFromSiblings=function(e){return n(this,void 0,void 0,(function*(){return h.thenMap(function(e){return T.getOrSet(e.nativePath,()=>n(this,void 0,void 0,(function*(){const{younger:t,older:i}=yield I(e),n=yield _(t),r=yield _(i);return null==n||null==r?void 0:{before:n,after:r,index:n.index,slots:n.index+r.index+1}})))}(e),({before:t,after:i,index:n,slots:r})=>{if(v.sameDay(t.date,i.date))return a.map(p.DateInterval.for(t.date,i.date,n,r),e=>({date:e,src:`before:${t.src},after:${i.src}`}));x.debug("rejecting, not same day",{file:e.nativePath,before:l.toS(t),after:l.toS(i)})})}))};const T=new c.TTLMap(2*o.minuteMs);function D(e){let t=e.name;return a.map(/(?:burst)(.{8,})$/i.exec(t),e=>t=e[1]),a.map(/^(?:(?:dsc[0f]?|img|mov|mvi|mvimg|vid|gpfr|gopro?|gp|gf|p|100)(?:[-_ ])?)(\S.+)$/i.exec(t),e=>t=e[1]),t.replace(/\s*-?\s*copy( \(?\d+\)?)?\s*$/i,"").replace(/\s*\((another |\d+[a-z]{2} )?copy\)\s*$/i,"").replace(/^[-0\s_]+/,"").replace(/[\s-_][\d\s]{0,4}$/,"").replace(/_cover$/i,"").toLowerCase().normalize()}m.onClearCache(()=>T.clear()),t.bname=D;const O=g.extFilter(P.AllExifExts),F=new c.TTLMap(2*o.minuteMs);function I(e,t=7){return n(this,void 0,void 0,(function*(){return F.getOrSet(e.nativePath,()=>n(this,void 0,void 0,(function*(){const i=D(e),n=(yield e.siblings()).filter(t=>!t.base.startsWith(".")&&O.apply(t)&&!P.isSidecarExt(t.ext)&&(b.diceCoeff(t.name,e.name)>.7||b.diceCoeff(D(t),i)>.7)),s=r.sortBy(n,e=>D(e)),[o,a]=d.partition(s,e=>D(e)<i);return o.reverse(),{younger:o.slice(0,t),older:a.slice(0,t)}})))}))}t.nearestSiblings=I,t.nearestSiblingTzOffset=function(e){return n(this,void 0,void 0,(function*(){const{younger:t,older:i}=yield I(e),r=d.flatZip(t,i).slice(0,10),s=yield h.thenMap(function(e,t=7){return n(this,void 0,void 0,(function*(){return d.firstAsync(e.slice(0,t),(e,t)=>h.thenMap(S.readRawTags(e),e=>h.thenMap(w.capturedAtFromTags(e),e=>u.Opt(e).filter(e=>v.hasZone(e.date)).flatMap(e=>v.getZoneName(e.date)).map(e=>({zoneName:e,index:t})).get())))}))}(r),e=>e.zoneName);return M.info("nearestSiblingTzOffset()",{f:e.baseWithGrandparent,result:s}),s}))},t.extractStatBname=function(e){return n(this,void 0,void 0,(function*(){const t=v.parseDateTime(D(e)),i=a.map(t,v.datedToMillis);if(null==t||null==i)return void M.debug("extractStatBname() bname isn't dated",{bname:D(e),fromName:t,fromNameMs:i});const n=yield e.stat();if(null!=n)return M.tap({msg:"extractStatBname()",result:d.first(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],e=>Math.abs(n[e]-i)<f.MaxTzOffsetHours?{src:e,date:t}:void 0),meta:{fromName:t,fromNameMs:i,stat:n}});M.debug("extractStatBname() no stat",{fromName:t,fromNameMs:i})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.systemUID=t.SystemUIDStore=t.UIDStore=void 0;const r=i(1),s=i(2),o=i(47),a=i(8),u=i(13),l=i(57),c=i(308),d=i(65),h=i(50),f=i(309),p=i(32);class m{constructor(e){this.rootDir=e,this.read=s.lazy(()=>this.jfs.read()),this.jfs=new f.JsonFileStore(e.join("uid.json"),()=>this.mkUid())}mkUid(){return n(this,void 0,void 0,(function*(){return{uid:r.compactBlanks([c.fsSafeHostname().substr(0,6),l.TokenRadix.safeRandomUid(12,4)]).join("-"),version:d.version,createdAt:Date.now()}}))}}t.UIDStore=m,t.SystemUIDStore=s.lazy(()=>new m(p.PosixFile.for(o.App.userData()))),o.App.userData.onChange(()=>t.SystemUIDStore.unset()),t.systemUID=s.lazy(()=>a.thenMapOr(t.SystemUIDStore().read(),e=>e.uid,()=>"missing!").catch(e=>{throw new h.WrappedError({cause:e,fatal:!0,message:"Failed to read "+t.SystemUIDStore().rootDir})})),u.onClearCache(()=>{t.SystemUIDStore.unset(),t.systemUID.unset()})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.idEql=t.id2id=t.BlankID=void 0;const n=i(0),r=i(5);function s(e){return n.map(e,e=>r.isNumber(e)?e:e.id)}t.BlankID={id:-1,v:-1},t.id2id=s,t.idEql=function(e,t){return n.map2Or(s(e),s(t),(e,t)=>e===t,()=>!1)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localModelDbPath=t.libraryModelDbFile=t.setModelDb=t.modelDb=void 0;const n=i(22),r=i(91),s=i(0),o=i(174);let a;function u(){return s.map(r.libraryDataDir(),e=>o.pathToDb(e,"models"))}t.modelDb=()=>a,t.setModelDb=function(e){a=e},t.libraryModelDbFile=u,t.localModelDbPath=function(){return n.isFalse(null==a?void 0:a.datadir.eql(u()))?a.dbfile:void 0}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.EndableInterval=void 0;const r=i(34),s=i(0),o=i(5),a=i(15),u=i(17);class l extends u.EndableWrapper{constructor(e){super(e.name,()=>{s.map(this.timer,clearTimeout),this.timer=void 0},s.orElse(e.rank,u.EndableRanks.first),()=>s.mapOr(e._isEnded,e=>e(),()=>!1),e.endTimeoutMs),this.setup(e)}setup(e){return n(this,void 0,void 0,(function*(){o.gt0(e.initialDelayMs)&&(yield r.delay(e.initialDelayMs)),this.ended||(this.timer=setInterval(e.callback,Math.round(e.intervalMs),...a.toA(e.args)),e.unref&&this.timer.unref())}))}}t.EndableInterval=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sortLogEntriesInPlace=void 0;const n=i(1);t.sortLogEntriesInPlace=function(e){n.sortByInPlace(e,e=>e.ts)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eql=void 0;const n=i(20);t.eql=function(e,t){return n.stringify(e)===n.stringify(t)}},function(e,t){e.exports=require("deep-eql")},function(e,t){e.exports=require("he")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cacheDir=void 0;const n=i(1),r=i(2),s=i(103),o=i(59),a=i(30),u=i(86),l=i(14);t.cacheDir=r.lazy(()=>{{const e=o.getEnv("PS_CACHE_DIR");if(a.isDirectorySync(e))return e}if(l.isDocker()&&a.isDirectorySync("/ps/cache"))return"/ps/cache";if(l.isWin)for(const e of n.compactBlanks([o.getEnv("TEMP"),o.getEnv("LOCALAPPDATA")]))if(a.isDirectorySync(e))return a.resolve(e,s.AppName);if(l.isMac){const e=a.resolve(u.homeDir(),"Library","Caches");if(a.isDirectorySync(e))return a.resolve(e,s.AppName)}return a.resolve(u.homeDir(),".cache",s.AppName.toLowerCase())})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultLogDir=void 0;const n=i(31),r=i(136),s=i(103),o=i(86),a=i(14);t.defaultLogDir=function(){return a.isDocker()?"/ps/logs":a.isMac?n.resolve(o.homeDir(),"Library","Logs",s.AppName):n.resolve(r.appData(),s.AppName,"logs")}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.channel=t.isBetaVersion=t.isAlphaVersion=void 0;const n=i(2),r=i(65);t.isAlphaVersion=n.lazy(()=>r.version.includes("-alpha")),t.isBetaVersion=n.lazy(()=>r.version.includes("-beta")),t.channel=n.lazy(()=>t.isAlphaVersion()?"alpha":t.isBetaVersion()?"beta":"latest")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isFirefox=t.isChrome=t.isSafari=void 0;const n=i(7);t.isSafari=function(e){return n.toS(e).includes(" Safari/")},t.isChrome=function(e){return n.toS(e).includes(" Chrome/")},t.isFirefox=function(e){return n.toS(e).includes(" Firefox/")}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.asPromise=void 0;const r=i(38);t.asPromise=function(e){return n(this,void 0,void 0,(function*(){return r.isFunction(e)?e():e}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Elapsed=void 0;const n=i(0);t.Elapsed=class{constructor(e,t){this.l=e,this.listener=t,this.ts=Date.now()}elapsed(e){const t=Date.now(),i=t-this.ts;this.ts=t,n.map(this.listener,t=>t(e,i)),i>2&&this.l.log(i>500?"warn":i>100?"info":"debug",e,i)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeError=void 0;const n=i(0),r=i(7),s=i(10);t.describeError=function(e){const t=s.stripSuffix(r.toS(e).trim().toUpperCase(),":");return n.mapOr(o[t],e=>e.description,()=>e)};const o=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestEventEmitter=void 0;const n=i(140);class r extends n.EventEmitter{constructor(){super(...arguments),this.events=[]}emit(e,...t){return super.emit(e,...t),this.events.push({name:e,args:t}),!0}clear(){this.events.length=0}}t.TestEventEmitter=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MRUMap=void 0;const n=i(11);class r{constructor(e=1e3,t=!1){if(this.maxSize=e,this.fifo=t,this.delegate=new Map,this.expireListeners=[],e<1)throw new Error("maxSize must be positive")}get size(){return this.delegate.size}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}entries(){return this.delegate.entries()}forEach(e){this.delegate.forEach(e)}get(e){if(this.delegate.has(e)){const t=this.delegate.get(e);return this.fifo||(this.delegate.delete(e),this.delegate.set(e,t)),t}}getOrSet(e,t){return this.delegate.has(e)?this.get(e):n.tap(t(),t=>this.set(e,t))}has(e){return this.delegate.has(e)}keys(){return this.delegate.keys()}set(e,t){return this.delegate.set(e,t),this.vacuum(),this}values(){return this.delegate.values()}[Symbol.iterator](){return this.entries()}on(e,t){this.expireListeners.push(t)}vacuum(){if(this.delegate.size>this.maxSize)for(const[e,t]of this.delegate)if(this.delegate.delete(e),this.expireListeners.forEach(i=>i(e,t)),this.delegate.size<=this.maxSize)return}}t.MRUMap=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isCussy=t.getCuss=t.NaughtyWords=void 0;const n=i(105),r=i(2),s=i(213);function o(e){const i=e.toLowerCase().normalize();for(const e of[i.replace(/[^a-z]/gi,""),...s.unl33t(i)]){const i=t.NaughtyWords().find(t=>e.includes(t));if(null!=i)return i}}t.NaughtyWords=r.lazy(()=>n.brotliDecompressSync(Buffer.from(["G24yBdxY6FE9AIB56kZgVD0kUDeM0HozfcdOfRyH23FTwzDY8VIiYsefEhE7TvItgRvq8R21YMV","sIKayhmm2WwJHeT5Eqg1VmbLz8X2gMGSUgGmmbhBjio3LrYuisamIeSDtN5CY8f6Kqp4g89fo9E","ZscKID3kdlNi5dl4cjYtUGcY4/PYB8dNhXNtM2Cij4fUO0h+3dI4wDNuYjsKITiHdyFej7r6pVS","8pDOwMi5VnwUTbwH2UC/A6b+nJCdSFWIae6H+/lqmwO3t//7ey1jz9EKUV2/1caNPpJZBEIQREc","RISIQTxfEiVvf6Qecm5kOfnpbDG2UrZabJ+NXcruf/bHxr43btW5Mdy+J4PBwBg44/hhaDJ8MDw","ZozMyGSWMmtxJ7lHuSe6fHx5RHvXmycXTg6cfnmtxjM5Rk6MWRzlHJcefeBG89PAq5S8Hbw/evn","jvi39eTG6mJ9PBzGRmMbOZSea/m1mNWSezfnz+FZ9/i0VlEax8WG8BAfoHT/i88Xahk9M6dVw0l","c6gc9FL9H7z/f8/PzcuhIvJpUEk24nuRcztIObWidlFQEpgF4F6CKwg8BXBKwSHiXiJiE+In5S4","XyLu2yT+Jnlu8hgX6SHSadL/IlNDRkLGDjK7kqUmyw6ycoLKg4jDEOfowzlpnLMG56w356zk9BL","nqeQonaOKo4XjNo4RztXFmYgz+3Bmk2KEYn2ojFCVTnWaqnXqnwhlD0o7KC9TWy9ql6h5qJ9d1N","uN6IaIhogv4iNUEap01CFUO1C3od6JnmxkE7IZTTqOFE5/cJZwrHCvH+yeWBe+Cbw68Dw076K5R","OM7zbfoVNPplY6etDW03Wl70K7Qumm9aL3Tc9O/+vHGn5n0h2lcTJ8v83OKUEWQEPRFOk0+ceI2","cnWR2SSLIm83mxq262FtYm2L9RCrT3a2A0WBJWANwAy4gBDkPqDSoRLoO1B9g2WCR8D5gBrQBIb","BGLDjDTPBbMJy8FHDh4SPdfHxFF/65MsU35r51sLvp/innJ+H+Hk8/KzlDI1ZoCh4C8wCGmABvy","DNSAuiRsyIFXIJ8V+cNXHWHypCJehb6DvofND1g5pQM3oJvYxehfpCY6AZNCeUAfsFD8HXBU+F2","+Al6Bv0D8zgluC/tmHTmAqLgcWDpbA0lmH/ytjOxXmLc5mnJ4+bx6N8xHrbAAk0JWgINA6QBfQf","6BrQldD1ga4HeiX0emCsBeNPMP4MUx+YTpgr4eEBj5XwjELKhNRA/IJ8Ba8SeNWAV014VcI/v+D","fKrAksJRQxaFEUGIo6VBT8JUjxZDjjdiB+I7qD2oIdS3UXVH3gTZhqjCXcNXGPyVnzo/To5wfGa","U05XpT7k7t95vGOo2LVr7oXg/dc9F+v+mKwRcT3/Fnvknxwzo/9skv98Wl+nD5Ka7HvXMtE9abZ","5p3lSy/lrDs3lh2T1bcKyvrMGtSsfdLyt52seHuzLXE5naIzVPOIDWDtBgqxVDZGL52tuViH3dn","PKozTZ1MUz92qzi7/2TEaCcxEsQZJjyL+GkQv1uUuhalySjRJiWmKLdPqjRRj9PU9Qo1t0bNabL","YQUozOWSkKkg9Q5qdtK/JXR9yt4fcdpA7HzKmyFtN1yXpWk13pWjSRBt30ca9aLaL5kqaf0zzW7","SYD+35CMgmIE3guA2GHIyPwIiB10sgtgLPt8DzDRJDSAwjMQqJERzpC6d6x6nuOGUdJ6XhpBknO","3GSwlnN6E6htwq9tdBbA6U/cNjhyx2eGagxuOxw6wP9I+ifwF8CPl/hlgi3YuA7MjDZgkkM6xJM","E5hrYtEKe7Q5ioujuzi8P1xqKVfdw9msnOsV7lZO7kYP7n67uEmM2+XJl6SJL+VlviwNn22t+Pq","sfVZu/LcKN/5bnRuzOld3DDGSCD0LoWcQqRciR1BEiqJbQ4khlBhGiVEoMYIqzaiHHHU0o+4jqD","GMmlOoOY0eZ9Cz0kg9jfRPIXMamV8jbzO6sg3dSKFVOVqzo43zQbulY4rtGJNhbF+YmIX5quH4y","7j2DX5kO/7kVmwMY7+fYB85vtbgWz3xzdnwzWX8/ZPEqy/h9Rr85gpN+1c0739F8/6eNFtN81XQ","X6Wi+95F932Lbs7QLjmt9Yc27LSfT+h1Cb0YD/1bL9HvVZ1XaicPe4yHf8t4sTUzvLcwvHsYZpR","hSRmyi0mVMKlKJnUFk68bc2STsdkZX5+HMYYY79OZjWMwy76Yn7MGQXQRxEaQbsJRTjAbiR0i8b","dI12VS6w958g5xJok2DzI9i8x2kfmvyKIVWUyR5RR5c4W8949Y6p/YSDMb38MmXmG77GyXf6zHW","6zH26yqYA07612S9c6HXb3FrtnZDRm77ALmnwD9mcCSA8s/YMWAde+ANwH5z0B+HiATEElANAbx","XRDfDX8OO/w54lA7BLXcoPQHtClwm8BrGPQY6KuDtxp8voK7K+HuXfCdFOyYBYshWAzDYhQsRmA","5BcvZ+Chz8iF9goBwNhH+pIS/0UiGnWTcIhm3ScZdJOMOybwXqbRJau8QbxPxNpPlND2dpnA2Sq","Upy0S/fge0M0BtQE8DPQvYR8DGA2wWsPkAPwKiC6QMaTWRVw9ytiBqR/QSoknkykJ8GInNSNqRX","C/kiaFiQ6UJldqoDKGyAp12dPqH6rlQO4TaDHr9CL1+jPop9NmFR7/gWctQmqA0Q2mBb1eop6D+","Bl5W6J9AvwVzCndT4u5W3JUTqw7MtsKuH7H+9GKPvsXWy8HWRWy9H2z97pxiO8f24lx2HuGVFEv","nFMslxSrrYr3bUtZ79IP1GUNAUQGtAmhZwHoFsP0CfDOQMrjFBbd4oHkJmpeheRU0r0C7NEHLBr","p+Avp3g94qoScFjvHAkHUY7gmjUjAqJ8xcD8RGIDsfiG+C+GZIbIHkfcNrWYetaaj6EpTYoU4T1","GmG0jKkxpDLjvglJDSQ0ETix0jakZxGchby/xFKmlD9OFCjGeWHUH4JFdOoVKByCpXTqFsa6tFE","PdronA9GWjCqE2OHMDuE8T24NITL94ErZ8GVs+OKClc0uPIvrJBhRXuwYiz8K+uc487FGVqikE0","UrQrFcYpSaaJUWij5IUr3x5RLE+XSQjnnopzLqKxKqvRXVOmvafKf6a5odI+bXis7DvHjGvy4Jn","/GKvy51fw93g+PMsX7yq68VE1e7SNe7WNer5+Hp99iOT7DrFV3VnOuxsadncwlMTbV4gxfd2d8a","TyMVSyMty4x3ivEeK8Ik/w2u5MOokpE1ESI5m6E7XbCr0zCryQR35rEc3lQitkpxfyjHG8bZXYb","RcuKomWh2NdOiTVCR+1XdNR+TUd2FJ2EGrXk1qi10tTjfZo6FIOaXibFKfIoDfla1smzpMhzq0h","dLeR6lZH7mCK3VSd9t5KxNZOxtUHGsJP31CRvv01Xdoau8mu6ZZvo1pbQrdhCt56P6Eaa6Eaa6c","aa6K6cou9h/6WJU7Rx2GnjttHm+Iq2XmvR1rDRIiZaxEyLWNGr3Bq956gC6q0N6h0DIgsQuYEoB","URpIE4BcRpItwOJGQw1gaEWMJQCQ2kwlAWGMkD3tYGWGHilkN3NiCeNI4nhaHbjKKdxLJtwqtjE","qfIJTtXbOCXNOCWtcKrfjlOHHKeWHCfSghPrD072ZZxcdpzcZpwlTThLmnGWtMJZ1h+cdcnRraf","QrafRHT9Br6TxlJ6GI2n4rha4rupwa3XoSUHPE1xJF27FMG5iGHfJJtwlW7AiTVhJByZbK0xdHC","vvag/F67JTrKuSwrt/FN6rU/ySjWrbT1PdhyfluhyUu2VTXiWmrsbq1M1QUHfMLur1cT7U//Xt4","ublH3OxLTUX79POxWHfubHFJ1cOVa7an5V72ZLG/fc/fxHS5IguDsQ4kohUDPRX39ZC0bk1lLVn","oY6YUXdOo8a0o+asgR7ZYfQ8e3X0PPtjZKsmZKsWpJ5ypN9y5J230ZUdQVf5NboeH6Hr8TG6ia3","QWjWhtWpB71vdMPV0YPSliVkJYaLNwvyG//FRDOGjmIXrZww/2veJP4ph/Kl9H/gT2YQtuf2PLT","mMnX0Z9j7N2DuG8dVpxtfagm/ZEbxiM3iytcKTrS28fqvx1mXHvzo1+Nenhqa8umimu9MsLdH8u","TuNaxWN7zGaGFVofoeM/nJX0bGpk67t2bTtqE5rh53Wun+01qvT7mmn9Y9/9PonRu+Ydl4+8128","UjvFG/5d4WFzTB62peJhW1o8bEvDw1vLPBw5Nw/DMRn8ljN8TjmTKnuYfB2DWY6+CDW3Eo63nXC","8ywnH+zZBpwZBpyZhlZlgmibYPznBZpLgtyYhhy7C90+NHJkfcmRfkY7DTp6kjXyWniK+YyHavh","a5unOQHW85ee+fKixV34clp51NvMrY5F3GVvplVq0U6w47uyURu3VZgbosgEgESD0CzqICtCmBp","SZgjWzASgLYownYkwl4iQCPGfBYAX4rAF/vAJEUcC/dwE9p4PeKQUwWiMkNMaUgpjTElAUxZSC+","xSD50YTkvA1/SxXQmtug3XfB314+2TbxccVHBIOrDLGhe+7ql1IYZKCVdzHwUzNeDGQdT49UBYO","PUTFa99lv4awXSL1CeP95oGMb8zaJ3LuothTxGgI9Hhn4VGXUtoZ5nqIN055p/Rq6564tQK5yit","76wLEe43J64ufx6nmtqlneAm/yylHMnyVe9VqCTssuKDteuRJ+u5SHcIoYw5HgSh83YiR5MaiCK","9Qt9ALhcmFrEHlI2fUY8iEszleawvYPOdC6sKHBGP1zSNMaTM1CGr1uP0Q4NjBfYtqer/YlnC2A","zw+ZIuq3cU5jU7Zrokw11ENEM8Bkqhc8Zk/iVdzodopx/iZL9GWwrGMYQwDGqBjX8Kffz4mVuRc","sbA4KNsm5Sjgjn60wxXhJ3N3ChY2pC0x2jefLhW1SV6/B5w5TV3hq+Bx7syKb7NQCWae/cbavKH","fefwTSuluabsQ4ISfYn022aG55iAfyRK0z2UFnzf4hR8n8JDanVhJf4oOY1SQLG8iVuMy9gh1ru","wxlQ5w+JH94fp9+OTvV8jqvvDvGFNUBzVvfkEKTeTUEDf+FW7XAKlGRcHb5Vdg8VTAZOmRMh+la","agNDTITyNpJ+k7stTF2ZKhEuCdzFEJeiArjA8wN/qqZYJ8yb2+vPx8VnwHvNACMIZnLiiT4ux+W","QafJnvHXx+mX75uunCldmP0m3dNPWL6GdIny6xv0SWMf+Vft8rf6ijNE/5h8NN6S1L9ezym/i5y","GVX6mvGc0c8NpgVkuMC8ktVxaVcTZ9CIZ0IyfuF0OqN+HuP6b8JxmZQqrjJgpsle7wLWtVnXo/X","Soc4Um1Fd2qPuK/ouKS9cgmgyr+16Pys5988vlJx+e+Lj+ZzPoGlnvZ2DWiaXVhxa44xJE1lrwx","NjyyVkC/RV0GWMmTNa89JdxoUI774BPLPHqXg1Fyn0I+cRWPc7uVNrZ1STSkvZk8E/j9JkvVVlM","lPVVgT8Vr8Cmyto2ZMoC4dPl8aZJarp0OmuCk5JVdA5re/FSVBi5OvC05Lom4eXKywFQ1rLb0ZK","gqvjw87q7BEy44BkOc97JBHFVIcUmi/QDVp3WIfHlmPzQMHAm8vG0BjdDtYSMusfsU8zzNiWuWC","hrEyblJp+LtE8nZJu3y2RPvWKVe4pKwyk9xZftFjHRZwsnZJGuHS/jWyV4HjTttMeACbGB8sqx1","gTI2TvsV4lIPkocTYmmrZFmXda5C2gmnGDcF5RrlEZyCqpn2l7YXo4M0nskIFGzxmXw6tm5PvOY","9JEewmTk0m7y6JRLVzs/4rBJWknMTBJshMhkjUeGiXN2nbA13XNHgZEkGNqWsdRkflTWQlXBybo","IOyc4UoFRyc6PnC3RLvbn2ZMFTKBe7RpO+rtCBbTyA/6PQkcgpHvQrp8OAZF/dqh5lHVPpbYv0J","m1RVypqOS5RPr3mS1Wb4OBc9FUon344r5rxp8dJT1aOs0k1H+KhPbTuykX56m6kU9yVxfDOraKt","iP4lPkK4ZJfv/MdzSho/B+bkEttpnEQrT9a9bGx3IONnfOGrjo2azNQoHkOwlMKxUOmkiEu/yYV","3Dze1fTlsq2iXcHK2GS7ezMXSWrpm6aqKcISuToh72fiU3/KMI27yGdjAcy+c1yazdRgzX1SSFV","S97tappuMSq2esdamUg/ksfgSy5mrmJJcRuXgYanFsxt1KIf68wfGbLCV/SxKmA+VosSFKbKtgi","NdyiaEzOavBGQ/mU1XTgThfxnn3IuLV37IGVM2bzK7QeL6Jd/F5eGKDuNoc96VYed4d/XvVTjxT","gdd4jQ/0Tdt/6XFes3peEHcko8eVZ+sO4sYoiYu4qpnVK1ScThOZ6zCxYDR6cmn75uUU+5S8N7T","S+2ZnFzc6Lu7WRuWvQn+VLW3tvmpZs4L8pg+9VPlBfn1iPYCuBGxgZ3jfstwX0vthQQoyWifwyR","qFtmAUfqW33LcsHImHK1dgpEkuvAqcnJuEWY9oManu4Kk4MVp3MlUlAXXaUk9pDDJ9woN4u5KcW","OTqPlWtDo5rrxzthCGeR+viDzi5ecTYnx75Ed1ZCzyFrTs9Xdt6dfLa2AsueCqVFJ8JnJybhOKR","ARddrKfLNbD5UvYrkPUgrLEY/V7wtZL7uhFK9R0X22mc9IjIOHQm5VHDlqtnU/ZDXvXCOT7KlUd","ScqNnNKh02AaG/Ml1JlL2K8DJeG+CVh7vW24Vn7FBBif5ak+x47LXklqOC61T8zyWKutiikfbNh","ldAhucVo7H9fpUatMJ0V27buP8F83+Q8yxEQtxia0rFc5AJA7SlueTjFKicNBad8rlKRu4hsEa2","1W2g1A+JjxkPoxTJaQtUU/ltMYMBx3rEQzEf7yv1xp6BeOKlbgRS7TZ7LWOfoUZnLtsqJWwnpY7","nJxNlBq8TLHF/L/DR9xpObq7Qa2Ek7PJUcdpjL7gI8qq0J366GDiojO0fGZsfDK4lyYRL7PzvKY","tJNs1VKw95AQnkZZc5YqN1GtmNUl1CeZfi/2pFvYd7G1w/ArbYzBLv8qLHWyDL07ONviI770yXS","GMHHc57uJRveOx/tKff4i/LnIuiHR4eTrh1W9pBy8nb+RPjktbcWt+lKZ6ZeEKcLIu2gYjXQYYV","da9bFSD445UsLHInorrYIGnq7/g2mjYU/+SvoBT4/6yTlvKqq3Pv4KqfJqT1qtAgC3PWaeXNfnE","5Hf7Gub++RazGxqhu1JwQh1YFdutKv4lDi+9ftzXVtGevHURdyjR9YpUx4a4djvvlGv8/PkSDUm","sR/oh33LRwK4TZRV1s6qzaqt6YjwDjKpRfFsnsRbHiltouS7EV+OMd/ZkAw=="].join(""),"base64")).toString().split(",")),t.getCuss=o,t.isCussy=function(e){return null!=o(e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unl33t=t.l33t=void 0;const n=i(1);t.l33t=function(e){return e.replace(/o/g,"0").replace(/[il]/g,"1").replace(/e/g,"3").replace(/a/g,"4").replace(/s/g,"5").replace(/b/g,"6").replace(/t/g,"7").replace(/g/g,"9")},t.unl33t=function(e){return function e(t){const i=t.indexOf("1");if(-1===i)return[t];{const r=t.substr(0,i),s=e(t.substr(i+1));return n.flatten(s.map(e=>[r+"l"+e,r+"i"+e]))}}(e.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WritableToBuffer=void 0;const n=i(141),r=i(60);class s extends n.Writable{constructor(e){super(e),this.deferred=new r.Deferred("WritableToBuffer"),this._buf=[],this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",e=>{this.deferred.reject(e)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,t,i){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,t)),i()}}t.WritableToBuffer=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColoredLogFormatter=void 0;const n=i(33),r=i(1),s=i(37),o=i(0),a=i(7),u=i(74),l=i(28),c=i(29),d=i(77),h=i(106);class f{constructor(e={}){this.logLevels={trace:"trace",debug:u.darkGrey("debug"),info:u.cyan("info "),error:u.redBright("error"),warn:u.yellowBright("warn ")},this.inspectOptions=Object.assign(Object.assign({},f.defaultInspectOptions()),e),l.isTest&&(this.inspectOptions.breakLength=255)}formatMeta(e){return null==e?void 0:s.isError(e)?s.errorToVerbose(e):n.inspect(e,this.inspectOptions)}formatLogEntry(e){const t=h.logFilter().highlight(e.ctx)?u.yellow:u.blue;return r.compactBlanks([d.dateForLog(e.ts),c.colorProcessName(o.orElse(e.from,()=>this.inspectOptions.processName())),this.logLevels[e.l],t(e.ctx),e.msg,this.formatMeta(e.meta)]).map(e=>a.toS(e)).join(" ")}format(e,t,i,n){return this.formatLogEntry({ts:Date.now(),l:e,from:c.processName(),ctx:t,msg:i,meta:n})}}t.ColoredLogFormatter=f,f.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:25,processName:c.processName})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaintextLogFormatter=void 0;const n=i(33),r=i(1),s=i(0),o=i(11),a=i(7),u=i(29),l=i(10),c=i(77),d=i(107);t.PlaintextLogFormatter=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e,this.paddedLogLevels=o.fromEntries(d.LogLevels.values.map(e=>[e,l.rightPad(e,5," ")]))}formatLogEntry(e){return r.compactBlanks([c.dateForLog(e.ts),u.processName(),this.paddedLogLevels[e.l],l.stripAnsiEsc(e.ctx),l.stripAnsiEsc(e.msg),s.map(e.meta,e=>n.inspect(e,this.inspectOptions))]).map(e=>a.toS(e)).join(" ")}format(e,t,i,n){return this.formatLogEntry({ts:Date.now(),l:e,from:u.processName(),ctx:t,msg:i,meta:n})}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CLI=void 0;const r=i(187),s=i(19),o=i(29),a=i(65),u=i(3),l=i(0),c=i(188);t.CLI=class{constructor(e,t,i){this.serviceName=e,this.args=t,this.additionalDescription=i,this.plugins=[],o.setServiceName(e)}add(...e){return this.plugins.push(...e),this}parse(){return n(this,void 0,void 0,(function*(){let e=c.addFooter(r.program.version(a.version,"--version","Output the version number (spoiler: it's "+a.version+")").description(c.CliDesc[this.serviceName]+u.mapNotBlankOr(this.additionalDescription,e=>"\n\n"+e,()=>"")));l.map(this.args,t=>{e=e.arguments(t)});for(const t of this.plugins)e=t.beforeParse(e);e.parse(s.argv);for(const t of this.plugins)yield t.afterParse(e);return e}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.backupDbCold=t.makeVersionBackup=t.escStr=t.verifyDb=t.backupDb=t.sqlite=t.sqliteVersion=void 0;const r=i(266),s=i(64),o=i(21),a=i(26),u=i(148),l=i(6),c=i(27),d=i(50),h=i(4),f=i(25),p=i(7),m=i(280),g=l.mkLogger("SQLite");function v(e,t){return n(this,void 0,void 0,(function*(){const i=yield u.sqliteNativePath(),n=yield a.elapsedAsync(()=>o.stdout(i,[e.nativePath,t],{timeout:1*h.minuteMs}));return g.debug("sqlite("+t+") on "+e+" in "+n.elapsedMs+"ms",n.result),n.result}))}function y(e,t){return n(this,void 0,void 0,(function*(){return g.info("coldDbBackup(): copying "+e+" to "+t),f.thenCollect(m.sqliteFiles(e),e=>e.copyFile(t))}))}t.sqliteVersion=function(){return n(this,void 0,void 0,(function*(){return f.thenMap(u.sqliteNativePath(),e=>n(this,void 0,void 0,(function*(){const t=yield o.stdout(e,["-version"],{timeout:c.CmdTimeoutMs}),i=t.split(/\s+/,1)[0],n=new r(":memory:",{fileMustExist:!1}),s=n.prepare("select sqlite_version()").pluck().get();return n.close(),{libraryVersion:s,toolVersion:i,fullToolVersion:t}})))}))},t.sqlite=v,t.backupDb=function(e,t){return n(this,void 0,void 0,(function*(){try{yield s.mkdirp(t.parent().nativePath);const i=yield m.sqliteFiles(t);yield Promise.all(i.map(e=>e.unlink())),yield v(e,`.backup '${t.nativePath}'`),t.clear(),g.info("backupDb(): copied",{srcDb:p.toS(e),destDb:p.toS(t)})}catch(i){throw new d.WrappedError({cause:i,fatal:!0,message:`Could not back up db ${e} -> ${t}`})}}))},t.verifyDb=function(e){return n(this,void 0,void 0,(function*(){try{const t=yield v(e,"VACUUM ; PRAGMA integrity_check");if("ok"===t.trim())return g.info("verifyDb("+e+"): OK"),!0;throw new Error(t)}catch(t){throw new d.WrappedError({cause:t,fatal:!0,message:"verifyDb("+e+") failed"})}}))},t.escStr=function(e){return`'${p.toS(e).replace(/'/g,"''")}'`},t.makeVersionBackup=function(e){return n(this,void 0,void 0,(function*(){if(yield e.notExists())return;const t=yield e.parent().join("version-backup").mkdirp(),i=yield null==t?void 0:t.childWithSameContents(e);if(null==t||null!=i)return i;const n=t.join(a.filestamp()+"-"+e.base);return yield y(e,n),n}))},t.backupDbCold=y},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatsModel=void 0;const n=i(92),r=i(281);class s extends n.TimestampedModel{}t.StatsModel=s,s.schema="stats",s.db=r.statsDb},function(e,t,i){"use strict";function n(e,t,i=.5){return(1-i)*e+i*t}Object.defineProperty(t,"__esModule",{value:!0}),t.lerp2d_=t.lerp2d=t.lerp=void 0,t.lerp=n,t.lerp2d=function(e,t,i){const r=t.x-e.x,s=(i-e.x)/r;return n(e.y,t.y,s)},t.lerp2d_=function(e,t,i){return(e.y*(t.x-i)+t.y*(i-e.x))/(t.x-e.x)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.parseRawInfoOutput=t.rawInfo=void 0;const r=i(1),s=i(3),o=i(4),a=i(37),u=i(2),l=i(0),c=i(5),d=i(11),h=i(7),f=i(22),p=i(55),m=i(21),g=i(13),v=i(84),y=i(302),b=i(148),w=i(51),S=i(6),P=i(10),M=i(132),E=new p.BoundedMap(7*o.minuteMs,2048,!1);g.onClearCache(()=>E.clear()),g.onFileChanged(e=>null==e?E.clear():E.delete(e));const x=u.lazy(()=>S.mkLogger("DCRawInfo"));function _(e){const t=v.splitLines(e),i=r.compact(t.map(e=>{const[t,i]=P.splitFirst(e,":"),n=function(e){return h.toS(e).split(/\W+/).map(P.capitalize).join("")}(t);return l.map(function(e,t){return s.blank(t)||T.includes(e)?void 0:e.toLowerCase().includes("time")?l.orElse(w.parseDated(t),t):e.endsWith("Size")?M.parseDimensions(t):D.includes(e)?c.toInt(t):O.includes(e)?f.toBoolean(t):t}(n,h.toS(i).trim()),e=>[n,e])}));return x().tap({msg:"parseRawInfoOutput",result:d.fromEntries(i)})}t.rawInfo=function(e){return n(this,void 0,void 0,(function*(){return E.getOrSet(e.nativePath,()=>n(this,void 0,void 0,(function*(){try{const t=yield b.dcrawNativePath(),i=yield m.stdout(t,["-v","-i",e.nativePath],{timeout:y.StatTimeoutMs,ignoreExitCode:!0});return s.mapNotBlank(i,_)}catch(t){return void x().warn("rawInfo failed",{file:e.nativePath,error:a.errorToS(t)})}})))}))},t.parseRawInfoOutput=_;const T=["CameraMultipliers","DaylightMultipliers"],D=["RawColors","ISOSpeed","NumberOfRawImages"],O=["EmbeddedICCProfile"]},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.duration=t.extractDurationSec=void 0;const r=i(0),s=i(5),o=i(68),a=i(32),u=i(82),l=i(39);function c(e){return r.map(e,e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(s.gt0))}t.extractDurationSec=c,t.duration=function(e){return n(this,void 0,void 0,(function*(){const t=a.PosixFile.for(e);return o.thenOpt(l.mimetype(t)).filter(u.isVideoMimeType).flatMap(()=>l.readRawTags(t,!1)).flatMap(c).get()}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrSetByNativePath=t.sameNativePaths=void 0;const n=i(4),r=i(15),s=i(13),o=new(i(224).TTLMultiMap)(10*n.minuteMs);function a(e){return[e.toString(),...r.toA(o.get(e.toString()))]}s.onFileCopied((e,t)=>{o.add(e,t),o.add(t,e)}),t.sameNativePaths=a,t.getOrSetByNativePath=function(e,t,i){for(const t of a(e)){const e=i.get(t);if(null!=e)return e}const n=t(e);return i.set(e.toString(),n),n}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLMultiMap=void 0;const n=i(79),r=i(100);class s extends r.MultiMap{constructor(e){super(new n.TTLMap(e)),this.ttlMs=e,this.m=this.store}add(e,t){return this.m.touch(e),super.add(e,t)}}t.TTLMultiMap=s},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.rotateToImgTmp=t.rotate=t.rotateInPlace=t.validJpeg=void 0;const r=i(4),s=i(2),o=i(108),a=i(8),u=i(21),l=i(13),c=i(148),d=i(6),h=i(14),f=i(129),p=h.isWin?"NUL":"/dev/null",m=s.lazy(()=>d.mkLogger("jpegtran"));function g(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield c.jpegtranNativePath();if(!o.isRotation(i))throw new Error("refusing to rotate("+e+", "+i+")");yield u.stdout(n,["-copy","all","-trim","-rotate",i.toFixed(0),"-outfile",t.nativePath,e.nativePath],{timeout:r.minuteMs})}))}t.validJpeg=function(e){return n(this,void 0,void 0,(function*(){const t=yield c.jpegtranNativePath();yield u.stdoutResult(t,["-outfile",p,e.nativePath],{timeout:30*r.secondMs})}))},t.rotateInPlace=function(e,t){return n(this,void 0,void 0,(function*(){const i=e.wip();m().info("rotateInPlace("+e+")",t),yield g(e,i,t),yield i.unwip(),l.emitFileChanged(e.nativePath)}))},t.rotate=g,t.rotateToImgTmp=function(e,t){return n(this,void 0,void 0,(function*(){return null==t||0===t?e:a.thenMap(f.cachedImgFile(e,"r"+t,e.ext),i=>i.applyIfEmpty(i=>g(e,i,t)))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.videoExtFilter=t.browserExtFilter=t.browserImgExtFilter=t.extFilter=t.excludedPathFilter=void 0;const n=i(1),r=i(3),s=i(2),o=i(18),a=i(44),u=i(304),l=i(10),c=i(48),d=i(30);function h(e){const t=s.lazy(()=>new Set(n.compactBlanks(a.tot(e).map(e=>l.ensurePrefix(e.toLowerCase().normalize(),".")))));return u.Filter.lift(e=>o.Opt(e).flatMap(e=>r.firstNotBlank(e.ext,e.base)).map(e=>t().has(e.toLowerCase().normalize())).getOrElse(()=>!1))}t.excludedPathFilter=function(e){const t=new Set(e.map(e=>e.toLowerCase()));return u.Filter.lift(e=>d.pathnames(e.nativePath).every(e=>!t.has(e.toLowerCase())))},t.extFilter=h,t.browserImgExtFilter=h(c.BrowserImgExts),t.browserExtFilter=h(c.BrowserExts),t.videoExtFilter=h(c.VideoExts)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractLensMakeModel=void 0;const n=i(1),r=i(3),s=i(10),o=i(228);function a(e){return e.filter(e=>r.notBlank(e)&&"n/a"!==e.trim())}t.extractLensMakeModel=function(e){const t=o.make(e.LensMake),i=o.make(e.Make),u=a([t,e.LensMake,i,e.Make]),l=e=>u.reduce((e,t)=>s.stripPrefixIgnoreCase(e,t).trim(),e);if(r.notBlank(t)&&r.notBlank(e.LensModel))return{lensMake:t,lensModel:l(e.LensModel)};const c=a([e.LensID,e.LensType,e.LensInfo,e.LensModel]);for(const e of c){if(r.notBlank(t))return{lensMake:t,lensModel:l(e)};if(e.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:l(e)};for(const r of n.compactBlanks([t,i,"Canon","Carl Zeiss","Fujifilm","Konica","Leica","Olympus","Sigma","Sony"]))if(e.toLowerCase().includes(r.toLowerCase()))return u.unshift(r),{lensMake:r,lensModel:l(e)}}return n.isNotEmpty(u)&&n.isNotEmpty(c)?{lensMake:u[0],lensModel:s.stripPrefixIgnoreCase(c[0],"unknown").trim()}:void 0}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.model=t.make=t.companyCased=void 0;const n=i(3),r=i(0),s=i(10),o=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|"),a=new RegExp(`[\\s\\.,_-]*(?:${o})[\\s\\.,_-]*$`,"i");function u(e,t,i=""){const n=e.replace(t,i);return n===e?e:u(n,t,i)}function l(e){const t=e.trim();return"gopro"===t.toLowerCase()?"GoPro":"benq"===t.toLowerCase()?"BenQ":"oneplus"===t.toLowerCase()?"OnePlus":t.length<4?t:t.toLowerCase().replace(/(?:^|\s|-)\S/g,e=>e.toUpperCase())}t.companyCased=l,t.make=function(e){return n.mapNotBlank(e,e=>e=l(e=u(e=s.stripQuotes(e),a).replace("LGE","LG")))};const c=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i],d=new Map([["Samsung",[[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]]],["LG",[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]]],["OnePlus",[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]]]]);t.model=function(e,t){if(n.blank(e)||n.blank(t))return;let i=s.stripQuotes(t);const o=r.map(d.get(e),e=>e.find(([e])=>null!=i.match(e)));return null!=o?o[1]:("Sony"===e&&(i=i.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"Î±").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V")),"Olympus"===e&&(i=r.mapOr(/^(.+?\d)mark(i.+?)$/i.exec(i),e=>`${e[1]} Mark ${e[2]}`,()=>i)),"Canon"===e&&(i=i.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel")),c.forEach(e=>i=u(i,e).trim()),i=i.replace(new RegExp(`^${e}\\s+`,"i"),""),null!=e.match(/^HP|Hewlett.Packard$/i)&&null!=i.match(/^hp\b/i)&&(i=i.slice(2).trim()),i)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DbRequestLocal=void 0;const r=i(55),s=i(1),o=i(4),a=i(0),u=i(149),l=i(230),c=i(150);t.DbRequestLocal=class{constructor(e,t){this.db=e,this.tableName=t,this.cachedStatements=new r.BoundedMap(o.minuteMs,1e3,!0),e().addCloseListener(()=>this.cachedStatements.clear())}qb(){return u.knex(this.tableName)}exec(e){return n(this,void 0,void 0,(function*(){yield c.tx(this.db(),t=>t.exec(l.toSqlQuery(e).sql))}))}prep(e,t,i=!1){const n=l.toSqlQuery(t);return{sq:n,stmt:this.cachedStatements.getOrSet((!0===i?"pluck:":"")+n.sql,()=>{const t=e.prepare(n.sql);return!0===i?t.pluck():t})}}wrap({q:e,pluck:t,m:i}){return n(this,void 0,void 0,(function*(){return c.tx(this.db(),n=>{const{sq:r,stmt:s}=this.prep(n,e,t),o=s[i].bind(s);return a.mapOr(r.bindings,e=>o(e),()=>o())})}))}run(e){return this.wrap({q:e,m:"run"})}mapRun(e){return c.tx(this.db(),t=>e.map(e=>{const{sq:i,stmt:n}=this.prep(t,e);return a.mapOr(i.bindings,e=>n.run(e),()=>n.run())}))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}first(e){return this.wrap({q:e,m:"get"})}all(e){return this.wrap({q:e,m:"all"})}mapAll(e){return c.tx(this.db(),t=>s.flatten(e.map(e=>{const{sq:i,stmt:n}=this.prep(t,e);return a.mapOr(i.bindings,e=>n.all(e),()=>n.all())})))}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}pluckBatched(e){return n(this,void 0,void 0,(function*(){let t;do{t=yield this.wrap({q:e.qb(this.qb(),t).limit(5e3),pluck:!0,m:"all"}),s.isNotEmpty(t)&&(yield e.onResults(t))}while(s.isNotEmpty(t))}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.wherein=t.maybeLimit=t.isQueryBuilder=t.hasLimit=t.toSqlQuery=t.isSqlQuery=void 0;const n=i(10),r=i(20),s=i(5),o=i(11),a=i(38),u=i(231);function l(e){return null!=e&&n.isString(e.sql)&&(null==e.bindings||u.isDbValued(e.bindings))}function c(e){if(null==e)throw new Error("null sql");if(l(e))return e;if(n.isString(e))return{sql:e};if(a.isFunction(e.toSQL))return o.without(e.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+r.stringify(e))}function d(e){return null!=/\blimit\b/i.exec(c(e).sql)}function h(e){return a.isFunction(e.where)&&a.isFunction(e.limit)}t.isSqlQuery=l,t.toSqlQuery=c,t.hasLimit=d,t.isQueryBuilder=h,t.maybeLimit=function(e,t=1e3){return h(e)&&!d(e)?e.limit(t):e},t.wherein=function(e){return"("+s.times(e,()=>"?").join(",")+")"}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toDbValued=t.isDbValued=t.isDbValue=void 0;const n=i(51),r=i(1),s=i(11);function o(e){return r.includes(["number","string"],typeof e)}t.isDbValue=o,t.isDbValued=function(e){return null!=e&&s.entries(e).every(([,e])=>o(e))},t.toDbValued=function(e){return s.mapFields(e,(e,t)=>{if(!e.startsWith("$"))return"boolean"==typeof t?[e,t?1:0]:o(t)?[e,t]:n.isDated(t)?[e,n.datedToMillis(t)]:void 0})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.modeReduce=t.submatrixCollect=t.greatestHalf=t.leastQuarter=t.subMatrixMode=t.submatrixMagnitude=t.submatrixForEach=t.index1D=t.slice=t.matXvec=t.vecXvec=void 0;const n=i(1),r=i(5),s=i(12),o=i(80),a=i(52);function u(e,t,i,n){const r=Math.floor(Math.max(0,t.row)),s=Math.ceil(Math.min(e.row,i.row)),o=Math.floor(Math.max(0,t.col)),a=Math.ceil(Math.min(e.col,i.col));for(let t=r;t<s;t++)for(let i=o;i<a;i++)n(t*e.col+i)}function l(e,t,i,n){let s=0;return u(t,i,n,t=>r.mapFinite(e[t],e=>s+=e*e)),Math.sqrt(s)}function c(e,t,i,n){const s=[];return u(t,i,n,t=>r.mapFinite(e[t],e=>s.push(e))),a.mode(s)}t.vecXvec=function(e,t){return e.map((e,i)=>e*t[i])},t.matXvec=function(e,t){return e.map((e,i)=>{if(e.length!==t.length)throw new Error("misshaped matrix on row "+i);return a.sum(e.map((e,i)=>e*t[i]))})},t.slice=function(e,t,i){const r=Math.max(0,t.row),s=Math.min(e.length,i.row),o=Math.max(0,t.col),a=Math.min(e[0].length,i.col);return n.range(r,s,t=>e[t].slice(o,a))},t.index1D=function(e,t,i){return t*e.col+i},t.submatrixForEach=u,t.submatrixMagnitude=l,t.subMatrixMode=c,t.leastQuarter=function(e,t){const i=t.col,n=t.row,r=[l(e,t,{col:i/2,row:0},{col:i,row:n/2}),l(e,t,{col:0,row:0},{col:i/2,row:n/2}),l(e,t,{col:0,row:n/2},{col:i/2,row:n}),l(e,t,{col:i/2,row:n/2},{col:i,row:n})];return s.leastIndex(r)},t.greatestHalf=function(e,t){const i=t.col,n=t.row,r=[c(e,t,{col:0,row:0},{col:i,row:n/2}),c(e,t,{col:0,row:0},{col:i/2,row:n}),c(e,t,{col:0,row:n/2},{col:i,row:n}),c(e,t,{col:i/2,row:0},{col:i,row:n})];return s.greatestIndex(r)},t.submatrixCollect=function(e,t,i){const n=[];return u(e,t,i,e=>n.push(e)),n},t.modeReduce=function(e,t,i){const a=Math.floor(t.col/i.col),l=Math.floor(t.row/i.row),c=new o.Average(Math.ceil(a*l));return s.concat(...n.stepRange(0,t.row,l,i=>n.stepRange(0,t.col,a,n=>{c.clear();return u(t,{col:n,row:i},{col:n+a,row:i+l},t=>r.mapFinite(e[t],e=>c.push(e))),c.sampleMode})))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.coalesceStreams=t.AssetStream=t.cmpAssetDesc=t.cmpAssetAsc=t.BeforeAfterLimit=void 0;const r=i(12),s=i(6),o=i(52),a=i(196),u=i(1),l=i(54),c=i(0),d=i(5),h=i(41),f=i(25),p=i(131);t.BeforeAfterLimit=8;const m=new Map;function g(e){return e<=0?[]:l.getOrSet(m,e,()=>d.times(e,()=>a.BlankID))}function v(e){return[...e,...g(t.BeforeAfterLimit-e.length)]}t.cmpAssetAsc=(e,t)=>h.cmp([e.capturedAtLocal,e.id],[t.capturedAtLocal,t.id]),t.cmpAssetDesc=(e,t)=>h.cmp([t.capturedAtLocal,t.id],[e.capturedAtLocal,e.id]);t.AssetStream=class{constructor(e,t,i){this.tags=e,this.before=t,this.after=i,this.logger=()=>s.mkLogger("TaggedAssetStream("+this.toString()+")")}toString(){return this.tags.map(e=>e.path.join("")).join(",")}valueOf(){return this.toString()}mergeWith(e){e.tags.forEach(e=>u.insertUniq(this.tags,e,p.Tag.cmp)),this.before.push(...e.before),u.sortUniqByInPlace(this.before,e=>[e.capturedAtLocal,e.id]),r.retainFirstN(this.before,t.BeforeAfterLimit),this.after.push(...e.after),u.sortUniqByInPlace(this.before,e=>[-e.capturedAtLocal,e.id]),r.retainLastN(this.after,t.BeforeAfterLimit)}toApi(){return n(this,void 0,void 0,(function*(){return this.logger().tap({msg:"toApi()",level:"debug",result:{tags:yield f.thenCollect(this.tags,e=>e.toApiTag()),assetIdsAfter:(e=this.after.map(e=>e.toID()),[...g(t.BeforeAfterLimit-e.length),...e]),assetIdsBefore:v(this.before.map(e=>e.toID()))}});var e}))}streamCoeff(e){return this.logger().tap({level:"info",msg:"streamCoeff",meta:{this:this.tags.map(e=>e.path),tas:e.tags.map(e=>e.path)},result:o.avg([r.diceCoeff(this.before,e.before,e=>e.id),r.diceCoeff(this.after,e.after,e=>e.id)])})}},t.coalesceStreams=function(e){const t=[];for(const i of e)c.mapOr(r.greatestBy(t,e=>d.gtOrElse(e.streamCoeff(i),.6)),e=>{e.mergeWith(i)},()=>{t.push(i)});return t}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StdoutWrite=t.isMigrationEvent=t.stdoutWriteMigration=t.stdoutWriteUpdateResult=t.stdoutWriteSettings=t.ReadyStr=t.stdoutWrite=void 0;const n=i(19),r=i(29),s=i(9),o=i(3),a=i(20);function u(e,i=r.isSyncFileService()){n.stdout.destroyed||(n.stdout.write(a.stringify(e)+"\n"),i&&n.stdout.write(t.ReadyStr+"\n"))}t.stdoutWrite=u,t.ReadyStr=a.stringify({ready:!0}),t.stdoutWriteSettings=function(...e){const t={};for(const i of e)i.addToEnv(t);u(t)},t.stdoutWriteUpdateResult=function(e){return u(e)},t.stdoutWriteMigration=function(e){return u({migration:e.name})},t.isMigrationEvent=function(e){return null!=e&&o.notBlank(e.migration)},t.StdoutWrite={pauseHealthChecks:()=>u({pauseHealthChecks:!0}),resumeHealthChecks:()=>u({pauseHealthChecks:!1}),restartSync:e=>u(s.Settings.libraryPath.addToEnv(Object.assign({restartSync:!0,pauseHealthChecks:!1},e))),shutdownSync:()=>u({shutdownSync:!0}),pause:()=>u({pause:!0}),resume:()=>u({pause:!1}),shutdown:()=>u({shutdown:!0}),sendRecentLogs:()=>u({sendRecentLogs:!0})}},,function(e,t){e.exports=require("@iarna/toml")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=void 0;const n=i(53),r=i(0),s=i(63);t.debounce=function(e,t){let i;t=Math.ceil(t);let o=[];const a=(...a)=>{o=a,r.map(i,n.clearTimeout),i=s.setUnrefTimeout(()=>e(...o),t)};return a.reset=()=>{r.map(i,n.clearTimeout),i=void 0},a.now=()=>{a.reset(),e()},a}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isInstallDmg=t.ignorableMacFilesystems=t.mounts=void 0;const r=i(1),s=i(2),o=i(0),a=i(8),u=i(21),l=i(45),c=i(40),d=i(27),h=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;function f(){return n(this,void 0,void 0,(function*(){const e=yield u.stdout("mount",[],{timeout:d.CmdTimeoutMs});return r.compact(e.split("\n").map(e=>o.map(h.exec(e),e=>{const[t,i,n]=e.slice(1);return{filesystem:t,mountpoint:i,options:n.split(",").map(e=>e.trim())}})))}))}function p(e){return n(this,void 0,void 0,(function*(){const t=c.BaseFile.for(e),i=yield a.thenMapOr(yield t.childNames(),e=>e.filter(e=>!e.startsWith(".")).map(e=>e.toLowerCase()).sort(),()=>[]);return l.eql(i,["applications","photostructure.app"])}))}t.mounts=f,t.ignorableMacFilesystems=s.lazy(()=>n(void 0,void 0,void 0,(function*(){return a.asyncFilter(yield f(),e=>n(void 0,void 0,void 0,(function*(){return e.options.includes("nobrowse")||e.options.includes("quarantine")||(yield p(e.mountpoint))}))).then(e=>e.map(e=>e.filesystem))})),d.MountpointsTtlMs),t.isInstallDmg=p},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsPosix=void 0;const r=i(1),s=i(0),o=i(8),a=i(121),u=i(120);t.mountpointsPosix=function(){return n(this,void 0,void 0,(function*(){const e=yield o.thenMap(a.dfPosixRaw(!1),e=>r.compactBlanks(e.map(e=>e.mountpoint)));return null!=e&&(yield u.isGioSupported())&&(yield o.thenMap(u.gioVolumes(),t=>e.push(...t.map(e=>e.mountpoint)))),s.map(e,e=>e.filter(e=>!e.startsWith("/snap/")&&"/dev"!==e))}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsWinFsutil=t.mountpointsWin=void 0;const r=i(1),s=i(4),o=i(68),a=i(21),u=i(71),l=i(42),c=/\s([A-Z]:\\)/g;t.mountpointsWin=()=>n(void 0,void 0,void 0,(function*(){return o.thenOpt(l.PowerShell.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(e=>e.map(e=>e.Root)).filter(r.isNotEmpty).orElse(()=>t.mountpointsWinFsutil()).map(e=>e.sort()).getRequired()})),t.mountpointsWinFsutil=()=>n(void 0,void 0,void 0,(function*(){const e=(yield a.stdout(yield u.fsutil(),["fsinfo","drives"],{timeout:10*s.secondMs})).trim(),t=[];let i;for(;null!==(i=c.exec(e));)t.push(i[1]);return t}))},function(e,t){e.exports=require("punycode")},function(e,t){e.exports=require("dns")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ipAddrFromPing=t.ipv4Re=t.ping=void 0;const r=i(3),s=i(4),o=i(5),a=i(18),u=i(7),l=i(81),c=i(21),d=i(71),h=i(14);t.ping=l.memoize(e=>n(void 0,void 0,void 0,(function*(){const t=h.isWin?yield d.pingWin():"ping";return c.stdout(t,[h.isWin?"-n":"-c","1",e],{timeout:5*s.secondMs})})),5*s.minuteMs,255),t.ipv4Re=new RegExp("\\b"+o.times(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),t.ipAddrFromPing=l.memoize(e=>n(void 0,void 0,void 0,(function*(){return a.Opt(yield t.ping(e).catch(e=>{console.warn("failed to ping: "+e)})).filter(r.notBlank).flatMap(e=>t.ipv4Re.exec(u.toS(e))).map(e=>e[0]).get()})),5*s.minuteMs,255)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosix=void 0;const r=i(8),s=i(121),o=i(120),a=i(58),u=a.lazyFsAsync(()=>r.thenMap(s.dfPosixRaw(!0),e=>e.map(e=>e.mountpoint)));t.dfPosix=a.lazyFsAsync(()=>n(void 0,void 0,void 0,(function*(){const e=yield s.dfPosixRaw(!1);if(null!=e)return yield r.thenMap(u(),t=>{e.forEach(e=>{e.remote=!t.includes(e.mountpoint)})}),(yield o.isGioSupported())&&(yield r.thenMap(o.gioVolumes(),t=>e.push(...t))),e})))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._local=t.LocalCmd=t._localAndNet=t.LocalAndNetCmd=t.dfWin=void 0;const r=i(3),s=i(0),o=i(5),a=i(23),u=i(6),l=i(42),c=i(10),d=i(246),h=i(58),f=i(169),p=u.mkLogger("DfWin");function m(){return n(this,void 0,void 0,(function*(){const e=yield l.PowerShell.instance().executeJsonToA(t.LocalAndNetCmd).catch(e=>{a.onError("_localAndNet(): PowerShell failed, trying wmic",e)});return null==e?d._localAndNet():e.map(e=>Object.assign({mountpoint:e.Root,filesystem:"",label:e.Description,size:e.Used+e.Free,used:e.Used,available:e.Free,remote:r.notBlank(e.DisplayRoot)},s.map(f.parseRemoteName(e.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))))}))}function g(){return n(this,void 0,void 0,(function*(){const e=yield l.PowerShell.instance().executeJsonToA(t.LocalCmd);if(null==e)return d._local();return e.filter(e=>r.notBlank(e.DriveLetter)&&(r.notBlankAnd(e.HealthStatus,e=>c.equalsIgnoreCase(e,"Healthy"))||r.notBlankAnd(e.OperationalStatus,e=>c.equalsIgnoreCase(e,"OK")))).map(e=>({mountpoint:e.DriveLetter+":\\",filesystem:e.FileSystem,label:e.FileSystemLabel,size:e.Size,used:e.Size-e.SizeRemaining,available:e.SizeRemaining,remote:!1}))}))}t.dfWin=h.lazyFsAsync(()=>n(void 0,void 0,void 0,(function*(){return(yield m().catch(e=>(p.warn("_localAndNet timed out, using local volumes.",e),g()))).filter(e=>r.notBlank(e.mountpoint)&&o.gt0(e.size))}))),t.LocalAndNetCmd="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free",t._localAndNet=m,t.LocalCmd="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus",t._local=g},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._local=t._localAndNet=t.dfWin=t.NETWORK_DRIVE=t.LOCAL_DISK=t.REMOVABLE_DISK=void 0;const r=i(3),s=i(5),o=i(12),a=i(21),u=i(83),l=i(71),c=i(6),d=i(10),h=i(58),f=i(27);t.REMOVABLE_DISK=2,t.LOCAL_DISK=3,t.NETWORK_DRIVE=4;const p=c.mkLogger("DfWinWmic");t.dfWin=h.lazyFsAsync(()=>n(void 0,void 0,void 0,(function*(){return(yield g().catch(e=>(p.warn("_localAndNet timed out, using local volumes.",e),y()))).filter(e=>o.allNotBlank([e.mountpoint,e.filesystem])&&e.size>0)})));const m="LOGICALDISK get DeviceID,DriveType,FileSystem,FreeSpace,Size,VolumeName /format:table".split(" ");function g(){return n(this,void 0,void 0,(function*(){const e=l.wmic(),i=yield a.stdout(e,m,{timeout:f.CmdTimeoutMs});return b(u.parseFixed(["DeviceID","DriveType","FileSystem","FreeSpace","Size","VolumeName"],i,!1).map(e=>{const i=r.mapNotBlank(e.DeviceID,e=>d.ensureSuffix(e,"\\")),n=e.FileSystem,o=e.VolumeName,a=s.toInt(e.Size,{defaultValue:0}),u=s.toInt(e.FreeSpace,{defaultValue:0});return{mountpoint:i,filesystem:n,label:o,size:a,used:a-u,available:u,remote:s.toInt(e.DriveType,{defaultValue:t.LOCAL_DISK})===t.NETWORK_DRIVE}}))}))}t._localAndNet=g;const v="VOLUME get Capacity,DriveLetter,FileSystem,FreeSpace,Label /format:table".split(" ");function y(){return n(this,void 0,void 0,(function*(){const e=l.wmic(),t=yield a.stdout(e,v,{timeout:f.CmdTimeoutMs});return b(u.parseFixed(["Capacity","DriveLetter","FileSystem","FreeSpace","Label"],t,!1).map(e=>{const t=r.mapNotBlank(e.DriveLetter,e=>d.ensureSuffix(e,"\\")),i=e.FileSystem,n=e.Label,o=s.toInt(e.Capacity,{defaultValue:0}),a=s.toInt(e.FreeSpace,{defaultValue:0});return{mountpoint:t,filesystem:i,label:n,size:o,used:o-a,available:a,remote:!1}}))}))}function b(e){return e.filter(e=>o.allNotBlank(e.mountpoint,e.filesystem)&&s.gte(e.size,0))}t._local=y},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mnt2uuidMac=t.addLocalVolumeInfoMac=void 0;const r=i(3),s=i(0),o=i(25),a=i(21),u=i(76),l=i(10),c=i(58),d=i(27);t.addLocalVolumeInfoMac=function(e){return n(this,void 0,void 0,(function*(){return o.thenMap(t.mnt2uuidMac(),t=>e.map(e=>s.mapOr(t.get(e.mountpoint),t=>Object.assign(Object.assign({},e),t),()=>e)))}))},t.mnt2uuidMac=c.lazyFsAsync(()=>n(void 0,void 0,void 0,(function*(){const e=(yield a.stdout("diskutil",["info","-all"],{timeout:d.CmdTimeoutMs})).split(/^\s*\*{3,}\s*$/m);return u.toMap(e,e=>{const t=u.toMap(e.split(/\s*\n+\s*/),e=>{const[t,i]=e.split(":").map(e=>e.trim());return l.includesIgnoreCase(["not applicable","no file system"],i)?void 0:[t.toLowerCase(),i]}),i=t.get("mount point"),n=t.get("volume name"),s=t.get("volume uuid");return r.blank(i)?void 0:[i,{label:n,uuid:s}]})})))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.localVolumeInfoPosix=t.addLocalVolumeInfoPosix=void 0;const r=i(1),s=i(0),o=i(25),a=i(7),u=i(21),l=i(183),c=i(84),d=i(58),h=i(27);t.addLocalVolumeInfoPosix=function(e){return n(this,void 0,void 0,(function*(){return o.thenMap(yield t.localVolumeInfoPosix(),t=>e.map(e=>s.mapOr(t.find(t=>t.mountpoint===e.mountpoint),t=>Object.assign(Object.assign({},e),t),()=>e)))}))},t.localVolumeInfoPosix=d.lazyFsAsync(()=>n(void 0,void 0,void 0,(function*(){const e=yield u.stdout("lsblk",["-P","--output","mountpoint,label,uuid"],{timeout:h.CmdTimeoutMs});return r.compact(c.splitLines(e).map(e=>s.map(l.parseEnvTokens(e),e=>a.toS(e.mountpoint).startsWith("/")?Object.assign(Object.assign({},e),{ignorable:e.mountpoint.startsWith("/snap/")||e.mountpoint.startsWith("/boot")}):void 0)))})))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.FsutilVolumeList=t.addLocalVolumeInfoWin=void 0;const r=i(4),s=i(0),o=i(11),a=i(25),u=i(7),l=i(8),c=i(43),d=i(21),h=i(71),f=i(42),p=i(58),m=i(67);t.addLocalVolumeInfoWin=function(e){return n(this,void 0,void 0,(function*(){const t=yield a.thenMap(y(),t=>e.map(e=>Object.assign(Object.assign({},e),o.compactValues(t.find(t=>t.mountpoint===e.mountpoint)))));return a.thenMap(g(),i=>s.orElse(t,e).map(e=>s.mapOr(i.get(e.mountpoint),t=>Object.assign(Object.assign({},e),{uuid:t}),()=>e)))}))},t.FsutilVolumeList="fsutil volume list";const g=p.lazyFsAsync(()=>n(void 0,void 0,void 0,(function*(){return f.PowerShell.instance().ended?v(yield d.stdout(yield h.fsutil(),["volume","list"],{timeout:7*r.secondMs})):f.PowerShell.instance().execute(t.FsutilVolumeList,v)})));function v(e){const t=new Map;let i;const n=/^\\.+\{([a-z0-9-]+)\}\\(?:\r?\n)([a-z]:\\)/gim;for(;null!=(i=n.exec(e));){const e=i[1],n=i[2];t.set(n,e)}return t}const y=p.lazyFsAsync(()=>n(void 0,void 0,void 0,(function*(){return l.thenCompact(a.thenMap(m.mountpoints(),e=>c.withBoundedConcurrency({name:"_mnt2info",laters:e.map(e=>()=>function(e){return n(this,void 0,void 0,(function*(){return s.map((t=e,s.map(u.toS(t).match(b),e=>e[0]+":")),t=>n(this,void 0,void 0,(function*(){const i=yield d.execStdout("vol "+t),n=w.exec(i),r=S.exec(i);return{mountpoint:e,label:null==n?void 0:n[1],serialNumber:null==r?void 0:r[1]}})));var t}))}(e)),maxConcurrent:3})))}))),b=/^[a-z]{1,2}/i,w=/Volume in drive [A-Z] is (.*)[\r\n]/im,S=/Volume Serial Number is ([A-Z0-9-]+)/i},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.addRemoteVolumeInfoPosix=void 0;const r=i(0),s=i(7),o=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i;t.addRemoteVolumeInfoPosix=function(e){return n(this,void 0,void 0,(function*(){return e.filter(e=>e.remote).forEach(e=>{r.map(o.exec(s.toS(e.filesystem)),t=>{e.remoteHost=t[1],e.remoteShare=t[2]})}),e}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readVolumeUUID=t.addVolumeUUIDs=t.VolumeUuidTimeoutMs=void 0;const r=i(56),s=i(3),o=i(2),a=i(0),u=i(68),l=i(8),c=i(43),d=i(22),h=i(13),f=i(32),p=i(6),m=i(76),g=i(252),v=i(67),y=i(27),b=o.lazy(()=>p.mkLogger("VolumeUUID"));t.VolumeUuidTimeoutMs=y.MountpointsTtlMs/2;const w=o.lazy(()=>(v.mountpoints.onChange(()=>w.clear()),new Map));function S(e){return n(this,void 0,void 0,(function*(){const i=f.PosixFile.for(e.mountpoint).join(".uuid");{const n=yield r.thenOrTimeout(()=>u.thenOpt(i.readFile("debug")).map(e=>e.toString().trim()).filter(s.notBlank).get(),t.VolumeUuidTimeoutMs);if(null!=n&&n.length>7)return b().info("Serving UUID from .uuid",{uuid:n,mountpoint:e.mountpoint}),n}if("/"===e.mountpoint)return a.orElse(e.uuid,e.serialNumber);const n=s.notBlankOr(e.uuid,g.mkuuid);if(yield i.parent().isWritable())try{return yield i.writeTxt(n),b().info("volumeUUID(): Saved new UUID for "+e.mountpoint,{uuid:n}),n}catch(t){b().info("volumeUUID(): Failed to save new UUID for "+e.mountpoint,t)}return a.orElse(e.uuid,e.serialNumber)}))}h.onClearCache(()=>w.clear()),t.addVolumeUUIDs=function(e){return n(this,void 0,void 0,(function*(){yield c.withBoundedConcurrency({name:"addVolumeUUIDs",laters:e.map(e=>()=>function(e){return n(this,void 0,void 0,(function*(){d.isTrue(e.ignorable)?b().info("volumeUUID(): ignorable is true for "+e.mountpoint):d.isFalse(e.remoteOK)?b().info("volumeUUID(): remoteOK is false for "+e.mountpoint):yield l.thenMap(m.getOrSetAsync(w(),e.mountpoint,()=>r.thenOrTimeout(()=>S(e),t.VolumeUuidTimeoutMs)),t=>e.uuid=t)}))}(e))})}))},t.readVolumeUUID=S},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UUIDRegExp=t.mkuuid=void 0;const n=i(109),r=i(2);t.mkuuid=function(){const e=n.randomBytes(16);e[6]=15&e[6]|64;const t=e.toString("hex");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20)].join("-")},t.UUIDRegExp=r.lazy(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.orLoggedAsync=t.orLogged=void 0;const r=i(0),s=i(11);function o(e,t,i){const n=null==i?"warn":"debug";e.log(n,t,i)}t.orLogged=function(e,t,i){const n={};try{for(const t of e)for(const e of s.keys(t)){const i=t[e]();if(n[e]=r.orElse(i,!1),!0===i)return i}return!1}finally{o(i,t,n)}},t.orLoggedAsync=function(e,t,i){return n(this,void 0,void 0,(function*(){const n={};try{for(const t of e)for(const e of s.keys(t)){const i=yield t[e]();if(n[e]=i,i)return i}return!1}finally{o(i,t,n)}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SetSet=void 0;const n=i(54),r=i(0),s=i(16);t.SetSet=class{constructor(){this.store=new Map}add(e,t){n.getOrSet(this.store,e,()=>new Set).add(t)}delete(e,t){r.map(this.store.get(e),i=>{i.delete(t),0===i.size&&this.store.delete(e)})}find(e){return s.mapGte0(e.findIndex((t,i)=>{var n;return null===(n=this.store.get(t))||void 0===n?void 0:n.has(e[i+1])}),t=>e.slice(t,t+2))}has(e){return null!=this.find(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.seemsRecursive=void 0;const n=i(1),r=i(10);t.seemsRecursive=function(e,t=7){return n.compactBlanks(e).some(i=>n.count(e,e=>r.equalsIgnoreCase(i,e))>t)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.snaps=t.hasSnap=t.ignorableSnapDir=void 0;const r=i(4),s=i(2),o=i(15),a=i(126),u=i(21),l=i(83),c=i(6),d=i(14),h=i(30),f=c.mkLogger("Snap");t.ignorableSnapDir=a.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){if(!d.isLinux||!(yield t.hasSnap()))return!1;const i=h.pathnames(e.nativePath).indexOf("snap");return!(i<0)&&o.toA(yield t.snaps()).includes(h.pathnames[i+1])}))),t.hasSnap=s.lazy(()=>n(void 0,void 0,void 0,(function*(){try{return yield u.stdout("snap",["--version"],{timeout:10*r.secondMs}),!0}catch(e){return!1}}))),t.snaps=s.lazy(()=>n(void 0,void 0,void 0,(function*(){try{return yield l.parseFixed(["Name","Version"],yield u.stdout("snap",["list"],{timeout:10*r.secondMs})).map(e=>e.Name)}catch(e){return f.warn("snap failed",e),[]}})),30*r.secondMs)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.copyExampleImageToLibraryDir=t.libraryHealthChecks=void 0;const r=i(19),s=i(184),o=i(23),a=i(13),u=i(40),l=i(112),c=i(6),d=i(28),h=i(14),f=i(42),p=i(9),m=i(88),g=i(39),v=i(95),y=i(27),b=i(50),w=i(1),S=i(3),P=i(4),M=i(37),E=i(2),x=i(78),_=i(15),T=i(35),D=i(159),O=i(130),F=i(285),I=i(322),k=c.mkLogger("LibraryHealthChecks");function C(e){return n(this,void 0,void 0,(function*(){const t=_.toA(yield u.BaseFile.for(l.ProjectPath.Public()).join("images").children()).find(e=>e.name.startsWith("splash"));if(null==t)return k.throw("copyExampleImageToLibraryDir(): missing validation image");const i=e.join(".tmp-"+x.randomChars(6)),n=i.join("write-test"+t.ext);try{yield t.copyFile(n);const r=yield t.sha();if(r!==(yield n.sha()))return k.throw("Failed to copy sample file to library. Is "+e+" writable?");k.debug(`Library root directory, ${e}, is writable`)}finally{yield i.rmrf("debug")}}))}t.libraryHealthChecks=E.lazy(()=>function(){return n(this,void 0,void 0,(function*(){if(I.healthChecksArePaused())return{ok:["Library health checks are paused"]};if(!p.Settings.libraryPath.hasValue()&&!m.libraryHasSettings.refresh())return{ok:["Library isn't set up yet"]};const e=O.Library.instance();if(null==e)return m.libraryHasSettings.refresh()?{fail:["Missing library at "+p.Settings.libraryPath.value]}:{};if(e.isPendingSetup){e.ready.then(()=>t.libraryHealthChecks.unset());const i=Date.now()-e.start;return i<y.CmdTimeoutMs?{ok:["Library is setting up..."]}:i<3*P.minuteMs?{warn:["Library is taking a long time to set up..."]}:{fail:["Library took too long time to set up."]}}try{yield e.ready}catch(e){return{fail:["Library setup failed: "+o.errorToHumanString(e)]}}const i=[],a=[],u=[],l=[],c=e=>n(this,void 0,void 0,(function*(){try{return yield e()}catch(t){return l.push(t),k.warn("trap(): failed to run "+e.name+": "+M.errorToVerbose(t)),void u.push(o.errorToHumanString(t))}})),d=yield c(()=>v.volumes());if(w.isEmpty(d)&&u.push("Failed to scan system volumes."+o.FatalErrorFlag),yield c(()=>e.openedBy().throwIfUnavailable("(library health check)")),yield c(()=>g.exiftoolVersionMaybe()),yield c(()=>C(e.rootDir).catch(t=>{throw new b.WrappedError({cause:t,message:"Cannot write to "+e.rootDir,fatal:!0})})),h.isWin)try{const e=yield f.PowerShell.instance().version();S.blank(e)&&u.push("PowerShell isn't working (can't get version).")}catch(e){l.push(e),u.push(`PowerShell isn't working (${o.errorToHumanString(e)}).`)}for(const t of yield e.requiredFiles())try{const e=yield t.file();if(null==e)continue;if(e.clear(),t.isDir&&!(yield e.isDirectory()))u.push(`${t.desc}, ${e}, is missing`+o.FatalErrorFlag);else if(w.isNotEmpty(d)){const i=v.bestVolume(d,e.nativePath);k.debug("checkDir()",{dir:e.nativePath,desc:t.desc,bestVolume:i,vols:d.map(e=>e.mountpoint)}),null==i?u.push(`${t.desc}, ${e}, doesn't seem to have a mountpoint (?!)`):i.available<p.Settings.minDiskFreeGb.valueOrDefault*T.GB&&a.push(`Only ${T.fmtBytes(i.available)} are available on ${i.mountpoint}.`)}}catch(e){l.push(e),u.push("Failed to check "+t.desc+": "+o.errorToHumanString(e))}return w.isEmpty(u)&&w.isEmpty(a)&&i.push("Library and support directories are OK"),S.notBlank(r.env.TEST_FAIL)&&u.unshift(...r.env.TEST_FAIL.split(",")),S.notBlank(r.env.TEST_WARN)&&a.unshift(...r.env.TEST_WARN.split(",")),yield c(()=>F.Heartbeat.assertPing()),u.map(e=>o.onError(e+o.HealthCheckErrorFlag)),s.concatHealthChecks({ok:i,warn:a,bad:[],fail:u},D.syncSettingsCheck())}))}(),7*P.secondMs),p.Settings.libraryPath.addListener(()=>t.libraryHealthChecks.clear()),d.isTest||(a.onVolumesChanged(()=>t.libraryHealthChecks.refresh()),a.onSettingsChanged(()=>t.libraryHealthChecks.refresh()),a.onNonFatal(()=>t.libraryHealthChecks.clear())),t.copyExampleImageToLibraryDir=C},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ffmpegValidVideo=t.ffmpegTranscode=t.ffmpegFrame=t.isFFmpegSupported=t.checkFFmpegVersion=t.ffmpegVersionDescription=t.ffmpegVersion=void 0;const r=i(1),s=i(3),o=i(4),a=i(37),u=i(2),l=i(0),c=i(5),d=i(18),h=i(7),f=i(8),p=i(21),m=i(6),g=i(16),v=i(9),y=i(27),b=i(66),w=i(160),S=u.lazy(()=>m.mkLogger("ffmpeg")),P=u.lazy(()=>c.clamp(1,8,c.round(b.maxCpus()/2))),M=/ffmpeg version (\S+)/i;t.ffmpegVersion=u.lazy(()=>n(void 0,void 0,void 0,(function*(){var e;try{const t=yield p.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,["-version"],{timeout:y.CmdTimeoutMs,ignoreStderr:!0,isIgnorableError:()=>!0}),i=null===(e=M.exec(t.result))||void 0===e?void 0:e[1];return S().info("ffmpegVersion",{version:i,code:t.code,stdout:t.result.split("\n",1)[0]}),0===t.code&&s.notBlank(i)?i:void 0}catch(e){return}}))),t.ffmpegVersionDescription=u.lazy(()=>f.thenMapOr(t.ffmpegVersion(),e=>"version "+e,()=>"(not found)")),t.checkFFmpegVersion=function(){return n(this,void 0,void 0,(function*(){return f.thenOrElse(t.ffmpegVersion.prior(),()=>t.ffmpegVersion.refresh())}))},t.isFFmpegSupported=function(){return n(this,void 0,void 0,(function*(){return null!=(yield t.ffmpegVersion())}))};const E=/corrupt|invalid|error|failed|nothing\b.*\boutput|partial file|Cannot determine format of input stream.*after EOF/i;function x(e){return S().tap({msg:"isIgnorableError",meta:{err:e},result:null==a.errorToS(e).match(E)})}t.ffmpegFrame=function(e){var t;return n(this,void 0,void 0,(function*(){return(yield e.dest.exists())&&(yield e.dest.isEmpty())&&(yield e.dest.unlink()),p.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,r.compact(["-loglevel","error","-i",e.src.nativePath,...null!==(t=g.mapGte0f(e.startAtSec,e=>["-ss",e.toFixed(1)]))&&void 0!==t?t:[],"-vframes","1","-f","singlejpeg","-y",e.dest.nativePath]),{timeout:o.minuteMs,isIgnorableError:x})}))},t.ffmpegTranscode=function(e){return n(this,void 0,void 0,(function*(){const t=d.Opt(e.videoBitrateKbps).filter(c.gt0).map(e=>c.sigFigs(e,2)).map(e=>["-b:v",e+"k","-maxrate",e+"k","-bufsize",c.sigFigs(e/2,2)+"k"]).getOrElse(()=>[]);return p.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,["-loglevel","error","-threads",h.toS(P()),"-i",e.src.nativePath,"-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high",...t,"-c:a","aac",e.dest.nativePath],{timeout:e.timeoutMs,isIgnorableError:x})}))},t.ffmpegValidVideo=function(e){return n(this,void 0,void 0,(function*(){return S().tap({msg:"ffmpegValidVideo",meta:{src:e.nativePath},result:yield p.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",h.toS(P()),"-i",e.nativePath,"-f","null","-"],{timeout:l.orElse(yield w.syncFileTimeoutForFileMs(e),2*o.minuteMs),isIgnorableError:x,ignoreExitCode:!0,quiet:!1})})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.vlcTranscode=t.vlcFrame=t.vlcPath=t.isVlcSupported=t.checkVlcInfo=t.vlcInfo=t.vlcVersionDescription=void 0;const r=i(31),s=i(1),o=i(3),a=i(4),u=i(20),l=i(2),c=i(0),d=i(5),h=i(11),f=i(18),p=i(8),m=i(21),g=i(59),v=i(23),y=i(32),b=i(6),w=i(16),S=i(14),P=i(42),M=i(9),E=i(10),x=i(27),_=l.lazy(()=>b.mkLogger("vlc"));t.vlcVersionDescription=l.lazy(()=>p.thenMapOr(t.vlcInfo().catch(()=>{}),e=>"version "+e.version,()=>"(not found)"));const T=/VLC (?:version|media player) ([0-9.]+)/i,D=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"];function O(e){return n(this,void 0,void 0,(function*(){return p.thenMap(m.stdoutResult(e,[...D,"--version"],{timeout:x.CmdTimeoutMs,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),e=>f.Opt(e.result).filter(o.notBlank).map(e=>e.trim()).flatMap(e=>T.exec(e)).flatMap(e=>e[1]).get())}))}function F(e){return p.thenMap(P.PowerShell.instance().execute(`(Get-Item -path ${P.pwshQuote(e)}).VersionInfo.FileVersion`,e=>e).catch(t=>{_().warn("Failed to run vlcInfoWin: "+e+": "+t)}),e=>c.denull(e.trim()))}t.vlcInfo=l.lazy(()=>function(){return n(this,void 0,void 0,(function*(){const e=[];function t(...t){e.push(y.PosixFile.for(r.join(...t)))}if(S.isWin&&!M.Settings.vlcPath.hasValue()||e.push(M.Settings.vlcPath.valueOrDefault),S.isMac){const e="/Applications/VLC.app/Contents/MacOS/VLC";o.mapNotBlank(g.getEnv("HOME"),i=>t(i+e)),t(e)}if(S.isWin){const e=["VideoLAN","VLC","vlc.exe"];o.mapNotBlank(g.getEnv("LOCALAPPDATA"),i=>{t(i,"Apps",...e)}),o.mapNotBlank(g.getEnv("ProgramFiles"),i=>{t(i,...e)}),o.mapNotBlank(g.getEnv("ProgramFiles(x86)"),i=>{t(i,...e)})}for(const t of e)try{if(t instanceof y.PosixFile&&(yield t.clear().notExists()))continue;const e=t.toString(),i=yield S.isWin?F(e):O(e);if(o.blank(i)){_().info("vlcInfo(): no VLC version found for "+t);continue}return h.tap({path:e,version:i},e=>_().info("vlcInfo()",e))}catch(e){_().warn("vlcInfo(): err:"+e,{path:t})}}))}()),t.checkVlcInfo=function(){return n(this,void 0,void 0,(function*(){const e=yield t.vlcInfo.prior();return null!=(null==e?void 0:e.version)?e:yield t.vlcInfo.refresh()}))},t.isVlcSupported=function(){return n(this,void 0,void 0,(function*(){return!S.isArm&&(yield p.thenMapOr(t.vlcInfo(),e=>null!=e.version,()=>!1))}))},t.vlcPath=l.lazy(()=>p.thenMap(t.vlcInfo(),e=>null==e.version?void 0:e.path)),t.vlcFrame=function(e){var i;return n(this,void 0,void 0,(function*(){const n=yield t.vlcPath();if(o.blank(n))throw new Error(e.src+" is not supported (no vlc)");const r=E.stripPrefix(e.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(r))return _().throw("vlcFrame(): Invalid destination extension"+v.NonRetriableErrorFlag,{format:r,args:e});const l=null!==(i=e.startAtSec)&&void 0!==i?i:0,c=l+1,h=yield m.stdoutResult(n,s.compact([...D,"--avcodec-hw=none","--video-filter=scene","--scene-format="+r,"--scene-replace","--scene-ratio=500","--scene-path="+e.dest.dir,"--scene-prefix="+e.dest.name,"--start-time="+l.toFixed(1),"--stop-time="+c.toFixed(1),e.src.nativePath,"vlc://quit"]),{timeout:a.minuteMs,ignoreStderr:!0});if(e.dest.clear(),d.gt0(h.code))throw new Error("vlc failed: "+u.stringify(h));return h}))},t.vlcTranscode=function(e){return n(this,void 0,void 0,(function*(){const i=yield t.vlcPath();if(o.blank(i))throw new Error("vlc.transcode(): VLC is not installed, cannot transcode "+e.src);const n=s.compact(["vcodec=h264",w.mapGt0(e.videoBitrateKbps,e=>"vb="+e),w.mapGt0(e.width,e=>"width="+Math.floor(e)),w.mapGt0(e.height,e=>"height="+Math.floor(e)),"venc=x264{ref=2:me=hex:mixed_ref=0:chroma_qp_offset=0:b_adapt=1:direct=1:weightp=1:rc_lookahead=20}","acodec=mp4a","ab=128","channels=2","samplerate=44100","scodec=none","deinterlace"]).join(","),r=["access=file{overwrite}","mux=mp4","dst="+e.dest.base].join(",");return m.stdoutResult(i,[...D,"--no-repeat","--no-loop",e.src.fileuri(),`--sout=#transcode{${n}}:standard{${r}}`,"vlc://quit"],{cwd:e.dest.dir,timeout:e.timeoutMs,ignoreStderr:!0})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mkDownloadableTitle=t.previewToDownloadable=t.extractPreviewInfo=void 0;const r=i(173),s=i(85),o=i(96),a=i(0),u=i(5),l=i(8),c=i(30),d=i(6),h=i(16),f=i(10),p=i(113),m=d.mkLogger("extractPreviewInfo");function g(e,t,i,n){return`Download ${t} ${e.ext} ${i} (${s.dimToS(n)})`}t.extractPreviewInfo=function(e,t){const i=t.posixPathFrom(e).replace(/\//g,"").split("-"),n=u.toInt(i[0]),r=i[1],s=o.ReducerNames.validOrElse(r,void 0),a=h.extractInt(i[2]);return u.gt0(n)?{file:t,assetId:n,reducer:s,width:a}:void m.warn("Failed to extract preview info",{file:t,previewsRoot:e,arr:i,assetId:n,reducer:s,width:a})},t.previewToDownloadable=function(e,t){return n(this,void 0,void 0,(function*(){return a.map2(t.assetId,t.width,(i,n)=>l.thenMap(p.dimensions(t.file),a=>{const u=s.dimToSize(a);return{size:u,basename:`${f.stripSuffix(e,c.extname2(e))}-${u}${t.file.ext}`,title:g(t.file,u,"image",a),description:"Download "+u,details:`(${s.dimToS(a)} ${t.file.ext})`,href:new r.AssetUrls(i).imgLink(o.ReducerNames.fit,n)}}))}))},t.mkDownloadableTitle=g},function(e,t){e.exports=require("net")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uid=void 0;const n=i(49),r=i(19),s=i(2),o=i(70),a=i(57);let u=0;const l=s.lazy(()=>o.shortStringSha(n.hostname()+r.pid)+"-");t.uid=function(){return l()+a.GeoRadix.encode(++u)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.OpenedByIO=t.currentLibraryLockOwner=t.expectedJson=t.isLockOwner=t.openedByFiles=t.StaleMs=void 0;const r=i(64),s=i(49),o=i(19),a=i(12),u=i(17),l=i(81),c=i(8),d=i(63),h=i(45),f=i(23),p=i(13),m=i(70),g=i(195),v=i(6),y=i(166),b=i(29),w=i(91),S=i(27),P=i(1),M=i(4),E=i(2),x=i(0),_=i(78);function T(e){return x.map(function(e){return x.map(e,e=>e.join("opened-by"))}(e),e=>e.children(e=>n(this,void 0,void 0,(function*(){return".json"===e.ext&&(yield e.isFile())}))))}t.StaleMs=M.hourMs,t.openedByFiles=T,t.isLockOwner=function(){return n(this,void 0,void 0,(function*(){return x.mapOr(w.libraryDataDir(),e=>n(this,void 0,void 0,(function*(){return h.eqlAsyncPicked(t.currentLibraryLockOwner(e),t.expectedJson(),"systemUID","pid")})),()=>n(this,void 0,void 0,(function*(){return!1})))}))},t.expectedJson=E.lazy(()=>n(void 0,void 0,void 0,(function*(){return{systemUID:yield g.systemUID(),pid:o.pid}}))),t.currentLibraryLockOwner=l.memoize(e=>n(void 0,void 0,void 0,(function*(){const i=!b.isSyncFileService(),r=v.mkLogger("currentLibraryLockOwner("+e+")"),s=yield g.systemUID(),o=yield T(e);if(P.isEmpty(o))return void r.warn("no opened-by files found.");const u=yield c.thenCompact(o.map(e=>n(void 0,void 0,void 0,(function*(){const t=yield e.readJSON();return i&&null==t&&!0!==(yield e.modifiedCloseTo(Date.now(),S.CmdTimeoutMs))?(r.warn("unlinking old empty json file: "+e),void(yield e.unlink("debug"))):Object.assign({file:e},t)})))),l=Date.now()-t.StaleMs,[d,h]=a.partition(u,e=>e.updatedAt>l);i&&P.isNotEmpty(h)&&(r.debug("Unlinking expired opened-by files:",{minUpdatedAt:l,staleJsons:h}),yield Promise.all(h.map(e=>{var t;return null===(t=e.file)||void 0===t?void 0:t.unlink("debug")})));const[f,p]=a.partition(d,e=>e.systemUID===s),m=f.map(e=>e.pid),w=x.orElse(yield y.existingPids(m),m),[M,E]=a.partition(f,e=>w.includes(e.pid));i&&P.isNotEmpty(E)&&(r.debug("Unlinking zombie opened-by files:",E),yield Promise.all(E.map(e=>{var t;return null===(t=e.file)||void 0===t?void 0:t.unlink()})));const _=[...M,...p];if(P.isEmpty(_))return void r.debug("No valid opened-by files.");const D=a.leastBy(_,e=>e.createdAt),O=_.filter(e=>e.systemUID===D.systemUID),F=a.leastBy(O,e=>[b.serviceNameIndex(e.serviceName),x.orElse(e.createdAt,()=>Date.now())]);return r.tap({msg:"currentLibraryLockOwner",level:"info",result:F})})),_.randomInt(7*M.secondMs,S.CmdTimeoutMs),3),p.onClearCache(()=>t.currentLibraryLockOwner.clear());class D extends u.EndableWrapper{constructor(e){super("OpenedByIO()",()=>this.onEnd(),u.EndableRanks.postdb),this.ldd=e,this.createdAt=Date.now(),this.watchers=[],this.intervalMs=t.StaleMs/4,this.file=E.lazy(()=>this.dir.join(m.shortFsStringSha(s.hostname(),7)+"-"+o.pid+".json")),this.json=E.lazy(()=>n(this,void 0,void 0,(function*(){return Object.assign({hostname:s.hostname(),serviceName:b.serviceName(),createdAt:this.createdAt,updatedAt:Date.now()},yield t.expectedJson())})),this.intervalMs/2),this.write=E.lazy(()=>n(this,void 0,void 0,(function*(){const e=yield this.json();return this.logger.tap({level:"info",msg:"write()",result:null!==(yield this.file().writeJsonMaybe(yield this.json())),meta:{file:this.file().nativePath,json:e}})})),this.intervalMs/2),this.setup=E.lazy(()=>n(this,void 0,void 0,(function*(){yield this.write(),yield this.watchers.push(...this.file().selfAndParents(4).map(e=>r.watch(e.nativePath,{persistent:!1,recursive:!1},()=>n(this,void 0,void 0,(function*(){u.ending()||(yield this.lockOwner.refresh())})))))}))),this.lockOwner=E.lazy(()=>n(this,void 0,void 0,(function*(){return yield this.setup(),t.currentLibraryLockOwner(this.ldd)})),7*M.secondMs),this.dir=e.join("opened-by"),this.timer=d.setUnrefInterval(()=>this.write(),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write.unset()}refresh(){return this.clear(),this.write()}onEnd(){return n(this,void 0,void 0,(function*(){this.watchers.forEach(e=>e.close()),this.watchers.length=0,x.map(this.timer,clearInterval),this.timer=void 0,yield this.file().unlink()}))}deleteAllLocks(e=!1){return n(this,void 0,void 0,(function*(){e?yield this.dir.rmrf():yield this.dir.visitDescendants(e=>e.eql(this.file())?void 0:e.unlink())}))}isLockOwner(){return n(this,void 0,void 0,(function*(){return h.eqlAsyncPicked(this.lockOwner(),t.expectedJson(),"systemUID","pid")}))}throwIfUnavailable(e){return n(this,void 0,void 0,(function*(){const t=yield this.lockOwner();if(null==t)return;const i=yield this.json(),n=i.systemUID;if(null!=t&&t.systemUID!==n)throw this.logger.warn("library is unavailable",{lockOwner:t,json:i}),new Error(`Library is already opened by ${t.hostname} (${t.serviceName}:${t.pid}) ${e}`+(b.isWebService()?"":f.FatalErrorFlag)+f.DoNotSendErrorFlag+f.NonRetriableErrorFlag)}))}}t.OpenedByIO=D},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toJSON=t.assignFromJSON=t.fromJSON=t.addModelClass=void 0;const n=i(22),r=i(6),s=i(10),o=i(1),a=i(3),u=i(11),l=i(18),c=new Map;function d(e){c.set(e.$ctor,e)}t.addModelClass=d;const h=([e,t])=>null!=e&&null!=t;function f(e,t,i=[]){const r=e.class();return u.keys(t).filter(e=>"$ctor"!==e).filter(e=>null!=t[e]).map(e=>{const a=t[e];return i.forEach(t=>e=s.stripPrefix(e,t)),o.includes(r.booleanFields,e)?[e,n.isTrue(a)]:[e,a]}).filter(h).forEach(([t,i])=>e[t]=i),e}t.fromJSON=function(e,t){if(null==t)throw new Error("json is null");if(null!=e&&a.notBlank(e.$ctor)&&!c.has(e.$ctor)&&d(e),t instanceof e)return t;const i=l.Opt(t.$ctor).flatMap(e=>c.get(e)).getOrElse(()=>e);if(t instanceof i)return t;const n=new i;return null==t?n:f(n,t,o.uniq([e.tableName+".",i.tableName+"."]))},t.assignFromJSON=f,t.toJSON=function e(t,i,n){if(null!=t)return Array.isArray(t)?t.map((t,r)=>e(t,i,`${n}[${r}]`)):"function"==typeof t.toJSON?t.toJSON():void r.mkLogger("ModelJSON.toJSON()").warn("Failed",{m:t,key:n,mc:i.$ctor})}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ModelOpsLocal=t.MaxBatchSize=void 0;const r=i(12),s=i(8),o=i(6),a=i(1),u=i(20),l=i(2),c=i(0),d=i(5),h=i(11),f=i(25),p=i(15),m=i(229),g=i(153),v=i(231),y=i(230),b=i(150);t.MaxBatchSize=99;class w{constructor(e,t){this.model=e,this.db=t,this.dbr=l.lazy(()=>new m.DbRequestLocal(this.db)),this.columnNames=l.lazy(()=>g.handleDbRetriesSync(()=>this.db().pragma(`table_info(${this.tableName})`).map(e=>e.name))),this.logger=o.mkLogger(`ModelOpsLocal(${e.tableName})`)}static forTableName(e){return this.instances.get(e)}static forModel(e,t){const i=e,n=new w(i,t);return this.instances.set(i.tableName,n),n}get dbOpen(){return c.mapOr(this.db(),e=>e.open,()=>!1)}get tableName(){return this.model.tableName}query(){return this.model.query()}toDbValued(e){const t=this.model.fromJSON(e),i=v.toDbValued(t);return h.pick(i,...this.columnNames())}exec(e){return this.dbr().exec(e)}run(e){return this.dbr().run(e)}fromJSON(e){return f.thenMap(e,e=>this.model.fromJSON(e))}fromJSONs(e){return n(this,void 0,void 0,(function*(){return(yield s.thenCompact(e)).map(e=>this.model.fromJSON(e))}))}first(e){return this.fromJSON(this.dbr().first(e))}all(e=this.query()){return this.fromJSONs(this.dbr().all(y.maybeLimit(e)))}allf(e){return this.all(e(this.query()))}findOne(e){return this.fromJSON(this.dbr().first(e.first()))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e){return this.findOneBy({id:e})}findByIds(e){return n(this,void 0,void 0,(function*(){const i=yield b.tx(this.db(),()=>n(this,void 0,void 0,(function*(){return f.thenCollect(r.batches(p.toA(e).filter(d.gt0),t.MaxBatchSize),e=>this.dbr().all(this.query().whereIn("id",e)))})));return a.sortBy(yield this.fromJSONs(a.flatten(i)),t=>e.indexOf(t.id))}))}findBy(e){return this.all(this.model.queryBy(e))}rows(){return this.count(this.model.query())}count(e){return s.thenOrElse(this.dbr().pluckFirst(e),()=>0)}insert(e){return n(this,void 0,void 0,(function*(){return b.tx(this.model.db(),()=>f.thenCollect(e,e=>this.insertOne(e)))}))}insertOne(e){return n(this,void 0,void 0,(function*(){const t=this.model.fromJSON(e);if(null!=t.id)throw new Error("insert called for "+u.stringify(e));t.$beforeUpsert();const i=t.$toDbJSON(this.columnNames()),n=yield this.run(this.model.query().insert(i));return yield this.findById(d.toInt(n.lastInsertRowid))}))}upsertOne(e){return n(this,void 0,void 0,(function*(){return(yield this.upsert([e]))[0]}))}get ucn(){return this.model.uniqueColumnName}get ucnConstraint(){return`(${this.ucn})`}upsert(e){return n(this,void 0,void 0,(function*(){const t=yield this.columnNames();return f.thenCollect(p.toA(e),e=>n(this,void 0,void 0,(function*(){const i=this.model.fromJSON(e);i.$beforeUpsert();const n=i.$toDbJSON(t);if(d.gt0(n.id)){const e=yield this.run(this.query().where({id:n.id}).update(n));return this.logger.debug("upsert(): update",{result:e,json:n}),i}if("id"===this.ucn){const e=yield this.run(this.query().insert(n));if(null==e||!d.gt0(e.lastInsertRowid))throw new Error("failed to insert "+u.stringify(n));return i.id=e.lastInsertRowid,i}{const e=this.query().insert(n).toSQL(),t=h.keys(n).filter(e=>"createdAt"!==e).map(e=>`${e}=excluded.${e}`).join(","),i={sql:`${e.sql} ON CONFLICT ${this.ucnConstraint} DO UPDATE SET ${t}`,bindings:e.bindings};return yield this.run(i),this.findOneBy(h.fromEntries(this.ucn.split(",").map(e=>[e,n[e]])))}})))}))}delete(e){return n(this,void 0,void 0,(function*(){return a.mapNotEmpty(e.filter(d.gt0),e=>this.run(this.model.query().delete().whereIn("id",e)))}))}}t.ModelOpsLocal=w,w.instances=new Map},function(e,t){e.exports=require("better-sqlite3")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QueueItem=void 0;const n=i(219);class r extends n.StatsModel{}t.QueueItem=r,r.tableName="QueueItem",r.uniqueColumnName="queueId,contents"},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.posixLocale=t.macLocale=t.winLocale=t.lc2locale=t.locale=t.defaultLocale=void 0;const r=i(19),s=i(1),o=i(3),a=i(4),u=i(2),l=i(0),c=i(11),d=i(68),h=i(62),f=i(8),p=i(21),m=i(14),g=i(42),v=i(10);function y(e=r.env){return l.firstDefined(e.LC_ALL,e.LC_MESSAGES,e.LANG,e.LANGUAGE)}t.defaultLocale="en",t.locale=u.lazy(()=>n(void 0,void 0,void 0,(function*(){return w(yield h.firstDefinedLater(()=>y(),()=>m.isWin?S():void 0,()=>m.isMac?M():void 0,()=>m.isPosix?x():void 0))})));const b=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function w(e){if(o.blank(e)||v.equalsIgnoreCase("c",e)||v.equalsIgnoreCase("posix",e))return t.defaultLocale;{const i=b.exec(e);return null==i?t.defaultLocale:s.compact([i[1],i[2]]).join("-")}}function S(){return f.thenMap(g.PowerShell.instance().executeJson("GET-WinSystemLocale | Select-Object -Property Name"),e=>e.Name)}t.lc2locale=w,t.winLocale=S;const P={timeout:10*a.secondMs};function M(){return d.thenOpt(p.stdout("defaults",["read","-globalDomain","AppleLocale"],P)).flatMap(w).get()}t.macLocale=M;const E=/^([a-z_]+)\s*=\s*"(.+)"$/i;function x(){return d.thenOpt(p.stdout("locale",[],P)).flatMap(e=>e.split("\n").map(e=>l.map(e.match(E),e=>[e[1],e[2]]))).flatMap(c.fromEntries).flatMap(y).flatMap(w).get()}t.posixLocale=x},function(e,t){e.exports=require("@sentry/node")},,function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.excludeDirnameFilter=t.fileExtFilter=t.onlyDirectories=t.extless=t.expensiveFileFilter=t.expensiveFileFilters=t.cheapFileFilter=t.noStatFileFilter=t.fileSizeFilter=t.notHiddenCheap=t.exifExtFilter=t.supportedMimeTypeFilter=t.videoFilter=t.imageFilter=t.hasBrowserImgMimetype=t.notRejected=t.hasMakeAndModel=t.hasMimeType=t.minDimensionsFilter=t.requiredTagsFilter=t.onlyReadable=t.onlyFiles=void 0;const r=i(1),s=i(3),o=i(2),a=i(5),u=i(7),l=i(12),c=i(126),d=i(8),h=i(178),f=i(82),p=i(6),m=i(16),g=i(9),v=i(39),y=i(48),b=i(226),w=i(171);function S(e){return c.AsyncFilter.lift(t=>n(this,void 0,void 0,(function*(){return d.thenMapOr(v.readRawTags(t,!1),e,()=>!1)})))}function P(e){return S(t=>l.allNotBlank(...e.map(e=>t[e])))}t.onlyFiles=c.AsyncFilter.lift(e=>e.isFile()),t.onlyReadable=c.AsyncFilter.lift(e=>e.isReadable()),t.requiredTagsFilter=P,t.minDimensionsFilter=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){const t=yield v.mimetype(e);if(null==t||!t.startsWith("image/")&&!t.startsWith("video/"))return!1;const i=t.startsWith("video/")?g.Settings.minVideoDimension.valueOrDefault:g.Settings.minImageDimension.valueOrDefault;return d.thenMapOr(v.sizeInfo(e),e=>a.gte(e.ImageWidth,i)&&a.gte(e.ImageHeight,i),()=>!1)}))),t.hasMimeType=P(["MIMEType"]),t.hasMakeAndModel=P(["Make","Model"]),t.notRejected=S(e=>a.toInt(e.Rating,{defaultValue:0})>=0),t.hasBrowserImgMimetype=S(e=>r.includes(["image/jpeg","image/png"],u.toS(e.MIMEType))),t.imageFilter=S(e=>u.toS(e.MIMEType).startsWith("image/")),t.videoFilter=S(e=>u.toS(e.MIMEType).startsWith("video/"));const M=t.imageFilter.and(t.hasMakeAndModel).or(t.videoFilter),E=o.lazy(()=>new Set([...y.sharpSupportedMimeTypes(),...h.dcrawSupportedMimeTypes]));function x(e){return!s.blank(e)&&(f.isVideoMimeType(e)||E().has(e.toLowerCase()))}t.supportedMimeTypeFilter=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return d.thenMapOr(v.mimetype(e.nativePath),x,()=>!1)}))),t.exifExtFilter=b.extFilter(y.AssetFileExts),t.notHiddenCheap=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return!w.ignorablePath(e.nativePath)}))),t.fileSizeFilter=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return d.thenMapOr(e.size(),e=>m.within(g.Settings.minAssetSizeBytes.valueOrDefault,g.Settings.maxFileSizeBytes.valueOrDefault,e),()=>!1)}))),t.noStatFileFilter=c.AsyncFilter.andLogged(p.mkLogger("noStatFileFilter"),{exifExtFilter:t.exifExtFilter},{notHiddenCheap:t.notHiddenCheap}),t.cheapFileFilter=c.AsyncFilter.andLogged(p.mkLogger("cheapFileFilter"),{exifExtFilter:t.exifExtFilter},{notHiddenCheap:t.notHiddenCheap},{fileSizeFilter:t.fileSizeFilter}),t.expensiveFileFilters=o.lazy(()=>r.compact([{exifExtFilter:t.exifExtFilter},{fileSizeFilter:t.fileSizeFilter},{notHiddenCheap:t.notHiddenCheap},{hasMimeType:t.hasMimeType},{supportedMimeTypeFilter:t.supportedMimeTypeFilter},g.Settings.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:M}:void 0,{notRejected:t.notRejected},{minDimensionsFilter:t.minDimensionsFilter}])),t.expensiveFileFilter=o.lazy(()=>c.AsyncFilter.andLogged(p.mkLogger("expensiveFileFilter"),...t.expensiveFileFilters())),t.extless=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return s.blank(e.ext)}))),t.onlyDirectories=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return e.isDirectory()}))),t.fileExtFilter=function(e){return c.AsyncFilter.and(b.extFilter(e),t.onlyFiles)},t.excludeDirnameFilter=function(e){return c.AsyncFilter.and(b.excludedPathFilter(e),t.onlyDirectories)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sentryEnabled=void 0;const n=i(59),r=i(28),s=i(14),o=i(9),a=i(2);t.sentryEnabled=a.lazy(()=>n.isEnvTrue("ENABLE_SENTRY")||r.isProd&&s.isPacked&&o.Settings.reportErrors.valueOrDefault),o.Settings.reportErrors.addListener(()=>t.sentryEnabled.clear())},function(e,t){e.exports=require("source-map-support")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommonArgs=void 0;const n=i(22),r=i(9),s=i(275);t.CommonArgs={beforeParse:e=>e.option("--verbose","Verbose logging mode for all current processes; equals --info --tail").option("--tail","Emit log messages from both this process and all other concurrently running PhotoStructure processes on this host to stdout. This can be really helpful in seeing how PhotoStructure's processes are coordinating work. Caution: very noisy especially during imports. Sets PS_TAIL_LOGS to true. Ignored if daemonized.").option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--info",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.'),afterParse:e=>{if(n.isTrue(e.elapsed)&&(r.Settings.logElapsedMs.tmpValue=e.elapsed),s.isDaemon(e))r.Settings.logStdout.tmpValue=!1,r.Settings.tailLogs.tmpValue=!1;else{const t=n.isTrue(e.verbose),i=n.isTrue(e.debug),s=n.isTrue(e.info)||t,o=n.isTrue(e.warn),a=n.isTrue(e.tail)||t;o&&(r.Settings.logLevel.tmpValue="warn"),s&&(r.Settings.logLevel.tmpValue="info"),i&&(r.Settings.logLevel.tmpValue="debug"),(i||s||o)&&(r.Settings.logStdout.tmpValue=!0),a&&(r.Settings.tailLogs.tmpValue=!0)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDaemon=void 0;const n=i(19),r=i(22),s=i(3);t.isDaemon=function(e){return r.isTrue(n.env.__is_daemon)||r.isTrue(null==e?void 0:e.daemon)||!s.blank(null==e?void 0:e.pidfile)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.validFile=t.isValidFile=void 0;const r=i(72),s=i(4),o=i(2),a=i(18),u=i(8),l=i(55),c=i(13),d=i(32),h=i(223),f=i(6),p=i(9),m=i(39),g=i(50),v=i(225),y=i(134),b=i(118),w=i(82),S=o.lazy(()=>f.mkLogger("ValidFile")),P=new l.BoundedMap(10*s.minuteMs,1024,!0);function M(e){return n(this,void 0,void 0,(function*(){if(p.Settings.validateJpegImages.valueOrDefault||p.Settings.validateVideos.valueOrDefault)return h.getOrSetByNativePath(e,E,P);S().debug("no validation for "+e,{validateJpegImages:p.Settings.validateJpegImages.valueOrDefault,validateVideos:p.Settings.validateVideos.valueOrDefault})}))}function E(e){return n(this,void 0,void 0,(function*(){const t=d.PosixFile.for(e);try{const e=yield m.mimetype(t);if(null==e)throw new Error("Cannot validate, no mimetype");if(w.isVideoMimeType(e))p.Settings.validateVideos.valueOrDefault&&(S().debug("validating "+t),yield b.validVideo(t,e));else{if(!e.startsWith("image/"))throw new Error("Unsupported mimetype, "+e);if("image/jpeg"===e){if(p.Settings.validateJpegImages.valueOrDefault)return yield v.validJpeg(t)}else if(p.Settings.validateRawImages.valueOrDefault){const e=yield y.sharpReadable(t);if(null==e)throw new Error("Cannot read");yield r(e.nativePath,{failOnError:!0}).tiff().toBuffer()}}}catch(e){throw new g.WrappedError({cause:e,message:"invalid file "+t,retriable:!1,ignorable:!0})}}))}c.onClearCache(()=>P.clear()),c.onFileChanged(e=>a.Opt(e).forEach(e=>{P.delete(e)}).orElse(()=>{P.clear()})),t.isValidFile=function(e){return n(this,void 0,void 0,(function*(){return u.resolved(M(e))}))},t.validFile=M},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.posixPathFromUri=t.uriFromLibraryPath=t.installLibraryUriSupport=void 0;const n=i(147),r=i(30),s=i(32),o=i(9),a=i(3),u=i(2),l=i(7),c=i(87);t.installLibraryUriSupport=u.lazy(()=>{n.addUriParser(f),n.addUriFormatter(h)});const d=()=>a.mapNotBlank(o.Settings.libraryPath.value,e=>s.PosixFile.for(e));function h(e){if(a.blank(e.posixPath))return;const t=d();if(null==t)return;const i=s.PosixFile.for(r.posix2native(e.posixPath));return i.isDescendantOf(t)?{pathname:encodeURI(i.posixPathFrom(t)),protocol:c.PS_LIBRARY_PROTOCOL,slashes:!0}:void 0}function f(e){if(null==e||l.toS(e.protocol).toLowerCase()!==c.PS_LIBRARY_PROTOCOL)return;const t=d();return null!=t?a.mapNotBlankOr(e.pathname,e=>t.join(decodeURIComponent(e)),()=>t):void 0}t.uriFromLibraryPath=h,t.posixPathFromUri=f},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Db=void 0;const r=i(266),s=i(17),o=i(22),a=i(40),u=i(112),l=i(91),c=i(9),d=i(4),h=i(2),f=i(0),p=i(174),m=i(333),g=i(153),v=i(334),y=i(218),b=i(162);class w extends s.EndableWrapper{constructor(e,t){super("Db("+e+")",()=>this.closeDb(),s.EndableRanks.db),this.schema=e,this._dataDir=t,this.endTimeoutMs=d.minuteMs,this.closeListeners=[],this.migrate=h.lazy(()=>n(this,void 0,void 0,(function*(){const e=this.dbfile,t=this.db;if(null==t||null==e)throw new Error("Cannot migrate database: missing db");const i=h.lazy(()=>n(this,void 0,void 0,(function*(){return y.makeVersionBackup(e)}))),r=new v.Migration(a.BaseFile.for(u.ProjectPath.Migrations()).join(this.schema),t,e);return{appliedMigrations:yield r.apply(i),migration:r}})))}addCloseListener(e){this.closeListeners.push(e)}get datadir(){return f.orElse(this._dataDir,l.libraryDataDir())}get dbfile(){return f.map(this.datadir,e=>p.pathToDb(e,this.schema))}get open(){return null!=this._db&&this._db.open}get inTransaction(){return null!=this._db&&this._db.inTransaction}prepare(e){return this.db.prepare(e)}pragma(e,t){return this.db.pragma(e,t)}get priorWasClosed(){var e;return o.isFalse(null===(e=this._db)||void 0===e?void 0:e.open)}get db(){const e=this.priorWasClosed,t=null==this._db;return(t||e)&&f.map(this.dbfile,i=>{this.logger.info("setting up new db connection to "+i,{priorWasNull:t,priorWasClosed:e}),this._db=m.setPragmas(new r(i.nativePath,{fileMustExist:!1,readonly:!1,timeout:c.Settings.dbTimeoutMs.valueOrDefault}))}),this._db}setup(){return n(this,void 0,void 0,(function*(){yield f.map(this.dbfile,e=>n(this,void 0,void 0,(function*(){return e.parent().mkdirp()})))}))}closeDb(){this.closeListeners.forEach(e=>e()),f.map(this._db,e=>{e.open&&(this.logger.warn("closing db "+e.name),e.close())}),this._db=void 0}reopenDb(){return n(this,void 0,void 0,(function*(){return this.closeDb(),yield this.setup(),this.db}))}vacuum(){return n(this,void 0,void 0,(function*(){return"models"===this.schema?b.withVacuumEvent(()=>this._vacuum()):this._vacuum()}))}_vacuum(){var e,t;return n(this,void 0,void 0,(function*(){this.logger.info("_vacuum() started for "+(null===(e=this.db)||void 0===e?void 0:e.name)),yield f.map(this.db,m.optimizeDb),yield g.handleDbRetries(()=>f.map(this.db,e=>e.exec("VACUUM"))),this.logger.info("_vacuum() completed for "+(null===(t=this.db)||void 0===t?void 0:t.name))}))}}t.Db=w},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.b64diff=t.b64corr=t.uint12toB64=t.uint6toB64=t.uint8toB64=t.b64decodeSmall=t.b64hammRatio=t.b64decode=t.b64encode=t.b64charset=t.hex2b64=void 0;const n=i(1),r=i(3),s=i(0),o=i(5),a=i(12),u=i(16),l=i(52);function c(e){return"number"==typeof e&&e<t.b64charset.length?t.b64charset[e]:Buffer.from(e.toString(16),"hex").toString("base64")}function d(e){return BigInt("0x0"+Buffer.from(e,"base64").toString("hex"))}function h(e){if(null==e||0===e.length)return-1;const i=e.split("");let n=0;for(const r of i){const i=t.b64charset.indexOf(r);if(-1===i)return-1;if(n>Math.pow(2,46))throw new Error("b64decodeSmall("+e+"): overflow");n=64*n+i}return n}function f(e,t=6){const i=t/6;return n.stepRange(0,e.length,i,t=>h(e.substr(t,i)))}t.hex2b64=function(e){return Buffer.from(e,"hex").toString("base64")},t.b64charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t.b64encode=c,t.b64decode=d,t.b64hammRatio=function(e,t){return r.mapNotBlank(e,e=>r.mapNotBlank(t,t=>u.hammRatioBigInt(d(e),d(t))))},t.b64decodeSmall=h,t.uint8toB64=function(e){return Buffer.from(Uint8ClampedArray.from(e).buffer).toString("base64")},t.uint6toB64=function(e){return e.map(e=>t.b64charset[63&e]).join("")},t.uint12toB64=function(e){const t=[];return e.forEach(e=>{t.push(c(e>>6&63)),t.push(c(63&e))}),t.join("")},t.b64corr=function(e,t,i=6){if(e===t)return 1;const n=f(e,i),r=f(t,i),s=Math.pow(2,i-1);return l.cosineSimilarity(n.map(e=>e-s),r.map(e=>e-s))},t.b64diff=function(e,t,i=6){return e===t?0:a.zip(f(e,i),f(t,i)).reduce((e,t)=>s.orElse(o.absdiff(t[0],t[1]),0)+e,0)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.unlinkJournalFiles=t.isDbOpen=t.sqliteFiles=void 0;const r=i(8),s=i(26),o=i(4),a=i(336);t.sqliteFiles=function(e){return r.asyncFilter([e,...a.SqliteSuffixes.map(t=>e.sibling(e.base+t))],e=>e.exists())};const u=["-wal","-journal"];t.isDbOpen=function(e,t=2*o.minuteMs){return n(this,void 0,void 0,(function*(){const i=i=>n(this,void 0,void 0,(function*(){return r.thenMapOr(e.sibling(e.base+i).clear().maxStatMs(),e=>s.isRecentMs(e,t),()=>!1)}));return(yield e.clear().isNonEmptyFile())&&((yield i("-wal"))||(yield i("-journal")))}))},t.unlinkJournalFiles=function(e){return n(this,void 0,void 0,(function*(){yield u.map(t=>e.sibling(e.base+t).unlink("info"))}))}},function(e,t,i){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.setStatsDb=t.statsDb=void 0,t.statsDb=function(){return n},t.setStatsDb=function(e){n=e}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dateTagFile=t.dateTag=t.dayTagRef=t.monthTagRef=t.yearTagRef=t.dayToOrdinal=t.monthToOrdinal=t.yearToOrdinal=void 0;const r=i(51),s=i(268),o=i(16),a=i(9),u=i(135),l=i(39),c=i(1),d=i(2),h=i(0),f=i(68),p=i(7),m=i(115),g=d.lazy(()=>n(void 0,void 0,void 0,(function*(){return new Intl.DateTimeFormat(yield s.locale(),{month:"short"})}))),v=d.lazy(()=>n(void 0,void 0,void 0,(function*(){const e=yield g();return c.range(0,12,t=>e.format(new Date(2016,t)))})));function y(e){return 1e4-e}function b(e){return 13-e}function w(e){return 33-e}function S(e){return o.mapGt0(e,e=>({name:p.toS(e),ordinal:y(e)}))}function P(e){return n(this,void 0,void 0,(function*(){if(o.within(1,12,e))return h.map((yield v())[e-1],t=>({name:t,ordinal:b(e)}))}))}function M(e){return o.mapGt0(e,e=>({name:p.toS(e),ordinal:w(e)}))}function E(e){return n(this,void 0,void 0,(function*(){const t=p.toS(a.Settings.tagDate.valueOrDefault).toLowerCase();if(""===t)return;const i=[m.When];if(t.startsWith("y")){const t=h.map(r.getYear(e),S);if(null==t)return;i.push(t)}if(t.startsWith("ym")){const t=yield h.map(r.getMonth(e),P);if(null==t)return i;i.push(t)}if(t.startsWith("ymd")){const t=h.map(r.getDay(e),M);if(null==t)return i;i.push(t)}return i}))}t.yearToOrdinal=y,t.monthToOrdinal=b,t.dayToOrdinal=w,t.yearTagRef=S,t.monthTagRef=P,t.dayTagRef=M,t.dateTag=E,t.dateTagFile=function(e,t=[]){return n(this,void 0,void 0,(function*(){return f.thenOpt(l.readTags(e)).flatMap(e=>u.bestCapturedAt([e.capturedAt,...t])).flatMap(e=>E(e.date)).get()}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CISet=void 0;const n=i(15),r=i(7);function s(e){return r.toS(e).normalize().toLowerCase()}class o{constructor(e){this.delegate=new Set,this.keys=this.values.bind(this),n.toA(e).forEach(e=>this.add(e))}get size(){return this.delegate.size}add(e){return this.delegate.add(s(e)),this}addAll(e){return n.toA(e).forEach(e=>this.delegate.add(s(e))),this}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(s(e))}forEach(e,t){for(const[t]of this.delegate)e(t,t,this)}has(e){return this.delegate.has(s(e))}values(){const e=this;return function*(){for(const t of e.delegate.keys())yield t}()}entries(){const e=this;return function*(){for(const t of e.delegate.keys())yield[t,t]}()}toA(){return[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}}t.CISet=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uidGeoHash=t.imageId=t.lensId=t.cameraId=t.normalizeExposureSettings=t.present=t.compactZeroes=t.zeroesRe=void 0;const n=i(1),r=i(3),s=i(2),o=i(0),a=i(5),u=i(11),l=i(7),c=i(177),d=i(6),h=i(227);t.zeroesRe=/^[\s0]*$/;const f=s.lazy(()=>d.mkLogger("ExifUid"));function p(e){return null==e||a.isNumber(e)?0===e:null!=t.zeroesRe.exec(l.toS(e))}function m(e){return null!=e&&r.notBlank(e)&&!p(e)}t.compactZeroes=function(e){return u.mapFields(e,(e,t)=>p(t)?void 0:[e,t])},t.present=m,t.normalizeExposureSettings=function(e){if(null==e)return;const t={focalLength:o.map(e.focalLength,e=>l.toS(e).trim()),aperture:a.mapNumeric(e.aperture,e=>a.sigFigs(e,2)),shutterSpeed:o.map(e.shutterSpeed,e=>{return t=e,i="/",l.toS(t).split(i).map(e=>a.mapIntOr(e,e=>l.toS(a.sigFigs(e,2)),()=>e)).join(i);var t,i}),iso:a.mapInt(e.iso,e=>a.sigFigs(e,2))};return f().debug("normalizeExposureSettings("+l.toS(e.FileName)+")",t),u.reqValuedOrElse(t)},t.cameraId=function(e){return o.map(u.pickFirst(e,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"],e=>r.notBlank(e)&&!p(e)),l.toS)},t.lensId=function(e){return o.map(h.extractLensMakeModel(e),({lensMake:e,lensModel:t})=>`${e.toLowerCase()}/${t.toLowerCase()}`)},t.imageId=function(e){return u.pickFirst(e,n.compact(["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"]),m)},t.uidGeoHash=function(e,t){return c.geohash(a.toFixed(e,4),a.toFixed(t,4))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Heartbeat=void 0;const r=i(50),s=i(4),o=i(92);class a extends o.TimestampedModel{static ping(e="ping"){return a.ops().upsertOne({name:e})}static assertPing(e){return n(this,void 0,void 0,(function*(){const t=Date.now();try{if(null==a.db())throw new Error("db is undefined");const i=yield this.ping(e);if(this.logger().info("assertPing()",{heartbeat:i}),Math.abs(t-i.updatedAt)>20*s.secondMs)throw new Error("Heartbeat.updatedAt wasn't updated")}catch(e){throw new r.WrappedError({cause:e,message:"Failed to write to the library database"})}}))}}t.Heartbeat=a,a.tableName="Heartbeat",a.uniqueColumnName="name"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Progress=t.ProgressRateMs=void 0;const n=i(66),r=i(1),s=i(3),o=i(4),a=i(20),u=i(2),l=i(0),c=i(92);t.ProgressRateMs=u.lazy(()=>o.secondMs*(n.maxCpus()<=2?2.5:1));class d extends c.TimestampedModel{toSyncState(){return{volume:this.volume,uri:this.uri,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return l.orElse(s.mapNotBlank(this.dekJSON,()=>r.compactBlanks(JSON.parse(this.dekJSON))),()=>[])}set dek(e){this.dekJSON=a.stringify(r.compactBlanks(e))}static findByUri(e){return d.ops().findOne(this.query().where({uri:e}))}}t.Progress=d,d.tableName="Progress",d.uniqueColumnName="uri"},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.EventStore=t.ExtraEventsForPlease=void 0;const r=i(4),s=i(2),o=i(15),a=i(47),u=i(17),l=i(8),c=i(23),d=i(40),h=i(70),f=i(6),p=i(57),m=i(9),g=s.lazy(()=>f.mkLogger("EventStore"));t.ExtraEventsForPlease=7;class v{constructor(){this.root=d.BaseFile.for(a.App.userData()).join("events")}datedRoot(e=new Date){return this.root.joinYMD(e)}rmrf(){return this.root.rmrf()}msg2file(e){return this.datedRoot(new Date(e.timestamp*r.secondMs)).join(h.shortStringSha(e.message,8,p.GeoRadix)+".json")}eventsFrom(e=new Date){return n(this,void 0,void 0,(function*(){return o.toA(yield this.datedRoot(e).childFiles(e=>".json"===e.ext&&!e.isHiddenPosix()))}))}eventCount(e=new Date){return n(this,void 0,void 0,(function*(){return(yield this.eventsFrom(e)).length}))}maybeSendEvent(e){return n(this,void 0,void 0,(function*(){if(u.ending())return g().error("maybeSendEvent(): REJECT: we're ending.",{event:e}),null;try{const i=c.isPleaseSendError(e.message),n=yield this.eventCount(),r=m.Settings.maxErrorsPerDay.valueOrDefault+(i?t.ExtraEventsForPlease:0);if(n>=r)return g().error("maybeSendEvent(): REJECT: too many events sent in the last day.",{recentEventCount:n,pleaseSend:i,maxErrorsPerDay:r,event:e}),null;return null==(yield this.writeEvent(e))?(g().error("maybeSendEvent(): REJECT: event was already sent in the last day.",e),null):(g().error("maybeSendEvent(): ACCEPT",{event:e,pleaseSend:i,recentEventCount:n,maxErrorsPerDay:r}),e)}catch(e){return g().error("maybeSendEvent(): Failed to determine if we should squelch the event. Failing closed.",e),null}}))}writeEvent(e){return n(this,void 0,void 0,(function*(){const t=this.msg2file(e);return l.thenMap(t.ensureNew({maxVersions:m.Settings.maxErrorsPerDay.valueOrDefault,emptyIsNew:!1}).catch(()=>{}),t=>t.writeJsonMaybe(e))}))}}t.EventStore=v,v.instance=s.lazy(()=>new v)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.logLevelToSeverity=t.logEntryToBreadcrumb=t.mkBreadcrumbs=t.annotateEvent=t.sentryExceptionToS=t.sentryExceptionsToS=t.extractMessage=t.EventFilter=t.eventFilter=t.sendToSentry=t.installSentry=void 0;const r=i(269),s=i(346),o=i(49),a=i(19),u=i(17),l=i(23),c=i(13),d=i(287),h=i(195),f=i(258),p=i(259),m=i(268),g=i(347),v=i(77),y=i(6),b=i(28),w=i(294),S=i(14),P=i(127),M=i(29),E=i(9),x=i(10),_=i(65),T=i(1),D=i(3),O=i(4),F=i(34),I=i(37),k=i(20),C=i(2),A=i(0),L=i(15),R=i(7),N=i(35),B=i(159),j=i(130),z=i(272),V=y.mkLogger("Sentry");function q(e,t){z.sentryEnabled()&&(l.isIgnorableError(t)?l.isIgnorableError(e)||r.captureMessage(e):r.captureException(l.addMessage(t,e)))}t.installSentry=function(e){return n(this,void 0,void 0,(function*(){try{return!!z.sentryEnabled()&&(r.init({dsn:S.isElectron?"https://0652cdd351054fe9853ff944b1f54e2c@sentry.io/289071":"https://408e2f8d62c3494d8ed663d9e488d67a@sentry.io/1828379",shutdownTimeout:M.serviceShutdownTimeoutMs(e.name),release:_.release,environment:b.nodeEnv,maxBreadcrumbs:100,integrations:()=>[],beforeSend:t.eventFilter().beforeSend,serverName:yield h.systemUID(),onFatalError:e=>l.onError("sentry.onFatalError",e)}),!0)}catch(e){return V.warn("Failed to set up sentry: "+e),!1}}))},t.sendToSentry=q,t.eventFilter=C.lazy(()=>new W);class W{constructor(){this.eventStore=d.EventStore.instance(),this.beforeSend=(e,t)=>n(this,void 0,void 0,(function*(){if(!z.sentryEnabled())return V.error("Sentry.beforeSend(): not sending event",e),null;const i=x.ellipsize(U(e,t),60);if(l.isDoNotSendError(i))return V.info("Sentry.beforeSend(): event not sendable. vetoing",{event:e,hint:t,msg:i}),null;D.blank(e.message)&&(e.message=i);const n=yield J(e);return this.eventStore.maybeSendEvent(n)})),c.onNonFatal(q),c.onFatal(q),new u.EndableWrapper("EventFilter",()=>this.end(),u.EndableRanks.first)}end(){return A.map(r.getCurrentHub().getClient(),e=>e.close(5*O.secondMs))}}function U(e,t){var i;return T.uniq(T.compactBlankish([e.message,...L.toA(H(null===(i=e.exception)||void 0===i?void 0:i.values)),I.errorToS(null==t?void 0:t.originalException)])).join(": ")}function H(e){return T.mapNotEmpty(e,e=>T.compactBlanks(e.map(G)))}function G(e){return T.mapNotEmpty(T.compactBlanks([null==e?void 0:e.type,null==e?void 0:e.value].filter(e=>"error"!==R.toS(e).toLowerCase())),e=>e.join(": "))}function J(e){return n(this,void 0,void 0,(function*(){const t=E.Settings.email.value;D.notBlank(t)&&(null==e.user&&(e.user={}),e.user.email=t),T.isEmpty(e.breadcrumbs)&&(e.breadcrumbs=yield $());const i=A.orElse(e.extra,{});return i.pid=a.pid,i.serviceName=M.serviceName(),i.serviceEnding=u.ending(),i.runtimeMs=Date.now()-b.start,i.version=_.version,i.os=w.OS(),i.isDocker=S.isDocker(),i.nodeVersion=a.versions.node,i.locale=yield m.locale(),i.cpus=w.CPUs(),i.memoryUsageBytes=B.memoryUsageBytes(),i.systemMemory=N.fmtBytes(o.freemem())+" / "+N.fmtBytes(o.totalmem()),i.ffmpeg=yield f.ffmpegVersionDescription(),i.vlc=yield p.vlcVersionDescription(),i.argv=k.stringify(a.argv),i.systemUID=yield h.systemUID(),i.libraryUID=yield j.libraryUID(),e.extra=i,Object.assign({timestamp:Date.now()/O.secondMs},e)}))}function $(){return n(this,void 0,void 0,(function*(){yield P.broadcast("writeRecentLogEntries"),yield F.delay(3*v.DefaultLogFlushMs);const e=yield g.allRecentLogEntries();return T.compact(e.map(Q))}))}function Q(e){return A.map(K(e.l),t=>({timestamp:e.ts/O.secondMs,level:t,category:A.orElse(e.from,M.processName()),message:x.stripAnsiEsc(e.ctx+": "+e.msg),data:"object"==typeof e.meta?e.meta:{value:x.isString(e.meta)?x.stripAnsiEsc(e.meta):e.meta}}))}function K(e){switch(e){case"error":return s.Severity.Error;case"warn":return s.Severity.Warning;case"info":return s.Severity.Info;case"debug":return s.Severity.Debug;default:return}}t.EventFilter=W,t.extractMessage=U,t.sentryExceptionsToS=H,t.sentryExceptionToS=G,t.annotateEvent=J,t.mkBreadcrumbs=$,t.logEntryToBreadcrumb=Q,t.logLevelToSeverity=K},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.assetFileSortCriteriaPojo=t.sortAssetFiles=t.file2sortableAssetFile=t.mtime2sort=t.dim2sort=void 0;const r=i(1),s=i(3),o=i(4),a=i(2),u=i(0),l=i(5),c=i(11),d=i(7),h=i(87),f=i(30),p=i(6),m=i(10),g=i(48),v=i(113),y=a.lazy(()=>p.mkLogger("AssetFileSorter")),b=[h.PS_NETWORK_FILESYSTEM_PROTOCOL,"file:",h.PS_LOCAL_FILE_PROTOCOL,h.PS_LIBRARY_PROTOCOL];function w(e){return u.map(e,e=>l.map2Numeric(e.width,e.height,(e,t)=>Math.ceil(Math.pow(e*t,.15))))}function S(e){return Math.round(e/(2*o.minuteMs))}function P(e){const t=w(e),[i,n]=d.toS(e.uri).split("://");if(s.blank(i)||s.blank(n)||null==e.mtime)return void y().debug("assetFileSortCriteriaPojo(): skipping",{af:e,protocol:i,pathname:n});const r=b.indexOf(m.ensureSuffix(i,":").toLowerCase());if(-1===r)return void y().debug("assetFileSortCriteriaPojo(): skipping",{af:e,schemeIdx:r,protocol:i});const o=f.parsePosixPath(n),a=o.base.toLowerCase().includes("cover"),l=g.isBrowserExt(o.ext),c=u.orElse(f.countFromName(o.name),0);return{resolution:t,mtime:S(e.mtime),schemeIdx:r,isCover:a,count:c,isBrowserSupported:l,uri:e.uri}}t.dim2sort=w,t.mtime2sort=S,t.file2sortableAssetFile=function(e){return n(this,void 0,void 0,(function*(){return c.reqValuedOrElse(Object.assign({uri:yield e.uri(),mtime:yield e.thisOrSidecareMaxMtimeMs(),sha:yield e.sha()},yield v.dimensions(e)))}))},t.sortAssetFiles=function(e){for(const t of r.uniq(e.map(e=>e.sha))){const i=e.filter(e=>e.sha===t),n=Math.max(...r.compact(i.map(e=>e.mtime)));i.forEach(e=>e.mtime=n)}const t=r.compact(e.map(e=>u.map(P(e),t=>u.map(function(e){const t=c.values(e);return t.some(e=>null==e)?void y().debug("pojoToCriteria(): skipping",{pojo:e}):t}(t),i=>({f:e,crit:i,pojo:t}))))),i=r.sortBy(t,({crit:e})=>e);return r.mapNotEmpty(i,e=>e.map(e=>e.f))},t.assetFileSortCriteriaPojo=P},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.clearCacheDirs=t.vacuumCacheDirs=t.clearCacheDir=t.cacheDir=t.CacheDirPrefix=t.cacheDirs=void 0;const r=i(64),s=i(33),o=i(47),a=i(8),u=i(70),l=i(32),c=i(118),d=i(6),h=i(57),f=i(163),p=i(9),m=i(1),g=i(20),v=i(2),y=i(0),b=v.lazy(()=>d.mkLogger("CacheDir"));function w(){return a.thenMapOr(l.PosixFile.for(o.App.getPath("userData")).children(),e=>e.filter(e=>e.name.startsWith(t.CacheDirPrefix)),()=>[])}function S(){return n(this,void 0,void 0,(function*(){const e=[p.Settings.libraryPath,...p.persistedLibrarySettings()].map(e=>[e.key,e.valueOrDefault]);e.push(["ASSET_FILE_VERSION",f.AssetFileVersion]),e.push(["ASSET_VERSION",f.AssetVersion]),e.push(["TRANSCODE",yield c.isVideoTranscodingSupported()]);const i=m.sortBy(e,([e])=>e),n=u.shortStringSha(g.stringify(i),9,h.GeoRadix),a=(yield l.PosixFile.for(o.App.getPath("cache")).mkNoMedia()).join(t.CacheDirPrefix+n);return yield r.mkdirp(a.nativePath),yield a.join("README.txt").applyIfEmpty(e=>e.writeTxt(`\nThis folder holds state for library synchronization of\n\n${p.Settings.libraryPath.value}\n\nIf you delete or modify the contents of this directory, you will need to\nrestart PhotoStructure, and the next sync will need to rescan all your drives.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSettings: \n\n`+s.inspect(i,{colors:!1,breakLength:80}))).catch(e=>{b().warn("Failed to write README to "+a,e)}),b().info("Set up cache dir "+a),a}))}function P(e){return n(this,void 0,void 0,(function*(){const i=y.orElse(e,yield S());if(!i.name.startsWith(t.CacheDirPrefix))throw new Error("Refusing to remove directory "+i);yield i.rmrf()}))}t.cacheDirs=w,t.CacheDirPrefix="sync-state-",t.cacheDir=S,t.clearCacheDir=P,t.vacuumCacheDirs=function(){return n(this,void 0,void 0,(function*(){const e=yield S();for(const t of yield w())t.eql(e)||(yield P(t))}))},t.clearCacheDirs=function(){return n(this,void 0,void 0,(function*(){for(const e of yield w())yield P(e)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SquareMatrix=t.rotateSquareMatrix=void 0;const n=i(108);t.rotateSquareMatrix=function(e,t){return 0===n.normalizeRotation(t)?e:new r(e).rotate(t).m};class r{constructor(e,t=1){if(this.m=e,this.ary=t,this.rows=Math.sqrt(e.length/t),this.rows!==Math.floor(this.rows))throw new Error(`Only square tuple matrices are supported: ${1===this.ary?"":this.ary}(${this.rows}Ã${this.rows}) != ${e.length}`)}index(e,t){return this.ary*(t+e*this.rows)}swap(e,t){for(let i=0;i<this.ary;i++){const n=this.m[e+i];this.m[e+i]=this.m[t+i],this.m[t+i]=n}}transpose(){for(let e=0;e<this.rows;e++)for(let t=e+1;t<this.rows;t++)this.swap(this.index(e,t),this.index(t,e));return this}reverseRows(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(t,e),this.index(this.rows-1-t,e));return this}reverseCols(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(e,t),this.index(e,this.rows-1-t));return this}reverse(){const e=Math.pow(this.rows,2);for(let t=0;t<e/2;t++)this.swap(t,e-1-t);return this}rotate(e){switch(n.normalizeRotation(e)){case 0:break;case 90:this.transpose(),this.reverseCols();break;case 180:this.reverse();break;case 270:this.transpose(),this.reverseRows();break;default:throw new Error("unsupported rotate("+e+")")}return this}}t.SquareMatrix=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prngSeed=t.SeedCount=t.primesPerBin=void 0;const n=i(78);t.primesPerBin=6,t.SeedCount=Math.pow(t.primesPerBin,6),t.prngSeed=function(){return n.randomInt(0,t.SeedCount)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.idleStats=t.removeIdleListener=t.addIdleListener=t.setDoNotRunImpl=t.idleRunner=void 0;const r=i(4),s=i(34),o=i(17),a=i(198),u=i(43),l=i(13),c=i(345),d=i(66),h=i(117);l.onResume(()=>b()),l.onIdle(()=>s.later(b));const f=new u.Promises,p=new u.Promises,m=new c.RoundRobin;t.idleRunner=new a.EndableInterval({name:"Idle",callback:b,intervalMs:7*r.secondMs,initialDelayMs:20*r.secondMs,unref:!0});let g=()=>n(void 0,void 0,void 0,(function*(){return!1}));function v(){return n(this,void 0,void 0,(function*(){return h.isPaused()||o.ending()||0===m.size||p.pendingCount>=d.maxCpus()||(yield g())}))}t.setDoNotRunImpl=function(e){g=e};const y=d.maxCpus()>4?250:750;function b(){return n(this,void 0,void 0,(function*(){return(yield v())?void 0:f.maybeRun("runOnIdle",()=>n(this,void 0,void 0,(function*(){if(yield v())return;const{value:e}=m.next(e=>e.runnable);null!=e&&p.push(e.name,()=>n(this,void 0,void 0,(function*(){return e.onIdle()}))).finally(()=>b),m.size>0&&s.later(b,y)})))}))}t.addIdleListener=function(e){m.push(e),s.later(b)},t.removeIdleListener=function(e){return m.filterInPlace(t=>t.name!==e)},t.idleStats=function(){return n(this,void 0,void 0,(function*(){return{doNotRun:{isPaused:h.isPaused(),ending:o.ending(),doNotRunImpl:yield g()},idleListeners:m.toA().map(e=>null==e?void 0:e.name),runnableIdleListeners:m.toA(e=>null==e?void 0:e.runnable).map(e=>null==e?void 0:e.name),pendingWorkItems:p.pendingNames()}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CPUs=t.osNameWin=t.osNameLinux=t.OS=void 0;const n=i(154),r=i(46),s=i(49),o=i(4),a=i(2),u=i(0),l=i(12),c=i(183),d=i(6),h=a.lazy(()=>d.mkLogger("os"));function f(){switch(s.platform()){case"linux":return m();case"darwin":return function(){try{const e=n.execSync("sw_vers -productVersion").toString().trim();return u.mapOr(g.get(s.release().split(".",1)[0]),t=>`macOS ${t} (${e})`,p)}catch(e){return h().warn("Failed to get osNameMac",e),p()}}();case"win32":return y();default:return p()}}function p(){return s.platform()+" "+s.release()}function m(){try{const e=r.readFileSync("/etc/os-release").toString(),t=c.parseEnvTokens(e);return u.map2Or(t.name,t.version,(e,t)=>e+" "+t,p)}catch(e){return h().warn("Failed to fetch /etc/os-release",e),p()}}t.OS=a.lazy(()=>[f(),"on",s.arch()].join(" ")),t.osNameLinux=m;const g=new Map([["19","Catalina"],["18","Mojave"],["17","High Sierra"],["16","Sierra"],["15","El Capitan"],["14","Yosemite"],["13","Mavericks"],["12","Mountain Lion"],["11","Lion"],["10","Snow Leopard"]]);const v=[["10.0","10"],["6.3","8.1"],["6.2","8"],["6.1","7"],["6.0","Vista"],["5.2","Server 2003"],["5.1","XP"],["5.0","2000"],["4.9","ME"],["4.1","98"],["4.0","95"]];function y(e=s.release()){for(const[t,i]of v)if(e.startsWith(t))return`Windows ${i} (${e})`;return h().warn("osNameWin(): unknown release: "+e),`Windows (${e})`}t.osNameWin=y,t.CPUs=a.lazy(()=>l.uniqCount(s.cpus().map(e=>e.model)).map(e=>`${e.count} Ã ${e.t}`).join(", "),o.minuteMs)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ChildService=t.nodeArgs=t.inspectPort=t.pathToService=t.ChildServiceExitCommand=void 0;const r=i(19),s=i(53),o=i(1),a=i(3),u=i(4),l=i(2),c=i(0),d=i(11),h=i(38),f=i(15),p=i(7),m=i(47),g=i(12),v=i(60),y=i(17),b=i(43),w=i(63),S=i(23),P=i(40),M=i(6),E=i(14),x=i(9),_=i(10),T=i(27),D=i(21),O=i(184),F=i(192);t.ChildServiceExitCommand="--exit";const I=l.lazy(()=>M.mkLogger("ChildService"));function k(e){return n(this,void 0,void 0,(function*(){const t=_.ensureSuffix(e,".js"),i=P.BaseFile.projectRoot(),s=P.BaseFile.for(r.cwd()),o=E.isPacked?[i.join("bin",t),i.join("app.asar",t)]:[s.join("dist","library",t),s.join("lib","library",t)];o.push(s.join("dist","app",t));const a=g.firstAsync(o,e=>n(this,void 0,void 0,(function*(){return(yield e.isNonEmpty(101))?e:void 0})));return I().tap({msg:"pathToService()",level:"info",result:a,meta:{cmd:t,isPacked:E.isPacked,dirs:o.map(p.toS)}})}))}t.pathToService=k;let C=0;function A(e){switch(e){case"web":return 9223;case"sync":return 9224;case"sync-file":return 9225+C++%20;default:return 9222}}function L(e){const t=[];return x.Settings.inspect.valueOrDefault&&t.push("--inspect="+A(e)),t}t.inspectPort=A,t.nodeArgs=L;class R{constructor(e,i,r){this.cmd=i,this.opts=r,this.restartCount=0,this.healthCheck=b.serially("ChildService.healthCheck",()=>n(this,void 0,void 0,(function*(){if(y.ending()||this.ended)return;if(this.logger.debug("healthCheck(): running..."),h.isFunction(this.opts.healthy)){if(!1===(yield this.opts.healthy()))return S.onError("healthCheck for "+this.name+": !healthy(), restarting."),void(yield this.restart())}const e=this._lastStatus=new v.Deferred(this.name+" healthCheck at "+new Date).setTimeout(T.CmdTimeoutMs);e.promise.catch(e=>(S.onError("healthCheck for "+this.name+": failed",e),this.restart()));(yield this.write("--status"))||e.resolve(O.fullhc({fail:["write --status failed"]}));try{const t=yield e.promise;return O.hasBad(t)||O.hasFail(t)?(S.onError("healthCheck for "+this.name+": unhealthy, restarting."),void(yield this.restart())):(this.logger.debug("healthCheck: all is well",t),t)}catch(e){return void this.logger.warn("healthCheck: failed",e)}}))),this.name="ChildService("+e+")",this.logger=M.mkLogger(this.name);const s=[...f.toA(r.nodeArgs),i.nativePath];o.isNotEmpty(r.args)&&s.push(...r.args);const a=d.pick(this.opts,"argv0","cwd","detached","env","gid","shell","stdio","timeout","uid","windowsHide","windowsVerbatimArguments");this.wc=new F.WatchedChild(Object.assign({name:e,childFactory:()=>n(this,void 0,void 0,(function*(){return this.restartCount>0&&null!=this.opts.onPreRestart&&(yield this.opts.onPreRestart()),this.restartCount++,D.spawn(m.App.getPath("exe"),s,-1,a)})),endableRank:y.EndableRanks.service,onStdout:this.onStdout.bind(this),onError:c.orElse(this.opts.onError,()=>e=>!S.isIgnorableError(e)),ignoreStopErrors:!1,exitCommand:t.ChildServiceExitCommand},r)),this.healthCheckTimer=w.setUnrefInterval(()=>this.healthCheck(),u.minuteMs),y.addFirstEndable(this)}static mk(e,t={}){return n(this,void 0,void 0,(function*(){const i=c.orElse(t.pathToService,yield k(e));if(a.blank(i))throw new Error("Failed to find path to "+e);return t.nodeArgs=[...L(e),...f.toA(t.nodeArgs)],new R(e,i,t)}))}get startMs(){return this.wc.startMs}onStdout(e){return n(this,void 0,void 0,(function*(){if(!a.blank(e))try{const t=JSON.parse(e);if(a.notBlank(t.fatal))this.wc.onError(this.name+".onStdout()",t.error);else if(null!=t.healthChecks){const e=this._lastStatus;null!=e&&e.pending&&e.resolve(Object.assign(Object.assign({},t.healthChecks),{ts:Date.now()}))}else null!=this.opts.onData&&this.opts.onData(t)}catch(t){console.log(e)}}))}start(){return this.wc.start()}stop(){return this.wc.stop()}restart(e){return this.wc.restart(e)}get ended(){return this.wc.ended}end(){return n(this,void 0,void 0,(function*(){return s.clearInterval(this.healthCheckTimer),this.wc.ended||(yield this.write("--quit")),this.wc.end()}))}get pid(){return this.wc.pid}get msSinceLastStart(){return this.wc.msSinceLastStart}running(){return this.wc.running()}notRunning(){return this.wc.notRunning()}write(e,t=2){return n(this,void 0,void 0,(function*(){if(t<0)return this.logger.warn("write(): no more retries",{toStdin:e}),!1;try{const t=this.wc.proc;return null!=t&&null!=t.stdin&&t.stdin.writable?t.stdin.write(_.ensureSuffix(e,"\n")):(this.logger.warn("write(): childProc isn't open, ignoring",{toStdin:e}),!1)}catch(i){return this.logger.warn("write(): caught "+i),yield this.wc.onError("onStdout()",i),this.write(e,t-1)}}))}}t.ChildService=R},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpBroadcaster=void 0;const r=i(2),s=i(6),o=r.lazy(()=>s.mkLogger("Broadcaster"));var a;!function(e){e.broadcast=(e,t)=>n(this,void 0,void 0,(function*(){return o().warn("broadcast sent to no-op",{event:e,args:t}),!1}))}(a||(a={})),t.NoOpBroadcaster=a},function(e,t){e.exports=require("file-type")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readFilePart=void 0;const r=i(64),s=i(0),o=i(8),a=i(16);t.readFilePart=function(e,t=0,i){return n(this,void 0,void 0,(function*(){let n=-1;try{const u=yield s.orElse(i,()=>o.thenMap(r.stat(e),e=>e.size-t)),l=Buffer.alloc(u);return n=yield r.open(e,"r"),yield r.read(n,l,0,u,t)}finally{yield a.mapGte0(n,r.close)}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.emitSafely=void 0;const r=i(1),s=i(8);t.emitSafely=function(e,t,i,o=1e3){return n(this,void 0,void 0,(function*(){const n=yield s.until(()=>r.isNotEmpty(e.listeners(t)),o);return n&&e.emit(t,i),n}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Reducers=t.Fit=t.fitInsideToAspectRatio=t.Square=t.SharpFits=void 0;const n=i(85),r=i(301),s=i(96),o=i(2),a=i(36),u=i(6),l=i(9),c=i(132);var d,h;t.SharpFits=a.strEnum("cover","contain","fill","inside","outside"),function(e){e.name=s.ReducerNames.sq,e.fit="cover",e.reduce=(e,t)=>{const i=t.width!==t.height;if(c.ltBoth(e,t))return i?Object.assign(Object.assign({},e),{fit:"cover",position:l.Settings.squareThumbStrategy.valueOrDefault}):e}}(d=t.Square||(t.Square={})),t.fitInsideToAspectRatio=function(e,t){return e.width/e.height>=t?{width:Math.floor(e.height*t),height:e.height}:{width:e.width,height:Math.floor(e.width/t)}},function(e){const t=o.lazy(()=>u.mkLogger("Reducers.Fit"));e.name=s.ReducerNames.fit,e.fit="inside",e.reduce=(e,i)=>{if(!c.ltBoth(i,e))return r.fitInside(i,e);t().trace(`reduce(): input ${n.dimToS(i)} is too small for ${n.dimToS(e)}`)}}(h=t.Fit||(t.Fit={})),t.Reducers=[d,h]},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fitInside=void 0,t.fitInside=function(e,t){const i=e.width/e.height;if(i>=t.width/t.height){const n=Math.min(t.width,e.width);return{width:n,height:Math.ceil(n/i)}}{const n=Math.min(t.height,e.height);return{width:Math.ceil(t.height*i),height:n}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatTimeoutMs=void 0;const n=i(4);t.StatTimeoutMs=25*n.secondMs},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractBitrateKbps=void 0;const n=i(0),r=i(7),s=i(12),o=i(16);t.extractBitrateKbps=function(e){return s.first(["AvgBitrate","MaxDataRate"],t=>{return i=e[t],n.map(o.extractFloat(i),e=>{const t=r.toS(i).toLowerCase();return n.map(s.first(a,e=>t.includes(e.pat)?e.fac:void 0),t=>e*t)});var i})};const a=[{pat:"mb/s",fac:1024},{pat:"mbps",fac:1024},{pat:"kb/s",fac:1},{pat:"kbps",fac:1}]},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.trueFilter=t.definedFilter=t.Filter=void 0;const n=i(0),r=i(126);class s{static lift(e){return new class extends s{apply(t){return e(t)}}}and(e){return s.lift(t=>this.apply(t)&&e.apply(t))}or(e){return s.lift(t=>this.apply(t)||e.apply(t))}filter(e){return e.filter(e=>this.apply(e))}asAsync(){return r.AsyncFilter.lift(e=>Promise.resolve(this.apply(e)))}}t.Filter=s,t.definedFilter=s.lift(n.defined),t.trueFilter=s.lift(()=>!0)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractExposureSettings=void 0;const n=i(3),r=i(11),s=i(6),o=i(16),a=s.mkLogger("ExposureSettings");t.extractExposureSettings=function(e){const t={focalLength:e.FocalLength,iso:o.firstNonZero(e.ISO,e.ISOSpeed,e.SonyISO),aperture:o.firstNonZero(e.FNumber,e.Fnumber,e.ApertureValue,e.SonyFNumber),shutterSpeed:n.firstNotBlank(e.ExposureTime,e.ShutterSpeed,e.SonyExposureTime)};return a.debug("extracted from "+e.FileName,{exposureSettings:t}),r.reqValuedOrElse(t)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readJsonSidecar=void 0;const r=i(98),s=i(73),o=i(3),a=i(5),u=i(18),l=i(6).mkLogger("JsonSidecar");function c(e,t,i){for(const n of t)if(e&&e[n]&&a.isNumber(e[n][i]))return e[n][i]}t.readJsonSidecar=function(e){return n(this,void 0,void 0,(function*(){const t=yield e.readJSON(),i=null==t?void 0:{DateTimeOriginal:u.Opt(t.photoTakenTime).flatMap(e=>e.timestamp).flatMap(a.toInt).filter(a.gt0).flatMap(e=>r.ExifDateTime.fromDateTime(s.DateTime.fromMillis(1e3*e))).get(),GPSLatitude:c(t,["geoDataExif","geoData"],"latitude"),GPSLongitude:c(t,["geoDataExif","geoData"],"longitude"),GPSAltitude:c(t,["geoDataExif","geoData"],"altitude"),Title:o.ifNotBlank(t.title),Description:o.ifNotBlank(t.description)};return null!=i&&l.debug("read "+e,i),i}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractTitleDescription=void 0;const n=i(1),r=i(3),s=i(7),o=i(11);t.extractTitleDescription=function(e){const t=n.uniq(["OLYMPUS DIGITAL CAMERA",e.originalMake,e.originalModel,e.Model,e.Make,e.CameraID]).map(e=>r.mapNotBlank(e,e=>e.trim().toLowerCase().normalize())),i=(...i)=>{for(const n of i){const i=s.toS(e[n]).trim();if(r.notBlank(i)&&!t.includes(i.toLowerCase().normalize()))return i}};return o.compactValues({title:i("XPTitle","Title","ObjectName"),description:i("XPSubject","Description","ImageDescription","Caption-Abstract")})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fsSafeHostname=void 0;const n=i(49),r=i(10);t.fsSafeHostname=function(e=n.hostname()){return r.stripDiacritics(e).replace(/[^a-z0-9-\s]/gi,"").trim().replace(/\s+/g,"-").toLowerCase()}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.JsonFileStore=void 0;const r=i(2),s=i(8),o=i(6),a=i(24),u=i(50);t.JsonFileStore=class{constructor(e,t,i=a.identity,n=a.identity){this.file=e,this.onCreate=t,this.onRead=i,this.onWrite=n,this.prior=r.lazy(()=>this.file.readJSON("debug"))}read(){return n(this,void 0,void 0,(function*(){const e=yield this.prior();return o.mkLogger("JsonFileStore").debug("prior "+this.file,e),null!=e?this.onRead(e):s.thenMap(this.onCreate(),e=>this.write(e))}))}write(e){return n(this,void 0,void 0,(function*(){try{const t=yield this.onWrite(e);return yield this.file.writeJSON(t,{spaces:2}),o.mkLogger("JsonFileStore").info("wrote to "+this.file,t),yield this.prior.set(Promise.resolve(t)),t}catch(e){throw new u.WrappedError({cause:e,message:"Failed to write to "+this.file})}}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;const r=i(19),s=i(56),o=i(3),a=i(4),u=i(34),l=i(20),c=i(2),d=i(0),h=i(5),f=i(7),p=i(79),m=i(17),g=i(8),v=i(69),y=i(23),b=i(13),w=i(102),S=i(61),P=i(6),M=i(93),E=i(28),x=i(29),_=i(262),T=i(311),D=a.minuteMs,O=5*a.secondMs,F={requestTTL:D,retriesPerRequest:5,delayBetweenRetries:E.isTest?100:O,maxPendingRequests:10};let I=0;t.Client=class{constructor(e,t,i={}){this.streamFactory=t,this._ended=!1,this.mkStreamRate=new M.Rate(a.minuteMs),this.times=new v.PromiseTimer,this.changeListeners=[],this.stream=c.lazy(()=>n(this,void 0,void 0,(function*(){try{if(this.flapping)return this.onError("stream() is restarting too frequently (epm: "+this.mkStreamRate.eventsPerMinute+")");const e=yield this.streamFactory();return null==e?this.onError("streamFactory() returned null"):(this.changeListeners.forEach(e=>e()),this.logger.debug("Opened stream"),e.on("end",e=>this.onFinish("on(end)",e)),e.on("close",e=>this.onFinish("on(close)",e)),e.on("error",e=>this.onError("stream error",e)),w.onDataChunked(e,"\n",e=>this.onData(e)),e)}catch(e){return this.onError("streamFactory rejection",e)}}))),this.ping=c.lazy(()=>this.request("ping",{serviceName:x.serviceName(),pid:r.pid}),250),this.name="rpc.Client("+e+"#"+I+++")",this.logger=P.mkLogger(this.name),this.opts=Object.assign(Object.assign({},F),i),this.pending=new p.TTLMap(3*this.opts.requestTTL),m.addFirstEndable(this),this.stream()}get ended(){return this._ended}end(){return this.logger.info("end()",{ending:m.ending(),timings:this.times.report(),pendingSize:this.pending.size}),this._ended=!0,this.pending.clear(),this.close()}addChangeListener(e){this.changeListeners.push(e)}get flapping(){return this.mkStreamRate.msSinceLastEvent<5*a.secondMs||h.gt(this.mkStreamRate.eventsPerMinute,5)}broadcast(e,t){return this.request("broadcast",{event:e,args:t})}sendRecentLogs(){return this.request("sendRecentLogs")}ready(e=2){return n(this,void 0,void 0,(function*(){if(this.ended)return this.logger.debug("ready(): false (ended)"),!1;const t=[...this.pending.values()],i=t.filter(e=>e.pending).length,n=t.filter(e=>e.rejected).length;return i>this.opts.maxPendingRequests||n>=e?(this.logger.warn("Client is not ready",{pendingReqCnt:i,recentErrCnt:n}),!1):null!=(yield this.stream())}))}request(e,t){return n(this,void 0,void 0,(function*(){if(this.ended){if(m.ending())return;throw new Error("client is ending")}if(o.blank(e))throw new Error("method cannot be blank");return s.retryOnReject(()=>this.submit(e,t),{maxRetries:this.opts.retriesPerRequest,onRetryWaitUntil:e=>u.delay(this.opts.delayBetweenRetries*e).then(()=>g.until(()=>this.ready(),this.opts.requestTTL)),errorIsRetriable:e=>f.toS(e).includes(y.RetriableErrorFlag)})}))}submit(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.stream();if(null==i)return this.onError("submit("+e+"): stream is closed");const n=_.uid(),r=new T.RequestResponse(n,e,t,this.times);return r.setTimeout(this.opts.requestTTL),this.pending.set(n,r),this.logger.trace("sending request",{id:n,method:e,params:t}),i.write(l.stringify({id:n,method:e,params:t})+"\n"),r.response}))}close(){return this.logger.info("close()",{ended:this.ended}),g.thenMap(this.stream.clear(),S.end)}onData(e){if(!o.blank(e))try{this.logger.trace("onData",{req:e});const t=JSON.parse(e);if(o.blank(t.sid))throw new Error("response is missing server id");if(this.sid!==t.sid&&(null!=this.sid&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:t.sid}),b.eventEmitter.emit("rpcServerChange")),this.sid=t.sid,m.ending()))return;if(null==t.id){if(o.notBlank(t.event))return this.logger.debug("re-broadcasting event",t),void b.eventEmitter.emit(t.event,t.args);throw new Error("missing request id from response")}const i=this.pending.pop(t.id);null==i?this.logger.warn("unknown or stale request ID",{resp:t,pendingIds:[...this.pending.keys()]}):null!=t.error?(i.reject(d.orElse(t.error.message,t.error)),this.logger.warn("Rejected",{resp:t,rr:i})):(i.resolve(t.result),this.logger.debug("Resolved",t.result))}catch(t){this.logger.warn("invalid input: "+e,t)}}onError(e,t){return n(this,void 0,void 0,(function*(){this.logger.info(e+" onError(): "+d.map(t,e=>d.orElse(e.stack,e))),yield y.onError(e,t),yield this.restart()}))}restart(){return n(this,void 0,void 0,(function*(){if(this.logger.info("restart()",{ended:this.ended,flapping:this.flapping}),yield this.close(),this.changeListeners.forEach(e=>e()),this.flapping)this.logger.warn("restart(): Too many recent errors, we'll try reconnecting again in a bit",{errPerMin:this.mkStreamRate.eventsPerMinute});else{if(!this.ended&&!m.ending()){if(null!=(yield this.stream())){const e=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+e.length+" jobs now."),e.forEach(e=>e.reject("restarting"+y.RetriableErrorFlag)),e.forEach(e=>e.d.promise.catch(()=>{})),!0}return this.logger.warn("restart(): stream() returned null"),!1}this.logger.warn("restart(): Ending. Rejecting new connection.")}}))}onFinish(e,t){if(this.ended)return;const i=null==t||!1===t;return this.logger.info("onFinish",{source:e,error:t,restarting:i}),i?this.restart():this.onError(e,t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestResponse=void 0;const n=i(33),r=i(0),s=i(60);class o{constructor(e,t,i,n){this.id=e,this.method=t,this.params=i,this.timer=n;const r="rpc.RequestResponse("+t+")#"+e;this.d=new s.Deferred(r)}[n.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),r.map(this.d.settledMs,e=>this.timer.push(this.method,e)))}reject(e){this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}}t.RequestResponse=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.awaitAll=t.amap=t.atap=void 0;const n=i(11),r=i(25);t.atap=function(e,t){return r.isPromise(e)?r.thenTap(e,t):n.tap(e,t)},t.amap=function(e,t){return r.isPromise(e)?e.then(e=>t(e)):t(e)},t.awaitAll=function(e){return e.some(e=>r.isPromise(e))?Promise.all(e):e}},function(e,t){e.exports=require("knex")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DirStat=void 0;const r=i(32),s=i(0),o=i(149),a=i(219);class u extends a.StatsModel{static findByUri(e){return this.ops().findOneBy({uri:e})}static getAggregate(e,t){return n(this,void 0,void 0,(function*(){const i=this.query().select({assetCount:o.knex.raw("sum(assetCount)"),fileCount:o.knex.raw("sum(fileCount)"),dirCount:o.knex.raw("count(id)")});t(i);const n=yield this.dbLocal().first(i);return s.map(n,t=>t.rootUri=e),n}))}static getPathAggregates(e){return n(this,void 0,void 0,(function*(){return this.getAggregate(e,t=>t.where("uri","like",e+"%"))}))}static getFullAggregates(){return n(this,void 0,void 0,(function*(){return this.getAggregate("",()=>{})}))}static touchSubpaths(e){return this.dbLocal().run(this.query().where("uri","like",e+"%").update({updatedAt:Date.now()}))}static allForRootUri(e){return this.ops().all(this.query().where("uri","like",e+"%").orderBy("id"))}static deleteStaleForRoot(e,t){return this.dbLocal().run(this.query().where("uri","like",e+"%").where("updatedAt","<",t).delete())}get posixFile(){return r.PosixFile.forUri(this.uri)}}t.DirStat=u,u.tableName="DirStat",u.uniqueColumnName="uri"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Queue=void 0;const n=i(267),r=i(219);class s extends r.StatsModel{itemCount(){return n.QueueItem.dbr(e=>e.pluckFirstf(e=>e.where({queueId:this.id}).count()))}upsertWorkItems(e){const t=e.map(e=>Object.assign({queueId:this.id},e));return this.logger().info("upserting into queue "+this.name,e),n.QueueItem.ops().upsert(t)}}t.Queue=s,s.tableName="Queue",s.uniqueColumnName="name"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.primes=t.primeSeeds=t.primeLists=t.prng=t.prngOrderByClause=void 0;const n=i(4),r=i(2),s=i(5),o=i(292),a=i(12),u=i(81),l=i(317);function c(e){return a.zip(t.primeLists(),l.digits(e,o.primesPerBin,6).reverse()).map(([e,t])=>e[t])}t.prngOrderByClause=function(e,i,n){const[r,s,o,a,u]=t.primes(e),l=`(${i}%${a})`;return`ROUND(${`(${r}*${l}*${l}+${s}*${l})`}*${`(${o}*${l}+${a})`}+${`${u}+${i}`})${n?"%"+n:""}`},t.prng=function(e,i,n){const[r,s,o,a,u]=t.primes(e),l=i%a,c=(r*l*l+s*l)*(o*l+a)+u+i;return Math.round(c)%n},t.primeLists=r.lazy(()=>[[21683,39301,45853,57427,58991,65543],[262139,314569,366997,419429,471871,524309],[1048573,1258291,1468079,1677811,1887539,2097257],[10392467,22222223,32457869,42638597,58947631,68956417,84619573],[353868013,472882027,573259391,694847533,756065159,899809343],[2147483647,3743895347,4295032837,5949670231,6607882123,8753196421]]),t.primeSeeds=c,t.primes=u.memoize(e=>{const[t,i,n,r,a,u]=c(e%o.SeedCount);return[...[n/t,r/i,a/n,u/r].map(e=>s.sigFigs(e,6)),n]},1*n.minuteMs,256)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.digits=void 0,t.digits=function(e,t,i){const n=[];for(;e>0;){const i=e%t;n.push(i),e=Math.floor(e/t)}for(;null!=i&&n.length<i;)n.push(0);return n.reverse()}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagUrls=void 0;const n=i(0),r=i(87);t.TagUrls=class{constructor(e){this.id=e}nextAssetBatch(e){const t={};return n.map(e,e=>t.capturedAtLt=e.getTime()),r.joinQuery("/tag-gallery/"+this.id,t)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.LogTail=void 0;const r=i(46),s=i(64),o=i(31),a=i(19),u=i(53),l=i(4),c=i(37),d=i(2),h=i(54),f=i(0),p=i(41),m=i(25),g=i(17),v=i(43),y=i(26),b=i(125),w=i(51),S=i(29),P=i(9),M=i(88),E=i(143),x=i(157),_=i(77),T=i(167),D=i(124);class O extends g.EndableWrapper{constructor(){super("LogTail",()=>this.onEnd(),g.EndableRanks.logger),this.watchers=new Map,this.file2pos=new Map,this.lastReadFiles=new E.TTLSet(5*l.secondMs),this.mutex=new v.Promises,this.setup=d.lazy(()=>n(this,void 0,void 0,(function*(){yield M.readSystemSettings();const e=P.Settings.logDir.valueOrDefault;yield s.mkdirpSync(e),this.root=yield b.DirectoryEntry.for(e)}))),T.setLogTailEnabled(!0),this.scan(!0),this.flushTimeout=u.setInterval(()=>this.flush(),_.DefaultLogFlushMs/2),this.scanTimeout=u.setInterval(()=>this.scan(),l.minuteMs)}flush(){return n(this,void 0,void 0,(function*(){this.write(T.popExpiredLogEntries())}))}readable(e){return(e.endsWith(".log")||e.endsWith(".log.gz"))&&!e.includes(o.sep+S.serviceName()+"-"+a.pid+"-")}watchDir(e){g.ending()||this.ended||h.getOrSet(this.watchers,e,()=>{try{return r.watch(e,(t,i)=>this.watchListener(t,o.join(e,i)))}catch(t){return void console.log("failed to read "+e)}})}scan(e=!1){return n(this,void 0,void 0,(function*(){if(!(g.ending()||this.ended||(yield this.setup(),yield this.root.visitDescendantFiles(t=>n(this,void 0,void 0,(function*(){this.readable(t.nativePath)&&(e&&(yield m.thenMap(t.size(),e=>this.file2pos.set(t.nativePath,e))),w.nowish(yield t.mtimeMs())&&this.watchDir(t.dir))}))),g.ending()||this.ended))){try{const e=o.join(this.root.nativePath,y.datestamp());yield s.mkdirp(e),this.watchDir(e)}catch(e){console.error("Failed to create the current log dir",e)}g.ending()||this.ended||e&&console.log("Tailing "+this.root+"/**/*.log...")}}))}onEnd(){return n(this,void 0,void 0,(function*(){f.map(this.flushTimeout,u.clearInterval),this.flushTimeout=void 0,f.map(this.scanTimeout,u.clearInterval),this.scanTimeout=void 0;for(const e of this.watchers.values())e.close();this.watchers.clear();for(const e of this.lastReadFiles)yield this.watchListener("onEnd",e);this.write(T.popExpiredLogEntries(0))}))}write(e){for(const t of e)console.log(x.DefaultLogFormatter().formatLogEntry(t))}watchListener(e,t){return n(this,void 0,void 0,(function*(){this.readable(t)&&(yield this.mutex.serialByName(t,()=>n(this,void 0,void 0,(function*(){try{const e=yield b.DirectoryEntry.for(t);if(null==e)return;const i=yield e.size();if(null==i||i<=0)return;const n=f.orElse(this.file2pos.get(e.nativePath),()=>0);if(p.gte(n,i))return;yield m.thenMap(D.readLogEntries(e,{start:n,end:i}),e=>T.pushLogEntries(...e)),this.lastReadFiles.add(e.nativePath),this.file2pos.set(e.nativePath,i)}catch(e){console.error("Failed to read "+t+": "+c.errorToVerbose(e))}}))))}))}}t.LogTail=O,O.instance=d.lazy(()=>new O)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.rpcServer=void 0;const r=i(6),s=i(330),o=i(29),a=i(9),u=i(2),l=i(331),c=u.lazy(()=>r.mkLogger("RpcServer"));t.rpcServer=u.lazy(()=>n(void 0,void 0,void 0,(function*(){if(!(yield o.isRpcServer()))return;c().info("Setting up RPC...");const e=a.Settings.rpcPort.valueOrDefault,t=new s.Server(e,!0);return t.addSimpleHandlers(l.RpcServiceHandlers()),yield t.start(),c().info("RPC service serving port "+t.port),t})))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileRepository=t.directoryForDate=void 0;const r=i(123),s=i(13),o=i(51),a=i(6),u=i(9),l=i(39),c=i(1),d=i(0);function h(e){return e.toDateTime().toFormat(u.Settings.assetSubdirectoryDatestampFormat.valueOrDefault).split(/[\\/]/)}t.directoryForDate=h;t.AssetFileRepository=class{constructor(e,t){this.root=e,this.copyAssets=t,this.logger=a.mkLogger("AssetFileRepository")}directoryForDate(e){return this.root.join(...h(e))}importFile(e){return n(this,void 0,void 0,(function*(){const t=this.copyAssets();if(this.logger.debug("importFile()",{file:e,copyAssets:t}),!t)return e;if(yield e.isDescendantOf(this.root))return this.logger.debug("no-op: "+e+" already contained by "+this.root),e;this.logger.debug("importing "+e);const i=yield l.readTags(e);if(null==i)throw new Error(e.nativePath+" has no tags (so, no createdAt)");const n=d.map(i.capturedAt,e=>o.toFuzzyDate(e.date));if(null==n)throw new Error(e.nativePath+" has no capturedAt");if(null==n.year||null==n.month||null==n.day)throw new Error(e.nativePath+" capturedAt has insufficient precision: "+i.capturedAt);const s=this.directoryForDate(n);if(null==(yield s.mkdirp()))throw new Error("Cannot create destination directory, "+s.nativePath+" for "+e.nativePath);const a=yield s.children(),u=yield e.size(),c=yield r.filter(a,e=>e.size().then(e=>e===u)),h=yield e.sha();if(c.length>0){const t=yield r.filter(c,e=>e.sha().then(e=>e===h));if(t.length>0){const i=t[0];return this.logger.info(e+" matches "+i),this.handleSidecars(e,i)}}const f=yield s.join(e.base).ensureNew();return this.logger.info("Copying...",{src:e.nativePath,dest:f.nativePath}),yield e.copyFile(f),this.handleSidecars(e,f)}))}handleSidecars(e,t){return n(this,void 0,void 0,(function*(){const i=d.orElse(yield e.sidecars(),[]);for(const e of i)yield this.handleSidecar(e,t);return c.isNotEmpty(i)&&s.emitFileChanged(t.nativePath),t}))}handleSidecar(e,t){return n(this,void 0,void 0,(function*(){for(const i of d.orElse(yield t.sidecars(),[]))if(yield l.sidecarEql(e,i))return void this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:i,dest:t});const i=yield t.parent().join(t.name+e.ext).ensureNew({emptyIsNew:!0});return e.copyFile(i)}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.healthChecksArePaused=t.resumeHealthChecks=t.pauseHealthChecks=void 0;const n=i(4);let r=0;t.pauseHealthChecks=function(e=2*n.minuteMs){r=Date.now()+e},t.resumeHealthChecks=function(){r=0},t.healthChecksArePaused=function(){return Date.now()<=r}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sendRecentLogs=t.pleaseSendMessage=void 0;const r=i(269),s=i(23),o=i(287),a=i(272),u=i(288);function l(){return"User requested recent logs at "+(new Date).toISOString()+s.PleaseSendErrorFlag}t.pleaseSendMessage=l,t.sendRecentLogs=function(){return n(this,void 0,void 0,(function*(){const e=l(),t=yield u.annotateEvent({message:e,breadcrumbs:yield u.mkBreadcrumbs()});return a.sentryEnabled()?r.captureEvent(t):yield o.EventStore.instance().writeEvent(t),t}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Previews=void 0;const r=i(196),s=i(4),o=i(5),a=i(79),u=i(325),l=i(328);t.Previews=class{constructor(e,t){this.root=e,this.alp=t,this.id2ap=new a.TTLMap(2*s.minuteMs)}build(e){return n(this,void 0,void 0,(function*(){return this.apb(e.assetId,e.assetFiles).build(e)}))}apb(e,t){return new u.AssetPreviewBuilder(this.ap(e),t)}ap(e){const t=this.id2ap.get(r.id2id(e));if(null!=t&&r.idEql(e,t.assetId))return t;{const t=new l.AssetPreviews(this.root,e,this.alp);return o.isNumber(e)||this.id2ap.set(r.id2id(e),t),t}}clearAssetId(e){this.id2ap.delete(e)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviewBuilder=void 0;const r=i(72),s=i(33),o=i(1),a=i(85),u=i(20),l=i(0),c=i(11),d=i(69),h=i(22),f=i(23),p=i(32),m=i(111),g=i(6),v=i(24),y=i(9),b=i(50),w=i(289),S=i(326),P=i(193),M=i(327),E=i(134),x=i(276);class _{constructor(e,t){this.ap=e,this.assetFiles=t,this.logger=g.mkLogger("AssetPreviewBuilder("+e.assetId+")")}[s.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build(e){return d.time("img.AssetPreviewBuilder.build()",()=>n(this,void 0,void 0,(function*(){const t=yield w.sortAssetFiles(yield this.assetFiles);for(;o.isNotEmpty(t);){const i=t.pop();try{return yield this._build(i,e)}catch(e){this.logger.warn("Failed to set shown file to "+i,e)}}return this.logger.throw("none of the files are valid"+f.NonRetriableErrorFlag)})))}_build(e,t){return n(this,void 0,void 0,(function*(){if(null==e)return this.logger.throw("_build(): best was undefined");this.logger.info("_build()",{best:e.uri});const i=yield p.PosixFile.forUri(e.uri);if(null==i)return this.logger.throw("_build: failed to create PosixFile",{best:e});h.isTrue(t.validate)&&(yield x.validFile(i));const n=yield i.size(),s=yield i.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:n,mtime:s,best:e}),null==n||null==s)return this.logger.throw("IE build(): missing stat info for best file "+e);if(null==e.width||null==e.height||null==e.mimetype||null==e.sha)return this.logger.throw("IE build(): missing fields for best file "+i,e);const o=S.fitSizes(e,e.rotation,e.mimetype),d=Object.assign(Object.assign({assetFileId:e.id},c.pick(e,"assetId","uri","width","height","mimetype","sha","rotation")),{path:i.nativePath,mtime:s,filesize:n,fitSizes:o.map(([,e])=>e.name).join(",")});if(!h.isTrue(t.force)&&!y.Settings.forceSync.valueOrDefault){const t=yield this.ap.readInfo.refresh();if(null!=t){if(t.assetId!==d.assetId)throw new Error("IE build(): Mismatched asset IDs for "+e+": "+u.stringify({priorInfo:t,info:d}));if(null!=t.sha&&t.sha===d.sha&&t.rotation===d.rotation&&S.equivalentFitSizes(t.fitSizes.split(","),d.fitSizes.split(",")))return this.logger.debug("build(): no-op: SHA and rotation match.",{info:d,priorInfo:t}),yield this.ap.writeInfo(d),d}}const f=new m.PushProgressObserver({path:i.nativePath,op:"Building previews for"},P.ImageSize.sq().length+P.ImageSize.fit().length);if(this.logger.debug("Rebuilding all previews from "+e.uri,{assetId:e.assetId,best:e,info:d}),null==(yield this.ap.parent.mkdirp()))throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+e);const g=yield this.ap.existingFiles(),w=yield E.sharpReadable(i,P.ImageSize.largestFit().max);if(null==w)throw new b.WrappedError({message:"build(): "+e+" is not readable by sharp.",retriable:!1});const _=r(w.nativePath).toColorspace("srgb");e.mimetype.startsWith("image/")&&null!=e.rotation&&0!==e.rotation&&(_.rotate(e.rotation),this.logger.debug("build(): rotating "+e.rotation+"Â°")),w.name.toLowerCase().includes("thumbnail")&&v.Try(()=>_.trim(1));const T=[];let D,O;const F=c.pick(e,"width","height");{let e=_.clone(),t=F;for(const[i,n]of o){const r=Date.now(),s=t,o=this.ap.fileForWidth(n.reducer.name,i.width).wip();if(e=yield M.applyAndClone(n.resize(i,e)),t=i,null==O){null!=P.ImageSize.largestSq().outputSize(i)?(O=e.clone(),D=i):(O=_,D=F)}yield n.toJpeg({path:o.nativePath,sh:e.clone(),outputSize:i}),f.onProgress(),this.logger.debug("resize("+n.name+") "+a.dimToS(s)+" -> "+a.dimToS(i)+" in "+(Date.now()-r)+" ms"),T.push(o)}}null==O&&(O=_,D=F);for(const e of P.ImageSize.sq()){const t=Date.now(),i=D,n=e.outputSize(l.orElse(D,F));if(null==n)continue;const r=this.ap.fileForWidth(e.reducer.name,n.width).wip();O=yield M.applyAndClone(e.resize(n,O)),D=n,yield e.toJpeg({path:r.nativePath,sh:O.clone(),outputSize:n}),f.onProgress(),T.push(r),this.logger.debug("resize("+e.name+") "+a.dimToS(i)+" -> "+a.dimToS(n)+" in "+(Date.now()-t)+" ms")}return yield Promise.all(g.map(e=>e.unlink())),yield Promise.all(T.map(e=>e.unwip())),yield this.ap.writeInfo(d),d}))}}t.AssetPreviewBuilder=_},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.equivalentFitSizes=t.fitSizes=void 0;const n=i(1),r=i(85),s=i(5),o=i(193);function a(e){return"qhd"===e?"wvga":"uhd"===e?"uhd4k":e}t.fitSizes=function(e,t,i){const n=o.ImageSize.fit().map(t=>[t.outputSize(e),t]).filter(([e])=>null!=e);let a=e;return n.filter(([e],n)=>function(e,n){const o=r.dmegapixels(a)/r.dmegapixels(e),u=0===n&&("image/jpeg"!==i||s.gt0(t))||o>3||r.dmegapixels(e)-r.dmegapixels(a)>2.5;return u&&(a=e),u}(e,n))},t.equivalentFitSizes=function(e,t){return n.includesAll(n.compactBlanks(e).map(a),n.compactBlanks(t).map(a))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sharpFromBuffer=t.applyAndClone=void 0;const r=i(72),s=i(11);function o(e,t){return r(e,{raw:s.pick(t,"width","height","channels")})}t.applyAndClone=function(e){return n(this,void 0,void 0,(function*(){const t=yield e.raw().toBuffer({resolveWithObject:!0});return o(t.data,t.info)}))},t.sharpFromBuffer=o},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviews=t.previewTimers=void 0;const r=i(196),s=i(1),o=i(173),a=i(96),u=i(2),l=i(0),c=i(12),d=i(8),h=i(69),f=i(6),p=i(10),m=i(260);t.previewTimers=new h.PromiseTimer;t.AssetPreviews=class{constructor(e,t,i){this.previewsRoot=e,this.alp=i,this.readInfo=u.lazy(()=>this.infoJson().readJSON("debug")),this.logger=f.mkLogger("AssetPreviews(assetId:"+r.id2id(t)+")"),this.assetId=r.id2id(t),this.urls=new o.AssetUrls(t);const n=p.leftPad(this.assetId,8,"0"),s=p.splitEvery(n,3);this.basename=s.pop()+"-",this.parent=e.join(...s)}existingFiles(){return d.thenOrElse(this.parent.childFiles(e=>e.base.startsWith(this.basename)),()=>[])}existingJpgs(){return d.thenOrElse(this.parent.childFiles(e=>e.base.startsWith(this.basename)&&".jpg"===e.ext),()=>[])}previews(){return n(this,void 0,void 0,(function*(){const e=yield this.existingFiles();return d.sortByAsync(s.compact(e.map(e=>m.extractPreviewInfo(this.previewsRoot,e))),e=>null==e?void 0:e.file.size())}))}deleteAll(){return n(this,void 0,void 0,(function*(){this.parent.clear();const e=yield this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return yield Promise.all(e.map(e=>e.unlink())),e}))}file(e){return this.parent.join(this.basename+e)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(e){return this.readInfo.unset(),this.infoJson().writeJsonMaybe(e,{spaces:2})}fileForWidth(e,t){return this.file(e+"-w"+t+".jpg")}filesForReducer(e){const t=this.basename+e+"-";return this.existingFiles().then(e=>e.filter(e=>e.base.startsWith(t)))}smallestFileForReducer(e){return n(this,void 0,void 0,(function*(){return c.leastBy(yield this.filesForReducer(e),e=>l.orElse(l.map(m.extractPreviewInfo(this.previewsRoot,e),e=>e.width),0))}))}largestFileForReducer(e){return n(this,void 0,void 0,(function*(){return c.greatestBy(yield this.filesForReducer(e),e=>l.orElse(l.map(m.extractPreviewInfo(this.previewsRoot,e),e=>e.width),0))}))}widths(e){return n(this,void 0,void 0,(function*(){const t=yield this.filesForReducer(e);return s.sort(s.compact(t.map(e=>l.map(m.extractPreviewInfo(this.previewsRoot,e),e=>e.width))))}))}posterLink(){return n(this,void 0,void 0,(function*(){const e=yield this.widths(a.ReducerNames.fit);return this.urls.imgLink(a.ReducerNames.fit,Math.max(...e))}))}imgAttrs(e,t=!1,i=!0){return n(this,void 0,void 0,(function*(){if(t||e!==a.ReducerNames.sq){const t=e===a.ReducerNames.fit?yield this.readInfo():void 0;return this.urls.imgAttrs(e,yield this.widths(e),i,t)}return this.urls.sqImgAttrs(i)}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BroadcasterImpl=void 0;const n=i(8),r=i(161),s=i(320);t.BroadcasterImpl={broadcast:(e,t)=>n.thenMapOr(s.rpcServer(),i=>i.broadcast(e,t),()=>n.thenMap(r.rpcClient(),i=>i.broadcast(e,t)))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Server=t.ClientConnection=void 0;const r=i(261),s=i(19),o=i(1),a=i(3),u=i(4),l=i(20),c=i(75),d=i(2),h=i(0),f=i(11),p=i(156),m=i(7),g=i(17),v=i(8),y=i(69),b=i(26),w=i(23),S=i(13),P=i(102),M=i(61),E=i(99),x=i(6),_=i(57),T=i(16),D=i(29),O=i(9),F=i(127),I=x.mkLogger("rpc.Server"),k=({params:e,conn:t})=>(a.mapNotBlank(e.serviceName,e=>{a.blank(t.serviceName)&&(t.serviceName=e)}),T.mapGt0(e.pid,e=>{a.blank(t.pid)&&(t.pid=e)}),`pong to ${t.serviceName}@${t.pid} from ${D.serviceName()}@${s.pid} at ${new Date}`);class C{constructor(e){this.socket=e}toString(){return a.blank(this.serviceName)?M.remoteDesc(this.socket):`${this.serviceName}:${this.pid}`}}t.ClientConnection=C;t.Server=class{constructor(e,t=!0){this.port=e,this.unref=t,this._ended=!1,this._ready=new c.Latch,this.connections=[],this.onPause=()=>this.broadcast("pause"),this.onResume=()=>this.broadcast("resume"),this.handlers=new Map,this.sid=d.lazy(()=>_.Radix58.randomChars(12)),this.start=p.throttle(()=>n(this,void 0,void 0,(function*(){if(!this.ended)return I.debug("start("+this.port+")"),this.server=r.createServer(this.onConnect.bind(this)),this.server.on("listening",()=>{I.info("listening on "+this.port),this._ready.resolve()}),this.server.on("error",e=>n(this,void 0,void 0,(function*(){I.warn("error, rejecting ready"),this._ready.reject(),yield this.onError("createServer"+w.FatalErrorFlag,e)}))),this.server.listen(this.port,O.Settings.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise})),5e3),this.end=d.lazy(()=>n(this,void 0,void 0,(function*(){this._ended=!0,S.eventEmitter.removeListener("pause",this.onPause),S.eventEmitter.removeListener("resume",this.onResume),yield this.closeAllConnections(),yield M.close(this.server)}))),this.name="Server:"+e,this.addHandler("ping",k),this.addSimpleHandler("broadcast",e=>(S.eventEmitter.emit(e.event,e.args),this.broadcast(e.event,e.args))),S.onPause(this.onPause),S.onResume(this.onResume),g.addFirstEndable(this),F.setBroadcaster(this)}get connectionCount(){return this.connections.length}serialize(e){return n(this,void 0,void 0,(function*(){return l.stringify(Object.assign({sid:this.sid()},e))+"\n"}))}addHandler(e,t){const i=this.handlers.get(e);null!=i&&I.warn("addHandler(): overwriting",{method:e,prior:i,newHandler:t}),this.handlers.set(e,t)}addSimpleHandler(e,t){this.addHandler(e,({params:e})=>t(e))}addSimpleHandlers(e){f.entries(e).forEach(([e,t])=>this.addSimpleHandler(e,t))}get ended(){return this._ended||g.ending()}get ready(){return this._ready.promise}closeAllConnections(){const e=this.connections.map(e=>M.end(e.socket));return this.connections.length=0,Promise.all(e)}broadcast(e,t){return this.sendAll({event:e,args:t})}sendAll(e,t="write"){return n(this,void 0,void 0,(function*(){const i=yield this.serialize(e),n=[...this.connections];let r=n.length;I.debug("sendAll()",{pojo:e,method:t});for(const e of n)try{e.socket.writableEnded?r--:e.socket[t](i,()=>r--)}catch(e){r--}const s=u.secondMs;return v.until(()=>r<=0,s)}))}onConnect(e){I.info("Connection from "+M.remoteDesc(e)),this.unref&&e.unref();const t=new C(e);this.connections.push(t),e.on("end",()=>{I.info("Closing connection from "+M.remoteDesc(e)),o.filterInPlace(this.connections,t=>t.socket!==e)}),e.on("error",t=>n(this,void 0,void 0,(function*(){I.warn("on error from "+M.remoteDesc(e)+": "+t),yield this.onError("socket",t),e.end()})));try{P.onDataChunked(e,"\n",e=>this.onRequest(e,t))}catch(t){I.warn("Caught error from "+M.remoteDesc(e)+": "+t),e.end()}}onRequest(e,t){return n(this,void 0,void 0,(function*(){if(I.debug("onRequest()",e),a.blank(e))return;let i="missing",n="missing";try{const r=JSON.parse(e);return a.mapNotBlank(r.id,e=>i=e),a.mapNotBlank(r.method,e=>n=e),yield y.time("rpc."+n,()=>this.handle(i,n,r.params,t))}catch(n){I.warn("invalid request",{line:e,error:n}),t.socket.write(yield this.serialize({id:i,error:h.orElse(n.message,()=>m.toS(n))}))}}))}handle(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=this.handlers.get(t);if(null==n)throw I.warn("bad handler request",{method:t,params:i,supported:f.keys(this.handlers)}),new Error("No handler for "+t);const{elapsedMs:s,result:o}=yield b.elapsedAsync(()=>n({id:e,method:t,params:i,conn:r}));I.log(E.ms2level(s,u.secondMs),"handle()",{method:t,conn:m.toS(r),elapsedMs:s,id:e,params:i,result:o}),r.socket.write(yield this.serialize({id:e,result:o}))}))}onError(e,t){return n(this,void 0,void 0,(function*(){this.ended||w.onError(e,t)}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RpcServiceHandlers=void 0;const n=i(6),r=i(9),s=i(67),o=i(95),a=i(117),u=i(2),l=i(162),c=i(257),d=u.lazy(()=>n.mkLogger("RpcServiceHandlers"));t.RpcServiceHandlers=u.lazy(()=>({libraryPath:()=>r.Settings.libraryPath.value,healthChecks:()=>c.libraryHealthChecks(),isVacuuming:()=>d().tap({msg:"isVacuuming",level:"warn",result:l.isVacuuming()}),mountpoints:()=>s.mountpoints(),volumes:()=>o.volumes(),paused:()=>a.isPaused()}))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDbJanitor=void 0;const r=i(60),s=i(17),o=i(8),a=i(6),u=i(29),l=i(9),c=i(95),d=i(4),h=i(2),f=i(0),p=i(278),m=i(337),g=i(174),v=i(218),y=i(339),b=i(164),w=i(197);class S{constructor(e,t,i){this.dataDir=e,this.isLockOwner=t,this.localDbDir=i,this.endTimeoutMs=d.minuteMs,this.end=h.lazy(()=>f.map(this.backup.value,e=>e.end())),this.setup=h.lazy(()=>n(this,void 0,void 0,(function*(){var e;try{yield this._setup(),this.logger.info("ModelDb reading from "+(null===(e=this.db.value)||void 0===e?void 0:e.dbfile))}catch(e){this.db.reject(e),this.backup.reject(e),this.logger.throw(e,{fatal:!0,from:"ModelDbJanitor.setup"})}}))),this.beforeBackup=()=>n(this,void 0,void 0,(function*(){yield b.AdvisoryLock.vacuum()})),this.backupAndMigrate=()=>n(this,void 0,void 0,(function*(){return u.isMainService()||(yield this.isLockOwner())})),this.name="ModelDbJanitor("+e+")",this.logger=a.mkLogger(this.name),this.db=new r.Deferred(this.name+".db"),this.backup=new r.Deferred(this.name+".backup"),this.srcDbFile=g.pathToDb(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),s.addDbEndable(this),this.setup()}static for(e,t,i=y.localDbDir){return n(this,void 0,void 0,(function*(){const n=new S(e,t,i);return yield n.setup(),n}))}get ended(){return null!=this.end.prior()}_setup(){return n(this,void 0,void 0,(function*(){if(l.Settings.forceLocalDbReplica.valueOrDefault||!0===(yield o.thenMap(c.volumeFor(this.srcDbFile.nativePath),e=>e.remote))){const e=yield this.localDbDir();return this.localDbReplica=g.pathToDb(e,"models"),this.logger.info("Library on remote drive. Using local db replica.",{src:this.srcDbFile.nativePath,local:this.localDbReplica}),(yield this.backupAndMigrate())&&(this.logger.info("Setting up local model db replica...."),yield this.localDbReplica.parent().rmrf("info"),yield v.backupDbCold(this.srcDbFile,this.localDbReplica.parent()),this.logger.info("Local model db replica set up at "+this.localDbReplica)),this._finishSetup(e,this.srcDbFile.parent())}return this._finishSetup(this.dataDir)}))}_finishSetup(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.backupDir.mkdirp();if(null==i)throw new Error("Failed to create models DB backup dir "+this.backupDir);const n=new p.Db("models",e);yield n.setup(),(yield this.backupAndMigrate())?(yield n.migrate(),this.backup.resolve(new m.DbBackup(n,this.backupAndMigrate,n.dbfile,i,t,this.beforeBackup))):this.backup.resolve(void 0),w.setModelDb(n),this.db.resolve(n),this.logger.info("Finished setup",{primaryDbDir:e,replaceDbDir:t,backupDir:i})}))}}t.ModelDbJanitor=S},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.optimizeDb=t.setPragmas=void 0;const r=i(6),s=i(9),o=i(35),a=i(153);t.setPragmas=function(e){const t=['encoding = "UTF-8"',"threads = 4","foreign_keys = ON","page_size = "+16*o.KiB,"trusted_schema = 0","cache_size = -"+s.Settings.dbCacheSizeMb.valueOrDefault*(o.MiB/o.KiB),"locking_mode = NORMAL","journal_mode = WAL","busy_timeout = "+s.Settings.dbTimeoutMs.valueOrDefault,"synchronous = NORMAL","case_sensitive_like = ON","auto_vacuum = NONE"];return a.handleDbRetriesSync(()=>{for(const i of t)e.pragma(i)}),e},t.optimizeDb=function(e){return n(this,void 0,void 0,(function*(){const t=["wal_checkpoint(RESTART)","optimize"],i=r.mkLogger("optimizeDb()");yield a.handleDbRetries(()=>{i.warn("optimize starting...");for(const i of t)e.pragma(i);i.warn("optimize finished.")})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Migration=void 0;const r=i(13),s=i(6),o=i(50),a=i(1),u=i(3),l=i(37),c=i(20),d=i(2),h=i(0),f=i(38),p=i(7),m=i(335),g=i(8),v=i(4);t.Migration=class{constructor(e,t,i){this.migrationsDir=e,this.db=t,this.dbFile=i,this.fsMigrations=d.lazy(()=>this.migrationsDir.children(e=>".sql"===e.ext)),this.logger=s.mkLogger("Migration("+c.stringify({schema:e.base,db:i.nativePath})+")"),t.exec("\nCREATE TABLE IF NOT EXISTS migrations (\n  id integer NOT NULL PRIMARY KEY, \n  name varchar(255) NOT NULL, \n  migration_time integer NOT NULL \n)\n"),this.addMigrationStmt=t.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}apply(e){return n(this,void 0,void 0,(function*(){const t=[],i=this.db.prepare("SELECT name from migrations").pluck().all(),n=yield this.fsMigrations();if(null==n)throw new Error("no migration files found for "+this.migrationsDir);this.logger.debug("_apply()",{migrationsDir:this.migrationsDir,migrationFiles:n.map(e=>e.baseWithParent)});for(const r of n)i.includes(r.name)?this.logger.debug("latest(): already applied "+r.base):(yield h.map(e,e=>e(r)),yield g.thenOrTimeout(this.applyMigration(r),5*v.minuteMs,()=>{throw new o.WrappedError({fatal:!0,ignorable:!1,message:"Migration "+r.name+" timed out."})}),t.push(r.base));return this.logger.info("up to latest!",{appliedMigrations:t}),t}))}applyMigration(e){return n(this,void 0,void 0,(function*(){r.emitMigration(e.name);try{const t=Date.now(),i=m.Migrations[e.name.replace(/^[\d_-]+/,"")],n=f.isFunction(i);return n?yield i.bind(m.Migrations)(this.db):yield this.applySqlMigration(e),this.logger.debug("applyMigration() completed",{elapsedMs:Date.now()-t,codeMigration:n,migration:e.baseWithParent}),this.db.transaction(()=>{this.addMigrationStmt.run(e.name,Date.now())})()}catch(t){return this.logger.throw("Failed to apply migration "+e.baseWithParent,l.errorToVerbose(t))}}))}applySqlMigration(e){return n(this,void 0,void 0,(function*(){const t=e.base.includes("_nofk");try{const i=p.toS(yield e.readFile());if(u.blank(i))return void this.logger.error("Empty migration: "+e);t&&this.db.pragma("foreign_keys = OFF"),this.db.transaction(()=>{for(const e of a.compactBlanks(i.split(";")))try{this.db.exec(e)}catch(t){throw new o.WrappedError({cause:t,fatal:!0,message:"Failed to apply DDL: "+e})}if(t){const t=this.db.pragma("foreign_key_check");if(a.isNotEmpty(t))throw this.logger.error("foreign_key_check failed",t),new Error("Foreign key checks failed during migration "+e.name)}}).immediate()}finally{t&&this.db.pragma("foreign_keys = ON")}}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Migrations=t.plucklabmodeb6=t.lowercase_psnet_function=void 0;const r=i(26),s=i(51),o=i(179),a=i(180),u=i(6),l=i(172),c=i(16),d=i(9),h=i(88),f=i(10),p=i(2),m=i(0),g=i(5),v=i(18),y=i(87),b=p.lazy(()=>u.mkLogger("Migrations")),w=new RegExp(`^(${y.PS_NETWORK_FILESYSTEM_PROTOCOL}//.*?/)(.*)$`);function S(e,t){return c.mapGt0(e,()=>m.map(function(e,t=a.ModeBits){return l.splitBits(e,t).map(e=>o.unlabhash(e,t))}(e,6)[t],e=>o.labhash(e,a.ModeBits)))}t.lowercase_psnet_function=e=>v.Opt(e).filter(f.isString).flatMap(e=>w.exec(e)).map(e=>e[1].toLowerCase()+e[2]).getOrElse(()=>e),t.plucklabmodeb6=S,t.Migrations={lowercase_psnet_hostname:e=>{e.function("lowercase_psnet_hostname",{deterministic:!0},t.lowercase_psnet_function),e.transaction(()=>{e.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),e.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),e.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")})()},force_stable_channel:()=>n(void 0,void 0,void 0,(function*(){try{yield h.readSystemSettings();const e=d.Settings.updateChannel.value;"stable"!==e&&(d.Settings.updateChannel.value="stable",yield h.writeSystemSettings(),b().info("force_stable_channel(): reset updateChannel",{priorValue:e}))}catch(e){b().error("force_stable_channel(): failed: "+e)}})),numeric_captured_at:e=>{e.function("isoToLocal",{deterministic:!0},r.isoToLocal),e.function("isoToOffsetMinutes",{deterministic:!0},s.isoToOffsetMinutes),e.function("isoToPrecisionMs",{deterministic:!0},r.isoToPrecisionMs),e.transaction(()=>{e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),e.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),e.exec("DROP INDEX asset_captured_at_geohash_idx"),e.exec("DROP INDEX assetfile_exifuid_idx"),e.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")})()},spread_modes:e=>{e.function("plucklabmodeb6",{deterministic:!0},S),e.transaction(()=>{g.times(a.ModeCount,t=>e.exec(`ALTER TABLE AssetFile ADD COLUMN mode${t} integer`)),e.exec("UPDATE AssetFile SET "+g.times(a.ModeCount,e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`).join(", "))})()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqliteSuffixes=void 0,t.SqliteSuffixes=["-wal","-journal"]},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DbBackup=t.stamp=t.DefaultRetentionCount=t.DefaultBackupFrequencyMs=void 0;const r=i(17),s=i(198),o=i(43),a=i(26),u=i(338),l=i(9),c=i(4),d=i(2),h=i(218),f=i(280);t.DefaultBackupFrequencyMs=1*c.hourMs,t.DefaultRetentionCount=32,t.stamp=function(e=new Date){return"."+a.filestampUTC(e)+"-"};class p extends s.EndableInterval{constructor(e,t,i,s,a,h=(()=>{}),f=(()=>{})){super({name:"DbBackup("+i+")",callback:()=>this.backup(),intervalMs:l.Settings.dbBackupIntervalMinutes.valueOrDefault*c.minuteMs,rank:r.EndableRanks.predb,unref:!0}),this.db=e,this.isLockOwner=t,this.srcDbFile=i,this.backupsDir=s,this.replaceDir=a,this.beforeBackup=h,this.onBackupFinished=f,this.endTimeoutMs=c.minuteMs,this.mutex=new o.Promises,this.hanoi=d.lazy(()=>u.Hanoi.for(this.backupsDir,l.Settings.dbBackupsCount.valueOrDefault)),this.onEnds.push(()=>n(this,void 0,void 0,(function*(){yield this.mutex.serial("DbBackup.end()",()=>this._backup())})))}backup(){return this.mutex.maybeRun("DbBackup.backup()",()=>this._backup())}_backup(e=this.ended){return n(this,void 0,void 0,(function*(){if(yield this.isLockOwner())if(e||this.db.open)if(yield this.srcDbFile.clear().isEmpty())this.logger.warn("backup(): db is missing.",this.srcDbFile.nativePath);else try{this.logger.info("backup(): housekeeping...",{srcDb:this.srcDbFile.nativePath,backupsDir:this.backupsDir.nativePath}),yield this.beforeBackup(),yield this.db.vacuum(),e&&this.db.open&&(yield this.db.closeDb());const t=this.srcDbFile.parent().join("backup",this.srcDbFile.base);this.logger.info("backup(): starting backup to "+t),yield h.backupDb(this.srcDbFile,t),this.logger.info("backup(): backup taken. Verifying "+t),yield h.verifyDb(t),null!=this.replaceDir&&(this.logger.info("backup(): Copying to "+this.replaceDir),yield h.backupDbCold(t,this.replaceDir));const i=yield f.sqliteFiles(t),n=yield this.hanoi(),r=n.next("").toFilename();this.logger.info("backup(): Rotating files to "+this.backupsDir.join(r));for(const e of i)yield e.mv(this.backupsDir.join(r+e.base),{overwrite:!0});for(const e of yield n.staleFiles())this.logger.info("backup(): removing stale backup "+e),yield e.unlink();this.logger.info("backup(): finished successfully")}catch(e){this.logger.throw(e,{from:"DbBackup._backup() failed",fatal:!0,srcDb:this.srcDbFile.nativePath})}else this.logger.warn("backup(): db is already closed.",this.db.name);else this.logger.info("backup(): not lock owner, no-op.")}))}}t.DbBackup=p},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Hanoi=t.HanoiFile=void 0;const r=i(1),s=i(2),o=i(0),a=i(5),u=i(15),l=i(12),c=i(8),d=i(26),h=i(52),f=i(100);class p{constructor(e,t,i,n=d.filestampUTC()){this.seq=e,this.set=t,this.name=i,this.stamp=n}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return this.fromBasename(e.base)}static fromBasename(e){return o.map(this.parseRe.exec(e),e=>new p(parseInt(e[2],10),parseInt(e[3],10),e[4],e[1]))}}t.HanoiFile=p,p.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;class m{constructor(e,t,i){this.dir=e,this.sets=t,this.seq=i,this.mods=s.lazy(()=>a.times(this.sets,e=>Math.pow(2,e)).reverse())}static for(e,t){return n(this,void 0,void 0,(function*(){return new m(e,t,o.orElse(yield m.maxSeq(e),-1))}))}static maxSeq(e){return n(this,void 0,void 0,(function*(){return h.max([...u.toA(yield c.thenMap(e.childNames(),e=>e.map(e=>{var t;return null===(t=p.fromBasename(e))||void 0===t?void 0:t.seq})))])}))}set(e){return this.sets-this.mods().findIndex(t=>e%t==0)}next(e){const t=++this.seq;return new p(t,this.set(t),e)}hanoiFiles(){return n(this,void 0,void 0,(function*(){const e=yield this.dir.clear().childNames();return r.compact(null==e?void 0:e.map(e=>p.fromBasename(e)))}))}validHanoiFiles(e){return n(this,void 0,void 0,(function*(){const t=yield c.thenOrElse(e,()=>this.hanoiFiles()),i=f.groupBy(t,e=>e.set),n=[];for(const e of i.keys())o.map(l.greatestBy(i.get(e),e=>e.seq),e=>n.push(e));return n}))}staleHanoiFiles(e){return n(this,void 0,void 0,(function*(){const t=yield c.thenOrElse(e,()=>this.hanoiFiles()),i=(yield this.validHanoiFiles(e)).map(e=>e.seq);return t.filter(e=>!i.includes(e.seq))}))}staleFiles(){return n(this,void 0,void 0,(function*(){return this.staleHanoiFiles().then(e=>e.map(e=>e.toFile(this.dir)))}))}}t.Hanoi=m},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.localDbDir=void 0;const r=i(47),s=i(32),o=i(2);t.localDbDir=o.lazy(()=>n(void 0,void 0,void 0,(function*(){const e=s.PosixFile.for(r.App.getPath("userData")).join("local-db");return yield e.join("README.txt").writeTxt("\nThis folder is only used when your library is on a remote filesystem.\n\nYou will corrupt your library if you remove this directory while PhotoStructure is\nrunning.\n\nIf you have any questions, please visit <https://support.photostructure.com/>."),e})))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupModelJson=void 0;const n=i(6),r=i(314),s=i(315),o=i(267),a=i(164),u=i(114),l=i(122),c=i(181),d=i(341),h=i(285),f=i(264),p=i(265),m=i(286),g=i(131);t.setupModelJson=function(){for(const e of[a.AdvisoryLock,u.Asset,l.AssetFile,h.Heartbeat,c.AssetTag,r.DirStat,d.Example,m.Progress,g.Tag,s.Queue,o.QueueItem])try{f.addModelClass(e),p.ModelOpsLocal.forModel(e,e.db)}catch(t){n.mkLogger("setupModelJson").throw(t,e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Example=void 0;const n=i(92);class r extends n.TimestampedModel{}t.Example=r,r.tableName="Example",r.uniqueColumnName="name",r.booleanFields=["isExample"]},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setupVolumeRpc=void 0;const r=i(29),s=i(67),o=i(95),a=i(2),u=i(0),l=i(161);t.setupVolumeRpc=a.lazy(()=>{s.setRpcMountpointsImpl(r.isRpcClient()?c:void 0),o.setRpcVolumesImpl(r.isRpcClient()?d:void 0)});const c=()=>n(void 0,void 0,void 0,(function*(){return(yield l.rpcClientReady())?u.map(l.rpcClient(),e=>e.request("mountpoints")):void 0})),d=()=>n(void 0,void 0,void 0,(function*(){return(yield l.rpcClientReady())?u.map(l.rpcClient(),e=>e.request("volumes")):void 0}))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.statsDbJanitor=void 0;const r=i(17),s=i(198),o=i(28),a=i(29),u=i(4),l=i(278),c=i(281);t.statsDbJanitor=function(e){return n(this,void 0,void 0,(function*(){const t=a.isStatsDbMigrator(),i=new l.Db("stats",e);return yield i.setup(),t&&(yield i.migrate(),new s.EndableInterval({name:"statsDbJanitor vacuum",callback:()=>i.vacuum(),intervalMs:o.isTest?20*u.secondMs:5*u.minuteMs,rank:r.EndableRanks.service,unref:!0})),c.setStatsDb(i),i}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Service=t.StartupTimeoutMs=t.setupEventHandlers=void 0;const r=i(19),s=i(175),o=i(47),a=i(17),u=i(8),l=i(295),c=i(59),d=i(23),h=i(13),f=i(319),p=i(6),m=i(24),g=i(14),v=i(29),y=i(9),b=i(88),w=i(10),S=i(65),P=i(27),M=i(293),E=i(117),x=i(50),_=i(3),T=i(4),D=i(34),O=i(37),F=i(75),I=i(2),k=i(0),C=i(7),A=i(159),L=i(130),R=i(323),N=i(288),B=i(234);t.setupEventHandlers=I.lazy(()=>{h.onWriteRecentLogEntries(()=>p.writeRecentLogEntries()),h.onResume(()=>E.resume()),h.onPause(()=>E.pause())}),t.StartupTimeoutMs=P.CmdTimeoutMs;t.Service=class{constructor(e){this.opts=e,this.exitted=!1,this._ready=new F.Latch,this.onFatalHandlers=[],this.inputHandlers=new Map,this.setup=I.lazy(()=>n(this,void 0,void 0,(function*(){const e=()=>!this.exitted&&!a.ending();try{_.mapNotBlank(c.getEnv("PS_FATAL_"+this.name),e=>{throw new x.WrappedError({fatal:!0,message:e})}),_.mapNotBlank(c.getEnv("PS_CRASH_"+this.name),e=>{D.later(()=>{throw new x.WrappedError({message:e})},5*T.secondMs)});{const e=o.App.getName()+(this.name===v.ServiceNames.main?"":" "+this.name);m.Try(()=>r.title=e)}if(yield b.readSystemSettings(),b.libraryHasSettings()&&(yield b.readLibrarySettings()),yield this.setupErrorHandling(),this.logStartup(),v.isMainService()&&(yield this.maybeUpgradeSystemSettings(),yield this.maybeUpgradeLibrarySettings()),t.setupEventHandlers(),M.setDoNotRunImpl(A.doNotRun),yield this.setupStdin(),e()){const e=L.Library.instance();if(null==e&&!v.isWelcomeService())throw new Error("Cannot start, library path is unset"+d.FatalErrorFlag);yield null==e?void 0:e.ready}const i=!e();this.logger.debug("setup done.",{reject:i}),i?this._ready.reject():this._ready.resolve()}catch(e){this._ready.reject(e),yield this.exit(w.ensureSuffix(this.name+" setup failed: "+e,d.FatalErrorFlag),14)}}))),v.setServiceName(this.name=this.opts.name),p.setupLogger(),y.Settings.logDir.addListener(()=>p.setupLogger()),y.Settings.tailLogs.valueOrDefault&&f.LogTail.instance(),this.logger=p.mkLogger("Service("+this.name+")"),this.addDefaultInputHandlers(),u.thenOrTimeout(this.setup(),t.StartupTimeoutMs,()=>this.exit("setup timed out",13))}get ready(){return this._ready.promise}on(e,t){this.onFatalHandlers.push(t)}logStartup(){this.logger.info("setup()",Object.assign({version:S.version,argv:r.argv,arch:r.arch,platform:r.platform,isDocker:g.isDocker(),isPacked:g.isPacked,isElectron:g.isElectron,versions:r.versions,settings:{logLevel:y.Settings.logLevel.valueOrDefault,httpPort:y.Settings.httpPort.valueOrDefault,rpcPort:y.Settings.rpcPort.valueOrDefault,libraryPath:y.Settings.libraryPath.valueOrDefault}},y.psenv()))}maybeUpgradeSystemSettings(){return u.thenMap(b.systemSettingsVersion(),e=>n(this,void 0,void 0,(function*(){e!==S.version&&(yield b.writeSystemSettings())})))}maybeUpgradeLibrarySettings(){return n(this,void 0,void 0,(function*(){return u.thenMap(b.librarySettingsVersion(),e=>n(this,void 0,void 0,(function*(){e!==S.version&&(yield b.writeLibrarySettings())})))}))}setupErrorHandling(){return n(this,void 0,void 0,(function*(){h.eventEmitter.on("fatal",({message:e,error:t})=>this.exit(e+k.map(t,e=>": "+O.errorToS(e)),12)),this.setInputHandler("--send-recent-logs",()=>R.sendRecentLogs()),r.on("unhandledRejection",e=>d.onError("unhandledRejection",e)),r.on("uncaughtException",e=>d.onError("uncaughtException",e)),r.on("SIGINT",()=>this.exit("SIGINT",0)),r.on("SIGTERM",()=>this.exit("SIGTERM",0)),r.on("disconnect",()=>this.exit("disconnect",0)),r.stdin.on("close",()=>this.exit("stdin.close",0)),r.stdin.on("error",e=>this.logger.warn("stdin.error: "+e)),r.stdin.on("disconnect",()=>this.exit("stdin.disconnect",0)),r.stdout.on("disconnect",()=>this.exit("stdout.disconnect",0)),r.stdout.on("error",e=>this.logger.warn("stdout.error: "+e)),r.stderr.on("disconnect",()=>this.exit("stderr.disconnect",0)),r.stderr.on("error",e=>this.logger.warn("stderr.error: "+e)),yield N.installSentry(this)}))}setupStdin(){s.createInterface({input:r.stdin}).on("line",e=>this.onLine(C.toS(e)))}exit(e,t){return n(this,void 0,void 0,(function*(){if(!this.exitted){if(this.exitted=!0,this.logger.info("exit()",{status:t,reason:e,ending:a.ending()}),yield this.logger.flush(),0!==t){yield Promise.all(this.onFatalHandlers.map(t=>t(e)));const i={fatal:!0,exit:!0,status:t,pid:r.pid,ppid:r.ppid};i.error=e,m.Try(()=>B.stdoutWrite(i,!1))}return yield a.endEndables(),r.exit(t)}}))}setInputHandler(e,t){this.inputHandlers.set(e.trim().toLowerCase(),t)}addDefaultInputHandlers(){this.setInputHandler("--version",()=>n(this,void 0,void 0,(function*(){yield this.ready,B.stdoutWrite({version:S.version})}))),this.setInputHandler("--status",()=>n(this,void 0,void 0,(function*(){yield this.ready;const e=yield A.healthChecks();return this.logger.debug("--status",e),B.stdoutWrite({healthChecks:e})}))),this.setInputHandler("--quit",()=>this.exit("--quit from stdin",0)),this.setInputHandler(l.ChildServiceExitCommand,()=>this.exit(l.ChildServiceExitCommand+" from stdin",0)),this.setInputHandler("--pause",()=>(E.pause(),B.stdoutWrite({paused:E.isPaused()}))),this.setInputHandler("--resume",()=>(E.resume(),B.stdoutWrite({paused:E.isPaused()})))}onLine(e){return n(this,void 0,void 0,(function*(){if(this.logger.debug("onLine",e),e.trim().startsWith("--")){const t=e.split(" ",1)[0],i=this.inputHandlers.get(t);null==i?console.warn("unknown command "+e):yield i(e.substr(t.length).trim())}else try{yield k.map(this.opts.stdinReceiver,t=>t(e))}catch(t){this.logger.error("onLine(): failed to process",{line:e,error:t})}}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundRobin=void 0;const n=i(1);t.RoundRobin=class{constructor(){this.arr=[],this.iterIdx=0}get size(){return this.arr.length}count(e){return n.count(this.arr,e)}unshift(...e){this.arr.splice(this.iterIdx,0,...e)}push(...e){this.unshift(...e),this.incrIdx(e.length)}remove(e){return this.filterInPlace(t=>t!==e)}filterInPlace(e){let t=!1;return n.filterInPlace(this.arr,(i,n,r)=>{const s=e(i,n,r);return s||(t=!0,n<this.iterIdx&&this.iterIdx--),s}),this.incrIdx(0),t}next(e=(()=>!0)){if(0===this.size)return{value:void 0,done:!0};for(let t=0;t<this.size;t++){const t=this.arr[this.iterIdx];if(this.incrIdx(),null!=t&&e(t))return{value:t,done:!1}}return{value:void 0,done:!0}}toA(e=(()=>!0)){if(n.isEmpty(this.arr))return[];const t=[];for(let i=0;i<this.size;i++){const n=this.arr[(this.iterIdx+i)%this.arr.length];e(n)&&t.push(n)}return t}incrIdx(e=1){this.iterIdx=0===this.arr.length?0:(this.iterIdx+e)%this.arr.length}}},function(e,t){e.exports=require("@sentry/types")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.allRecentLogEntries=t.recentLogFiles=void 0;const r=i(1),s=i(4),o=i(2),a=i(54),u=i(41),l=i(25),c=i(43),d=i(348),h=i(125),f=i(6),p=i(9),m=i(124),g=o.lazy(()=>f.mkLogger("AllRecentLogEntries"));function v(e=30*s.minuteMs){const t=Date.now()-e;return l.thenMap(h.DirectoryEntry.for(p.Settings.logDir.valueOrDefault),e=>e.filterDescendantFiles(e=>n(this,void 0,void 0,(function*(){return[".log",".log.gz"].includes(e.ext)&&u.gte(yield e.mtimeMs(),t)}))))}t.recentLogFiles=v,t.allRecentLogEntries=function(e=50){return n(this,void 0,void 0,(function*(){yield f.writeRecentLogEntries();const t=()=>new d.BoundedGreatestList(e,e=>e.ts),i=new Map;yield l.thenMap(v(),e=>c.withBoundedConcurrency({name:"allRecentLogEntries()",laters:e.map(e=>()=>l.thenMap(m.readLogEntries(e),n=>{g().info("allRecentLogEntries: importing "+n.length+" entries from "+e),n.forEach(e=>a.getOrSet(i,e.l,t).add(e))}))}));return r.flatten([...i.values()].map(e=>e.vacuum())).sort((e,t)=>u.cmp(e.ts,t.ts))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedGreatestList=void 0;const n=i(41),r=i(12);t.BoundedGreatestList=class{constructor(e,t){this.maxLength=e,this.toValue=t,this.store=[]}vacuum(){return this.sort(),r.retainLastN(this.store,this.maxLength)}sort(){this.store.sort((e,t)=>n.cmp(this.toValue(e),this.toValue(t)))}min(){return Math.min(...this.store.map(this.toValue))}add(...e){for(const t of e)if(this.store.length<this.maxLength)this.store.push(t);else{this.toValue(t)>this.min()&&(this.store.push(t),this.store.length>2*this.maxLength&&this.vacuum())}}}},,function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkQueue=void 0;const r=i(17),s=i(198),o=i(8),a=i(43),u=i(13),l=i(93),c=i(293),d=i(66),h=i(117),f=i(1),p=i(56),m=i(4),g=i(34),v=i(2),y=i(5),b=i(315),w=i(267);class S extends r.EndableWrapper{constructor(e,t,i,o=!1){super(`WorkQueue(${e})`,()=>c.removeIdleListener(this.name),r.EndableRanks.first),this.queueName=e,this._itemIsReady=t,this._processItem=i,this._singleThreaded=o,this.processRate=new l.Rate(2*m.minuteMs),this.queueIsEmpty=!1,this.nextMutex=new a.Promises,this.workItems=new a.Promises,this.queue=v.lazy(()=>b.Queue.ops().upsertOne({name:this.queueName})),this.checkQueueIsEmpty=v.lazy(()=>n(this,void 0,void 0,(function*(){this.queueIsEmpty=f.isEmpty(yield this.peek())})),10*m.secondMs),this.pendingWorkCount=v.lazy(()=>n(this,void 0,void 0,(function*(){const e=yield this.queue(),t=yield w.QueueItem.dbr(t=>t.pluckFirstf(t=>t.where({queueId:e.id}).count()));return this.queueIsEmpty=0===t,t}))),this._maxQueueSize=this._singleThreaded?1:d.maxPending(),this.janitor=new s.EndableInterval({name:"WorkQueueJanitor("+this.queueName+")",callback:this.checkQueueIsEmpty,intervalMs:10*m.secondMs,unref:!0,initialDelayMs:15*m.secondMs}),c.addIdleListener(this)}refresh(){return n(this,void 0,void 0,(function*(){yield this.checkQueueIsEmpty.refresh(),this.queueIsEmpty||u.emitIdle()}))}donePromise(){return n(this,void 0,void 0,(function*(){const e=3*m.secondMs;yield o.until(()=>n(this,void 0,void 0,(function*(){return yield this.checkQueueIsEmpty.refresh(),this.done()})),void 0,e)}))}done(){return this.ended||this.queueIsEmpty&&this.nextMutex.settled&&this.workItems.settled}get runnable(){return!h.isPaused()&&!r.ending()&&!this.done()&&!this.ended&&!this.queueIsEmpty&&this.workItems.pendingCount<this._maxQueueSize}enqueueWork(e){return n(this,void 0,void 0,(function*(){if(f.isNotEmpty(e)){const t=yield this.queue(),i=yield t.upsertWorkItems(e);this.logger.info("enqueueWork()",{items:e,inserted:i})}this.queueIsEmpty=!1,this.pendingWorkCount.unset(),g.later(()=>u.emitIdle())}))}dequeue(e){return n(this,void 0,void 0,(function*(){yield e.delete(),this.pendingWorkCount.unset(),yield this.checkQueueIsEmpty()}))}currentQueueItems(){return this.workItems.pendingNames()}doneCount(){return this.processRate.eventCount}todoCount(){return n(this,void 0,void 0,(function*(){return this.workItems.pendingCount+(yield this.pendingWorkCount())}))}percents(){return n(this,void 0,void 0,(function*(){const e=this.doneCount(),t=yield this.todoCount(),i=y.sigFigs(e/(t+e)*100,2);return{done:e,todo:t,completePct:i,incompletePct:100-i}}))}currentQueueItemIds(){return this.currentQueueItems().map(e=>e.id)}onIdle(){return n(this,void 0,void 0,(function*(){return this.next()}))}peek(e=3*this._maxQueueSize){return n(this,void 0,void 0,(function*(){const t=yield this.queue();return w.QueueItem.ops().all(w.QueueItem.query().whereNotIn("id",this.currentQueueItemIds()).andWhere({queueId:t.id}).limit(e))}))}next(){return n(this,void 0,void 0,(function*(){return this.nextMutex.maybeRun(this.name+".next()",()=>this._next())}))}_next(){return n(this,void 0,void 0,(function*(){if(!this.runnable)return;const e=yield this.peek();0===e.length&&(this.logger.info("_next(): Queue is currently empty"),this.queueIsEmpty=!0);for(const t of e){if(!this.runnable)return;(yield this._itemIsReady(t))&&(this.logger.info("starting "+t.contents),this.workItems.push(t,()=>n(this,void 0,void 0,(function*(){try{this.processRate.onEvent(),yield p.retryOnReject(()=>this._processItem(t),{maxRetries:2})}finally{this.logger.info("finished",t),yield this.dequeue(t)}}))))}}))}}t.WorkQueue=S},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.saveSyncProgress=t.saveProgressOnDone=void 0;const r=i(1),s=i(286);function o(e){return n(this,void 0,void 0,(function*(){const t=yield e.status();r.isNotEmpty(t)&&(yield s.Progress.ops().upsert(t))}))}t.saveProgressOnDone=function(e){e.donePromise().then(()=>o(e))},t.saveSyncProgress=o},,,,,,,,,function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ForceArg=void 0;const r=i(22),s=i(9),o=i(290);t.ForceArg={beforeParse:e=>e.option("--force","Deletes prior cached directory metadata to force directory contents to be re-scanned"),afterParse:e=>n(void 0,void 0,void 0,(function*(){r.isTrue(e.force)&&(s.Settings.forceSync.tmpValue=!0,yield o.clearCacheDirs())}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.NoFilterArg=void 0;const r=i(22),s=i(9);t.NoFilterArg={beforeParse:e=>e.option("--no-filter","Disables import filters. All paths will try to be imported, even if they are too small or are missing tags."),afterParse:e=>n(void 0,void 0,void 0,(function*(){r.isTrue(e["no-filter"])&&(s.Settings.minAssetSizeBytes.tmpValue=0,s.Settings.requireMakeModel.tmpValue=!1,s.Settings.minImageDimension.tmpValue=0,s.Settings.minVideoDimension.tmpValue=0)}))}},,,,,,,,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSuccessResult=t.isErrorResult=void 0;const n=i(3),r=i(5);function s(e){return null!=e&&n.notBlank(e.path)&&n.notBlank(e.error)}t.isErrorResult=s,t.isSuccessResult=function(e){return null!=e&&!s(e)&&n.notBlank(e.path)&&r.gt0(e.assetId)&&r.gt0(e.assetFileId)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSuccessResult=t.isErrorResult=void 0;const n=i(3),r=i(5);function s(e){return null!=e&&r.gt0(e.id)&&n.notBlank(e.error)}t.isErrorResult=s,t.isSuccessResult=function(e){return!s(e)&&null!=e&&r.gt0(e.id)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DirectorySync=void 0;const r=i(17),s=i(8),o=i(74),a=i(23),u=i(6),l=i(375),c=i(52),d=i(100),h=i(28),f=i(16),p=i(10),m=i(66),g=i(117),v=i(1),y=i(3),b=i(4),w=i(20),S=i(75),P=i(2),M=i(0),E=i(5),x=i(68),_=i(15),T=i(35),D=i(122),O=i(426),F=i(429),I=i(351),k=P.lazy(()=>u.mkLogger("DirectorySync"));class C{constructor(e,t,i,s){this.root=e,this.rootUri=t,this.assetFileQueue=i,this.directoryCounter=s,this.start=Date.now(),this.eta=new l.ETA,this._ended=!1,this.saveSyncProgress=P.lazy(()=>I.saveSyncProgress(this),h.isTest?100:b.secondMs),this.doneLatch=P.lazy(()=>new S.Latch(this.logger.context).observe((()=>n(this,void 0,void 0,(function*(){yield this.saveSyncProgress().catch(e=>{a.onError("save initial progress failed",e)}),yield this.directoryCounter.donePromise().catch(e=>{a.onError("directoryCounter donePromise failed",e)}),yield this.saveSyncProgress().catch(e=>{a.onError("directoryCounter save directory counter completion progress failed",e)}),this.logger.info("doneLatch(): directoryCounter is done"),yield this.assetFileQueue.donePromise().catch(e=>{a.onError("assetProcessor donePromise failed",e)}),this.logger.info("doneLatch(): assetProcessor is done")})))())),this.end=P.lazy(()=>n(this,void 0,void 0,(function*(){this._ended||(this._ended=!0,r.end(this.directoryCounter),r.end(this.assetFileQueue),this.logger.info(o.magenta("ended.")))})));const c="DirectorySync("+e+")";this.logger=u.mkLogger(c),r.addFirstEndable(this),I.saveProgressOnDone(this)}static for(e,t){return n(this,void 0,void 0,(function*(){const i=yield e.uri(),n=yield e.directoryEntry();if(null==i||null==n)return void k().warn("Cannot make DirectorySync for "+e,{rootUri:i,rootDE:n});const r=yield F.AssetFileQueue.for(e,t),s=new O.DirectoryCounter(n,r.fileListener.bind(r),500);return new C(e,i,r,s)}))}get name(){return"DirectorySync "+w.stringify({done:this.ended,root:this.root.nativePath})}toString(){return this.name}status(){return n(this,void 0,void 0,(function*(){return[Object.assign(Object.assign({},yield this.syncState()),{dcDone:this.directoryCounter.done(),apDone:yield this.assetFileQueue.done()})]}))}get ended(){return this.doneLatch().settled}donePromise(){return this.doneLatch().promise}done(){return this.doneLatch().settled}get processedCount(){return this.assetFileQueue.processedCount}syncState(){return n(this,void 0,void 0,(function*(){const e=yield this.directoryCounter,t=this.assetFileQueue,i=e.done(),n=yield t.done(),s=i&&n,o=g.isPaused()||r.ending(),a=s?"done":o?"paused":"processing",u=[];s||o||(y.mapNotBlank(this.assetFileQueue.recentProcessedFile,e=>u.push(e)),i||u.push("Scanning "+y.firstNotBlank(this.directoryCounter.recentVisitedDirectory,this.root.nativePath)));const l=n?yield x.thenOpt(D.AssetFile.assetCountByMimetype(this.rootUri)).map(e=>d.groupBy(e,e=>e.mimetype.split("/",1)[0])).map(e=>({image:_.toA(e.get("image")).length,video:_.toA(e.get("video")).length})).getOrElse(()=>({})):{},h=c.max([l.image,t.processedImageCount]),f=c.max([l.video,t.processedVideoCount]),m=[];h+f>0&&m.push("Processed",T.plur(h,"photo"),"and",T.plur(f,"video")+".");const b=yield this.assetFileQueue.pendingCount();b>0&&m.push(i?"":"At least",T.fmt(b),"remain to be processed"),u.push(v.compactBlanks(m).join(" "));const w=yield this.percents(),S=[];return S.push(p.capitalize(a)),s||M.map(this.eta.fmtEstimate(),e=>S.push(e)),Object.assign({uri:this.rootUri,volume:this.root.nativePath,state:a,hed:S.join(", "),dek:u},w)}))}percents(){return n(this,void 0,void 0,(function*(){if(yield this.done())return{completePct:100,incompletePct:0,scanningPct:0};const e=yield this.directoryCounter,t=yield s.thenMap(e.scannedPct(),E.round);if(!f.within(0,100,t))return this.logger.warn("Invalid scannedPct "+t),{completePct:0,incompletePct:0,scanningPct:100};const i=100-t,n=this.processedCount,r=yield this.assetFileQueue.pendingCount(),o=0===r&&0===n?0:E.round(t*(n/(r+n))),a=100-(o+i),u={completePct:o,incompletePct:a,scanningPct:i};if(this.logger.debug("percents(): ",{scannedPct:t,processed:n,pending:r,p:u}),100!==c.sum([u.completePct,u.incompletePct,u.scanningPct])&&this.logger.warn("percents(): BUGGED",{p:u,processed:n,pending:r,scannedPct:t,scanningPct:i,incompletePct:a,completePct:o}),100===t&&n>7){const e=this.assetFileQueue;let t=0;const i=yield e.pendingImagesCount(),n=yield e.pendingVideoCount();{const n=e.avgImageProcessingTime;i>0&&null!=n&&(t+=i*n)}{const i=e.avgVideoProcessingTime;n>0&&null!=i&&(t+=n*i)}{const r=t>0?t/(m.maxCpus()/2):void 0,s=e.assetProcessRate.eventCount>5?M.map(e.assetProcessRate.msPerEvent,e=>(i+n)*e):void 0;k().debug("ETAs",{eta1:r,eta2:s,msPerAssetProcessed:e.assetProcessRate.msPerEvent}),M.map(c.avg(v.compact([r,s])),e=>this.eta.push(E.round(e)))}}return u}))}}t.DirectorySync=C},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ETA=void 0;const n=i(4),r=i(5),s=i(26),o=i(6),a=i(16),u=i(80);t.ETA=class{constructor(){this.remainingMs=new u.Average(5),this.logger=o.mkLogger("ETA")}push(e){a.mapGt0(e,e=>this.remainingMs.push(e))}clear(){this.remainingMs.clear()}fmtEstimate(e=1){return a.mapGt0(this.remainingMs.weightedSampleAvg,t=>{const i=t*e;return i<n.minuteMs?"less than a minute remains":i<n.weekMs&&r.lt(this.remainingMs.sampleStdDev,t/3)?"about "+s.fmtDuration(i,1,{plural:"remains",singular:"remain"}):void this.logger.debug("Skipping remaining, avgMillisRemaining is too wiggly",Object.assign({avg:i},this.remainingMs.stats()))})}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.enqueueAssetUpdates=t.enqueueAssetFileUpdates=void 0;const r=i(70),s=i(6),o=i(52),a=i(163),u=i(67),l=i(1),c=i(0),d=i(7),h=i(114),f=i(122),p=i(315);function m(e,t){return e.upsertWorkItems(t.map(e=>({contents:d.toS(e)})))}t.enqueueAssetFileUpdates=function(){return n(this,void 0,void 0,(function*(){const e=s.mkLogger("enqueueAssetFileUpdates()"),t=yield u.mountpoints();if(null==t)return e.warn("Failed: no mountpoints");const i=`assetFileUpdates:${a.AssetFileVersion}:${r.shortStringSha(l.sort(t).join(":"))}`,c=yield p.Queue.ops().upsertOne({name:i});return e.info("starting",{name:i,queue:c}),yield f.AssetFile.dbr(e=>e.pluckBatched({onResults:e=>n(this,void 0,void 0,(function*(){return m(c,e)})),qb:(e,i)=>(e=e.select("id").orderBy("id","asc").where("version","<",a.AssetFileVersion).andWhere(e=>e.whereNull("mountpoint").orWhereIn("mountpoint",t)),l.isNotEmpty(i)&&(e=e.andWhere("id",">",o.max(i))),e)})),e.info("Finished",{name:i,itemCount:yield c.itemCount()}),i}))},t.enqueueAssetUpdates=function(e){return n(this,void 0,void 0,(function*(){const t=s.mkLogger("enqueueAssetUpdates()"),i=yield u.mountpoints();if(null==i)return t.warn("Failed: no mountpoints");const d=`assetUpdates:${a.AssetVersion}:${r.shortStringSha(l.sort(i).join(":"))}`;let f=0;const g=yield p.Queue.ops().upsertOne({name:d}),v=e=>n(this,void 0,void 0,(function*(){f+=e.length,yield m(g,e)}));return t.info("starting",{name:d,queue:g}),yield c.mapOr(e,v,()=>h.Asset.dbr(e=>e.pluckBatched({onResults:v,qb:(e,t)=>(e=e.select("Asset.id").distinct().orderBy("Asset.id","asc").leftJoin("AssetFile","AssetFile.assetId","Asset.id").where("Asset.version","<",a.AssetVersion).andWhere(e=>e.whereNull("AssetFile.mountpoint").orWhereIn("AssetFile.mountpoint",i)),l.isNotEmpty(t)&&(e=e.andWhere("Asset.id",">",o.max(t))),e)}))),t.info("Finished",{name:d,itemCount:yield g.itemCount()}),{queueName:d,upserted:f}}))}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,i){i(186),e.exports=i(419)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.load=void 0;try{i(273).install()}catch(e){}const r=i(217),s=i(274),o=i(420),a=i(360),u=i(361),l=i(421),c=i(422);!function(){n(this,void 0,void 0,(function*(){const e=yield new r.CLI("sync","[files-or-directories...]","If paths are provided on the command line, they should be fully-qualified.\n\n* Paths to directories will be scanned recursively.\n* Paths to files will be imported if they pass configured filters.\n\nNote that sync will spawn 1 or more `sync-file` processes to work in parallel.").add(a.ForceArg,l.RebuildArg,u.NoFilterArg,s.CommonArgs,o.ExitWhenDoneArg).parse();new c.SyncService(e.args)}))}(),t.load=!0},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExitWhenDoneArg=void 0;const n=i(22),r=i(9);t.ExitWhenDoneArg={beforeParse:e=>e.option("--exitWhenDone","Exit after jobs are completed. Defaults to false unless paths are specified on the command line."),afterParse:e=>{n.isTrue(e.exitWhenDone)&&(r.Settings.exitWhenDone.tmpValue=!0)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RebuildArg=void 0;const r=i(22),s=i(9);t.RebuildArg={beforeParse:e=>e.option("--rebuild","Rebuild your library by re-importing all your photos and videos (slow!)"),afterParse:e=>n(void 0,void 0,void 0,(function*(){r.isTrue(e.rebuild)&&(s.Settings.rebuild.tmpValue=!0)}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SyncService=void 0;const r=i(94),s=i(19),o=i(17),a=i(8),u=i(155),l=i(55),c=i(21),d=i(295),h=i(184),f=i(26),p=i(23),m=i(13),g=i(182),v=i(158),y=i(32),b=i(102),w=i(423),S=i(129),P=i(160),M=i(6),E=i(28),x=i(16),_=i(24),T=i(9),D=i(27),O=i(66),F=i(50),I=i(1),k=i(56),C=i(3),A=i(4),L=i(34),R=i(20),N=i(2),B=i(0),j=i(5),z=i(15),V=i(7),q=i(290),W=i(150),U=i(159),H=i(130),G=i(122),J=i(197),$=i(344),Q=i(234),K=i(424),Y=i(425),X=i(374),Z=i(430),ee=i(431),te=i(432),ie=i(437),ne=i(438),re=M.mkLogger("SyncService");t.SyncService=class{constructor(e=s.argv.slice(2),t=m.eventEmitter){this.importPaths=e,this.ee=t,this.logger=M.mkLogger("SyncService"),this.progressUpdater=N.lazy(()=>new ie.ProgressUpdater(()=>this.sync())),this.taskDataChunkers=new l.BoundedMap(500,10*A.minuteMs,!1),this.syncFileCluster=N.lazy(()=>n(this,void 0,void 0,(function*(){this.taskDataChunkers.clear();const e=yield d.pathToService("sync-file");if(null==e)return void re.error("Could not find sync-file");this.logger.info("syncFileCluster(): sync-file found at "+e);const t=2*P.MaxSyncFileTimeoutMs,i=new r.BatchCluster({processFactory:()=>(this.logger.info("Spawning new sync-file",{execPath:process.execPath,syncFile:e.nativePath,maxProcs:O.maxCpus()}),c.spawn(process.execPath,[...d.nodeArgs("sync-file"),e.nativePath],t)),maxProcs:O.maxCpus(),maxIdleMsPerProcess:A.minuteMs,maxTasksPerProcess:E.isTest?10:200,spawnTimeoutMillis:D.CmdTimeoutMs,taskTimeoutMillis:void 0,endGracefulWaitTimeMillis:30*A.secondMs,maxProcAgeMillis:t,versionCommand:"--version",pass:Q.ReadyStr,fail:p.FatalErrorRe,exitCommand:"--exit",cleanupChildProcs:!1});return i.on("taskData",(e,t)=>{null!=e&&null!=t&&this.taskDataChunkers.getOrSet(V.toS(t),()=>new b.Chunker("\n",e=>this.onTaskData(e),!0)).onChunk(e)}),u.observeBatchCluster(i,"sync-file",o.EndableRanks.first)}))),this.setupStatsDb=N.lazy(()=>(v.neverIgnore(...z.toA(this.importPaths)),H.Library.instanceRequired().statsDb())),this.modelDbUpdater=N.lazy(()=>n(this,void 0,void 0,(function*(){const e=new te.ModelDbUpdater({assetFileUpdater:e=>this.repairAssetFile(e,!1),assetUpdater:e=>this.repairAsset(e,!1,!0),assetPreviewUpdater:e=>this.repairAssetPreviews(e,!1)});return e.donePromise().then(()=>n(this,void 0,void 0,(function*(){this.logger.info("modelDbUpdater completed. Starting normal sync."),this.sync.refresh()}))),e.donePromise().catch(e=>{this.logger.error("modelDbUpdater failed. Attempting to continue with sync.",e),this.service.exit("failed to update model db",1)}),e}))),this.sync=N.lazy(()=>n(this,void 0,void 0,(function*(){yield this.setupStatsDb();const e=yield this.modelDbUpdater();if(null!=e&&!e.done())return e;const t=this.exitWhenDone&&I.isEmpty(this.importPaths)?void 0:I.isEmpty(this.importPaths)?new ee.FsSync(H.Library.instanceRequired(),this.processFile.bind(this)):new ne.Syncs("import paths fs sync",this.importPaths.map(e=>y.PosixFile.for(e)).map(e=>()=>n(this,void 0,void 0,(function*(){return(yield e.isDirectory())?X.DirectorySync.for(e,this.processFile.bind(this)):(yield e.isNonEmptyFile())?new Z.FileSync(e,this.processFile(e)):void this.logger.warn("Cannot import path (doesn't exist): ",e.nativePath)})))),i=T.Settings.syncIntervalHours.valueOrDefault;return this.exitWhenDone?L.delay(A.secondMs).then(()=>B.map(t,e=>e.donePromise())).then(()=>L.delay(A.secondMs)).catch(e=>this.service.exit("Error: "+e,12)).then(()=>this.service.exit("Finished",0)):j.gt0(i)&&L.delay(A.secondMs).then(()=>B.map(t,e=>e.donePromise())).then(()=>B.map(t,e=>e.end())).catch(e=>{p.onError("Syncs failed, but will restart after "+i+" hours",e)}).then(()=>L.delay(i*A.hourMs)).then(()=>(this.logger.info("Restarting scanDrives after "+T.Settings.syncIntervalHours.valueOrDefault+" hours."),this.sync.refresh())),t}))),I.filterInPlace(e,C.notBlank),v.neverIgnore(...e),this.exitWhenDone=T.Settings.exitWhenDone.valueOrDefault||I.isNotEmpty(e),this.service=new $.Service({name:"sync"}),m.onRpcServerChange(()=>this.service.exit("rpcServerChange",0)),this.setup().catch(e=>p.onError("setup() failed",new F.WrappedError({cause:e,fatal:!0}))),this.tmpFileCleanup=new w.TmpfileCleanup(S.imgCacheDir,15*A.minuteMs)}done(){return n(this,void 0,void 0,(function*(){const e=yield this.sync();return null==e||e.done()}))}status(){return n(this,void 0,void 0,(function*(){try{const e=yield this.sync.prior(),t=yield U.healthChecks();(h.hasWarn(t)||h.hasBad(t)||h.hasFail(t))&&(this.logger.info("status(): healthcheck is sad, let's clean up tmpfiles",t),this.tmpFileCleanup.cleanup(this.tmpFileCleanup.maxAgeMs/2));const i={libraryPath:T.Settings.libraryPath.value,rpcPort:T.Settings.rpcPort.value,ending:o.ending(),done:yield this.done(),sync:B.map(e,e=>e.name),healthChecks:t,progress:yield a.thenMap(this.sync(),e=>e.status())};Q.stdoutWrite(i)}catch(e){Q.stdoutWrite({error:e})}}))}processFile(e){return n(this,void 0,void 0,(function*(){try{re.info("processFile("+e+")");if(null==(yield this.syncFileCluster()))throw new Error("this.bc is null");const t=yield f.thenElapsed(this._processFile(e));if(!E.isProd){const i=yield P.syncFileTimeoutForFile(e);Q.stdoutWrite(Object.assign({timeout:i},t))}return t.result}catch(t){return re.warn("Failed to process "+e,t),{path:e.nativePath,error:t}}}))}_processFile(e){return n(this,void 0,void 0,(function*(){if(o.ending())return;const t=yield a.thenMap(e.uri(),t=>a.thenMap(G.AssetFile.ops().findOneBy({uri:t}),t=>a.thenAnd(t.matchesFile(e),()=>t)));if(null!=t)return this.logger.info("_processFile("+e+"): no-op, AssetFile:"+t.id+" already in sync."),{path:e.nativePath,assetId:t.assetId,assetFileId:t.id};{if(o.ending())return;const t=yield this.bc();return null==t?void this.logger.error("_processFile("+e+"): this.bc is null"):k.retryOnReject(()=>n(this,void 0,void 0,(function*(){if(o.ending())return;const i=new K.ImportTask(e);return t.enqueueTask(i).finally(()=>this.taskDataChunkers.delete(V.toS(i)))})),{maxRetries:1,errorIsRetriable:p.isRetriableError})}}))}setup(){return n(this,void 0,void 0,(function*(){if(yield a.rejected(this.service.ready))return void this.logger.warn("setup(): service.ready was rejected, exitting.");T.Settings.forceSync.valueOrDefault&&(this.logger.info("setup(): --force: clearing cache directories "),yield q.clearCacheDirs());const e=H.Library.instanceRequired();this.logger.info("setup(): library is at "+e.rootDir),yield e.ready,T.Settings.rebuild.valueOrDefault&&(this.logger.info("setup(): --rebuild: setting all assets to require updates..."),yield W.tx(J.modelDb(),e=>n(this,void 0,void 0,(function*(){e.exec("update Asset set version = 0"),e.exec("update AssetFile set version = 0")})))),yield this.sync(),yield this.progressUpdater(),this.service.setInputHandler("--status",()=>this.status()),E.isTest&&I.isNotEmpty(this.importPaths)&&g.onProgressEvt(e=>console.log(R.stringify(e)));m.eventEmitter.on("repairAsset",e=>this.repairAsset(null==e?void 0:e.assetId,null==e?void 0:e.force,!1)),m.eventEmitter.on("repairAssetFile",e=>this.repairAssetFile(null==e?void 0:e.assetFileId,null==e?void 0:e.force))}))}enqueueTask(e){return n(this,void 0,void 0,(function*(){return a.thenMap(this.bc(),t=>n(this,void 0,void 0,(function*(){const i=Date.now(),n=yield t.enqueueTask(new Y.UpdateTask(e));return E.isTest&&Q.stdoutWrite(Object.assign(Object.assign(Object.assign({},e),{elapsedMs:Date.now()-i}),n)),n})))}))}repairAsset(e,t,i){return n(this,void 0,void 0,(function*(){return this.logger.info("Asked to repair asset ",{assetId:e}),x.mapGt0(e,e=>this.enqueueTask({updateAssetId:e,force:t,skipPreviews:i}))}))}repairAssetFile(e,t){return n(this,void 0,void 0,(function*(){return this.logger.info("Asked to repair assetFile",{assetFileId:e}),x.mapGt0(e,e=>this.enqueueTask({updateAssetFileId:e,force:t}))}))}repairAssetPreviews(e,t){return n(this,void 0,void 0,(function*(){return this.logger.info("Asked to repair asset preview",{assetId:e}),x.mapGt0(e,e=>this.enqueueTask({updateAssetPreviewId:e,force:t}))}))}bc(){return a.thenMap(this.syncFileCluster(),e=>e.bc)}onTaskData(e){const t=B.orElse(_.Try(()=>JSON.parse(e)),{});g.isProgressEvt(t)&&(E.isTest&&Q.stdoutWrite(t),g.emitProgressEvt(t))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.TmpfileCleanup=void 0;const r=i(4),s=i(17),o=i(6),a=i(152);t.TmpfileCleanup=class{constructor(e,t,i=(()=>!0),n=!0){this.root=e,this.maxAgeMs=t,this.filter=i,this.scheduleCleanup=n,this._ended=!1,this.name="TmpfileCleanup",this.logger=o.mkLogger(this.name),s.addFirstEndable(this),this._scheduleCleanup()}get ended(){return this._ended}end(){this._ended=!0}_scheduleCleanup(){!this._ended&&this.scheduleCleanup&&setTimeout(()=>this.cleanup(),Math.min(r.minuteMs,Math.floor(this.maxAgeMs/5)))}cleanup(e=this.maxAgeMs){return n(this,void 0,void 0,(function*(){if(this._ended)return[];const t=yield this.root();if(null==t)return[];const i=Date.now()-e,r=[];yield t.visitDescendants(e=>n(this,void 0,void 0,(function*(){const n=yield e.stat();null!=n&&n.isFile()&&(!e.parent().eql(t)||!a.isNoMediaName(e.base))&&this.filter(e)&&n.birthtimeMs<i&&(r.push(e),yield e.unlink().catch(t=>this.logger.warn("Failed to unlink "+e,t)))})));const s=r.length;return this.logger.info("Removed "+s+" files."),yield t.visitDescendants(e=>n(this,void 0,void 0,(function*(){e.clear(),(yield e.isDirectory())&&(yield e.hasNoChildren())&&(r.push(e),yield e.rmrf().catch(t=>this.logger.warn("Failed to rmdir "+e,t)))}))),this.logger.info("Pruned "+(r.length-s)+" empty directories."),this._scheduleCleanup(),r}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImportTask=void 0;const n=i(94),r=i(1),s=i(20),o=i(7),a=i(372);class u extends n.Task{constructor(e){super(s.stringify({file:e.nativePath}),e=>this.parse(e)),this.file=e,this.name=`ImportTask(${this.file})`}toString(){return this.name}parse(e){for(const t of r.compactBlanks(o.toS(e).split("\n")).reverse()){const e=JSON.parse(t);if(a.isErrorResult(e)||a.isSuccessResult(e))return e}return{path:this.file.nativePath,error:"INTERNAL ERROR: no result found in input"}}}t.ImportTask=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateTask=void 0;const n=i(94),r=i(191),s=i(1),o=i(20),a=i(0),u=i(7),l=i(373);class c extends n.Task{constructor(e){super(o.stringify(e),e=>this.parse(e)),this.cmd=e,this.name=`UpdateTask(${o.stringify(e)})`,this.id=a.firstDefined(e.updateAssetId,e.updateAssetFileId,e.updateAssetPreviewId)}toString(){return this.name}parse(e){for(const t of s.compactBlanks(u.toS(e).split("\n")).reverse()){const e=r.parseMaybe(t);if(l.isErrorResult(e)||l.isSuccessResult(e))return e}return{id:this.id,error:"INTERNAL ERROR: no result found in input: "+e}}}t.UpdateTask=c},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryCounter=void 0;const r=i(60),s=i(17),o=i(8),a=i(43),u=i(147),l=i(32),c=i(6),d=i(28),h=i(9),f=i(190),p=i(95),m=i(27),g=i(293),v=i(1),y=i(4),b=i(34),w=i(37),S=i(2),P=i(0),M=i(156),E=i(35),x=i(427),_=i(314);t.DirectoryCounter=class{constructor(e,t,i,w=h.Settings.syncIntervalHours.valueOrDefault*y.hourMs,P=.25*E.MB,T=50*E.KB,D=1.25*h.Settings.statTimeoutSeconds.valueOrDefault*y.secondMs){this.root=e,this.fileListener=t,this.workTimeMs=i,this.priorValidMs=w,this.totalFileEstimateChunksize=P,this.averageFileSizeEstimate=T,this.dirIterTimeoutMs=D,this.startedAt=Date.now(),this.recentDirs=new f.TTLArray(1*y.minuteMs,200),this._skippedDirs=0,this._unchangedDirs=0,this._changedDirs=0,this._runningTotalFiles=0,this._runningTotalAssetCount=0,this._ended=!1,this.driveUsedBytes=S.lazy(()=>o.thenMap(p.volumeFor(this.root.nativePath),e=>e.used),m.LongTtlMs),this.run=a.oneRunAtATime(this.name+".run",()=>n(this,void 0,void 0,(function*(){if(this._ended)return;const e=Date.now()+this.workTimeMs,t=new Map,i=yield u.nativePath2uriString(this.root.nativePath);if(null==i)return void this.onError(new Error("Cannot fetch URI for "+this.root));for(;Date.now()<e&&!this._ended;){const i=yield o.thenOrTimeout(this.dirIter.next(e).catch(e=>this.onError(e)),this.dirIterTimeoutMs,()=>{this.logger.warn("DirectoryIterator TIMEOUT after "+this.dirIterTimeoutMs)});if(this.logger.debug("run(): got dirIter result",i),this._ended=this._ended||null==i||!0===i.done,null==i||this.finalResult.rejected)return;const n=i.value;if(null!=n&&null!=n.result){const e=n.result;t.set(e.uri,e);const i=yield o.thenMap(l.PosixFile.forUri(e.uri),e=>e.nativePath);if(null==i)return void this.logger.error("Cannot restore path from "+e.uri);if(this.recentDirs.pushUniq(i),!0!==n.priorStillValid||h.Settings.forceSync.valueOrDefault)null!=e.completedAt&&(this.logger.info("Completed ",e),this._runningTotalAssetCount+=e.assetCount,this._runningTotalFiles+=e.fileCount,!0===n.priorMtimeMatches?this._unchangedDirs++:this._changedDirs++);else{const e=yield _.DirStat.getPathAggregates(n.result.uri);null==e?this.logger.warn("internal error: no path aggregates for "+n.result.uri):(this.logger.debug(n.result.uri+" is complete and unchanged. Adding aggregates:",{uriAgg:e,v:n}),yield _.DirStat.touchSubpaths(n.result.uri),this._runningTotalAssetCount+=e.assetCount,this._runningTotalFiles+=e.fileCount,this._unchangedDirs+=e.dirCount,this._skippedDirs+=e.dirCount)}}}this.logState();const n=[...t.values()];if(v.isNotEmpty(n)){const e=Date.now(),t=yield _.DirStat.ops().upsert(n),i=Date.now()-e;this.logger.info("Upserted in "+i+"ms",t.map(e=>({id:e.id,uri:e.uri}))),this.dirIter.updateDirStats(t)}if(this.dirIter.done()){this.logger.info("dirIter is done, cleaning up..."),g.removeIdleListener(this.name),yield _.DirStat.deleteStaleForRoot(i,this.startedAt);const e={rootUri:i,assetCount:this._runningTotalAssetCount,fileCount:this._runningTotalFiles,dirCount:this.dirCount};b.later(()=>this.finalResult.resolve(e))}}))),this.logState=M.throttle(()=>this.logger.info("Visiting "+[...this.recentDirs.values],{dirIterDone:this.dirIter.done()}),(d.isTest?5:15)*y.secondMs),this.name="stats.DirectoryCounter("+e.nativePath+")",this.logger=c.mkLogger(this.name),this.finalResult=new r.Deferred(this.name).finally(()=>this.end()),this.dirIter=new x.DirectoryIterator(e,t,w),s.addFirstEndable(this),g.addIdleListener(this),o.thenMap(p.volumeFor(this.root.nativePath),e=>this._driveUsedBytes=e.used).catch(e=>{this.logger.warn("Failed to get used bytes for "+this.root+": "+e)})}get recentVisitedDirectory(){return this.recentDirs.shiftOrFirst()}get estimatedTotalFileCount(){const e=P.map(this._driveUsedBytes,e=>e/this.averageFileSizeEstimate),t=this.totalFileEstimateChunksize*(1+Math.ceil(this.runningTotalFiles/this.totalFileEstimateChunksize));return null!=e&&e>t?e:t}get runningTotalAssetCount(){return this._runningTotalAssetCount}get runningTotalFiles(){return this._runningTotalFiles}scannedPct(){return this.done()?100:this.runningTotalFiles/this.estimatedTotalFileCount*100}get unchangedDirs(){return this._unchangedDirs}get changedDirs(){return this._changedDirs}get skippedDirs(){return this._skippedDirs}get dirCount(){return this._unchangedDirs+this._changedDirs}get ended(){return this._ended}end(){this._ended=!0,g.removeIdleListener(this.name)}done(){return this._ended||this.finalResult.settled}donePromise(){return this.finalResult.promise}get runnable(){return!this._ended}onIdle(){return this.run()}onError(e){this.logger.error("fatal: "+e),this.finalResult.reject(w.asError(e))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryIterator=void 0;const r=i(12),s=i(8),o=i(26),a=i(147),u=i(171),l=i(152),c=i(271),d=i(428),h=i(6),f=i(9),p=i(1),m=i(56),g=i(4),v=i(34),y=i(0),b=i(11),w=i(18),S=i(78),P=i(15),M=i(314),E={done:!0,value:void 0},x={done:!1,value:void 0};class _{constructor(e,t,i=f.Settings.syncIntervalHours.valueOrDefault*g.hourMs,r,m=3){this.dir=e,this.fileListener=t,this.priorValidMs=i,this.parent=r,this.maxRetries=m,this.skipChildFiles=!1,this.pendingChildDirs=[],this._done=!1,this.maybeTimeout=e=>{if(Date.now()>=e)return x},this.setupResult=()=>n(this,void 0,void 0,(function*(){if(null!=this.result)return;const e=yield a.nativePath2uriString(this.dir.nativePath);if(null==e)throw new Error("Cannot create URI for "+this.dir);const t=yield s.thenMap(this.dir.mtimeMs(),o.unixtime);if(null==t)return this.logger.error("mtime was undefined"),{done:!0,value:void 0};const i=yield M.DirStat.findByUri(e);this.priorMtimeMatches=w.Opt(i).map(e=>e.mtime===t).getOrElse(()=>!1),this.logger.debug("setupResult()",{priorId:y.map(i,e=>e.id),priorMtimeMatches:this.priorMtimeMatches}),null!=i&&this.priorMtimeMatches?(this.result=i,this.priorValidMs<=0||o.recent(i.completedAt,this.priorValidMs)?(this.logger.debug("prior exists, mtime matches, and was completed recently enough"),this.skipChildFiles=!0):(this.result.completedAt=void 0,this.logger.debug("prior exists and mtime matches"))):(this.result=y.orElse(i,()=>M.DirStat.fromJSON({uri:e})),this.result.mtime=t,this.result.assetCount=0,this.result.fileCount=0,this.logger.info("set up result",this.result))})),this.fetchChildren=()=>n(this,void 0,void 0,(function*(){if(null==this.pendingChildren)if(yield l.hasNoMedia(this.dir))this.logger.info("skipping .nomedia dir, "+this.dir),this.pendingChildren=[];else{const e=yield s.thenMap(this.dir.children(),e=>d.sortByExt(e.filter(e=>!u.ignorableFile(e))));this.pendingChildren=P.toA(e)}})),this.popChildren=e=>n(this,void 0,void 0,(function*(){const t=[];for(;null!=this.pendingChildren&&this.pendingChildren.length>0&&Date.now()<e;){const e=this.pendingChildren.pop();if(null==e)return;e.isDirectory()?this.pendingChildDirs.push(e):this.skipChildFiles||(this.result.fileCount++,(yield c.cheapFileFilter.apply(e))&&(t.push(e),this.result.assetCount++))}p.isNotEmpty(t)&&this.fileListener(t)})),this.maybeSetupChildDelegate=e=>n(this,void 0,void 0,(function*(){for(;Date.now()<e&&null==this.childDelegate&&this.pendingChildDirs.length>0;){const e=this.pendingChildDirs.shift();(yield u.ignorableDirectory(e))||(this.childDelegate=new _(e,this.fileListener,this.priorValidMs,this))}})),this.maybeDelegateToChild=e=>n(this,void 0,void 0,(function*(){const t=this.childDelegate;if(null!=t){const i=f.Settings.statTimeoutSeconds.valueOrDefault*g.secondMs,n=yield s.thenOrTimeout(t.next(e).catch(e=>{this.logger.warn("Failed to descend into "+t.dir+": "+e)}),i,()=>{this.logger.warn("Failed to descend into "+t.dir+": TIMEOUT after "+i)});return null!=n&&!0!==n.done||(this.childDelegate=void 0),null!=n?Object.assign(Object.assign({},n),{done:!1}):x}})),this.maybeCompleteResult=()=>n(this,void 0,void 0,(function*(){return null==this.result||null==this.pendingChildren||null!=this.childDelegate||p.isNotEmpty(this.pendingChildDirs)||p.isNotEmpty(this.pendingChildren)?(this.logger.warn("maybeCompleteResult, not done (?!)",b.pick(this,"result","pendingChildren","childDelegate","pendingChildDirs")),x):(this.result.completedAt=y.orElse(this.result.completedAt,Date.now()),{done:!0,value:{result:this.result,priorMtimeMatches:this.priorMtimeMatches}})})),this.nextChain=[this.maybeTimeout,this.setupResult,this.maybeTimeout,this.fetchChildren,this.maybeTimeout,this.popChildren,this.maybeTimeout,this.maybeSetupChildDelegate,this.maybeTimeout,this.maybeDelegateToChild,this.maybeCompleteResult].map(e=>t=>n(this,void 0,void 0,(function*(){const i="."+e.name+"()",n=yield e.call(this,t);return this.logger.debug(i,{result:n,thisResult:this.result}),n}))),this.name="stats.DirectoryIterator("+e+")",this.logger=h.mkLogger(this.name)}get isRoot(){return null==this.parent}root(){return null==this.parent?this:this.parent.root()}updateDirStats(e){y.map(this.result,t=>{y.map(e.find(e=>e.uri===t.uri),e=>{Object.assign(t,e),this.logger.debug("updateDirStats()",this.result)})}),y.map(this.childDelegate,t=>t.updateDirStats(e))}done(){return this._done}next(e){return n(this,void 0,void 0,(function*(){if(this._done)return E;const t=Date.now();if(e<t)return x;const i=yield m.retryOnReject(()=>r.firstAsync(this.nextChain,t=>t(e)),{maxRetries:this.maxRetries,onRetryWaitUntil:()=>v.delay(S.randomInt(500,10*g.secondMs))});return null==i?x:(this._done=!0===i.done,this.logger.debug("next()",{result:i,ttr:e-t,elapsed:Date.now()-t}),i)}))}}t.DirectoryIterator=_},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sortByExt=t.extSortCriteria=void 0;const n=i(1),r=i(2),s=i(7),o=i(48),a=i(194),u=r.lazy(()=>[o.VideoExts,o.RawImageExts,o.SharpImageExts()].map(e=>new Set(e.map(e=>e.toLowerCase()))));function l(e){const t=s.toS(e.ext).toLowerCase(),i=e.isDirectory()?-2:u().findIndex(e=>e.has(t));return[e.isFile(),a.bname(e),i,t]}t.extSortCriteria=l,t.sortByExt=function(e){return n.sortBy(e,e=>l(e))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileQueue=void 0;const r=i(31),s=i(8),o=i(23),a=i(13),u=i(182),l=i(40),c=i(125),d=i(32),h=i(118),f=i(80),p=i(93),m=i(48),g=i(194),v=i(190),y=i(143),b=i(1),w=i(4),S=i(0),P=i(5),M=i(267),E=i(372),x=i(350);class _ extends x.WorkQueue{constructor(e,t,i){super("afq:"+e.nativePath,e=>this.itemIsReady(e),e=>this.processItem(e)),this.root=e,this.importer=t,this.maxConcurrentVideos=i,this._processedImages=0,this._processedVideo=0,this._imageProcessTimeMs=new f.Average(50),this._videoProcessTimeMs=new f.Average(50),this.recentProgress=new v.TTLArray(15*w.secondMs),this.recentlyProcessed=new v.TTLArray(20*w.secondMs),this.recentlyRetried=new y.TTLSet(30*w.minuteMs),this.processMs=new f.Average,this.assetProcessRate=new p.Rate(5*w.minuteMs),this._lastOpProgress=0,this.fileListener=e=>n(this,void 0,void 0,(function*(){this.logger.debug("fileListener()",{possibleAssetPaths:e.map(e=>e.nativePath)}),this.queueIsEmpty=!1,yield this.enqueueWork(e.map(e=>({contents:e.nativePath,type:m.extType(e.ext)})))})),this.progressCallback=e=>{this.logger.debug("progressCallback()",e),this.hasPath(e.path)&&(this.recentProgress.push(`${e.op} ${e.path}: ${e.pct.toFixed(0)}%`),this._lastOpProgress=Date.now())},u.onProgressEvt(this.progressCallback),this.onEnds.push(()=>u.removeProgressEvtListener(this.progressCallback))}static for(e,t){return n(this,void 0,void 0,(function*(){return new _(e,t,yield h.maxConcurrentVideoImports())}))}pathQuery(e){return M.QueueItem.query().where({queueId:e.id})}get lastOpProgress(){return this._lastOpProgress}get currentPaths(){return this.currentQueueItems().map(e=>e.contents)}get currentBaseFiles(){return this.currentPaths.map(e=>l.BaseFile.for(e))}hasPath(e){for(const t of this.currentPaths)if(e===t)return!0;return!1}get currentVideoJobCount(){return b.count(this.currentPaths,e=>m.isVideoExt(r.extname(e)))}get currentVideoJobCapacity(){return P.clamp(0,this.maxConcurrentVideos,this.maxConcurrentVideos-this.currentVideoJobCount)}get preventAdditionalVideoJobs(){return this.currentVideoJobCount>=this.maxConcurrentVideos}get processedCount(){return this._processedImages+this._processedVideo}get processedImageCount(){return this._processedImages}get processedVideoCount(){return this._processedVideo}get avgImageProcessingTime(){return this._imageProcessTimeMs.p84}get avgVideoProcessingTime(){return this._videoProcessTimeMs.p84}pendingCount(){return n(this,void 0,void 0,(function*(){return M.QueueItem.dbLocal().pluckFirst(this.pathQuery(yield this.queue()).count("id"))}))}pendingImagesCount(){return n(this,void 0,void 0,(function*(){return M.QueueItem.dbLocal().pluckFirst(this.pathQuery(yield this.queue()).andWhere("type","!=",m.ExtTypes.video).count("id"))}))}pendingVideoCount(){return n(this,void 0,void 0,(function*(){return M.QueueItem.dbLocal().pluckFirst(this.pathQuery(yield this.queue()).andWhere("type","=",m.ExtTypes.video).count("id"))}))}get recentProcessedFile(){return S.orElse(this.recentProgress.shift(),()=>S.map(this.recentlyProcessed.shiftOrFirst(),e=>"Processing "+e))}handleError(e,t){return n(this,void 0,void 0,(function*(){this.logger.warn("Error handling file",{pq:e,err:t}),yield this.dequeue(e),o.isRetriableError(t)&&!this.recentlyRetried.has(e.contents)&&(yield s.thenMap(c.DirectoryEntry.for(e.contents),t=>(this.recentlyRetried.add(e.contents),this.logger.info("Re-enqueuing "+t),this.fileListener([t]))))}))}onFileDone(e,t){this.logger.debug("onFileDone("+e.contents+", "+t+" ms)");const i=T(e);return m.isVideoExt(i.ext)?this._processedVideo++:this._processedImages++,t>0&&(m.isVideoExt(i.ext)?this._videoProcessTimeMs.push(t):this._imageProcessTimeMs.push(t)),this.dequeue(e).then(a.emitIdle)}itemIsReady(e){return n(this,void 0,void 0,(function*(){if(e.type===m.ExtTypes.video&&this.currentVideoJobCapacity<=0)return!1;const t=l.BaseFile.for(e.contents);return!b.uniq(this.currentBaseFiles.map(g.bname)).includes(g.bname(t))}))}processItem(e){return n(this,void 0,void 0,(function*(){const t="processItem("+e.contents+"): ",i=T(e),n=Date.now();if(yield i.clear().isEmpty())return this.logger.debug(t+"is empty, skipping."),this.onFileDone(e,0);try{this.logger.debug(t+"starting");const r=yield this.importer(i);E.isSuccessResult(r)?yield this.onFileDone(e,Date.now()-n):yield this.handleError(e,new Error(E.isErrorResult(r)?r.error:"undefined result"))}catch(t){return this.handleError(e,t)}finally{this.queueIsEmpty=!1,this.assetProcessRate.onEvent(),this.processMs.push(Date.now()-n),this.recentlyProcessed.push(i.nativePath)}}))}}function T(e){return d.PosixFile.for(e.contents)}t.AssetFileQueue=_,_.MaxErrors=2},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.FileSync=void 0;const r=i(60),s=i(8),o=i(351);t.FileSync=class{constructor(e,t){this.root=e,this._ended=!1,this.name="FileSync("+e+")",this.sync=new r.Deferred(this.name).observe(t),o.saveProgressOnDone(this)}get ended(){return this._ended}end(){this._ended=!0}done(){return this.sync.settled}donePromise(){return this.sync}status(){return n(this,void 0,void 0,(function*(){return[{uri:yield s.thenOrElse(this.root.uri(),()=>"file:///"+this.root.posixPath),volume:this.root.nativePath,state:this.sync.pending?"processing":"done"}]}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.FsSync=void 0;const r=i(47),s=i(17),o=i(8),a=i(43),u=i(63),l=i(26),c=i(23),d=i(13),h=i(32),f=i(6),p=i(9),m=i(143),g=i(95),v=i(27),y=i(117),b=i(1),w=i(4),S=i(75),P=i(2),M=i(0),E=i(5),x=i(156),_=i(15),T=i(374),D=()=>E.clamp(1,168,p.Settings.syncIntervalHours.valueOrDefault)*w.hourMs;t.FsSync=class{constructor(e,t){this.library=e,this.importer=t,this.logger=f.mkLogger("Syncs"),this.name="Syncs",this.scanned=new S.Latch,this._doneLatch=new S.Latch,this._ended=!1,this.nativePathsCompleted=new m.TTLSet(D()),this.urisCompleted=new m.TTLSet(D()),this.pathsToDo=[],this.onVolumesChanged=()=>this.scanDrives(),this.end=P.lazy(()=>n(this,void 0,void 0,(function*(){this._ended=!0,this.logger.info("end()"),clearInterval(this.driveScanTimer),d.eventEmitter.removeListener("volumesChanged",this.onVolumesChanged),M.map(this.pathsToDo,e=>e.length=0);const e=o.thenMap(this.sync,e=>e.end());this.sync=void 0,yield e}))),this.scanDrives=a.serially(this.name+".scanDrives()",()=>n(this,void 0,void 0,(function*(){const e=f.mkLogger(this.name+".scanDrives()");try{return y.isPaused()||s.ending()?void e.info("paused || ending"):(yield this.validateCurrentSync(),null!=(yield this.sync)?void e.debug("sync not complete."):(yield this.buildPathsToDo(),yield this.popNextMountpoint(),this.scanned.pending&&this.scanned.resolve(),b.isEmpty(this.pathsToDo)&&null==this.sync&&(e.info("WOOT, all drives are sync'ed"),this._doneLatch.resolve()),void this.logState()))}catch(e){c.onError("scanDrives() failed",e)}}))),this.logState=x.throttle(()=>n(this,void 0,void 0,(function*(){const e={mountpointsCompleted:[...this.nativePathsCompleted.keys()],urisCompleted:[...this.urisCompleted.keys()],mountpointsTodo:this.pathsToDo};yield o.thenMap(this.sync,t=>{e.sync={root:t.root.nativePath,start:l.fmtDuration(Date.now()-t.start)+" ago"}}),this.logger.info("status",e)})),30*w.secondMs),this.scanDrives(),this.driveScanTimer=u.setUnrefInterval(()=>this.scanDrives(),v.MountpointsTtlMs),p.Settings.scanAllDrives.valueOrDefault&&d.onVolumesChanged(this.onVolumesChanged)}status(){return n(this,void 0,void 0,(function*(){return o.thenMap(this.sync,e=>e.status())}))}done(){return this.scanned.settled&&null==this.sync&&b.isEmpty(this.pathsToDo)}doneLatch(){return this._doneLatch}donePromise(){return this._doneLatch.promise}get ended(){return this._ended}endCurrentSync(){const e=o.thenMap(this.sync,e=>(this.logger.info("endCurrentSync(): ending "+e),s.end(e)));return this.sync=void 0,e}validateCurrentSync(){return n(this,void 0,void 0,(function*(){const e=f.mkLogger(this.name+".validateCurrentSync()"),t=yield this.sync;if(null==t)return void e.debug("no current sync");const i=t.root.nativePath,n=t.rootUri;return t.done()?(this.urisCompleted.add(n),this.nativePathsCompleted.add(i),this.endCurrentSync()):(yield t.root.clear().notExists())?(e.warn("sync "+i+" has disappeared. Ending."),this.endCurrentSync()):void 0}))}buildPathsToDo(){return n(this,void 0,void 0,(function*(){const e=f.mkLogger(this.name+".buildPathsToDo()"),t=p.Settings.scanPaths.values.map(e=>h.PosixFile.for(e));t.push(this.library.rootDir),p.Settings.scanMyPictures.valueOrDefault&&t.push(h.PosixFile.for(r.App.getPath("pictures")));const i=yield g.volumes();if(b.isEmpty(i))return void e.warn("volumes() is empty, giving up.");const s=i.map(e=>h.PosixFile.for(e.mountpoint));p.Settings.scanAllDrives.valueOrDefault&&t.push(...s);const a=h.coalesce(t,s),u=this.pathsToDo;this.pathsToDo=(yield o.asyncFilter(a,e=>n(this,void 0,void 0,(function*(){return!this.nativePathsCompleted.has(e.nativePath)&&!this.urisCompleted.has(M.orElse(yield e.uri(),e.nativePath))})))).map(e=>e.nativePath),e.info("result",{allPaths:t,coalescedPaths:a,pathsToDo:this.pathsToDo,priorPathsToDo:u,pathsCompleted:_.toA(this.nativePathsCompleted.entries()),urisCompleted:_.toA(this.urisCompleted.entries())})}))}popNextMountpoint(){return n(this,void 0,void 0,(function*(){const e=f.mkLogger(this.name+".popNextMountpoint()");for(;!this._ended&&null==this.sync&&b.isNotEmpty(this.pathsToDo);){const t=this.pathsToDo.shift();if(null==t)continue;const i=h.PosixFile.for(t);if(!(yield i.clear().notExists()))return e.info("starting sync for "+i),this.sync=T.DirectorySync.for(i,this.importer),o.thenMap(this.sync,i=>i.donePromise().catch(i=>{e.warn("sync donePromise was rejected",{err:i,root:t}),this.sync=void 0}).then(()=>this.scanDrives())),!0;e.warn(i+" doesn't exist")}return!1}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDbUpdater=void 0;const r=i(17),s=i(22),o=i(23),a=i(375),u=i(16),l=i(293),c=i(66),d=i(433),h=i(1),f=i(3),p=i(4),m=i(75),g=i(2),v=i(0),y=i(5),b=i(7),w=i(35),S=i(130),P=i(114),M=i(373),E=i(434),x=i(435),_=i(436),T=i(351);class D extends r.EndableWrapper{constructor(e){super("ModelDbUpdater",()=>this.onEnd(),r.EndableRanks.first),this.opts=e,this.name="ModelDbUpdater",this._done=new m.Latch,this.eta=new a.ETA,this.saveSyncProgress=g.lazy(()=>T.saveSyncProgress(this),p.secondMs),this.assetUpdater=e=>n(this,void 0,void 0,(function*(){const t=yield this.opts.assetUpdater(e);return this.logger.warn("ModelDbUpdater.assetUpdater("+e+")",{result:t}),M.isSuccessResult(t)&&(s.isTrue(t.skipped)||(yield this.pq.enqueueWork([{contents:b.toS(e)}])),yield h.mapNotEmpty(null==t?void 0:t.assetIdsToUpdate,e=>n(this,void 0,void 0,(function*(){yield P.Asset.dbr(t=>t.runf(t=>t.whereIn("id",e).update({version:0}))),null==this.aq||this.aq.ended?this.logger.warn("non-empty assetIdsToUpdate, and AssetQueue is null/ended"):yield this.aq.enqueueWork(e.map(e=>({contents:b.toS(e)})))})))),t})),this.run(),T.saveProgressOnDone(this)}run(){var e,t,i,s,a,u,c,d,h,f,p,m,g,v,y;return n(this,void 0,void 0,(function*(){try{if(this.ended||r.ending())return;if(yield S.Library.instanceRequired().ready,this.afq=yield E.AssetFileUpdateQueue.for(this.opts.assetFileUpdater),this.logger.info("Starting asset file updates",{afqName:null===(e=this.afq)||void 0===e?void 0:e.name,afqEnded:null===(t=this.afq)||void 0===t?void 0:t.ended,afqRunnable:null===(i=this.afq)||void 0===i?void 0:i.runnable,idleStats:yield l.idleStats()}),yield null===(s=this.afq)||void 0===s?void 0:s.donePromise(),this.logger.info("Completed asset file updates",{afqName:null===(a=this.afq)||void 0===a?void 0:a.name,afqEnded:null===(u=this.afq)||void 0===u?void 0:u.ended,afqRunnable:null===(c=this.afq)||void 0===c?void 0:c.runnable,idleStats:yield l.idleStats()}),yield null===(d=this.afq)||void 0===d?void 0:d.end(),this.eta.clear(),yield this.saveSyncProgress(),this.ended||r.ending())return;this.pq=new x.AssetPreviewQueue(this.opts.assetPreviewUpdater),this.aq=yield _.AssetUpdateQueue.for(this.assetUpdater),this.logger.info("Starting asset updates",{aqName:null===(h=this.aq)||void 0===h?void 0:h.name,aqEnded:null===(f=this.aq)||void 0===f?void 0:f.ended,aqRunnable:null===(p=this.aq)||void 0===p?void 0:p.runnable,idleStats:yield l.idleStats()}),yield null===(m=this.aq)||void 0===m?void 0:m.donePromise(),yield this.saveSyncProgress(),yield null===(g=this.aq)||void 0===g?void 0:g.end(),yield null===(v=this.pq)||void 0===v?void 0:v.donePromise(),yield null===(y=this.pq)||void 0===y?void 0:y.end(),yield this.saveSyncProgress(),this.logger.info("run(): finished"),this._done.resolve()}catch(e){o.onError("ModelDbUpdater.run() failed",e),this._done.reject(e)}}))}onEnd(){return n(this,void 0,void 0,(function*(){this._done.resolve(),yield r.endAll(this.afq,this.pq,this.aq),this.afq=this.pq=this.aq=void 0}))}done(){return this._done.settled}donePromise(){return this._done.promise}isNoOp(){var e,t,i;return!y.gt0(null===(e=this.afq)||void 0===e?void 0:e.doneCount())&&!y.gt0(null===(t=this.pq)||void 0===t?void 0:t.doneCount())&&!y.gt0(null===(i=this.aq)||void 0===i?void 0:i.doneCount())}status(){return n(this,void 0,void 0,(function*(){if(this.ended||this.isNoOp())return;if(this.done())return[{uri:"",volume:"ð",state:"done",hed:"Finished rebuilding your library ð",dek:[],completePct:100,incompletePct:0,scanningPct:0}];const e=this.afq;if(null!=e&&!e.done()){const t=yield e.todoCount();yield u.mapGt0(e.processRate.msPerEvent,i=>n(this,void 0,void 0,(function*(){const n=5*(e.doneCount()+t)*p.secondMs/(.5*c.maxCpus()),r=t*i;this.eta.push(n+r)})));const{completePct:i}=yield e.percents(),r=this.eta.fmtEstimate(),s="Rebuilding your library"+f.mapNotBlankOr(r,e=>", "+e,"â¦");return[{uri:d.RebuildingURI,volume:"ð",state:"processing",hed:s,dek:[`Updating file metadata (${w.fmt(y.sigFigs(t,3))} remain)`],completePct:0,incompletePct:i,scanningPct:0}]}if(null!=this.aq&&null!=this.pq){const e=yield this.aq.todoCount(),t=e*v.orElse(this.aq.processRate.msPerEvent,p.secondMs),i=e+(yield this.pq.todoCount()),n=i*v.orElse(this.pq.processRate.msPerEvent,5*p.secondMs);this.eta.push(t+n);const r=i+e,s=this.aq.doneCount()+this.pq.doneCount(),o=s/(r+s),a=y.sigFigs(50+100*o/2,2),u=this.eta.fmtEstimate();return[{uri:"",volume:"ð",state:"processing",hed:"Rebuilding your library"+f.mapNotBlankOr(u,e=>", "+e,"â¦"),dek:[`Refreshing assets and previews (${w.fmt(y.sigFigs(i,3))} remain)`],completePct:a,incompletePct:100-a,scanningPct:0}]}}))}}t.ModelDbUpdater=D},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RebuildingURI=t.ProgressWithAssetsProps=t.SyncStatuses=void 0;const n=i(36);t.SyncStatuses=n.strEnum("processing","paused","done"),t.ProgressWithAssetsProps=["uri","volume","state","hed","dek","completePct","incompletePct","scanningPct","recentAssetIds"],t.RebuildingURI="rebuilding://"},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileUpdateQueue=void 0;const r=i(8),s=i(9),o=i(5),a=i(350),u=i(376);class l extends a.WorkQueue{constructor(e,t){super(e,()=>!0,e=>this.processItem(e)),this.assetFileUpdater=t,this.donePromise().then(()=>this.end())}static for(e){return n(this,void 0,void 0,(function*(){return s.Settings.skipAssetFileUpdates.valueOrDefault?void 0:r.thenMap(u.enqueueAssetFileUpdates(),t=>new l(t,e))}))}processItem(e){return n(this,void 0,void 0,(function*(){yield this.assetFileUpdater(o.toInt(e.contents))}))}}t.AssetFileUpdateQueue=l},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviewQueue=t.AssetPreviewQueueName=void 0;const r=i(5),s=i(350);t.AssetPreviewQueueName="AssetPreview";class o extends s.WorkQueue{constructor(e){super(t.AssetPreviewQueueName,()=>!0,e=>this.processItem(e)),this.repairAssetPreviews=e}processItem(e){return n(this,void 0,void 0,(function*(){const t=r.toInt(e.contents);this.logger.info("processItem",{assetId:t,qi:e}),yield this.repairAssetPreviews(t,!1)}))}}t.AssetPreviewQueue=o},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetUpdateQueue=void 0;const r=i(8),s=i(9),o=i(5),a=i(350),u=i(376);class l extends a.WorkQueue{constructor(e,t){super(e,()=>!0,e=>this.processItem(e),!0),this.assetUpdater=t,this.donePromise().then(()=>this.end())}static for(e){return n(this,void 0,void 0,(function*(){return s.Settings.skipAssetUpdates.valueOrDefault?void 0:r.thenMap(u.enqueueAssetUpdates(),({queueName:t})=>new l(t,e))}))}processItem(e){return n(this,void 0,void 0,(function*(){yield this.assetUpdater(o.toInt(e.contents))}))}}t.AssetUpdateQueue=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressUpdater=void 0;const n=i(17),r=i(198),s=i(8),o=i(117),a=i(286),u=i(351);class l extends r.EndableInterval{constructor(e){super({name:"ProgressUpdater",callback:()=>n.ending()||o.isPaused()?void 0:s.thenMap(this.sync(),u.saveSyncProgress),intervalMs:a.ProgressRateMs(),unref:!0}),this.sync=e}}t.ProgressUpdater=l},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Syncs=void 0;const r=i(23),s=i(75),o=i(2),a=i(0);t.Syncs=class{constructor(e,t){this.laters=t,this._ended=!1,this._done=new s.Latch,this.run=o.lazy(()=>n(this,void 0,void 0,(function*(){try{for(const e of this.laters){const t=yield e();null!=t&&(this.currentSync=t,yield t.donePromise())}this._done.resolve()}catch(e){r.onError("Syncs.run() failed",e),this._done.reject(e)}}))),this.name=`Syncs(${e})`,this.run()}done(){return!this._done.pending}donePromise(){return this._done.promise}status(){return n(this,void 0,void 0,(function*(){return a.map(this.currentSync,e=>e.status())}))}get ended(){return this._ended}end(){return this._ended=!0,a.map(this.currentSync,e=>e.end())}}}]);
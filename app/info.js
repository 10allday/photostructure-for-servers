#!/usr/bin/env node
module.exports=function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=361)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6),r=n(9),o=n(41),s=n(61),a=n(4),u=n(11);var l=n(6);e.defined=l.defined,e.orElse=l.orElse;var c=n(9);function d(t,e){return null!=t?e(t):void 0}function h(t,e){try{return t()}catch(t){return null!=e?e(t):void 0}}function f(t){return r.keys(t).filter(e=>s.isPrimitive(t[e])||u.isDate(t[e])).map(e=>[e,t[e]])}e.compactValues=c.compactValues,e.entries=c.entries,e.fromEntries=c.fromEntries,e.keys=c.keys,e.mapFields=c.mapFields,e.maybeCall=c.maybeCall,e.onlyReqValued=c.onlyReqValued,e.pick=c.pick,e.reqValuedOrElse=c.reqValuedOrElse,e.values=c.values,e.without=c.without,e.definedThunks=function(...t){return t.every(t=>i.defined(t()))},e.firstThunk=function(...t){for(const e of t){const t=e();if(null!=t)return t}},e.firstTrueThunk=function(t,e){for(const n of t){const t=n();if(null!=t&&(null==e||e(t)))return t}},e.firstDefined=function(...t){return t.find(i.defined)},e.firstDefinedField=function(t,...e){return d(e.find(e=>null!=t[e]),e=>t[e])},e.firstFieldLike=function(t,e){return a.first(r.keys(t),n=>e(n,t[n])?t[n]:void 0)},e.ornull=function(t){return void 0===t?null:t},e.map=d,e.mapOr=function(t,e,n){return null!=t?e(t):o.isFunction(n)?n():n},e.mapAnd=function(t,e){return null!=t&&e(t)},e.mapOrThrow=function(t,e,n){if(null!=t)return e(t);throw new Error(n)},e.Try=h,e.tryEach=function(t,e){[...t].forEach(t=>h(()=>e(t)))},e.identity=function(t){return t},e.ctor=function(t){return d(t.constructor,t=>t.name)},e.hasKeys=function(t){return Object.keys(t).some(e=>"string"==typeof e&&t.propertyIsEnumerable(e))},e.primitiveEntries=f,e.spread=function(t,...e){return Object.assign({},t,...a.compact(e))},e.assignMissingPrimitives=function(t,e){return null==e?t:(f(e).forEach(([e,n])=>{null==t[e]&&(t[e]=n)}),t)},e.pickMap=function(t,e,n){const i={};for(const r of e)i[r]=n(r,t[r]);return i},e.mapEntries=function(t,e){const n={};for(const i of r.keys(t))n[i]=e(i,t[i]);return n}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(3),r=n(34),o=n(189),s=n(134),a=n(101),u=n(174),l=n(0),c=n(12);e.rootLogger=i.lazy(()=>s.ConsoleLogger.instance()),e.safeRootLogger=i.lazy(()=>a.safeLogger(e.rootLogger())),e.rootLogger.onChange(()=>e.safeRootLogger.clear()),e.alsoLogToConsole=function(){e.rootLogger.set(e.rootLogger()===s.ConsoleLogger.instance()?e.rootLogger():new o.CompoundLogger(e.rootLogger(),s.ConsoleLogger.instance()))},e.setLoggerProcessName=function(t,n){l.map(e.rootLogger.prior(),t=>t.close());const i=new u.LogWriter(r.BaseFile.for(n),t);e.rootLogger.set(c.Settings.logStdout.valueOrDefault?new o.CompoundLogger(i,s.ConsoleLogger.instance()):i)},e.mkLogger=function(t){return new a.ContextualLogger(t,e.rootLogger)},e.mkSafeLogger=function(t){return new a.ContextualLogger(t,e.safeRootLogger)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(42),o=n(15),s=n(33),a=n(4),u=n(29),l=n(11),c=n(7),d=n(0),h=n(184),f=n(37),p=n(51);var m=n(84);function g(t){return i(this,void 0,void 0,function*(){try{return yield t,!0}catch(t){return!1}})}function v(t,e,n=(()=>void 0),r=(()=>void 0)){return i(this,void 0,void 0,function*(){let i,o=!1,s=!1;return yield Promise.race([h.asPromise(t).then(t=>s?void 0:(i=t,o=!0,t)),f.unrefDelay(e).then(()=>{o||(s=!0)})]),o?yield r(i):yield n(),i})}function y(t,n,r=e.DefaultMaxConcurrent){return i(this,void 0,void 0,function*(){return(yield p.withBoundedConcurrency({name:"tuples",laters:t.map(t=>()=>i(this,void 0,void 0,function*(){return[yield n(t),t]})),maxConcurrent:r})).filter(([t,e])=>null!=t&&null!=e)})}e.thenTap=m.thenTap,e.DefaultMaxConcurrent=8,e.PromiseStates=s.strEnum("pending","resolved","rejected"),e.resolvedThen=function(t,e){return i(this,void 0,void 0,function*(){if(null==t)return Promise.resolve(void 0);try{return yield t,e()}catch(t){return}})},e.resolvedWithin=function(t,e){return Promise.race([t,f.delay(e).then(()=>void 0)])},e.resolved=g,e.rejected=function(t){return i(this,void 0,void 0,function*(){return!(yield g(t))})},e.thenDefined=function(t){return i(this,void 0,void 0,function*(){return null!=(yield t)})},e.allSerial=function(t){return i(this,void 0,void 0,function*(){const e=[];for(const n of a.compact(t))e.push(yield n());return a.compact(e)})},e.awaitAll=function(t){return i(this,void 0,void 0,function*(){yield Promise.all(a.compact(t))})},e.thenFlatten=function(t){return i(this,void 0,void 0,function*(){return null==t?[]:a.flatten(a.compact(yield Promise.all(t)))})},e.thenCompact=function(t){return i(this,void 0,void 0,function*(){const e=a.compact(t);return a.isEmpty(e)?[]:a.compact(yield Promise.all(e))})},e.asyncFind=function(t,e){return i(this,void 0,void 0,function*(){for(const n of t)if(yield e(n))return n})},e.asyncFilter=function(t,n,r=e.DefaultMaxConcurrent){return i(this,void 0,void 0,function*(){return(yield y(a.compact(t),n,r)).filter(([t])=>t).map(([,t])=>t)})},e.tryAsync=function(t){return i(this,void 0,void 0,function*(){try{return yield t()}catch(t){return}})},e.DefaultTryAllTimeoutMs=30*l.secondMs,e.tryAll=function(t,n=(t=>console.error(t)),r=e.DefaultTryAllTimeoutMs){return i(this,void 0,void 0,function*(){for(const e of t)try{yield v(e,r)}catch(t){n(t)}})},e.thenFinally=function(t,e=(()=>{}),n=(()=>{})){return i(this,void 0,void 0,function*(){let i,r=null;try{i=yield"function"==typeof t?t():t}catch(t){r=t;try{yield e(t)}catch(t){}}try{yield n(null!=r?r:i)}catch(t){}if(null!=r)throw r;return i})},e.thenNot=function(t,e=!0){return i(this,void 0,void 0,function*(){if(null==t)return e;const n=yield t;return null==n?e:!u.truthy(n)})},e.thenMap=function(t,e){return i(this,void 0,void 0,function*(){const n=yield t;return null==n?void 0:e(n)})},e.thenMapOr=function(t,e,n){return i(this,void 0,void 0,function*(){const i=yield t;if(null==i)return n();const r=yield e(i);return null==r?n():r})},e.thenAnd=function(t,e){return i(this,void 0,void 0,function*(){if(null!=t)return(yield t)?e():void 0})},e.thenOrElse=function(t,e){return i(this,void 0,void 0,function*(){return d.orElse(yield t,e)})},e.thenSome=function(t,e){return i(this,void 0,void 0,function*(){let n=0;for(const i of t)if(yield e(i,n++,t))return!0;return!1})},e.thenEvery=function(t,e){return i(this,void 0,void 0,function*(){let n=0;for(const i of t)if(!1===(yield e(i,n++,t)))return!1;return!0})},e.firstAsync=function(t,e){return i(this,void 0,void 0,function*(){if(null!=t){let n=-1;for(const i of t){n++;try{if(null==i)continue;const t=yield e(i,n);if(null!=t)return t}catch(t){}}}})},e.firstDefinedPromise=function(...t){return i(this,void 0,void 0,function*(){for(const e of t){const t=yield e();if(null!=t)return t}})},e.firstResolvedDefinedPromise=function(t,e){return i(this,void 0,void 0,function*(){for(const n of t)try{const t=yield n();if(null!=t)return t}catch(t){e(t)}})},e.firstTruePromise=function(t,...e){return i(this,void 0,void 0,function*(){for(const n of e)try{const e=yield n();if(null!=e&&!0===(yield t(e)))return e}catch(t){}})},e.until=function(t,e,n){return i(this,void 0,void 0,function*(){const i=c.mapGt0(e,t=>Date.now()+t),s=o.Opt(n).getOrElse(()=>d.orElse(e,3e4)/10),a=c.clamp(100,1e4,s);for(;null==i||Date.now()<i;){const e=yield t();if(!0===e)return!0;if(null!=e&&!1!==e)throw new Error("f must return a boolean, but returned "+r.inspect(e));yield f.delay(a)}return!1})},e.untilDefined=function(t,{timeoutMs:e,timeBetweenMs:n}){return i(this,void 0,void 0,function*(){const i=c.mapGt0(e,t=>Date.now()+t),r=o.Opt(n).getOrElse(()=>d.orElse(e,3e4)/10),s=c.clamp(50,1e4,r);for(;null==i||Date.now()<i;){const e=yield t();if(null!=e)return e;yield f.delay(s)}})},e.thenOrTimeout=v,e.tuples=y,e.thenGreatest=function(t,e){return i(this,void 0,void 0,function*(){return d.map(a.greatestBy(yield y(t,e),t=>t[0]),t=>t[1])})},e.sortByAsync=function(t,e){return i(this,void 0,void 0,function*(){return a.sortBy(yield y(t,e),t=>t[0]).map(t=>t[1])})}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.lazy=function(t,e){let n,i=0;const r=[];function o(t){return i=Date.now(),n=t,r.forEach(t=>t(n)),n}function s(){return(0===i||null!=e&&i+e<=Date.now())&&o(t()),n}return s.clear=function(){const t=n;return i=0,n=void 0,r.forEach(t=>t(n)),t},s.set=function(t){return o(t)},s.prior=function(){return n},s.refresh=function(){return o(t())},s.setTTL=function(t){return e=t},s.onChange=function(t){r.push(t)},s}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(9),o=n(61),s=n(10),a=n(7),u=n(0);var l=n(5);function c(t){return u.defined(t)&&t.every(u.defined)}function d(t,e,n=1,i=u.identity){const r=[];if(t<e)for(let o=t;o<e;o+=n)r.push(i(o));else for(let o=t;o>e;o-=n)r.push(i(o));return r}function h(...t){const e=Math.max(...t.map(t=>t.length));return a.times(e,e=>t.map(t=>t[e]))}function f(t){return v(t,(t,e)=>t.valueOf()<e.valueOf())}function p(t){return g(t,t=>t.valueOf())}function m(t,e){return v(t,(t,n)=>u.map(e(t),t=>u.map(e(n),e=>t<e)))}function g(t,e){return v(t,(t,n)=>u.map(e(t),t=>u.map(e(n),e=>t>e)))}function v(t,e){let n,i=-1;for(let r=0;r<t.length;r++)u.map(t[r],t=>{null!=n&&!0!==e(t,n)||(i=r,n=t)});return i}e.clear=l.clear,e.compact=l.compact,e.count=l.count,e.includesAll=l.includesAll,e.isEmpty=l.isEmpty,e.isNotEmpty=l.isNotEmpty,e.mapNotEmpty=l.mapNotEmpty,e.filterInPlace=l.filterInPlace,e.uniq=l.uniq,e.uniqBy=l.uniqBy,e.sort=l.sort,e.sortBy=l.sortBy,e.sorted=l.sorted,e.startsWith=l.startsWith,e.toA=l.toA,e.allDefined=c,e.mapAllDefined=function(t,e){return c(t)?e(t):void 0},e.mapAll=function(t,e){return c(t)?e(t):void 0},e.allNotDefined=function(t){return null==t||t.every(t=>null==t)},e.allNotBlank=function(...t){return null!=t&&t.every(s.notBlank)},e.anyNotDefined=function(t){return null==t||t.some(t=>null==t)},e.anyDefined=function(t){return null!=t&&t.some(t=>null!=t)},e.first=function(t,e){if(null!=t)for(const n of i.compact(t)){const t=e(n);if(null!=t)return t}},e.firstNonEmptyThunk=function(...t){for(const e of t){const t=e();if(i.isNotEmpty(t))return t}},e.concat=function(...t){const e=[];for(const n of t)if(Array.isArray(n))for(const t of n)null!=t&&e.push(t);else null!=n&&e.push(n);return e},e.flatten=function t(e,n=[]){return null==e?n:(e.forEach(e=>u.map(e,e=>Array.isArray(e)?t(e,n):n.push(e))),n)},e.exclude=function(t,e){if(e.length<50)return t.filter(t=>!e.includes(t));{const n=new Set(e);return t.filter(t=>!n.has(t))}},e.remove=function(t,e){const n=t.length;return i.filterInPlace(t,t=>t!==e),n!==t.length},e.diff=function(t,e){const n=new Set(e.map(t=>t.valueOf()));return t.filter(t=>!n.has(t.valueOf()))},e.intersect=function(t,e){const n=new Set(e.map(t=>t.valueOf()));return t.filter(t=>n.has(t.valueOf()))},e.eqlContents=function(t,e){return h(i.sort(t),i.sort(e)).every(([t,e])=>t===e)},e.removeFirst=function(t,e){const n=t.findIndex(e);return n>=0?t.splice(n,1)[0]:void 0},e.uniqInPlace=function(t){i.filterInPlace(t,(e,n)=>t.indexOf(e)===n)},e.partition=function(t,e){const n=[],i=[];return t.forEach((t,r)=>(e(t,r)?n:i).push(t)),[n,i]},e.uniqCount=function(t){return function t(e){if(null==e||0===e.length)return[];const n=e[0];const i=e.lastIndexOf(n);return[{t:n,count:i+1},...t(e.slice(i+1))]}(t.sort())},e.mapCompact=function(t,e){return i.compact(i.compact(t).map(e))},e.toMapEntries=function(t,e){return new Map(t.map(e).filter(u.defined))},e.flatMap=function(t,e){return t.reduce((t,n)=>t.concat(e(n)),[])},e.range=function(t,e,n=u.identity){return d(t,e,1,n)},e.stepRange=d,e.retainLastN=function(t,e){return t.length>e&&t.splice(0,t.length-e),t},e.retainFirstN=function(t,e){return t.length=Math.min(t.length,e),t},e.contextAround=function(t,e,n,i){const r=t.findIndex(i);if(-1!==r){return{before:0===r?[]:t.slice(Math.max(0,r-e),r),after:r===t.length-1?[]:t.slice(r+1,Math.min(r+1+n,t.length))}}},e.zip=h,e.flatZip=function(...t){const e=Math.max(...t.map(t=>t.length)),n=[];return a.times(e,e=>t.map(t=>n.push(t[e]))),n},e.unzip=function(t){return[t.map(([t])=>t),t.map(([,t])=>t)]},e.ancestry=function(t){return a.times(t.length,e=>t.slice(0,e+1))},e.leastIndex=f,e.greatestIndex=p,e.min=function(t){return t[f(t)]},e.max=function(t){return t[p(t)]},e.leastIndexBy=m,e.greatestIndexBy=g,e.leastBy=function(t,e){return t[m(t,e)]},e.greatestBy=function(t,e){return t[g(t,e)]},e.combinations=function*t(e,n){if(!(null==e||e.length<n))for(let i=0;i<e.length;i++)if(1===n)yield[e[i]];else for(const r of t(e.slice(i+1),n-1))yield[e[i],...r]},e.sortByInPlace=function(t,e){return t.sort((t,n)=>o.cmp(e(t),e(n)))},e.reverse=function(t){const e=[];for(let n=t.length-1;n>=0;n--)e.push(t[n]);return e},e.batches=function(t,e){return e<=0&&(e=1),d(0,t.length,e,n=>t.slice(n,n+e))},e.sortArrArr=function(t){return i.sortBy(t.map(t=>i.sort(t)),t=>t[0].valueOf())},e.contextFilter=function(t,e){let n;return t.filter((t,i)=>r.tap(e(t,i,n),e=>{e&&(n=t)}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(8),r=n(46),o=n(180),s=n(95),a=n(6),u=n(61),l=n(18);function c(t){return null==t?[]:"function"==typeof Array.from?Array.from(t):Array.isArray(t)?t:[].slice.call(t)}function d(t){return o.isList(t)&&t.length>0&&t.some(t=>null!=t)}function h(t){return!d(t)}function f(t){return u.isPrimitive(t)||u.isPrimitiveArray(t)?t:t.valueOf()}function p(t,e){if(null==t)return!1;for(const n of t)if(e===n)return!0;return!1}function m(t){if(null==t)return[];const e=c(t);return e.every(a.defined)?e:e.filter(a.defined)}e.toA=c,e.isNotEmpty=d,e.isEmpty=h,e.mapNotEmpty=function(t,e){return d(t)?e(t):void 0},e.sort=function(t){return m(t).sort((t,e)=>u.cmp(a.map(t,f),a.map(e,f)))},e.sorted=function(t){return t.every((e,n)=>0===n||e>t[n-1])},e.sortBy=function(t,e){return c(t).map(t=>[e(t),t]).filter(([t])=>null!=t).sort((t,e)=>u.cmp(t[0],e[0])).map(t=>t[1])},e.startsWith=function(t,e){return r.arrayEql(t.slice(0,e.length),e)},e.filterInPlace=function(t,e){for(let n=0;n<t.length;)e(t[n],n,t)?n++:t.splice(n,1);return t},e.includes=p,e.indexOf=function(t,e){if(null==t)return;let n=0;for(const i of t){if(e(i,n))return n;n++}},e.includesAll=function(t,e){return null!=t&&null!=e&&e.every(e=>p(t,e))},e.pushUniq=function(t,e){return p(t,e)||t.push(e),t},e.compact=m;const g=["null","undefined"];function v(t,e){if(h(t))return[];const n=new Map;return t.forEach(t=>s.getOrSet(n,e(t),()=>t)),[...n.values()]}e.compactBlankish=function(t){return c(t).filter(t=>i.notBlank(t)&&!g.includes(l.toS(t)))},e.compactBlanks=function(t){return null==t?[]:t.map(l.toS).filter(i.notBlank)},e.uniq=function(t){return v(t,t=>JSON.stringify(t))},e.uniqBy=v,e.clear=function(t){return t.length=0,t},e.count=function(t,e){return t.reduce((t,n)=>t+(e(n)?1:0),0)},e.sum=function(t,e){return t.reduce((t,n)=>t+e(n),0)},e.firstMatch=function(t,e){for(const n of m(e)){const e=t.exec(n);if(null!=e)return e}},e.commonPrefixLength=function(t,e){if(null==t||null==e)return 0;if(r.eql(t,e))return t.length;let n=0;for(;r.eql(t[n],e[n]);)n++;return n}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(41);function r(t){return null!=t}e.map=function(t,e){return null==t?void 0:e(t)},e.orElse=function(t,e){return null!=t?t:i.isFunction(e)?e():e},e.mapOr=function(t,e,n){return null==t?n():e(t)},e.defined=r,e.allDefined=function(t){return null!=t&&t.every(r)},e.firstDefined=function(...t){return t.find(r)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(17),r=n(59),o=n(4),s=n(10),a=n(0);var u=n(17);e.clamp=u.clamp,e.gt0=u.gt0,e.gte0=u.gte0,e.isNumber=u.isNumber,e.id=u.id,e.mapFinite=u.mapFinite,e.mapInt=u.mapInt,e.round=u.round,e.sigFigs=u.sigFigs,e.times=u.times,e.toInt=u.toInt,e.toFloat=u.toFloat,e.toPrecision=u.toPrecision;var l=n(59);e.fmt=l.fmt,e.fmtBytes=l.fmtBytes,e.GB=l.GB,e.GiB=l.GiB,e.KB=l.KB,e.KiB=l.KiB,e.MB=l.MB,e.megapixels=l.megapixels,e.MiB=l.MiB,e.MP=l.MP;const c=t=>(e,n)=>i.isNumber(e)&&i.isNumber(n)&&t(e,n);e.lt=c((t,e)=>t<e),e.lte=c((t,e)=>t<=e),e.gt=c((t,e)=>t>e),e.gte=c((t,e)=>t>=e),e.firstGt0=function(...t){return t.find(i.gt0)},e.firstNonZero=function(...t){for(const e of o.flatten(t)){const t=i.toFloat(e);if(null!=t&&0!==t)return t}},e.mapGte0=function(t,e){return i.mapInt(t,t=>t>=0?e(t):void 0)},e.mapGt0=function(t,e){return i.mapInt(t,t=>t>0?e(t):void 0)},e.within=function(t,n,i){return null!=i&&([t,n]=[Math.min(t,n),Math.max(t,n)],e.gte(i,t)&&e.lte(i,n))};const d=/[+-]?[0-9\.]/;function h(t){if(i.isNumber(t))return t;if(s.blank(t))return;const e=String(t);return a.map(d.exec(e),t=>i.toFloat(e.substr(t.index)))}e.extractInt=function(t){return i.toInt(h(t))},e.extractFloat=h,e.closeTo=function(t,e,n){return Math.abs(t-e)<n},e.assertPositive=function(t,e){if(null==e||e<=0)throw new Error(t+" must be positive")},e.plur=function(t,e,n=e+"s"){return r.fmt(t)+" "+(1===t?e:n)},e.absdiff=function(t,e){t=null==t?0:t,e=null==e?0:e;const n=Math.min(t,e);return Math.abs(n+t-(n+e))};e.Array2D=class{constructor(t){this.columns=t,this.store=[]}get(t,e){return t<0||e<0?0:a.orElse(this.store[t*this.columns+e],()=>0)}set(t,e,n){this.store[t*this.columns+e]=n}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(18);function o(t){if(null==t)return!0;const e=r.toS(t);return 0===e.length||0===e.trim().length}function s(t){return!o(t)}e.blank=o,e.notBlank=s,e.ifNotBlank=function(t){if(null==t)return;const e=r.toS(t);return 0===e.length||0===e.trim().length?void 0:e},e.notBlankOr=function(t,e){if(null==t)return e;const n=r.toS(t).trim();return n.length>0?n:e},e.notBlankAnd=function(t,e){return!o(t)&&e(t)},e.mapNotBlank=function(t,e){if(!1===t||null==t||""===t)return;const n=r.toS(t);return s(n)?e(n):void 0},e.firstNotBlank=function(...t){return i.toA(t).find(t=>s(t))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(8),o=n(6),s=n(41);var a=n(6);function u(t){return null==t||"object"!=typeof t?[]:Object.keys(t).filter(e=>"string"==typeof e&&(null==t.propertyIsEnumerable||t.propertyIsEnumerable(e)))}function l(t){return u(t).map(e=>t[e])}function c(t){return u(t).map(e=>[e,t[e]])}function d(t,e={}){return"object"!=typeof e&&(e={}),i.compact(t).reduce((t,[e,n])=>f(t,()=>{null!=e&&null!=n&&(t[e]=n)}),e)}function h(t){return l(t).every(t=>null!=t)}function f(t,e){return null!=e?e(t):console.dir(t,{depth:3}),t}e.map=a.map,e.emptyObj=function(t){return i.isEmpty(u(t))},e.keys=u,e.values=l,e.compactValues=function(t){const e=c(t).filter(([t,e])=>null!=t&&null!=e);return i.isEmpty(e)?void 0:d(e)},e.entries=c,e.fromEntries=d,e.mapFields=function(t,e,n={}){return d(i.compact(c(t).map(([t,n])=>e(t,n))).filter(([t,e])=>null!=t&&null!=e),n)},e.pick=function(t,...e){if(null==t)return t;if(!e.every(t=>"string"==typeof t))throw new Error("bad keys: "+JSON.stringify(e));return i.isEmpty(e)?{}:e.reduce((e,n)=>f(e,()=>o.map(t[n],t=>e[n]=t)),{})},e.pickFirst=function(t,e,n=o.defined){if(null!=t)for(const i of e)if(n(t[i]))return t[i]},e.without=function(t,...e){if(null==t||e.every(e=>r.blank(t[e])))return t;const n=c(t).filter(([t])=>!e.includes(t));return i.isEmpty(n)?void 0:d(n)},e.reqValued=h,e.reqValuedOrElse=function(t){return h(t)?t:void 0},e.onlyReqValued=function(t){return t.filter(h)},e.sortedKeys=function(t){return d(i.sortBy(c(t),([t])=>t))},e.filter=function(t,e){return null==t?t:d(c(t).filter(([t,n])=>e(t,n)))},e.tap=f,e.allKeys=function(t){const e=u(t);for(;null!=(t=Reflect.getPrototypeOf(t));)e.push(...Reflect.ownKeys(t).filter(t=>"string"==typeof t));return i.uniq(e)},e.maybeCall=function(t,e,...n){return null!=t&&s.isFunction(t[e])?t[e].bind(t)(...n):void 0},e.firstValueCaseInsensitive=function(t,e){if(r.blank(e))return;if(null!=t[e])return t[e];const n=e.toLocaleLowerCase().normalize();for(const e of u(t))if(n===e.toLocaleLowerCase().normalize()&&null!=t[e])return t[e]}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8);var o=n(8);e.blank=o.blank,e.notBlank=o.notBlank,e.mapNotBlank=o.mapNotBlank,e.firstNotBlank=o.firstNotBlank;var s=n(5);e.compactBlanks=s.compactBlanks,e.firstNotBlankThunk=function(...t){for(const e of t)try{const t=e();if(r.notBlank(t))return t}catch(t){}throw new Error("No elements were defined")},e.firstNotBlankPromise=function(...t){return i(this,void 0,void 0,function*(){for(const e of t)try{const t=yield e();if(r.notBlank(t))return t}catch(t){}throw new Error("No elements were defined")})}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(79),o=n(16),s=n(6),a=n(17),u=n(15),l=n(61),c=n(4),d=n(10),h=n(98),f=n(26),p=n(38),m=n(7),g=n(0),v=n(13);var y=n(16);function S(t){return t instanceof Date}function w(t,e=5*o.secondMs){return m.gt0(t)&&Math.abs(Date.now()-t)<=e}function b(t,e=2){return v.leftPad(t,e,"0")}function M(t,e,n){return t<1?void 0:m.plur(t,e,n)}function P(t,e=2){if(!m.gte0(t))return a.isNumber(t)?"-"+P(Math.abs(t),e):"";const n=[M(Math.floor(t/o.dayMs),"day","days"),M(Math.floor(t/o.hourMs)%24,"hour","hours"),M(Math.floor(t/o.minuteMs)%60,"minute","minutes"),M(Math.floor(t/o.secondMs)%60,"second","seconds")],i=n.findIndex(t=>null!=t);return c.compact(n.slice(i,i+e)).join(", ")}e.dayMs=y.dayMs,e.hourMs=y.hourMs,e.minuteMs=y.minuteMs,e.secondMs=y.secondMs,e.isDate=S,e.cmpDate=function(t,e){const n=g.mapOr(t,t=>t.getTime(),0),i=g.mapOr(e,t=>t.getTime(),0);return l.cmp(n,i)},e.unixtime=function(t){const e=S(t)?t.getTime():a.isNumber(t)?t:void 0;return s.map(e,t=>Math.floor(t/1e3))},e.ago=function(t,e){return new Date(g.orElse(e,new Date).getTime()-t)},e.closeTo=function(t,e,n){return null!=t&&null!=e&&Math.abs(t.getTime()-e.getTime())<=n},e.recent=function(t,e=5*o.secondMs){return w(s.map(t,t=>f.datedToMillis(t)),e)},e.recentMs=w,e.elapsed=function(t){const e=Date.now(),n=t();return{elapsedMs:Date.now()-e,result:n}},e.elapsedAsync=function(t){return i(this,void 0,void 0,function*(){const e=Date.now(),n=yield t();return{elapsedMs:Date.now()-e,result:n}})},e.thenElapsed=function(t){return i(this,void 0,void 0,function*(){const e=Date.now(),n=yield t;return{elapsedMs:Date.now()-e,result:n}})},e.datestamp=function(t=new Date){return t.getFullYear()+"-"+b(t.getMonth()+1)+"-"+b(t.getDate())},e.datestampUTC=function(t=new Date){return t.getUTCFullYear()+"-"+b(t.getUTCMonth()+1)+"-"+b(t.getUTCDate())},e.filestampUTC=function(t=new Date){return[t.getUTCFullYear(),b(t.getUTCMonth()+1),b(t.getUTCDate()),"-",b(t.getUTCHours()),b(t.getUTCMinutes()),b(t.getUTCSeconds())].join("")},e.fmtMs=function(t,e=2){return t<10*o.secondMs?Number(t).toLocaleString()+"ms":P(t,e)},e.fmtDuration=P;const x=new Map;e.fmtIsoDate=function(t,e,n=r.DateTime.DATETIME_MED){let i=r.DateTime.fromISO(t,{setZone:!0});if(i.isValid)return d.mapNotBlank(e,t=>i=i.setLocale(t)),i.toLocaleString(n);{const n=h.DateInterval.parse(t);return null==n?t:(i=n.middle.toDateTime(),d.mapNotBlank(e,t=>i=i.setLocale(t)),i.toLocaleString(r.DateTime.DATE_MED))}},e.isoNow=function(){return(new Date).toISOString()},e.fmtShort=function(t,e="en-US"){return p.getOrSet(x,e,()=>new Intl.DateTimeFormat(e,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(f.datedToMillis(t))};const E=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;e.wmiDate=function(t){const e=E.exec(t);if(null==e)return;const n=e.slice(1,8).map(t=>m.toInt(t));if(!c.allDefined(n))return;const[i,r,s,a,u,l,d]=n,h=m.toInt(e[8],{defaultValue:0});return new Date(Date.UTC(i,r-1,s,a,u,l,d/1e3)-h*o.minuteMs)};const _=/Date\((\d+)\)/;e.pwshJsonDate=function(t){return u.Opt(t).flatMap(t=>_.exec(t)).flatMap(t=>t[1]).flatMap(m.toInt).filter(t=>m.within(0,Date.now()+o.dayMs,t)).map(t=>new Date(t)).get()},e.MaxTzOffsetHours=14},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(45),r=n(30),o=n(22),s=n(5),a=n(8),u=n(146),l=n(9),c=n(33),d=n(18),h=n(128),f=n(129),p=n(4),m=n(3),g=n(10),v=n(29),y=n(28),S=n(7),w=n(0),b=n(23),M=n(49),P=n(138);var x;function E(t){const n=(a.blank(t)?"":t).split(r.delimiter);if(b.isWin&&a.blank(o.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return n.push(...e.DefaultPaths),s.uniq(n).filter(g.notBlank).join(r.delimiter)}function _(t){const n={};e.settingsForChildProcs().forEach(t=>t.addToEnv(n));const i=w.compactValues(Object.assign({},o.env,{ELECTRON_RUN_AS_NODE:"1",PATH:e.pathWithDefaults()},n,w.orElse(t,{})));return x.logStdout.deleteFromEnv(i),i}!function(t){t.nodeEnv=new P.StringEnumSetting({name:"nodeEnv",key:"NODE_ENV",category:P.SettingCategories.System,description:"runtime environment",defaultValue:()=>{const t=d.toS(o.env.NODE_ENV).toLowerCase();return t.startsWith("test")?"test":t.startsWith("prod")?"production":t.startsWith("dev")?"development":o.argv.some(t=>t.includes("mocha"))?"test":"production"},validValues:["development","test","production"],persisted:!1,addToChildProcs:!0}),t.electronVersion=new P.StringSetting({name:"electronVersion",key:"PS_ELECTRON_VERSION",category:P.SettingCategories.System,description:"",defaultValue:o.versions.electron,persisted:!1,addToChildProcs:!0}),t.libraryPath=new P.StringSetting({name:"libraryPath",key:"PS_LIBRARY_PATH",alternateKeys:["PS_LIBRARY"],category:P.SettingCategories.System,description:"This is the full path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators.",defaultValue:"",persisted:!0,advanced:!1,addToChildProcs:!0}),t.logLevel=new P.StringSetting({name:"logLevel",key:"PS_LOG_LEVEL",alternateKeys:["PS_LOG","LOG"],category:P.SettingCategories.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', or 'error'.",defaultValue:"error",persisted:!0,addToChildProcs:!0}),t.logDir=new P.StringSetting({name:"logDir",key:"PS_LOG_DIR",category:P.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>"darwin"===i.platform()?y.resolve(i.homedir(),"Library","Logs",f.AppName):y.resolve(h.appData(),f.AppName,"logs"),persisted:!0,addToChildProcs:!0}),t.logColor=new P.BooleanSetting({name:"logColor",key:"PS_LOG_COLOR",category:P.SettingCategories.Logging,description:"Should log messages be colorized with ANSI escape sequences? Great for nerds, bad for everyone else.",defaultValue:!1,persisted:!0}),t.logCompression=new P.BooleanSetting({name:"logCompression",key:"PS_LOG_COMPRESS",category:P.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:!0,persisted:!0}),t.logWebRequests=new P.BooleanSetting({name:"logWebRequests",key:"PS_LOG_WEB_REQUESTS",category:P.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1,persisted:!0}),t.logWebDir=new P.StringSetting({name:"logWebDir",key:"PS_LOG_WEB_DIR",category:P.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir.",defaultValue:"",persisted:!0,addToChildProcs:!0}),t.logSql=new P.StringSetting({name:"logSql",key:"PS_LOG_SQL",category:P.SettingCategories.Logging,description:"If non-blank, and a given db query includes the given string, the query will be logged.",defaultValue:"",persisted:!0}),t.logStdout=new P.BooleanSetting({name:"logStdout",key:"PS_LOG_STDOUT",alternateKeys:["LOG_STDOUT","PS_STDOUT"],category:P.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,persisted:!1}),t.minDiskFreeGb=new P.IntegerSetting({name:"minDiskFreeGb",key:"PS_MIN_DISK_FREE_GB",category:P.SettingCategories.System,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe.",defaultValue:8,persisted:!0}),t.maxCpuPercent=new P.BoundedIntegerSetting({name:"maxCpuPercent",key:"PS_MAX_CPU_PERCENT",category:P.SettingCategories.System,description:"PhotoStructure will not schedule work if the current system utilization percent is higher than this value. This value must be between 0 and 100. Smaller values (less than 25) may mean PhotoStructure can never schedule work. A value of 100 will allow PhotoStructure to schedule work on all of your CPUs, and may make your system unusable.",defaultValue:75,min:0,max:200,persisted:!0}),t.maxMemoryMb=new P.BoundedIntegerSetting({name:"maxMemoryMb",key:"PS_MAX_MEMORY_MB",category:P.SettingCategories.System,description:"PhotoStructure will restart services if their process consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:512,max:8e3,persisted:!0}),t.dbCacheSizeMb=new P.IntegerSetting({name:"dbCacheSizeMb",key:"PS_DB_CACHE_SIZE_MB",category:P.SettingCategories.System,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:128,persisted:!0}),t.vlcPath=new P.StringSetting({name:"vlcPath",key:"PS_VLC_PATH",category:P.SettingCategories.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc",persisted:!0}),t.ffmpegPath=new P.StringSetting({name:"ffmpegPath",key:"PS_FFMPEG_PATH",category:P.SettingCategories.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH.',defaultValue:"ffmpeg",persisted:!0}),t.updateChannel=new P.StringEnumSetting({name:"updateChannel",key:"PS_UPDATE_CHANNEL",category:P.SettingCategories.Updates,description:'TL:DR; keep this on "latest." This controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds will not have been thoroughly tested. Please only consider changing this if customer support asks you to.',defaultValue:"latest",validValues:["alpha","beta","latest"],persisted:!0}),t.allowDowngrade=new P.BooleanSetting({name:"allowDowngrade",key:"PS_ALLOW_DOWNGRADE",category:P.SettingCategories.Updates,description:"If you're running an alpha or beta build, and you switch back to 'updateChannel = \"latest\"', would you like PhotoStructure to downgrade you? Note that enabling this may make your library unreadable, if the current stable version of PhotoStructure can't read new alpha or beta database schemas.",defaultValue:!1,persisted:!0}),t.updateOnLaunch=new P.BooleanSetting({name:"updateOnLaunch",key:"PS_UPDATE_ON_LAUNCH",category:P.SettingCategories.Updates,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0,persisted:!0}),t.updateCheckMinutes=new P.IntegerSetting({name:"updateCheckMinutes",key:"PS_UPDATE_CHECK_MINUTES",category:P.SettingCategories.Updates,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:1440,persisted:!0}),t.reportErrors=new P.BooleanSetting({name:"reportErrors",key:"PS_REPORT_ERRORS",category:P.SettingCategories.ErrorReporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:!1,persisted:!0}),t.maxErrorsPerDay=new P.IntegerSetting({name:"maxErrorsPerDay",key:"PS_MAX_ERRORS_PER_DAY",category:P.SettingCategories.ErrorReporting,description:"Set this to zero to remove all bugs in PhotoStructure.\n\nHUR HUR #DADJOKE\n\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3,persisted:!0}),t.email=new P.StringSetting({name:"email",key:"PS_EMAIL",category:P.SettingCategories.ErrorReporting,description:"If set, this email will be added to error reports, so we can contact you to help debug the issue. It is not required.",defaultValue:"",advanced:!1,persisted:!0}),t.inspect=new P.BooleanSetting({name:"inspect",key:"PS_INSPECT",category:P.SettingCategories.System,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,persisted:!0}),t.rpcPort=new P.IntegerSetting({name:"rpcPort",key:"PS_RPC_PORT",category:P.SettingCategories.Web,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807,persisted:!0,addToChildProcs:!0}),t.httpPort=new P.IntegerSetting({name:"httpPort",key:"PS_HTTP_PORT",category:P.SettingCategories.Web,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787,persisted:!0,addToChildProcs:!0}),t.sessionTimeoutHours=new P.BoundedIntegerSetting({name:"sessionTimeoutHours",key:"PS_SESSION_TIMEOUT_HOURS",category:P.SettingCategories.Web,description:"How long should unused HTTP sessions exist before requiring visitors to log back in? This defaults to 180 days, just to maximize convenience.",defaultValue:4320,max:8760,min:1,persisted:!0}),t.exposeNetworkWithoutAuth=new P.BooleanSetting({name:"exposeNetworkWithoutAuth",key:"PS_EXPOSE_NETWORK_WITHOUT_AUTH",category:P.SettingCategories.Web,description:"Normally the web service is bound to loopback, so your PhotoStructure library is only accessible to this machine. Setting this to true will expose your library to all computers on your network (if they know your PhotoStructure port). You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n\n** Don't enable this unless you know what you're doing. **",defaultValue:!1,persisted:!0}),t.copyAssetsToLibrary=new P.BooleanSetting({name:"copyAssetsToLibrary",key:"PS_COPY_ASSETS",category:P.SettingCategories.Sync,description:"Should PhotoStructure copy photos and videos to your PhotoStructure Library?",defaultValue:!0,advanced:!1,persisted:!0}),t.scanAllDrives=new P.BooleanSetting({name:"scanAllDrives",key:"PS_SCAN_ALL_DRIVES",category:P.SettingCategories.Sync,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:!1,persisted:!0}),t.scanMyPictures=new P.BooleanSetting({name:"scanMyPictures",key:"PS_SCAN_MY_PICTURES",category:P.SettingCategories.Sync,description:"Should PhotoStructure only scan your system's 'Pictures' folder for photos and videos?",defaultValue:!t.scanAllDrives.defaultValue,advanced:!1,persisted:!0}),t.scanPaths=new P.StringArraySetting({name:"scanPaths",key:"PS_SCAN_PATHS",category:P.SettingCategories.Sync,description:"This holds an array of full native paths to scan for assets.",advanced:!1,persisted:!0}),t.assetSubdirectoryDatestampFormat=new P.StringSetting({name:"assetSubdirectoryDatestampFormat",key:"PS_ASSET_SUBDIR_FORMAT",category:P.SettingCategories.Sync,description:"If you chose to copy assets into your library, they will be copied into <library directory>/<result of this pattern>/<original imagename>.\nSee <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.",defaultValue:"y/y-MM-dd",persisted:!0}),t.validateJpegImages=new P.BooleanSetting({name:"validateJpegImages",key:"PS_VALIDATE_JPEG_IMAGES",category:P.SettingCategories.Sync,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:!1,persisted:!0}),t.validateRawImages=new P.BooleanSetting({name:"validateRawImages",key:"PS_VALIDATE_RAW_IMAGES",category:P.SettingCategories.Sync,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:!1,persisted:!0}),t.validateVideos=new P.BooleanSetting({name:"validateVideos",key:"PS_VALIDATE_VIDEOS",category:P.SettingCategories.Sync,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature dramatically slows down imports, as videos must be "played" to be validated. Note that if you set transcodeVideos to true, this setting is effectively true for all videos that aren\'t MP4-encoded.',defaultValue:!1,advanced:!1,persisted:!0}),t.transcodeVideos=new P.BooleanSetting({name:"transcodeVideos",key:"PS_TRANSCODE_VIDEOS",category:P.SettingCategories.Sync,description:"Should videos be transcoded during import? VLC must be installed. Note that this dramatically slows down imports, and *dramatically* increases the disk space your library will need to use. If this is set to false, though, your browser will not be able to render your videos unless they are already MP4-encoded.",defaultValue:!0,persisted:!0}),t.squareThumbStrategy=new P.StringEnumSetting({name:"squareThumbStrategy",key:"PS_SQUARE_THUMB_STRATEGY",category:P.SettingCategories.Sync,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: https://sharp.dimens.io/en/stable/api-resize/',defaultValue:"attention",validValues:["center","entropy","attention"],persisted:!0}),t.sharpen=new P.BooleanSetting({name:"sharpen",key:"PS_SHARPEN",category:P.SettingCategories.Sync,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1,persisted:!0}),t.progressive=new P.BooleanSetting({name:"progressive",key:"PS_PROGRESSIVE",category:P.SettingCategories.Sync,description:"Should preview JPEGs be progressively encoded? If set, syncs will take a bit longer, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0,persisted:!0}),t.previewResolutions=new P.StringEnumsSetting({name:"previewResolutions",key:"PS_PREVIEW_RESOLUTIONS",category:P.SettingCategories.Sync,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:p.exclude(u.FitSizeValues,["uhd8k","uhd5k"]),validValues:u.FitSizeValues,persisted:!0}),t.statTimeoutSeconds=new P.BoundedIntegerSetting({name:"statTimeoutSeconds",key:"PS_STAT_TIMEOUT_SECONDS",category:P.SettingCategories.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300,persisted:!0}),t.minFileSizeBytes=new P.IntegerSetting({name:"minFileSizeBytes",key:"PS_MIN_ASSET_SIZE",category:P.SettingCategories.Sync,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*S.KB,persisted:!0}),t.maxFileSizeBytes=new P.IntegerSetting({name:"maxFileSizeBytes",key:"PS_MAX_ASSET_SIZE",category:P.SettingCategories.Sync,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library)",defaultValue:.5*S.GB,persisted:!0}),t.minImageDimension=new P.IntegerSetting({name:"minImageDimension",key:"PS_MIN_IMAGE_DIMENSION",category:P.SettingCategories.Sync,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480,persisted:!0}),t.minVideoDimension=new P.IntegerSetting({name:"minVideoDimension",key:"PS_MIN_VIDEO_DIMENSION",category:P.SettingCategories.Sync,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240,persisted:!0}),t.neverIgnored=new P.StringArraySetting({name:"neverIgnored",key:"PS_NEVER_IGNORED",category:P.SettingCategories.Sync,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files.",persisted:!0}),t.startPaused=new P.BooleanSetting({name:"startPaused",key:"PS_START_PAUSED",category:P.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray menu.",defaultValue:!1,persisted:!0}),t.syncIntervalHours=new P.BoundedIntegerSetting({name:"syncIntervalHours",key:"PS_SYNC_INTERVAL_HOURS",category:P.SettingCategories.Sync,description:"This value controls both how often the sync process runs, and how often new files are discovered and imported. WARNING: Setting this value to a small value (say, less than 10) will mean PhotoStructure is constantly scanning your disks, which may reduce the lifespan of your storage media. Note that setting this and fileSyncIntervalHours to 0 will disable automatic scheduling of the sync process. This defaults to every day (to balance picking up new files automatically and trying to avoid unnecessary wear and tear on your storage media).",defaultValue:24,max:504,min:0,persisted:!0}),t.fileSyncIntervalHours=new P.BoundedIntegerSetting({name:"fileSyncIntervalHours",key:"PS_FILE_SYNC_INTERVAL_HOURS",category:P.SettingCategories.Sync,description:"This value controls how often the files in your library are checked for changes. The `syncIntervalHours` setting, in contrast, controls how often *new* files are discovered. This defaults to every week (to try to balance picking up changes with wear and tear on your storage media)",defaultValue:168,max:1344,min:0,persisted:!0}),t.forceSync=new P.BooleanSetting({name:"forceSync",key:"PS_FORCE_SYNC",category:P.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem",defaultValue:!1,persisted:!1}),t.defaultSidecarType=new P.StringEnumSetting({name:"defaultSidecarType",key:"PS_DEFAULT_SIDECAR_TYPE",category:P.SettingCategories.Sync,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:c.strEnumValues(M.SidecarExtsEnum),persisted:!0}),t.writeMetadataToSidecars=new P.BooleanSetting({name:"writeMetadataToSidecars",key:"PS_WRITE_METADATA_TO_SIDECARS",category:P.SettingCategories.Sync,description:"Should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original?",defaultValue:!0,persisted:!0})}(x=e.Settings||(e.Settings={})),e.envSuggestedPathsKey="SUGGESTED_PATHS",e.envSkipFiltersKey="PS_SKIP_FILTERS",e.envSkipFilters=v.truthy(o.env[e.envSkipFiltersKey]),e.DefaultPaths=Object.freeze(b.isWin?[o.env.SYSTEMROOT,r.join(o.env.SYSTEMROOT,"System32"),r.join(o.env.SYSTEMROOT,"System32","webm")]:["/usr/local/sbin","/usr/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),e.withDefaultPaths=E,e.pathWithDefaults=m.lazy(()=>E(o.env.PATH)),e.persistedSystemSettings=m.lazy(()=>l.values(x).filter(t=>t.opts.persisted&&P.SystemCategories.includes(t.category))),e.persistedLibrarySettings=m.lazy(()=>l.values(x).filter(t=>t.opts.persisted&&P.LibraryCategories.includes(t.category))),e.settingsForChildProcs=m.lazy(()=>l.values(x).filter(t=>t.addToChildProcs)),e.psenv=function(){const t=l.values(x).map(t=>t.key);return l.sortedKeys(l.filter(o.env,e=>"nodeEnv"===e||t.includes(e)))},e.childEnv=_,e.spawnOptions=function(t){const e=w.orElse(t,{});return Object.assign({},e,{env:_(e.env),detached:!1,shell:!1})};const T=x.nodeEnv.valueOrDefault;x.nodeEnv.value=T,x.nodeEnv.addToEnv(),e.isDev="development"===T,e.isTest="test"===T,e.isProd="production"===T},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(4),r=n(10),o=n(7),s=n(0),a=n(19),u=n(181);e.isString=function(t){return"string"==typeof t};const l={};function c(t,e){if(e<1)return"";for(null==l[t]&&(l[t]=t);e>l[t].length;)l[t]+=t;return l[t].substring(0,e)}function d(t,e){return t=a.toS(t),e=a.toS(e),t.startsWith(e)?t:e+t}function h(t){return t.sort((t,e)=>t.valueOf().localeCompare(e.valueOf()))}e.leftPad=function t(e,n,i){if("number"==typeof e&&e<0)return"-"+t(String(-e),n-1,i);const r=String(e);return c(i,n-r.length)+r},e.padding=c,e.padReplace=function(t,e,n,i){return t.substr(0,e)+c(i,n)+t.substr(e+n)},e.contains=function(t,e,n){return a.toS(t).indexOf(a.toS(e),n)>-1},e.count=function t(e,n,i=0){if(null==n||0===n.length)return 0;const r=e.indexOf(n,i);return-1===r?0:1+t(e,n,r+n.length)},e.replaceAll=function(t,e,n){return t.split(e).join(n)},e.maybeToS=function(t){return null==t?void 0:String(t)},e.mapParse=function(t,e){if(r.notBlank(t))try{return e(JSON.parse(t))}catch(t){}},e.trim=function(t){return t.map(a.toS).filter(t=>r.notBlank(t))},e.splitEvery=function(t,e,n){const i=Math.min(Math.ceil(t.length/e),s.orElse(n,()=>t.length))-1;return i<=0?[t]:[...o.times(i,n=>t.slice(n*e,(n+1)*e)),t.slice(i*e)]},e.stripPrefix=function(t,e){const n=a.toS(t),i=a.toS(e);return i.length>0&&n.startsWith(i)?n.slice(i.length):n},e.stripSuffix=function(t,e){const n=a.toS(t),i=a.toS(e);return i.length>0&&n.endsWith(i)?n.slice(0,-i.length):n},e.stripPreSuff=function(t,e,n){return(t=a.toS(t)).endsWith(n)&&t.startsWith(e)?t.slice(e.length,-n.length):t},e.ensurePrefix=d,e.ensureSuffix=function(t,e){return t=a.toS(t),e=a.toS(e),t.endsWith(e)?t:t+e},e.ellipsize=function(t,e=80){if(null==t)return"";const n=a.toS(t);return n.length<=e?n:n.slice(0,e-1)+"…"},e.gist=function(t,e=80,n=80){const i=a.toS(t),r=i.length-(e+n);return r<=0?i:i.slice(0,e).trim()+" …(+"+r+" chars)…"+i.slice(-n).trim()},e.capitalize=function(t){return r.blank(t)?t:t.charAt(0).toUpperCase()+t.slice(1)},e.equalsIgnoreCase=function(t,e){return null!=t&&null!=e&&a.toS(t).toLowerCase()===a.toS(e).toLowerCase()},e.startsWithIgnoreCase=function(t,e){return null!=t&&null!=e&&t.toLowerCase().normalize().startsWith(e.toLowerCase().normalize())},e.includesIgnoreCase=function(t,e){const n=a.toS(e).trim().toLowerCase().normalize();return!i.isEmpty(t)&&0!==n.length&&t.map(t=>a.toS(t).trim().toLowerCase().normalize()).filter(r.notBlank).some(t=>n.includes(t))},e.reverse=function(t){return null==t?t:t.split("").reverse().join("")},e.localeSort=h,e.sortChars=function(t){return h(t.split("")).join("")},e.longestPrefix=function(t,e){return i.greatestBy(e.filter(e=>t.startsWith(e)),t=>t.length)},e.stripAnsiEsc=function(t){return a.toS(t).replace(/\u001b\[[0-9;]+[a-z]/gi,"")};const f=/[\r\n]/;e.wrap=function t(e,n={maxLineLen:75,prefix:""}){if(e.includes("\n"))return i.flatten(e.split(f).map(e=>t(e,n)));if((e=d(a.toS(e).trim(),n.prefix)).length<=n.maxLineLen)return[e.trim()];const r=e.slice(0,n.maxLineLen+1).replace(/[\s-]/g," ").lastIndexOf(" "),o=r<=1?n.maxLineLen-(n.prefix.length+2):r;return[e.slice(0,o+1).trim(),...t(e.slice(o+1),n)]};const p=[[/[‘’]/g,"'"],[/[“”„«»”〃]/g,'"']];function m(t){return p.reduce((t,[e,n])=>t.replace(e,n),t).normalize()}e.dumbquote=m;const g=/^(['"]).+\1$/;e.stripQuotes=function(t){return r.blank(t)?t:(t=a.toS(t).trim(),null!=g.exec(m(t))&&(t=t.slice(1,-1).trim()),t)},e.wbrPath=function(t){return t.split(/(?<=[\\\/_,:=-]+)/).map(t=>u.escape(t.normalize())).join("<wbr>")},e.escapeRegExp=function(t){return a.toS(t).replace(/[?.()[\]{}*^+|$]/g,"\\$&")}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=new(n(182).EventEmitter);i.setMaxListeners(50),e.eventEmitter=i,e.emitBoom=function(){e.eventEmitter.emit("boom")},e.onBoom=function(t){e.eventEmitter.on("boom",t)},e.emitIdle=function(){e.eventEmitter.emit("idle")},e.onIdle=function(t){e.eventEmitter.on("idle",t)},e.emitPause=function(){e.eventEmitter.emit("pause")},e.onPause=function(t){e.eventEmitter.on("pause",t)},e.emitResume=function(){e.eventEmitter.emit("resume")},e.onResume=function(t){e.eventEmitter.on("resume",t)},e.emitBeforeExit=function(t,n){e.eventEmitter.emit("beforeExit",{reason:t,status:n})},e.onBeforeExit=function(t){e.eventEmitter.on("beforeExit",({reason:e,status:n})=>t(e,n))},e.emitClearCache=function(){e.eventEmitter.emit("clearCache")},e.onClearCache=function(t){e.eventEmitter.on("clearCache",t)},e.emitFileChanged=function(t){e.eventEmitter.emit("fileChanged",t)},e.onFileChanged=function(t){e.eventEmitter.on("fileChanged",t)},e.emitFocus=function(t,n){e.eventEmitter.emit("focus",t,n)},e.onFocus=function(t){e.eventEmitter.on("focus",t)},e.emitFatal=function(t,n){e.eventEmitter.emit("fatal",{message:t,error:n})},e.onFatal=function(t){e.eventEmitter.on("fatal",({message:e,error:n})=>t(e,n))},e.emitNonFatal=function(t,n){e.eventEmitter.emit("nonFatal",{message:t,error:n})},e.onNonFatal=function(t){e.eventEmitter.on("nonFatal",({message:e,error:n})=>t(e,n))},e.emitRpcServerChange=function(){e.eventEmitter.emit("rpcServerChange")},e.onRpcServerChange=function(t){e.eventEmitter.on("rpcServerChange",t)},e.readyToUpdate=!1,e.emitReadyToUpdate=function(){e.readyToUpdate=!0,e.eventEmitter.emit("readyToUpdate")},e.onReadyToUpdate=function(t){e.eventEmitter.on("readyToUpdate",t)},e.emitUpdateNow=function(){e.eventEmitter.emit("updateNow")},e.onUpdateNow=function(t){e.eventEmitter.on("updateNow",t)},e.emitVolumesChanged=function(){e.eventEmitter.emit("volumesChanged")},e.onVolumesChanged=function(t){e.eventEmitter.on("volumesChanged",t)}},function(t,e,n){"use strict";var i;Object.defineProperty(e,"__esModule",{value:!0}),function(t){t.isDefined=!1,t.isEmpty=!0,t.get=function(){},t.exists=()=>!1;const e=()=>t;t.map=e,t.flatMap=e,t.filter=e,t.forEach=e,t.getOrElse=function(t){return t()},t.orElse=function(t){return o(t())},t.zip1=e,t.zip2=e,t.zip3=e}(i||(i={})),e.None=i;class r{constructor(t){this.a=t,this.isDefined=!0,this.isEmpty=!1}get(){return this.a}exists(t){return t(this.a)}map(t){return new r(t(this.a))}flatMap(t){const e=t(this.a);return s(e)?e:o(e)}filter(t){return o(t(this.a)?this.a:void 0)}forEach(t){return t(this.a),this}getOrElse(t){return this.a}orElse(t){return this}zip1(t,e){return o(t).flatMap(t=>e(this.a,t))}zip2(t,e,n){return o(t).flatMap(t=>o(e).flatMap(e=>n(this.a,t,e)))}zip3(t,e,n,i){return o(t).flatMap(t=>o(e).flatMap(e=>o(n).flatMap(n=>i(this.a,t,e,n))))}}function o(t){return s(t)?t:null!=t?new r(t):e.None}function s(t){return t instanceof r||t===e.None}e.Some=r,e.Opt=o,e.isOpt=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(55),r=n(15);e.secondMs=1e3,e.minuteMs=60*e.secondMs,e.hourMs=60*e.minuteMs,e.dayMs=24*e.hourMs,e.weekMs=7*e.dayMs;const o=i.lazy(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));e.fmtDateShort=function(t){return r.Opt(t).flatMap(t=>t instanceof Date?t.getTime():t).map(t=>o().format(t)).get()}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(8),r=n(6),o=n(15),s=n(18);function a(t){return"number"==typeof t&&isFinite(t)}function u(t,e){return a(t)?e(t):void 0}function l(t){return p(t,t=>{const e=Math.trunc(t);return 0===e?Math.abs(e):e})}function c(t,e){if(i.blank(t))return e.defaultValue;if(a(t))return e.nton(t);try{const n=e.ston(s.toS(t));return a(n)?e.nton(n):e.defaultValue}catch(t){return e.defaultValue}}function d(t,e){return c(t,Object.assign({defaultValue:void 0,nton:t=>l(t),ston:parseInt},e))}function h(t){return a(t)&&t>0}function f(t,e){return o.Opt(t).flatMap(t=>d(t)).flatMap(e).get()}function p(t,e){return o.Opt(t).filter(a).flatMap(e).get()}function m(t){return t<0?-Math.round(-t):Math.round(t)}function g(t,e){if(null==t)return 0;const n=Math.pow(10,e);return m(t*n)/n}e.isNumber=a,e.mapFinite=u,e.trunc=l,e.toInt=d,e.toFloat=function(t,e){return c(t,Object.assign({defaultValue:void 0,nton:t=>t,ston:parseFloat},e))},e.toGt0=function(t){const e=d(t);return null!=e&&e>0?e:void 0},e.gt0=h,e.gte0=function(t){return a(t)&&t>=0},e.mapInt=f,e.id=function(t){const e=d(t);return h(e)?String(e):void 0},e.mapIntOr=function(t,e,n){return r.orElse(f(t,e),n)},e.mapNumeric=p,e.round=m,e.toPrecisionMaybe=function(t,e){return u(t,t=>g(t,e))},e.toFixed=function(t,e){try{return p(t,t=>parseInt(t.toFixed(e)))}catch(t){return}},e.toPrecision=g,e.sigFigs=function(t,e){if(0===t||0===e)return 0;const n=Math.pow(10,e-m(Math.ceil(Math.log10(Math.abs(t)))));return m(t*n)/n},e.base2Ceil=function(t){return Math.pow(2,Math.ceil(Math.log2(t)))},e.base10Ceil=function(t){return Math.pow(10,Math.ceil(Math.log10(t)))},e.clamp=function(t,e,n){return a(n)?([t,e]=[Math.min(t,e),Math.max(t,e)],Math.max(t,Math.min(n,e))):m((t+e)/2)},e.times=function(t,e){if(!a(t))return[];const n=Math.round(t);return n<=0?[]:[...Array(n)].map((t,n)=>e(n))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.toS=function t(e){return null==e?"":"string"==typeof e?e:Array.isArray(e)?e.map(t).join(","):e.toString()}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(18);e.toS=i.toS},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(186),o=n(22),s=n(35),a=n(9),u=n(36),l=n(37),c=n(3),d=n(2),h=n(11),f=n(25),p=n(54),m=n(1),g=n(7),v=n(0),y=n(81),S=n(23),w=n(12),b=n(13),M=n(19),P=c.lazy(()=>m.mkLogger("ChildProcess"));function x(t){return a.pick(t,"pid","killed","connected","exitCode","signalCode")}function E(t,e,n){const r=new Date;let a=!1;return t.on("exit",()=>a=!0),s.setTimeout(()=>i(this,void 0,void 0,function*(){if(a)return;yield d.until(()=>g.gt0(t.pid),h.secondMs);const i=t.pid;return g.gt0(i)?y.addPid({pid:i,cmd:e,maxAgeMs:n,ppid:o.pid},r):void P().warn("newProc(): not writing pidfile, child_process has no pid",{cmd:e,cp:x(t)})}),S.isWin?500:250),t}function _(t,e,n,i){return E(r.execFile(t,e,w.spawnOptions(i)),t,n)}function T(t,e,n){return i(this,void 0,void 0,function*(){const i=v.orElse(n.quiet,!1),r=v.orElse(n.ignoreStderr,!1),o=v.orElse(n.ignoreExitCode,!1);let a="";P().debug("stdoutResult(): execFile",{cmd:t,args:e,opts:n});const l=yield _(t,e,n.timeout,v.without(n,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(!0===n.disconnect)return l.disconnect(),{result:"",pid:l.pid};const c=JSON.stringify({cmd:t,args:e}),d=new u.Deferred(c);s.setTimeout(()=>{d.pending&&P().warn("stdoutResult(): SLOW COMMAND",{cmd:t,args:e})},n.timeout/3).unref(),d.setTimeout(n.timeout);const h=(r,o)=>{f.isIgnorableError(o)||(null!=l.pid&&O(l),i||P().warn("stdoutResult(): "+r,{cmd:t,args:e,opts:n,error:o}),d.pending&&d.reject(o))};try{l.on("error",t=>h("on(error)",t)),l.on("close",n=>{const r=Date.now()-d.start,s=0!==n?"warn":r<1e3?"trace":r<3e3?"debug":"info";i||P().log(s,"stdoutResult(): on(close)",{cmd:t,code:n,args:e,elapsed:r,result:b.gist(a,160,160)}),o||0===n?d.resolve({result:a,code:n,pid:l.pid}):d.reject(new Error("non-zero exit code: "+JSON.stringify({code:n,cmd:t,args:e})))}),l.stdin.end(),l.stdout.on("data",t=>v.map(t,t=>{a+=t.toString()})),l.stderr.on("error",t=>h("stderr(error)",t)),l.stderr.on("data",t=>r?P().warn("stdoutResult(): stderr(data): "+M.toS(t)):h("stderr(data)",t))}catch(t){h("try/catch",t)}return d.promise})}function O(t,e=30*h.secondMs){return i(this,void 0,void 0,function*(){if(null==t)return!1;const n=t.pid;if(P().debug("endProcess("+n+")",{killed:t.killed,connected:t.connected}),!t.killed){if(n<=0)return P().warn("endProcess(): asked to end invalid pid",x(t)),!1;if(n===o.pid)return P().warn("endProcess(): asked to end MY pid",x(t)),!1;v.Try(()=>t.kill())}return yield l.delay(250),yield p.closeStreams(t),t.connected&&v.Try(()=>t.disconnect()),v.Try(()=>t.unref()),(yield k(n,e))?(P().debug("endProcess(): exitted",x(t)),!0):(yield y.kill(n,!0).catch(t=>{P().warn("endProcess(): kill("+n+",true) failed: "+t)}),k(n,5e3))})}function k(t,e){return d.until(()=>d.thenNot(y.pidExists(t)),e)}e.spawn=function(t,e,n,i){return P().debug("spawn()",{command:t,args:e,maxAgeMs:n,options:i}),E(r.spawn(t,e,w.spawnOptions(i)),t,n)},e.execFile=_,e.stdout=function(t,e,n){return T(t,e,n).then(t=>t.result)},e.stdoutResult=T,e.endProcess=O,e.waitForExit=k},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(9),o=n(33),s=n(4),a=n(72),u=n(11),l=n(14),c=n(1),d=n(73),h=n(7),f=n(0),p=n(12),m=n(3),g=n(2),v=n(50),y=m.lazy(()=>c.mkSafeLogger(a.red("Endable")));e.EndableWrapper=class{constructor(t,e,n){this.name=t,this._onEnd=e,this._isEnded=n,this._ended=!1}get ended(){return f.mapOr(this._isEnded,t=>t(),()=>!1)||this._ended}end(){return this._ended=!0,this._onEnd()}};const S=new d.MultiMap;v.setUnrefInterval(()=>E(),1*u.minuteMs);const w=new Map,b=5*u.secondMs;function M(t,e){return S.add(t,e),e}e.EndableRanks=o.strEnum("first","service","cleanup","db","logger"),e.addFirstEndable=function(t){return M(e.EndableRanks.first,t)},w.set(e.EndableRanks.first,5*u.secondMs),e.addServiceEndable=function(t){return M(e.EndableRanks.service,t)},e.addCleanupEndable=function(t){return M(e.EndableRanks.cleanup,t)},w.set(e.EndableRanks.cleanup,1*u.minuteMs),e.addDbEndable=function(t){return M(e.EndableRanks.db,t)},e.addLoggerEndable=function(t){return M(e.EndableRanks.logger,t)},w.set(e.EndableRanks.logger,10*u.secondMs),e.addEndable=M;let P=!1;function x(t,e=g.DefaultTryAllTimeoutMs){if(null!=t&&!t.ended)return y().debug(a.magenta(t.name+" ending...")),g.thenOrTimeout(t.end(),e,()=>y().warn(a.magenta(t.name+".end() timed out")),()=>y().debug(a.magenta(t.name+".end() completed"))).catch(e=>{y().warn(a.magenta(t.name+".end() rejected: ")+e)})}function E(){S.filterInPlace((t,e)=>!e.ended),y().debug("vacuumEndables()",S.entriesArray().map(([t,e])=>[t,e.map(t=>t.name)]))}e.ending=function(){return P},e.setEnding=function(t){if(!p.isTest)throw new Error("cannot set ending");P=t},e.end=x,l.onBeforeExit(()=>P=!0),e.endEndables=m.lazy(()=>i(this,void 0,void 0,function*(){p.isTest||(P=!0),E();for(const t of r.keys(e.EndableRanks)){const e=f.orElse(S.get(t),[]);if(s.isNotEmpty(e)){y().debug(a.magenta("endEndables(): ending "+t));const n=h.firstGt0(w.get(t),b);yield Promise.all(e.map(t=>x(t,n)))}}}))},function(t,e){t.exports=require("process")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(43),r=n(45),o=n(22),s=n(8),a=n(3),u=n(29),l=r.platform();e.inspectFlag=o.argv.includes("--inspect")||u.truthy(o.env.NODE_INSPECT),e.isWin=l.startsWith("win"),e.isWinStore=e.isWin&&u.truthy(o.windowsStore),e.isWinPortable=e.isWin&&s.notBlank(o.env.PORTABLE_EXECUTABLE_DIR),e.isMac="darwin"===l,e.isMacStore=e.isMac&&u.truthy(o.mas),e.isLinux="linux"===l,e.isLinuxAppImage=e.isLinux&&s.notBlank(o.env.APPIMAGE),e.isLinuxSnap=e.isLinux&&s.notBlank(o.env.SNAP_USER_DATA),e.isPosix=e.isMac||e.isLinux,e.isDocker=a.lazy(()=>{try{return e.isLinux&&i.readFileSync("/proc/1/cgroup").toString().includes("/docker/")}catch(t){return console.warn("isDocker: failed to read /proc/1/cgroup: "+t),!1}}),e.platformName=e.isWin?"win":e.isMac?"mac":e.isLinux?"linux":l},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(16),r=n(11);e.mountpointsTtlMs=15*r.secondMs,e.dfTtlMs=5*i.minuteMs,e.cmdTimeoutMs=25*r.secondMs,e.longTtlMs=1*r.hourMs},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(8),o=n(15),s=n(21),a=n(13),u=n(19);e.asError=function(t){if(r.blank(t))throw new Error("undefined error");if(t instanceof Error)return t;if(Array.isArray(t)){const e=t[0];return e instanceof Error?(t.length>1&&(e.errors=t.slice(1)),e):new Error(t.map(t=>u.toS(t)).filter(r.notBlank).join(", "))}return new Error(u.toS(t))},e.FatalErrorFlag="¹",e.NonRetriableErrorFlag="²",e.IgnorableErrorFlag="³",e.PleaseSendErrorFlag="⁴",e.ErrorFlags=[e.FatalErrorFlag,e.NonRetriableErrorFlag,e.IgnorableErrorFlag,e.PleaseSendErrorFlag];const l=new RegExp("["+e.ErrorFlags.join("")+"]","g");function c(t){return t instanceof f?t.fatal:!h(t).includes(e.FatalErrorFlag)}function d(t){return t instanceof Error?h(t):u.toS(t)}function h(t){return null==t?h(new Error("undefined error")):r.notBlankOr(i.compactBlanks([t.name,t.message]).join(": "),u.toS(t))}e.removeErrorFlags=function(t){return t.replace(l,"")},e.hasErrorFlag=function(t){return e.ErrorFlags.some(e=>t.includes(e))},e.isFatalError=c,e.isRetriableError=function(t){return!c(t)&&!h(t).includes(e.NonRetriableErrorFlag)&&(!(t instanceof f)||t.retriable)},e.isSendableError=function(t){return h(t).includes(e.PleaseSendErrorFlag)},e.isIgnorableError=function(t){return s.ending()||!c(t)&&a.includesIgnoreCase([e.IgnorableErrorFlag,"diskutil: interrupted","net::ERR_","debugger listening on","for help","https://nodejs.org/en/docs/inspector","debugger attached"],d(t))},e.maybeErrorToS=d,e.errorToS=h,e.throws=function(t){try{return t(),!1}catch(t){return!0}},e.stack=function t(){const e={};return Error.captureStackTrace(e,t),e.stack.split(/\n(?:\s*at\s+)?/).slice(1)},e.trimErrorMessage=function(t){return u.toS(t).trim().replace(/^Error: /i,"").trim().replace(/^[0-9T\.: -]+Z? /i,"").replace(/^error /i,"").trim()},e.cleanError=function(t,e){return u.toS(t).split(/\r?\n/).map(t=>a.stripPrefix(t,e)).map(t=>t.replace(/: ?/,"")).filter(r.notBlank).join(", ")};class f extends Error{constructor({cause:t,message:n,retriable:s=!0,ignorable:l=!1,fatal:c=!1}){super(function(t,n,s,l,c){const d=[t];o.Opt(n).flatMap(t=>t.message).flatMap(t=>a.stripPrefix(t,"Error: ")).forEach(t=>d.push(t));const h=d.map(t=>u.toS(t).trim()).filter(r.notBlank).join(": "),f=[];c||s||f.push(e.NonRetriableErrorFlag);l&&!c&&f.push(e.IgnorableErrorFlag);c&&f.push(e.FatalErrorFlag);i.isNotEmpty(f)&&f.unshift(" ");return h+f.join("")}(n,t,s,l,c)),this.cause=t,this.retriable=s,this.fatal=c}}e.WrappedError=f},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(65),r=n(79),o=n(5),s=n(8),a=n(46),u=n(6),l=n(17),c=n(15),d=n(4),h=n(3),f=n(10),p=n(98),m=n(7),g=n(0),v=n(13),y=n(19);function S(t,e=2){return null==t?"":v.leftPad(t,e,"0")}function w(t){return null!=t&&("string"!=typeof t&&(!String(tt(t)).startsWith("1970-01-01T00:00:00")&&(!!b(z(t))&&(!!M(V(t))&&(t instanceof r.DateTime?t.isValid:P(z(t),V(t),W(t)))))))}function b(t){return m.within(e.minYear,e.maxYear,t)}function M(t){return m.within(1,12,t)}function P(t,e,n){return null!=n&&r.DateTime.fromObject({year:t,month:e,day:n}).isValid}function x(t,e,n){return b(t)&&(null==e||M(e)&&(null==n||P(t,e,n)))}e.validDate=w,e.minYear=1826,e.maxYear=(new Date).getFullYear()+2,e.validYear=b,e.validMonth=M,e.validDay=P,e.validYMD=x;class E{constructor(t,e,n){this.year=t,this.month=e,this.day=n}static for(t,e,n){return x(t,e,n)?new E(t,e,n):void 0}static localToday(){return it(new Date)}toString(){return o.compact([this.year,this.month,this.day]).map(t=>S(t)).join("-")}toISOString(){return this.toString()}toDateTime(){return r.DateTime.fromObject(this)}}e.FuzzyDate=E;class _{constructor(t,e,n,i,r){this.monthsToMonth=t,this.re=e,this.yearIndex=n,this.monthIndex=i,this.dayIndex=r}apply(t){const e=this.re.exec(t);if(null!=e){const t=parseInt(e[this.yearIndex],10),n=this.month(e),i=null==this.dayIndex?void 0:parseInt(e[this.dayIndex],10);return E.for(t,n,i)}}month(t){if(null==this.monthIndex)return;const e=t[this.monthIndex].toLowerCase();return this.monthsToMonth.has(e)?this.monthsToMonth.get(e):m.toInt(e)}}const T="((?:19|20)[0-9]{2})",O="(1[0-2]|0?[1-9])",k="([1-3][0-9]|0?[1-9])",F="([0-5][0-9])",I="([-\\.\\,:_/ |])?";function D(t,e){const n=e.exec(t);if(null==n)return;const i=[...n.slice(1)],[o,s,a,u,l,h]=i.splice(0,6).map(t=>m.toInt(t)),f=m.clamp(0,999,1e3*m.toFloat(i.shift(),{defaultValue:0})),p=J(function(t,e){if(d.isEmpty(t))return e;const[n,i]=t.splice(0,2),[r,o]=t.splice(0,2).map(t=>m.toInt(t));return v.equalsIgnoreCase(n,"z")?0:d.anyNotDefined([i,r,o])?e:("-"===i?-1:1)*(60*r+o)}(i));return c.Opt(r.DateTime.fromObject({year:o,month:s,day:a,hour:u,minute:l,second:h,millisecond:f,zone:p})).filter(t=>t.isValid).flatMap(t=>Q(t,p)).get()}const C=new RegExp([T,"(1[0-2]|0[1-9])","([1-3][0-9]|0[1-9])","(1[0-9]|2[0-3]|0[0-9])",F,F,"(?:(\\.[0-9]+))?"].join("[-:_ ]?")+"(?:(Z)|(?:([+-])([01][0-9]):?([0-5][0-9])))?","i");function L(t){return D(t,C)}function A(t,e=!0){return f.mapNotBlank(t,t=>g.firstTrueThunk([()=>p.DateInterval.parse(t),()=>i.ExifDateTime.fromEXIF(t),()=>e?i.ExifDate.fromEXIF(t):void 0,()=>L(t),()=>e?i.ExifDate.fromEXIF(t):void 0,()=>e?N().parseYMD(t):void 0],t=>w(t)))}e.parseFuzzyDatetime=L,e.dateTimeBetween=function(t,e){return t.until(e).divideEqually(2)[0].end},e.agoMs=function(t){return l.mapNumeric(X(t),t=>Date.now()-t)},e.parseDatedWithTime=function(t){return A(t,!1)},e.parseDated=A;class R{constructor(t){this.locale=t,this.monthsToMonth=new Map,this.ymdPatterns=[],this.ymPatterns=[],this.setup()}parseYMD(t){return d.first(this.ymdPatterns,e=>e.apply(t))}addParser(t,e,n,i){const r=new _(this.monthsToMonth,new RegExp(t+"(?:$|[^\\d])","i"),e,n,i);null!=i&&null!=n?this.ymdPatterns.push(r):null!=n&&this.ymPatterns.push(r)}setup(){["short","long"].forEach(t=>{const e=new Intl.DateTimeFormat(this.locale,{month:t});m.times(12,t=>{const n=e.format(new Date(2017,t));this.monthsToMonth.set(n.toLowerCase(),t+1)})});const t="("+d.sort([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(T+I+O+"\\2"+k,1,3,4),this.addParser(T+I+t+"\\2"+k,1,3,4),this.addParser(t+I+k+",?\\2"+T,4,1,3),this.addParser(k+I+t+",?\\2"+T,4,3,1),this.addParser(t+I+T,3,1),this.addParser(T+I+t,1,3)}extractDateFromPath(t){B.forEach(e=>{d.startsWith(t,e)&&t.splice(0,e.length)}),t=t.filter(e=>s.notBlank(e)&&null==t[0].match(j));const e=[...t].reverse();return g.firstThunk(()=>d.first(e,t=>this.parseYMD(t)),()=>this.parseYMD(t.join(" ")),()=>this.parseYMD(e.join(" ")),()=>d.first(this.ymPatterns,e=>e.apply(t.join(" "))),()=>d.first(this.ymPatterns,t=>t.apply(e.join(" "))))}}e.FuzzyDateParser=R;const j=/^((DCIM)|(DSC[_0F]?|IMG_|GOPRO|MOV_|P)\d+)$/i,N=h.lazy(()=>new R(void 0)),B=[];function z(t){return g.map(t,t=>t instanceof Date?t.getFullYear():t.year)}function V(t){return g.map(t,t=>t instanceof Date?t.getMonth()+1:t.month)}function W(t){return g.map(t,t=>t instanceof Date?t.getDate():t.day)}function G(t){return ot(t)?t instanceof Date?t.getHours():t.hour:void 0}function U(t){return ot(t)?t instanceof Date?t.getMinutes():t.minute:void 0}function q(t){return ot(t)?t instanceof Date?t.getSeconds():t.second:void 0}function H(t){return ot(t)?t instanceof Date?t.getMilliseconds():t.millisecond:void 0}function $(t){return g.map(q(t),e=>{const n=g.orElse(H(t),0);let i=(e+n/1e3).toString();for(e<10&&(i="0"+i),0===n&&(i+=".");i.length<6;)i+="0";return i})}function J(t){if(null==t)return;if(0===t)return"UTC";const e=t<0?"-":"+",n=15*l.round(t/15),i=Math.abs(n),r=Math.floor(i/60),o=Math.floor(Math.abs(i%60));return`UTC${e}${S(r)}:${S(o)}`}function K(t){return!l.isNumber(t)&&(t instanceof i.ExifDateTime?null!=t.tzoffsetMinutes:t instanceof r.DateTime&&null!=t.offsetNameShort)}function Y(t){return t instanceof r.DateTime?g.map(t.offsetNameShort,()=>J(t.offset)):t instanceof i.ExifDateTime?J(t.tzoffsetMinutes):void 0}function Q(t,e){const n=X(t);if(null==n||!ot(t))return;const r=s.blank(e)?K(t)?Y(t):void 0:e,o=f.mapNotBlank(r,t=>st(n,t));return null==e||null!=o?g.map(z(t),e=>g.map(V(t),n=>g.map(W(t),r=>g.map(G(t),s=>new i.ExifDateTime(e,n,r,s,g.orElse(U(t),0),g.orElse(q(t),0),H(t),o,t.rawValue))))):void 0}function Z(t){if(null==t)return;if("number"==typeof t)return new Date(t);if(t instanceof Date)return t;if(t instanceof r.DateTime)return t.toJSDate();if(t.toDate)return t.toDate();if(m.gt0(t.year)&&m.gt0(t.month)&&m.gt0(t.day))return new Date(t.year,g.orElse(t.month,1)-1,t.day,12);const e=y.toS(t);return s.notBlank(e)?g.map(et(e),Z):void 0}function X(t){if(null!=t)return l.isNumber(t)?t:t instanceof Date?t.getTime():t instanceof r.DateTime?t.toMillis():g.map(Z(t),t=>t.getTime())}function tt(t,e=!0){if(t instanceof p.DateInterval)return t.toString(e);const n=l.isNumber(t)?new Date(t):t,i=nt(n);if(!ot(n))return i;const r=`${S(G(n))}:${S(U(n))}:${$(n)}`,o=g.map(e&&K(t)?Y(n):void 0,t=>"UTC"===t?"Z":v.stripPrefix(t,"UTC"));return i+"T"+r+y.toS(o)}function et(t,e){return"string"!=typeof t||s.blank(t)?void 0:c.Opt(i.ExifDateTime.fromISO(t,e)).orElse(()=>i.ExifDate.fromISO(t)).orElse(()=>i.ExifTime.fromEXIF(t)).get()}function nt(t){return o.compact([z(t),V(t),W(t)]).map(t=>S(t)).join("-")}function it(t){return g.map(t,t=>g.map(z(t),e=>new E(e,V(t),W(t))))}function rt(t,e){const[n,i]=[t,e].map(X);return null==n||null==i?void 0:n-i}function ot(t){return t instanceof Date||t instanceof i.ExifDateTime||t instanceof r.DateTime}function st(t,e){const n=r.Info.normalizeZone(e);return n.isValid?n.offset(t):void 0}e.addIgnorableSubpath=function(t){B.push(t)},e.clearIgnorableSubpaths=function(){B.length=0},e.extractDateFromPath=function(t){return N().extractDateFromPath(t)},e.parseYMD=function(t){return N().parseYMD(t)},e.isDated=function(t){return t instanceof E||t instanceof i.ExifDate||t instanceof i.ExifDateTime||t instanceof Date||t instanceof p.DateInterval||t instanceof r.DateTime},e.getYear=z,e.getMonth=V,e.getDay=W,e.getHour=G,e.getMinute=U,e.getSecond=q,e.getMillisecond=H,e.hasSeconds=function(t){return ot(t)&&(m.gt0(U(t))||m.gt0(q(t))||m.gt0(H(t)))},e.getSecMs=$,e.zoneOffsetToName=J,e.hasZoneOffset=K,e.getZoneName=Y,e.toDateTime=Q,e.toDate=Z,e.datedToMillis=X,e.datedToISO=tt,e.fromISO=et,e.datedToYMD=nt,e.toFuzzyDate=it,e.sameDay=function(t,e){return a.eql(it(t),it(e))},e.diffMillis=rt,e.closeTo=function(t,e,n){return u.mapOr(rt(t,e),t=>Math.abs(t)<n,()=>!1)},e.gtDate=function(t,e){const n=X(t),i=X(e);return null!=n&&null!=i&&n>i},e.nowish=function(t,e=2500){const n=X(t),i=Date.now();return m.within(i-e,i+e,n)},e.dateBetween=function(t,e,n=1,i=1){if(null==X(t)||null==X(e))return;const[o,s]=[t,e].map(t=>X(t)).sort(),a=(s-o)/(i+1),u=Y(t),l=u===Y(e)?u:void 0,c=r.DateTime.fromMillis(o+a*n,{zone:l});return[t,e].some(t=>!ot(t))?it(c):c},e.hasTime=ot,e.zoneToOffset=st},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(9),r=n(84);var o=n(9);e.tap=o.tap,e.atap=function(t,e){return r.isPromise(t)?r.thenTap(t,e):i.tap(t,e)},e.amap=function(t,e){return r.isPromise(t)?t.then(t=>e(t)):e(t)},e.awaitAll=function(t){return t.some(t=>r.isPromise(t))?Promise.all(t):t}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(30),r=n(6),o=n(17),s=n(18),a=n(4),u=n(10),l=n(23),c=n(13),d=i.posix;function h(t){return i.sep===d.sep?t:d.sep===i.sep?t:t.split(i.sep).join(d.sep)}e.posix2native=function(t,e){if(i.sep===d.sep)return t;const n=u.notBlank(e)?i.sep+i.sep+e+i.sep:"",r=t.split(d.sep);return c.equalsIgnoreCase(r[0],e)&&r.unshift(),n+r.join(i.sep)},e.native2posix=h;const f=/^([A-Z]:)[\\\/]?(.*)$/i;e.resolve=function(...t){const e=i.join(...t);return i.resolve(l.isWin?function(t){const e=f.exec(t);return null!=e?e[1].toUpperCase()+"\\"+e[2]:t}(e):e)};const p=/(\.?.*?)(\.[a-z]{1,10}\.(?:gz|z|xz|bz2))$/i;function m(t){const e=p.exec(t);return null!=e&&u.notBlank(e[2])?e[2]:i.extname(t)}function g(t){return c.stripPrefix(t,i.sep).split(i.sep)}e.parse=function(t){const e=i.parse(t),n=m(e.base),r=c.stripSuffix(e.base,n);return Object.assign({},e,{ext:n,name:r})},e.extname2=m,e.containedBy=function(t,e){return u.notBlank(t)&&u.notBlank(e)&&(t===e||t.startsWith(c.ensureSuffix(e,d.sep)))},e.containedByNativePath=function(t,e){return u.notBlank(t)&&u.notBlank(e)&&(t===e||t.startsWith(c.ensureSuffix(e,i.sep)))},e.pathnames=g,e.posixPathFrom=function(t,e){return t.nativePath===e.nativePath?"":c.stripPrefix(h(e.nativePath),c.ensureSuffix(h(t.nativePath),"/"))},e.posixPathFromGrandparent=function(t){return g(t).slice(-3).join("/")};const v=/(.*?)(?:-(\d+)|\((\d+)\))$/;e.nameWithoutCount=function(t){return r.mapOr(s.toS(t).match(v),t=>t[1],()=>t)},e.countFromName=function(t){return r.map(s.toS(t).match(v),t=>a.first([t[2],t[3]],o.toInt))}},function(t,e,n){"use strict";function i(t){if("boolean"==typeof t)return t;if(null==t)return!1;const e=String(t).toLowerCase();return["true","1"].includes(e)}function r(t){if("boolean"==typeof t)return!t;if(null==t)return!1;const e=String(t).toLowerCase();return["false","0"].includes(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.isBoolean=function(t){return"boolean"==typeof t},e.truthy=i,e.toBoolean=function(t){return!!i(t)||!r(t)&&void 0},e.boolToInt=function(t){return i(t)?1:0},e.falsy=r,e.or=function(t){return t.some(t=>i(t))},e.and=function(t){return t.every(t=>i(t))}},function(t,e){t.exports=require("path")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(65),o=n(5),s=n(16),a=n(46),u=n(9),l=n(15),c=n(39),d=n(4),h=n(21),f=n(58),p=n(3),m=n(2),g=n(132),v=n(10),y=n(63),S=n(11),w=n(14),b=n(228),M=n(32),P=n(114),x=n(163),E=n(86),_=n(1),T=n(0),O=n(23),k=n(12),F=n(19),I=n(82),D=n(76),C=n(236),L=n(237),A=n(238),R=n(239),j=n(94),N=n(240),B=n(241),z=n(115),V=n(150),W=_.mkLogger("ExifTags");let G=1;e.setMaxProcs=function(t){return i(this,void 0,void 0,function*(){G=t;const e=U.prior();null!=e&&e.options.maxProcs!==t&&(U.clear(),yield e.end())})};const U=p.lazy(()=>{return g.observeBatchCluster(new r.ExifTool({maxProcs:G,cleanupChildProcs:!1}),"exiftool",h.EndableRanks.service)});function q(){const t=U();return t.ended?U.refresh():t}e.exiftool=q,e.shutdownExiftool=function(t){return T.map(U.prior(),e=>e.end(t))},e.extractBinaryTag=function(t,e,n){return q().extractBinaryTag(t,e,n)};const H=new y.BoundedMap(3*S.minuteMs,1024,!0);function $(){H.clear(),e.rawTagsCache.clear()}e.rawTagsCache=new y.BoundedMap(3*S.minuteMs,1024,!0),e.clearTagsCache=$,w.onClearCache($),w.onFileChanged(t=>{v.blank(t)?$():(H.deleteIf(e=>e.startsWith(t)),e.rawTagsCache.deleteIf(e=>e.startsWith(t)))});const J=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];function K(t){return i(this,void 0,void 0,function*(){if(null==t)return;const e=M.PosixFile.for(t);return(yield e.isEmpty())?void 0:H.getOrSet(e.nativePath,()=>i(this,void 0,void 0,function*(){const t=yield S.thenElapsed(m.thenMap(X(e),t=>it(e,t)));return W.info("readTags("+e+") in "+t.elapsedMs+" ms"),t.result}))})}function Y(t){return i(this,void 0,void 0,function*(){return H.get(String(t))})}function Q(t){return i(this,void 0,void 0,function*(){if(v.blank(t))return;const e=M.PosixFile.for(t);return m.firstDefinedPromise(()=>m.thenMap(Y(e),t=>t.MIMEType),()=>m.thenMap(b.readFileType(e.nativePath),t=>t.mime),()=>m.thenMap(X(e,!1),t=>t.MIMEType))})}function Z(t,e="_original"){return i(this,void 0,void 0,function*(){return t.sibling(t.base+e).saveIfNewOrDelete(t.name+e+t.ext)})}function X(t,e=!0){return i(this,void 0,void 0,function*(){const n=yield nt(t.nativePath);if(null==n||!e)return n;const r=[],s=m.thenMap(t.jsonSidecar(),t=>i(this,void 0,void 0,function*(){const e=yield N.readJsonSidecar(t);return null!=e&&r.push(t.base),e})),a=m.thenMap(t.sidecars(),t=>m.tuples(t,t=>nt(t.nativePath)));let l=Object.assign({},n,yield s);for(const[t,e]of o.toA(yield a))r.push(e.base),l=Object.assign({},l,u.compactValues(T.without(t,...J)));return d.isNotEmpty(r)&&(l.sidecars=r),l})}e.sidecarEql=function(t,e){return i(this,void 0,void 0,function*(){const n=t=>m.thenMap(X(t,!1),t=>T.without(t,...J));return(yield a.eqlAsync(t.clear().sha(),e.clear().sha()))||(yield a.eqlAsync(n(t),n(e)))})},e.readTags=K,e.cachedTags=Y,e.capturedAt=function(t){return i(this,void 0,void 0,function*(){return m.thenMap(K(t),t=>t.capturedAt)})},e.mimetype=Q,e.rotation=function(t){return i(this,void 0,void 0,function*(){return m.thenMap(K(t),t=>t.rotation)})},e.isMimetype=function(t,e){return i(this,void 0,void 0,function*(){const n=yield Q(t);return null!=n&&e.has(n)})},e.exifUid=function(t){return i(this,void 0,void 0,function*(){return m.thenMap(K(t),t=>t.exifUid)})},e.exifUid4=function(t){return i(this,void 0,void 0,function*(){return m.thenMap(K(t),C.extractUid4)})},e.exifUid5=function(t){return i(this,void 0,void 0,function*(){return l.Opt(yield K(t)).flatMap(t=>L.extractUidPojo5(t,t.capturedAt)).flatMap(L.serializeUidPojo5).get()})},e.exifUid6=function(t){return i(this,void 0,void 0,function*(){return l.Opt(yield K(t)).flatMap(t=>A.extractUidPojo6(t,t.capturedAt)).flatMap(D.serializeUidPojo).get()})},e.exifUid7=function(t){return i(this,void 0,void 0,function*(){return l.Opt(yield K(t)).flatMap(t=>R.extractUidPojo7(t,t.capturedAt)).flatMap(D.serializeUidPojo).get()})},e.exifUids=function(t){return i(this,void 0,void 0,function*(){return T.map(yield K(t),t=>v.compactBlanks([C.extractUid4(t),T.map(L.extractUidPojo5(t,t.capturedAt),L.serializeUidPojo5),T.map(A.extractUidPojo6(t,t.capturedAt),D.serializeUidPojo),T.map(R.extractUidPojo7(t,t.capturedAt),D.serializeUidPojo)]))})},e.duration=function(t){return i(this,void 0,void 0,function*(){return m.thenMap(K(t),t=>t.Duration)})},e.dimensions=function(t){return i(this,void 0,void 0,function*(){return m.thenMap(K(t),t=>t.dimensions)})},e.moveOriginal=Z,e.writeTags=function(t,e){return i(this,void 0,void 0,function*(){const n=yield t.sidecar(),i=k.Settings.writeMetadataToSidecars.valueOrDefault||(yield n.exists())?n:t;yield q().write(i.nativePath,e);const r=yield Z(i);return o.uniq([t.nativePath,i.nativePath]).forEach(w.emitFileChanged),i.clearThisAndParent(),{original:r,dest:i}})},e.readRawTags=X;const tt=new f.Latch,et=new f.Latch;function nt(t){return i(this,void 0,void 0,function*(){return e.rawTagsCache.getOrSet(t,()=>i(this,void 0,void 0,function*(){W.debug("readRawTags("+t+")");const e=tt.pending;e?tt.resolve():yield et.promise;const n=yield m.thenOrTimeout(S.thenElapsed(q().read(t).catch(e=>{W.info("Failed to read "+t,e)})),30*s.secondMs);return e&&et.resolve(),T.map(n,e=>(W.debug("read("+t+") in "+e.elapsedMs+"ms"),T.map(e.result,t=>{const n=v.compactBlanks([t.Error,...T.orElse(t.errors,[]),t.Warning].map(F.toS));return d.isNotEmpty(n)&&(t.problems=n),t.exiftoolMs=e.elapsedMs,t})))}))})}function it(t,e){return i(this,void 0,void 0,function*(){if(null==e)return;const n=e.MIMEType,i=t.nativePath;if(v.blank(n))return void W.debug("No mimetype for "+t);const r=t.nativePath.startsWith(c.App.getPath("temp"))||t.pathnames.includes(".photostructure");r||(yield V.inferMakeAndModel(t,e)),e.Make=B.make(e.Make),e.Model=B.model(e.Make,F.toS(e.Model));const o=yield I.extractCapturedAt(t,e,r);if(null==o)return void W.info("No capturedAt for "+t);const s=j.extractExposureSettings(e),a=R.extractUidPojo7(e,o,s),u=T.map(a,D.serializeUidPojo),l=T.firstDefined(z.extractRotation(e),0);let d=z.extractSizeInfo(e,l);if(null==d&&E.vlcSupportedMimeType(n)){W.debug("Trying to extract video dimensions from frame...");const e=yield x.extractVideoFrame(M.PosixFile.for(t),n);null!=e&&(d=yield m.thenMap(K(e),t=>z.extractSizeInfo(t,l)))}if(null==d)return void W.info("No size info for "+i);const h=Object.assign({mimetype:n,exposureSettings:s,rotation:l},d,{capturedAt:o,geohash:P.geohash_num(e.GPSLatitude,e.GPSLongitude),exifUidPojo:a,exifUid:u,tz:e.tz});return W.debug("parsedTags",Object.assign({nativePath:i},h,{tzSource:e.tzSource,capturedAt:T.map(o,t=>({date:t.date.toString(),src:t.src}))})),Object.assign({},e,h)})}O.isWin||(tt.resolve(),et.resolve()),e.parseTags=it},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(30),o=n(109),s=n(5),a=n(6),u=n(17),l=n(15),c=n(70),d=n(4),h=n(3),f=n(2),p=n(10),m=n(20),g=n(11),v=n(14),y=n(1),S=n(48),w=n(73),b=n(23),M=n(12),P=n(13),x=n(103),E=n(49),_=n(40),T=n(34),O=n(135),k=n(160),F=n(161),I=n(140),D=n(28),C=new T.FileCache;e.groupByMountpoint=function(t,e){return w.groupBy(t,t=>a.map(t.bestMountpoint(e),t=>t.nativePath))},e.coallesce=function(t,e){const n=w.groupBy(t,t=>a.map(t.bestMountpoint(e),t=>t.nativePath));return s.sortBy(d.flatten(s.toA(n.values()).map(t=>d.contextFilter(s.sort(t),(t,e,n)=>null==n||!t.isDescendantOf(n)))),t=>t.pathnames)};class L extends T.BaseFile{constructor(t,e){super(t,e),this.nativePath=t,this.pflog=h.lazy(()=>y.mkLogger("PosixFile("+this.nativePath+")")),this.uriObject=h.lazy(()=>O.file2voluri(this)),this.uri=h.lazy(()=>f.thenMap(this.uriObject(),t=>o.format(t))),this.fileuri=h.lazy(()=>O.file2fileuri(this)),this.mountpoint=h.lazy(()=>f.thenMap(_.mountpoints(),t=>this.bestMountpoint(t.map(t=>this.for(t))))),this.etag=h.lazy(()=>f.thenMap(this.stat(),t=>[t.size,t.mtime.getTime()].map(t=>S.Radix58.encode(t)).join("-"))),this.ignorable=h.lazy(()=>i(this,void 0,void 0,function*(){return(yield this.isDirectory())?F.ignorableDirectory(this):F.ignorableFile(this)})),this.hidden=h.lazy(()=>k.hidden(this)),this.isMountpoint=h.lazy(()=>i(this,void 0,void 0,function*(){return(yield this.isDirectory())&&(yield f.thenMapOr(_.mountpoints(),t=>t.includes(this.nativePath),()=>!1))})),this.sidecars=h.lazy(()=>i(this,void 0,void 0,function*(){if(this.isSidecar())return[];const t=yield this.dirEntSiblings(t=>t.filter(t=>E.isSidecarExt(t.ext)&&(t.name===this.name||D.nameWithoutCount(t.name)===D.nameWithoutCount(this.name))));return f.sortByAsync(s.toA(t),t=>t.mtimeMs())})),C.set(t,this)}static for(t,e){if(t instanceof L)return t;if(t instanceof T.BaseFile)return this.for(t.nativePath,e);if(O.isUri(t))throw new Error("use forUri");const n=C.get(t);if(null!=n)return n;const i=D.resolve(t);return C.getOrSet(i,()=>new L(i,e))}static forPosix(t){return this.for(t.replace(/\//g,r.sep))}static forUri(t,e){return f.thenMap(O.uri2file(t,e),t=>this.for(D.posix2native(t.posixPath,t.hostname)))}static forUriOrPath(t,e){return f.firstDefinedPromise(()=>this.forUri(t),()=>this.for(e))}for(t,e){return L.for(t,e)}clear(){return super.clear(),this.uriObject.clear(),this.uri.clear(),this.fileuri.clear(),this.mountpoint.clear(),this.etag.clear(),this.ignorable.clear(),this.hidden.clear(),this.sidecars.clear(),this}bestMountpoint(t){return d.greatestBy(t.filter(t=>this.isDescendantOf(t)),t=>l.Opt(s.commonPrefixLength(this.pathnames,t.pathnames)).filter(e=>e>=t.pathnames.length).get())}httpHeaders(){return i(this,void 0,void 0,function*(){return{ETag:yield this.etag(),"Last-Modified":yield this.lastModifiedUtc()}})}hide(){return i(this,void 0,void 0,function*(){const t=yield b.isWin?m.stdout("attrib",["+h",this.nativePath],{timeout:10*g.secondMs}).catch(t=>t):b.isMac?m.stdout("chflags",["hidden",this.nativePath],{timeout:10*g.secondMs}).catch(t=>t):"";return p.notBlank(t)?void this.pflog().warn("hide("+this.nativePath+") failed: "+t):this.clear()})}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(t=>t.ignorable()))}mkNoMedia(){return this.join(".NoMedia").writeTxt("See <https://support.photostructure.com/no-media/>").then(t=>t?(v.emitFileChanged(this.nativePath),this):void 0).catch(t=>{this.pflog().warn("Could not add .NoMedia file to "+this,t)})}noMediaDir(){return i(this,void 0,void 0,function*(){return I.hasNoMedia(yield this.directoryEntry())})}ignorableCheap(){return F.ignorablePath(this.nativePath)}isSidecar(){return E.isSidecarExt(this.ext)}sidecar(){return i(this,void 0,void 0,function*(){return c.thenOpt(this.sidecars()).flatMap(t=>t[t.length-1]).getOrElse(()=>this.sibling(this.name+E.asExt(M.Settings.defaultSidecarType.valueOrDefault)))})}jsonSidecar(){return i(this,void 0,void 0,function*(){const t=yield this.dirEntSiblings(t=>t.filter(t=>P.equalsIgnoreCase(t.ext,".json")&&(t.name===this.name||t.name===this.base||D.nameWithoutCount(t.name)===D.nameWithoutCount(this.name)))),e=s.sortBy(s.toA(t),t=>-x.diceCoeff(this.name,t.name))[0];return this.pflog().debug("jsonSidecar(): "+e),e})}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",()=>i(this,void 0,void 0,function*(){const t=yield this.mtimeMs(),e=yield this.sidecars(),n=[t,...yield Promise.all(s.toA(e).map(t=>t.mtimeMs()))].filter(u.gt0);return s.mapNotEmpty(n,t=>Math.floor(Math.max(...t)))}))}thisOrSidecareMaxMtimeSec(){return f.thenMap(this.thisOrSidecareMaxMtimeMs(),t=>g.unixtime(t))}}e.PosixFile=L},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(9);e.strEnum=function(...t){return Object.freeze(t.reduce((t,e)=>(t[e]=e,t),Object.create(null)))},e.strEnumValues=function(t){return i.keys(t)},e.enumHas=function(t,e){return"string"==typeof e&&t[e]===e}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(43),o=n(99),s=n(30),a=n(145),u=n(96),l=n(42),c=n(183),d=n(5),h=n(80),f=n(6),p=n(15),m=n(4),g=n(36),v=n(37),y=n(3),S=n(92),w=n(2),b=n(10),M=n(63),P=n(20),x=n(11),E=n(14),_=n(26),T=n(1),O=n(57),k=n(7),F=n(0),I=n(23),D=n(13),C=n(103),L=n(19),A=n(24),R=n(139),j=n(173),N=n(52),B=n(28),z=n(104),V=n(106),W=n(88),G=n(54),U=n(188);e.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1}),e.execDir=function(){return K.for(process.execPath).parent()};const q=x.minuteMs,H=500;class $ extends M.BoundedMap{constructor(){super(q,H,!0),E.onFileChanged(t=>this.clearFromPath(t)),E.onClearCache(()=>this.clearEntries()),this.on("expire",(t,e)=>F.map(e,t=>t.clear()))}clearEntries(){for(const t of this.values())t.clear()}clearFromPath(t){for(const e of this.values())(null==t||e.nativePath.startsWith(t))&&e.clear()}}e.FileCache=$;const J=new $;class K{constructor(t,e){if(this.dirent=e,this.bflog=y.lazy(()=>T.mkLogger("BaseFile("+this.nativePath+")")),this.dirents=y.lazy(()=>i(this,void 0,void 0,function*(){return w.thenMap(this.directoryEntry(),t=>t.children())})),this.stat=y.lazy(()=>this.trap("stat",()=>o.stat(this.nativePath).catch(()=>void 0)),K.attrTTL),this.statSync=y.lazy(()=>this.trapSync("statSync",()=>F.Try(()=>o.statSync(this.nativePath))),K.attrTTL),this.executable=y.lazy(()=>this.access(o.constants.R_OK|o.constants.X_OK)),this.shaResult=y.lazy(()=>i(this,void 0,void 0,function*(){const t=yield this.size();if(0===t||null==t)return;const e=t>5*k.MiB?new z.PushProgressObserver({op:"SHA",path:this.nativePath},t):void 0;return x.elapsedAsync(()=>this.trap("sha",()=>N.fileSha(this.nativePath,{observer:e}).then(t=>t.toString("base64"))))}),K.attrTTL),null!=e)this.nativePath=e.nativePath,this.dir=e.dir,this.base=e.base,this.name=e.name,this.ext=e.ext;else{this.nativePath=B.resolve(t),this.nativePath.startsWith("\\\\")&&(this.hostname=this.nativePath.split("\\")[2]);const e=B.parse(this.nativePath);this.dir=e.dir,this.base=e.base,this.name=e.name,this.ext=e.ext}this.posixPath=B.native2posix(this.nativePath),J.set(t,this)}[l.inspect.custom](){return{ctor:this.constructor.name,nativePath:this.nativePath}}static withFastestAccess(t){return i(this,void 0,void 0,function*(){const e=m.compact(t),n=yield Promise.all(e.map(t=>t.shaMs()));return e[m.leastIndex(n)]})}static forPosix(t){return t instanceof K?t:this.for(D.replaceAll(t,"/",s.sep))}static forDirectoryEntry(t){return this.for(t.nativePath,t)}static for(t,e){if(t instanceof K)return t;const n=J.get(t);if(null!=n)return n;const i=B.resolve(t);return J.getOrSet(i,()=>new K(i,e))}static clear(t){E.emitFileChanged(t)}for(t,e){return K.for(t,e)}clear(){return this.dirent=void 0,this.dirents.clear(),this.stat.clear(),this.statSync.clear(),this.executable.clear(),this.shaResult.clear(),this}clearThisAndParent(){return E.emitFileChanged(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(t){return null!=t&&this.nativePath===t.toString()}get baseWithParent(){return(this.isRoot?"":this.parent().base)+"/"+this.base}get baseWithGrandparent(){return(this.isRoot?"":this.parent().baseWithParent)+"/"+this.base}posixPathFrom(t){return B.posixPathFrom(t,this)}directoryEntry(){return i(this,void 0,void 0,function*(){if(null==this.dirent){const t=yield this.isFile(),e=yield this.isDirectory(),n=yield this.isSymbolicLink(),i={name:this.base,isFile:function(){return t},isDirectory:function(){return e},isSymbolicLink:function(){return n}};this.dirent=new j.DirectoryEntry(this.dir,i)}return this.dirent})}_child(t){return this.for(s.join(this.nativePath,t.base),t)}childNames(){return w.thenMap(this.dirents(),t=>t.map(t=>t.base))}children(t){return i(this,void 0,void 0,function*(){return w.thenMap(this.dirents(),e=>w.thenCompact(e.map(e=>i(this,void 0,void 0,function*(){return S.apply(this._child(e),t)}))))})}childFiles(t){return i(this,void 0,void 0,function*(){const e=[];for(const n of d.toA(yield this.dirents()))if(n.isFile()){const i=this._child(n);(null==t||t(i))&&e.push(i)}return e})}childDirectories(t){return i(this,void 0,void 0,function*(){return w.thenMap(this.dirents(),e=>w.thenCompact(e.filter(t=>t.isDirectory()).map(e=>i(this,void 0,void 0,function*(){return S.apply(this._child(e),t)}))))})}childrenSync(){return F.orElse(this.trapSync("childrenSync",()=>r.readdirSync(this.nativePath).map(t=>this.join(t))),[])}hasChildren(t){return i(this,void 0,void 0,function*(){const e=yield this.childNames();return m.isNotEmpty(t)?d.includesAll(e,t):m.isNotEmpty(e)})}hasNoChildren(){return i(this,void 0,void 0,function*(){return(yield this.isFile())||m.isEmpty(yield this.childNames())})}visitDescendants(t){return i(this,void 0,void 0,function*(){return w.thenMap(this.children(),e=>i(this,void 0,void 0,function*(){for(const n of e)yield n.visitDescendants(t),yield t(n)}))})}descendants(t){return i(this,void 0,void 0,function*(){const e=[];for(const n of d.toA(yield this.childFiles()))(yield t(n))&&e.push(n);const n=yield this.childDirectories();if(null!=n){for(const i of n)yield w.thenMap(i.descendants(t),t=>e.push(...t));return e}})}ancestorWithChildren(t){return i(this,void 0,void 0,function*(){return(yield this.hasChildren(t))?this:this.isRoot?void 0:this.parent().ancestorWithChildren(t)})}siblings(){return i(this,void 0,void 0,function*(){return this.selfAndSiblings().then(t=>t.filter(t=>!this.eql(t)))})}dirEntSiblings(t){return i(this,void 0,void 0,function*(){return w.thenMap(this.parent().dirents(),e=>t(e).map(t=>this.parent()._child(t)))})}selfAndSiblings(){return i(this,void 0,void 0,function*(){return this.parent().children()})}firstExistingSelfOrAncestor(){return i(this,void 0,void 0,function*(){return this.isRoot||(yield this.exists())?this:this.parent().firstExistingSelfOrAncestor()})}get pathnames(){return this.nativePath.split(s.sep).filter(t=>null!=t&&""!==t)}get pathnamesWithoutDrive(){return I.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(I.isWin?1:0)}get isRoot(){return this.pathnames.length===(I.isWin?1:0)}root(t=0){return this.depth<=t?this:this.parent().root(t)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(t){return null!=t&&m.startsWith(t.pathnames,this.pathnames)}isDescendantOf(t){return null!=t&&m.startsWith(this.pathnames,t.pathnames)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(t){return[this,...this.isRoot||t<=0?[]:this.parent().selfAndParents(t-1)]}parents(){const t=this.parent();return this.isRoot?[]:[...t.parents(),t]}sibling(t){return this.parent().join(t)}withPrefix(t){return this.sibling(t+this.base)}withNameSuffix(t){return this.sibling(this.name+t+this.ext)}siblingOf(t){return this.nativePath!==t.nativePath&&this.dir===t.dir}join(...t){return m.isEmpty(t)?this:this.for(s.join(this.nativePath,...t))}child(...t){return m.isEmpty(t)?this:this.join(...B.native2posix(s.join(...t)).split("/").filter(t=>".."!==t))}trap(t,e,n="warn"){return i(this,void 0,void 0,function*(){try{const i=yield e();return this.bflog().trace(`trap ${t}()`,Buffer.isBuffer(i)?"<Buffer>":i),i}catch(e){return void this.bflog().log(n,`trap: ${t}() failed: ${e}`)}})}trapOr(t,e,n="warn"){return i(this,void 0,void 0,function*(){try{return this.bflog().debug(`trapOr ${t}()`),yield e(),!0}catch(e){return this.bflog().log(n,`trapOr: ${t}() failed: ${e}`),!1}})}trapSync(t,e){try{return this.bflog().debug(`trapSync ${t}()`),e()}catch(e){return void this.bflog().warn(`trapSync: ${t}() failed: ${e}`)}}exists(){return i(this,void 0,void 0,function*(){return null!=this.dirent||(yield w.thenDefined(this.stat()))})}existsSync(){return null!=this.dirent||null!=this.statSync()}notExists(){return i(this,void 0,void 0,function*(){return w.thenNot(this.exists())})}mtime(){return w.thenMap(this.stat(),t=>t.mtime)}mtimeMs(){return w.thenMap(this.stat(),t=>Math.floor(t.mtimeMs))}mtimeSec(){return w.thenMap(this.stat(),t=>x.unixtime(t.mtime))}lastModifiedUtc(){return i(this,void 0,void 0,function*(){return w.thenMap(this.stat(),t=>t.mtime.toUTCString())})}statTimes(){return w.thenMap(this.stat(),t=>d.uniq([t.birthtimeMs,t.mtimeMs].filter(t=>null!=t&&0!==t)))}maxStatMs(){return w.thenMap(this.statTimes(),m.max)}maxStatDate(){return w.thenMap(this.maxStatMs(),t=>new Date(t))}minStatMs(){return w.thenMap(this.statTimes(),O.min)}minStatDate(){return w.thenMap(this.minStatMs(),t=>new Date(t))}size(){return w.thenMap(this.stat(),t=>t.size)}access(t){return this.trapOr("access("+t+")",()=>o.access(this.nativePath,t))}isReadable(){return this.access(o.constants.R_OK)}isHiddenPosix(){return this.base.startsWith(".")}isEmpty(){return i(this,void 0,void 0,function*(){if(yield this.isDirectory())return m.isNotEmpty(yield this.childNames());{const t=yield this.size();return null==t||0===t}})}isNonEmpty(t=1){return w.thenMapOr(this.stat(),e=>e.size>t,()=>!1)}modifiedGTE(t){return i(this,void 0,void 0,function*(){return w.thenMap(this.mtime(),e=>x.unixtime(e)>=x.unixtime(t))})}modifiedCloseTo(t,e){return i(this,void 0,void 0,function*(){return w.thenMap(this.mtimeMs(),n=>Math.abs(n-t)<=e)})}modifiedGT(t){return i(this,void 0,void 0,function*(){if(null!=t)return w.thenMap(this.mtime(),e=>x.unixtime(e)>x.unixtime(t))})}isDirectory(){return i(this,void 0,void 0,function*(){return null!=this.dirent?this.dirent.isDirectory():w.thenMapOr(this.stat(),t=>t.isDirectory(),()=>!1)})}isNotDirectory(){return i(this,void 0,void 0,function*(){return w.thenNot(this.isDirectory())})}isDirectorySync(){return null!=this.dirent?this.dirent.isDirectory():f.mapOr(this.statSync(),t=>t.isDirectory(),()=>!1)}isSymbolicLink(){return i(this,void 0,void 0,function*(){return null!=this.dirent?this.dirent.isSymbolicLink():w.thenMapOr(this.stat(),t=>t.isSymbolicLink(),()=>!1)})}nearestDir(){return i(this,void 0,void 0,function*(){return(yield this.isDirectory())?this:this.parent()})}isFile(){return i(this,void 0,void 0,function*(){return null!=this.dirent?this.dirent.isFile():this.stat().then(t=>p.Opt(t).map(t=>t.isFile()).getOrElse(()=>!1))})}isFileSync(){return null!=this.dirent?this.dirent.isFile():p.Opt(this.statSync()).filter(t=>t.isFile()).isDefined}rmdir(t="warn"){return this.clear(),this.trapOr("rmdir",()=>o.rmdir(this.nativePath),t)}mkdirp(){return i(this,void 0,void 0,function*(){return(yield this.clear().isDirectory())?this:this.trap("mkdirp",()=>i(this,void 0,void 0,function*(){try{return yield o.mkdirp(this.nativePath),this.clearThisAndParent()}catch(t){if("EEXIST"!==t.code)throw t}if(null==(yield this.parent().mkdirp()))throw new Error("Failed to mkdirp parent of "+this);if(yield o.mkdir(this.nativePath),!1===(yield w.until(()=>this.clear().isDirectory(),2*x.secondMs)))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}))})}mkdirpSync(){return this.trapSync("mkdirpSync",()=>(o.mkdirpSync(this.nativePath),this.clearThisAndParent()))}sha(){return w.thenMap(this.shaResult(),t=>t.result)}shaMs(){return w.thenMap(this.shaResult(),t=>t.elapsedMs)}writeStream(t,e){return i(this,void 0,void 0,function*(){return yield G.pipelinePromise([t,o.createWriteStream(this.nativePath,e)]),this.clearThisAndParent()})}writeJSON(t,e={}){return i(this,void 0,void 0,function*(){return this.trap("writeJSON",()=>i(this,void 0,void 0,function*(){return yield this.parent().mkdirp(),yield o.writeFile(this.nativePath,JSON.stringify(t,e.replacer,e.spaces),Object.assign({flag:"w"},e)),this.clearThisAndParent()}))})}readJSON(){return this.trap("readJSON",()=>h.retryOnReject(()=>o.readJSON(this.nativePath),{maxRetries:2,onRetryWaitUntil:()=>v.delay(25),errorIsRetriable:t=>-2!==t.errno}))}readJSONSync(){return this.trapSync("readJSONSync",()=>o.readJSONSync(this.nativePath))}readFile(){return this.trap("readFile",()=>o.readFile(this.nativePath),void 0)}readLines(){return w.thenMap(this.readFile(),t=>R.splitLines(t.toString()))}readFileSync(){return F.Try(()=>F.map(o.readFileSync(this.nativePath),L.toS))}writeTxt(t){return this.writeFile(R.crlf(t))}writeFile(t){return this.trapOr("writeFile",()=>i(this,void 0,void 0,function*(){yield this.parent().mkdirp(),yield o.outputFile(this.nativePath,t),this.clearThisAndParent()}))}appendFile(t){return this.trapOr("appendFile",()=>i(this,void 0,void 0,function*(){yield o.mkdirp(this.dir),yield o.appendFile(this.nativePath,t),this.clearThisAndParent()}))}wip(t="."){return this.sibling(t+this.base)}unwip(t="."){return i(this,void 0,void 0,function*(){const e=this.sibling(D.stripPrefix(this.base,t));return this.mv(e,{overwrite:!0})})}dest(t){return i(this,void 0,void 0,function*(){const e=t.clear();return b.notBlank(this.ext)&&b.blank(e.ext)||(yield e.isDirectory())?e.join(this.base):e})}copyFile(t,e={maxRetries:1}){return i(this,void 0,void 0,function*(){return h.retryOnReject(()=>this._copyFile(t),{maxRetries:e.maxRetries,onRetryWaitUntil:()=>v.delay(250)})})}_copyFile(t){return i(this,void 0,void 0,function*(){let e;const n=(yield this.dest(t)).clear();if(this.nativePath===n.nativePath)return this;{const t=yield this.stat(),s=F.map(t,t=>t.size);if(null==t||null==s)throw new Error("Can't copy missing files");const a=yield this.sha();if(null==a)throw new Error("Can't copy file without SHA");const u=n.wip();try{if(null==(yield n.parent().mkdirp()))throw new Error("Cannot mkdirp "+n.dir);const l=new Promise((t,e)=>r.copyFile(this.nativePath,u.nativePath,r.constants.COPYFILE_FICLONE,n=>null==n?t():e(n)));s>5*k.MiB&&(e=new z.PullProgressObserver({op:"file copy",path:this.nativePath,dest:n.nativePath},s,()=>u.clear().size())),yield l;const c=yield w.until(()=>i(this,void 0,void 0,function*(){return s===(yield u.clear().size())}),15*x.secondMs),d=yield u.clear().sha();if(!c||d!==a)throw this.bflog().warn("copyFile() failed",{sizeMatches:c,destSha:d,thisSha:a}),new Error("wipDest mismatch");const h=yield u.unwip();if(null==h)throw new Error(".unwip() failed");return yield o.chmod(h.nativePath,t.mode),yield o.utimes(h.nativePath,t.atime,t.mtime),this.bflog().debug(`copyFile(${n.nativePath}): success`),n.clearThisAndParent()}catch(t){throw this.bflog().warn(`copyFile(${u.nativePath}) failed: ${t}`),yield u.unlink(),yield n.unlink(),t}finally{F.map(e,t=>t.end())}}})}touch(t=Date.now(),e){return i(this,void 0,void 0,function*(){return this.trap("touch",()=>w.thenMap(this.ensureFile(),()=>this.utimes(t,e)))})}utimes(t,e){return i(this,void 0,void 0,function*(){const n=F.orElse(t,Date.now()),i=F.orElse(e,n);return this.trap("utimes",()=>o.utimes(this.nativePath,x.unixtime(i),x.unixtime(n)).then(()=>this.clearThisAndParent()))})}unlink(t="warn"){return i(this,void 0,void 0,function*(){return this.trap("unlink",()=>i(this,void 0,void 0,function*(){return yield o.unlink(this.nativePath),this.clearThisAndParent()}),t)})}remove(){return i(this,void 0,void 0,function*(){return this.trap("remove",()=>i(this,void 0,void 0,function*(){return this.bflog().info("remove()"),yield o.remove(this.nativePath),this.clearThisAndParent()}))})}unlock(){return i(this,void 0,void 0,function*(){return I.isMac&&(yield this.clear().exists())&&(yield P.stdout("chflags",["nouchg",this.nativePath],{timeout:A.cmdTimeoutMs})),this})}renameWithNameSuffix(t){return i(this,void 0,void 0,function*(){return w.thenMap(this.withNameSuffix(t).ensureNew({emptyIsNew:!0}),t=>t.unlink("debug").then(()=>this.mv(t)))})}mv(t,e={overwrite:!1}){return i(this,void 0,void 0,function*(){const n=yield this.dest(t);return this.nativePath===n.nativePath?(this.bflog().warn("mv(): no-op",new Error("internal error")),this):(yield n.parent().mkdirp(),yield Promise.all([this.unlock(),n.unlock()]),this.bflog().debug("mv",n),yield o.move(this.nativePath,n.nativePath,e),yield n.unlock(),this.clearThisAndParent(),n.clearThisAndParent())})}gzip(){return i(this,void 0,void 0,function*(){return this.trap("gzip",()=>i(this,void 0,void 0,function*(){const t=yield this.for(this.nativePath+".gz").ensureNew();return yield new Promise((e,n)=>u.pipeline(o.createReadStream(this.nativePath),c.createGzip(),o.createWriteStream(t.nativePath),t=>null==t?e():n(t))),yield this.unlink(),t}))})}ensureFile(){return this.trap("ensureFile",()=>o.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync(){return this.trapSync("ensureFileSync",()=>(o.ensureFileSync(this.nativePath),this.clearThisAndParent()))}get nameWithoutCount(){return B.nameWithoutCount(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}ensureNewNativePath(t){return i(this,void 0,void 0,function*(){const n=Object.assign({},e.DefaultEnsureNewOptions,t);if(this.clear(),!n.requireNumber&&((yield this.notExists())||n.emptyIsNew&&(yield this.isEmpty())))return this.nativePath;const i=this.parent();yield i.mkdirp();for(let t=n.startIndex;t<=n.maxVersions;t++){const e=i.join(`${this.name}-${D.leftPad(t,n.leftPad,"0")}${this.ext}`);if(e.clear(),(yield e.notExists())||n.emptyIsNew&&(yield e.isEmpty()))return e.nativePath}throw new Error("There are already more than "+n.maxVersions+" of "+this)})}ensureNew(t={}){return this.ensureNewNativePath(t).then(t=>this.for(t))}renameYMD(){return i(this,void 0,void 0,function*(){if(yield this.clear().isNonEmpty()){const t=_.datedToYMD(yield w.thenOrElse(this.mtime(),()=>new Date)),e=yield this.withNameSuffix("-"+t).ensureNew({emptyIsNew:!0});if(null!=e)return this.mv(e);this.bflog().warn("renameYMD(): failed (ensureNew returned null)")}})}saveIfNewOrDelete(t){return i(this,void 0,void 0,function*(){if(yield this.clear().isEmpty())return void(yield this.unlink());const e=yield this.siblingWithSameContents();if(null!=e)return yield this.unlink(),e;const n=yield this.sibling(t).ensureNew();return this.mv(n)})}chmod(t){return i(this,void 0,void 0,function*(){return yield o.chmod(this.nativePath,t),this.clear()})}zreadline(){return a.createInterface({input:o.createReadStream(this.nativePath).on("error",t=>{throw new Error("Failed to read from "+this+": "+t)}).pipe(c.createGunzip()).on("error",t=>{throw new Error("Failed to gunzip "+this+": "+t)})})}zcat(){return this.ext.endsWith(".gz")?this.trap("zcat",()=>i(this,void 0,void 0,function*(){const t=new U.WritableToBuffer;return yield new Promise((e,n)=>u.pipeline(o.createReadStream(this.nativePath),c.createGunzip(),t,t=>null==t?e():n(t))),w.thenMap(t.buffer,t=>t.toString())})):w.thenMap(this.readFile(),t=>t.toString())}siblingWithSameContents(){return i(this,void 0,void 0,function*(){return this.parent().childWithSameContents(this)})}childWithSameContents(t){return i(this,void 0,void 0,function*(){if((yield this.notExists())||!(yield this.isDirectory()))return;const e=yield t.size(),n=yield this.children(),i=[];for(const r of d.toA(n))(yield r.size())!==e||t.eql(r)||i.push(r);if(m.isEmpty(i))return;const r=yield t.sha();for(const t of i.sort((t,e)=>C.diceCoeff(t.base,e.base)).reverse())if((yield t.sha())===r)return t})}applyIfEmpty(t){return i(this,void 0,void 0,function*(){if(yield this.clear().isNonEmpty())return this;const e=this.wip();try{return yield e.parent().mkdirp(),yield e.unlink("debug"),yield t(e),(yield e.clear().isEmpty())?(this.bflog().warn("applyIfEmpty(): builder didn't write to dest"),void(yield e.unlink("debug"))):e.unwip()}catch(t){throw yield w.tryAll([()=>e.unlink(),()=>this.unlink()]),t}})}firstMatchingLine(t){const e=new g.Deferred("firstMatchingLine("+this+")"),n=r.createReadStream(this.nativePath,{flags:"r"});return n.on("error",t=>{-2===t.errno||"ENOENT"===t.code?(e.maybeResolve(void 0),n.close()):e.maybeReject(t)}),n.on("close",()=>e.maybeResolve(void 0)),W.onDataChunked(n,R.newlineRe,i=>{const r=t.exec(i);null!=r&&(e.maybeResolve(r),n.close())}),e.promise}}K.attrTTL=1*x.minuteMs,K.projectRoot=y.lazy(()=>{const t=V.ProjectPath.Root();if(null==t)throw new Error("Cannot find project path");return K.for(t)}),e.BaseFile=K},function(t,e){t.exports=require("timers")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(35),r=n(42),o=n(6),s=n(25),a=n(1),u=n(12),l=n(13),c=n(2),d=n(50);e.Deferred=class{constructor(t){this.name=t,this.start=Date.now(),this.state=c.PromiseStates.pending,this.promise=new Promise((t,e)=>{this._resolve=t,this._reject=e}),this.logger=a.mkLogger("Deferred("+this.toString()+")")}toString(){return l.isString(this.name)?this.name:JSON.stringify(this.name)}[r.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(t){return t.then(t=>{this.resolve(t)}).catch(t=>{this.logger.log(u.isTest?"warn":"error","observeQuietly.reject()",t),this.resolve(void 0)}),this}observe(t){return t.then(t=>{this.resolve(t)}).catch(t=>{this.reject(t)}),this}setTimeout(t){return o.map(this.priorTimeout,i.clearTimeout),this.priorTimeout=d.setUnrefTimeout(()=>{if(this.pending){const t="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(t)}},t),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===c.PromiseStates.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==c.PromiseStates.pending}get resolved(){return this.state===c.PromiseStates.resolved}get rejected(){return this.state===c.PromiseStates.rejected}get settledMs(){return null==this.end?void 0:this.end-this.start}resolve(t){return this.settle(()=>{this.state=c.PromiseStates.resolved,this._value=t,this._resolve(t)})}maybeResolve(t){return this.pending?this.resolve(t):this}reject(t){this.logger.log(u.isTest?"warn":"error",".reject()",t);const e=s.asError(t);return this.settle(()=>{this._error=e,this.state=c.PromiseStates.rejected,this._reject(e)})}maybeReject(t){return this.pending?this.reject(t):this}finally(t){return this.promise.finally(t),this}then(t){return this.promise.then(t)}settle(t){if(this.state===c.PromiseStates.pending){o.map(this.priorTimeout,i.clearTimeout),t(),this.end=Date.now();const e=this.settledMs;if(this.resolved&&e>5e3){const t=e>5e3?"info":"debug";this.logger.log(t,"Completed in "+e+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(147);e.delay=i.delay,e.delayUntil=i.delayUntil,e.later=i.later,e.unrefDelay=i.unrefDelay},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(4),s=n(0);var a=n(95);function u(t){const e=o.compact(t).filter(([t,e])=>null!=t&&null!=e);return new Map(e)}function l(t,e){return new Map([...t.entries()].filter(([t,n])=>e(t,n)))}e.getOrSet=a.getOrSet,e.hasAll=function(t,e){return e.every(e=>t.has(e))},e.getOrSetAsync=function(t,e,n){return i(this,void 0,void 0,function*(){const i=t.get(e);if(null!=i)return i;const r=Promise.resolve(n());return t.set(e,r),r.then(n=>{null==n?t.delete(e):t.set(e,n)}).catch(()=>t.delete(e)),r})},e.flatMap=function(t,e){return new Map(o.concat(...t.map(t=>e(t))))},e.compactMap=u,e.toMap=function(t,e){return u(o.compact(t).map(e))},e.toMapAsync=function(t,e){return i(this,void 0,void 0,function*(){if(null==t)return new Map;return u(yield Promise.all(o.compact(r.toA(t)).map(t=>e(t))))})},e.toObj=function(t){const e={};for(const[n,i]of t)e[n]=i;return e},e.filter=l,e.filterInPlace=function(t,e){[...t.entries()].forEach(([n,i])=>e(n,i)||t.delete(n))},e.pickKeys=function(t,e){return l(t,t=>e.indexOf(t)>=0)},e.getLike=function(t,e){return s.map([...t.entries()].find(([t])=>e(t)),([,t])=>t)},e.inverse=function(t){return new Map([...t.entries()].map(([t,e])=>[e,t]))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(43),r=n(45),o=n(22),s=n(9),a=n(33),u=n(128),l=n(129),c=n(4),d=n(3),h=n(10),f=n(28),p=n(0),m=n(12);var g;e.AppPaths=a.strEnum("exe","home","appData","userData","pictures","temp"),function(t){t.getName=function(){return l.AppName},t.exe=d.lazy(()=>o.execPath),t.home=d.lazy(()=>p.orElse(c.first(h.compactBlanks([r.homedir(),o.env.HOME,o.env.HOMEPATH,o.env.USERPROFILE]).map(t=>f.resolve(t)),t=>p.map(i.statSync(t),()=>t)),r.homedir())),t.appData=d.lazy(()=>u.appData()),t.appName=d.lazy(()=>l.AppName+(m.isProd?"":`-${m.Settings.nodeEnv.value}`)),t.userData=d.lazy(()=>f.resolve(t.appData(),t.appName())),t.pictures=d.lazy(()=>f.resolve(t.home(),"Pictures")),t.temp=d.lazy(()=>f.resolve(r.tmpdir(),l.AppName+"-"+r.userInfo().username)),t.getPath=function(e){return s.maybeCall(t,e)},t.setPath=function(e,n){t[e].set(f.resolve(n))}}(g=e.App||(e.App={})),m.Settings.nodeEnv.addListener(()=>void s.values(g).forEach(t=>s.maybeCall(t,"clear"))),g.appName.onChange(()=>g.userData.clear())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(80),o=n(16),s=n(4),a=n(37),u=n(21),l=n(3),c=n(2),d=n(20),h=n(167),f=n(14),p=n(1),m=n(23),g=n(111),v=n(211),y=n(212),S=n(24);let w;function b(){return i(this,void 0,void 0,function*(){return null==w&&null==e.localMountpointSetup.prior()&&(yield e.localMountpointSetup()),r.retryOnReject(()=>(w||e.nonRpcMountpoints)(),{maxRetries:3,onRetryWaitUntil:t=>a.delay(1500*t)}).catch(t=>{f.emitNonFatal("mountpoints() failed",t)})})}e.nonRpcMountpoints=l.lazy(m.isWin?y.mountpointsWin:v.mountpointsPosix,S.mountpointsTtlMs),f.onClearCache(()=>e.nonRpcMountpoints.clear()),e.setRpcMountpointsImpl=function(t){w=t,e.localMountpointSetup.clear()},e.localMountpointSetup=l.lazy(()=>i(this,void 0,void 0,function*(){null==w?a.later(()=>i(this,void 0,void 0,function*(){const t=p.mkLogger("Mountpoints.localMountpointSetup()");m.isMac?(t.info("Setting up Mac diskutil activity watcher"),e.nonRpcMountpoints.setTTL(S.dfTtlMs),e.diskUtilActivity()):m.isLinux&&((yield g.isGioSupported())?(t.info("Setting up Linux gio mount monitor"),e.nonRpcMountpoints.setTTL(S.dfTtlMs),e.gioMountMonitor()):(yield M())&&(t.info("Setting up Linux findmnt mount monitor"),e.nonRpcMountpoints.setTTL(S.dfTtlMs),e.findmntPoll()))}),30*o.secondMs).unref():yield c.awaitAll([u.end(e.diskUtilActivity.clear()),u.end(e.gioMountMonitor.clear()),u.end(e.findmntPoll.clear())])})),e.mountpoints=b,e.mountsCacheKey=()=>c.thenMap(b(),t=>s.sort(t).join(":")),e.diskUtilActivity=l.lazy(()=>h.mkBasicWatchedChild("diskutil",["activity"],()=>e.nonRpcMountpoints.clear())),e.gioMountMonitor=l.lazy(()=>h.mkBasicWatchedChild(g.GioCommand,g.GioMountMonitorArgs,()=>{g.gioVolumes.clear(),g.mtabEntries.clear(),e.nonRpcMountpoints.clear()}));const M=l.lazy(()=>i(this,void 0,void 0,function*(){if(!m.isLinux)return!1;try{return 0===(yield d.stdoutResult("findmnt",["--version"],{timeout:S.cmdTimeoutMs,ignoreStderr:!0})).code}catch(t){return!1}}));e.findmntPoll=l.lazy(()=>h.mkBasicWatchedChild("findmnt",["--poll"],()=>e.nonRpcMountpoints.clear()))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(179),r=n(61);var o;function s(t){return"symbol"==typeof t}function a(t){return"function"==typeof t}function u(t){return null==t?o.Empty:s(t)?o.Symbol:r.isPrimitive(t)?o.Primitive:Array.isArray(t)?o.Array:i.isIterable(t)?o.Iterable:a(t)?o.Function:"object"==typeof t?t.constructor&&"Object"===t.constructor.name?o.Object:o.Instance:o.Unknown}!function(t){t[t.Empty=0]="Empty",t[t.Primitive=1]="Primitive",t[t.Symbol=2]="Symbol",t[t.Object=3]="Object",t[t.Array=4]="Array",t[t.Iterable=5]="Iterable",t[t.Instance=6]="Instance",t[t.Function=7]="Function",t[t.Unknown=8]="Unknown"}(o=e.ObjectType||(e.ObjectType={})),e.isSymbol=s,e.isFunction=a,e.isObject=function(t){return u(t)===o.Object},e.objectType=u},function(t,e){t.exports=require("util")},function(t,e){t.exports=require("fs")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6);class r{constructor(t){this.value=t,this.ctime=Date.now()}touch(){this.ctime=Date.now()}}e.Entry=r;e.TTLMap=class{constructor(t,e=new Map){this.ttlMs=t,this.store=e,this.expireListeners=[]}get size(){return this.vacuum(),this.store.size}clear(){return this.store.clear(),this}delete(t){return this.store.delete(t)}deleteIf(t){this.store.forEach((e,n)=>{t(n,e.value)&&this.store.delete(n)})}entries(){const t=this;return function*(){for(const[e,n]of t.store.entries())t.expired(e,n)||(yield[e,n.value])}()}forEach(t){this.store.forEach((e,n)=>{this.expired(n,e)||t(e.value,n,this)})}get(t){return i.map(this.store.get(t),e=>this.expired(t,e)?void 0:e.value)}touch(t){i.map(this.store.get(t),t=>t.touch())}pop(t){const e=this.store.get(t);return this.store.delete(t),i.map(e,e=>this.expired(t,e)?void 0:e.value)}has(t){return!this.expired(t,this.store.get(t))}keys(){const t=this;return function*(){for(const[e,n]of t.store.entries())t.expired(e,n)||(yield e)}()}set(t,e){return i.map(this.store.get(t),e=>this.expireListeners.forEach(n=>n(t,e.value))),this.store.set(t,new r(e)),this}values(){const t=this;return function*(){for(const[e,n]of t.store.entries())t.expired(e,n)||(yield n.value)}()}[Symbol.iterator](){return this.entries()}getOrSet(t,e){const n=this.store.get(t);if(this.valid(t,n))return n.touch(),n.value;{const n=e();return this.set(t,n),n}}on(t,e){this.expireListeners.push(e)}valid(t,e){return!this.expired(t,e)}expired(t,e){return null!=e&&e.ctime+this.ttlMs<=Date.now()?(this.store.delete(t),this.expireListeners.forEach(n=>n(t,e.value)),!0):null==e}vacuum(){this.store.forEach((t,e)=>{this.expired(e,t)})}}},function(t,e){t.exports=require("os")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(9),s=n(41);function a(t,e){return i(this,void 0,void 0,function*(){const n=yield t,i=yield e;return null!=n&&null!=i&&u(n,i)})}function u(t,e){return null==l(t,e)}function l(t,e){switch(s.objectType(t)){case s.ObjectType.Empty:case s.ObjectType.Symbol:case s.ObjectType.Primitive:return t===e?void 0:`${t} !== ${e}`;case s.ObjectType.Array:return c(t,e);case s.ObjectType.Iterable:return c([...t],[...e]);default:return t instanceof Set?d(t,e):t instanceof Map?h(t,e):f(t,e)}}function c(t,e){if(!Array.isArray(t))return"a is not an Array";if(!Array.isArray(e))return"b is not an Array";if(t.length!==e.length)return`length mismatch (${t.length} != ${e.length})`;const n=r.compact(t.map((t,n)=>{const i=l(t,e[n]);return null==i?void 0:"["+n+"] not eql: "+i}));return 0===n.length?void 0:n.join(", ")}function d(t,e){if(!(t instanceof Set))return"a is not a Set";if(!(e instanceof Set))return"b is not a Set";if(t.size!==e.size)return`size mismatch (${t.size} != ${e.size})`;const n=[...t.keys()].filter(t=>!e.has(t));return 0===n.length?void 0:"Missing keys in b: "+n}function h(t,e){if(!(t instanceof Map))return"a is not a Map";if(!(e instanceof Map))return"b is not a Map";if(t.size!==e.size)return`size mismatch (${t.size} != ${e.size})`;const n=[...t.keys()].filter(t=>!e.has(t));if(n.length>0)return"Missing keys in b: "+n;const i=r.compact([...t.entries()].map(([t,n])=>l(n,e.get(t))));return 0===i.length?void 0:"Mismatched entries: "+i.join(", ")}function f(t,e){const n=o.keys(t),i=o.keys(e),s=c(n.sort(),i.sort());if(null!=s)return s;const a=r.compact(n.map(n=>{const i=l(t[n],e[n]);return null==i?void 0:"Mismatch at ["+n+"]: "+i}));return 0===a.length?void 0:a.join(", ")}e.eqlAsync=a,e.notEqlAsync=function(t,e){return i(this,void 0,void 0,function*(){return!(yield a(t,e))})},e.eql=u,e.notEql=function(t,e){return!u(t,e)},e.whyNotEql=l,e.arrayEql=function(t,e){return null==c(t,e)},e.whyNotArrayEql=c,e.setEql=function(t,e){return null==d(t,e)},e.whyNotSetEql=d,e.mapEql=function(t,e){return null==h(t,e)},e.whyNotMapEql=h,e.whyNotObjEql=f},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(87),o=n(8),s=n(16),a=n(6),u=n(21),l=n(3),c=n(2),d=n(132),h=n(20),f=n(11),p=n(14),m=n(1),g=n(12),v=n(13),y=n(24),S=10*s.minuteMs,w="{ready}",b=" | ConvertTo-Json -Compress";p.onClearCache(()=>a.map(M.instance.prior(),t=>t.clearMockResults()));class M{constructor(){this.logger=m.mkLogger("PowerShell"),this.mockResults=new Map,this.pwsh=d.observeBatchCluster(new r.BatchCluster({processFactory:()=>h.execFile("powershell",[],S),versionCommand:`function prompt {"${w}"}`,pass:w,fail:"Error",exitCommand:"exit",maxProcs:2,maxTasksPerProcess:150,taskTimeoutMillis:y.cmdTimeoutMs,cleanupChildProcs:!1}),"PowerShell",u.EndableRanks.db)}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockResult(t,e){this.mockResults.set(v.ensureSuffix(t,b),e)}clearMockResults(){this.mockResults.clear()}execute(t,e){return i(this,void 0,void 0,function*(){if(this.pwsh.ended||u.ending())this.logger.warn("execute() failed (ended)",{cmd:t});else{if(g.isTest&&this.mockResults.has(t)){const n=this.mockResults.get(t);return e(n.stdout,n.stderr,n.passed)}try{this.logger.debug("execute()",{cmd:t});const n=yield f.elapsedAsync(()=>this.pwsh.enqueueTask(new r.Task(t,(n,i,r)=>e(a.map(n,e=>v.stripPrefix(e,t)),i,r)))),i=n.elapsedMs<500?"trace":n.elapsedMs<1500?"debug":n.elapsedMs<3e3?"info":"warn";return this.logger.log(i,"execute()",{cmd:t,elapsedMs:n.elapsedMs}),n.result}catch(e){return void this.logger.warn("execute() failed: "+e,{cmd:t})}}})}executeJson(t){return i(this,void 0,void 0,function*(){const e=yield this.execute(v.ensureSuffix(t,b),(t,e,n)=>({stdout:t,stderr:e,passed:n}));if(null!=e)if(o.blank(e.stdout)||o.notBlank(e.stderr)||!e.passed)this.logger.warn("executeJson(): failed result",Object.assign({cmd:t},e));else try{return JSON.parse(e.stdout)}catch(t){const n=e.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:v.ellipsize(e.stdout),after:v.ellipsize(n)}),JSON.parse(n)}else this.logger.warn("executeJson(): null result",{cmd:t})})}executeJsonToA(t){return i(this,void 0,void 0,function*(){return c.thenMap(this.executeJson(t),t=>Array.isArray(t)?t:[t])})}}M.instance=l.lazy(()=>new M),e.PowerShell=M},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(133),r=n(10),o=n(0),s=n(13);class a{constructor(t,e,n=o.identity){this.name=t,this.numerals=e,this.decodePreparser=n,this.base=e.length}digitsToNumerals(t){return t.map(t=>this.numerals[t]).join("")}encode(t,e=0){const n=[],i=t<0;if(i&&e--,0===(t=Math.abs(t)))n.push(0);else for(;t>0;)n.push(t%this.base),t=Math.floor(t/this.base);for(;n.length<e;)n.push(0);return(i?"-":"")+this.digitsToNumerals(n.reverse())}encodeBuffer(t){if(null==t||0===t.length)return"";const e=[0];for(let n of t)for(e.forEach((t,i)=>{n+=t<<8,e[i]=n%this.base,n=Math.floor(n/this.base)});n>0;)e.push(n%this.base),n=Math.floor(n/this.base);return this.digitsToNumerals(e.reverse())}decode(t){if(null==t||r.blank(t))return;const e="-"===(t=this.decodePreparser(t))[0];e&&(t=t.slice(1));let n=0;for(const e of t){const t=this.numerals.indexOf(e);if(t<0)return;n=n*this.base+t}return e?-1*n:n}randomChars(t){return this.encodeBuffer(i.randomBytes(t+3)).slice(1,t+1)}randomUid(t=25,e=5){return s.splitEvery(this.randomChars(t),e).join("-")}}e.Radix=a,e.Hex=new a("hex","0123456789abcdef",t=>t.toLowerCase()),e.Radix58=new a("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),e.RadixAlphaNum=new a("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",t=>t.toLowerCase()),e.GeoRadix=new a("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",t=>t.toLowerCase())},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(8),o=n(6),s=n(33),a=n(18),u=n(4),l=n(0),c=n(13);e.fileExtsToDesc=[[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["DNG"],"Digital Negative (TIFF-based)"],[["ERF"],"Epson RAW Format (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PNG"],"Portable Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["THM"],"Thumbnail image (JPEG)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["XMP"],"Extensible Metadata Platform sidecar file"]];const d=e.fileExtsToDesc.map(([t])=>t);function h(t){return u.flatten(i.compact(t.map(t=>t.toUpperCase()).map(t=>d.find(e=>e.includes(t))))).map(m)}function f(t){return r.blank(t)?void 0:c.ensurePrefix(a.toS(t),".").toLowerCase()}function p(t){const e=new Set(i.compactBlanks(t.map(f)));return t=>l.orElse(o.map(f(t),t=>e.has(t)),!1)}function m(t){return c.ensurePrefix(t,".").toUpperCase()}e.BaseSharpImageExts=["GIF","JPEG","PNG","PPM","TIFF","THM","WEBP"],e.SharpImageExts=h(e.BaseSharpImageExts),e.isSharpExt=p(e.SharpImageExts),e.sharpSupportedMimeTypes=new Set(["image/gif","image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"]),e.isSharpMimetype=function(t){return e.sharpSupportedMimeTypes.has(a.toS(t).toLowerCase())},e.BaseRawImageExts=["ARQ","ARW","CR2","CR3","CRW","DNG","ERF","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"],e.RawImageExts=h(e.BaseRawImageExts),e.isRawImageExt=p(e.RawImageExts),e.BaseVideoExts=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"],e.VideoExts=h(e.BaseVideoExts),e.isVideoExt=p(e.VideoExts),e.SidecarExtsEnum=s.strEnum("EXIF","EXV","MIE","XMP"),e.SidecarExts=h(s.strEnumValues(e.SidecarExtsEnum)),e.isSidecarExt=p(e.SidecarExts),e.AssetFileExts=[...e.SharpImageExts,...e.RawImageExts,...e.VideoExts].sort(),e.AllExifExts=[...e.AssetFileExts,...e.SidecarExts].sort(),e.browserImgExts=h(["JPEG","PNG"]),e.browserExts=h(["JPEG","PNG","GIF","MP4","WEBM","WEBP"]),e.asExt=m,e.ExtTypes=s.strEnum("image","raw","video"),e.extType=function(t){return e.isSharpExt(t)?e.ExtTypes.image:e.isRawImageExt(t)?e.ExtTypes.raw:e.isVideoExt(t)?e.ExtTypes.video:void 0}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(35),r=n(9),o=n(27);e.setUnrefTimeout=function(t,e,...n){return o.tap(i.setTimeout(t,Math.round(e),n),t=>t.unref())},e.setUnrefInterval=function(t,e,...n){return o.tap(i.setInterval(t,Math.round(e),n),t=>t.unref())},e.unref=function(t){return r.maybeCall(t,"unref"),t}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(41),s=n(4),a=n(67),u=n(36),l=n(58);class c{constructor(){this._pushCount=0,this._arr=[],this.nextSettledLatches=[],this.serialLatencyAvg=new a.Average}get arr(){return s.filterInPlace(this._arr,t=>t.pending),this._arr}get pushCount(){return this._pushCount}push(t,e){this._pushCount++;const n=o.isFunction(e)?e():e;return this.arr.push(new u.Deferred(t).observeQuietly(n).finally(()=>this.emitSettled())),n}emitSettled(){this.nextSettledLatches.forEach(t=>t.resolve()),this.nextSettledLatches.length=0}awaitNextSettled(){const t=new l.Latch;return this.nextSettledLatches.push(t),t}serial(t,e){const n=Date.now();return this.push(t,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-n),e())))}oneRunAtATime(t,e){return this.pending?this.awaitAll():this.serial(t,e)}maybeRun(t,e){return this.pending?void 0:this.serial(t,e)}get pendingCount(){return r.count(this._arr,t=>t.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(t=>t.name)}get settled(){return 0===this.arr.length}awaitAll(){return 0===this.arr.length?Promise.resolve(void 0):Promise.all(this.arr.map(t=>t.promise)).then(()=>void 0)}}e.Promises=c,e.oneRunAtATime=function(t,e){const n=new c;return()=>n.oneRunAtATime(t,e)},e.maybeRun=function(t,e){const n=new c;return()=>n.maybeRun(t,e)},e.serially=function(t,e){const n=new c;return()=>n.serial(t,e)},e.withBoundedConcurrency=function({name:t,laters:e,maxConcurrent:n=4}){return i(this,void 0,void 0,function*(){const i=[],r=new c;for(const o of e){for(;r.pendingCount>=n;)yield r.awaitNextSettled();i.push(r.push(t,o))}return Promise.all(i)})}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(133),r=n(43),o=n(9),s=n(15),a=n(48);function u(t,n=e.HashBits){return i.createHash("sha512").update(t).digest().slice(0,n/8)}e.HashBits=192,e.fileSha=function(t,n){const a=r.createReadStream(t,{autoClose:!0}),u=i.createHash("sha512");let l=0;const c=s.Opt(n).flatMap(t=>t.msbits).getOrElse(()=>e.HashBits)/8,d=o.map(n,t=>t.observer);return new Promise((t,e)=>{a.on("error",t=>e(t)),a.on("data",t=>{l+=t.length,o.map(d,t=>t.onProgress(l)),u.update(t)}),a.on("end",()=>t(u.digest().slice(0,c)))})},e.stringSha=u,e.shortStringSha=function(t,e=9,n=a.Radix58,i=224){return n.encodeBuffer(u(t,i)).substring(0,e)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(4),o=n(14),s=n(1),a=n(0),u=n(80),l=n(36),c=n(3),d=n(2);e.keyedLazy=function(t,e,n,h){const f=c.lazy(()=>s.mkLogger("KeyedLazy("+t+")")),p=[],m=()=>i(this,void 0,void 0,function*(){try{return yield e()}catch(t){return void f().warn("key() failed: "+t)}}),g=()=>i(this,void 0,void 0,function*(){const e=yield m();if(r.filterInPlace(p,t=>(null==e||t.name===e)&&t.start+h.priorResultTtlMs>Date.now()&&!t.rejected),r.sortByInPlace(p,t=>[t.resolved,t.start]),null==e||p.length>0)return a.map(p[p.length-1],t=>t.promise);const i=new l.Deferred(e).setTimeout(h.timeoutMs).observe((()=>h.maxRetries<=0?n():u.retryOnReject(n,{maxRetries:h.maxRetries}))());return i.promise.catch(n=>{f().warn("Caught error",{newKey:e,startAgoMs:Date.now()-i.start,error:n}),o.emitNonFatal(t+" failed",n)}),p.push(i),i.promise});return g.clear=()=>p.length=0,g.prior=()=>{r.greatestBy(p,t=>t.start)},g.refresh=()=>(g.clear(),g()),g.set=t=>d.thenMap(m(),e=>{p.length=0,p.push(new l.Deferred(e).resolve(t))}),g}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(96),o=n(5),s=n(37),a=n(25),u=n(0),l=n(21);e.ReadableBuffer=class extends r.Readable{constructor(t){super(),this.push(t),this.push(null)}},e.end=function(t){return i(this,void 0,void 0,function*(){null!=t&&(u.Try(()=>u.maybeCall(t,"unref")),l.ending()?t.end(null):yield new Promise(e=>t.end(null,e)),yield s.delay(50),u.Try(()=>u.maybeCall(t,"destroy")))})},e.close=function(t){return i(this,void 0,void 0,function*(){null!=t&&(u.Try(()=>u.maybeCall(t,"unref")),l.ending()?t.close(()=>{}):yield new Promise(e=>t.close(e)),yield s.delay(50),u.Try(()=>u.maybeCall(t,"destroy")))})},e.onError=function(t,e){[{name:"cp",ea:t},{name:"stdin",ea:t.stdin},{name:"stdout",ea:t.stdout},{name:"stderr",ea:t.stderr}].forEach(({name:t,ea:n})=>u.map(n,n=>n.on("error",n=>{a.isIgnorableError(n)||e(t,n)})))},e.closeStreams=function(t){null!=t&&[t.stdin,t.stdout,t.stderr].forEach(t=>u.Try(()=>u.map(t,t=>t.destroy())))},e.pipelinePromise=function(t){return new Promise((e,n)=>{const i=[];t.forEach(t=>t.on("error",t=>{i.push(t)})),r.pipeline(t,t=>s.later(()=>{null!=t?n(t):o.isNotEmpty(i)?n(a.asError(i)):e()},10))})},e.remoteDesc=function(t){return t.destroyed?"destroyed":`${t.remoteFamily}:${t.remoteAddress}:${t.remotePort}`}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.lazy=function(t){let e,n=!1;return()=>{if(!n){n=!0;try{e=t()}catch(t){}}return e}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(17),r=n(123),o=n(162),s=n(7);function a(t){return{width:t.height,height:t.width}}e.dimToS=function(t){return`${t.width}×${t.height}`},e.maybeFlip=function(t,e){return r.flippable(e)?a(t):t},e.maybeFlipInPlace=function(t,e){r.flippable(e)&&([t.width,t.height]=[t.height,t.width])},e.flip=a,e.isPortrait=function(t){return t.height/t.width>=4/3},e.dmegapixels=function(t){return s.megapixels(t.width*t.height)},e.ltBoth=function(t,e){return s.lt(t.width,e.width)&&s.lt(t.height,e.height)};const u={x:76800,y:500},l={x:2073600,y:3e3};e.roughVideoBitrateKbps=function(t){return i.clamp(300,5e3,Math.floor(o.lerp2d(u,l,t.width*t.height)))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(131),o=n(7);function s(t,e){const n=new r.CountingSet;return t.forEach(t=>o.mapFinite(t,t=>n.incr(t))),n.top(e).map(t=>t[0])}function a(t){return t.reduce((t,e)=>t+e,0)}function u(t){return i.isEmpty(t)?NaN:a(t)/t.length}function l(t){const e=u(t);return u(t.map(t=>Math.pow(t-e,2)))}function c(t){return Math.sqrt(t.reduce((t,e)=>t+e*e,0))}function d(t,e){return t.reduce((t,n,i)=>t+n*e[i],0)}e.min=function(t){return t.reduce((t,e)=>null==t?e:null==e||t<=e?t:e,void 0)},e.max=function(t){return t.reduce((t,e)=>null==t?e:null==e||t>=e?t:e,void 0)},e.deltas=function(t){return null==t||t.length<=1?[]:t.slice(1).map((e,n)=>e-t[n])},e.modes=s,e.mode=function(t){return s(t,1)[0]},e.sum=a,e.avg=u,e.variance=l,e.stdDev=function(t){return Math.sqrt(l(t))},e.weightedAvg=function(t){let e;for(const n of t)e=null==e?n:(e+n)/2;return null==e?NaN:e},e.l2norm=c,e.dot=d,e.cosineSimilarity=function(t,e){return d(t,e)/(c(t)*c(e))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.Latch=class{constructor(t){this.id=t,this._state="pending",this.promise=new Promise((t,e)=>{this._resolve=t,this._reject=e})}resolve(){return this.pending&&this._resolve(),this._state="resolved",this}reject(t){return this.pending&&this._reject(t),this._state="rejected",this}observe(t){return t.then(()=>this.resolve()).catch(t=>this.reject(t)),this}observeQuietly(t){return t.then(()=>this.resolve()).catch(()=>this.resolve()),this}get pending(){return"pending"===this._state}get settled(){return!this.pending}get resolved(){return"resolved"===this._state}get rejected(){return"rejected"===this._state}get state(){return this._state}then(t){return this.promise.then(t)}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(17),r=new Intl.NumberFormat;e.fmt=function(t){return r.format(t)},e.KB=1e3,e.MB=1e3*e.KB,e.GB=1e3*e.MB,e.TB=1e3*e.GB,e.KiB=1024,e.MiB=1024*e.KiB,e.GiB=1024*e.MiB,e.TiB=1024*e.GiB;const o=["B","KB","MB","GB","TB","PB"],s=["B","KiB","MiB","GiB","TiB","PiB"];e.fmtBytes=function(t,e=3){const n=Math.floor(Math.log10(t)),r=Math.floor(n/3),s=Math.pow(10,3*r),a=o[r];return i.sigFigs(t/s,e)+" "+a},e.fmtMebi=function(t,e=3){const n=Math.floor(Math.log2(t)),r=Math.floor(n/10),o=Math.pow(2,10*r),a=s[r];return i.sigFigs(t/o,e)+" "+a},e.MP=1e6,e.megapixels=function(t){return i.sigFigs(t/e.MP,3)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.wmic=()=>"wmic",e.fsutil=()=>"fsutil",e.nslookupWin=()=>"nslookup",e.pingWin=()=>"ping",e.arpWin=()=>"arp"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=["number","string","boolean"];function o(t){return-1!==r.indexOf(typeof t)}function s(t,e){return null==t&&null==e?0:null==t?-1:null==e?1:"string"==typeof t&&"string"==typeof e?t.localeCompare(e):Array.isArray(t)&&Array.isArray(e)?a(t,e):t>e?1:t<e?-1:0}function a(t,e){if(i.isEmpty(t)&&i.isEmpty(e))return 0;const n=Math.min(t.length,e.length);for(let i=0;i<n;i++){const n=s(t[i],e[i]);if(0!==n)return n}return s(t.length,e.length)}e.isPrimitive=o,e.isPrimitiveArray=function(t){return Array.isArray(t)&&t.every(o)},e.cmp=s,e.cmpArr=a},,function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(44),r=n(185);e.BoundedMap=class extends i.TTLMap{constructor(t,e,n){super(t,new r.MRUMap(e,n)),this.maxSize=e,this.fifo=n}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.version="0.6.0-alpha.1",e.release="0.6.0-alpha.1+20190821062758",e.gitSha="db7c291e059bae500abafeeb1d58b7434096f821",e.gitDate=new Date(1566368878e3)},function(t,e){t.exports=require("exiftool-vendored")},,function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(4),r=n(130),o=n(131),s=n(7),a=n(0),u=n(57);e.Average=class{constructor(t=10,e=0,n=0){this.maxSamples=t,this._k=e,this._avg=n,this._weightedTotalAvg=n,this._samples=new r.BoundedList(t)}push(t){if(!isFinite(t))throw new Error("Average.push("+t+"): not a number");if(this._k++,this._samples.push(t),this._min=null==this._min?t:Math.min(t,this._min),this._max=null==this._max?t:Math.max(t,this._max),1===this._k)this._m=t,this._v=0,this._avg=t,this._weightedTotalAvg=t;else{const e=this._m;this._m+=(t-this._m)/this._k,this._v+=(t-e)*(t-this._m),this._avg=this._avg*(this._k-1)/this._k+t/this._k,this._weightedTotalAvg=(this._weightedTotalAvg+t)/2}return t}stats(t=2){const e={k:s.sigFigs(this.k,t)};if(!this.empty){const n=e=>a.map(e,e=>s.sigFigs(e,t));e.mean=n(this.avg),e.max=n(this.max),e.min=n(this.min)}return e}get empty(){return 0===this._k}get k(){return this._k}get avg(){return this.empty?void 0:s.sigFigs(this._avg,4)}get max(){return this._max}get min(){return this._min}get stdDev(){return this._k<2?void 0:Math.sqrt(this._v/(this._k-1))}get sampleMode(){if(this.empty)return;const t=new o.CountingSet;this._samples.forEach(e=>t.incr(e));const e=t.entriesByCountDesc(),n=e[0][1],r=e.filter(([,t])=>t===n);return i.sortBy(r,([t])=>s.absdiff(this._avg,t))[0][0]}get sampleStdDev(){return i.mapNotEmpty(this._samples,u.stdDev)}get sampleAvg(){return i.mapNotEmpty(this._samples,u.avg)}get samples(){return[...this._samples]}p(t){if(0===this._samples.length)return 0;const e=[...this._samples].sort((t,e)=>t-e);return e[Math.floor(e.length*(t/100))]}get weightedAvg(){return i.mapNotEmpty(this._samples,t=>s.sigFigs(u.weightedAvg(t),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._k=0,this._weightedTotalAvg=0,this._samples.length=0}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(18),r=n(4),o=n(3),s=n(10),a=n(1),u=n(7),l=n(0),c=n(100),d=n(13);class h{constructor(t){this.h=t,this.text=l.orElse(t.text,i.toS(t)),this.greedyLeft=l.orElse(t.greedyLeft,!1)}toEntry(t){return[this.text,t.substring(this.leftIdx,this.rightIdx).trim()]}}const f=o.lazy(()=>a.mkLogger("Fixed"));e.parseFixed=function(t,e,n=!0){return new p(t,e,n).entries};class p{constructor(t,e,n=!0){this.warnIfMissingHeaders=n;const i=e.split(/[\r\n]{1,2}/);this.headerRow=i[0],this.rows=i.slice(1);const o=Math.max(...this.rows.map(t=>t.length));this.col2blanks=new Map(u.times(o,t=>[t,r.count(this.rows,e=>s.blank(e[t]))])),this.headers=this.extractHeaders(t.map(t=>new h(t))),this.entries=this.rows.map(t=>this.headers.map(e=>e.toEntry(t))).map(t=>l.fromEntries(t)).filter(t=>l.values(t).some(s.notBlank))}extractHeaders(t){let e=this.headerRow;r.sortBy(t,t=>-t.text.length),f().trace("extractHeaders()",t),t.forEach(t=>{const n=new RegExp(`\\b${t.text}\\b`,"i"),i=n.exec(e);null==i?this.warnIfMissingHeaders&&f().warn("extractHeaders(): Failed to find header!",{re:n,headerLine:e}):(t.indexOf=i.index,e=d.padReplace(e,i.index,t.text.length," "))});const n=t.filter(t=>null!=t.indexOf),i=r.sortBy(n,t=>t.indexOf);f().trace("extractHeaders()",{byAppearance:i}),i.forEach((t,e)=>{const n=t.indexOf,r=i[e-1],o=0===e?0:r.indexOf+r.text.length-1,[s,a]=t.greedyLeft?[o,n]:[n,o];t.leftIdx=l.map(this.firstBlankColumn(s,a),t=>t+1),0===e&&null==t.leftIdx&&(t.leftIdx=0),f().trace("extractHeaders(): finding leftIdx",{from:n,to:o,header:t}),null==t.leftIdx&&f().warn("no blank column for "+t.text+" between "+n+" and "+o)}),r.filterInPlace(i,t=>null!=t.leftIdx),i.slice(0,-1).forEach((t,e)=>{const n=i[e+1];t.rightIdx=n.leftIdx-1});const o=r.toA(c.diff(t.map(t=>t.text),i.map(t=>t.text)));return o.length>0&&f().warn("Missing headers",{missingHeaders:o}),i}firstBlankColumn(t,e){return r.range(t,e).find(t=>this.col2blanks.get(t)===this.rows.length)}}e.Fixed=p},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(22),r=n(9);e.getEnv=function(t){return r.firstValueCaseInsensitive(i.env,t)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(6);e.thenOpt=function(t){return s(t)?t:new o(()=>t)};class o{constructor(t){this.a=t}_map(t,e){return i(this,void 0,void 0,function*(){const n=null!=this.a?yield this.a():void 0,i=s(n)?yield n.get():n;return null!=i?t(i):e()})}isDefined(){return i(this,void 0,void 0,function*(){return this._map(()=>!0,()=>!1)})}isEmpty(){return i(this,void 0,void 0,function*(){return this._map(()=>!1,()=>!0)})}get(){return i(this,void 0,void 0,function*(){return this._map(t=>t,()=>void 0)})}getRequired(){return i(this,void 0,void 0,function*(){return this._map(t=>t,()=>{throw new Error("unexpectedly undefined")})})}exists(t){return i(this,void 0,void 0,function*(){return this._map(t,()=>!1)})}map(t){return new o(()=>i(this,void 0,void 0,function*(){return this._map(t,()=>void 0)}))}flatMap(t){return new o(()=>i(this,void 0,void 0,function*(){return this._map(t,()=>void 0)}))}filter(t){return new o(()=>i(this,void 0,void 0,function*(){return this._map(e=>i(this,void 0,void 0,function*(){return(yield t(e))?e:void 0}),()=>void 0)}))}catch(t){return new o(()=>this.get().catch(e=>i(this,void 0,void 0,function*(){return t(e)})))}forEach(t){return new o(()=>i(this,void 0,void 0,function*(){const e=yield this.get();return yield r.map(e,t),e}))}getOrElse(t){return i(this,void 0,void 0,function*(){return r.orElse(yield this.get(),t)})}orElse(t){return new o(()=>i(this,void 0,void 0,function*(){const e=yield this.get(),n=null==e?yield t():e;return s(n)?n.get():n}))}}function s(t){return t instanceof o}e.OptAsync=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(14);let r=new(n(233).PermissiveWorkPlanner);e.getWorkPlanner=function(){return r},e.setWorkPlanner=function(t){r=t},e.work=function(t,e){return r.work(t,e)},e.isPaused=function(){return r.isPaused()},e.pause=function(){r.isPaused()||(r.pause(),i.emitPause())},e.resume=function(){r.isPaused()&&(r.resume(),i.emitResume())}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(10),r=n(127);function o(t){return e=>i.blank(e)?"":t(e)}e.black=o(r.default.black),e.blue=o(r.default.blue),e.cyan=o(r.default.cyan),e.green=o(r.default.green),e.grey=o(r.default.grey),e.magenta=o(r.default.magenta),e.red=o(r.default.red),e.yellow=o(r.default.yellow)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(6),o=n(4),s=n(38),a=n(57),u=n(27);e.groupBy=function(t,e){const n=new l;return t.forEach(t=>r.map(e(t),e=>n.add(e,t))),n};class l{constructor(t=new Map){this.store=t}get(t){return this.store.get(t)}has(t){return this.store.has(t)}get keyCount(){return this.store.size}get valueCount(){return a.sum([...this.store.values()].map(t=>t.length))}add(t,e){return u.tap(s.getOrSet(this.store,t,()=>[]),t=>t.push(e))}delete(t,e){if(null==e)return this.store.delete(t);{const n=this.store.get(t);if(null==n)return!1;{const i=o.remove(n,e);return i&&0===n.length&&this.store.delete(t),i}}}clear(){return this.store.clear(),this}keys(){const t=this;return function*(){for(const[e,n]of t.store.entries())n.length>0&&(yield e)}()}values(){const t=this;return function*(){for(const[,e]of t.store.entries())e.length>0&&(yield e)}()}flatValues(){const t=this;return function*(){for(const[,e]of t.store.entries())if(e.length>0)for(const t of e)yield t}()}entriesArray(){return[...this.store.entries()].filter(([,t])=>o.isNotEmpty(t))}entries(){const t=this;return function*(){for(const[e,n]of t.store.entries())n.length>0&&(yield[e,n])}()}tuples(){const t=this;return function*(){for(const[e,n]of t.store.entries())for(const t of i.toA(n))null!=t&&(yield[e,t])}()}filterInPlace(t){let e=!1;for(const[n,i]of this.store.entries()){const r=i.length;o.filterInPlace(i,e=>t(n,e)),e=e||r!==i.length}return e}}e.MultiMap=l},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(8),s=n(16),a=n(46),u=n(15),l=n(4),c=n(53),d=n(3),h=n(2),f=n(10),p=n(29),m=n(69),g=n(14),v=n(28),y=n(1),S=n(158),w=n(23),b=n(13),M=n(216),P=n(217),x=n(219),E=n(220),_=n(222),T=n(40),O=n(223),k=n(159),F=n(24),I=d.lazy(()=>y.mkLogger("Volumes"));let D;e.nonRpcVolumes=c.keyedLazy("volumes",T.mountsCacheKey,function(){return i(this,void 0,void 0,function*(){const t=yield w.isWin?P.dfWin():M.dfPosix();if(null==t)return void I().warn("df failed");if(t.some(t=>t.remote&&o.blank(t.remoteHost))&&(yield h.thenOrTimeout(w.isWin?k.addRemoteVolumeInfoWin(t):O.addRemoteVolumeInfoPosix(t),10*s.secondMs).catch(t=>{g.emitNonFatal("Failed to get remote volume info",t)})),null==(yield(w.isWin?_.addLocalVolumeInfoWin(t):w.isMac?x.addLocalVolumeInfoMac(t):E.addLocalVolumeInfoPosix(t)).catch(t=>{g.emitNonFatal("Failed to get local volume info",t)})))return void I().warn("addLocalVolumeInfo failed");t.forEach(t=>o.mapNotBlank(t.remoteHost,e=>t.remoteHost=e.toLowerCase().normalize().trim())),t.forEach(t=>{t.remote=!!p.truthy(t.remote),!t.remote&&o.blank(t.uuid)&&(t.uuid=JSON.stringify({size:t.size}))});const e=l.sortBy(t,t=>t.mountpoint).filter(t=>!p.truthy(t.ignorable));return I().info("_volumes(): final result",e),Object.freeze(e)})},{maxRetries:2,timeoutMs:1.5*F.cmdTimeoutMs,priorResultTtlMs:F.longTtlMs}),g.onClearCache(()=>e.nonRpcVolumes.clear()),e.setRpcVolumesImpl=function(t){D=t};let C=[];function L(){return i(this,void 0,void 0,function*(){try{return yield h.thenTap((D||e.nonRpcVolumes)(),t=>{r.mapNotEmpty(t,t=>{const e=t.map(t=>t.mountpoint).sort();a.eql(C,e)||(g.emitVolumesChanged(),C=e)})})}catch(t){return void g.emitNonFatal("volumes() failed",t)}})}function A(t){return i(this,void 0,void 0,function*(){return h.thenMap(L(),e=>R(e,t))})}function R(t,e){const n=t.filter(t=>v.containedByNativePath(e,t.mountpoint));return l.greatestBy(n,t=>r.commonPrefixLength(t.mountpoint,e))}function j(t,e,n){return i(this,void 0,void 0,function*(){const r=n.filter(t=>b.equalsIgnoreCase(e,t.remoteShare));if(l.isEmpty(r))return;const o=r.find(e=>p.truthy(e.remote)&&f.notBlank(e.remoteHost)&&b.equalsIgnoreCase(t,e.remoteHost));if(null!=o)return o;const s=yield S.friendlyname(t);return h.asyncFind(r,t=>i(this,void 0,void 0,function*(){return b.equalsIgnoreCase(s,yield S.friendlyname(t.remoteHost))}))})}e.volumes=L,e.rootPath=d.lazy(()=>w.isWin?u.Opt(m.getEnv("SystemDrive")).filter(f.notBlank).orElse(()=>"C:").map(t=>b.ensureSuffix(t,"\\")).get():"/"),e.rootVolume=function(){return A(e.rootPath())},e.volumeFor=A,e.bestVolume=R,e.remoteVolumeFor=function(t,e){return i(this,void 0,void 0,function*(){return h.thenMap(L(),n=>j(t,e,n))})},e.bestRemoteVolume=j},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(39),o=n(3),s=n(2),a=n(11),u=n(52),l=n(32),c=n(1),d=n(48),h=n(13),f=o.lazy(()=>c.mkLogger("ImgTmp"));function p(t,n,r){return i(this,void 0,void 0,function*(){const i=yield t.stat();if(null==i)return void f().warn("tmpImgFile(): src.stat() was null",{src:t,desc:n,ext:r});const o=yield e.imgtmpDir();if(null==o)return void f().warn("tmpImgFile: null imgTmpDir");const s=d.GeoRadix.encodeBuffer(u.stringSha(JSON.stringify({src:t.nativePath,size:i.size,mtime:i.mtimeMs})));r=h.ensurePrefix(r,".");const a=o.join(...h.splitEvery(s.slice(0,24),2,3),n+r);return yield a.parent().mkdirp(),f().info("tmpImgFile("+t.baseWithGrandparent+")",{desc:n,ext:r,result:a}),a})}e.imgtmpDir=o.lazy(()=>i(this,void 0,void 0,function*(){return l.PosixFile.for(r.App.temp()).mkNoMedia()}),a.minuteMs),e.tmpImgFile=p,e.readableToFile=function(t,e,n,r){return i(this,void 0,void 0,function*(){try{return yield s.thenMap(p(t,e,n),t=>t.applyIfEmpty(t=>i(this,void 0,void 0,function*(){return s.thenMap(r(),e=>t.writeStream(e))})))}catch(e){throw f().warn("readableToFile("+t+"): "+e),e}})}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(8),o=n(6),s=n(17),a=n(9),u=n(3),l=n(52),c=n(114),d=n(1),h=n(0),f=n(19);e.zeroesRe=/^[\s0]*$/;const p=u.lazy(()=>d.mkLogger("ExifUid"));function m(t){return null==t||s.isNumber(t)?0===t:null!=e.zeroesRe.exec(f.toS(t))}function g(t){return null!=t&&r.notBlank(t)&&!m(t)}function v(t,e){return f.toS(t).split(e).map(t=>s.mapIntOr(t,t=>f.toS(s.sigFigs(t,2)),()=>t)).join(e)}e.zeroish=m,e.compactZeroes=function(t){return a.mapFields(t,(t,e)=>m(e)?void 0:[t,e])},e.present=g,e.sigfigish=v,e.normalizeExposureSettings=function(t){if(null==t)return;const e={focalLength:f.toS(t.focalLength).trim(),aperture:s.mapNumeric(t.aperture,t=>s.sigFigs(t,2)),shutterSpeed:v(t.shutterSpeed,"/"),iso:s.mapInt(t.iso,t=>s.sigFigs(t,2))};return p().debug("normalizeExposureSettings("+f.toS(t.FileName)+")",e),h.reqValuedOrElse(e)},e.cameraId=function(t){return a.pickFirst(t,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"],t=>r.notBlank(t)&&!m(t))},e.imageId=function(t,{includeImageUniqueId:e=!0}={}){return a.pickFirst(t,i.compact(["BurstUUID","ImageNumber","ShutterCount",e?"ImageUniqueID":void 0,"RunTimeValue"]),g)},e.uidGeoHash=function(t,e){return c.geohash(s.toFixed(t,4),s.toFixed(e,4))},e.serializeUidPojo=function(t,e=28){return o.map(t,t=>l.shortStringSha(JSON.stringify(t),e)+":v"+t.version)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(9),r=n(84),o=n(63);e.memoize=function(t,e,n){let s=0;const a=new o.BoundedMap(e,n,!0),u=e=>(s++,a.getOrSet(JSON.stringify(e),()=>i.tap(t(e),t=>{r.isPromise(t)&&t.catch(()=>u.clear())})));return u.clear=t=>null==t?a.clear():a.delete(JSON.stringify(t)),u.prior=()=>new Map(a.entries()),u.size=()=>a.size,u.callCount=()=>s,u}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(30),r=n(5),o=n(9),s=n(18);e.joinQuery=function(t,e){if(null==e)return t;const n=o.entries(e).filter(([,t])=>null!=t);return r.isEmpty(n)?t:t+"?"+n.map(t=>t.map(s.toS).map(encodeURIComponent).join("=")).join("&")},e.parent=function(t){return i.posix.parse(t).dir},e.PS_LIBRARY_PROTOCOL="pslib:",e.PS_LOCAL_FILE_PROTOCOL="psfile:",e.OLD_PS_LOCAL_FILE_PROTOCOL="psvol:",e.PS_NETWORK_FILESYSTEM_PROTOCOL="psnet:"},function(t,e){t.exports=require("luxon")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(15);e.retryOnReject=function(t,e){const n=r.Opt(e.errorIsRetriable).getOrElse(()=>()=>!0),o=r.Opt(e.onRetryWaitUntil).getOrElse(()=>()=>Promise.resolve());let s=0;const a=()=>i(this,void 0,void 0,function*(){try{return yield t()}catch(t){if(n(t)&&s<e.maxRetries)return s++,yield o(s),a();throw t}});return a()}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(87),o=n(22),s=n(5),a=n(8),u=n(16),l=n(6),c=n(17),d=n(15),h=n(18),f=n(39),p=n(4),m=n(21),g=n(3),v=n(2),y=n(51),S=n(50),w=n(11),b=n(14),M=n(34),P=n(28),x=n(1),E=n(38),_=n(7),T=n(0),O=n(23),k=n(187),F=n(47),I=g.lazy(()=>x.mkLogger("Pids"));function D(t,e){return i(this,void 0,void 0,function*(){return null!=t&&null!=e&&(t.name===h.toS(e.pid)&&L(yield t.readJSON(),e))})}e.addPid=function(t,e){return A.instance().addPid(t,e)};const C=10*u.secondMs;function L(t,e){if(null==t||null==e)return!1;const n=l.map(e.start,t=>t.getTime()),i=t.startTime;return _.gt0(n)&&_.gt0(i)&&Math.abs(n-i)<C}class A{constructor(t=M.BaseFile.for(f.App.userData()).join("pids")){this.pidsDir=t,this.p=new y.Promises,this.killOldProcs=(t={})=>this.p.serial("killOldProcs()",()=>i(this,void 0,void 0,function*(){const e=T.orElse(t.everything,!1),n=T.orElse(t.force,O.isWin),i=yield this.pidfiles(),r=yield E.toMapAsync(i,t=>v.thenMap(t.readJSON(),t=>[t.pid,t])),a=s.uniq(p.flatten(s.toA(r.values()).map(t=>[t.pid,t.ppid])));if(s.isEmpty(a))return I().debug("killOldProcs(): no pidfiles"),[];const u=yield k.pidInfos(a);if(I().debug("killOldProcs()",{pids:a,allEntries:u}),null==u)return void b.emitNonFatal("Pids.killOldProcs(): failed to get process information");const c=new Set(u.map(t=>t.pid)),d=u.filter(t=>r.has(t.pid)),h=s.sortBy(s.compact(d.map(t=>l.map(r.get(t.pid),e=>L(e,t)?Object.assign({},e,t):void 0))),t=>t.pid).filter(t=>o.pid!==t.pid),f=e?h:h.filter(e=>!c.has(e.ppid)||!c.has(e.pid)||_.gt0(e.timeoutTime)&&Date.now()>=e.timeoutTime||null!=t.everythingBefore&&e.startTime<t.everythingBefore);I().debug("killOldProcs()",{trackedEntries:d,victims:f,pidfiles:s.toA(r.values())});for(const t of f)I().info("killOldProcs(): killing",{entry:t}),R(t.pid,n,!1);return yield this.vacuumPids(),s.sortBy(f,t=>t.pid)}))}addPid(t,e){return i(this,void 0,void 0,function*(){if(null==t)throw new Error("undefined info");const n=t.pid;if(!_.gt0(n))throw new Error("undefined pid");if(!_.gte0(t.maxAgeMs))throw new Error("bad maxAgeMs: "+JSON.stringify(t));const i=this.pidsDir.join(t.pid+".json"),r=d.Opt(T.Try(()=>P.parse(t.cmd).base)).filter(a.notBlank).getOrElse(()=>t.cmd),o=e.getTime(),s=_.mapGt0(t.maxAgeMs,t=>o+t),u=Object.assign({},t,{cmd:r,startTime:o,timeoutTime:s});if(null==(yield i.writeJSON(u)))throw new Error("Failed to write to "+i);return I().debug("addPid() wrote "+i,u),i})}pidfiles(){return this.pidsDir.clear().children(t=>".json"===t.ext&&null!=c.toInt(t.name))}onKill(t){return i(this,void 0,void 0,function*(){const e=this.pidsDir.join(t+".json");return v.thenMap(e.clear().readJSON(),e=>this.addPid(Object.assign({},e,{maxAgeMs:1}),w.ago(u.minuteMs)).catch(e=>{I().info("onKill(): failed to rewrite pidfile: "+e,{pid:t})}))})}vacuumPids(){return i(this,void 0,void 0,function*(){const t=yield this.pidfiles(),e=s.toA(t).map(t=>c.toInt(t.name)).filter(_.gt0);if(s.isEmpty(e))return;const n=yield k.pidInfos(e);if(null!=n){I().info("vacuumPids",{pids:e,pidfiles:s.toA(t).map(t=>t.base),entries:n});for(const e of t){const t=n.find(t=>h.toS(t.pid)===e.name);null!=t&&(yield D(e,t))||(I().info("vacuumPids(): Removing old pidfile "+e.base,{psEntry:t,pidfile:yield e.readFile().then(h.toS).catch(t=>"(failed to read file: "+t+")")}),yield e.unlink())}}else b.emitNonFatal("Failed to get pidInfo for pids "+e)})}}function R(t,e=!1,n=!0){if(t===o.pid||t===o.ppid)throw new Error("cannot self-terminate");return e&&n&&A.instance().onKill(t),O.isWin?function(t,e=!1){return i(this,void 0,void 0,function*(){if(m.ending()||F.PowerShell.instance().ended)return r.kill(t,e);try{const n=s.compact(["Stop-Process","-Id",c.toInt(t),e?"-Force":void 0]).join(" ");yield F.PowerShell.instance().execute(n,T.identity)}catch(n){I().warn("killWin(): pwsh error, using TASKKILL: "+n),r.kill(t,e)}})}(t,e):function(t,e=!1){return i(this,void 0,void 0,function*(){try{o.kill(t,e?"SIGKILL":"SIGTERM")}catch(t){if(!String(t).includes("ESRCH"))throw t}})}(t,e)}function j(t){return i(this,void 0,void 0,function*(){return null!=(yield k.pidInfo(t))})}A.instance=g.lazy(()=>new A),e.Pids=A,e.kill=R,e.pidExists=j,e.pidNotExists=function(t){return v.thenNot(j(t))},e.ProcCleaner=g.lazy(()=>{const t=[{everything:!1,force:!1,intervalMs:5*u.minuteMs},{everything:!1,force:!0,intervalMs:17*u.minuteMs}].map(t=>S.setUnrefInterval(()=>A.instance().killOldProcs(t),t.intervalMs));return m.addCleanupEndable(new m.EndableWrapper("ProcCleaner",()=>(t.map(clearInterval),A.instance().killOldProcs())))})},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(65),o=n(79),s=n(5),a=n(8),u=n(16),l=n(6),c=n(17),d=n(9),h=n(4),f=n(2),p=n(26),m=n(1),g=n(0),v=n(150),y=m.mkLogger("CapturedAt");class S{constructor(t,e,n,i){this.file=t,this.date=e,this.src=n,this.mtime=i}spread(t){const e=Object.assign({},this,t);return new S(e.file,e.date,e.src,e.mtime)}hasTz(){return p.hasZoneOffset(this.date)}hasTime(){return p.hasTime(this.date)}toISOString(){return p.datedToISO(this.date)}toString(){return JSON.stringify({file:this.file.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}}function w(t,e){return i(this,void 0,void 0,function*(){if(null==e||!p.validDate(e))return;if(p.hasZoneOffset(e))return e;const n=yield v.nearestSiblingTzOffset(t);if(null!=n){const t=p.toDateTime(e,n);if(p.validDate(t))return t}return e})}function b(t,e){return i(this,void 0,void 0,function*(){const n=p.datedToMillis(e),i=yield t.stat();if(null==i)return;const o=d.compactValues({bname:p.parseDatedWithTime(v.bname(t)),birthtime:0!==i.birthtimeMs?i.birthtime:void 0,mtime:i.mtime});for(const[i,s]of d.entries(o)){const o=p.diffMillis(s,n);if(null!=o){const n=r.offsetMinutesToZoneName(o/u.minuteMs);if(y.trace(t.baseWithGrandparent+" offset",{tz:n,src:i,deltaHours:c.sigFigs(o/u.hourMs,2),ea:s,ts:e}),null!=n)return{ts:p.toDateTime(e,n),src:i}}}})}function M(t){return g.map(t,t=>h.first(["SubSecDateTimeOriginal","DateTimeOriginal","SubSecCreateDate","CreateDate","SubSecMediaCreateDate","MediaCreateDate","DateTimeCreated","DateTimeUTC","GPSDateTime"],e=>{const n=t[e];if(p.validDate(n))return!p.hasZoneOffset(n)&&a.notBlank(t.tz)?l.orElse(p.toDateTime(n,t.tz),n):n}))}e.CapturedAt=S,e.bestCapturedAt=function(t){return i(this,void 0,void 0,function*(){const e=h.sortBy(t,t=>-t.mtime.getTime());return g.firstThunk(()=>e.find(t=>t.src.startsWith("tags")),()=>e.find(t=>"statname"===t.src),()=>e.find(t=>"siblings"===t.src),()=>e.find(t=>"path"===t.src),()=>t[0])})},e.capturedAtTags=function(t){return t=h.sortBy(s.toA(t),t=>-t.mtime),h.firstNonEmptyThunk(()=>t.filter(t=>t.src.startsWith("tags")),()=>t.filter(t=>"statname"===t.src),()=>t.filter(t=>"siblings"===t.src),()=>t.filter(t=>"path"===t.src),()=>t.filter(t=>"stat"===t.src).slice(1,1),()=>[])},e.hasSubSecCapturedAt=function(t){return null!=t&&h.anyDefined([t.SubSecTime,t.SubSecTimeDigitized,t.SubSecTimeOriginal,t.SubSecCreateDate,t.SubSecDateTimeOriginal])},e.addTzFromSibs=w,e.extractCapturedAt=function(t,e,n){return i(this,void 0,void 0,function*(){const r=yield t.mtime(),s=(s,a)=>f.thenMap(function(t,e,n,r){return i(this,void 0,void 0,function*(){const i=yield n;if(p.validDate(i))return p.hasZoneOffset(i)?i:null!=e&&null!=e.tz&&o.Info.isValidIANAZone(e.tz)?p.toDateTime(i,e.tz):r?i:w(t,i)})}(t,e,a,n),e=>(y.debug("extractCapturedAt()",{f:t.nativePath,src:s,at:p.datedToISO(e)}),new S(t,e,s,r))),a=yield f.firstDefinedPromise(()=>s("tags",M(e)),()=>s("statname",v.extractStatname(t)),()=>n?void 0:s("siblings",v.inferCapturedAtFromSiblings(t)),()=>n?void 0:s("name",p.parseDated(v.bname(t))),()=>n?void 0:s("path",p.extractDateFromPath(t.pathnamesWithoutDrive)),()=>s("stat",t.minStatDate()));if(null!=a&&a.hasTime()&&!a.hasTz()&&"tags"===a.src){const e=yield b(t,a.date);if(null!=e)return y.info("extractCapturedAt(): inferring timezone offset",{capturedAt:a,inferred:e}),a.spread({date:e.ts,src:a.src+" (tz from "+e.src+")"})}return a})},e.inferTzFromFile=b,e.capturedAtFromTags=M},,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.thenTap=function(t,e=console.dir.bind(console)){return i(this,void 0,void 0,function*(){const n=yield t;return yield e(n),n})},e.isPromise=function(t){return null!=t&&"function"==typeof t.then&&"function"==typeof t.catch}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5);function r(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}function o(t,e){return Math.random()*(e-t)+t}function s(){return e.RandomChars[r(0,e.RandomChars.length)]}function a(t){const e=Array(...t);for(let t=e.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));t!==n&&([e[t],e[n]]=[e[n],e[t]])}return e}e.randomInt=r,e.randomFloat=o,e.RandomChars="0123456789abcdefghijkmnopqrstuvwxyz",e.randomChars=function(t){let e="";for(let n=0;n<t;n++)e+=s();return e},e.randomChar=s,e.pickRandom=function(...t){return t[r(0,t.length)]},e.shuffle=a,e.sample=function(t,e){if(e<t.length/10){const n=new Set;for(;n.size<e;)n.add(r(0,t.length));return[...n.keys()].map(e=>t[e])}return a([...t]).slice(0,e)},e.pickWeightedRandom=function(t){if(i.isEmpty(t))return;let e=o(0,i.sum(t,t=>t.priority));return t.find(t=>(e-=t.priority)<=0)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(30),o=n(5),s=n(8),a=n(16),u=n(6),l=n(9),c=n(15),d=n(18),h=n(3),f=n(2),p=n(10),m=n(20),g=n(69),v=n(14),y=n(32),S=n(104),w=n(1),b=n(7),M=n(0),P=n(23),x=n(47),E=n(232),_=n(12),T=n(31),O=n(24),k=n(71),F=n(93),I=h.lazy(()=>w.mkLogger("vlc"));e.vlcVersionDescription=h.lazy(()=>f.thenMapOr(e.vlcInfo().catch(()=>void 0),t=>t.version+("vlc"===t.path?" (found on $PATH)":" from "+t.path),()=>"(not found on $PATH)"));const D=/VLC version (\S+)/i,C=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"];function L(t){return i(this,void 0,void 0,function*(){return f.thenMap(m.stdoutResult(t,[...C,"--version"],{timeout:O.cmdTimeoutMs,ignoreStderr:!0,quiet:!0}),t=>c.Opt(t.result).filter(s.notBlank).map(t=>t.trim()).flatMap(t=>D.exec(t)).flatMap(t=>E.SemVer.for(t[1])).get())})}function A(t){return f.thenMap(x.PowerShell.instance().execute(`(Get-Item -path "${t}").VersionInfo.FileVersion`,t=>t).catch(e=>{I().warn("Failed to run vlcInfoWin: "+t+": "+e)}),t=>E.SemVer.for(t.trim()))}function R(t){return!p.blank(t)&&t.startsWith("video/")}e.vlcInfo=h.lazy(()=>(function(){return i(this,void 0,void 0,function*(){const t=[_.Settings.vlcPath.valueOrDefault];function e(...e){t.push(y.PosixFile.for(r.join(...e)))}const n=[];if(P.isMac){const t="/Applications/VLC.app/Contents/MacOS/VLC";s.mapNotBlank(g.getEnv("HOME"),n=>e(n+t)),e(t)}if(P.isWin){const t=["VideoLAN","VLC","vlc.exe"];s.mapNotBlank(g.getEnv("LOCALAPPDATA"),n=>{e(n,"Apps",...t)}),s.mapNotBlank(g.getEnv("HOMEPATH"),n=>{e(n,"AppData","Local","Apps",...t)}),s.mapNotBlank(g.getEnv("ProgramFiles"),n=>{e(n,...t)}),s.mapNotBlank(g.getEnv("ProgramFiles(x86)"),n=>{e(n,...t)})}for(const e of t)try{if(e instanceof y.PosixFile&&(yield e.clear().notExists()))continue;const t=e.toString(),i=yield P.isWin?A(t):L(t);if(null==i){I().info("No VLC version found for "+e);continue}if(3===i.major&&0===i.minor)return l.tap({path:t,version:i},t=>I().info("VLC version found!",t));n.push({path:t,unsupportedVersion:i})}catch(t){I().warn("vlcInfo(): err:"+t,{path:e})}return n[0]})})()),e.isVlcSupported=h.lazy(()=>f.thenMapOr(e.vlcInfo(),t=>null!=t.version,()=>!1)),e.vlcPath=h.lazy(()=>f.thenMap(e.vlcInfo(),t=>null==t.version?void 0:t.path)),e.vlcSupportedFile=function(t){return i(this,void 0,void 0,function*(){return!!(yield e.isVlcSupported())&&f.thenMapOr(T.mimetype(t),R,()=>!1)})},e.vlcSupportedMimeType=R,e.vlcFrame=function(t,n,r=1){return i(this,void 0,void 0,function*(){return k.work("vlcFrame()",()=>(function(t,n,r=1){return i(this,void 0,void 0,function*(){const i=yield T.readRawTags(t);if(null==i)throw new Error(t+" has no tags");const s=i.MIMEType;if(null==s)throw new Error(t+" has no MIMEtype");if(!s.startsWith("video/"))throw new Error(t+": unsupported mimetype, "+s);const l=_.Settings.minVideoDimension.valueOrDefault,c=i.ImageWidth;if(null!=c&&!b.gte(c,l))throw new Error(t+": invalid width: "+c);const d=i.ImageHeight;if(null!=d&&!b.gte(d,l))throw new Error(t+": invalid height: "+d);const h=yield e.vlcPath();if(p.blank(h))throw new Error(t+" is not supported (no vlc)");if(".jpg"!==n.ext)throw new Error("only .jpg is supported");if(null==(yield n.parent().mkdirp()))throw new Error("Cannot make dest dir, "+n.dir);const f=Math.min(1,r),g=o.compact([...C,"--avcodec-hw=none","--video-filter=scene","--scene-format=jpg","--scene-replace","--scene-ratio=200",u.map(c,t=>"--scene-width="+t),u.map(d,t=>"--scene-height="+t),"--scene-path="+n.parent().nativePath,"--scene-prefix="+n.name.replace(/[^a-z]/gi,""),"--start-time=0","--stop-time="+f,t.nativePath,"vlc://quit"]);I().info("_vlcFrame",{args:g});const v=yield m.stdoutResult(h,g,{timeout:30*a.secondMs,ignoreStderr:!0});if(n.clear(),b.gt0(v.code))throw new Error("vlc failed: "+JSON.stringify(v));return!0})})(t,n,r))})},e.vlcTranscode=function(t,n,r){return i(this,void 0,void 0,function*(){return k.work("vlcTranscode()",()=>(function(t,n,r=2048){return i(this,void 0,void 0,function*(){const s=yield e.vlcPath();if(p.blank(s))throw new Error("vlc.transcode(): VLC is not installed, cannot transcode "+t);const a=yield t.size();if(!b.gt0(a))throw new Error("vlcTranscode(): cannot read "+t);const l=yield F.transcodeTimeoutForFile(t);if(!b.gt0(l))throw new Error("vlcTranscode(): no timeout");const c=yield T.readRawTags(t);if(null==c)throw new Error("Cannot transcode files that exiftool can't read");if(!d.toS(c.MIMEType).startsWith("video/"))throw new Error("Cannot transcode MIMEType "+c.MIMEType);const h=yield n.parent().mkdirp();if(null==h)throw new Error("vlc.transcode(): cannot make dest dir: "+n.parent());yield n.unlink("debug");const f=u.map(c,t=>b.mapGt0(t.ImageWidth,t=>"width="+Math.floor(t))),g=u.map(c,t=>b.mapGt0(t.ImageHeight,t=>"height="+Math.floor(t))),y=u.map(r,t=>"vb="+t),w=o.compact(["vcodec=h264",y,f,g,"venc=x264{ref=2:me=hex:mixed_ref=0:chroma_qp_offset=0:b_adapt=1:direct=1:weightp=1:rc_lookahead=20}","acodec=mp4a","ab=128","channels=2","samplerate=44100","scodec=none","deinterlace"]).join(","),P=["access=file{overwrite}","mux=mp4","dst="+n.base].join(","),x=[...C,"--no-repeat","--no-loop",t.fileuri(),`--sout=#transcode{${w}}:standard{${P}}`,"vlc://quit"];I().info("transcode()",{src:t,timeout:l,duration:c.Duration,size:a,videoBitrateKbps:y,width:f,height:g,args:x});const E=u.mapOr(c.Duration,t=>t*r*300,()=>a),_=new S.PullProgressObserver({path:t.nativePath,op:"video conversion"},E,()=>i(this,void 0,void 0,function*(){return M.orElse(yield n.clear().size(),0)}));try{const t=yield _.observe(m.stdoutResult(s,x,{cwd:h.nativePath,timeout:l,ignoreStderr:!0}));if(v.emitFileChanged(n.nativePath),0!==t.code)throw new Error("vlc failed: "+JSON.stringify(t))}catch(t){throw yield n.unlink("debug"),t}return!0})})(t,n,r))})}},function(t,e){t.exports=require("batch-cluster")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(8);e.onDataChunked=function(t,e,n){new r(e,n,!0).read(t)};class r{constructor(t,e,n=!0){this.sep=t,this.onData=e,this.filterBlanks=n,this.incompleteChunk=""}onChunk(t){if(null==t)return;const e=(this.incompleteChunk+t.toString()).split(this.sep);this.incompleteChunk=e.pop(),e.forEach(t=>{this.filterBlanks&&!i.notBlank(t)||this.onData(t)})}read(t){return t.on("data",t=>this.onChunk(t)),t.on("close",()=>this.onChunk("")),this}}e.Chunker=r},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(8),s=n(18),a=n(3),u=n(10),l=n(12);function c(t){const n=e.LogLevels.indexOf(t.toLowerCase());return-1===n?e.LogLevels.length-1:n}e.LogLevels=["error","warn","info","debug","trace"],e.levelIndex=c,e.silently=function(t){try{return e.logFilter().silent=!0,t()}finally{e.logFilter().silent=!1}},e.silentlyAsync=function(t){return i(this,void 0,void 0,function*(){try{return e.logFilter().silent=!0,yield t()}finally{e.logFilter().silent=!1}})},function(t){t.highlight=()=>!1,t.enabled=()=>!t.silent,t.defaultLevelIndex=c("trace"),t.silent=!1}(e.PermissiveLogFilter||(e.PermissiveLogFilter={}));const d=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i;class h{constructor(t){this.silent=!1,this.contexts=[];let e=c(l.Settings.logLevel.defaultValue);const n=u.notBlank(t)?t:l.Settings.logLevel.valueOrDefault;r.compactBlanks(n.split(",")).forEach(n=>{const i=d.exec(n.trim());if(null==i)l.isTest||console.error("EnvLogFilter: Ignoring '"+n+"' from "+t);else{const t=s.toS(i[1]).toLowerCase(),n=c(i[2]);o.blank(t)?e=n:this.contexts.push({prefix:t,levelIndex:n})}}),this.defaultLevelIndex=e}contextOverride(t){if(0===this.contexts.length&&o.blank(t))return;const e=s.toS(t).toLowerCase();return this.contexts.find(t=>e.startsWith(t.prefix))}enabled(t,e){if(this.silent)return!1;const n=c(t),i=this.contextOverride(e);return n<=(null!=i?i.levelIndex:this.defaultLevelIndex)}highlight(t){const e=this.contextOverride(t);return null!=e&&e.levelIndex>=this.defaultLevelIndex}}e.LogFilterImpl=h,e.logFilter=a.lazy(()=>new h),l.Settings.logLevel.addListener(()=>e.logFilter.clear())},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(42),r=n(4),o=n(11),s=n(14),a=n(7),u=n(190),l=n(57);s.onClearCache(()=>c.clearCaches());class c{constructor(t){if(this.ttlMs=t,this._eventCount=0,this._firstEventTime=0,this._lastEventTime=0,t<=0)throw new Error("ttlMs must be positive");this.start=Date.now(),this.eventTimes=new u.TTLArray(t),c.instances.push(this),r.retainLastN(c.instances,1e3)}static clearCaches(){this.instances.forEach(t=>t.clear())}[i.inspect.custom](){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){const t=Date.now();0===this._eventCount&&(this._firstEventTime=t),this._lastEventTime=t,this.eventTimes.push(t),this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventTimes.clear()}get firstEventTime(){return this._firstEventTime}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return 0===this.eventTimes.length?0:l.weightedAvg(l.deltas([...this.eventTimes.values,Date.now()]))}get eventsPerMs(){return this.eventTimes.length/this.ttlMs}get msPerEvent(){return a.mapGt0(this.eventTimes.length,t=>this.ttlMs/t)}get eventsPerSecond(){return a.sigFigs(this.eventsPerMs*o.secondMs,3)}get eventsPerMinute(){return a.sigFigs(this.eventsPerMs*o.minuteMs,3)}}c.instances=[],e.Rate=c},,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(6),s=n(2);e.True=()=>!0,e.not=function(t){return e=>!t(e)},e.and=function(...t){return e=>{for(const n of t)if(!n(e))return!1;return!0}},e.or=function(...t){return e=>{for(const n of t)if(n(e))return!0;return!1}},e.all=function(t,e){for(const n of t)if(!e(n))return!1;return!0},e.some=function(t,e){for(const n of t)if(e(n))return!0;return!1},e.none=function(t,e){for(const n of t)if(e(n))return!1;return!0},e.find=function(t,e){for(const n of t)if(e(n))return n},e.filter=function(t,e){return i(this,void 0,void 0,function*(){return null==t||null==e?o.mapOr(t,r.compact,()=>[]):s.asyncFilter(t,e)})},e.apply=function(t,e){return i(this,void 0,void 0,function*(){return null==t||null==e?t:(yield e(t))?t:void 0})}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(11),o=n(162),s=n(7),a=n(2),u=n(0),l=n(31),c=n(49);e.MinSyncFileTimeoutMs=30*r.secondMs,e.MaxSyncFileTimeoutMs=15*r.minuteMs,e.DurationMultiplier=15;const d={p0:{x:7*s.MB,y:30*r.secondMs},p1:{x:18*s.MB,y:90*r.secondMs}},h={p0:{x:500*s.KB,y:20*r.secondMs},p1:{x:22*s.MB,y:60*r.secondMs}},f={p0:{x:7*s.MB,y:30*r.secondMs},p1:{x:18*s.MB,y:90*r.secondMs}};function p(t){return c.isVideoExt(t.ext)?Math.max(o.lerp2d(f.p0,f.p1,t.bytes),u.orElse(s.mapGt0(t.durationMs,t=>t*e.DurationMultiplier),0)):0}function m(t){return a.thenMap(t.size(),e=>i(this,void 0,void 0,function*(){return{bytes:e,ext:t.ext,durationMs:c.isVideoExt(t.ext)?yield a.thenMap(l.readRawTags(t),t=>s.mapGt0(t.Duration,t=>t*r.secondMs)):void 0}}))}function g(t){const n=s.clamp(100*s.KB,64*s.GB,t.bytes),i=2*r.secondMs,a=20*r.secondMs,u=n*r.secondMs/(4*s.MB),l=t=>o.lerp2d(t.p0,t.p1,n),f=l(d),m="raw"===c.extType(t.ext)?l(h):0,g=p(t);return s.clamp(e.MinSyncFileTimeoutMs,e.MaxSyncFileTimeoutMs,Math.round(i+a+u+f+m+g))}e.transcodeTimeoutForFile=function(t){return c.isVideoExt(t.ext)?a.thenMap(m(t),p):void 0},e.transcodeTimeout=p,e.syncFileTimeoutForFile=function(t){return a.thenMap(m(t),g)},e.syncFileTimeout=g},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(9),r=n(10),o=n(1),s=n(7),a=o.mkLogger("ExposureSettings");e.extractExposureSettings=function(t){const e={focalLength:t.FocalLength,iso:s.firstNonZero(t.ISO,t.ISOSpeed,t.SonyISO),aperture:s.firstNonZero(t.FNumber,t.Fnumber,t.ApertureValue,t.SonyFNumber),shutterSpeed:r.firstNotBlank(t.ExposureTime,t.ShutterSpeed,t.SonyExposureTime)};return a.debug("extracted from "+t.FileName,{exposureSettings:e}),i.reqValuedOrElse(e)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getOrSet=function(t,e,n){if(t.has(e))return t.get(e);{const i=n();return t.set(e,i),i}}},function(t,e){t.exports=require("stream")},,function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(65),r=n(9),o=n(26),s=n(7),a=n(19),u=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/;class l{constructor(t,e,n,i=0,r=1){this.start=t,this.middle=e,this.end=n,this.index=i,this.splits=r,this.toISOString=this.toString.bind(this),this.year=o.getYear(this.middle),this.month=o.getMonth(this.middle),this.day=o.getDay(this.middle)}static parse(t){t=a.toS(t).trim();const e=u.exec(t);if(null==e)return;const n=i.ExifDateTime.fromISO(e[1]),r=i.ExifDateTime.fromISO(e[2]),o=s.toInt(e[3]),l=s.toInt(e[4]);return this.for(n,r,o,l)}static for(t,e,n=0,i=1){if(!o.validDate(t)||!o.validDate(e))return;const a=o.toDateTime(t),u=o.toDateTime(e);if(null==a||null==u)return;i=s.clamp(1,1e3,s.toInt(i,{defaultValue:1})),n=s.clamp(0,i-1,s.toInt(n,{defaultValue:0}));const c=r.map(a.toDateTime().until(u.toDateTime()).divideEqually(i+1)[n],t=>t.end);return null!=c?new l(a,o.toDateTime(c,a.zone),u,n,i):void 0}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDateTime(){return this.middle.toDateTime()}toDate(){return this.toDateTime().toJSDate()}get hasTimes(){return o.hasTime(this.start)&&o.hasTime(this.end)}toString(t=!0){return`${o.datedToISO(this.start,t)}/${o.datedToISO(this.end,t)}`+(0===this.index&&1===this.splits?"":`/${this.index}/${this.splits}`)}includes(t){if(null==t)return!1;const e=o.toDateTime(t);return null!=e?this.interval().contains(e.toDateTime()):this.year===o.getYear(t)&&this.month===o.getMonth(t)&&this.day===o.getDay(t)}}e.DateInterval=l},function(t,e){t.exports=require("fs-extra")},function(t,e,n){"use strict";function i(t){return t instanceof Set?t:new Set([...t])}Object.defineProperty(e,"__esModule",{value:!0}),e.asSet=i,e.union=function(t,e){return new Set([...t,...e])},e.intersection=function(t,e){const n=i(e);return new Set([...t].filter(t=>n.has(t)))},e.diff=function(t,e){const n=i(e);return new Set([...t].filter(t=>!n.has(t)))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(95),o=n(6),s=n(33),a=n(2),u=n(130),l=n(25),c=n(0),d=n(19);e.LogLevels=s.strEnum("error","warn","info","debug","trace");const h=()=>void 0;e.NoOpLogger={enabled:()=>!1,log:h,flush:()=>Promise.resolve(),close:h,error:h,warn:h,info:h,debug:h,trace:h},e.safeLogger=function(t){return{enabled:(e,n)=>c.Try(()=>t.enabled(e,n),()=>!1),log:(e,n,i,r)=>c.Try(()=>t.log(e,n,i,r)),flush:()=>a.tryAsync(()=>t.flush()),close:()=>a.tryAsync(()=>t.close())}};const f=/^[a-z]*/i;e.MaxRecentLogEntriesByLevel=20;const p=new Map;e.clearRecentLogEntries=function(){p.clear()},e.recentLogEntries=function(){const t=[];for(const e of p.values())t.push(...e.toA());return i.sortBy(t,t=>t.timestamp)};e.ContextualLogger=class{constructor(t,e){this.context=t,this.logger=e,this.error=(t,e)=>{this.log("error",t,e)},this.warn=(t,e)=>{this.log("warn",t,e)},this.info=(t,e)=>{this.log("info",t,e)},this.debug=(t,e)=>{this.log("debug",t,e)},this.trace=(t,e)=>{this.log("trace",t,e)},this.filterContext=o.mapOr(f.exec(d.toS(this.context)),t=>t[0],()=>this.context)}throw(t,e){const n=l.asError(t);throw this.log("error",l.errorToS(n),e),n}log(t,n,i){var o;"trace"!==t&&(o={timestamp:Date.now(),level:t,context:this.context,msg:n,meta:i},r.getOrSet(p,o.level,()=>new u.BoundedList(e.MaxRecentLogEntriesByLevel)).push(o)),this.enabled(t)&&c.map(this.logger(),e=>e.log(t,this.context,n,i))}enabled(t){const e=this.logger();return null!=e&&e.enabled(t,this.filterContext)}flush(){return this.logger().flush()}close(){return c.map(this.logger(),t=>t.close())}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(33);e.ReducerNames=i.strEnum("fit","sq"),e.isReducerName=function(t){return i.enumHas(e.ReducerNames,t)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(4),o=n(10),s=n(63),a=n(11),u=n(48),l=n(7),c=n(0),d=n(100),h=n(19);function f(t,e){if(null==t)return e;if(null==e)return t;if((t=t.normalize())===(e=e.normalize())||e.includes(t))return t;if(t.includes(e))return e;const n=new l.Array2D(t.length);let i=0,r="";for(let o=0;o<t.length;o++)for(let s=0;s<e.length;s++)t[o]===e[s]&&(0===o||0===s?n.set(o,s,1):n.set(o,s,n.get(o-1,s-1)+1),n.get(o,s)>=i&&(i=n.get(o,s),r=t.substr(o-i+1,i)));return r}function p(t,e){if(null!=t&&null!=e)return t=t.normalize(),e=e.normalize(),t.length!==e.length?void 0:t.split("").reduce((t,n,i)=>n===e.charAt(i)?t:t+1,0)}e.commonSubstringRatio=function(t,e){return[t,e].some(o.blank)?0:f(t,e).length/Math.max(t.length,e.length)},e.lcs=f,e.hamming=p;const m=new s.BoundedMap(10*a.minuteMs,1e4,!0),g=String.fromCharCode(31);function v(t,e){return t=t.normalize(),e=e.normalize(),m.getOrSet(r.sort([t,e]).join(g),()=>{if(0===t.length)return e.length;if(0===e.length)return t.length;const n=t.charAt(t.length-1)===e.charAt(e.length-1)?0:1,i=t.slice(0,-1),r=e.slice(0,-1);return Math.min(v(i,e)+1,v(t,r)+1,v(i,r)+n)})}function y(t,e){const n=t.toUpperCase().normalize(),i=e.toUpperCase().normalize();return c.firstThunk(()=>n===i?1:void 0,()=>o.blank(t)!==o.blank(e)?0:void 0,()=>1===t.length&&1===e.length?0:void 0,()=>{const t=S(n),e=S(i);return 2*w(t,e).length/(t.length+e.length)})}function S(t){return null==t||0===t.length?[]:t.slice(0,-1).split("").map((e,n)=>e+t[n+1])}function w(t,e){const n=d.intersection(t,e),i=[];return n.forEach(n=>{const o=Math.min(r.count(t,t=>t===n),r.count(e,t=>t===n));l.times(o,()=>i.push(n))}),i}function b(t,e,n){const r=i.commonPrefixLength(t,e);return n(t.substr(r))-n(e.substr(r))}function M(t){const e=o.compactBlanks(h.toS(t).split(/[^\d]+/));return r.sortBy(e,t=>-t.length)[0]}function P(t,e){const[n,i]=[t,e].map(M).map(t=>o.blank(t)?"":t);return b(n,i,t=>l.toInt(t,{defaultValue:0}))}e.levenshtein=v,e.diceCoeff=y,e.bigrams=S,e.nonUniqIntersection=w,e.lnsDiff=P;const x=/[^0-9a-z]+/gi;function E(t,e){const[n,i]=[t,e].map(t=>h.toS(t).replace(x,"").toLowerCase());return b(n,i,t=>u.RadixAlphaNum.decode(t))}e.radixDiff=E,e.str=function(t,e){return{pref:i.commonPrefixLength(t,e),lev:v(t,e),ham:p(t,e),dice:y(t,e),lns:P(t,e),radixDiff:E(t,e)}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(35),r=n(157),o=n(9),s=n(105),a=n(2),u=n(7),l=750;e.PushProgressObserver=class{constructor(t,e){this.context=t,this.total=e,this.start=Date.now(),this.emit=s.throttle(()=>{r.emitProgressEvt(Object.assign({},this.context,{pct:u.sigFigs(100*this.current/this.total,3),elapsedMs:Date.now()-this.start}))},l,!0)}onProgress(t){this.current=u.clamp(0,this.total,t),this.emit()}};e.PullProgressObserver=class{constructor(t,e,n){this.ctx=t,this.total=e,this.progress=n,this.start=Date.now(),this.onInterval=s.throttle(()=>a.thenMap(this.progress(),t=>this.emit(t)),l),this.timer=i.setInterval(()=>this.onInterval(),l)}observe(t){return t.then(()=>this.completed()).catch(()=>this.end()),t}emit(t){o.map(t,t=>r.emitProgressEvt(Object.assign({},this.ctx,{pct:100*u.clamp(0,this.total,t)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>l&&this.emit(this.total),this.end()}end(){o.map(this.timer,t=>i.clearInterval(t)),this.timer=void 0}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.throttle=function(t,e,n=!1){let i=n?Date.now()+e:0,r=0;const o=()=>{const n=Date.now();return n>=i?(i=n+e,r++,t()):void 0};return o.count=()=>r,o}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(43),r=n(30),o=n(22),s=n(3),a=n(0);function u(t){const e=[];for(;t!==r.dirname(t);)t=r.dirname(t),e.push(t);return e}function l(t){try{return i.readdirSync(t)}catch(t){return[]}}function c(t,e){const n=l(t);return e.every(t=>n.includes(t))}function d(t,e){return u(t).find(t=>c(t,e))}e.execDir=s.lazy(()=>r.dirname(process.execPath)),e.ancestors=u,e.childrenSync=l,e.hasChildren=c,e.ancestorWithChildren=d,function(t){function n(e){return s.lazy(()=>r.join(t.Root(),e))}t.Root=s.lazy(()=>{const t=["migrations","public","tools","views"];return a.firstThunk(()=>[r.join(e.execDir(),"resources"),r.join(e.execDir(),"..","Resources"),e.execDir(),process.cwd()].find(e=>c(e,t)),()=>d(o.cwd(),t),()=>{throw new Error("Failed to find project root.")})}),t.Migrations=n("migrations"),t.Public=n("public"),t.Tools=n("tools"),t.Views=n("views")}(e.ProjectPath||(e.ProjectPath={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0),r=n(100),o=n(5),s=n(6),a=n(18);function u(t){return s.map(t,t=>i.orElse(t.name,a.toS(t)))}function l(t){return t.map(u)}function c(t){return l(t).join(e.sep).toLowerCase()}function d(t,e){const n=new Set(o.compact(e).map(t=>c(t)));return o.compact(t).filter(t=>!n.has(c(t)))}function h(t){return u(o.toA(t)[0])}function f(t){return new Set(o.compact(o.toA(t).map(h)))}e.sep=String.fromCharCode(31),e.When="When",e.Camera="Camera",e.Keywords="Keywords",e.Roots=[{name:e.When,ordinal:1},{name:e.Camera,ordinal:5},{name:e.Keywords,ordinal:7}],e.tagRefToS=u,e.tagPathToStringArray=l,e.joinTagPath=function(t,n=e.sep){return l(t).join(n)},e.tagPathEql=function(t,e){return null!=t&&null!=e&&c(t)===c(e)},e.tagDiff=d,e.tagDeltas=function(t,e,n=!0){const i=d(e,t),o=d(t,e),s=n?r.diff(f(o),f(i)):new Set;return{add:i,remove:o.filter(t=>!s.has(h(t)))}}},,function(t,e){t.exports=require("url")},,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),o=n(6),s=n(15),a=n(3),u=n(77),l=n(2),c=n(20),d=n(34),h=n(1),f=n(23),p=n(13),m=n(112),g=n(24);e.isGioSupported=a.lazy(()=>i(this,void 0,void 0,function*(){if(!f.isLinux)return!1;try{return 0===(yield c.stdoutResult(e.GioCommand,["version"],{timeout:g.cmdTimeoutMs,ignoreStderr:!0})).code}catch(t){return!1}})),e.GioCommand="gio",e.GioMountMonitorArgs=["mount","--monitor","--anonymous"];const v=h.mkLogger("Gio.gioVolumes()");e.gioVolumes=a.lazy(()=>i(this,void 0,void 0,function*(){const t=yield function(){return i(this,void 0,void 0,function*(){return(yield e.isGioSupported())?l.thenFlatten(yield l.thenMap(e.mtabEntries(),t=>t.map(t=>d.BaseFile.for(t).clear().childDirectories()))):[]})}(),n=(yield l.thenFlatten(t.map(t=>i(this,void 0,void 0,function*(){const e=yield m.dfPosixRaw(!1,t.nativePath).catch(e=>{v.warn("Failed to df "+t+": "+e)}),n=o.map(e,t=>t[0]);return o.map(n,e=>e.mountpoint=t.nativePath),n})))).filter(t=>t.size>0);return Promise.all(n.map(t=>i(this,void 0,void 0,function*(){return l.thenMapOr(S(t.mountpoint),e=>(t.remoteHost=e.remoteHost,t.remoteShare=e.remoteShare,t.label=e.displayName,t.remote=!0,t),()=>t)})))}),g.dfTtlMs);const y=h.mkLogger("Gio.getRemoteInfo()"),S=u.memoize(t=>i(this,void 0,void 0,function*(){try{const n=(yield c.stdout(e.GioCommand,["info",t],{timeout:g.cmdTimeoutMs})).split(/[\n\r]+/),i=r.mapNotBlank(n.find(t=>t.startsWith("uri: ")),t=>new URL(p.stripPrefix(t,"uri: ")));return{displayName:o.map(n.find(t=>t.startsWith("display name: ")),t=>p.stripPrefix(t,"display name: ")),remoteHost:o.map(i,t=>t.hostname),remoteShare:s.Opt(i).flatMap(t=>t.pathname).flatMap(t=>p.stripPrefix(t,"/")).flatMap(t=>p.stripSuffix(t,"/")).flatMap(decodeURIComponent).filter(r.notBlank).get()}}catch(e){return void y.warn("gio info failed",{mountpoint:t,err:e})}}),g.dfTtlMs,1e3);e.mtabEntries=a.lazy(()=>i(this,void 0,void 0,function*(){return l.thenMap(d.BaseFile.for("/proc/mounts").readLines(),t=>t.filter(t=>t.startsWith("gvfsd-fuse ")).map(t=>t.split(" ")[1]))}),g.dfTtlMs)},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),o=n(18),s=n(20),a=n(68),u=n(7),l=n(23),c=n(210),d=n(24);function h(t){return 1024*u.toInt(t,{defaultValue:0})}const f=l.isMac?["devfs"]:["udev","tmpfs"],p=["/boot/efi"];e.dfPosixRaw=function(t,e){return i(this,void 0,void 0,function*(){const n=l.isMac?yield c.ignorableMacFilesystems():[],i=["-k","-P"];t&&i.push("-l"),r.notBlank(e)&&i.push(e);const u=yield s.stdout("df",i,{timeout:d.cmdTimeoutMs});return a.parseFixed(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],u).map(t=>({filesystem:t.Filesystem,size:h(t["1024-blocks"]),used:h(t.Used),available:h(t.Available),mountpoint:t["Mounted on"]})).filter(t=>{const e=o.toS(t.filesystem),i=o.toS(t.mountpoint);return r.notBlank(i)&&!p.includes(i)&&r.notBlank(e)&&!n.includes(e)&&!f.includes(e)})})}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(4),o=n(72),s=n(0),a=n(13),u=n(92),l=n(2);class c{constructor(t){this.apply=t}static lift(t){return new c(t)}static and(...t){return new c(e=>i(this,void 0,void 0,function*(){for(const n of t){const t=yield n.apply(e);if(!t)return t}return!0}))}static or(...t){return new c(e=>i(this,void 0,void 0,function*(){for(const n of t){const t=yield n.apply(e);if(t)return t}return!1}))}static andLogged(t,...e){return this.and(...r.flatMap(e,e=>s.entries(e).map(([e,n])=>n.asAsync().logged(t,e))))}static orLogged(t,...e){return this.or(...r.flatMap(e,e=>s.entries(e).map(([e,n])=>n.asAsync().logged(t,e))))}static andExplain(t,e){return i(this,void 0,void 0,function*(){const n=[],i=[];for(const r of e)for(const[e,o]of s.entries(r))((yield o.apply(t))?n:i).push(e);return{accepted:n,rejected:i}})}asAsync(){return this}and(...t){return c.and(this,...t)}not(){return c.lift(t=>this.apply(t).then(t=>!t))}or(t){return new c(e=>i(this,void 0,void 0,function*(){return(yield this.apply(e))||(yield t.apply(e))}))}filter(t){return i(this,void 0,void 0,function*(){return u.filter(t,t=>this.apply(t))})}logged(t,e){return new c(n=>l.thenTap(this.apply(n),i=>{t.log(i?"debug":"info",[o.grey(e),i?o.green("ACCEPT"):o.red("REJECT"),a.ellipsize(n)].join(" "))}))}}e.AsyncFilter=c},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(230),r=n(48),o=n(7),s=n(0);function a(t,e){return o.within(-90,90,t)&&o.within(-180,180,e)&&0!==t&&0!==e}function u(t,e,n=50){return a(t,e)?i.bitZip({dims:[{min:-180,value:e,max:180},{min:-90,value:t,max:90}],bitDepth:n}):void 0}function l(t,e=52){return s.map(i.bitUnzip(t,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:e}),t=>t.reverse())}e.validLatLon=a,e.geohash=function(t,e,n=52){return s.map(u(t,e,n),t=>r.GeoRadix.encode(t))},e.geohash_num=u,e.ungeohash=function(t,e=52){return s.map(r.GeoRadix.decode(t),t=>l(t,e))},e.ungeohash_num=l},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(17),r=n(123),o=n(56),s=n(0);e.extractRotation=function(t){return s.firstThunk(()=>u(t.Orientation),()=>u(t.CameraOrientation),()=>i.toInt(t.Rotation))};const a=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function u(t){return s.map(t,t=>a.get(t))}e.orientationToRotation=u;const l=new Map([[0,1],[90,6],[180,3],[270,8]]);function c(t){return s.map(t,t=>l.get(t))}e.rotationToExifOrientation=c,e.extractSizeInfo=function(t,e){if(!i.gte0(t.ImageHeight)||!i.gte0(t.ImageWidth))return;const n=o.maybeFlip({width:t.ImageWidth,height:t.ImageHeight},e),r=i.sigFigs(n.width/n.height,5);return{ImageHeight:n.height,ImageWidth:n.width,aspectRatio:r,dimensions:n,fileDimensions:{width:t.ImageWidth,height:t.ImageHeight}}},e.isRotation=function(t){return i.isNumber(t)&&[0,90,180,270].includes(t)},e.rotationToWriteTag=function(t,e){return s.map(r.normalizeRotation(t),t=>e.startsWith("video/")?{Rotation:t}:s.map(c(t),t=>({"Orientation#":t})))}},,,,,function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(127),r=n(42),o=n(15),s=n(10),a=n(72),u=n(12),l=n(19),c=n(89);e.OnlyMessages={formatLogEntry:t=>t.msg,format:(t,e,n,i)=>n};const d=[{re:/sync-file/,f:i.default.bgCyan},{re:/sync/,f:i.default.bgBlue},{re:/web/,f:i.default.bgGreen},{re:/db/,f:i.default.bgMagenta},{re:/main/,f:i.default.bgRed}];class h{constructor(t={}){this.chalkedLevels=new Map,this.inspectOptions=Object.assign(h.defaultInspectOptions(),t),u.Settings.logColor.valueOrDefault?(i.default.enabled=!0,i.default.level=1):(this.inspectOptions.colors=!1,i.default.enabled=!1),u.isTest&&(this.inspectOptions.breakLength=255),this.chalkedLevels.set("error",a.red("error")),this.chalkedLevels.set("warn",a.yellow("warn ")),this.chalkedLevels.set("info",a.green("info ")),this.chalkedLevels.set("debug",a.blue("debug")),this.prefix=o.Opt(t.prefix).flatMap(t=>o.Opt(d.find(e=>null!=t.match(e.re))).map(e=>e.f(a.black(t))).getOrElse(()=>t)).getOrElse(()=>"")}formatLogEntry(t){return s.compactBlanks([a.grey(new Date(t.timestamp).toISOString()),this.chalkedLevels.get(t.level),a.blue(t.context),t.msg,f(t.meta,this.inspectOptions)]).map(t=>l.toS(t)).join(" ")}format(t,e,n,i){const r=c.logFilter().highlight(e)?a.yellow:a.blue;return s.compactBlanks([a.grey((new Date).toISOString()),this.prefix,this.chalkedLevels.get(t),r(e),n,f(i,this.inspectOptions)]).map(t=>l.toS(t)).join(" ")}}function f(t,e){return null==t?t:r.inspect(t,e)}h.defaultInspectOptions=()=>({showHidden:!1,depth:4,compact:!0,colors:!0,customInspect:!0,maxArrayLength:25}),e.ColoredLogFormatter=h,e.DefaultLogFormatter=new h},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),o=n(32),s=`\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n\nMoving or deleting any files here will cause problems using your library.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v${n(64).version}`;function a(t){return r.mapNotBlank(t,t=>o.PosixFile.for(t).join(".photostructure"))}e.libraryDataDir=a,e.setupLibraryDataDir=function(t){return i(this,void 0,void 0,function*(){const e=a(t);if(null==e)throw new Error("empty dataDir");if(null==(yield e.mkdirp()))throw new Error("Could not mkdirp "+e);yield e.mkNoMedia();const n=e.join("README.txt");if((yield n.size())!==s.length&&!(yield n.writeTxt(s)))throw new Error("Could not write README to "+e);return e})}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(45),o=n(55),s=n(6),a=n(2),u=n(25),l=n(23),c=n(13),d=n(34),h=n(106);function f(...t){return i(this,void 0,void 0,function*(){l.isWin&&t.push(c.ensureSuffix(t.pop(),".exe"));const e=s.map(h.ProjectPath.Tools(),t=>d.BaseFile.for(t));if(null==e||(yield e.isNotDirectory()))throw new Error("Cannot find project path for tools"+u.FatalErrorFlag);function n(n){return e.join(l.platformName+"-"+n,...t)}return a.firstTruePromise(t=>s.map(t,t=>t.exists()),()=>n(r.arch()),()=>"x64"===r.arch()?n("ia32"):void 0,()=>{throw new Error("Cannot find path to tool "+t)})})}e.toolFile=f,e.dcrawNativePath=o.lazy(()=>f("dcraw","dcraw").then(t=>t.nativePath)),e.jpegtranNativePath=o.lazy(()=>f("jpegtran","jpegtran").then(t=>t.nativePath)),e.sqliteNativePath=o.lazy(()=>f("sqlite3","sqlite3").then(t=>t.nativePath))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6);function r(t){return i.map(t,t=>t+360*Math.ceil(-t/360))}e.normalizeRotation=r,e.flippable=function(t){const e=r(t);return 90===e||270===e}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(242),o=n(5),s=n(8),a=n(46),u=n(6),l=n(9),c=n(15),d=n(18),h=n(39),f=n(4),p=n(2),m=n(34),g=n(139),v=n(1),y=n(13),S=n(64),w=n(121),b=n(138),M=n(12),P=v.mkLogger("SettingsIO");e.systemSettingsFile=()=>m.BaseFile.for(h.App.getPath("userData")).join("settings.toml"),e.librarySettingsFile=t=>c.Opt(t).filter(s.notBlank).orElse(()=>M.Settings.libraryPath.value).filter(s.notBlank).flatMap(t=>w.libraryDataDir(t)).map(t=>t.join("settings.toml")).get(),e.libraryTxtFile=()=>m.BaseFile.for(h.App.getPath("userData")).join("library.txt"),e.readSystemSettings=function(){return i(this,void 0,void 0,function*(){const t=yield p.thenOrElse(I(e.systemSettingsFile()),()=>[]);return s.blank(M.Settings.libraryPath.value)&&s.notBlank(yield function(){return i(this,void 0,void 0,function*(){if(!M.Settings.libraryPath.hasValue()){const t=e.libraryTxtFile().clear();if(yield t.isNonEmpty()){const e=d.toS(yield t.readFile());if(s.notBlank(e))return P.info("Importing old library.txt file",{priorPath:e,libraryTxt:t}),M.Settings.libraryPath.value=e,(yield k())&&(yield t.renameWithNameSuffix("-obsolete")),e}}})}())&&o.pushUniq(t,M.Settings.libraryPath),t})},e.savedLibraryPath=function(){return p.thenMap(F(e.systemSettingsFile()),t=>t[M.Settings.libraryPath.name])},e.systemSettingsVersion=function(){return i(this,void 0,void 0,function*(){return E(e.systemSettingsFile())})},e.librarySettingsVersion=function(){return i(this,void 0,void 0,function*(){return u.map(e.librarySettingsFile(),t=>E(t))})};const x=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;function E(t){return i(this,void 0,void 0,function*(){return p.thenMap(t.firstMatchingLine(x),t=>t[1])})}const _={maxLineLen:78,prefix:"# "};function T(t,e){return i(this,void 0,void 0,function*(){const n=yield t.clear().isNonEmpty(),r=n?yield t.wip():t;P.info("maybeWriteFile(): writing settings",{file:t});const s=yield function(t,e){return i(this,void 0,void 0,function*(){const n=f.flatten(["","Hello!","","These are settings for PhotoStructure, and are formatted using TOML. See <https://github.com/toml-lang/toml>.","","NOTE: Please shut down PhotoStructure before editing this file.","",'Most settings have reasonable defaults, which are provided after the description. Remove the "#" from the beginning of the line to override the default.',"","Visit <https://support.photostructure.com> or email <mailto:hello@photostructure.com>.","","-- ","","PhotoStructure v"+S.version,""].map(t=>y.wrap(t,_)));e.forEach(t=>{n.push("","",...y.wrap(t.opts.description,_),"# (env: "+t.key+")");const e=t.addToJSON();if(o.isNotEmpty(l.keys(e))&&n.push("# "+JSON.stringify(e)),n.push("#"),t.defaultValue!==t.value){const e={};e[t.name]=t.defaultValue,n.push(...O(e).map(t=>"# "+t))}if(t.hasValue()){const e={};e[t.name]=t.valueOrDefault,n.push(...O(e))}});try{return t.writeTxt("\n"+n.map(t=>t.trimRight()).join("\n")+"\n\n")}catch(e){return P.error("Failed to write "+t+": "+e),!1}})}(r,e);return s&&n&&((yield p.thenNot(a.eqlAsync(F(r),F(t))))&&(P.info("Archiving prior, different contents",{dest:r,file:t}),yield t.renameYMD()),yield r.unwip()),s})}function O(t){return g.splitLines(...l.entries(t).map(([t,e])=>(null==e?"# ":"")+t+" = "+JSON.stringify(e,void 0,2)))}function k(){return T(e.systemSettingsFile(),M.persistedSystemSettings())}function F(t){return i(this,void 0,void 0,function*(){return p.thenMap(t.readFile(),t=>r.parse(y.dumbquote(t.toString())))})}function I(t){return i(this,void 0,void 0,function*(){const e=v.mkLogger("FileSettings.importFileSettings("+t.baseWithGrandparent+")");try{e.debug("ENV before",M.psenv());const n=yield F(t);if(null==n){if(yield t.isNonEmpty())throw new Error("Failed to read "+t);return[]}const i=new Map(l.entries(M.Settings).filter(([,t])=>t instanceof b.Setting&&t.opts.persisted)),r=o.compact(l.keys(n).map(t=>{const r=n[t],o=i.get(t);return null==o?e.warn("Failed to import",{key:t}):o.hasValue()?e.debug("deferring to ENV",{key:t,tomlValue:r,currentValue:o.value}):o.value=r,o}));return e.info("loaded",{file:t.baseWithGrandparent,envAfter:M.psenv()}),r}catch(t){return void e.error("Cannot read",t)}})}e.stringify=O,e.writeSystemSettings=k,e.readLibrarySettings=function(t){return i(this,void 0,void 0,function*(){return u.map(e.librarySettingsFile(t),t=>I(t))})},e.writeLibrarySettings=function(t){return i(this,void 0,void 0,function*(){return yield w.setupLibraryDataDir(s.firstNotBlank(t,M.Settings.libraryPath.value)),u.map(e.librarySettingsFile(t),t=>T(t,M.persistedLibrarySettings()))})}},,function(t,e){t.exports=require("sharp")},function(t,e){t.exports=require("chalk")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(45),r=n(30),o=n(22),s=n(8),a=n(69);e.appData=function(){const t=a.getEnv("APPDATA");if(s.notBlank(t))return r.resolve(t);switch(i.platform()){case"win32":return r.resolve(i.homedir(),"AppData","Roaming");case"darwin":return r.resolve(i.homedir(),"Library","Application Support");case"linux":return s.firstNotBlank(o.env.XDG_DATA_HOME,o.env.XDG_CONFIG_HOME,r.resolve(i.homedir(),".config"));default:throw new Error("Platform not supported")}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AppName="PhotoStructure"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(17),r=n(7);e.BoundedList=class{constructor(t){if(this.maxLength=t,this._length=0,this._firstIndex=0,t>1e3)throw new Error("BoundedList.maxLength of "+t);this.store=new Array(...r.times(t,()=>null))}mapIndex(t,e){return t<0||t>this._length-1?void 0:e((t+this._firstIndex+this.maxLength)%this.maxLength)}get(t){return this.mapIndex(t,t=>this.store[t])}set(t,e){return this.mapIndex(t,t=>this.store[t]=e)}get length(){return this._length}set length(t){this._length=i.clamp(0,this._length,t)}[Symbol.iterator](){const t=this;return function*(){for(let e=0;e<t.length;e++)yield t.mapIndex(e,e=>t.store[e])}()}push(...t){for(const e of t)this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,t=>{this.store[t]=e});return this._length}pop(){return this.mapIndex(this._length-1,t=>(this._length--,this.store[t]))}unshift(...t){for(const e of t.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,t=>{this.store[t]=e,this._firstIndex=t});return this._length}shift(){return this.mapIndex(0,t=>(this._firstIndex++,this._length--,this.store[t]))}every(t){for(let e=0;e<this._length;e++)if(!t(this.get(e),e))return!1;return!0}some(t){for(let e=0;e<this._length;e++)if(t(this.get(e),e))return!0;return!1}forEach(t){for(let e=0;e<this._length;e++)t(this.get(e),e)}map(t){const e=[];for(let n=0;n<this._length;n++)e.push(t(this.get(n),n));return e}reduce(t,e){let n=e;for(let e=0;e<this._length;e++)n=t(n,this.get(e),e);return n}reverse(){for(let t=0;t<Math.floor(this._length/2);t++)this.mapIndex(t,e=>{this.mapIndex(this._length-1-t,t=>{const n=this.store[t];this.store[t]=this.store[e],this.store[e]=n})});return this}toA(){return[...this]}slice(t,e){return[...this].slice(t,e)}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(4),r=n(67),o=n(0),s=n(27);e.CountingSet=class{constructor(){this.m=new Map}incr(t,e=1){const n=this.get(t)+e;return 0===n?this.m.delete(t):this.m.set(t,n),this}get(t){return o.orElse(this.m.get(t),()=>0)}has(t){return this.m.has(t)}get size(){return this.m.size}keys(){return this.m.keys()}entries(){return this.m.entries()}entriesByCountDesc(){return i.sortBy([...this.entries()],([,t])=>-t)}top(t=1){return this.entriesByCountDesc().slice(0,t)}get averageCounts(){return s.tap(new r.Average(this.size),t=>[...this.m.values()].forEach(e=>t.push(e)))}forEach(t){this.m.forEach(t)}clear(){this.m.clear()}get toS(){return i.sort([...this.keys()]).map(t=>t+" "+this.get(t)).join("\n")}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(87),r=n(22),o=n(16),s=n(6),a=n(18),u=n(21),l=n(14),c=n(1),d=n(81);class h{constructor(t,e){this.name=t,this.bc=e}get ended(){return this.bc.ended}end(){return this.bc.end()}}e.observeBatchCluster=function(t,e,n=u.EndableRanks.service){const f=c.mkLogger(e);return i.setLogger(f),u.addEndable(n,new h(e,t)),t.on("childStart",n=>d.addPid({pid:n.pid,ppid:r.pid,cmd:e,maxAgeMs:t.options.maxProcAgeMillis+o.minuteMs},new Date)),t.on("startError",t=>{l.emitFatal("Failed to start "+e,t)}),t.on("taskError",(t,n)=>{if(!a.toS(t).includes("end() called when not idle")&&!u.ending()){const i=s.map(n,t=>t.command);f.warn("observeBatchCluster.taskError()",{error:t,cmd:i}),l.emitNonFatal(e+" failed to run "+i,t)}}),t.on("internalError",t=>{f.warn("observeBatchCluster.internalError()",t),l.emitNonFatal("Internal error from "+e,t)}),t.on("endError",t=>{f.warn("observeBatchCluster.endError()",t),f.error("Failed to shut down: "+t)}),t}},function(t,e){t.exports=require("crypto")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(9),o=n(3),s=n(89),a=n(120),u=n(101);class l{constructor(t,e=[["error",console.error]]){this.logFilter=t,this.loggers=r.fromEntries(e)}log(t,e,n,i){(this.loggers[t]||console.log)(a.DefaultLogFormatter.format(t,e,n,i))}enabled(t,e){return this.logFilter.enabled(t,e)}flush(){return i(this,void 0,void 0,function*(){})}close(){}}l.instance=o.lazy(()=>new l(s.logFilter())),e.ConsoleLogger=l,e.mkConsoleLogger=function(t){return new u.ContextualLogger(t,()=>l.instance())}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(213),o=n(109),s=n(78),a=n(4),u=n(3),l=n(77),c=n(2),d=n(10),h=n(29),f=n(11),p=n(14),m=n(1),g=n(158),v=n(13),y=n(27),S=n(19),w=n(74),b=n(34),M=n(52),P=n(28),x=n(32),E=u.lazy(()=>m.mkLogger("FileURI")),_=["http:","https:","file:",s.PS_LOCAL_FILE_PROTOCOL,s.PS_NETWORK_FILESYSTEM_PROTOCOL,s.OLD_PS_LOCAL_FILE_PROTOCOL].map(t=>t+"//");function T(t,n){return i(this,void 0,void 0,function*(){if(h.truthy(t.remote)){if(d.notBlank(t.remoteHost)&&d.notBlank(t.remoteShare)){const e=encodeURI(n.posixPathFrom(x.PosixFile.for(t.mountpoint)));return{protocol:s.PS_NETWORK_FILESYSTEM_PROTOCOL,hostname:r.toASCII(yield g.friendlyname(t.remoteHost)),pathname:r.toASCII(t.remoteShare)+(d.blank(e)?e:"/"+e),slashes:!0,volume:t}}}else if(d.notBlank(t.uuid))return{protocol:s.PS_LOCAL_FILE_PROTOCOL,hostname:e.volsha(t.uuid),pathname:encodeURI(n.posixPathFrom(x.PosixFile.for(t.mountpoint))),slashes:!0,volume:t}})}e.isUri=function(t){const e=S.toS(t).toLowerCase();return _.some(t=>e.startsWith(t))},e.FileToFileUri=t=>{if(null==t||d.blank(t.posixPath))return;const e=S.toS(t.hostname),n={pathname:encodeURI(v.stripPrefix(t.posixPath,"//"+e)),protocol:"file:",slashes:!0};return d.notBlank(e)&&(n.hostname=r.toASCII(e)),n},e.volsha=l.memoize(t=>y.tap(d.mapNotBlank(t,M.shortStringSha),e=>E().debug("volsha",{uuid:t,ea:e})),1*f.hourMs,128),p.onClearCache(()=>e.volsha.clear()),e.volumeURI=T,e.FileToPsUri=t=>{const e=x.PosixFile.for(P.posix2native(t.posixPath));return c.thenMap(w.volumeFor(e.nativePath),t=>T(t,e))};const O=[e.FileToPsUri,e.FileToFileUri];function k(t){return i(this,void 0,void 0,function*(){if(null!=t&&!d.blank(t.posixPath))return c.firstAsync(O,e=>e(t)).catch(e=>{E().warn("file2voluri failed",{file:t,err:e})})})}e.addUriFormatter=function(t){O.unshift(t),a.uniqInPlace(O)},e.file2fileuri=function(t){return o.format(e.FileToFileUri(t))},e.nativePath2uriString=function(t){return c.thenMap(k({posixPath:P.native2posix(t)}),o.format)},e.file2voluri=k,e.uriToString=function(t){if(null==t||"string"==typeof t)return t;try{return o.format(t)}catch(e){return void E().warn("toString failed",{uri:t,err:e})}};const F=/^[a-z]+:\/\/([a-z0-9-\.]+?)(?:\/(.+)?)?$/i;e.PsfileUriToFile=(t,n)=>i(this,void 0,void 0,function*(){if(null==t||d.blank(n))return;if(!v.equalsIgnoreCase(t.protocol,s.PS_LOCAL_FILE_PROTOCOL)&&!v.equalsIgnoreCase(t.protocol,s.OLD_PS_LOCAL_FILE_PROTOCOL))return;const i=yield w.volumes();if(a.isEmpty(i))return void E().warn("PsfileUriToFile(): volumes() was empty: Can't resolve "+n);const r=n.match(F);if(null==r)return void E().warn("PsfileUriToFile(): didn't match regex",{raw:n});const o=r[1];if(d.blank(o))return void E().warn("PsfileUriToFile(): no volsha",{raw:n});const u=v.stripSuffix(decodeURI(S.toS(r[2])),"/").split("/"),l=i.find(t=>!t.remote&&d.notBlank(t.uuid)&&o===e.volsha(t.uuid));if(null!=l)return{posixPath:b.BaseFile.for(l.mountpoint).join(...u).posixPath};{const t=i.filter(t=>null!=t.uuid).map(t=>e.volsha(t.uuid));E().warn("PsfileUriToFile(): no volume had matching volsha",{raw:n,volid:o,volshas:t})}}),e.PsnetUriToFile=t=>i(this,void 0,void 0,function*(){if(null==t)return;if(!v.equalsIgnoreCase(t.protocol,s.PS_NETWORK_FILESYSTEM_PROTOCOL))return;if(d.blank(t.pathname)||d.blank(t.hostname))return;const e=r.toUnicode(S.toS(t.hostname)),n=v.stripPrefix(S.toS(t.pathname),"/").split("/"),i=r.toUnicode(n.shift());if(d.blank(i))return;const o=n.map(decodeURIComponent);return c.thenMap(w.remoteVolumeFor(e,i),t=>({posixPath:b.BaseFile.for(t.mountpoint).join(...o).posixPath}))}),e.FileUriToFile=t=>{if(null==t)return;if(!v.equalsIgnoreCase(t.protocol,"file:")||d.blank(t.pathname))return;const e=decodeURI(S.toS(t.hostname)),n=decodeURI(S.toS(t.pathname));return d.notBlank(e)?{hostname:e,posixPath:n}:{posixPath:null!=n.match(/^\/[A-Z]:\//i)?n.substring(1):n}};const I=[e.PsfileUriToFile,e.PsnetUriToFile,e.FileUriToFile];e.addUriParser=function(t){I.unshift(t),a.uniqInPlace(I)},e.uri2file=function(t,e){return i(this,void 0,void 0,function*(){if(d.blank(t))return;const n=function(t){try{return o.parse(t,!1,!0)}catch(e){return void E().warn("bad URI",{uri:t,err:e})}}(t);return null!=n?c.firstAsync(I,e=>e(n,t)).catch(i=>{if(E().warn("uri2file failed",{uri:t,err:i}),d.notBlank(e)&&null!=n.pathname){const t=n.pathname.split("/").slice(1);return{posixPath:x.PosixFile.for(e).join(...t).posixPath}}}):void 0})},e.toUrl=function(t){if(null!=t){if("string"!=typeof t&&[t.protocol,t.pathname,t.hostname].every(d.notBlank))return t;try{return o.parse(S.toS(t),!0)}catch(e){return void E().warn("toUrl failed",{uri:t,err:e})}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(42),r=n(4),o=n(3),s=n(7),a=n(12),u=n(56),l=n(231);class c{constructor(t,e,n,i,r=!0){this.name=t,this.maxWidth=e,this.maxHeight=n,this.reducer=i,this.rotational=r,this.megapixels=o.lazy(()=>s.megapixels(this.maxWidth*this.maxHeight)),this.max={width:e,height:n},c._Sizes.push(this)}static sq(){return this._Sizes.filter(t=>t.reducer===l.Square)}static largestSq(){return r.greatestBy(this.sq(),t=>t.megapixels())}static fit(){const t=a.Settings.previewResolutions.valueOrDefault;return this._Sizes.filter(e=>e.reducer===l.Fit&&t.includes(e.name))}static largestFit(){return r.greatestBy(this.fit(),t=>t.megapixels())}[i.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"x"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(t){return this.reducer.reduce(this.rotational&&u.isPortrait(t)?u.flip(this.max):this.max,t)}resize(t,e){return e=e.resize(Object.assign({},t,{fit:this.reducer.fit,withoutEnlargement:!0}))}toJpeg({path:t,sh:e,outputSize:n}){return(u.dmegapixels(n)<2||a.Settings.sharpen.valueOrDefault)&&(e=e.sharpen()),e.jpeg({quality:85,progressive:a.Settings.progressive.valueOrDefault}).toFile(t)}toString(){return this.name}}c._Sizes=[],c.UHD8k=new c("uhd8k",7680,4320,l.Fit,!1),c.UHD5k=new c("uhd5k",5120,2880,l.Fit,!1),c.UHD=new c("uhd4k",4096,2160,l.Fit),c.QHD=new c("qhd",3120,1440,l.Fit),c.FHD=new c("fhd",1920,1080,l.Fit),c.HD=new c("hd",1280,720,l.Fit),c.WVGA=new c("wvga",720,480,l.Fit),c.QVGA=new c("qvga",320,240,l.Fit),c.QQVGA=new c("qqvga",160,120,l.Fit),c.S480=new c("s480",480,480,l.Square),c.S240=new c("s240",240,240,l.Square),c.S120=new c("s120",120,120,l.Square),c.S60=new c("s60",60,60,l.Square),e.ImageSize=c},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(8),o=n(15),s=n(235),a=n(13),u=n(49),l=n(28);function c(t){const e=new Set(i.compactBlanks(t.map(t=>a.ensurePrefix(t.toLowerCase().normalize(),"."))));return s.Filter.lift(t=>o.Opt(t).flatMap(t=>r.firstNotBlank(t.ext,t.base)).map(t=>e.has(t.toLowerCase().normalize())).getOrElse(()=>!1))}e.excludedPathFilter=function(t){const e=new Set(t.map(t=>t.toLowerCase()));return s.Filter.lift(t=>l.pathnames(t.nativePath).every(t=>!e.has(t.toLowerCase())))},e.extFilter=c,e.browserImgExtFilter=c(u.browserImgExts),e.browserExtFilter=c(u.browserExts),e.videoExtFilter=c(u.VideoExts)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(30),r=n(22),o=n(5),s=n(8),a=n(46),u=n(6),l=n(17),c=n(9),d=n(41),h=n(15),f=n(33),p=n(18),m=n(29),g=n(0);e.SettingCategories=f.strEnum("System","Logging","Updates","ErrorReporting","Tools","Web","Sync","Filters"),e.LibraryCategories=Object.freeze([e.SettingCategories.Web,e.SettingCategories.Sync,e.SettingCategories.Filters]),e.SystemCategories=Object.freeze(f.strEnumValues(e.SettingCategories).filter(t=>!e.LibraryCategories.includes(t)));class v{constructor(t){this.opts=t,this.listeners=[],v.instances.push(this),this.readFromEnv(),this.addToChildProcs=!0===t.addToChildProcs}static importSavedPref(t){return s.mapNotBlank(t.key,e=>u.map(this.instances.find(t=>t.key===e),e=>g.Try(()=>c.tap(e,e=>e.value=t.value))))}readFromEnv(){if(!this.hasValue())return h.Opt(r.env[this.opts.key]).filter(s.notBlank).orElse(()=>h.Opt(this.opts.alternateKeys).map(t=>t.map(t=>r.env[t])).flatMap(t=>t.find(s.notBlank))).flatMap(this.opts.fromEnv).map(t=>this.value=t).get()}addListener(t){this.listeners.push(t),this.hasValue()&&setImmediate(()=>t(this.value))}removeListener(t){o.filterInPlace(this.listeners,e=>e===t)}onChange(){const t=this.value;this.listeners.forEach(e=>e(t))}get name(){return this.opts.name}get key(){return this.opts.key}get category(){return this.opts.category}get persisted(){return this.opts.persisted}get advanced(){return g.orElse(this.opts.advanced,!0)}get value(){return this._value}set value(t){const e=this._value;this._value=this.opts.fromEnv(this.opts.toEnv(t)),a.eql(e,this._value)||this.onChange()}set valueFromFile(t){this.value!==this.defaultValue&&(this.value=t)}get defaultValue(){return d.isFunction(this.opts.defaultValue)?this.opts.defaultValue():this.opts.defaultValue}get valueOrDefault(){return g.orElse(this.value,this.defaultValue)}addToEnv(t,e){const n=g.orElse(t,r.env);return n[this.opts.key]=y(this.opts.toEnv(g.orElse(e,this.valueOrDefault))),n}deleteFromEnv(t){const e=g.orElse(t,r.env);return delete e[this.opts.key],u.map(this.opts.alternateKeys,t=>t.forEach(t=>{delete e[t]})),e}hasValue(){return null!=this.value}clear(){return this._value=void 0,this.onChange(),this}addToJSON(){return{}}toJSON(){return{key:this.opts.key,value:this.value,defaultValue:this.opts.defaultValue,description:this.opts.description}}}v.instances=[],e.Setting=v;const y=t=>s.notBlank(t)&&"undefined"!==t?p.toS(t).trim():void 0;function S(t,e){const n=p.toS(t).toLowerCase();return e.find(t=>t.toLowerCase()===n)}e.StringSetting=class extends v{constructor(t){super(Object.assign({toEnv:y,fromEnv:y},t))}hasValue(){return s.notBlank(this.value)}};e.StringEnumSetting=class extends v{constructor(t){if(super(Object.assign({toEnv:e=>S(e,t.validValues),fromEnv:e=>S(e,t.validValues)},t)),this.validValues=t.validValues,!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${t.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}};e.StringArraySetting=class extends v{constructor(t){super(Object.assign({defaultValue:[],fromEnv:t=>s.mapNotBlank(t,t=>{try{return o.compactBlankish(o.toA(JSON.parse(t)))}catch(e){return o.compactBlankish(t.split(i.delimiter))}}),toEnv:t=>u.map(t,t=>JSON.stringify(o.uniq(t)))},t))}get values(){return o.uniq(o.compactBlanks(this.valueOrDefault))}push(...t){this.value=o.uniq(o.compactBlanks(this.valueOrDefault.concat(...t)))}removeValue(t){u.map(this.value,e=>this.value=e.filter(e=>e!==t))}};e.StringEnumsSetting=class extends v{constructor(t){super(Object.assign({defaultValue:t.defaultValue,fromEnv:t=>s.mapNotBlank(t,t=>{try{return this.asValidValues(JSON.parse(t))}catch(e){return this.asValidValues(t.split(i.delimiter))}}),toEnv:t=>u.map(t,t=>JSON.stringify(o.uniq(t)))},t)),this.validValues=t.validValues}asValidValues(t){return o.compactBlankish(o.toA(t).map(t=>S(p.toS(t),this.validValues)))}addToJSON(){return{validValues:this.validValues}}};e.IntegerSetting=class extends v{constructor(t){super(Object.assign({},t,{toEnv:y,fromEnv:l.toInt}))}};e.BoundedIntegerSetting=class extends v{constructor(t){super(Object.assign({},t,{toEnv:y,fromEnv:e=>h.Opt(e).flatMap(parseInt).map(e=>l.clamp(t.min,t.max,e)).get()})),this.options=t}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};e.BooleanSetting=class extends v{constructor(t){super(Object.assign({},t,{toEnv:y,fromEnv:m.toBoolean}))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(4),r=n(23);e.crlf=function(t){const n=t.trim()+"\n";return r.isWin?n.replace(e.newlineRe,"\r\n"):n},e.newlineRe=/\r?\n/gm,e.splitLines=function(...t){return i.flatten(t.map(t=>t.split(e.newlineRe)))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(30),o=n(8),s=n(16),a=n(55),u=n(17),l=n(2),c=n(29),d=n(63),h=n(11),f=n(14),p=n(1),m=n(34),g=n(148),v=n(28),y=/^\.?NoMedia$/i;function S(t){return null!=y.exec(t)}e.isNoMediaName=S,f.onClearCache(()=>b.clear()),f.onFileChanged(t=>{if(o.blank(t))b.clear();else for(const e of b.keys())e.startsWith(t)&&b.delete(e)});const w=15*s.secondMs,b=new d.BoundedMap(3*s.minuteMs,2e3,!1),M=a.lazy(()=>p.mkLogger("hasNoMedia()"));e.hasNoMedia=function t(e){return i(this,void 0,void 0,function*(){if(e instanceof m.BaseFile)return t(yield e.directoryEntry());if(g.pathIsNeverIgnored(e.nativePath))return M().debug(e+" is never ignoed"),!1;if(S(e.base))return M().debug(e+" basename is NoMedia"),!0;const n=v.pathnames(e.nativePath);if(n.some(S))return M().debug(e+" parent path is NoMedia"),!0;for(let t=n.length-1;t>0;t--){const i=n.slice(0,t).join(r.sep),o=b.get(i);if(!0===o)return M().debug(e+" ancestor is NoMedia, "+i),!0;if(!1!==o&&u.isNumber(o)&&(yield l.until(()=>c.isBoolean(b.get(i)),w))&&!0===b.get(i))return M().debug(e+" ancestor is NoMedia, "+i),!0}const i=b.get(e.nativePath);if(c.isBoolean(i))return M().debug(e+" returning cached result, "+i),i;const o=yield e.isDirectory();if(o){if(null!=i&&h.recentMs(i,w)&&(M().debug(e+" is a work-in-progress. Waiting for prior result."),yield l.until(()=>c.isBoolean(b.get(e.nativePath)),w)))return t(e);M().debug(e+" has no cached result, I'll do it.");const n=Date.now();b.set(e.nativePath,n);const r=yield e.children();if(null==r)return M().debug(e+" is a directory but has no children.",{result:!1}),b.set(e.nativePath,!1),!1;if(r.some(t=>S(t.base)))return M().debug(e+" is a directory and has a noMedia child",{result:!0}),b.set(e.nativePath,!0),!0}const s=yield e.parent();if(null==s||e.nativePath===s.nativePath)return M().debug(e+" root",{result:!1}),b.set(e.nativePath,!1),!1;{M().debug(e+" deferring to parent");const n=yield t(s);return M().debug(e+" got result from parent",{result:n}),o&&b.set(e.nativePath,n),M().debug(e+" from parent",{result:n}),n}})}},,,,,function(t,e){t.exports=require("readline")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(33);e.FitSizes=i.strEnum("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),e.FitSizeValues=i.strEnumValues(e.FitSizes),e.SqSizes=i.strEnum("s480","s240","s120","s60"),e.SqWidths=[60,120,240,480]},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(35),r=n(17);function o(t){return s(t,!1)}function s(t,e){return new Promise(n=>{if(t<=0)n();else{const r=i.setTimeout(()=>n(),Math.round(t+1));e&&r.unref()}})}e.unrefDelay=function(t){return s(t,!0)},e.delay=o,e.delayUntil=function(t){const e=(r.gt0(t)?t:t.getTime())-Date.now();if(e<0){if(e>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-e+"ms")}return o(e).then(()=>e)},e.later=function(t,e=1){return i.setTimeout(t,Math.max(1,Math.round(e)))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(18),o=n(3),s=n(14),a=n(12),u=o.lazy(()=>{a.Settings.neverIgnored.addListener(()=>{l.clear(),s.emitFileChanged()}),a.Settings.scanPaths.addListener(()=>{l.clear(),s.emitFileChanged()}),s.onClearCache(()=>l.clear())}),l=o.lazy(()=>(u(),new Set(i.compactBlanks([...a.Settings.scanPaths.values,...a.Settings.neverIgnored.values]))));function c(t){return l().has(t)||l().has(t.toLowerCase().normalize())}e.pathIsNeverIgnored=c,e.neverIgnore=function(...t){a.Settings.neverIgnored.push(...i.compactBlanks(t.map(r.toS)))},e.pathIsNeverIgnoredPredicate=function(t){return c(t)?{pathIsNeverIgnored:()=>!1}:void 0}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(16),o=n(2),s=n(20),a=n(14),u=n(122),l=n(23),c=n(115),d=n(75),h=l.isWin?"NUL":"/dev/null";function f(t,e,n){return i(this,void 0,void 0,function*(){const i=yield u.jpegtranNativePath();if(!c.isRotation(n))throw new Error("refusing to rotate("+t+", "+n+")");yield s.stdout(i,["-copy","all","-trim","-rotate",n.toFixed(0),"-outfile",e.nativePath,t.nativePath],{timeout:r.minuteMs})})}e.validJpeg=function(t){return i(this,void 0,void 0,function*(){const e=yield u.jpegtranNativePath();yield s.stdoutResult(e,["-outfile",h,t.nativePath],{timeout:30*r.secondMs})})},e.rotateInPlace=function(t,e){return i(this,void 0,void 0,function*(){const n=t.wip();yield f(t,n,e),yield n.unwip(),a.emitFileChanged(t.nativePath)})},e.rotate=f,e.rotateToImgTmp=function(t,e){return i(this,void 0,void 0,function*(){return null==e||0===e?t:o.thenMap(d.tmpImgFile(t,"r"+e,t.ext),n=>n.applyIfEmpty(n=>f(t,n,e)))})}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(30),o=n(8),s=n(16),a=n(15),u=n(44),l=n(4),c=n(2),d=n(10),h=n(98),f=n(137),p=n(26),m=n(1),g=n(0),v=n(103),y=n(27),S=n(19),w=n(82),b=n(31),M=n(49),P=m.mkLogger("TagInference"),x=m.mkLogger("TagInference.inferMakeAndModel()");e.inferMakeAndModel=function(t,e){return i(this,void 0,void 0,function*(){if(P.debug("inferMakeAndModel("+t+")",{Make:e.Make,Model:e.Model}),o.notBlank(e.Make)&&o.notBlank(e.Model))return;if(d.blank(e.Make)&&(S.toS(e.HandlerDescription)+S.toS(e.CompressorName)).includes("GoPro"))return void(e.Make="GoPro");const n=F(t),{younger:i,older:r}=yield L(t),s=l.compact(l.flatten(l.zip(i,r))).slice(0,50).filter(t=>v.diceCoeff(F(t),n)>.7).slice(0,10);P.info("inferMakeAndModel("+t+"): looking at nearby siblings",s.map(t=>t.base));for(const n of s){const i=yield b.readRawTags(n);if(null!=i&&l.allNotBlank(i.Make,i.Model))return x.info("Inferring Make and Model",{file:t.nativePath,sibling:n.base,Make:i.Make,Model:i.Model}),e.Make=i.Make,void(e.Model=i.Model)}})};const E=m.mkLogger("TagInference.inferCapturedAtFromSiblings()");function _(t,e=7){return i(this,void 0,void 0,function*(){return c.firstAsync(t.slice(0,e),(t,e)=>c.thenMap(b.readRawTags(t),t=>c.thenMap(w.capturedAtFromTags(t),t=>({d:t,index:e}))))})}e.inferCapturedAtFromSiblings=function(t){return i(this,void 0,void 0,function*(){return c.thenMap(function(t){return T.getOrSet(t.nativePath,()=>i(this,void 0,void 0,function*(){const{younger:e,older:n}=yield L(t),i=yield _(e),r=yield _(n);if(null!=i&&null!=r)return{before:i.d,after:r.d,index:i.index,slots:i.index+r.index+1}}))}(t),({before:e,after:n,index:r,slots:o})=>i(this,void 0,void 0,function*(){if(p.sameDay(e,n))return y.tap(h.DateInterval.for(e,n,r,o),e=>E.info("inferring date",{file:t.nativePath,result:S.toS(e)}));E.debug("rejecting, not same day",{file:t.nativePath,before:S.toS(e),after:S.toS(n)})}))})};const T=new u.TTLMap(2*s.minuteMs);const O=/^(?:(?:mvimg|img|vid|mov|gp|gf|p|gopr)(?:[-_ ]|(?=\d)))?(\S.+)$/i,k=/[\d_]{4,}$/;function F(t){return I(t.nameWithoutCount)}function I(t){return d.blank(t)?"":a.Opt(g.Try(()=>r.posix.parse(t))).flatMap(t=>t.name).flatMap(t=>a.Opt(k.exec(t.replace(/_cover$/i,""))).flatMap(t=>t[0]).orElse(()=>a.Opt(O.exec(t)).flatMap(t=>t[1]))).getOrElse(()=>t).replace(/^[\s-_]*/,"").replace(/[\s-_]*$/,"").toLowerCase().normalize()}e.bname=F,e.bnameString=I;const D=f.extFilter(M.AllExifExts),C=new u.TTLMap(2*s.minuteMs);function L(t,e=7){return i(this,void 0,void 0,function*(){return C.getOrSet(t.nativePath,()=>i(this,void 0,void 0,function*(){const n=F(t),i=(yield t.siblings()).filter(t=>D.apply(t)&&!M.isSidecarExt(t.ext)&&v.diceCoeff(F(t),n)>.7),r=l.sortBy(i,t=>F(t)),[o,s]=l.partition(r,t=>F(t)<n);return o.reverse(),{younger:o.slice(0,e),older:s.slice(0,e)}}))})}function A(t){return i(this,void 0,void 0,function*(){const{younger:e,older:n}=yield L(t),r=l.flatZip(e,n).slice(0,10),o=yield c.thenMap(function(t,e=7){return i(this,void 0,void 0,function*(){return c.firstAsync(t.slice(0,e),(t,e)=>c.thenMap(b.readRawTags(t),t=>c.thenMap(w.capturedAtFromTags(t),t=>a.Opt(t).filter(t=>p.hasZoneOffset(t)).flatMap(t=>p.getZoneName(t)).map(t=>({zoneName:t,index:e})).get())))})}(r),t=>t.zoneName);return P.info("nearestSiblingTzOffset()",{f:t.baseWithGrandparent,result:o}),o})}e.nearestSiblings=L,e.nearestSiblingTzOffset=A,e.extractStatname=function(t){return i(this,void 0,void 0,function*(){const e=p.parseDated(F(t));if(!p.hasTime(e))return;const n=yield t.stat(),i=p.datedToMillis(e);return null!=n&&null!=i&&[n.birthtimeMs,n.atimeMs,n.mtimeMs,n.ctimeMs].some(t=>Math.abs(t-i)<30*s.minuteMs)?y.tap(p.toDateTime(e,yield A(t)),e=>P.info("extractStatname()",{f:t.baseWithGrandparent,result:e})):void 0})}},,,,,,,function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(8),r=n(17),o=n(7),s=n(14);function a(t){return null!=t&&i.notBlank(t.path)&&i.notBlank(t.op)&&o.within(0,100,t.pct)}e.isProgressEvt=a;const u="progress";e.emitProgressEvt=function(t){a(t)&&s.eventEmitter.emit(u,Object.assign({},t,{pct:r.sigFigs(r.clamp(0,100,t.pct),2)}))},e.onProgressEvt=function(t){s.eventEmitter.on(u,t)},e.removeProgressEvtListener=function(t){return s.eventEmitter.removeListener(u,t)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(214),o=n(42),s=n(8),a=n(16),u=n(17),l=n(18),c=n(77),d=n(2),h=n(11),f=n(14),p=n(1),m=n(7),g=n(215),v=new RegExp("^"+g.ipv4Re.source+"$");e.friendlyname=c.memoize(t=>i(this,void 0,void 0,function*(){const n=null==v.exec(t)?t:yield e.nslookup(t);return l.toS(n).toLowerCase().normalize()}),10*h.minuteMs,128);const y=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function S(t){return null!=y.exec(t)}function w(t){const e=t.split(".").map(t=>u.toInt(t)).filter(t=>m.within(0,255,t));return 4===e.length?e:void 0}e.isLoopback=S,e.octets=w;const b=o.promisify(r.reverse),M=o.promisify(r.resolve4),P=p.mkLogger("nslookup");e.nslookup=c.memoize(t=>i(this,void 0,void 0,function*(){try{const e=yield d.thenOrTimeout(()=>S(t)?t.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=w(t)?b(t):M(t),10*a.secondMs);if(null==e)return P.info("nslookup("+t+"): timeout"),t;const n=e.find(s.notBlank);return null==n?(P.warn("No name found for "+t),t):n}catch(e){return P.warn("Failed to look up "+t+", using name.",e),t}}),10*h.minuteMs,256),f.onClearCache(()=>e.nslookup.clear())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),o=n(6),s=n(15),a=n(4),u=n(53),l=n(2),c=n(20),d=n(11),h=n(14),f=n(68),p=n(60),m=n(38),g=n(0),v=n(23),y=n(47),S=n(13),w=n(19),b=n(40),M=n(24);e.addRemoteVolumeInfoWin=function(t,e){return i(this,void 0,void 0,function*(){if(!v.isWin)throw new Error("wtf");return yield l.thenMap(o.orElse(e,()=>k()),e=>{const n=m.toMap(e,t=>[t.mountpoint,t]);t.forEach(t=>{g.map(n.get(t.mountpoint),e=>{t.remote=!0,t.remoteHost=e.host,t.remoteShare=e.share,t.remoteOK=e.ok})})}),t})};const P=["LocalName","RemoteName","Status"],x=["NETUSE","get",P.join(",")],E=/^\\\\(.+?)\\(.+)$/,_=/^[a-z]:\\?$/i;function T(t){if(!r.blank(t))return s.Opt(t).flatMap(t=>E.exec(t)).map(t=>({host:t[1],share:t[2]})).orElse(()=>s.Opt(t).flatMap(t=>g.Try(()=>new URL(t))).filter(t=>r.notBlank(t.hostname)).map(t=>({host:t.hostname,share:s.Opt(t.pathname).filter(r.notBlank).getOrElse(()=>"/")}))).get()}function O(){return i(this,void 0,void 0,function*(){const t=p.wmic(),e=yield c.stdout(t,x,{timeout:15*d.secondMs}),n=f.parseFixed(P,e);return a.compact(n.map(t=>g.map(E.exec(w.toS(t.RemoteName)),e=>g.map(_.exec(w.toS(t.LocalName)),n=>({mountpoint:S.ensureSuffix(n[0],"\\"),host:e[1],share:e[2],ok:"OK"===t.Status})))))})}e.NetInfoCmd="Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status",e.parseRemoteName=T,e._netInfoWinWmic=O;const k=u.keyedLazy("netInfoWin",b.mountsCacheKey,function(){return i(this,void 0,void 0,function*(){const t=yield y.PowerShell.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return null==t?O():a.compact(t.filter(t=>r.notBlank(t.LocalName)).map(t=>g.map(T(t.RemoteName),({host:e,share:n})=>g.map(_.exec(w.toS(t.LocalName)),i=>({mountpoint:S.ensureSuffix(i[0],"\\"),host:e,share:n,ok:"OK"===t.Status&&"Connected"===t.ConnectionState})))))})},{maxRetries:2,timeoutMs:M.cmdTimeoutMs,priorResultTtlMs:M.longTtlMs});h.onClearCache(()=>k.clear())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(16),o=n(17),s=n(15),a=n(20),u=n(23),l=n(47);e.hidden=function(t){return!!t.base.startsWith(".")||(u.isWin?function(t){return i(this,void 0,void 0,function*(){const e=yield l.PowerShell.instance().executeJsonToA(`Get-Item -Force -LiteralPath '${t.nativePath}' -ErrorAction SilentlyContinue | Select-Object -Property Name, Mode`);return s.Opt(e).flatMap(t=>t[0]).flatMap(t=>t.Mode).flatMap(t=>t.includes("h")||t.includes("s")).getOrElse(()=>!1)})}(t):!!u.isMac&&function(t){return i(this,void 0,void 0,function*(){try{const e=yield a.stdout("stat",["-f","%f",t.nativePath],{timeout:10*r.secondMs}),n=o.toInt(e);return null!=n&&(32768&n)>0}catch(t){return!1}})}(t))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),o=n(39),s=n(4),a=n(3),u=n(2),l=n(10),c=n(69),d=n(224),h=n(1),f=n(23),p=n(225),m=n(12),g=n(40),v=n(160),y=n(148),S=n(140),w=n(28),b=n(226);function M(t){const e=t.nativePath.toLowerCase().normalize();return y.pathIsNeverIgnored(t.nativePath)||y.pathIsNeverIgnored(e)?{pathIsNeverIgnored:()=>!1}:Object.assign({},x(t.nativePath),{snapDirectory:()=>i(this,void 0,void 0,function*(){return f.isLinux&&(yield b.ignorableSnapDir.apply(t))}),noMedia:()=>S.hasNoMedia(t),hidden:()=>v.hidden(t),mountpoint:()=>i(this,void 0,void 0,function*(){return u.thenMapOr(g.mountpoints(),e=>e.includes(t.nativePath),()=>!1)})})}e.ignorablePredicates=function(t){return i(this,void 0,void 0,function*(){return(yield t.isDirectory())?M(t):x(t.nativePath)})},e.ignorableFile=function(t){return E(t.nativePath)},e.ignorableDirectory=function(t){return i(this,void 0,void 0,function*(){return d.orLoggedAsync([M(t)],h.mkLogger("ignorableDirectory("+t.nativePath+")"))})},e.ignorableDirectoryPredicates=M;const P=a.lazy(()=>new _);function x(t){return P().ignorablePathPredicates(t)}function E(t){return P().ignorablePath(t)}e.ignorablePathPredicates=x,e.ignorablePath=E;class _{constructor(t=m.isTest){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","var","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(t=>t.toLowerCase().normalize())),this.ignorableDirectories=new Set(["#recycle","@Recycle","@eaDir","@SynoResource","$Recycle.Bin","Application Data","Application Support","Applications","cache","caches","com.apple.TimeMachine.localsnapshots","cpan","cygwin","cygwin64","DefinitelyTyped","Desktop DB","Desktop DF","DisplayDriver","ehthumbs.db","lost+found","Network Trash Folder","node_modules","Program Files (x86)","Program Files","ProgramData","steamapps","spotifycache","System32","System Volume Information","Temporary Items","tmp","iTunes","iTunes Media","Thumbnails","Thumbs.db","Trash","Windows10Upgrade"].map(t=>t.toLowerCase().normalize())),this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/.*?\.photolibrary\/(?!Masters?\/)/i,/\/ImageMagick[\d\.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Smart Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d\.-]*(\/|$)/i,/\/Python[\d\.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d\.-]+(amd64|x64)?(\/|$)/i],this.systemDirs=s.uniq(l.compactBlanks([o.App.appData(),c.getEnv("APPDATA"),c.getEnv("SYSTEMROOT"),c.getEnv("ProgramFiles"),c.getEnv("ProgramFiles(x86)")]).map(t=>t.toLowerCase().normalize())),this.ignorableSubdirs=new p.SetSet,f.isLinux&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);const e=["bin","etc","games","include","lib","lib32","local","locale","man","sbin","share","src"];this.addIgnorableSubdirs("usr",e),this.addIgnorableSubdirs("local",e),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...e]),this.addIgnorableSubdirs("var",["cache","crash","lib","local","log","snap","spool","tmp"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("go",["bin","blog","doc","lib","misc","pkg","src","test"]);const n=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",n),this.addIgnorableSubdirs("Perl64",n),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),t||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(c.getEnv("APPDATA"),["local","locallow","roaming"])),t&&(this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"))}addIgnorableSubdirs(t,e){if(r.blank(t))return;const n=t.toLowerCase().normalize();l.compactBlanks(e).forEach(t=>this.ignorableSubdirs.add(n,t.toLowerCase().normalize()))}ignorablePathPredicates(t){const e=y.pathIsNeverIgnoredPredicate(t);if(null!=e)return e;const n=t.toLowerCase().normalize(),i=l.compactBlanks(w.pathnames(n));return{hiddenPosix:()=>i.some(t=>t.startsWith(".")),systemDir:()=>this.systemDirs.some(t=>n.startsWith(t)),ignorableRoot:()=>this.ignorableRootDirectories.has(i[0]),ignorableDirectory:()=>i.some(t=>this.ignorableDirectories.has(t)),ignorablePath:()=>this.ignorableSubdirs.has(i),ignorablePattern:()=>{const e=w.native2posix(t);return this.ignorableDirectoryPatterns.some(t=>t.test(e))}}}ignorablePath(t){return d.orLogged([this.ignorablePathPredicates(t)],h.mkLogger("FsAttrs("+t+")"))}}e.Ignorable=_},function(t,e,n){"use strict";function i(t,e,n=.5){return(1-n)*t+n*e}Object.defineProperty(e,"__esModule",{value:!0}),e.lerp=i,e.lerp2d=function(t,e,n){const r=e.x-t.x,o=(n-t.x)/r;return i(t.y,e.y,o)},e.lerp2d_=function(t,e,n){return(t.y*(e.x-n)+e.y*(n-t.x))/(e.x-t.x)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),o=n(6),s=n(59),a=n(2),u=n(176),l=n(1),c=n(0),d=n(31),h=n(49),f=n(27),p=n(19),m=n(56),g=n(168),v=n(75),y=n(149),S=n(86),w=l.mkLogger("SharpReadable");function b(t,e,n,r){return i(this,void 0,void 0,function*(){if("image/jpeg"!==e.mimetype||0===e.rotation)return c.map(e[n],()=>a.thenMap(P(t,n),e=>a.thenMap(d.dimensions(e),i=>f.tap(m.ltBoth(r,i)?e:void 0,o=>{w.debug("imgFromExif()",{src:t.baseWithGrandparent,img:e.nativePath,tag:n,dim:i,minDim:r,result:p.toS(o)})}))));w.debug("Rotated JPEG, don't trust the thumbnail",{src:t,rotated:e.rotation})})}function M(t,e,n){return i(this,void 0,void 0,function*(){if(!(yield S.isVlcSupported())||!S.vlcSupportedMimeType(e))return;const i=yield v.tmpImgFile(t,"frame",".jpg");if(null==i)throw new Error("Cannot make tmpImgFile");const r=yield t.mtimeMs();if(null==r)return void w.warn("sharpReadable("+t+"): null mtime");const o=yield i.stat();return null!=o&&o.mtimeMs>r&&o.size>5*s.KB&&(yield a.resolved(y.validJpeg(i)))?(w.info("sharpReadable("+t+"): prior dest, "+i+" seems reasonable"),i):(yield i.unlink("debug"),a.thenAnd(S.vlcFrame(t,i,n),()=>i))})}function P(t,e){return a.thenMap(v.tmpImgFile(t,e,".jpg"),n=>n.applyIfEmpty(n=>i(this,void 0,void 0,function*(){return d.extractBinaryTag(e,t.nativePath,n.nativePath)})))}e.imgFromExif=b,e.sharpReadable=function(t,e){return i(this,void 0,void 0,function*(){const n=yield d.readTags(t.nativePath),s=c.map(n,t=>t.mimetype);if(null==n||r.blank(s))throw new Error(t+" is not supported (missing mimetype)");const l=[];null!=e&&0===n.rotation&&l.push(...["ThumbnailImage","PhotoshopThumbnail","PreviewImage","JpgFromRaw"].map(i=>()=>b(t,n,i,e))),h.isSharpMimetype(s)&&l.push(()=>i(this,void 0,void 0,function*(){return t})),u.dcrawSupportedMimeTypes.has(s)&&l.push(()=>v.readableToFile(t,"dcraw",".tiff",()=>u.dcraw(t))),l.push(()=>M(t,s)),l.push(()=>i(this,void 0,void 0,function*(){return g.ffmpegSupportedMimeType(s)&&(yield g.isFFmpegSupported())?v.readableToFile(t,"frame",".jpg",()=>g.ffmpegFrame(t)):void 0})),null!=n.JpgFromRaw&&l.push(()=>P(t,"JpgFromRaw")),null!=n.PreviewImage&&l.push(()=>P(t,"PreviewImage"));const f=[],p=yield a.firstResolvedDefinedPromise(l,e=>{w.warn("strategy failed for "+t+": "+e),f.push(e)});if(null==p)throw o.orElse(f[0],new Error("Cannot read "+t));return p})},e.extractVideoFrame=M,e.extractImageForThumbs=P},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(4),o=n(2);e.emitSafely=function(t,e,n,s=1e3){return i(this,void 0,void 0,function*(){const i=yield o.until(()=>r.isNotEmpty(t.listeners(e)),s);return i&&t.emit(e,n),i})}},,,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(8),s=n(16),a=n(208),u=n(6),l=n(15),c=n(37),d=n(21),h=n(3),f=n(2),p=n(51),m=n(25),g=n(14),v=n(88),y=n(54),S=n(1),w=n(209),b=n(90),M=n(0),P=n(81),x=n(20);e.mkBasicWatchedChild=function(t,e,n){const i=new E({name:r.compact([t,...e]).join(" "),childFactory:()=>x.spawn(t,e,30*s.minuteMs),onError:()=>!0,ignoreStopErrors:!0,onStdout:a.debounce(()=>n(),1.5*s.secondMs),onRestartError:()=>c.delay(w.randomInt(s.secondMs,15*s.secondMs)).then(()=>{i.restart()})});return i};class E{constructor(t){this.logger=h.lazy(()=>S.mkLogger("WatchedChild("+r.compact([this.name,this.pid]).join(":")+")")),this.startRate=new b.Rate(2*s.minuteMs),this.mutex=new p.Promises,this._ended=!1,this.onError=(t,e)=>{const n={src:t,errToS:m.maybeErrorToS(e)};if(this.logger().info("onError()",n),!this._ended&&!m.isIgnorableError(e)&&this.opts.onError(t,e)){const i=m.asError(e);return g.emitNonFatal(this.name+":"+t,i),this.logger().warn("onError returned true, restarting",n),this.restart(this.name+":"+t,i)}},this.name=t.name,this.opts=Object.assign({dataSep:"\n",maxErrorsPerMinute:3,endTimeoutMs:10*s.secondMs,endableRank:d.EndableRanks.first,exitCommand:"",restartOnExit:!0},t),d.addEndable(this.opts.endableRank,this),this.restart()}get ended(){return this._ended}end(){return i(this,void 0,void 0,function*(){return this._ended=!0,this.stop()})}get proc(){return this.cp}get pid(){return u.map(this.cp,t=>t.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return u.mapOr(this.pid,t=>P.pidExists(t),()=>i(this,void 0,void 0,function*(){return!1}))}notRunning(){return f.thenNot(this.running())}stop(){return i(this,void 0,void 0,function*(){const t=this.cp;return this.cp=void 0,null==t||(this.logger().info("stop()"),this.stopChild(t))})}stopChild(t){return i(this,void 0,void 0,function*(){return yield l.Opt(this.opts.exitCommand).filter(o.notBlank).flatMap(e=>l.Opt(t).flatMap(t=>t.stdin).filter(t=>t.writable).forEach(t=>M.Try(()=>t.write(e+"\n"))).map(y.end).get()),x.endProcess(t,this.opts.endTimeoutMs)})}restartIfStopped(){return i(this,void 0,void 0,function*(){return!(yield this.notRunning())||this.restart()})}restart(t,e){return i(this,void 0,void 0,function*(){return this.mutex.maybeRun(`WatchedChild(${this.name}).restart`,()=>i(this,void 0,void 0,function*(){if(yield this.stop(),this._ended)return!1;if(this.startRate.eventsPerMinute>this.opts.maxErrorsPerMinute)return this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),u.map(this.opts.onRestartError,n=>n(t,e)),!1;this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),this.startRate.onEvent();const n=this.cp;if(null!=n&&!0!==(yield this.stopChild(n))&&(this.logger().info("restart(): failed to stop prior child",{prior:n}),!this.opts.ignoreStopErrors))return u.map(this.opts.onRestartError,n=>n(t,e)),!1;const i=this.cp=yield this.opts.childFactory();this.logger.clear();const r="cp("+i.pid+")";return[{o:i,desc:""},{o:i.stdin,desc:".stdin"},{o:i.stdout,desc:".stdout"},{o:i.stderr,desc:".stderr"}].forEach(({o:t,desc:e})=>{u.map(t,t=>t.on("error",t=>this.onError(r+e+".on(error)",t)))}),this.cp.stderr.on("data",t=>this.onError(r+".stderr.on(data)",t)),this.cp.on("exit",(t,e)=>{this.logger().info("onExit",{code:t,signal:e}),this.opts.restartOnExit?this.restart():(this.logger().info("onExit(): this.opts.restartOnExit is false, so we're done."),this.end())}),v.onDataChunked(this.cp.stdout,this.opts.dataSep,t=>{this.logger().debug("onDataChunked()",t),this.opts.onStdout(t)}),this.logger().info("restart(): spawned pid "+this.pid),!0}))})}}e.WatchedChild=E},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),o=n(16),s=n(6),a=n(17),u=n(15),l=n(18),c=n(44),d=n(36),h=n(3),f=n(2),p=n(20),m=n(164),g=n(1),v=n(7),y=n(0),S=n(12),w=n(31),b=n(24),M=n(75),P=n(93),x=g.mkLogger("ffmpeg"),E=/ffmpeg version (\S+)/i;function _(t){return i(this,void 0,void 0,function*(){return!!(yield e.isFFmpegSupported())&&f.thenMapOr(w.mimetype(t),T,()=>!1)})}function T(t){return l.toS(t).startsWith("video/")}function O(t,n=.3){return i(this,void 0,void 0,function*(){const i=yield w.readTags(t);return null==i?[]:u.Opt(a.toFloat(i.PosterTime)).filter(t=>0!==t).orElse(()=>u.Opt(a.toFloat(i.Duration)).filter(t=>0!==t).map(t=>Math.min(Math.round(t*n),e.MaxSS)).get()).map(t=>["-ss",t.toFixed()]).getOrElse(()=>[])})}e.ffmpegVersion=h.lazy(()=>i(this,void 0,void 0,function*(){try{const t=yield p.stdoutResult(S.Settings.ffmpegPath.valueOrDefault,["-version"],{timeout:b.cmdTimeoutMs,ignoreStderr:!0});return 0===t.code?s.map(E.exec(t.result),t=>t[1]):void 0}catch(t){return}})),e.isFFmpegSupported=h.lazy(()=>i(this,void 0,void 0,function*(){return r.notBlank(yield e.ffmpegVersion())})),e.ffmpegSupportedFile=_,e.ffmpegSupportedMimeType=T,e.MaxSS=10,e.ssFlag=O,e.ffmpegFrame=function(t){return i(this,void 0,void 0,function*(){if(!(yield _(t)))throw new Error(t+" is not supported");const e=o.minuteMs,n=yield p.execFile(yield S.Settings.ffmpegPath.valueOrDefault,["-loglevel","fatal","-i",t.nativePath,"-vframes","1",...yield O(t),"-f","singlejpeg","pipe:"],e,{timeout:e,maxBuffer:100*v.MiB}),r=e=>i(this,void 0,void 0,function*(){(yield m.emitSafely(n.stdout,"error","Problem from "+t+": "+e))||x.error("No listeners for error when reading "+t,e),n.kill("SIGINT")});return n.on("error",r),n.stderr.on("data",r),n.stdout})};const k=new c.TTLMap(10*o.minuteMs);e.transcode=function(t,e="mp4"){return k.getOrSet(t.nativePath+":"+e,()=>(function(t,e="mp4"){return i(this,void 0,void 0,function*(){const n=Date.now(),r=yield M.tmpImgFile(t,"vid",e);if(!(yield f.resolved(I(r))))return r;yield r.unlink();const o=r.wip("wip-");yield o.unlink();const s=["-loglevel","fatal","-i",t.nativePath,o.nativePath];x.info("transcode()",{args:s});const a=yield P.syncFileTimeoutForFile(t);if(null==a)throw new Error("Cannot transcode "+t+": timeout calc failed.");const u=yield p.execFile(S.Settings.ffmpegPath.valueOrDefault,s,a),l=new d.Deferred(`ffmpeg._transcode(${t})`),c=e=>i(this,void 0,void 0,function*(){x.warn("onErr("+t+"): "+e),l.reject(e),y.Try(()=>u.kill("SIGINT"))});return u.on("error",c),u.stderr.on("data",c),u.on("exit",(r,s)=>i(this,void 0,void 0,function*(){if(x.info("transcode()",{elapsedMs:Date.now()-n,code:r,signal:s,src:t,ext:e}),l.pending)if(0!==r)l.reject("ffmpeg failed with code "+r);else{const t=yield o.unwip("wip-");null==t?l.reject(new Error("null unwip for "+o)):l.resolve(t)}})),l.promise})})(t,e))};const F=[/invalid nal/i,/invalid data found/i];function I(t){return i(this,void 0,void 0,function*(){if(yield t.notExists())throw new Error(t+" doesn't exist");if(null==(yield t.size()))throw new Error("cannot read "+t);const e=yield p.execFile(S.Settings.ffmpegPath.valueOrDefault,["-v","error","-i",t.nativePath,"-f","null","-"],1*o.minuteMs),n=new d.Deferred(`ffmpegValidVideo(${t})`),r=r=>i(this,void 0,void 0,function*(){const i=l.toS(r);F.some(t=>null!=t.exec(i))?(x.warn("validVideo.onErr("+t+"): "+r),n.reject(r),y.Try(()=>e.kill("SIGINT"))):x.info("validVideo.onErr("+t+"): ignorable "+r)});return e.on("error",r),e.stdout.on("data",r),e.stderr.on("data",r),e.on("exit",t=>i(this,void 0,void 0,function*(){0===t?n.resolve():n.reject("non-zero exit code "+t)})),n.promise})}e.ffmpegValidVideo=I},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(126),o=n(44),s=n(2),a=n(11),u=n(7),l=n(31),c=n(49),d=new o.TTLMap(2*a.minuteMs);e.dimensions=function(t){return d.getOrSet(t.nativePath,()=>(function(t){return s.firstDefinedPromise(()=>s.thenMap(l.cachedTags(t),t=>t.dimensions),()=>(function(t){return i(this,void 0,void 0,function*(){return c.isSharpExt(t.ext)?s.thenMap(function(t){return r(t.nativePath).metadata()}(t),t=>{const e=[t.width,t.height];u.gt0(t.orientation)&&[5,6,7,8].includes(t.orientation)&&e.reverse();const[n,i]=e;return u.gt0(n)&&u.gt0(i)?{width:n,height:i}:void 0}):void 0})})(t),()=>l.dimensions(t.nativePath))})(t))}},,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(22),o=n(16),s=n(6),a=n(9),u=n(70),l=n(4),c=n(3),d=n(2),h=n(10),f=n(20),p=n(23),m=n(47),g=n(13);function v(t=r.env){return s.firstDefined(t.LC_ALL,t.LC_MESSAGES,t.LANG,t.LANGUAGE)}e.defaultLocale="en",e.locale=c.lazy(()=>i(this,void 0,void 0,function*(){return S(yield d.firstDefinedPromise(()=>v(),()=>p.isWin?w():void 0,()=>p.isMac?M():void 0,()=>p.isPosix?x():void 0))}));const y=/([a-z]+)(?:(?:[_-])([a-z]+))?/i;function S(t){if(h.blank(t)||g.equalsIgnoreCase("c",t)||g.equalsIgnoreCase("posix",t))return e.defaultLocale;{const n=y.exec(t);return null==n?e.defaultLocale:l.compact([n[1],n[2]]).join("-")}}function w(){return d.thenMap(m.PowerShell.instance().executeJson("GET-WinSystemLocale | Select-Object -Property Name"),t=>t.Name)}e.lc2locale=S,e.winLocale=w;const b={timeout:10*o.secondMs};function M(){return u.thenOpt(f.stdout("defaults",["read","-globalDomain","AppleLocale"],b)).flatMap(S).get()}e.macLocale=M;const P=/^([a-z_]+)\s*=\s*"(.+)"$/i;function x(){return u.thenOpt(f.stdout("locale",[],b)).flatMap(t=>t.split("\n").map(t=>s.map(t.match(P),t=>[t[1],t[2]]))).flatMap(a.fromEntries).flatMap(v).flatMap(S).get()}e.posixLocale=x},,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(43),o=n(99),s=n(30),a=n(5),u=n(6),l=n(2),c=n(13),d=n(28);class h{constructor(t,e){this.dir=t,this.nativePath=s.join(this.dir,e.name),this.ext=d.extname2(e.name),this.base=e.name,this.name=c.stripSuffix(this.base,this.ext),this._isFile=e.isFile(),this._isDirectory=e.isDirectory(),this._isSymbolicLink=e.isSymbolicLink()}static for(t){return i(this,void 0,void 0,function*(){const e=d.parse(t);return o.stat(t).then(t=>new h(e.dir,{name:e.base,isFile:t.isFile.bind(t),isDirectory:t.isDirectory.bind(t),isSymbolicLink:t.isSymbolicLink.bind(t)})).catch(()=>void 0)})}toString(){return this.nativePath}isFile(){return this._isFile}isDirectory(){return this._isDirectory}isSymbolicLink(){return this._isSymbolicLink}parent(){const t=d.parse(this.dir);return t.dir===this.dir?this:new h(t.dir,{name:t.base,isFile:function(){return!1},isDirectory:function(){return!0},isSymbolicLink:function(){return!1}})}children(){return this.isDirectory()?new Promise((t,e)=>{r.readdir(this.nativePath,{withFileTypes:!0},(n,i)=>{null!=n?e(n):t(u.map(i,t=>a.sortBy(t,t=>t.name.toLowerCase().normalize()).map(t=>new h(this.nativePath,t))))})}):void 0}stat(){return o.stat(this.nativePath).catch(()=>void 0)}size(){return i(this,void 0,void 0,function*(){return l.thenMap(this.stat(),t=>t.size)})}mtimeMs(){return i(this,void 0,void 0,function*(){return l.thenMap(this.stat(),t=>t.mtimeMs)})}}e.DirectoryEntry=h},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(43),o=n(35),s=n(6),a=n(21),u=n(51),l=n(50),c=n(11),d=n(54),h=n(12),f=n(134),p=n(89),m=n(120);e.CaptureLogger=class{constructor(){this.logEntries=[]}log(t,e,n,i){this.logEntries.push({timestamp:Date.now(),level:t,context:e,msg:n,meta:i})}enabled(){return!0}close(){}flush(){return i(this,void 0,void 0,function*(){})}};e.LogWriter=class{constructor(t,e,n={}){this.logdir=t,this.prefix=e,this.ended=!1,this.mutex=new u.Promises,this._linesSinceRotate=0,this.pendingWrites=[],this._startIndex=0,this.maybeFlush=()=>{this.mutex.maybeRun("maybeFlush",()=>this._flush())},this.shouldRotate=()=>null==this._stream||this._linesSinceRotate>=this.opts.maxLinesPerFile,this.flush=()=>this.mutex.serial("flush",()=>this._flush()),this.name="GzLogWriter("+t+")",this.opts=Object.assign({filter:p.logFilter(),maxLinesPerFile:25e4,logFormatter:new m.ColoredLogFormatter({prefix:e}),errorLogger:f.ConsoleLogger.instance(),flushEveryMs:500},n),this.flushInterval=l.setUnrefInterval(()=>this.maybeFlush(),this.opts.flushEveryMs),a.addLoggerEndable(this)}enabled(t,e){return this.opts.filter.enabled(t,e)}log(t,e,n,i){this.opts.filter.enabled(t,e)&&(this.ended&&p.levelIndex(t)<=1?this.opts.errorLogger.log(t,e,n,i):this.pendingWrites.push(this.opts.logFormatter.format(t,e,n,i)+"\n"))}end(){return i(this,void 0,void 0,function*(){return this.ended=!0,s.map(this.flushInterval,o.clearInterval),this.flushInterval=void 0,this.close()})}close(){return i(this,void 0,void 0,function*(){return yield this.flush(),this.mutex.serial("close",()=>this._closeCurrent())})}_flush(){return i(this,void 0,void 0,function*(){const t=[...this.pendingWrites];for(this.pendingWrites.length=0;t.length>0;){this.shouldRotate()&&(yield this._rotate());const e=this._stream;if(null==e)return void this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const n=this.opts.maxLinesPerFile-this._linesSinceRotate,i=t.splice(0,n);this._linesSinceRotate+=i.length,e.write(i.join(""))}})}errback(t){return e=>this.opts.errorLogger.log("error","Caught error from "+t,e)}_rotate(){return i(this,void 0,void 0,function*(){yield this._closeCurrent(),this._currentFile=yield this.logdir.join(c.datestamp(),this.prefix+".log").ensureNew({emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=r.createWriteStream(this._currentFile.nativePath).on("error",this.errback("file write stream"))})}_closeCurrent(){return i(this,void 0,void 0,function*(){yield s.map(this._stream,t=>d.end(t)),this._stream=void 0,this._linesSinceRotate=0,h.Settings.logCompression.valueOrDefault&&(yield s.map(this._currentFile,t=>t.gzip())),this._currentFile=void 0})}}},,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(43),o=n(16),s=n(59),a=n(36),u=n(2),l=n(20),c=n(25),d=n(164),h=n(104),f=n(54),p=n(122),m=n(1),g=n(31),v=n(136),y=n(75);e.dcrawSupportedMimeTypes=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-fuji-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);const S=m.mkLogger("dcraw");function w(t){return g.isMimetype(t.nativePath,e.dcrawSupportedMimeTypes)}e.rawToTiff=function(t,e,n){return i(this,void 0,void 0,function*(){try{const i=yield M(t,n);if(null==i)return;const o=yield u.firstDefinedPromise(()=>e,()=>y.tmpImgFile(t,"dcraw",".tiff")),s=new a.Deferred(`rawToTiff(${t})`),l=r.createWriteStream(o.nativePath);return l.on("finish",()=>s.resolve(o)),yield f.pipelinePromise([i,l]),s.promise}catch(e){return void S.warn("Failed to read "+t.nativePath,e)}})},e.dcrawSupported=w;const b=v.ImageSize.UHD5k.megapixels();function M(t,e=b){return i(this,void 0,void 0,function*(){if(!(yield w(t)))throw new Error(t+" is unsupported");const n=Date.now(),r=yield g.readTags(t.nativePath),a=null!=r.Megapixels&&r.Megapixels>2*e?["-h"]:["-q","2"],u=yield p.dcrawNativePath(),f=["-T","-c","-H","2","-w","-o","1",...a,t.nativePath],m=2*o.minuteMs,v={encoding:"buffer",timeout:m,maxBuffer:250*s.MB};S.debug("dcraw()",{cmd:u,args:f,opts:v});const y=yield l.execFile(u,f,m,v),b=e=>i(this,void 0,void 0,function*(){(yield d.emitSafely(y.stdout,"error","Problem from "+t+": "+c.cleanError(e,t.nativePath)))||S.error("No listeners for error when reading "+t,e),y.kill("SIGINT")});y.on("error",b),y.stderr.on("data",b);const M=new h.PullProgressObserver({path:t.nativePath,op:"raw image conversion"},30*o.secondMs,()=>Date.now()-n);return y.on("close",()=>M.end()),y.stdout})}e.dcraw=M},,function(t,e){("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"0.6.0-alpha.1+20190821062758"}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isIterable=function(t){return null!=t&&"string"!=typeof t&&"function"==typeof t[Symbol.iterator]}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(41);e.isList=function(t){return null!=t&&(Array.isArray(t)||isFinite(t.length)&&i.isFunction(t[Symbol.iterator])&&i.isFunction(t.push)&&i.isFunction(t.pop)&&i.isFunction(t.forEach)&&i.isFunction(t.some))}},function(t,e){t.exports=require("he")},function(t,e){t.exports=require("events")},function(t,e){t.exports=require("zlib")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(41);e.asPromise=function(t){return i(this,void 0,void 0,function*(){return r.isFunction(t)?t():t})}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(27);e.MRUMap=class{constructor(t=1e3,e=!1){if(this.maxSize=t,this.fifo=e,this.delegate=new Map,this.expireListeners=[],t<1)throw new Error("maxSize must be positive")}get size(){return this.delegate.size}clear(){return this.delegate.clear(),this}delete(t){return this.delegate.delete(t)}entries(){return this.delegate.entries()}forEach(t){this.delegate.forEach(t)}get(t){if(this.delegate.has(t)){const e=this.delegate.get(t);return this.fifo||(this.delegate.delete(t),this.delegate.set(t,e)),e}}getOrSet(t,e){return this.delegate.has(t)?this.get(t):i.tap(e(),e=>this.set(t,e))}has(t){return this.delegate.has(t)}keys(){return this.delegate.keys()}set(t,e){return this.delegate.set(t,e),this.vacuum(),this}values(){return this.delegate.values()}[Symbol.iterator](){return this.entries()}on(t,e){this.expireListeners.push(e)}vacuum(){if(this.delegate.size>this.maxSize)for(const[t,e]of this.delegate)if(this.delegate.delete(t),this.expireListeners.forEach(n=>n(t,e)),this.delegate.size<=this.maxSize)return}}},function(t,e){t.exports=require("child_process")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(22),o=n(5),s=n(4),a=n(21),u=n(3),l=n(2),c=n(10),d=n(20),h=n(11),f=n(68),p=n(60),m=n(1),g=n(7),v=n(0),y=n(23),S=n(47),w=n(19),b=u.lazy(()=>m.mkLogger("Ps"));function M(t){return null!=t&&g.gt0(t.pid)&&null!=t.start&&c.notBlank(t.cmd)}function P(t){return i(this,void 0,void 0,function*(){const e=o.toA(t).filter(g.gt0);if(o.isEmpty(e))throw new Error("Invalid pids: "+JSON.stringify(t));return l.thenTap(l.thenMap(y.isWin?function(t){return i(this,void 0,void 0,function*(){if(a.ending()||S.PowerShell.instance().ended)return F(t);const e=[E,"-Id",T(t),"-ErrorAction SilentlyContinue",_].join(" ");return l.thenMap(S.PowerShell.instance().executeJsonToA(e),t=>x(t))})}(e):function(t){return i(this,void 0,void 0,function*(){return I((yield d.stdoutResult("ps",["-p",T(t),"-wwwo","pid,lstart,command"],Object.assign({},O,{ignoreExitCode:!0}))).result)})}(e),t=>t.filter(t=>M(t)&&e.includes(t.pid))),t=>b().debug("pidInfo()",{pids:e,result:t}))})}function x(t){return t.map(t=>({pid:t.Id,start:h.pwshJsonDate(t.StartTime),cmd:t.ProcessName}))}e.ps=function(){return i(this,void 0,void 0,function*(){const t=yield y.isWin?function(){return i(this,void 0,void 0,function*(){if(a.ending()||S.PowerShell.instance().ended)return F();const t=yield S.PowerShell.instance().executeJsonToA([E,_].join(" "));return null==t?F():x(t)})}():function(){return i(this,void 0,void 0,function*(){return I(yield d.stdout("ps",["-ewwwo","pid,lstart,command"],O))})}();return v.orElse(s.sortBy(t.filter(M),t=>t.pid),[])})},e.pidInfo=function(t){return i(this,void 0,void 0,function*(){return l.thenMap(P([t]),e=>o.toA(e).find(e=>e.pid===t))})},e.pidInfos=P;const E="Get-Process",_="| Select-Object -Property Id,ProcessName,StartTime";function T(t){return o.uniq([...t.filter(g.gt0),r.pid]).join(",")}const O={maxBuffer:1048576,timeout:15*h.secondMs,ignoreExitCode:!0,ignoreStderr:!0},k=["CommandLine","CreationDate","ProcessId"];function F(t){return i(this,void 0,void 0,function*(){const e=["process"];if(o.isNotEmpty(t)){const n=o.uniq([...t.filter(g.gt0),r.pid]).map(t=>`ProcessId=${t}`).join(" or ");e.push("where",n)}e.push("get",k.join(","));const n=yield d.stdoutResult(p.wmic(),e,O);return v.onlyReqValued(f.parseFixed(k,n.result).map(t=>({pid:g.toInt(t.ProcessId,{defaultValue:-1}),start:h.wmiDate(t.CreationDate),cmd:w.toS(t.CommandLine)})))})}function I(t){return f.parseFixed(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],t).map(t=>({pid:g.toInt(t.PID,{defaultValue:-1}),start:new Date(t.STARTED),cmd:w.toS(t.COMMAND)}))}e.psWinWmic=F},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(36),r=n(96);e.WritableToBuffer=class extends r.Duplex{constructor(t){super(t),this.deferred=new i.Deferred("WritableToBuffer"),this._buf=[],this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",t=>{this.deferred.reject(t)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_read(){}_write(t,e,n){const i=Buffer.isBuffer(t)?t:Buffer.from(t,e);this._buf.push(i),n()}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});e.CompoundLogger=class{constructor(t,...e){if(this.primary=t,null==t)throw new Error("null primary logger");this.delegates=[t,...e]}enabled(t,e){return this.primary.enabled(t,e)}log(t,e,n,i){this.enabled(t,e)&&this.delegates.forEach(r=>r.log(t,e,n,i))}flush(){return i(this,void 0,void 0,function*(){yield Promise.all(this.delegates.map(t=>t.flush()))})}close(){this.delegates.forEach(t=>t.close())}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(7);e.TTLArray=class{constructor(t,e){this.ttlMs=t,this.maxLength=e,this.times=[],this.a=[]}push(...t){i.times(t.length,()=>this.times.push(Date.now())),this.a.push(...t),null!=this.maxLength&&this.vacuum()}pushUniq(...t){t.forEach(t=>{this.includes(t)||this.push(t)})}includes(t){return this.vacuum(),this.a.indexOf(t)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;if(null!=this.maxLength){const t=this.a.length-this.maxLength;this.times.splice(0,t),this.a.splice(0,t)}const t=Date.now()-this.ttlMs,e=this.times.findIndex(e=>e>t);-1===e?this.clear():e>0&&(this.times.splice(0,e),this.a.splice(0,e))}}},,,,,,,,,,,,,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(4),o=n(3),s=n(26),a=n(171),u=n(7),l=n(0),c=n(82),d=n(31),h=n(19),f=n(70),p=n(107),m=o.lazy(()=>i(this,void 0,void 0,function*(){return new Intl.DateTimeFormat(yield a.locale(),{month:"short"})})),g=o.lazy(()=>i(this,void 0,void 0,function*(){const t=yield m();return r.range(0,12,e=>t.format(new Date(2016,e)))}));function v(t){return 1e4-t}function y(t){return{name:h.toS(t),ordinal:v(t)}}function S(t){return i(this,void 0,void 0,function*(){if(u.within(1,12,t))return l.map((yield g())[t-1],e=>({name:e,ordinal:w(t)}))})}function w(t){return 13-t}function b(t){return i(this,void 0,void 0,function*(){const e=[p.When];return f.thenOpt(s.getYear(t)).forEach(t=>e.push(y(t))).flatMap(()=>S(s.getMonth(t))).forEach(t=>e.push(t)).map(()=>e).get()})}e.yearToOrdinal=v,e.yearTagRef=y,e.monthTagRef=S,e.monthToOrdinal=w,e.dateTag=b,e.dateTagFile=function(t,e=[]){return i(this,void 0,void 0,function*(){return f.thenOpt(d.readTags(t)).flatMap(t=>c.bestCapturedAt([t.capturedAt,...e])).flatMap(t=>b(t.date)).get()})}},,,,function(t,e){t.exports=require("source-map-support")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6);e.debounce=function(t,e){let n;const r=()=>{i.map(n,global.clearTimeout),n=global.setTimeout(()=>t(),e)};return r.reset=()=>{i.map(n,global.clearTimeout),n=void 0},r.now=()=>{r.reset(),t()},r}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(85);e.randomInt=i.randomInt,e.randomFloat=i.randomFloat,e.RandomChars=i.RandomChars,e.randomChars=i.randomChars,e.randomChar=i.randomChar,e.pickRandom=i.pickRandom,e.shuffle=i.shuffle,e.sample=i.sample},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(46),s=n(6),a=n(3),u=n(2),l=n(20),c=n(34),d=n(24),h=/^([a-z0-9\/ -_]+) on (.+?) \((.+)\)$/i;function f(){return i(this,void 0,void 0,function*(){const t=yield l.stdout("mount",[],{timeout:d.cmdTimeoutMs});return r.compact(t.split("\n").map(t=>s.map(h.exec(t),t=>{const[e,n,i]=t.slice(1);return{filesystem:e,mountpoint:n,options:i.split(",").map(t=>t.trim())}})))})}function p(t){return i(this,void 0,void 0,function*(){const e=c.BaseFile.for(t),n=yield u.thenMapOr(yield e.childNames(),t=>t.filter(t=>!t.startsWith(".")).map(t=>t.toLowerCase()).sort(),()=>[]);return o.arrayEql(n,["applications","photostructure.app"])})}e.mounts=f,e.ignorableMacFilesystems=a.lazy(()=>i(this,void 0,void 0,function*(){return u.asyncFilter(yield f(),t=>i(this,void 0,void 0,function*(){return t.options.includes("nobrowse")||t.options.includes("quarantine")||(yield p(t.mountpoint))})).then(t=>t.map(t=>t.filesystem))}),d.mountpointsTtlMs),e.isInstallDmg=p},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),o=n(10),s=n(0),a=n(112),u=n(111);e.mountpointsPosix=function(){return i(this,void 0,void 0,function*(){const t=yield r.thenMap(a.dfPosixRaw(!1),t=>o.compactBlanks(t.map(t=>t.mountpoint)));if(null!=t&&(yield u.isGioSupported())){const e=yield u.gioVolumes();t.push(...e.map(t=>t.mountpoint))}return s.map(t,t=>t.filter(t=>!t.startsWith("/snap/")))})}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(70),s=n(3),a=n(20),u=n(11),l=n(60),c=n(47),d=n(24),h=/\s([A-Z]:\\)/g;e.mountpointsWin=s.lazy(()=>i(this,void 0,void 0,function*(){return o.thenOpt(c.PowerShell.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(t=>t.map(t=>t.Root)).filter(r.isNotEmpty).orElse(()=>e.mountpointsWinFsutil()).map(t=>t.sort()).getRequired()}),d.mountpointsTtlMs),e.mountpointsWinFsutil=s.lazy(()=>i(this,void 0,void 0,function*(){const t=(yield a.stdout(yield l.fsutil(),["fsinfo","drives"],{timeout:10*u.secondMs})).trim(),e=[];let n;for(;null!==(n=h.exec(t));)e.push(n[1]);return e}),d.mountpointsTtlMs)},function(t,e){t.exports=require("punycode")},function(t,e){t.exports=require("dns")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(15),o=n(77),s=n(10),a=n(20),u=n(11),l=n(60),c=n(7),d=n(23),h=n(19);e.ping=o.memoize(t=>i(this,void 0,void 0,function*(){const e=d.isWin?yield l.pingWin():"ping";return a.stdout(e,[d.isWin?"-n":"-c","1",t],{timeout:5*u.secondMs})}),5*u.minuteMs,255),e.ipv4Re=new RegExp("\\b"+c.times(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),e.ipAddrFromPing=o.memoize(t=>i(this,void 0,void 0,function*(){return r.Opt(yield e.ping(t).catch(t=>{console.warn("failed to ping: "+t)})).filter(s.notBlank).flatMap(t=>e.ipv4Re.exec(h.toS(t))).map(t=>t[0]).get()}),5*u.minuteMs,255)},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(53),o=n(2),s=n(112),a=n(111),u=n(40),l=n(24),c=r.keyedLazy("localMountpoints",u.mountsCacheKey,()=>o.thenMap(s.dfPosixRaw(!0),t=>t.map(t=>t.mountpoint)),{maxRetries:2,timeoutMs:l.cmdTimeoutMs,priorResultTtlMs:l.longTtlMs});e.dfPosix=r.keyedLazy("dfPosix",u.mountsCacheKey,function(){return i(this,void 0,void 0,function*(){const t=yield s.dfPosixRaw(!1);if(null!=t)return yield o.thenMap(c(),e=>{t.forEach(t=>{t.remote=!e.includes(t.mountpoint)})}),(yield a.isGioSupported())&&(yield o.thenMap(a.gioVolumes(),e=>t.push(...e))),t})},{maxRetries:2,timeoutMs:l.cmdTimeoutMs,priorResultTtlMs:l.dfTtlMs})},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),o=n(6),s=n(53),a=n(14),u=n(1),l=n(7),c=n(47),d=n(13),h=n(218),f=n(40),p=n(159),m=n(24),g=u.mkLogger("DfWin");function v(){return i(this,void 0,void 0,function*(){const t=yield c.PowerShell.instance().executeJsonToA(e.LocalAndNetCmd).catch(t=>{a.emitNonFatal("_localAndNet(): PowerShell failed, trying wmic",t)});return null==t?h._localAndNet():t.map(t=>Object.assign({mountpoint:t.Root,filesystem:"",label:t.Description,size:t.Used+t.Free,used:t.Used,available:t.Free,remote:r.notBlank(t.DisplayRoot)},o.map(p.parseRemoteName(t.DisplayRoot),t=>({remoteHost:t.host,remoteShare:t.share}))))})}function y(){return i(this,void 0,void 0,function*(){const t=yield c.PowerShell.instance().executeJsonToA(e.LocalCmd);return null==t?h._local():t.filter(t=>r.notBlank(t.DriveLetter)&&(r.notBlankAnd(t.HealthStatus,t=>d.equalsIgnoreCase(t,"Healthy"))||r.notBlankAnd(t.OperationalStatus,t=>d.equalsIgnoreCase(t,"OK")))).map(t=>({mountpoint:t.DriveLetter+":\\",filesystem:t.FileSystem,label:t.FileSystemLabel,size:t.Size,used:t.Size-t.SizeRemaining,available:t.SizeRemaining,remote:!1}))})}e.dfWin=s.keyedLazy("dfWin",f.mountsCacheKey,function(){return i(this,void 0,void 0,function*(){return(yield v().catch(t=>(g.warn("_localAndNet timed out, using local volumes.",t),y()))).filter(t=>r.notBlank(t.mountpoint)&&l.gt0(t.size))})},{maxRetries:2,timeoutMs:m.cmdTimeoutMs,priorResultTtlMs:m.dfTtlMs}),a.onClearCache(()=>e.dfWin.clear()),e.LocalAndNetCmd="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free",e._localAndNet=v,e.LocalCmd="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus",e._local=y},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(4),o=n(53),s=n(10),a=n(20),u=n(68),l=n(60),c=n(1),d=n(7),h=n(13),f=n(40),p=n(24);e.REMOVABLE_DISK=2,e.LOCAL_DISK=3,e.NETWORK_DRIVE=4;const m=c.mkLogger("DfWinWmic");e.dfWin=o.keyedLazy("dfWin",f.mountsCacheKey,function(){return i(this,void 0,void 0,function*(){return(yield v().catch(t=>(m.warn("_localAndNet timed out, using local volumes.",t),S()))).filter(t=>r.allNotBlank([t.mountpoint,t.filesystem])&&t.size>0)})},{maxRetries:2,timeoutMs:p.cmdTimeoutMs,priorResultTtlMs:p.dfTtlMs});const g="LOGICALDISK get DeviceID,DriveType,FileSystem,FreeSpace,Size,VolumeName /format:table".split(" ");function v(){return i(this,void 0,void 0,function*(){const t=l.wmic(),n=yield a.stdout(t,g,{timeout:p.cmdTimeoutMs});return w(u.parseFixed(["DeviceID","DriveType","FileSystem","FreeSpace","Size","VolumeName"],n,!1).map(t=>{const n=s.mapNotBlank(t.DeviceID,t=>h.ensureSuffix(t,"\\")),i=t.FileSystem,r=t.VolumeName,o=d.toInt(t.Size,{defaultValue:0}),a=d.toInt(t.FreeSpace,{defaultValue:0});return{mountpoint:n,filesystem:i,label:r,size:o,used:o-a,available:a,remote:d.toInt(t.DriveType,{defaultValue:e.LOCAL_DISK})===e.NETWORK_DRIVE}}))})}e._localAndNet=v;const y="VOLUME get Capacity,DriveLetter,FileSystem,FreeSpace,Label /format:table".split(" ");function S(){return i(this,void 0,void 0,function*(){const t=l.wmic(),e=yield a.stdout(t,y,{timeout:p.cmdTimeoutMs});return w(u.parseFixed(["Capacity","DriveLetter","FileSystem","FreeSpace","Label"],e,!1).map(t=>{const e=s.mapNotBlank(t.DriveLetter,t=>h.ensureSuffix(t,"\\")),n=t.FileSystem,i=t.Label,r=d.toInt(t.Capacity,{defaultValue:0}),o=d.toInt(t.FreeSpace,{defaultValue:0});return{mountpoint:e,filesystem:n,label:i,size:r,used:r-o,available:o,remote:!1}}))})}function w(t){return t.filter(t=>r.allNotBlank(t.mountpoint,t.filesystem)&&d.gte(t.size,0))}e._local=S},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(53),o=n(10),s=n(20),a=n(38),u=n(0),l=n(13),c=n(40),d=n(24);e.addLocalVolumeInfoMac=function(t){return i(this,void 0,void 0,function*(){const n=yield e.mnt2uuidMac();if(null!=n)return t.forEach(t=>{u.map(n.get(t.mountpoint),e=>{t.uuid=e.uuid,t.label=e.label})}),t})},e.mnt2uuidMac=r.keyedLazy("mnt2uuidMac",c.mountsCacheKey,function(){return i(this,void 0,void 0,function*(){const t=(yield s.stdout("diskutil",["info","-all"],{timeout:d.cmdTimeoutMs})).split(/^\s*\*{3,}\s*$/m);return a.toMap(t,t=>{const e=a.toMap(t.split(/\s*\n+\s*/),t=>{const[e,n]=t.split(":").map(t=>t.trim());return l.includesIgnoreCase(["not applicable","no file system"],n)?void 0:[e.toLowerCase(),n]}),n=e.get("mount point"),i=e.get("volume name"),r=e.get("volume uuid");return o.blank(n)?void 0:[n,{label:i,uuid:r}]})})},{maxRetries:2,timeoutMs:d.cmdTimeoutMs,priorResultTtlMs:d.longTtlMs})},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(53),o=n(10),s=n(20),a=n(221),u=n(0),l=n(19),c=n(40),d=n(24);e.addLocalVolumeInfoPosix=function(t){return i(this,void 0,void 0,function*(){const e=yield h();if(null!=e)return t.forEach(t=>{e.ignorablePaths.includes(t.mountpoint)?t.ignorable=!0:u.map(e.mnt2info.get(t.mountpoint),e=>{t.uuid=e.uuid,t.label=e.label})}),t})};const h=r.keyedLazy("volumeInfoLinux",c.mountsCacheKey,function(){return i(this,void 0,void 0,function*(){const t=yield s.stdout("lsblk",["-P","--output","mountpoint,label,uuid"],{timeout:d.cmdTimeoutMs}),e=new Map,n=[];return t.split(/[\r\n]+/).forEach(t=>{u.map(a.parseEnvTokens(t),t=>{l.toS(t.mountpoint).startsWith("/")&&(o.blank(t.uuid)?n.push(t.mountpoint):e.set(t.mountpoint,t))})}),{mnt2info:e,ignorablePaths:n}})},{maxRetries:2,timeoutMs:d.cmdTimeoutMs,priorResultTtlMs:d.longTtlMs})},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.parseEnvTokens=function(t){const e=/([a-z]+)="(.*?)"/gi,n={};let i;for(;null!=(i=e.exec(t));){const[,t,e]=i;n[t.toLowerCase()]=e}return n}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),o=n(53),s=n(20),a=n(11),u=n(14),l=n(60),c=n(38),d=n(0),h=n(47),f=n(13),p=n(40),m=n(24);function g(){return i(this,void 0,void 0,function*(){const t=yield l.fsutil(),e=yield s.stdout(t,["volume","list"],{timeout:7*a.secondMs}),n=new Map;let i;const r=/^\\\\.+\{([a-z0-9-]+)\}\\[\r\n]+([a-z]:\\)/gim;for(;null!=(i=r.exec(e));){const t=i[1],e=i[2];n.set(e,t)}return n})}e.addLocalVolumeInfoWin=function(t){return i(this,void 0,void 0,function*(){const e=yield v();if(null!=e)return t.forEach(t=>{d.map(e.get(t.mountpoint),e=>{t.remote=!1,t.uuid=e})}),t})},e.UuidCmd="Get-Partition | Select-Object -Property DriveLetter,Guid,IsOffline",e._mnt2uuidWinFsutil=g;const v=o.keyedLazy("mnt2uuidWin",p.mountsCacheKey,function(){return i(this,void 0,void 0,function*(){const t=yield h.PowerShell.instance().executeJsonToA(e.UuidCmd);return null==t?g():c.toMap(t.filter(t=>r.notBlank(t.DriveLetter)&&!t.IsOffline&&r.notBlank(t.Guid)),t=>[t.DriveLetter+":\\",f.stripPreSuff(t.Guid,"{","}")])})},{maxRetries:2,timeoutMs:m.cmdTimeoutMs,priorResultTtlMs:m.longTtlMs});u.onClearCache(()=>v.clear())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(0),o=n(19),s=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i;e.addRemoteVolumeInfoPosix=function(t){return i(this,void 0,void 0,function*(){return t.filter(t=>t.remote).forEach(t=>{r.map(s.exec(o.toS(t.filesystem)),e=>{t.remoteHost=e[1],t.remoteShare=e[2]})}),t})}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(18),o=n(29),s=n(72),a=n(0),u=n(27);function l({logger:t,name:e,result:n}){const i=null==n?"warn":"debug";t.enabled(i)&&t.log(i,s.grey(e)+": "+(!0===n?s.green:s.red)(r.toS(n)))}e.orLogged=function(t,e){return t.some(t=>a.keys(t).some(n=>o.truthy(u.tap(t[n](),t=>l({logger:e,name:n,result:t})))))},e.orLoggedAsync=function(t,e){return i(this,void 0,void 0,function*(){for(const n of t)for(const t of a.keys(n)){const i=yield n[t]();if(l({logger:e,name:t,result:i}),i)return i}return!1})}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(4),o=n(38),s=n(0);e.SetSet=class{constructor(){this.store=new Map}add(t,...e){o.getOrSet(this.store,t,()=>new Set).add(e)}find(t){for(let e=0;e<t.length-1;e++){const n=s.map(this.store.get(t[e]),n=>{const i=t.slice(e+1),o=[...n].filter(t=>r.startsWith(i,t));return r.greatestBy(o,t=>t.length)});if(i.isNotEmpty(n))return[t[e],...n]}}has(t){return null!=this.find(t)}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(113),s=n(3),a=n(20),u=n(11),l=n(68),c=n(1),d=n(23),h=n(28),f=c.mkLogger("Snap");e.ignorableSnapDir=o.AsyncFilter.lift(t=>i(this,void 0,void 0,function*(){if(!d.isLinux||!(yield e.hasSnap()))return!1;const n=h.pathnames(t.nativePath).indexOf("snap");return!(n<0)&&r.toA(yield e.snaps()).includes(h.pathnames[n+1])})),e.hasSnap=s.lazy(()=>i(this,void 0,void 0,function*(){try{return yield a.stdout("snap",["--version"],{timeout:10*u.secondMs}),!0}catch(t){return!1}})),e.snaps=s.lazy(()=>i(this,void 0,void 0,function*(){try{return yield l.parseFixed(["Name","Version"],yield a.stdout("snap",["list"],{timeout:10*u.secondMs})).map(t=>t.Name)}catch(t){return f.warn("snap failed",t),[]}}),30*u.secondMs)},,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(229),o=n(99),s=n(7);e.readFileType=function(t){return i(this,void 0,void 0,function*(){let e=-1;try{const n=Buffer.alloc(32);e=yield o.open(t,"r");const{buffer:i}=yield o.read(e,n,0,32,0);return r(i)}catch(t){return}finally{yield s.mapGte0(e,o.close)}})}},function(t,e){t.exports=require("file-type")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(7),r=n(57);function o(t){return t.toString(2).split("").reverse().map((t,e)=>"1"===t?e:-1).filter(t=>-1!==t)}e.concatBits=function(t,e){const n=Math.pow(2,e);return t.reduce((t,e)=>t*n+i.clamp(0,n,i.toInt(e,{defaultValue:0})),0)},e.bitZip=function(t){t.dims.forEach(t=>t.value=i.clamp(t.min,t.max,t.value));let e=0;for(let n=0;n<t.bitDepth;n++){e*=2;const i=n%t.dims.length,o=t.dims[i],s=r.avg([o.min,o.max]);o.value>s?(e+=1,o.min=s):o.max=s}return e},e.bitUnzip=function(t,e){if(e.bitDepth>52||e.bitDepth<0)return;const n=o(t);for(let t=0;t<e.bitDepth;t++){const i=t%e.dims.length,o=e.dims[i],s=r.avg([o.min,o.max]);n.includes(e.bitDepth-t-1)?o.min=s:o.max=s}return e.dims.map(t=>r.avg([t.min,t.max]))},e.bitsSet=o,e.pop=function(t){return t=(t=(858993459&(t-=t>>1&1431655765))+(t>>2&858993459))+(t>>4)&252645135,t+=t>>8,63&(t+=t>>16)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(102),r=n(33),o=n(1),s=n(12),a=n(56),u=n(55);e.SharpFits=r.strEnum("cover","contain","fill","inside","outside"),function(t){t.name=i.ReducerNames.sq,t.fit="cover",t.reduce=function(t,e){const n=e.width!==e.height;if(a.ltBoth(t,e))return n?Object.assign({},t,{fit:"cover",position:s.Settings.squareThumbStrategy.valueOrDefault}):t}}(e.Square||(e.Square={})),function(t){const e=u.lazy(()=>o.mkLogger("Reducers.Fit"));t.name=i.ReducerNames.fit,t.fit="inside",t.reduce=function(t,n){if(a.ltBoth(n,t))return void e().debug("reduce(): input is too small for max",{input:n,max:t});const i=n.width/n.height;return i>=t.width/t.height?{width:t.width,height:Math.ceil(t.width/i)}:{width:Math.ceil(t.height*i),height:t.height}}}(e.Fit||(e.Fit={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(22),r=n(5),o=n(17),s=n(15),a=n(18),u=n(7),l=n(64);class c{constructor(t,e,n,i){this.version=t,this.major=e,this.minor=n,this.patch=i}static for(t){return s.Opt(a.toS(t).split(".",3).map(t=>o.toInt(t))).map(r.compact).filter(t=>t.length>=3).map(e=>new c(t,e[0],e[1],e[2])).get()}gte(t){return"string"==typeof t&&(t=c.for(t)),u.gte(this.major,t.major)&&u.gte(this.minor,t.minor)&&u.gte(this.patch,t.patch)}toString(){return this.version}}e.SemVer=c,e.Version=c.for(l.version),e.NodeVersion=c.for(i.versions.node)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(234),r=n(12);e.PermissiveWorkPlanner=class{constructor(){this.pausedUntil=0,this.queue=[],this.paused=r.Settings.startPaused.valueOrDefault}isPaused(){return this.paused||Date.now()<this.pausedUntil}pause(t){null==t?this.paused=!0:this.pausedUntil=Math.max(Date.now()+t,this.pausedUntil)}resume(){this.paused=!1,this.pausedUntil=0,this.queue.forEach(t=>t()),this.queue.length=0}work(t,e){if(this.isPaused()){const{promise:t,later:n}=i.laterPromise(e);return this.queue.push(n),t}return e()}addIdleListener(){}removeIdleListener(){}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(29);!function(t){t.and=function(...t){return i(this,void 0,void 0,function*(){for(const e of t)if(!r.truthy(yield e()))return!1;return!0})},t.or=function(...t){return i(this,void 0,void 0,function*(){for(const e of t)if(r.truthy(yield e()))return!0;return!1})}}(e.Later||(e.Later={})),e.laterPromise=function(t){let e,n;return{promise:new Promise((t,i)=>{e=t,n=i}),later:()=>i(this,void 0,void 0,function*(){try{const i=yield t();return e(i),i}catch(t){throw n(t),t}})}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0),r=n(113);class o{static lift(t){return new class extends o{apply(e){return t(e)}}}and(t){return o.lift(e=>this.apply(e)&&t.apply(e))}or(t){return o.lift(e=>this.apply(e)||t.apply(e))}filter(t){return t.filter(t=>this.apply(t))}asAsync(){return r.AsyncFilter.lift(t=>Promise.resolve(this.apply(t)))}}e.Filter=o,e.definedFilter=o.lift(i.defined),e.trueFilter=o.lift(()=>!0)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(8),r=n(6),o=n(9),s=n(52),a=n(26),u=n(114),l=n(76),c=n(55),d=n(1),h=c.lazy(()=>d.mkLogger("ExifUid4"));e.extractUid4=function(t){return r.map(function(t,e,n){if(!e.src.startsWith("tags"))return;const r=a.datedToISO(e.date),s=t.Make,c=t.Model,d=l.compactZeroes(o.pick(t,"SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber","LensSerialNumber")),f=l.compactZeroes(o.pick(t,"BurstUUID","ImageNumber","ShutterCount","ImageUniqueID","RunTimeValue")),p=u.geohash(t.GPSLatitude,t.GPSLongitude,52);if(i.blank(p)&&null==n&&o.emptyObj(f)&&o.emptyObj(d))return;const m=o.compactValues(Object.assign({exifUid:4,capturedAt:r,Make:s,Model:c},n,f,d,{geoHash:p}));return h().debug("extractUidPojo4",{tags:o.pick(t,"SourceFile","tz","tzSource"),capturedAt:e,result:m}),m}(t,t.capturedAt,t.exposureSettings),t=>s.shortStringSha(JSON.stringify(t),20)+":v4")}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(8),r=n(6),o=n(9),s=n(3),a=n(52),u=n(26),l=n(1),c=n(76),d=n(94),h=5,f=s.lazy(()=>l.mkLogger("ExifUid5"));e.extractUidPojo5=function(t,e,n){if(null==e||!e.src.startsWith("tags"))return void f().debug("extractUidPojo(): rejecting, captured at isn't from tags",{src:t.SourceFile,ca:e});const s=e.date,a=r.map(s,u.datedToISO);if(null==s||null==a)return void f().debug("extractUidPojo5(): rejecting, captured at doesn't have a date or ISO",{src:t.SourceFile,ca:e,capturedAtDate:s,capturedAtIso:a});const l=c.normalizeExposureSettings(r.orElse(n,()=>d.extractExposureSettings(t))),p=t.Make,m=t.Model,g=c.cameraId(t),v=c.imageId(t),y=c.uidGeoHash(t.GPSLatitude,t.GPSLongitude),S=i.notBlank(p)&&i.notBlank(m),w=u.hasTime(e.date)&&[u.getMinute(e.date),u.getSecond(e.date)].some(c.present),b=S&&c.present(g)&&c.present(v),M=S&&w&&null!=l,P=w&&i.notBlank(y)&&(S||c.present(g)||c.present(v)),x=S&&null!=c.normalizeExposureSettings&&(c.present(g)||c.present(v)),E=Object.assign({version:h,capturedAtIso:a,Make:p,Model:m},l,{imageId:v,cameraId:g,geoHash:y}),_={hasMakeModelSerial:b,hasMakeModelExp:M,hasSecsGeo:P,hasMakeModelExpSerial:x,normalizedExpSets:l,exifUid:E};return b||M||P||x?(f().debug("extractUidPojo5()",_),o.compactValues(E)):void f().debug("extractUidPojo5(): cowardly rejecting, not enough context",_)},e.serializeUidPojo5=function(t){return a.shortStringSha(JSON.stringify(t),20)+":v"+r.orElse(t.version,h)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(8),r=n(6),o=n(9),s=n(18),a=n(26),u=n(1),l=n(76),c=n(94),d=6;e.extractUidPojo6=function(t,e,n){const h=u.mkLogger("extractUidPojo6("+s.toS(t.FileName)+")");if(null==e||!e.src.startsWith("tags"))return void h.debug("rejecting, captured at isn't from tags",{src:t.SourceFile,ca:e});const f=e.date,p=r.map(f,t=>a.datedToISO(t,!1));if(null==f||null==p)return void h.debug("rejecting, captured at doesn't have a date or ISO",{src:t.SourceFile,ca:e,capturedAtDate:f,capturedAtIso:p});const m=l.normalizeExposureSettings(r.orElse(n,()=>c.extractExposureSettings(t))),g=t.Make,v=t.Model,y=l.cameraId(t),S=l.imageId(t),w=l.uidGeoHash(t.GPSLatitude,t.GPSLongitude),b=i.notBlank(g)&&i.notBlank(v),M=a.hasTime(e.date)&&[a.getMinute(e.date),a.getSecond(e.date),a.getMillisecond(e.date)].some(l.present),P=b&&l.present(y)&&l.present(S),x=b&&M&&null!=m,E=M&&i.notBlank(w)&&(b||l.present(y)||l.present(S)),_=b&&null!=l.normalizeExposureSettings&&(l.present(y)||l.present(S)),T=Object.assign({version:d,capturedAtIso:p,Make:g,Model:v},m,{imageId:S,cameraId:y,geoHash:w}),O={hasMakeModelSerial:P,hasMakeModelExp:x,hasSecsGeo:E,hasMakeModelExpSerial:_,normalizedExpSets:m,exifUid:T};return P||x||E||_?(h.debug("result",O),o.compactValues(T)):void h.debug("cowardly rejecting, not enough context",O)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(8),r=n(55),o=n(6),s=n(9),a=n(26),u=n(1),l=n(76),c=n(94),d=7,h=r.lazy(()=>u.mkLogger("ExifUid7"));e.extractUidPojo7=function(t,e,n){if(null==e||!e.src.startsWith("tags"))return void h().debug("rejecting, captured at isn't from tags",{src:t.SourceFile,ca:e});const r=o.map(e.date,t=>a.datedToMillis(t));if(null==r)return void h().debug("rejecting, captured at doesn't have a date",{src:t.SourceFile,ca:e,capturedAtMs:r});const u=l.normalizeExposureSettings(o.orElse(n,()=>c.extractExposureSettings(t))),f=t.Make,p=t.Model,m=l.cameraId(t),g=l.imageId(t,{includeImageUniqueId:!1}),v=i.notBlank(f)&&i.notBlank(p),y=a.hasSeconds(e.date),S=v&&l.present(m)&&l.present(g),w=v&&y&&null!=u,b=v&&null!=l.normalizeExposureSettings&&(l.present(m)||l.present(g)),M=Object.assign({version:d,capturedAtMs:r,Make:f,Model:p},u,{imageId:g,cameraId:m}),P={hasMakeModelSerial:S,hasMakeModelExp:w,hasMakeModelExpSerial:b,normalizedExpSets:u,exifUid:M};return S||w||b?(h().debug("result",P),s.compactValues(M)):void h().debug("cowardly rejecting, not enough context",P)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(65),o=n(79),s=n(8),a=n(17),u=n(15),l=n(1).mkLogger("JsonSidecar");function c(t,e,n){for(const i of e)if(t&&t[i]&&a.isNumber(t[i][n]))return t[i][n]}e.readJsonSidecar=function(t){return i(this,void 0,void 0,function*(){const e=yield t.readJSON(),n=null==e?void 0:{DateTimeOriginal:u.Opt(e.photoTakenTime).flatMap(t=>t.timestamp).flatMap(a.toInt).filter(a.gt0).flatMap(t=>r.ExifDateTime.fromDateTime(o.DateTime.fromMillis(1e3*t))).get(),GPSLatitude:c(e,["geoDataExif","geoData"],"latitude"),GPSLongitude:c(e,["geoDataExif","geoData"],"longitude"),GPSAltitude:c(e,["geoDataExif","geoData"],"altitude"),Title:s.ifNotBlank(e.title),Description:s.ifNotBlank(e.description)};return null!=n&&l.debug("read "+t,n),n})}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(8),r=n(0),o=n(13),s=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|"),a=new RegExp(`[\\s\\.,_-]*(?:${s})[\\s\\.,_-]*$`,"i");function u(t,e,n=""){const i=t.replace(e,n);return i===t?t:u(i,e,n)}function l(t){const e=t.trim();return"gopro"===e.toLowerCase()?"GoPro":"benq"===e.toLowerCase()?"BenQ":e.length<4?e:e.toLowerCase().replace(/(?:^|\s|-)\S/g,t=>t.toUpperCase())}e.companyCased=l,e.make=function(t){return i.mapNotBlank(t,t=>t=l(t=u(t=o.stripQuotes(t),a).replace("LGE","LG")))};const c=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i],d=new Map([["Samsung",[[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10E"],[/^SM-G973/,"Galaxy S10"],[/^SM-G975/,"Galaxy S10+"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]]],["LG",[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]]]]);e.model=function(t,e){if(i.blank(t)||i.blank(e))return;e=o.stripQuotes(e);const n=r.map(d.get(t),t=>t.find(([t])=>null!=e.match(t)));return null!=n?n[1]:("Sony"===t&&(e=e.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"α").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV")),c.forEach(t=>e=u(e,t).trim()),e=e.replace(new RegExp(`^${t}\\s+`,"i"),""),null!=t.match(/^HP|Hewlett.Packard$/i)&&null!=e.match(/^hp\b/i)&&(e=e.slice(2).trim()),e)}},function(t,e){t.exports=require("@iarna/toml")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(6),o=n(9),s=n(78),a=n(3),u=n(2),l=n(137),c=n(28),d=n(1),h=n(0),f=n(169),p=a.lazy(()=>d.mkLogger("ShownFilePicker")),m=[s.PS_NETWORK_FILESYSTEM_PROTOCOL,"file:",s.PS_LOCAL_FILE_PROTOCOL,s.PS_LIBRARY_PROTOCOL];function g(t){return h.map(t,t=>Math.ceil(Math.log2(t.width*t.height)))}function v(t){return i(this,void 0,void 0,function*(){const e=yield y(t),n=o.values(e);return n.some(t=>null==t)?void p().debug("sortShownFiles: skipping "+t,e):n})}function y(t){return i(this,void 0,void 0,function*(){const e=g(yield f.dimensions(t)),n=yield t.uriObject(),i=yield u.thenMap(t.thisOrSidecareMaxMtimeSec(),t=>Math.round(t/60)),o=h.map(n,t=>m.indexOf(t.protocol)),s=t.name.toLowerCase().includes("cover"),a=l.browserExtFilter.apply(t);return{mp:e,mtime:i,schemeIdx:o,isCover:s,count:r.orElse(c.countFromName(t.name),0),isBrowserSupported:a}})}e.dim2sort=g,e.sortShownFiles=function(t){return i(this,void 0,void 0,function*(){return u.sortByAsync(t,v)})},e.fileSortCriteria=v,e.fileSortCriteriaPojo=y},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(3),r=n(10),o=n(135),s=n(28),a=n(32),u=n(12),l=n(13),c=n(15),d=n(78);e.installLibraryUriSupport=i.lazy(()=>{o.addUriParser(p),o.addUriFormatter(f)});const h=i.lazy(()=>c.Opt(u.Settings.libraryPath.value).filter(r.notBlank).map(t=>a.PosixFile.for(t)));function f(t){const e=a.PosixFile.for(s.posix2native(t.posixPath));return h().filter(t=>e.isDescendantOf(t)).map(e=>({pathname:encodeURI(a.PosixFile.for(t.posixPath).posixPathFrom(e)),protocol:d.PS_LIBRARY_PROTOCOL,slashes:!0})).get()}function p(t){return c.Opt("").filter(()=>l.equalsIgnoreCase(t.protocol,d.PS_LIBRARY_PROTOCOL)).flatMap(()=>h()).map(e=>r.blank(t.pathname)?e:e.join(decodeURIComponent(t.pathname))).get()}u.Settings.libraryPath.addListener(()=>h.clear()),e.uriFromLibraryPath=f,e.posixPathFromUri=p},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),o=n(4),s=n(113),a=n(2),u=n(10),l=n(176),c=n(168),d=n(1),h=n(7),f=n(12),p=n(31),m=n(49),g=n(19),v=n(137),y=n(161);function S(t){return s.AsyncFilter.lift(e=>i(this,void 0,void 0,function*(){return a.thenMapOr(p.readTags(e.nativePath),t,()=>!1)}))}function w(t){return S(e=>o.allNotBlank(...t.map(t=>e[t])))}function b(t){return S(e=>h.gte(e.ImageWidth,t)&&h.gte(e.ImageHeight,t))}function M(t){return!u.blank(t)&&(c.ffmpegSupportedMimeType(t)||e.supportedMimeTypes.has(t.toLowerCase()))}e.onlyFiles=s.AsyncFilter.lift(t=>t.isFile()),e.onlyReadable=s.AsyncFilter.lift(t=>t.isReadable()),e.requiredTagsFilter=w,e.minDimensionFilter=b,e.hasMimeType=w(["MIMEType"]),e.hasCapturedAt=w(["capturedAt"]),e.hasMakeAndModel=w(["Make","Model"]),e.notRejected=S(t=>h.toInt(t.Rating,{defaultValue:0})>=0),e.hasBrowserImgMimetype=S(t=>r.includes(["image/jpeg","image/png"],g.toS(t.MIMEType))),e.imageFilter=S(t=>g.toS(t.MIMEType).startsWith("image/")),e.videoFilter=S(t=>g.toS(t.MIMEType).startsWith("video/")),e.imageHasMakeAndModel=e.imageFilter.and(e.hasMakeAndModel).or(e.videoFilter),e.supportedMimeTypes=new Set([...m.sharpSupportedMimeTypes,...l.dcrawSupportedMimeTypes]),e.supportedMimeTypeFilter=s.AsyncFilter.lift(t=>i(this,void 0,void 0,function*(){return a.thenMapOr(p.mimetype(t.nativePath),M,()=>!1)})),e.exifExtFilter=v.extFilter(m.AssetFileExts),e.notHiddenCheap=s.AsyncFilter.lift(t=>i(this,void 0,void 0,function*(){return!y.ignorablePath(t.nativePath)})),e.fileSizeFilter=s.AsyncFilter.lift(t=>i(this,void 0,void 0,function*(){return a.thenMapOr(t.size(),t=>h.within(f.Settings.minFileSizeBytes.valueOrDefault,f.Settings.maxFileSizeBytes.valueOrDefault,t),()=>!1)})),e.noStatFileFilter=s.AsyncFilter.andLogged(d.mkLogger("noStatFileFilter"),{exifExtFilter:e.exifExtFilter},{notHiddenCheap:e.notHiddenCheap}),e.cheapFileFilter=s.AsyncFilter.andLogged(d.mkLogger("cheapFileFilter"),{exifExtFilter:e.exifExtFilter},{notHiddenCheap:e.notHiddenCheap},{fileSizeFilter:e.fileSizeFilter},{supportedMimeTypeFilter:e.supportedMimeTypeFilter}),e.minDimensionsFilter=e.videoFilter.and(b(f.Settings.minVideoDimension.valueOrDefault)).or(e.imageFilter.and(e.hasMakeAndModel).and(b(f.Settings.minImageDimension.valueOrDefault))),e.expensiveFileFilters=[{exifExtFilter:e.exifExtFilter},{fileSizeFilter:e.fileSizeFilter},{hasMimeType:e.hasMimeType},{supportedMimeTypeFilter:e.supportedMimeTypeFilter},{imageHasMakeAndModel:e.imageHasMakeAndModel},{hasCapturedAt:e.hasCapturedAt},{notRejected:e.notRejected},{minDimensionsFilter:e.minDimensionsFilter}],e.expensiveFileFilter=s.AsyncFilter.andLogged(d.mkLogger("expensiveFileFilter"),...e.expensiveFileFilters),e.extless=s.AsyncFilter.lift(t=>i(this,void 0,void 0,function*(){return u.blank(t.ext)})),e.onlyDirectories=s.AsyncFilter.lift(t=>i(this,void 0,void 0,function*(){return t.isDirectory()})),e.fileExtFilter=function(t){return s.AsyncFilter.and(v.extFilter(t),e.onlyFiles)},e.excludeDirnameFilter=function(t){return s.AsyncFilter.and(v.excludedPathFilter(t),e.onlyDirectories)}},,function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(10),o=n(0),s=n(31),a=n(107);function u(t){return o.map(t,t=>r.mapNotBlank(t.Make,e=>r.mapNotBlank(t.Model,t=>[a.Camera,e,t])))}e.cameraTag=u,e.cameraTagFile=function(t){return i.thenMap(s.readTags(t),u)}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(t,e,n){n(178),t.exports=n(362)},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});try{n(207).install()}catch(t){}const r=n(22),o=n(21),s=n(89),a=n(1),u=n(12),l=n(124),c=n(363),d=n(244);u.Settings.logLevel.hasValue()||(u.Settings.logLevel.value="warn",a.alsoLogToConsole()),function(t){return i(this,void 0,void 0,function*(){yield l.readSystemSettings(),yield l.readLibrarySettings(),d.installLibraryUriSupport(),console.dir(yield Promise.all(t.map(c.info)),{colors:!0,depth:5})})}(r.argv.slice(2)).then(()=>s.silentlyAsync(()=>o.endEndables()))},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(s,a)}u((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const r=n(113),o=n(161),s=n(32),a=n(291),u=n(26),l=n(243),c=n(31),d=n(64),h=n(6),f=n(9),p=n(293),m=n(203);e.info=function(t){return i(this,void 0,void 0,function*(){const e=s.PosixFile.for(t),n=[];for(const[t,i]of f.entries(yield o.ignorablePredicates(e)))(yield i())&&n.push(t);const i=yield c.capturedAt(e),g=yield c.readTags(e),v=yield r.AsyncFilter.andExplain(e,a.expensiveFileFilters);return Object.assign({nativePath:e.nativePath,ignoredBecause:n,filters:v,uri:yield e.uri(),sha:yield e.sha(),capturedAtISO:f.map(i,t=>u.datedToISO(t.date)),capturedAt:f.map(i,t=>u.datedToMillis(t.date)),capturedAtSrc:f.map(i,t=>t.src),dateTag:yield f.map(i,t=>m.dateTag(t.date)),cameraTag:yield p.cameraTag(g),tz:f.map(g,t=>t.tz),tzSource:f.map(g,t=>t.tzSource),fileSortCriteria:yield l.fileSortCriteriaPojo(e)},h.mapOr(g,t=>f.pick(t,"exifUid","exifUidPojo","geohash","tz","rotation","dimensions","problems","errors","Error","Warning"),()=>{}),{release:d.release})})}}]);
//# sourceMappingURL=info.js.map
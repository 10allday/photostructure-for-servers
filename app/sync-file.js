#!/usr/bin/env node
module.exports=function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=376)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(33);function r(t){return null!=t}e.map=function(t,e){return null==t?void 0:e(t)},e.map2=function(t,e,n){return null==t||null==e?void 0:n(t,e)},e.orElse=function(t,e){return null!=t?t:i.isFunction(e)?e():e},e.mapOr=function(t,e,n){return null==t?n():e(t)},e.defined=r,e.allDefined=function(t){return null!=t&&t.every(r)},e.firstDefined=function(...t){return t.find(r)},e.denull=function(t){return null==t?void 0:t}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(45),s=n(107),o=n(194),a=n(46),u=n(0),l=n(69),c=n(20),d=n(8);function h(t){return o.isList(t)&&t.length>0&&t.some(t=>null!=t)}function f(t){return!h(t)}function p(t){return l.isPrimitive(t)||l.isPrimitiveArray(t)?t:t.valueOf()}function m(t,e=[]){return null==t?e:(t.forEach(t=>u.map(t,t=>Array.isArray(t)?m(t,e):e.push(t))),e)}function g(t,e){const n=t.map((t,n)=>({ea:t,cmp:m([e(t),n])})).sort((t,e)=>l.cmp(t.cmp,e.cmp));for(let e=0;e<t.length;e++)t[e]=n[e].ea;return t.length=n.length,t}function v(t,e){return c.toA(t).filter(t=>null!=t).map((t,n)=>({ea:t,cmp:m([e(t),n])})).filter(t=>null!=t.cmp).sort((t,e)=>l.cmp(t.cmp,e.cmp)).map(t=>t.ea)}function y(t,e){if(null==t)return!1;for(const n of t)if(e===n)return!0;return!1}function b(t){if(null==t)return[];const e=c.toA(t);return e.every(u.defined)?e:e.filter(u.defined)}e.isNotEmpty=h,e.isEmpty=f,e.mapNotEmpty=function(t,e){return h(t)?e(t):void 0},e.flatten=m,e.sort=function(t){return g(b(t),p)},e.sortByInPlace=g,e.sorted=function(t){return t.every((e,n)=>0===n||e>t[n-1])},e.sortBy=v,e.deepSortBy=function t(e,n){return v(e,n).map(e=>s.isIterable(e)?t(e,n):e)},e.startsWith=function(t,e){return r.arrayEql(t.slice(0,e.length),e)},e.filterInPlace=function(t,e){for(let n=0;n<t.length;)e(t[n],n,t)?n++:t.splice(n,1);return t},e.includes=y,e.indexOf=function(t,e){if(null==t)return;let n=0;for(const i of t){if(e(i,n))return n;n++}},e.includesAll=function(t,e){return null!=t&&null!=e&&e.every(e=>y(t,e))},e.pushUniq=function(t,e){return y(t,e)||t.push(e),t},e.compact=b;const w=["null","undefined"];function S(t,e){if(f(t))return[];const n=new Map;return t.forEach(t=>a.getOrSet(n,e(t),()=>t)),[...n.values()]}e.compactBlankish=function(t){return c.toA(t).filter(t=>i.notBlank(t)&&!w.includes(d.toS(t)))},e.compactBlanks=function(t){return null==t?[]:t.map(t=>d.toS(t).trim()).filter(t=>t.length>0)},e.uniq=function(t){return S(b(t),t=>JSON.stringify(t))},e.uniqBy=S,e.clear=function(t){return t.length=0,t},e.count=function(t,e){return t.reduce((t,n,i)=>t+(e(n,i)?1:0),0)},e.sum=function(t,e){return t.reduce((t,n)=>t+e(n),0)},e.firstMatch=function(t,e){for(const n of b(e)){const e=t.exec(n);if(null!=e)return e}},e.commonPrefixLength=function(t,e){if(null==t||null==e)return 0;if(r.eql(t,e))return t.length;let n=0;for(;r.eql(t[n],e[n]);)n++;return n}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0),r=n(20),s=n(8);function o(t){if(null==t)return!0;const e=s.toS(t);return 0===e.length||0===e.trim().length}function a(t){return!o(t)}function u(t,e){if(!1===t||null==t||""===t)return;const n=s.toS(t);return a(n)?e(n):void 0}e.blank=o,e.notBlank=a,e.ifNotBlank=function(t){if(null==t)return;const e=s.toS(t);return 0===e.length||0===e.trim().length?void 0:e},e.notBlankOr=function(t,e){if(null==t)return e;const n=s.toS(t).trim();return n.length>0?n:e},e.notBlankAnd=function(t,e){return!o(t)&&e(t)},e.mapNotBlank=u,e.mapNotBlankOr=function(t,e,n){return i.orElse(u(t,e),n)},e.firstNotBlank=function(...t){return r.toA(t).find(t=>a(t))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(19),r=n(4),s=n(0),o=n(29),a=n(203),u=n(149),l=n(75),c=n(186),d=n(11);e.rootLogger=r.lazy(()=>u.ConsoleLogger.instance()),e.safeRootLogger=r.lazy(()=>l.safeLogger(e.rootLogger())),e.rootLogger.onChange(()=>e.safeRootLogger.clear()),e.alsoLogToConsole=function(){e.rootLogger.set(e.rootLogger()===u.ConsoleLogger.instance()?e.rootLogger():new a.CompoundLogger(e.rootLogger(),u.ConsoleLogger.instance()))},e.setLoggerProcessName=function(t,n=d.Settings.logDir.valueOrDefault){const r=t+"-"+i.pid,l=e.rootLogger.prior();if(null!=l&&l instanceof c.LogWriter&&l.prefix===r&&l.logDir.eql(n))return;s.map(e.rootLogger.prior(),t=>t.close());const h=new c.LogWriter(o.BaseFile.for(n),r);e.rootLogger.set(d.Settings.logStdout.valueOrDefault?new a.CompoundLogger(h,u.ConsoleLogger.instance()):h)},e.mkLogger=function(t){return new l.ContextualLogger(t,e.rootLogger)},e.mkSafeLogger=function(t){return new l.ContextualLogger(t,e.safeRootLogger)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.lazy=function(t,e){let n,i=0;const r=[];function s(t){return i=Date.now(),n=t,r.forEach(t=>t(n)),n}function o(){return(0===i||null!=e&&i+e<=Date.now())&&s(t()),n}return o.clear=function(){const t=n;return i=0,n=void 0,r.forEach(t=>t(n)),t},o.set=function(t){return s(t)},o.prior=function(){return n},o.refresh=function(){return s(t())},o.setTTL=function(t){return e=t},o.onChange=function(t){r.push(t)},o}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(4),r=n(14);e.secondMs=1e3,e.minuteMs=60*e.secondMs,e.hourMs=60*e.minuteMs,e.dayMs=24*e.hourMs,e.weekMs=7*e.dayMs;const s=i.lazy(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));e.fmtDateShort=function(t){return r.Opt(t).flatMap(t=>t instanceof Date?t.getTime():t).map(t=>s().format(t)).get()}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(0),s=n(14),o=n(8);function a(t){return"number"==typeof t&&isFinite(t)}function u(t,e){return a(t)?e(t):void 0}function l(t){return p(t,t=>{const e=Math.trunc(t);return 0===e?Math.abs(e):e})}function c(t,e){if(i.blank(t))return e.defaultValue;if(a(t))return e.nton(t);try{const n=e.ston(o.toS(t));return a(n)?e.nton(n):e.defaultValue}catch(t){return e.defaultValue}}function d(t,e){return c(t,Object.assign({defaultValue:void 0,nton:t=>l(t),ston:parseInt},e))}function h(t){return a(t)&&t>0}function f(t,e){return s.Opt(t).flatMap(t=>d(t)).flatMap(e).get()}function p(t,e){return a(t)?e(t):void 0}function m(t){return t<0?-Math.round(-t):Math.round(t)}function g(t,e){if(null==t)return 0;const n=Math.pow(10,e);return m(t*n)/n}e.isNumber=a,e.mapFinite=u,e.finiteOrElse=function(t,e){return a(t)?t:e},e.diff=function(t,e){return a(t)&&a(e)?t-e:void 0},e.absdiff=function(t,e){return a(t)&&a(e)?Math.abs(t-e):void 0},e.trunc=l,e.toInt=d,e.toFloat=function(t,e){return c(t,Object.assign({defaultValue:void 0,nton:t=>t,ston:parseFloat},e))},e.toGt0=function(t){const e=d(t);return null!=e&&e>0?e:void 0},e.gt0=h,e.gte0=function(t){return a(t)&&t>=0},e.mapInt=f,e.id=function(t){const e=d(t);return h(e)?String(e):void 0},e.mapIntOr=function(t,e,n){return r.orElse(f(t,e),n)},e.mapNumeric=p,e.map2Numeric=function(t,e,n){return p(t,t=>p(e,e=>n(t,e)))},e.mapNumericOr=function(t,e,n){return a(t)?e(t):n},e.round=m,e.toPrecisionMaybe=function(t,e){return u(t,t=>g(t,e))},e.toFixed=function(t,e){try{return p(t,t=>parseInt(t.toFixed(e)))}catch(t){return}},e.toPrecision=g,e.sigFigs=function(t,e){if(0===t||0===e)return 0;const n=Math.pow(10,e-m(Math.ceil(Math.log10(Math.abs(t)))));return m(t*n)/n},e.base2Ceil=function(t){return Math.pow(2,Math.ceil(Math.log2(t)))},e.base10Ceil=function(t){return Math.pow(10,Math.ceil(Math.log10(t)))},e.clamp=function(t,e,n){return a(n)?([t,e]=[Math.min(t,e),Math.max(t,e)],Math.max(t,Math.min(n,e))):m((t+e)/2)},e.times=function(t,e){if(!a(t))return[];const n=Math.round(t);return n<=0?[]:[...Array(n)].map((t,n)=>e(n))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(34),s=n(1),o=n(5),a=n(39),u=n(0),l=n(6),c=n(33),d=n(14),h=n(35),f=n(12),p=n(26),m=n(16),g=n(21),v=n(196),y=n(53);function b(t){return i(this,void 0,void 0,(function*(){try{return yield t,!0}catch(t){return!1}}))}function w(t,e,n=(()=>void 0),r=(()=>void 0)){return i(this,void 0,void 0,(function*(){let i,s=!1,o=!1;return yield Promise.race([v.asPromise(t).then(t=>o?void 0:(i=t,s=!0,t)),a.unrefDelay(e).then(()=>{s||(o=!0)})]),s?yield r(i):yield n(),i}))}function S(t,n,r=e.DefaultMaxConcurrent){return i(this,void 0,void 0,(function*(){return(yield y.withBoundedConcurrency({name:"tuples",laters:t.map((t,e)=>()=>i(this,void 0,void 0,(function*(){return[yield n(t,e),t]}))),maxConcurrent:r})).filter(([t,e])=>null!=t&&null!=e)}))}e.DefaultMaxConcurrent=8,e.PromiseStates=h.strEnum("pending","resolved","rejected"),e.resolvedThen=function(t,e){return i(this,void 0,void 0,(function*(){if(null==t)return Promise.resolve(void 0);try{return yield t,e()}catch(t){return}}))},e.resolvedWithin=function(t,e){return Promise.race([t,a.delay(e).then(()=>void 0)])},e.resolved=b,e.rejected=function(t){return i(this,void 0,void 0,(function*(){return!(yield b(t))}))},e.thenDefined=function(t){return i(this,void 0,void 0,(function*(){return null!=(yield t)}))},e.allSerial=function(t){return i(this,void 0,void 0,(function*(){const e=[];for(const n of s.compact(t))e.push(yield n());return s.compact(e)}))},e.awaitAll=function(t){return i(this,void 0,void 0,(function*(){const e=s.compact(t);return s.isEmpty(e)?void 0:Promise.all(e).then(()=>void 0)}))},e.thenFlatten=function(t){return i(this,void 0,void 0,(function*(){return null==t?[]:s.flatten(s.compact(yield Promise.all(t)))}))},e.thenCompact=function(t){return i(this,void 0,void 0,(function*(){const e=s.compact(t);return s.isEmpty(e)?[]:s.compact(yield Promise.all(e))}))},e.asyncFind=function(t,e){return i(this,void 0,void 0,(function*(){for(const n of t)if(yield e(n))return n}))},e.asyncFilter=function(t,n,r=e.DefaultMaxConcurrent){return i(this,void 0,void 0,(function*(){return(yield S(s.compact(t),n,r)).filter(([t])=>t).map(([,t])=>t)}))},e.partitionAsync=function(t,e){return i(this,void 0,void 0,(function*(){const n=yield S(t,e);return[n.filter(([t])=>p.truthy(t)).map(([,t])=>t),n.filter(([t])=>!p.truthy(t)).map(([,t])=>t)]}))},e.tryAsync=function(t){return i(this,void 0,void 0,(function*(){try{return yield t()}catch(t){return}}))},e.DefaultTryAllTimeoutMs=30*o.secondMs,e.tryAll=function(t,n=(t=>console.error(t)),r=e.DefaultTryAllTimeoutMs){return i(this,void 0,void 0,(function*(){for(const e of t)try{yield w(e,r)}catch(t){n(t)}}))},e.thenFinally=function(t,e=(()=>{}),n=(()=>{})){return i(this,void 0,void 0,(function*(){let i,r=null;try{i=yield c.isFunction(t)?t():t}catch(t){r=t;try{yield e(t)}catch(t){}}try{yield n(null!=r?r:i)}catch(t){}if(null!=r)throw r;return i}))},e.thenIf=function(t,e){return i(this,void 0,void 0,(function*(){const n=yield t;return null!=n&&(yield e(n))?n:void 0}))},e.thenNot=function(t,e=!0){return i(this,void 0,void 0,(function*(){if(null==t)return e;const n=yield t;return null==n?e:!p.truthy(n)}))},e.thenMap=function(t,e){return i(this,void 0,void 0,(function*(){const n=yield t;return null==n?void 0:e(n)}))},e.thenMapOr=function(t,e,n){return i(this,void 0,void 0,(function*(){const i=yield t;if(null==i)return n();const r=yield e(i);return null==r?n():r}))},e.thenAnd=function(t,e){return i(this,void 0,void 0,(function*(){if(null!=t)return(yield t)?e():void 0}))},e.thenOrElse=function(t,e){return i(this,void 0,void 0,(function*(){return u.orElse(yield t,e)}))},e.first=function(t,e){return i(this,void 0,void 0,(function*(){if(null!=t){let n=-1;for(const i of t){n++;try{if(null==i)continue;const t=yield e(i,n);if(null!=t)return t}catch(t){}}}}))},e.firstDefinedPromise=function(t,e=g.identity){return i(this,void 0,void 0,(function*(){for(const n of t){const t=yield n();if(null!=t){const n=yield e(t);if(null!=n)return n}}}))},e.firstResolvedDefinedPromise=function(t,e){return i(this,void 0,void 0,(function*(){for(const n of t)try{const t=yield n();if(null!=t)return t}catch(t){e(t)}}))},e.firstTruePromise=function(t,...e){return i(this,void 0,void 0,(function*(){for(const n of e)try{const e=yield n();if(null!=e&&!0===(yield t(e)))return e}catch(t){}}))},e.until=function(t,e,n){return i(this,void 0,void 0,(function*(){const i=m.mapGt0(e,t=>Date.now()+t),s=d.Opt(n).getOrElse(()=>u.orElse(e,3e4)/10),o=l.clamp(100,1e4,s);for(;null==i||Date.now()<i;){const e=yield t();if(!0===e)return!0;if(null!=e&&!1!==e)throw new Error("f must return a boolean, but returned "+r.inspect(e));yield a.delay(o)}return!1}))},e.untilDefined=function(t,{timeoutMs:e,timeBetweenMs:n}){return i(this,void 0,void 0,(function*(){const i=m.mapGt0(e,t=>Date.now()+t),r=d.Opt(n).getOrElse(()=>u.orElse(e,3e4)/10),s=l.clamp(50,1e4,r);for(;null==i||Date.now()<i;){const e=yield t();if(null!=e)return e;yield a.delay(s)}}))},e.thenOrTimeout=w,e.tuples=S,e.thenGreatest=function(t,e){return i(this,void 0,void 0,(function*(){return u.map(f.greatestBy(yield S(t,e),t=>t[0]),t=>t[1])}))},e.sortByAsync=function(t,e){return i(this,void 0,void 0,(function*(){return s.sortBy(yield S(t,e),t=>t[0]).map(t=>t[1])}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.toS=function t(e){return null==e?"":"string"==typeof e?e:Array.isArray(e)?e.map(t).join(","):e.toString()}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(0),o=n(33);function a(t){return null==t||"object"!=typeof t?[]:Object.keys(t).filter(e=>"string"==typeof e&&(null==t.propertyIsEnumerable||t.propertyIsEnumerable(e)))}function u(t){return a(t).map(e=>t[e])}function l(t){return a(t).map(e=>[e,t[e]])}function c(t,e={}){return"object"!=typeof e&&(e={}),i.compact(t).reduce((t,[e,n])=>h(t,()=>{null!=e&&null!=n&&(t[e]=n)}),e)}function d(t){return u(t).every(t=>null!=t)}function h(t,e){return null!=e?e(t):console.dir(t,{depth:3}),t}e.emptyObj=function(t){return i.isEmpty(a(t))},e.keys=a,e.values=u,e.compactValues=function(t){const e=l(t).filter(([t,e])=>null!=t&&null!=e);return i.isEmpty(e)?void 0:c(e)},e.entries=l,e.fromEntries=c,e.mapFields=function(t,e,n={}){return c(i.compact(l(t).map(([t,n])=>e(t,n))).filter(([t,e])=>null!=t&&null!=e),n)},e.pick=function(t,...e){if(null==t)return t;if(!e.every(t=>"string"==typeof t))throw new Error("bad keys: "+JSON.stringify(e));return i.isEmpty(e)?{}:e.reduce((e,n)=>h(e,()=>s.map(t[n],t=>e[n]=t)),{})},e.pickFirst=function(t,e,n=s.defined){if(null!=t)for(const i of e)if(n(t[i]))return t[i]},e.without=function(t,...e){if(null==t||e.every(e=>r.blank(t[e])))return t;const n=l(t).filter(([t])=>!e.includes(t));return i.isEmpty(n)?void 0:c(n)},e.reqValued=d,e.reqValuedOrElse=function(t){return d(t)?t:void 0},e.mapReqValued=function(t,e){return d(t)?e(t):void 0},e.onlyReqValued=function(t){return t.filter(d)},e.sortedKeys=function(t){return c(i.sortBy(l(t),([t])=>t))},e.filter=function(t,e){return null==t?t:c(l(t).filter(([t,n])=>e(t,n)))},e.tap=h,e.allKeys=function(t){const e=a(t);for(;null!=(t=Reflect.getPrototypeOf(t));)e.push(...Reflect.ownKeys(t).filter(t=>"string"==typeof t));return i.uniq(e)},e.maybeCall=function(t,e,...n){return null!=t&&o.isFunction(t[e])?t[e].bind(t)(...n):void 0},e.firstValueCaseInsensitive=function(t,e){if(r.blank(e))return;if(null!=t[e])return t[e];const n=e.toLocaleLowerCase().normalize();for(const e of a(t))if(n===e.toLocaleLowerCase().normalize()&&null!=t[e])return t[e]}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(0),o=n(6),a=n(8),u=n(12),l=n(195);e.newlineRe=/\r?\n/gm,e.isString=function(t){return"string"==typeof t};const c={};function d(t,e){if(e<1)return"";for(null==c[t]&&(c[t]=t);e>c[t].length;)c[t]+=t;return c[t].substring(0,e)}function h(t,e){return t=a.toS(t),e=a.toS(e),t.startsWith(e)?t:e+t}function f(t){return t.sort((t,e)=>t.valueOf().localeCompare(e.valueOf()))}e.leftPad=function t(e,n,i){if("number"==typeof e&&e<0)return"-"+t(String(-e),n-1,i);const r=String(e);return d(i,n-r.length)+r},e.padding=d,e.padReplace=function(t,e,n,i){return t.substr(0,e)+d(i,n)+t.substr(e+n)},e.contains=function(t,e,n){return a.toS(t).indexOf(a.toS(e),n)>-1},e.count=function t(e,n,i=0){if(null==n||0===n.length)return 0;const r=e.indexOf(n,i);return-1===r?0:1+t(e,n,r+n.length)},e.replaceAll=function(t,e,n){return t.split(e).join(n)},e.maybeToS=function(t){return null==t?void 0:String(t)},e.mapParse=function(t,e){if(r.notBlank(t))try{return e(JSON.parse(t))}catch(t){}},e.trim=function(t){return t.map(a.toS).filter(t=>r.notBlank(t))},e.splitEvery=function(t,e,n){const i=Math.min(Math.ceil(t.length/e),s.orElse(n,()=>t.length))-1;return i<=0?[t]:[...o.times(i,n=>t.slice(n*e,(n+1)*e)),t.slice(i*e)]},e.splitKeep=function(t,e,n=!0){const i=new RegExp(e,e.flags+"gm"),r=[];let s,o=0;for(;null!=(s=i.exec(t));)if(s.index===i.lastIndex)i.lastIndex++;else{i.lastIndex=s[0].length+s.index;const e=n?s.index:i.lastIndex;r.push(t.substring(o,e)),o=e}return o<t.length&&r.push(t.substring(o)),r},e.removeCapture=function(t,e){const n=e.exec(t);if(null==n||null==n[1])return t;const i=n.index+n[0].length,r=i-n[1].length;return t.substr(0,r)+t.substr(i)},e.stripPrefix=function(t,e){const n=a.toS(t),i=a.toS(e);return i.length>0&&n.startsWith(i)?n.slice(i.length):n},e.stripPrefixIgnoreCase=function(t,e){const n=a.toS(t),i=a.toS(e);return i.length>0&&n.toLowerCase().startsWith(i.toLowerCase())?n.slice(i.length):n},e.stripSuffix=function(t,e){const n=a.toS(t),i=a.toS(e);return i.length>0&&n.endsWith(i)?n.slice(0,-i.length):n},e.stripPreSuff=function(t,e,n){return(t=a.toS(t)).endsWith(n)&&t.startsWith(e)?t.slice(e.length,-n.length):t},e.ensurePrefix=h,e.ensureSuffix=function(t,e){return t=a.toS(t),e=a.toS(e),t.endsWith(e)?t:t+e},e.ellipsize=function(t,e=80){if(null==t)return"";const n=a.toS(t);return n.length<=e?n:n.slice(0,e-1)+"…"},e.gist=function(t,e=80,n=80){const i=a.toS(t),r=i.length-(e+n);return r<=0?i:i.slice(0,e).trim()+" …(+"+r+" chars)…"+i.slice(-n).trim()},e.capitalize=function(t){return r.blank(t)?t:t.charAt(0).toUpperCase()+t.slice(1)},e.equalsIgnoreCase=function(t,e){return null!=t&&null!=e&&a.toS(t).toLowerCase()===a.toS(e).toLowerCase()},e.startsWithIgnoreCase=function(t,e){return null!=t&&null!=e&&t.toLowerCase().normalize().startsWith(e.toLowerCase().normalize())},e.includesIgnoreCase=function(t,e){const n=a.toS(e).trim().toLowerCase().normalize();return!i.isEmpty(t)&&0!==n.length&&t.map(t=>a.toS(t).trim().toLowerCase().normalize()).filter(r.notBlank).some(t=>n.includes(t))},e.reverse=function(t){return null==t?t:t.split("").reverse().join("")},e.localeSort=f,e.sortChars=function(t){return f(t.split("")).join("")},e.longestPrefix=function(t,e){return u.greatestBy(e.filter(e=>t.startsWith(e)),t=>t.length)},e.stripAnsiEsc=function(t){return a.toS(t).replace(/\u001b\[[0-9;]+[a-z]/gi,"")},e.wrap=function t(n,r={maxLineLen:75,prefix:""}){if(n.includes("\n"))return i.flatten(n.split(e.newlineRe).map(e=>t(e,r)));if((n=h(a.toS(n).trim(),r.prefix)).length<=r.maxLineLen)return[n.trim()];const s=n.slice(0,r.maxLineLen+1).replace(/[\s-]/g," ").lastIndexOf(" "),o=s<=1?r.maxLineLen-(r.prefix.length+2):s;return[n.slice(0,o+1).trim(),...t(n.slice(o+1),r)]};const p=[[/[‘’]/g,"'"],[/[“”„«»”〃]/g,'"']];function m(t){return p.reduce((t,[e,n])=>t.replace(e,n),t).normalize()}e.dumbquote=m;const g=/^(['"]).+\1$/;e.stripQuotes=function(t){return r.blank(t)?t:(t=a.toS(t).trim(),null!=g.exec(m(t))&&(t=t.slice(1,-1).trim()),t)},e.wbrPath=function(t){return t.split(/(?<=[\\\/_,:=-]+)/).map(t=>l.escape(t.normalize())).join("<wbr>")},e.escapeRegExp=function(t){return a.toS(t).replace(/[?.()[\]{}*^+|$]/g,"\\$&")},e.zipStrings=function(...t){let e="";const n=i.compactBlanks(t),r=Math.max(...n.map(t=>t.length));for(let t=0;t<r;t++)for(let i=0;i<n.length;i++)s.map(n[i],n=>s.map(n[t],t=>e+=t));return e}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(43),r=n(30),s=n(19),o=n(1),a=n(2),u=n(5),l=n(157),c=n(4),d=n(0),h=n(9),f=n(35),p=n(28),m=n(144),g=n(145),v=n(12),y=n(26),b=n(27),w=n(25),S=n(200),M=n(23),P=n(44),x=n(146);var E;function _(t){const n=(a.blank(t)?"":t).split(r.delimiter);if(M.isWin&&a.blank(s.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return n.push(...e.DefaultPaths),o.uniq(n).filter(a.notBlank).join(r.delimiter)}function O(t){const n={};e.settingsForChildProcs().forEach(t=>t.addToEnv(n));const i=h.compactValues(Object.assign(Object.assign(Object.assign(Object.assign({},s.env),{NODE_ENV:w.nodeEnv,ELECTRON_RUN_AS_NODE:"1",PATH:e.pathWithDefaults()}),n),d.orElse(t,{})));return E.logStdout.deleteFromEnv(i),i}!function(t){t.libraryPath=new x.StringSetting({name:"libraryPath",key:"PS_LIBRARY_PATH",alternateKeys:["PS_LIBRARY"],category:x.SettingCategories.System,description:"This is the full path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators.",defaultValue:"",persisted:!0,advanced:!1,addToChildProcs:!0}),t.pidfile=new x.StringSetting({name:"pidfile",key:"PIDFILE",category:x.SettingCategories.System,description:"If set, the main process will write the main PID to this value, which should be an absolute path.",defaultValue:"",persisted:!0,addToChildProcs:!1}),t.logLevel=new x.StringSetting({name:"logLevel",key:"PS_LOG_LEVEL",alternateKeys:["PS_LOG","LOG"],category:x.SettingCategories.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', or 'error'.",defaultValue:()=>w.isProd?"error":"info",persisted:!0,addToChildProcs:!0}),t.logDir=new x.StringSetting({name:"logDir",key:"PS_LOG_DIR",category:x.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>"darwin"===i.platform()?b.resolve(i.homedir(),"Library","Logs",g.AppName):b.resolve(m.appData(),g.AppName,"logs"),persisted:!0,addToChildProcs:!0}),t.logColor=new x.BooleanSetting({name:"logColor",key:"PS_LOG_COLOR",category:x.SettingCategories.Logging,description:"Should log messages be colorized with ANSI escape sequences? Great for nerds, bad for everyone else.",defaultValue:()=>!w.isProd,persisted:!0}),t.logCompression=new x.BooleanSetting({name:"logCompression",key:"PS_LOG_COMPRESS",category:x.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>w.isProd,persisted:!0}),t.logWebRequests=new x.BooleanSetting({name:"logWebRequests",key:"PS_LOG_WEB_REQUESTS",category:x.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1,persisted:!0}),t.logWebDir=new x.StringSetting({name:"logWebDir",key:"PS_LOG_WEB_DIR",category:x.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir.",defaultValue:"",persisted:!0,addToChildProcs:!0}),t.logSql=new x.StringSetting({name:"logSql",key:"PS_LOG_SQL",category:x.SettingCategories.Logging,description:"If non-blank, and a given db query includes the given string, the query will be logged.",defaultValue:"",persisted:!0}),t.logStdout=new x.BooleanSetting({name:"logStdout",key:"PS_LOG_STDOUT",alternateKeys:["LOG_STDOUT","PS_STDOUT"],category:x.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,persisted:!1}),t.probationMs=new x.IntegerSetting({name:"probationMs",key:"PS_PROBATION_MS",category:x.SettingCategories.System,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*u.minuteMs,persisted:!0}),t.fatalErrorRatePerMinute=new x.IntegerSetting({name:"fatalErrorRatePerMinute",key:"PS_FATAL_ERROR_RATE_PER_MINUTE",category:x.SettingCategories.System,description:"If PhotoStructure sees non-fatal errors at a higher rate per minute than this setting, PhotoStructure will exit.",defaultValue:10,persisted:!0}),t.autoLaunch=new x.BooleanSetting({name:"autoLaunch",key:"PS_AUTO_LAUNCH",category:x.SettingCategories.System,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows.",defaultValue:!1,advanced:!1,persisted:!0}),t.minDiskFreeGb=new x.IntegerSetting({name:"minDiskFreeGb",key:"PS_MIN_DISK_FREE_GB",category:x.SettingCategories.System,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe.",defaultValue:8,persisted:!0}),t.maxCpuPercent=new x.BoundedIntegerSetting({name:"maxCpuPercent",key:"PS_MAX_CPU_PERCENT",category:x.SettingCategories.System,description:"PhotoStructure will not schedule work if the current system utilization percent is higher than this value. This value must be between 0 and 100. Smaller values (less than 25) may mean PhotoStructure can never schedule work. A value of 100 will allow PhotoStructure to schedule work on all of your CPUs, and may make your system unusable.",defaultValue:75,min:0,max:200,persisted:!0}),t.maxMemoryMb=new x.BoundedIntegerSetting({name:"maxMemoryMb",key:"PS_MAX_MEMORY_MB",category:x.SettingCategories.System,description:"PhotoStructure will restart services if their process consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:512,max:8e3,persisted:!0}),t.dbCacheSizeMb=new x.IntegerSetting({name:"dbCacheSizeMb",key:"PS_DB_CACHE_SIZE_MB",category:x.SettingCategories.System,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:128,persisted:!0}),t.pollIntervalMs=new x.IntegerSetting({name:"pollIntervalMs",key:"PS_POLL_INTERVAL_MS",category:x.SettingCategories.System,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>w.isProd?30*u.secondMs:100,persisted:!0}),t.vlcPath=new x.StringSetting({name:"vlcPath",key:"PS_VLC_PATH",category:x.SettingCategories.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc",persisted:!0}),t.ffmpegPath=new x.StringSetting({name:"ffmpegPath",key:"PS_FFMPEG_PATH",category:x.SettingCategories.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH.',defaultValue:"ffmpeg",persisted:!0}),t.updateChannel=new x.StringEnumSetting({name:"updateChannel",key:"PS_UPDATE_CHANNEL",category:x.SettingCategories.Updates,description:'TL:DR; keep this on "latest." This controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds will not have been thoroughly tested. Please only consider changing this if customer support asks you to.',defaultValue:S.channel,validValues:["alpha","beta","latest"],persisted:!0}),t.allowDowngrade=new x.BooleanSetting({name:"allowDowngrade",key:"PS_ALLOW_DOWNGRADE",category:x.SettingCategories.Updates,description:"If you're running an alpha or beta build, and you switch back to 'updateChannel = \"latest\"', would you like PhotoStructure to downgrade you? Note that enabling this may make your library unreadable, if the current stable version of PhotoStructure can't read new alpha or beta database schemas.",defaultValue:!1,persisted:!0}),t.updateOnLaunch=new x.BooleanSetting({name:"updateOnLaunch",key:"PS_UPDATE_ON_LAUNCH",category:x.SettingCategories.Updates,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0,persisted:!0}),t.updateCheckMinutes=new x.IntegerSetting({name:"updateCheckMinutes",key:"PS_UPDATE_CHECK_MINUTES",category:x.SettingCategories.Updates,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:1440,persisted:!0}),t.bounceMinutes=new x.IntegerSetting({name:"bounceMinutes",key:"PS_BOUNCE_MINUTES",category:x.SettingCategories.Updates,description:"PhotoStructure will bounce the web and sync processes periodically. The default is every 5 hours. Set to -1 to disable.",defaultValue:300,persisted:!0}),t.reportErrors=new x.BooleanSetting({name:"reportErrors",key:"PS_REPORT_ERRORS",category:x.SettingCategories.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:!1,persisted:!0}),t.maxErrorsPerDay=new x.IntegerSetting({name:"maxErrorsPerDay",key:"PS_MAX_ERRORS_PER_DAY",category:x.SettingCategories.Reporting,description:"Set this to zero to remove all bugs in PhotoStructure.\n\nHUR HUR #DADJOKE\n\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3,persisted:!0}),t.email=new x.StringSetting({name:"email",key:"PS_EMAIL",category:x.SettingCategories.Reporting,description:"If set, this email will be added to error reports, so we can contact you to help debug the issue. It is not required.",defaultValue:"",advanced:!1,persisted:!0}),t.inspect=new x.BooleanSetting({name:"inspect",key:"PS_INSPECT",category:x.SettingCategories.System,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,advanced:!0,persisted:!0}),t.rpcPort=new x.IntegerSetting({name:"rpcPort",key:"PS_RPC_PORT",category:x.SettingCategories.Web,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807,persisted:!0,addToChildProcs:!0}),t.httpPort=new x.IntegerSetting({name:"httpPort",key:"PS_HTTP_PORT",category:x.SettingCategories.Web,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787,persisted:!0,addToChildProcs:!0}),t.sessionTimeoutHours=new x.BoundedIntegerSetting({name:"sessionTimeoutHours",key:"PS_SESSION_TIMEOUT_HOURS",category:x.SettingCategories.Web,description:"How long should unused HTTP sessions exist before requiring visitors to log back in? This defaults to 180 days, just to maximize convenience.",defaultValue:4320,max:8760,min:1,persisted:!0}),t.exposeNetworkWithoutAuth=new x.BooleanSetting({name:"exposeNetworkWithoutAuth",key:"PS_EXPOSE_NETWORK_WITHOUT_AUTH",category:x.SettingCategories.Web,description:"Normally the web service is bound to loopback, so your PhotoStructure library is only accessible to this machine. Setting this to true will expose your library to all computers on your network (if they know your PhotoStructure port). You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n\n** Don't enable this unless you know what you're doing. **",defaultValue:!1,persisted:!0}),t.copyAssetsToLibrary=new x.BooleanSetting({name:"copyAssetsToLibrary",key:"PS_COPY_ASSETS",category:x.SettingCategories.Sync,description:"Should PhotoStructure copy photos and videos to your PhotoStructure Library?",defaultValue:!0,advanced:!1,persisted:!0}),t.scanAllDrives=new x.BooleanSetting({name:"scanAllDrives",key:"PS_SCAN_ALL_DRIVES",category:x.SettingCategories.Sync,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:!1,persisted:!0}),t.scanMyPictures=new x.BooleanSetting({name:"scanMyPictures",key:"PS_SCAN_MY_PICTURES",category:x.SettingCategories.Sync,description:"Should PhotoStructure only scan your system's 'Pictures' folder for photos and videos?",defaultValue:!t.scanAllDrives.defaultValue,advanced:!1,persisted:!0}),t.scanPaths=new x.StringArraySetting({name:"scanPaths",key:"PS_SCAN_PATHS",category:x.SettingCategories.Sync,description:"This holds an array of full native paths to scan for assets.",advanced:!1,persisted:!0}),t.assetSubdirectoryDatestampFormat=new x.StringSetting({name:"assetSubdirectoryDatestampFormat",key:"PS_ASSET_SUBDIR_FORMAT",category:x.SettingCategories.Sync,description:"If you chose to copy assets into your library, they will be copied into <library directory>/<result of this pattern>/<original imagename>.\nSee <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.",defaultValue:"y/y-MM-dd",persisted:!0}),t.validateJpegImages=new x.BooleanSetting({name:"validateJpegImages",key:"PS_VALIDATE_JPEG_IMAGES",category:x.SettingCategories.Sync,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:!1,persisted:!0}),t.validateRawImages=new x.BooleanSetting({name:"validateRawImages",key:"PS_VALIDATE_RAW_IMAGES",category:x.SettingCategories.Sync,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:!1,persisted:!0}),t.validateVideos=new x.BooleanSetting({name:"validateVideos",key:"PS_VALIDATE_VIDEOS",category:x.SettingCategories.Sync,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be "played" to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored. Note that if you set transcodeVideos to true, this setting is effectively true for all videos that aren\'t MP4-encoded.',defaultValue:!0,advanced:!1,persisted:!0}),t.transcodeVideos=new x.BooleanSetting({name:"transcodeVideos",key:"PS_TRANSCODE_VIDEOS",category:x.SettingCategories.Sync,description:"Should videos be transcoded during import? VLC must be installed. Note that this dramatically slows down imports, and *dramatically* increases the disk space your library will need to use. If this is set to false, though, your browser will not be able to render your videos unless they are already MP4-encoded.",defaultValue:!0,persisted:!0}),t.squareThumbStrategy=new x.StringEnumSetting({name:"squareThumbStrategy",key:"PS_SQUARE_THUMB_STRATEGY",category:x.SettingCategories.Sync,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: https://sharp.dimens.io/en/stable/api-resize/',defaultValue:"attention",validValues:["center","entropy","attention"],persisted:!0}),t.sharpen=new x.BooleanSetting({name:"sharpen",key:"PS_SHARPEN",category:x.SettingCategories.Sync,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1,persisted:!0}),t.progressive=new x.BooleanSetting({name:"progressive",key:"PS_PROGRESSIVE",category:x.SettingCategories.Sync,description:"Should preview JPEGs be progressively encoded? If set, syncs will take a bit longer, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0,persisted:!0}),t.previewResolutions=new x.StringEnumsSetting({name:"previewResolutions",key:"PS_PREVIEW_RESOLUTIONS",category:x.SettingCategories.Sync,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:v.exclude(l.FitSizeValues,["uhd8k","uhd5k"]),validValues:l.FitSizeValues,persisted:!0}),t.statTimeoutSeconds=new x.BoundedIntegerSetting({name:"statTimeoutSeconds",key:"PS_STAT_TIMEOUT_SECONDS",category:x.SettingCategories.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300,persisted:!0}),t.minFileSizeBytes=new x.IntegerSetting({name:"minFileSizeBytes",key:"PS_MIN_ASSET_SIZE",category:x.SettingCategories.Sync,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*p.KB,persisted:!0}),t.maxFileSizeBytes=new x.IntegerSetting({name:"maxFileSizeBytes",key:"PS_MAX_ASSET_SIZE",category:x.SettingCategories.Sync,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library)",defaultValue:.5*p.GB,persisted:!0}),t.requireMakeModel=new x.BooleanSetting({name:"requireMakeModel",key:"PS_REQUIRE_MAKE_MODEL",category:x.SettingCategories.Sync,description:"Normally PhotoStructure requires images to have an EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!0,persisted:!0}),t.minImageDimension=new x.IntegerSetting({name:"minImageDimension",key:"PS_MIN_IMAGE_DIMENSION",category:x.SettingCategories.Sync,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480,persisted:!0}),t.minVideoDimension=new x.IntegerSetting({name:"minVideoDimension",key:"PS_MIN_VIDEO_DIMENSION",category:x.SettingCategories.Sync,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240,persisted:!0}),t.neverIgnored=new x.StringArraySetting({name:"neverIgnored",key:"PS_NEVER_IGNORED",category:x.SettingCategories.Sync,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files.",persisted:!0}),t.startPaused=new x.BooleanSetting({name:"startPaused",key:"PS_START_PAUSED",category:x.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray menu.",defaultValue:!1,persisted:!0}),t.syncIntervalHours=new x.BoundedIntegerSetting({name:"syncIntervalHours",key:"PS_SYNC_INTERVAL_HOURS",category:x.SettingCategories.Sync,description:"This value controls both how often the sync process runs, and how often new files are discovered and imported. WARNING: Setting this value to a small value (say, less than 10) will mean PhotoStructure is constantly scanning your disks, which may reduce the lifespan of your storage media. Note that setting this and fileSyncIntervalHours to 0 will disable automatic scheduling of the sync process. This defaults to every day (to balance picking up new files automatically and trying to avoid unnecessary wear and tear on your storage media).",defaultValue:24,max:504,min:0,persisted:!0}),t.fileSyncIntervalHours=new x.BoundedIntegerSetting({name:"fileSyncIntervalHours",key:"PS_FILE_SYNC_INTERVAL_HOURS",category:x.SettingCategories.Sync,description:"This value controls how often the files in your library are checked for changes. The `syncIntervalHours` setting, in contrast, controls how often *new* files are discovered. This defaults to every week (to try to balance picking up changes with wear and tear on your storage media)",defaultValue:168,max:1344,min:0,persisted:!0}),t.forceSync=new x.BooleanSetting({name:"forceSync",key:"PS_FORCE_SYNC",category:x.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem",defaultValue:!1,persisted:!1}),t.defaultSidecarType=new x.StringEnumSetting({name:"defaultSidecarType",key:"PS_DEFAULT_SIDECAR_TYPE",category:x.SettingCategories.Sync,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:f.strEnumValues(P.SidecarExtsEnum),persisted:!0}),t.writeMetadataToSidecars=new x.BooleanSetting({name:"writeMetadataToSidecars",key:"PS_WRITE_METADATA_TO_SIDECARS",category:x.SettingCategories.Sync,description:"Should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original?",defaultValue:!0,persisted:!0}),t.useImageHashes=new x.BooleanSetting({name:"useImageHashes",key:"PS_USE_IMAGE_HASHES",category:x.SettingCategories.Sync,description:"Should image hashes be computed? This slows down imports, but supports more robust asset merging heuristcs, and allows color-based browsing",defaultValue:!0,persisted:!0}),t.minImageCorrPct=new x.BoundedIntegerSetting({name:"minImageCorrPct",key:"PS_MIN_IMAGE_CORR_PCT",category:x.SettingCategories.Sync,description:"This is the minimum image hash correlation value for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires strong image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 60% is fairly low image correlation, and can lead to false positives.",defaultValue:80,max:100,min:0,persisted:!0}),t.minDominantColorCorrPct=new x.BoundedIntegerSetting({name:"minDominantColorCorrPct",key:"PS_MIN_DOMINANT_COLOR_CORR_PCT",category:x.SettingCategories.Sync,description:"This is the minimum jaccard correlation found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires strong dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 40% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:60,max:100,min:0,persisted:!0})}(E=e.Settings||(e.Settings={})),e.envSuggestedPathsKey="SUGGESTED_PATHS",e.envSkipFiltersKey="PS_SKIP_FILTERS",e.envSkipFilters=y.truthy(s.env[e.envSkipFiltersKey]),e.DefaultPaths=Object.freeze(M.isWin?[s.env.SYSTEMROOT,r.join(s.env.SYSTEMROOT,"System32"),r.join(s.env.SYSTEMROOT,"System32","webm")]:["/usr/local/sbin","/usr/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),e.withDefaultPaths=_,e.pathWithDefaults=c.lazy(()=>_(s.env.PATH)),e.persistedSystemSettings=c.lazy(()=>h.values(E).filter(t=>t.opts.persisted&&x.SystemCategories.includes(t.category))),e.persistedLibrarySettings=c.lazy(()=>h.values(E).filter(t=>t.opts.persisted&&x.LibraryCategories.includes(t.category))),e.settingsForChildProcs=c.lazy(()=>h.values(E).filter(t=>t.addToChildProcs)),e.psenv=function(){const t=h.values(E).map(t=>t.key);return h.sortedKeys(h.filter(s.env,e=>"nodeEnv"===e||t.includes(e)))},e.childEnv=O,e.spawnOptions=function(t){const e=d.orElse(t,{});return Object.assign(Object.assign({},e),{env:O(e.env),detached:!1,shell:!1})}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(2),o=n(0),a=n(6),u=n(9),l=n(21);function c(t){return o.defined(t)&&t.every(o.defined)}function d(t,e){const n=t.length;return r.filterInPlace(t,t=>t!==e),n!==t.length}function h(t,e,n=1,i=l.identity){const r=[];if(t<e)for(let s=t;s<e;s+=n)r.push(i(s));else for(let s=t;s>e;s-=n)r.push(i(s));return r}function f(...t){const e=Math.max(...t.map(t=>t.length));return a.times(e,e=>t.map(t=>t[e]))}function p(t){return y(t,(t,e)=>t.valueOf()<e.valueOf())}function m(t){return v(t,t=>t.valueOf())}function g(t,e){return y(t,(t,n)=>o.map(e(t),t=>o.map(e(n),e=>t<e)))}function v(t,e){return y(t,(t,n)=>o.map(e(t),t=>o.map(e(n),e=>t>e)))}function y(t,e){let n,i=-1;for(let r=0;r<t.length;r++)o.map(t[r],t=>{null!=n&&!0!==e(t,n)||(i=r,n=t)});return i}function b(t,e,n=!1){return i(this,void 0,void 0,(function*(){const i=[];t:for(const r of t){for(const t of i)if(n){if(yield S(t,t=>e(r,t))){t.push(r);continue t}}else if(yield w(t,t=>e(r,t))){t.push(r);continue t}i.push([r])}return i}))}function w(t,e){return i(this,void 0,void 0,(function*(){if(null!=t)for(let n=0;n<t.length;n++)if(yield e(t[n],n))return!0;return!1}))}function S(t,e){return i(this,void 0,void 0,(function*(){if(null!=t)for(let n=0;n<t.length;n++)if(!(yield e(t[n],n)))return!1;return!0}))}e.allDefined=c,e.mapAllDefined=function(t,e){return c(t)?e(t):void 0},e.mapAll=function(t,e){return c(t)?e(t):void 0},e.allNotDefined=function(t){return null==t||t.every(t=>null==t)},e.allNotBlank=function(...t){return null!=t&&t.every(s.notBlank)},e.anyNotDefined=function(t){return null==t||t.some(t=>null==t)},e.anyDefined=function(t){return null!=t&&t.some(t=>null!=t)},e.first=function(t,e){if(null!=t)for(const n of r.compact(t)){const t=e(n);if(null!=t)return t}},e.firstNonEmptyThunk=function(...t){for(const e of t){const t=e();if(r.isNotEmpty(t))return t}},e.concat=function(...t){const e=[];for(const n of t)if(Array.isArray(n))for(const t of n)null!=t&&e.push(t);else null!=n&&e.push(n);return e},e.exclude=function(t,e){if(e.length<50)return t.filter(t=>!e.includes(t));{const n=new Set(e);return t.filter(t=>!n.has(t))}},e.remove=d,e.moveToEnd=function(t,e){return d(t,e),t.push(e),t},e.diff=function(t,e){const n=new Set(e.map(t=>t.valueOf()));return t.filter(t=>!n.has(t.valueOf()))},e.intersect=function(t,e){const n=new Set(e.map(t=>t.valueOf()));return t.filter(t=>n.has(t.valueOf()))},e.eqlContents=function(t,e){return f(r.sort(t),r.sort(e)).every(([t,e])=>t===e)},e.removeFirst=function(t,e){const n=t.findIndex(e);return n>=0?t.splice(n,1)[0]:void 0},e.uniqInPlace=function(t){r.filterInPlace(t,(e,n)=>t.indexOf(e)===n)},e.partition=function(t,e){const n=[],i=[];return t.forEach((t,r)=>(e(t,r)?n:i).push(t)),[n,i]},e.uniqCount=function(t){return function t(e){if(null==e||0===e.length)return[];const n=e[0];const i=e.lastIndexOf(n);return[{t:n,count:i+1},...t(e.slice(i+1))]}(t.sort())},e.mapCompact=function(t,e){return r.compact(r.compact(t).map(e))},e.toMapEntries=function(t,e){return new Map(t.map(e).filter(o.defined))},e.flatMap=function(t,e){return t.reduce((t,n)=>t.concat(e(n)),[])},e.range=function(t,e,n=l.identity){return h(t,e,1,n)},e.stepRange=h,e.retainLastN=function(t,e){return t.length>e&&t.splice(0,t.length-e),t},e.retainFirstN=function(t,e){return t.length=Math.min(t.length,e),t},e.contextAround=function(t,e,n,i){const r=t.findIndex(i);if(-1!==r){return{before:0===r?[]:t.slice(Math.max(0,r-e),r),after:r===t.length-1?[]:t.slice(r+1,Math.min(r+1+n,t.length))}}},e.zip=f,e.flatZip=function(...t){const e=Math.max(...t.map(t=>t.length)),n=[];return a.times(e,e=>t.map(t=>n.push(t[e]))),n},e.unzip=function(t){return[t.map(([t])=>t),t.map(([,t])=>t)]},e.ancestry=function(t){return a.times(t.length,e=>t.slice(0,e+1))},e.leastIndex=p,e.greatestIndex=m,e.min=function(t){return t[p(t)]},e.max=function(t){return t[m(t)]},e.leastIndexBy=g,e.greatestIndexBy=v,e.leastBy=function(t,e){return t[g(t,e)]},e.greatestBy=function(t,e){return t[v(t,e)]},e.combinations=function*t(e,n){if(!(null==e||e.length<n))for(let i=0;i<e.length;i++)if(1===n)yield[e[i]];else for(const r of t(e.slice(i+1),n-1))yield[e[i],...r]},e.reverse=function(t){const e=[];for(let n=t.length-1;n>=0;n--)e.push(t[n]);return e},e.batches=function(t,e){return e<=0&&(e=1),h(0,t.length,e,n=>t.slice(n,n+e))},e.contextFilter=function(t,e){let n;return t.filter((t,i)=>u.tap(e(t,i,n),e=>{e&&(n=t)}))},e.mergesort=function(t,e){return t.reduce((t,n)=>(function(t,e,n){const i=[],s=r.isEmpty(t),o=r.isEmpty(e);if(s&&o)return[];if(s)return e;if(o)return t;let a=0,u=0;for(;a<t.length||u<e.length;){for(;a<t.length&&!0!==n(e[u],t[a]);)i.push(t[a++]);for(;u<e.length&&!0!==n(t[a],e[u]);)i.push(e[u++])}return i})(t,n,e),[])},e.clusterStrictAsync=function(t,e){return i(this,void 0,void 0,(function*(){return b(t,e,!0)}))},e.clusterAsync=b,e.someAsync=w,e.everyAsync=S,e.firstAsync=function(t,e){return i(this,void 0,void 0,(function*(){if(null!=t){let n=-1;for(const i of t){n++;try{if(null==i)continue;const t=yield e(i,n);if(null!=t)return t}catch(t){}}}}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=new(n(199).EventEmitter);i.setMaxListeners(50),e.eventEmitter=i,e.emitBoom=function(){e.eventEmitter.emit("boom")},e.onBoom=function(t){e.eventEmitter.on("boom",t)},e.emitClearCache=function(){e.eventEmitter.emit("clearCache")},e.onClearCache=function(t){e.eventEmitter.on("clearCache",t)},e.emitIdle=function(){e.eventEmitter.emit("idle")},e.onIdle=function(t){e.eventEmitter.on("idle",t)},e.emitMigration=function(t){e.eventEmitter.emit("migration",t)},e.onMigration=function(t){e.eventEmitter.on("migration",t)},e.emitPause=function(){e.eventEmitter.emit("pause")},e.onPause=function(t){e.eventEmitter.on("pause",t)},e.emitResume=function(){e.eventEmitter.emit("resume")},e.onResume=function(t){e.eventEmitter.on("resume",t)},e.emitFileChanged=function(t){e.eventEmitter.emit("fileChanged",t)},e.onFileCopied=function(t){e.eventEmitter.on("fileCopied",t)},e.emitFileCopied=function(t,n){e.eventEmitter.emit("fileCopied",t,n)},e.onFileChanged=function(t){e.eventEmitter.on("fileChanged",t)},e.emitFocus=function(t,n){e.eventEmitter.emit("focus",t,n)},e.onFocus=function(t){e.eventEmitter.on("focus",t)},e.onFatal=function(t){e.eventEmitter.on("fatal",({message:e,error:n})=>t(e,n))},e.onNonFatal=function(t){e.eventEmitter.on("nonFatal",({message:e,error:n})=>t(e,n))},e.emitRpcServerChange=function(){e.eventEmitter.emit("rpcServerChange")},e.onRpcServerChange=function(t){e.eventEmitter.on("rpcServerChange",t)},e.readyToUpdate=!1,e.emitReadyToUpdate=function(){e.readyToUpdate=!0,e.eventEmitter.emit("readyToUpdate")},e.onReadyToUpdate=function(t){e.eventEmitter.on("readyToUpdate",t)},e.emitVolumesChanged=function(){e.eventEmitter.emit("volumesChanged")},e.onVolumesChanged=function(t){e.eventEmitter.on("volumesChanged",t)},e.emitSaveProgress=function(){e.eventEmitter.emit("saveProgress")},e.onSaveProgress=function(t){e.eventEmitter.on("saveProgress",t)}},function(t,e,n){"use strict";var i;Object.defineProperty(e,"__esModule",{value:!0}),function(t){t.isDefined=!1,t.isEmpty=!0,t.get=function(){},t.exists=()=>!1;const e=()=>t;t.map=e,t.flatMap=e,t.filter=e,t.forEach=e,t.getOrElse=function(t){return t()},t.orElse=function(t){return s(t())},t.zip1=e,t.zip2=e,t.zip3=e}(i||(i={})),e.None=i;class r{constructor(t){this.a=t,this.isDefined=!0,this.isEmpty=!1}get(){return this.a}exists(t){return t(this.a)}map(t){return new r(t(this.a))}flatMap(t){const e=t(this.a);return o(e)?e:s(e)}filter(t){return s(t(this.a)?this.a:void 0)}forEach(t){return t(this.a),this}getOrElse(t){return this.a}orElse(t){return this}zip1(t,e){return s(t).flatMap(t=>e(this.a,t))}zip2(t,e,n){return s(t).flatMap(t=>s(e).flatMap(e=>n(this.a,t,e)))}zip3(t,e,n,i){return s(t).flatMap(t=>s(e).flatMap(e=>s(n).flatMap(n=>i(this.a,t,e,n))))}}function s(t){return o(t)?t:null!=t?new r(t):e.None}function o(t){return t instanceof r||t===e.None}e.Some=r,e.Opt=s,e.isOpt=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(5),o=n(47),a=n(4),u=n(14),l=n(8),c=n(22),d=n(13),h=n(3),f=n(79),p=n(11),m=n(10),g=a.lazy(()=>h.mkLogger("Error"));e.FatalErrorFlag="¹",e.NonRetriableErrorFlag="²",e.IgnorableErrorFlag="³",e.PleaseSendErrorFlag="⁴",e.ErrorFlags=[e.FatalErrorFlag,e.NonRetriableErrorFlag,e.IgnorableErrorFlag,e.PleaseSendErrorFlag];const v=new RegExp("["+e.ErrorFlags.join("")+"]","g");e.removeErrorFlags=function(t){return t.replace(v,"")},e.hasErrorFlag=function(t){return e.ErrorFlags.some(e=>t.includes(e))};const y=new f.Rate(s.minuteMs);function b(t,e,n){y.onEvent();const i=null!=n&&!0===n.fatal||S(t)||S(e)||y.eventsPerMinute>p.Settings.fatalErrorRatePerMinute.valueOrDefault;if(!i&&(M(t)||M(e)))return;const r=i?"fatal":"nonFatal";g().warn("onError()",Object.assign({event:r,message:t,error:e},n)),d.eventEmitter.emit(r,{message:t,error:e})}e.onFatalError=function(t,e,n){return b(t,e,Object.assign(Object.assign({},n),{fatal:!0}))},e.onError=b;const w=new RegExp("SQLITE_IOERR|SQLITE_ERROR|Error: Cannot find module|"+e.FatalErrorFlag,"i");function S(t){return null!=t&&(!!(t instanceof P&&t.fatal)||null!=w.exec(o.errorToS(t)))}function M(t){return c.ending()||!S(t)&&m.includesIgnoreCase([e.IgnorableErrorFlag,"0 output files created","called while not idle","diskutil: interrupted","net::ERR_","debugger listening on","for help","https://nodejs.org/en/docs/inspector","debugger attached"],o.errorToS(t))}e.isFatalError=S,e.isRetriableError=function(t){return!S(t)&&!o.errorToS(t).includes(e.NonRetriableErrorFlag)&&(!(t instanceof P)||t.retriable)},e.isSendableError=function(t){return o.errorToS(t).includes(e.PleaseSendErrorFlag)},e.isIgnorableError=M,e.throws=function(t){try{return t(),!1}catch(t){return!0}},e.stack=function t(){const e={};return Error.captureStackTrace(e,t),e.stack.split(/\n(?:\s*at\s+)?/).slice(1)},e.trimErrorMessage=function(t){return l.toS(t).trim().replace(/^Error: /i,"").trim().replace(/^[0-9T\.: -]+Z? /i,"").replace(/^error /i,"").trim()},e.cleanError=function(t,e){return l.toS(t).split(/\r?\n/).map(t=>m.stripPrefix(t,e)).map(t=>t.replace(/: ?/,"")).filter(r.notBlank).join(", ")};class P extends Error{constructor({cause:t,message:n,retriable:s=!0,ignorable:o=!1,fatal:a=!1}){super(function(t,n,s,o,a){const c=[t];u.Opt(n).flatMap(t=>t.message).flatMap(t=>m.stripPrefix(t,"Error: ")).forEach(t=>c.push(t));const d=i.compactBlanks(c).map(t=>l.toS(t).trim()).filter(r.notBlank).join(": "),h=[];a||s||h.push(e.NonRetriableErrorFlag);o&&!a&&h.push(e.IgnorableErrorFlag);a&&h.push(e.FatalErrorFlag);i.isNotEmpty(h)&&h.unshift(" ");return d+h.join("")}(n,t,s,o,a)),this.cause=t,this.retriable=s,this.fatal=a}}e.WrappedError=P},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(0),o=n(6),a=n(28),u=n(10),l=t=>(e,n)=>o.isNumber(e)&&o.isNumber(n)&&t(e,n);e.lt=l((t,e)=>t<e),e.lte=l((t,e)=>t<=e),e.gt=l((t,e)=>t>e),e.gte=l((t,e)=>t>=e),e.firstGt0=function(...t){return t.find(o.gt0)},e.firstNonZero=function(...t){for(const e of i.flatten(t)){const t=o.toFloat(e);if(null!=t&&0!==t)return t}},e.mapGte0=function(t,e){return o.mapInt(t,t=>t>=0?e(t):void 0)},e.mapGt0=function(t,e){return o.mapInt(t,t=>t>0?e(t):void 0)},e.within=function(t,n,i){return null!=i&&([t,n]=[Math.min(t,n),Math.max(t,n)],e.gte(i,t)&&e.lte(i,n))};const c=/[+-]?[0-9\.]/;function d(t){if(o.isNumber(t))return t;if(r.blank(t))return;const e=String(t);return s.map(c.exec(e),t=>o.toFloat(e.substr(t.index)))}e.extractInt=function(t){return o.toInt(d(t))},e.extractFloat=d,e.closeTo=function(t,e,n){return Math.abs(t-e)<n},e.assertPositive=function(t,e){if(null==e||e<=0)throw new Error(t+" must be positive")},e.plur=function(t,e,n=e+"s"){return a.fmt(t)+" "+(1===t?e:n)};function h(t,e){if(null==t||null==e)return;const n=[t,e].map(t=>t.toString(2)),i=Math.max(...n.map(t=>t.length));return n.map(t=>u.leftPad(t,i,"0"))}e.Array2D=class{constructor(t){this.columns=t,this.store=[]}get(t,e){return t<0||e<0?0:s.orElse(this.store[t*this.columns+e],()=>0)}set(t,e,n){this.store[t*this.columns+e]=n}},e.hammingDistanceBigInt=function(t,e){return s.map(h(t,e),([t,e])=>i.count(t.split(""),(t,n)=>t!==e.charAt(n)))},e.hammRatioBigInt=function(t,e){return s.map(h(t,e),([t,e])=>{const n=t.length;return i.count(t.split(""),(t,n)=>t===e.charAt(n))/n})},e.valuesToBigInt=function(t,e){return i.isEmpty(t)?BigInt(0):BigInt("0b0"+t.map(t=>u.leftPad(t.toString(2),e-1,"0")).join(""))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(160),s=n(19),o=n(36),a=n(5),u=n(39),l=n(4),c=n(0),d=n(6),h=n(9),f=n(33),p=n(8),m=n(42),g=n(7),v=n(15),y=n(63),b=n(3),w=n(21),S=n(74),M=n(23),P=n(11),x=n(10),E=l.lazy(()=>b.mkLogger("ChildProcess"));function _(t){return h.pick(t,"pid","killed","connected","exitCode","signalCode")}function O(t,e,n){const r=new Date;let u=!1;return t.on("exit",()=>u=!0),o.setTimeout(()=>i(this,void 0,void 0,(function*(){if(u)return;yield g.until(()=>d.gt0(t.pid),a.secondMs);const i=t.pid;return d.gt0(i)?S.addPid({pid:i,cmd:e,maxAgeMs:n,ppid:s.pid},r):void E().warn("newProc(): not writing pidfile, child_process has no pid",{cmd:e,cp:_(t)})})),M.isWin?500:250),t}function T(t,e,n,i){return O(r.execFile(t,e,P.spawnOptions(i)),t,n)}function F(t,e,n){return i(this,void 0,void 0,(function*(){const i=c.orElse(n.quiet,!1),r=c.orElse(n.ignoreStderr,!1),s=c.orElse(n.ignoreExitCode,!1);let a="";E().debug("stdoutResult(): execFile",{cmd:t,args:e,opts:n});const u=yield T(t,e,n.timeout,h.without(n,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(!0===n.disconnect)return u.disconnect(),{result:"",pid:u.pid};const l=JSON.stringify({cmd:t,args:e}),d=new m.Deferred(l);o.setTimeout(()=>{d.pending&&E().warn("stdoutResult(): SLOW COMMAND",{cmd:t,args:e})},n.timeout/3).unref(),d.setTimeout(n.timeout);const g=(r,s)=>{v.isIgnorableError(s)||f.isFunction(n.isIgnorableError)&&n.isIgnorableError(s)?E().debug("stdoutResult(): ignorable error for "+r,{cmd:t,args:e,opts:n,error:s}):(null!=u.pid&&k(u),i||E().warn("stdoutResult(): "+r,{cmd:t,args:e,opts:n,error:s}),d.pending&&d.reject(s))};try{u.on("error",t=>g("on(error)",t)),u.on("close",n=>{const r=Date.now()-d.start,o=0!==n?"warn":"debug";i||E().log(o,"stdoutResult(): on(close)",{cmd:t,code:n,args:e,elapsedMs:r,result:x.gist(a,160,160)}),s||0===n?d.resolve({result:a,code:n,pid:u.pid}):d.reject(new Error("non-zero exit code: "+JSON.stringify({code:n,cmd:t,args:e})))}),u.stdin.end(),u.stdout.on("data",t=>c.map(t,t=>{a+=t.toString()})),u.stderr.on("error",t=>g("stderr(error)",t)),u.stderr.on("data",t=>r?E().warn("stdoutResult(): stderr(data): "+p.toS(t)):g("stderr(data)",t))}catch(t){g("try/catch",t)}return d.promise}))}function k(t,e=30*a.secondMs){return i(this,void 0,void 0,(function*(){if(null==t)return!1;const n=t.pid;if(E().debug("endProcess("+n+")",{killed:t.killed,connected:t.connected}),!t.killed){if(n<=0)return E().warn("endProcess(): asked to end invalid pid",_(t)),!1;if(n===s.pid)return E().warn("endProcess(): asked to end MY pid",_(t)),!1;w.Try(()=>t.kill())}return yield u.delay(250),yield y.closeStreams(t),t.connected&&w.Try(()=>t.disconnect()),w.Try(()=>t.unref()),(yield A(n,e))?(E().debug("endProcess(): exitted",_(t)),!0):(yield S.kill(n,!0).catch(t=>{E().warn("endProcess(): kill("+n+",true) failed: "+t)}),A(n,5e3))}))}function A(t,e){return g.until(()=>g.thenNot(S.pidExists(t)),e)}e.spawn=function(t,e,n,i){return E().debug("spawn()",{command:t,args:e,maxAgeMs:n,options:i}),O(r.spawn(t,e,P.spawnOptions(i)),t,n)},e.execFile=T,e.stdout=function(t,e,n){return F(t,e,n).then(t=>t.result)},e.stdoutResult=F,e.endProcess=k,e.waitForExit=A},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(86),s=n(1),o=n(2),a=n(5),u=n(46),l=n(0),c=n(6),d=n(14),h=n(69),f=n(113),p=n(41),m=n(16),g=n(21),v=n(10);function y(t){return t instanceof Date}function b(t,e=5*a.secondMs){return c.gt0(t)&&Date.now()-t<=e}function w(t,e=2){return v.leftPad(t,e,"0")}function S(t,e,n){return t<1?void 0:m.plur(t,e,n)}function M(t,e=2){if(!c.gte0(t))return c.isNumber(t)?"-"+M(Math.abs(t),e):"";const n=[S(Math.floor(t/a.dayMs),"day","days"),S(Math.floor(t/a.hourMs)%24,"hour","hours"),S(Math.floor(t/a.minuteMs)%60,"minute","minutes"),S(Math.floor(t/a.secondMs)%60,"second","seconds")],i=n.findIndex(t=>null!=t);return s.compact(n.slice(i,i+e)).join(", ")}e.isDate=y,e.cmpDate=function(t,e){const n=l.mapOr(t,t=>t.getTime(),()=>0),i=l.mapOr(e,t=>t.getTime(),()=>0);return h.cmp(n,i)},e.unixtime=function(t){const e=y(t)?t.getTime():c.isNumber(t)?t:void 0;return l.map(e,t=>Math.floor(t/1e3))},e.ago=function(t,e){return new Date(l.orElse(e,new Date).getTime()-t)},e.closeTo=function(t,e,n){return null!=t&&null!=e&&Math.abs(t.getTime()-e.getTime())<=n},e.recent=function(t,e=5*a.secondMs){return b(l.map(t,t=>p.datedToMillis(t)),e)},e.isRecentMs=b,e.elapsed=function(t){const e=Date.now(),n=t();return{elapsedMs:Date.now()-e,result:n}},e.elapsedAsync=function(t){return i(this,void 0,void 0,(function*(){const e=Date.now(),n=yield t();return{elapsedMs:Date.now()-e,result:n}}))},e.thenElapsed=function(t){return i(this,void 0,void 0,(function*(){const e=Date.now(),n=yield t;return{elapsedMs:Date.now()-e,result:n}}))},e.datestamp=function(t=new Date){return t.getFullYear()+"-"+w(t.getMonth()+1)+"-"+w(t.getDate())},e.datestampUTC=function(t=new Date){return t.getUTCFullYear()+"-"+w(t.getUTCMonth()+1)+"-"+w(t.getUTCDate())},e.filestamp=function(t=new Date){return[t.getFullYear(),w(t.getMonth()+1),w(t.getDate()),"-",w(t.getHours()),w(t.getMinutes()),w(t.getSeconds())].join("")},e.filestampUTC=function(t=new Date){return[t.getUTCFullYear(),w(t.getUTCMonth()+1),w(t.getUTCDate()),"-",w(t.getUTCHours()),w(t.getUTCMinutes()),w(t.getUTCSeconds())].join("")},e.fmtMs=function(t,e=2){return t<10*a.secondMs?Number(t).toLocaleString()+"ms":M(t,e)},e.fmtDuration=M;const P=new Map;function x(t,e,n=r.DateTime.DATETIME_MED){return p.mapValidDate(t,t=>(o.mapNotBlank(e,e=>t=t.setLocale(e)),t.toLocaleString(n)))}e.fmtDateTime=x,e.fmtIsoDate=function(t,e,n=r.DateTime.DATETIME_MED){return d.Opt(r.DateTime.fromISO(t,{setZone:!0})).filter(p.validDate).orElse(()=>l.map(f.DateInterval.fromISO(t),t=>t.middle.toDateTime())).map(t=>x(t,e,n)).getOrElse(()=>t)},e.isoNow=function(){return(new Date).toISOString()},e.fmtShort=function(t,e="en-US"){return u.getOrSet(P,e,()=>new Intl.DateTimeFormat(e,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(p.datedToMillis(t))};const E=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;e.wmiDate=function(t){const e=E.exec(t);if(null==e)return;const n=e.slice(1,8).map(t=>c.toInt(t));if(!l.allDefined(n))return;const[i,r,s,o,u,d,h]=n,f=c.toInt(e[8],{defaultValue:0});return new Date(Date.UTC(i,r-1,s,o,u,d,h/1e3)-f*a.minuteMs)};const _=/Date\((\d+)\)/;function O(t){if(!o.blank(t))return d.Opt(r.DateTime.fromISO(v.removeCapture(t,F),{setZone:!0})).filter(t=>t.isValid).orElse(()=>l.map(f.DateInterval.fromISO(t),t=>t.middle.toDateTime())).get()}function T(t){return null!=t&&t.isValid?l.map(c.toInt(t.toFormat("yMMddHHmmss")),e=>100*e+Math.floor(t.millisecond/10)):void 0}e.pwshJsonDate=function(t){return d.Opt(t).flatMap(t=>_.exec(t)).flatMap(t=>t[1]).flatMap(c.toInt).filter(t=>m.within(0,Date.now()+a.dayMs,t)).map(t=>new Date(t)).get()},e.MaxTzOffsetHours=14,e.isoToDateTime=O,e.dateTimeToLocal=T;const F=/\.\d\d\d(\d+)/;e.isoToLocal=function(t){return l.map(O(t),T)};const k=/^\d{1,4}-\d{2}-\d{2}$/;function A(t,e){if(null==t||t<0)return;let n=t;const i=()=>{const t=n%100;return n=Math.floor(n/100),t},s=10*i(),o=i(),a=i(),u=i(),c=i(),d=i();return{year:n,month:d,day:c,hour:u,minute:a,second:o,millisecond:s,zone:l.map(e,t=>r.Info.normalizeZone(t))}}function I(t,e){return l.map(A(t,e),t=>r.DateTime.fromObject(t))}e.isoToPrecisionMs=function(t){return o.mapNotBlank(t,t=>g.firstThunk(()=>l.map(f.DateInterval.fromISO(t),t=>t.intervalMs),()=>d.Opt(t.match(k)).flatMap(()=>r.DateTime.fromISO(t)).filter(p.validDate).map(()=>a.dayMs).get(),()=>d.Opt(r.DateTime.fromISO(t)).filter(p.validDate).map(()=>0).get()))},e.localToDateObject=A,e.localToDateTime=I,e.localToMs=function(t,e){return l.map(I(t,e),t=>t.toMillis())},e.msToLocal=function(t){const e=[];for(const n of[a.dayMs,a.hourMs,a.minuteMs,a.secondMs]){const i=Math.floor(t/n);e.push(w(i)),t-=i*n}return e.push(w(Math.floor(t/10))),c.toInt(e.join(""))},e.localPlusMs=function(t,e){return T(I(t).plus(e))}},function(t,e){t.exports=require("process")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(107);e.toA=function(t){return null==t?[]:i.isIterable(t)?Array.from(t):Array.isArray(t)?t:[t]}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(9),o=n(69),a=n(12),u=n(18);function l(t,e){try{return t()}catch(t){return null!=e?e(t):void 0}}function c(t){return s.keys(t).filter(e=>o.isPrimitive(t[e])||u.isDate(t[e])).map(e=>[e,t[e]])}e.definedThunks=function(...t){return t.every(t=>r.defined(t()))},e.firstThunk=function(...t){for(const e of t){const t=e();if(null!=t)return t}},e.firstTrueThunk=function(t,e){for(const n of t){const t=n();if(null!=t&&(null==e||e(t)))return t}},e.firstDefined=function(...t){return t.find(r.defined)},e.firstDefinedField=function(t,...e){return r.map(e.find(e=>null!=t[e]),e=>t[e])},e.firstFieldLike=function(t,e){return a.first(s.keys(t),n=>e(n,t[n])?t[n]:void 0)},e.ornull=function(t){return void 0===t?null:t},e.mapAnd=function(t,e){return null!=t&&e(t)},e.mapOrThrow=function(t,e,n){if(null!=t)return e(t);throw new Error(n)},e.Try=l,e.tryEach=function(t,e){[...t].forEach(t=>l(()=>e(t)))},e.identity=function(t){return t},e.ctor=function(t){return r.map(t.constructor,t=>t.name)},e.hasKeys=function(t){return Object.keys(t).some(e=>"string"==typeof e&&t.propertyIsEnumerable(e))},e.primitiveEntries=c,e.spread=function(t,...e){return Object.assign({},t,...i.compact(e))},e.assignMissingPrimitives=function(t,e){if(null==e)return t;for(const[n,i]of c(e))null==t[n]&&(t[n]=i);return t},e.pickMap=function(t,e,n){const i={};for(const r of e)i[r]=n(r,t[r]);return i},e.mapEntries=function(t,e){const n={};for(const i of s.keys(t))n[i]=e(i,t[i]);return n}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(5),o=n(4),a=n(0),u=n(9),l=n(35),c=n(66),d=n(3),h=n(72),f=n(16),p=n(25),m=n(7),g=n(59),v=o.lazy(()=>d.mkSafeLogger(c.red("Endable")));e.EndableWrapper=class{constructor(t,e,n){this.name=t,this._onEnd=e,this._isEnded=n,this._ended=!1}get ended(){return a.mapOr(this._isEnded,t=>t(),()=>!1)||this._ended}end(){return this._ended=!0,this._onEnd()}};const y=new h.MultiMap;g.setUnrefInterval(()=>x(),1*s.minuteMs);const b=new Map,w=5*s.secondMs;function S(t,e){return y.add(t,e),e}e.EndableRanks=l.strEnum("first","service","cleanup","db","logger"),e.addFirstEndable=function(t){return S(e.EndableRanks.first,t)},b.set(e.EndableRanks.first,5*s.secondMs),e.addServiceEndable=function(t){return S(e.EndableRanks.service,t)},e.addCleanupEndable=function(t){return S(e.EndableRanks.cleanup,t)},b.set(e.EndableRanks.cleanup,1*s.minuteMs),e.addDbEndable=function(t){return S(e.EndableRanks.db,t)},e.addLoggerEndable=function(t){return S(e.EndableRanks.logger,t)},b.set(e.EndableRanks.logger,10*s.secondMs),e.addEndable=S;let M=!1;function P(t,e=m.DefaultTryAllTimeoutMs){if(null!=t&&!t.ended)return v().debug(c.magenta(t.name+" ending...")),m.thenOrTimeout(t.end(),e,()=>v().warn(c.magenta(t.name+".end() timed out")),()=>v().debug(c.magenta(t.name+".end() completed"))).catch(e=>{v().warn(c.magenta(t.name+".end() rejected: ")+e)})}function x(){y.filterInPlace((t,e)=>!e.ended),v().debug("vacuumEndables()",y.entriesArray().map(([t,e])=>[t,e.map(t=>t.name)]))}e.ending=function(){return M},e.setEnding=function(t){if(!p.isTest)throw new Error("cannot set ending");M=t},e.end=P,e.endEndables=o.lazy(()=>i(void 0,void 0,void 0,(function*(){p.isTest||(M=!0),x();for(const t of u.keys(e.EndableRanks)){const e=a.orElse(y.get(t),[]);if(r.isNotEmpty(e)){v().debug(c.magenta("endEndables(): ending "+t));const n=f.firstGt0(b.get(t),w);yield Promise.all(e.map(t=>P(t,n)))}}})))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(55),r=n(43),s=n(19),o=n(2),a=n(4),u=n(26),l=r.platform();e.inspectFlag=s.argv.includes("--inspect")||u.truthy(s.env.NODE_INSPECT),e.isWin=l.startsWith("win"),e.isWinStore=e.isWin&&u.truthy(s.windowsStore),e.isWinPortable=e.isWin&&o.notBlank(s.env.PORTABLE_EXECUTABLE_DIR),e.isMac="darwin"===l,e.isMacStore=e.isMac&&u.truthy(s.mas),e.isLinux="linux"===l,e.isLinux_x64=e.isLinux&&"x64"===r.arch(),e.isLinuxAppImage=e.isLinux&&o.notBlank(s.env.APPIMAGE),e.isLinuxSnap=e.isLinux&&o.notBlank(s.env.SNAP_USER_DATA),e.isPosix=e.isMac||e.isLinux,e.isDocker=a.lazy(()=>{try{return e.isLinux&&i.readFileSync("/proc/1/cgroup").toString().includes("/docker/")}catch(t){return console.warn("isDocker: failed to read /proc/1/cgroup: "+t),!1}}),e.platformName=e.isWin?"win":e.isMac?"mac":e.isLinux?"linux":l},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(28);e.mountpointsTtlMs=15*i.secondMs,e.dfTtlMs=5*i.minuteMs,e.cmdTimeoutMs=25*i.secondMs,e.longTtlMs=1*i.hourMs,e.MinIoRate=i.secondMs/(2*r.MiB)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(19),r=n(8);function s(){if(i.argv.some(t=>t.endsWith("mocha")))return"test";switch(r.toS(i.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";default:return"production"}}e._nodeEnv=s,e.nodeEnv=(()=>{const t=s();return i.env.NODE_ENV=t,t})(),e.isDev="development"===e.nodeEnv,e.isTest="test"===e.nodeEnv,e.isProd="production"===e.nodeEnv},function(t,e,n){"use strict";function i(t){if("boolean"==typeof t)return t;if(null==t)return!1;const e=String(t).toLowerCase();return["true","1"].includes(e)}function r(t){if("boolean"==typeof t)return!t;if(null==t)return!1;const e=String(t).toLowerCase();return["false","0"].includes(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.isBoolean=function(t){return"boolean"==typeof t},e.truthy=i,e.toBoolean=function(t){return!!i(t)||!r(t)&&void 0},e.boolToInt=function(t){return i(t)?1:0},e.falsy=r,e.or=function(t){return t.some(t=>i(t))},e.and=function(t){return t.every(t=>i(t))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(30),r=n(2),s=n(0),o=n(6),a=n(8),u=n(12),l=n(23),c=n(10),d=i.posix;function h(t,e){if(i.sep===d.sep)return t;const n=r.notBlank(e)?i.sep+i.sep+e+i.sep:"",s=t.split(d.sep);return c.equalsIgnoreCase(s[0],e)&&s.unshift(),n+s.join(i.sep)}function f(t){return i.sep===d.sep?t:d.sep===i.sep?t:t.split(i.sep).join(d.sep)}e.posix2native=h,e.native2posix=f;const p=/^([A-Z]:)[\\/]?(.*)$/i;e.resolve=function(...t){const e=i.join(...t);return i.resolve(l.isWin?function(t){const e=p.exec(t);return null!=e?e[1].toUpperCase()+"\\"+e[2]:t}(e):e)};const m=/(\.?.*?)(\.[a-z]{1,10}\.(?:gz|z|xz|bz2))$/i;function g(t){const e=i.parse(t),n=v(e.base),r=c.stripSuffix(e.base,n);return Object.assign(Object.assign({},e),{ext:n,name:r})}function v(t){const e=m.exec(t);return null!=e&&r.notBlank(e[2])?e[2]:i.extname(t)}function y(t){return c.stripPrefix(t,i.sep).split(i.sep)}e.parsePosixPath=function(t){return g(h(t))},e.parseNativePath=g,e.extname2=v,e.containedBy=function(t,e){return r.notBlank(t)&&r.notBlank(e)&&(t===e||t.startsWith(c.ensureSuffix(e,d.sep)))},e.containedByNativePath=function(t,e){return r.notBlank(t)&&r.notBlank(e)&&(t===e||t.startsWith(c.ensureSuffix(e,i.sep)))},e.pathnames=y,e.posixPathFrom=function(t,e){return t.nativePath===e.nativePath?"":c.stripPrefix(f(e.nativePath),c.ensureSuffix(f(t.nativePath),"/"))},e.posixPathFromGrandparent=function(t){return y(t).slice(-3).join("/")};const b=/(.*?)(?:-(\d+)|\((\d+)\))$/;e.nameWithoutCount=function(t){return s.mapOr(a.toS(t).match(b),t=>t[1],()=>t)},e.countFromName=function(t){return s.map(a.toS(t).match(b),t=>u.first([t[2],t[3]],o.toInt))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6),r=new Intl.NumberFormat;e.fmt=function(t){return r.format(t)},e.KB=1e3,e.MB=1e3*e.KB,e.GB=1e3*e.MB,e.TB=1e3*e.GB,e.KiB=1024,e.MiB=1024*e.KiB,e.GiB=1024*e.MiB,e.TiB=1024*e.GiB;const s=["B","KB","MB","GB","TB","PB"],o=["B","KiB","MiB","GiB","TiB","PiB"];e.fmtBytes=function(t,e=3){const n=Math.floor(Math.log10(t)),r=Math.floor(n/3),o=Math.pow(10,3*r),a=s[r];return i.sigFigs(t/o,e)+" "+a},e.fmtMebi=function(t,e=3){const n=Math.floor(Math.log2(t)),r=Math.floor(n/10),s=Math.pow(2,10*r),a=o[r];return i.sigFigs(t/s,e)+" "+a},e.MP=1e6,e.megapixels=function(t){return i.sigFigs(t/e.MP,3)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(55),s=n(108),o=n(30),a=n(161),u=n(109),l=n(34),c=n(197),d=n(1),h=n(65),f=n(2),p=n(5),m=n(39),g=n(4),v=n(0),y=n(14),b=n(20),w=n(8),S=n(28),M=n(12),P=n(42),x=n(116),E=n(7),_=n(52),O=n(17),T=n(18),F=n(13),k=n(41),A=n(3),I=n(48),D=n(21),C=n(23),L=n(40),R=n(10),N=n(114),j=n(24),B=n(131),z=n(185),W=n(80),q=n(27),V=n(94),U=n(95),G=n(88),H=n(63),$=n(202);e.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1}),e.execDir=function(){return X.for(process.execPath).parent()};const J=p.minuteMs,K=500;class Q extends _.BoundedMap{constructor(){super(J,K,!0),F.onFileChanged(t=>this.clearFromPath(t)),F.onClearCache(()=>this.clearEntries()),this.on("expire",(t,e)=>v.map(e,t=>t.clear()))}clearEntries(){for(const t of this.values())t.clear()}clearFromPath(t){for(const e of this.values())(null==t||e.nativePath.startsWith(t))&&e.clear()}}e.FileCache=Q;const Y=new Q;class X{constructor(t,e){if(this.dirent=e,this.bflog=g.lazy(()=>A.mkLogger("BaseFile("+this.nativePath+")")),this.dirents=g.lazy(()=>i(this,void 0,void 0,(function*(){return E.thenMap(this.directoryEntry(),t=>t.children())}))),this.stat=g.lazy(()=>this.trap("stat",()=>s.stat(this.nativePath).catch(()=>void 0)),X.attrTTL),this.statSync=g.lazy(()=>this.trapSync("statSync",()=>D.Try(()=>s.statSync(this.nativePath))),X.attrTTL),this.executable=g.lazy(()=>this.access(s.constants.R_OK|s.constants.X_OK)),this.shaResult=g.lazy(()=>i(this,void 0,void 0,(function*(){const t=yield this.size();if(0===t||null==t)return;const e=t>5*S.MiB?new V.PushProgressObserver({op:"Computing SHA",path:this.nativePath},t):void 0,n=yield T.elapsedAsync(()=>this.trap("sha",()=>W.fileSha(this.nativePath,{observer:e}))),i=v.map(n.result,t=>t.toString("base64"));return{elapsedMs:n.elapsedMs,buffer:n.result,b64:i}})),X.attrTTL),null!=e)this.nativePath=e.nativePath,this.dir=e.dir,this.base=e.base,this.name=e.name,this.ext=e.ext;else{this.nativePath=q.resolve(t),this.nativePath.startsWith("\\\\")&&(this.hostname=this.nativePath.split("\\")[2]);const e=q.parseNativePath(this.nativePath);this.dir=e.dir,this.base=e.base,this.name=e.name,this.ext=e.ext}this.posixPath=q.native2posix(this.nativePath),Y.set(t,this)}toJSON(){return{ctor:this.constructor.name,nativePath:this.nativePath}}[l.inspect.custom](){return this.toJSON()}static withFastestAccess(t){return i(this,void 0,void 0,(function*(){const e=d.compact(t),n=yield Promise.all(e.map(t=>t.shaMs()));return e[M.leastIndex(n)]}))}static forPosix(t){return t instanceof X?t:this.for(R.replaceAll(t,"/",o.sep))}static forDirectoryEntry(t){return this.for(t.nativePath,t)}static for(t,e){if(t instanceof X)return t;const n=Y.get(t);if(null!=n)return n;const i=q.resolve(t);return Y.getOrSet(i,()=>new X(i,e))}static clear(t){F.emitFileChanged(t)}for(t,e){return X.for(t,e)}clear(){return this.dirent=void 0,this.dirents.clear(),this.stat.clear(),this.statSync.clear(),this.executable.clear(),this.shaResult.clear(),this}clearThisAndParent(){return F.emitFileChanged(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(t){return null!=t&&this.nativePath===t.toString()}get baseWithParent(){return(this.isRoot?"":this.parent().base)+"/"+this.base}get baseWithGrandparent(){return(this.isRoot?"":this.parent().baseWithParent)+"/"+this.base}posixPathFrom(t){return q.posixPathFrom(t,this)}directoryEntry(){return i(this,void 0,void 0,(function*(){if(null==this.dirent){const t=yield this.isFile(),e=yield this.isDirectory(),n=yield this.isSymbolicLink(),i={name:this.base,isFile:function(){return t},isDirectory:function(){return e},isSymbolicLink:function(){return n}};this.dirent=new z.DirectoryEntry(this.dir,i)}return this.dirent}))}_child(t){return this.for(o.join(this.nativePath,t.base),t)}childNames(){return E.thenMap(this.dirents(),t=>t.map(t=>t.base))}children(t){return i(this,void 0,void 0,(function*(){return E.thenMap(this.dirents(),e=>E.thenCompact(e.map(e=>i(this,void 0,void 0,(function*(){return x.apply(this._child(e),t)})))))}))}childFiles(t){return i(this,void 0,void 0,(function*(){const e=[];for(const n of b.toA(yield this.dirents()))if(n.isFile()){const i=this._child(n);(null==t||t(i))&&e.push(i)}return e}))}childDirectories(t){return i(this,void 0,void 0,(function*(){return E.thenMap(this.dirents(),e=>E.thenCompact(e.filter(t=>t.isDirectory()).map(e=>i(this,void 0,void 0,(function*(){return x.apply(this._child(e),t)})))))}))}childrenSync(){return v.orElse(this.trapSync("childrenSync",()=>r.readdirSync(this.nativePath).map(t=>this.join(t))),[])}hasChildren(t){return i(this,void 0,void 0,(function*(){const e=yield this.childNames();return d.isNotEmpty(t)?d.includesAll(e,t):d.isNotEmpty(e)}))}hasNoChildren(){return i(this,void 0,void 0,(function*(){return(yield this.isFile())||d.isEmpty(yield this.childNames())}))}visitDescendants(t){return i(this,void 0,void 0,(function*(){return E.thenMap(this.children(),e=>i(this,void 0,void 0,(function*(){for(const n of e)yield n.visitDescendants(t),yield t(n)})))}))}descendants(t){return i(this,void 0,void 0,(function*(){const e=[];for(const n of b.toA(yield this.childFiles()))(yield t(n))&&e.push(n);const n=yield this.childDirectories();if(null!=n){for(const i of n)yield E.thenMap(i.descendants(t),t=>e.push(...t));return e}}))}ancestorWithChildren(t){return i(this,void 0,void 0,(function*(){return(yield this.hasChildren(t))?this:this.isRoot?void 0:this.parent().ancestorWithChildren(t)}))}siblings(){return i(this,void 0,void 0,(function*(){return this.selfAndSiblings().then(t=>t.filter(t=>!this.eql(t)))}))}dirEntSiblings(t){return i(this,void 0,void 0,(function*(){return E.thenMap(this.parent().dirents(),e=>t(e).map(t=>this.parent()._child(t)))}))}selfAndSiblings(){return i(this,void 0,void 0,(function*(){return this.parent().children()}))}firstExistingSelfOrAncestor(){return i(this,void 0,void 0,(function*(){return this.isRoot||(yield this.exists())?this:this.parent().firstExistingSelfOrAncestor()}))}get pathnames(){return this.nativePath.split(o.sep).filter(t=>null!=t&&""!==t)}get pathnamesWithoutDrive(){return C.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(C.isWin?1:0)}get isRoot(){return this.pathnames.length===(C.isWin?1:0)}root(t=0){return this.depth<=t?this:this.parent().root(t)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(t){return null!=t&&d.startsWith(t.pathnames,this.pathnames)}isDescendantOf(t){return null!=t&&d.startsWith(this.pathnames,t.pathnames)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(t){return[this,...this.isRoot||t<=0?[]:this.parent().selfAndParents(t-1)]}parents(){const t=this.parent();return this.isRoot?[]:[...t.parents(),t]}sibling(t){return this.parent().join(t)}withPrefix(t){return this.sibling(t+this.base)}withNameSuffix(t){return this.sibling(this.name+t+this.ext)}siblingOf(t){return this.nativePath!==t.nativePath&&this.dir===t.dir}join(...t){return d.isEmpty(t)?this:this.for(o.join(this.nativePath,...t))}child(...t){return d.isEmpty(t)?this:this.join(...q.native2posix(o.join(...t)).split("/").filter(t=>".."!==t))}trap(t,e,n="warn"){return i(this,void 0,void 0,(function*(){try{const n=yield e();return this.bflog().trace(`trap ${t}()`,Buffer.isBuffer(n)?"<Buffer>":n),n}catch(e){return void this.bflog().log(n,`trap: ${t}() failed: ${e}`)}}))}trapOr(t,e,n="warn"){return i(this,void 0,void 0,(function*(){try{return this.bflog().debug(`trapOr ${t}()`),yield e(),!0}catch(e){return this.bflog().log(n,`trapOr: ${t}() failed: ${e}`),!1}}))}trapSync(t,e){try{return this.bflog().debug(`trapSync ${t}()`),e()}catch(e){return void this.bflog().warn(`trapSync: ${t}() failed: ${e}`)}}exists(){return i(this,void 0,void 0,(function*(){return null!=this.dirent||(yield E.thenDefined(this.stat()))}))}existsSync(){return null!=this.dirent||null!=this.statSync()}notExists(){return i(this,void 0,void 0,(function*(){return E.thenNot(this.exists())}))}mtime(){return E.thenMap(this.stat(),t=>t.mtime)}mtimeMs(){return E.thenMap(this.stat(),t=>Math.floor(t.mtimeMs))}mtimeSec(){return E.thenMap(this.stat(),t=>T.unixtime(t.mtime))}lastModifiedUtc(){return i(this,void 0,void 0,(function*(){return E.thenMap(this.stat(),t=>t.mtime.toUTCString())}))}statTimes(){return E.thenMap(this.stat(),t=>d.uniq([t.birthtimeMs,t.mtimeMs].filter(t=>null!=t&&0!==t)))}maxStatMs(){return E.thenMap(this.statTimes(),M.max)}maxStatDate(){return E.thenMap(this.maxStatMs(),t=>new Date(t))}minStatMs(){return E.thenMap(this.statTimes(),I.min)}minStatDate(){return E.thenMap(this.minStatMs(),t=>new Date(t))}size(){return E.thenMap(this.stat(),t=>t.size)}access(t){return this.trapOr("access("+t+")",()=>s.access(this.nativePath,t))}isReadable(){return this.access(s.constants.R_OK)}isHiddenPosix(){return this.base.startsWith(".")}isEmpty(){return i(this,void 0,void 0,(function*(){if(yield this.isDirectory())return d.isNotEmpty(yield this.childNames());{const t=yield this.size();return null==t||0===t}}))}isNonEmpty(t=1){return E.thenMapOr(this.stat(),e=>e.size>t,()=>!1)}isNonEmptyFile(t=1){return i(this,void 0,void 0,(function*(){return(yield this.isFile())&&(yield E.thenMapOr(this.stat(),e=>e.size>t,()=>!1))}))}modifiedGTE(t){return i(this,void 0,void 0,(function*(){return E.thenMap(this.mtime(),e=>T.unixtime(e)>=T.unixtime(t))}))}modifiedCloseTo(t,e){return i(this,void 0,void 0,(function*(){return E.thenMap(this.mtimeMs(),n=>Math.abs(n-t)<=e)}))}modifiedGT(t){return i(this,void 0,void 0,(function*(){if(null!=t)return E.thenMap(this.mtime(),e=>T.unixtime(e)>T.unixtime(t))}))}isDirectory(){return i(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isDirectory():E.thenMapOr(this.stat(),t=>t.isDirectory(),()=>!1)}))}isNotDirectory(){return i(this,void 0,void 0,(function*(){return E.thenNot(this.isDirectory())}))}isDirectorySync(){return null!=this.dirent?this.dirent.isDirectory():v.mapOr(this.statSync(),t=>t.isDirectory(),()=>!1)}isSymbolicLink(){return i(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isSymbolicLink():E.thenMapOr(this.stat(),t=>t.isSymbolicLink(),()=>!1)}))}nearestDir(){return i(this,void 0,void 0,(function*(){return(yield this.isDirectory())?this:this.parent()}))}isFile(){return i(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isFile():this.stat().then(t=>y.Opt(t).map(t=>t.isFile()).getOrElse(()=>!1))}))}isFileSync(){return null!=this.dirent?this.dirent.isFile():y.Opt(this.statSync()).filter(t=>t.isFile()).isDefined}rmdir(t="warn"){return this.clear(),this.trapOr("rmdir",()=>s.rmdir(this.nativePath),t)}mkdirp(){return i(this,void 0,void 0,(function*(){return(yield this.clear().isDirectory())?this:this.trap("mkdirp",()=>i(this,void 0,void 0,(function*(){try{return yield s.mkdirp(this.nativePath),this.clearThisAndParent()}catch(t){if("EEXIST"!==t.code)throw t}if(null==(yield this.parent().mkdirp()))throw new Error("Failed to mkdirp parent of "+this);if(yield s.mkdir(this.nativePath),!1===(yield E.until(()=>this.clear().isDirectory(),2*p.secondMs)))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()})))}))}mkdirpSync(){return this.trapSync("mkdirpSync",()=>(s.mkdirpSync(this.nativePath),this.clearThisAndParent()))}sha(){return E.thenMap(this.shaResult(),t=>t.b64)}shaMs(){return E.thenMap(this.shaResult(),t=>t.elapsedMs)}writeStream(t,e){return i(this,void 0,void 0,(function*(){return yield H.pipelinePromise([t,s.createWriteStream(this.nativePath,e)]),this.clearThisAndParent()}))}writeJSON(t,e={}){return i(this,void 0,void 0,(function*(){return this.trap("writeJSON",()=>i(this,void 0,void 0,(function*(){return yield this.parent().mkdirp(),yield s.writeFile(this.nativePath,JSON.stringify(t,e.replacer,e.spaces),Object.assign({flag:"w"},e)),this.clearThisAndParent()})))}))}readJSON(){return this.trap("readJSON",()=>h.retryOnReject(()=>s.readJSON(this.nativePath),{maxRetries:2,onRetryWaitUntil:()=>m.delay(25),errorIsRetriable:t=>-2!==t.errno}))}readJSONSync(){return this.trapSync("readJSONSync",()=>s.readJSONSync(this.nativePath))}readFile(){return this.trap("readFile",()=>s.readFile(this.nativePath),void 0)}readLines(){return E.thenMap(this.readFile(),t=>B.splitLines(t.toString()))}readFileSync(){return D.Try(()=>v.map(s.readFileSync(this.nativePath),w.toS))}writeTxt(t){return this.writeFile(B.crlf(t))}writeFile(t){return this.trapOr("writeFile",()=>i(this,void 0,void 0,(function*(){yield this.parent().mkdirp(),yield s.outputFile(this.nativePath,t),this.clearThisAndParent()})))}appendFile(t){return this.trapOr("appendFile",()=>i(this,void 0,void 0,(function*(){yield s.mkdirp(this.dir),yield s.appendFile(this.nativePath,t),this.clearThisAndParent()})))}wip(t="."){return this.sibling(t+this.base)}unwip(t="."){return i(this,void 0,void 0,(function*(){const e=this.sibling(R.stripPrefix(this.base,t));return this.mv(e,{overwrite:!0})}))}dest(t){return i(this,void 0,void 0,(function*(){const e=t.clear();return f.notBlank(this.ext)&&f.blank(e.ext)||(yield e.isDirectory())?e.join(this.base):e}))}copyFile(t){return i(this,void 0,void 0,(function*(){const e=(yield this.dest(t)).clear();if(this.nativePath===e.nativePath)return this;if(null==(yield e.parent().mkdirp()))return this.bflog().throw("Cannot mkdirp "+e.dir);try{return yield this._nativeCopyFile(e)}catch(t){return yield this._copyFile(e)}}))}_copyFile(t){return i(this,void 0,void 0,(function*(){let e;const n=yield this.stat(),o=v.map(n,t=>t.size);if(null==n||null==o)return this.bflog().throw("Can't copy missing files");const a=yield this.sha();if(null==a)return this.bflog().throw("Can't copy file without SHA");const u=t.wip();try{const l=new Promise((t,e)=>r.copyFile(this.nativePath,u.nativePath,r.constants.COPYFILE_FICLONE,n=>null==n?t():e(n)));o>5*S.MiB&&(e=new V.PullProgressObserver({op:"file copy",path:this.nativePath,dest:t.nativePath},o,()=>u.clear().size())),yield l;const c=yield E.until(()=>i(this,void 0,void 0,(function*(){return o===(yield u.clear().size())})),15*p.secondMs),d=yield u.clear().sha();if(!c||d!==a)return this.bflog().throw("copyFile() failed",{sizeMatches:c,destSha:d,thisSha:a});const h=yield u.unwip();return null==h?this.bflog().throw("copyFile("+t+") failed: .unwip() was null"):(yield s.chmod(h.nativePath,n.mode),yield s.utimes(h.nativePath,n.atime,n.mtime),this.bflog().debug(`copyFile(${t.nativePath}): success`),F.emitFileCopied(this.nativePath,t.nativePath),t.clearThisAndParent())}catch(e){throw this.bflog().warn(`copyFile(${u.nativePath}) failed: ${e}`),yield u.unlink(),yield t.unlink(),e}finally{v.map(e,t=>t.end())}}))}copyTimeoutMs(){return i(this,void 0,void 0,(function*(){return E.thenMapOr(this.size(),t=>Math.max(j.cmdTimeoutMs,t*j.MinIoRate),()=>j.cmdTimeoutMs)}))}_nativeCopyFile(t){return i(this,void 0,void 0,(function*(){let e;try{const n=yield this.stat(),i=v.map(n,t=>t.size);return null==n||null==i?this.bflog().throw("Can't copy missing files"):(i>5*S.MiB&&(e=new V.PullProgressObserver({op:"file copy",path:this.nativePath,dest:t.nativePath},i,()=>t.clear().size())),C.isWin?yield L.PowerShell.instance().execute(`Copy-Item -LiteralPath ${L.pwshQuote(this.nativePath)} -Destination ${L.pwshQuote(t.nativePath)}`,t=>t):yield O.stdout("cp",["-a","-f",this.nativePath,t.nativePath],{timeout:yield this.copyTimeoutMs()}),F.emitFileCopied(this.nativePath,t.nativePath),t.clearThisAndParent())}catch(e){return this.bflog().throw("_nativeCopyFile("+t+"): "+e)}finally{v.map(e,t=>t.end())}}))}touch(t=Date.now(),e){return i(this,void 0,void 0,(function*(){return this.trap("touch",()=>E.thenMap(this.ensureFile(),()=>this.utimes(t,e)))}))}utimes(t,e){return i(this,void 0,void 0,(function*(){const n=v.orElse(t,Date.now()),i=v.orElse(e,n);return this.trap("utimes",()=>s.utimes(this.nativePath,T.unixtime(i),T.unixtime(n)).then(()=>this.clearThisAndParent()))}))}unlink(t="warn"){return i(this,void 0,void 0,(function*(){return this.trap("unlink",()=>i(this,void 0,void 0,(function*(){return yield s.unlink(this.nativePath),this.clearThisAndParent()})),t)}))}remove(){return i(this,void 0,void 0,(function*(){return this.trap("remove",()=>i(this,void 0,void 0,(function*(){return this.bflog().info("remove()"),yield s.remove(this.nativePath),this.clearThisAndParent()})))}))}unlock(){return i(this,void 0,void 0,(function*(){return C.isMac&&(yield this.clear().exists())&&(yield O.stdout("chflags",["nouchg",this.nativePath],{timeout:j.cmdTimeoutMs})),this}))}renameWithNameSuffix(t){return i(this,void 0,void 0,(function*(){return E.thenMap(this.withNameSuffix(t).ensureNew({emptyIsNew:!0}),t=>t.unlink("debug").then(()=>this.mv(t)))}))}mv(t,e={overwrite:!1}){return i(this,void 0,void 0,(function*(){const n=yield this.dest(t);return this.nativePath===n.nativePath?(this.bflog().warn("mv(): no-op",new Error("internal error")),this):(yield n.parent().mkdirp(),yield Promise.all([this.unlock(),n.unlock()]),this.bflog().debug("mv",n),yield s.move(this.nativePath,n.nativePath,e),yield n.unlock(),this.clearThisAndParent(),n.clearThisAndParent())}))}gzip(){return i(this,void 0,void 0,(function*(){return this.trap("gzip",()=>i(this,void 0,void 0,(function*(){const t=yield this.for(this.nativePath+".gz").ensureNew();return yield new Promise((e,n)=>u.pipeline(s.createReadStream(this.nativePath),c.createGzip(),s.createWriteStream(t.nativePath),t=>null==t?e():n(t))),yield this.unlink(),t})))}))}ensureFile(){return this.trap("ensureFile",()=>s.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync(){return this.trapSync("ensureFileSync",()=>(s.ensureFileSync(this.nativePath),this.clearThisAndParent()))}get nameWithoutCount(){return q.nameWithoutCount(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}ensureNewNativePath(t){return i(this,void 0,void 0,(function*(){const n=Object.assign(Object.assign({},e.DefaultEnsureNewOptions),t);if(this.clear(),!n.requireNumber&&((yield this.notExists())||n.emptyIsNew&&(yield this.isEmpty())))return this.nativePath;const i=this.parent();yield i.mkdirp();for(let t=n.startIndex;t<=n.maxVersions;t++){const e=i.join(`${this.name}-${R.leftPad(t,n.leftPad,"0")}${this.ext}`);if(e.clear(),(yield e.notExists())||n.emptyIsNew&&(yield e.isEmpty()))return e.nativePath}throw new Error("There are already more than "+n.maxVersions+" of "+this)}))}ensureNew(t={}){return this.ensureNewNativePath(t).then(t=>this.for(t))}renameYMD(){return i(this,void 0,void 0,(function*(){if(yield this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");const t=k.datedToYMD(yield E.thenOrElse(this.mtime(),()=>new Date));return this.mv(yield this.withNameSuffix("-"+t).ensureNew({emptyIsNew:!0}))}))}saveIfNewOrDelete(t){return i(this,void 0,void 0,(function*(){if(yield this.clear().isEmpty())return void(yield this.unlink());const e=yield this.siblingWithSameContents();if(null!=e)return yield this.unlink(),e;const n=yield this.sibling(t).ensureNew();return this.mv(n)}))}chmod(t){return i(this,void 0,void 0,(function*(){return yield s.chmod(this.nativePath,t),this.clear()}))}zreadline(){return a.createInterface({input:s.createReadStream(this.nativePath).on("error",t=>{throw new Error("Failed to read from "+this+": "+t)}).pipe(c.createGunzip()).on("error",t=>{throw new Error("Failed to gunzip "+this+": "+t)})})}zcat(){return this.ext.endsWith(".gz")?this.trap("zcat",()=>i(this,void 0,void 0,(function*(){const t=new $.WritableToBuffer;return yield new Promise((e,n)=>u.pipeline(s.createReadStream(this.nativePath),c.createGunzip(),t,t=>null==t?e():n(t))),E.thenMap(t.buffer,t=>t.toString())}))):E.thenMap(this.readFile(),t=>t.toString())}siblingWithSameContents(){return i(this,void 0,void 0,(function*(){return this.parent().childWithSameContents(this)}))}childWithSameContents(t){return i(this,void 0,void 0,(function*(){if((yield this.notExists())||!(yield this.isDirectory()))return;const e=yield t.size(),n=yield this.children(),i=[];for(const r of b.toA(n))(yield r.size())!==e||t.eql(r)||i.push(r);if(d.isEmpty(i))return;const r=yield t.sha();for(const t of i.sort((t,e)=>N.diceCoeff(t.base,e.base)).reverse())if((yield t.sha())===r)return t}))}applyWip(t){return i(this,void 0,void 0,(function*(){const e=this.wip();try{yield s.mkdirp(e.dir),yield e.unlink("debug");const n=yield t(e);if(yield e.clear().isEmpty())throw new Error("applyWip(): builder didn't write to dest");return yield e.unwip(),n}catch(t){throw yield E.tryAll([()=>e.unlink(),()=>this.unlink()]),t}}))}applyIfEmpty(t){return i(this,void 0,void 0,(function*(){return(yield this.clear().isNonEmpty())?this:(yield this.applyWip(t),this)}))}firstMatchingLine(t){const e=new P.Deferred("firstMatchingLine("+this+")"),n=r.createReadStream(this.nativePath,{flags:"r"});return n.on("error",t=>{-2===t.errno||"ENOENT"===t.code?(e.maybeResolve(void 0),n.close()):e.maybeReject(t)}),n.on("close",()=>e.maybeResolve(void 0)),G.onDataChunked(n,R.newlineRe,i=>{const r=t.exec(i);null!=r&&(e.maybeResolve(r),n.close())}),e.promise}}e.BaseFile=X,X.attrTTL=3*p.minuteMs,X.projectRoot=g.lazy(()=>{const t=U.ProjectPath.Root();if(null==t)throw new Error("Cannot find project path");return X.for(t)})},function(t,e){t.exports=require("path")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(65),o=n(5),a=n(205),u=n(39),l=n(4),c=n(22),d=n(7),h=n(17),f=n(163),p=n(15),m=n(13),g=n(3),v=n(23),y=n(110),b=n(207),w=n(208),S=n(24);let M;function P(){return i(this,void 0,void 0,(function*(){return null==M&&null==e.localMountpointSetup.prior()&&(yield e.localMountpointSetup()),s.retryOnReject(()=>(M||e.nonRpcMountpoints)(),{maxRetries:3,onRetryWaitUntil:t=>u.delay(1500*t)}).catch(t=>{p.onError("mountpoints() failed",t)})}))}e.nonRpcMountpoints=l.lazy(v.isWin?w.mountpointsWin:b.mountpointsPosix,S.mountpointsTtlMs),m.onClearCache(()=>e.nonRpcMountpoints.clear()),e.setRpcMountpointsImpl=function(t){M=t,e.localMountpointSetup.clear()},e.localMountpointSetup=l.lazy(()=>i(void 0,void 0,void 0,(function*(){null==M?u.later(()=>i(void 0,void 0,void 0,(function*(){const t=g.mkLogger("Mountpoints.localMountpointSetup()");v.isMac?(t.info("Setting up Mac diskutil activity watcher"),e.nonRpcMountpoints.setTTL(S.dfTtlMs),e.diskUtilActivity()):v.isLinux&&((yield y.isGioSupported())?(t.info("Setting up Linux gio mount monitor"),e.nonRpcMountpoints.setTTL(S.dfTtlMs),e.gioMountMonitor()):(yield x())&&(t.info("Setting up Linux findmnt mount monitor"),e.nonRpcMountpoints.setTTL(S.dfTtlMs),e.findmntPoll()))})),30*o.secondMs).unref():yield d.awaitAll([c.end(e.diskUtilActivity.clear()),c.end(e.gioMountMonitor.clear()),c.end(e.findmntPoll.clear())])}))),e.mountpoints=P,e.mountsCacheKey=()=>d.thenMap(P(),t=>r.sort(t).join(":")),e.diskUtilActivity=l.lazy(()=>f.mkBasicWatchedChild({cmd:"diskutil",args:["activity"],onStdout:a.debounce(()=>e.nonRpcMountpoints.clear(),1.5*o.secondMs)})),e.gioMountMonitor=l.lazy(()=>f.mkBasicWatchedChild({cmd:y.GioCommand,args:y.GioMountMonitorArgs,onStdout:a.debounce(()=>{y.gioVolumes.clear(),y.mtabEntries.clear(),e.nonRpcMountpoints.clear()},1.5*o.secondMs)}));const x=l.lazy(()=>i(void 0,void 0,void 0,(function*(){if(!v.isLinux)return!1;try{return 0===(yield h.stdoutResult("findmnt",["--version"],{timeout:S.cmdTimeoutMs,ignoreStderr:!0})).code}catch(t){return!1}})));e.findmntPoll=l.lazy(()=>f.mkBasicWatchedChild({cmd:"findmnt",args:["--poll"],onStdout:a.debounce(()=>e.nonRpcMountpoints.clear(),1.5*o.secondMs)}))},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(30),s=n(99),o=n(1),a=n(2),u=n(5),l=n(4),c=n(0),d=n(6),h=n(14),f=n(70),p=n(20),m=n(12),g=n(7),v=n(17),y=n(18),b=n(13),w=n(3),S=n(50),M=n(72),P=n(23),x=n(11),E=n(10),_=n(114),O=n(44),T=n(31),F=n(29),k=n(100),A=n(152),I=n(153),D=n(125),C=n(27),L=new F.FileCache;e.groupByMountpoint=function(t,e){return M.groupBy(t,t=>c.map(t.bestMountpoint(e),t=>t.nativePath))},e.coallesce=function(t,e){const n=M.groupBy(t,t=>c.map(t.bestMountpoint(e),t=>t.nativePath));return o.sortBy(o.flatten(p.toA(n.values()).map(t=>m.contextFilter(o.sort(t),(t,e,n)=>null==n||!t.isDescendantOf(n)))),t=>t.pathnames)};class R extends F.BaseFile{constructor(t,e){super(t,e),this.nativePath=t,this.pflog=l.lazy(()=>w.mkLogger("PosixFile("+this.nativePath+")")),this.uriObject=l.lazy(()=>k.file2voluri(this)),this.uri=l.lazy(()=>g.thenMap(this.uriObject(),t=>s.format(t))),this.fileuri=l.lazy(()=>k.file2fileuri(this)),this.mountpoint=l.lazy(()=>g.thenMap(T.mountpoints(),t=>this.bestMountpoint(t.map(t=>this.for(t))))),this.etag=l.lazy(()=>g.thenMap(this.stat(),t=>[t.size,t.mtime.getTime()].map(t=>S.Radix58.encode(t)).join("-"))),this.ignorable=l.lazy(()=>i(this,void 0,void 0,(function*(){return(yield this.isDirectory())?I.ignorableDirectory(this):I.ignorableFile(this)}))),this.hidden=l.lazy(()=>A.hidden(this)),this.isMountpoint=l.lazy(()=>i(this,void 0,void 0,(function*(){return(yield this.isDirectory())&&(yield g.thenMapOr(T.mountpoints(),t=>t.includes(this.nativePath),()=>!1))}))),this.sidecars=l.lazy(()=>i(this,void 0,void 0,(function*(){if(this.isSidecar())return[];const t=yield this.dirEntSiblings(t=>t.filter(t=>O.isSidecarExt(t.ext)&&(t.name===this.name||C.nameWithoutCount(t.name)===C.nameWithoutCount(this.name))));return g.sortByAsync(p.toA(t),t=>t.mtimeMs())}))),L.set(t,this)}static for(t,e){if(t instanceof R)return t;if(t instanceof F.BaseFile)return this.for(t.nativePath,e);if(k.isUri(t))throw new Error("use forUri");const n=L.get(t);if(null!=n)return n;const i=C.resolve(t);return L.getOrSet(i,()=>new R(i,e))}static forPosix(t){return this.for(t.replace(/\//g,r.sep))}static forUri(t,e){return g.thenMap(k.uri2file(t,e),t=>this.for(C.posix2native(t.posixPath,t.hostname)))}static forUriOrPath(t,e){return g.firstDefinedPromise([()=>this.forUri(t),()=>this.for(e)])}for(t,e){return R.for(t,e)}clear(){return super.clear(),this.uriObject.clear(),this.uri.clear(),this.fileuri.clear(),this.mountpoint.clear(),this.etag.clear(),this.ignorable.clear(),this.hidden.clear(),this.sidecars.clear(),this}bestMountpoint(t){return m.greatestBy(t.filter(t=>this.isDescendantOf(t)),t=>h.Opt(o.commonPrefixLength(this.pathnames,t.pathnames)).filter(e=>e>=t.pathnames.length).get())}httpHeaders(){return i(this,void 0,void 0,(function*(){return{ETag:yield this.etag(),"Last-Modified":yield this.lastModifiedUtc()}}))}hide(){return i(this,void 0,void 0,(function*(){const t=yield P.isWin?v.stdout("attrib",["+h",this.nativePath],{timeout:10*u.secondMs}).catch(t=>t):P.isMac?v.stdout("chflags",["hidden",this.nativePath],{timeout:10*u.secondMs}).catch(t=>t):"";return a.notBlank(t)?void this.pflog().warn("hide("+this.nativePath+") failed: "+t):this.clear()}))}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(t=>t.ignorable()))}mkNoMedia(){return this.join(".NoMedia").writeTxt("See <https://support.photostructure.com/no-media/>").then(t=>t?(b.emitFileChanged(this.nativePath),this):void 0).catch(t=>{this.pflog().warn("Could not add .NoMedia file to "+this,t)})}noMediaDir(){return i(this,void 0,void 0,(function*(){return D.hasNoMedia(yield this.directoryEntry())}))}ignorableCheap(){return I.ignorablePath(this.nativePath)}isSidecar(){return O.isSidecarExt(this.ext)}sidecar(){return i(this,void 0,void 0,(function*(){return f.thenOpt(this.sidecars()).flatMap(t=>t[t.length-1]).getOrElse(()=>this.sibling(this.name+O.asExt(x.Settings.defaultSidecarType.valueOrDefault)))}))}jsonSidecar(){return i(this,void 0,void 0,(function*(){const t=yield this.dirEntSiblings(t=>t.filter(t=>E.equalsIgnoreCase(t.ext,".json")&&(t.name===this.name||t.name===this.base||C.nameWithoutCount(t.name)===C.nameWithoutCount(this.name)))),e=o.sortBy(p.toA(t),t=>-_.diceCoeff(this.name,t.name))[0];return this.pflog().debug("jsonSidecar(): "+e),e}))}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",()=>i(this,void 0,void 0,(function*(){const t=yield this.mtimeMs(),e=yield this.sidecars(),n=[t,...yield Promise.all(p.toA(e).map(t=>t.mtimeMs()))].filter(d.gt0);return o.mapNotEmpty(n,t=>Math.floor(Math.max(...t)))})))}thisOrSidecareMaxMtimeSec(){return g.thenMap(this.thisOrSidecareMaxMtimeMs(),t=>y.unixtime(t))}}e.PosixFile=R},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(107),r=n(69);var s;function o(t){return"symbol"==typeof t}function a(t){return"function"==typeof t}function u(t){return null==t?s.Empty:o(t)?s.Symbol:r.isPrimitive(t)?s.Primitive:Array.isArray(t)?s.Array:i.isIterable(t)?s.Iterable:a(t)?s.Function:"object"==typeof t?t.constructor&&"Object"===t.constructor.name?s.Object:s.Instance:s.Unknown}!function(t){t[t.Empty=0]="Empty",t[t.Primitive=1]="Primitive",t[t.Symbol=2]="Symbol",t[t.Object=3]="Object",t[t.Array=4]="Array",t[t.Iterable=5]="Iterable",t[t.Instance=6]="Instance",t[t.Function=7]="Function",t[t.Unknown=8]="Unknown"}(s=e.ObjectType||(e.ObjectType={})),e.isSymbol=o,e.isFunction=a,e.isObject=function(t){return u(t)===s.Object},e.objectType=u},function(t,e){t.exports=require("util")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(9);e.strEnum=function(...t){return Object.freeze(t.reduce((t,e)=>(t[e]=e,t),Object.create(null)))},e.strEnumValues=function(t){return i.keys(t)},e.enumHas=function(t,e){return"string"==typeof e&&t[e]===e}},function(t,e){t.exports=require("timers")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(87),s=n(1),o=n(2),a=n(5),u=n(45),l=n(4),c=n(0),d=n(9),h=n(20),f=n(8),p=n(38),m=n(22),g=n(54),v=n(7),y=n(147),b=n(52),w=n(18),S=n(13),M=n(243),P=n(32),x=n(126),E=n(101),_=n(3),O=n(23),T=n(11),F=n(102),k=n(246),A=n(44),I=n(247),D=n(171),C=n(172),L=n(81),R=n(164),N=_.mkLogger("ExifTags");let j=1;e.setMaxProcs=function(t){return i(this,void 0,void 0,(function*(){j=t;const e=B.prior();null!=e&&e.options.maxProcs!==t&&(B.clear(),yield e.end())}))};const B=l.lazy(()=>{return y.observeBatchCluster(new r.ExifTool({maxProcs:j,cleanupChildProcs:!1}),"exiftool",m.EndableRanks.service)});function z(){const t=B();return t.ended?B.refresh():t}e.exiftool=z,e.shutdownExiftool=function(t){return c.map(B.prior(),e=>e.end(t))},S.onFileCopied((t,e)=>v.thenMap(G(t),t=>{const n=P.PosixFile.for(e);return W.getOrSet(n.nativePath,()=>Promise.resolve(Object.assign(Object.assign({},t),{SourceFile:n.nativePath,FileName:n.base,Directory:n.dir})))})),e.extractBinaryTag=function(t,e,n){return z().extractBinaryTag(t,e,n)};const W=new b.BoundedMap(7*a.minuteMs,1024,!0);function q(){W.clear(),e.rawTagsCache.clear()}e.rawTagsCache=new b.BoundedMap(7*a.minuteMs,1024,!0),e.clearTagsCache=q,S.onClearCache(q),S.onFileChanged(t=>{o.blank(t)?q():(W.deleteIf(e=>e.startsWith(t)),e.rawTagsCache.deleteIf(e=>e.startsWith(t)))});const V=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];function U(t){return i(this,void 0,void 0,(function*(){if(null==t)return;const e=P.PosixFile.for(t);return(yield e.isEmpty())?void 0:W.getOrSet(e.nativePath,()=>i(this,void 0,void 0,(function*(){const t=yield w.thenElapsed(v.thenMap(K(e),t=>Z(e,t)));return N.info("readTags("+e+") in "+t.elapsedMs+" ms"),t.result})))}))}function G(t){return i(this,void 0,void 0,(function*(){return W.get(String(t))}))}function H(t){return i(this,void 0,void 0,(function*(){if(o.blank(t))return;const e=P.PosixFile.for(t);return v.firstDefinedPromise([()=>v.thenMap(G(e),t=>t.MIMEType),()=>v.thenMap(M.readFileType(e.nativePath),t=>t.mime),()=>A.isExifExt(e.ext)?v.thenMap(K(e,!1),t=>t.MIMEType):void 0])}))}function $(t,e){return i(this,void 0,void 0,(function*(){const n=P.PosixFile.for(t),i=yield v.thenOrElse(e,()=>K(n));if(null==i)return;const r=L.extractSizeInfo(i,L.extractRotation(i));return null!=r?r:f.toS(i.MIMEType).startsWith("video/")?v.thenMap(E.extractVideoFrame(n,i.MIMEType),$):void 0}))}function J(t,e="_original"){return i(this,void 0,void 0,(function*(){return t.sibling(t.base+e).saveIfNewOrDelete(t.name+e+t.ext)}))}function K(t,e=!0){return i(this,void 0,void 0,(function*(){const n=P.PosixFile.for(t),r=yield X(n.nativePath);if(null==r||!e)return r;const o=[],a=v.thenMap(n.jsonSidecar(),t=>i(this,void 0,void 0,(function*(){const e=yield I.readJsonSidecar(t);return null!=e&&o.push(t.base),e}))),u=v.thenMap(n.sidecars(),t=>v.tuples(t,t=>X(t.nativePath)));let l=Object.assign(Object.assign({},r),yield a);for(const[t,e]of h.toA(yield u))o.push(e.base),l=Object.assign(Object.assign({},l),d.compactValues(d.without(t,...V)));return s.isNotEmpty(o)&&(l.sidecars=o),l}))}e.sidecarEql=function(t,e){return i(this,void 0,void 0,(function*(){const n=t=>v.thenMap(K(t,!1),t=>d.without(t,...V));return(yield u.eqlAsync(t.clear().sha(),e.clear().sha()))||(yield u.eqlAsync(n(t),n(e)))}))},e.readTags=U,e.cachedTags=G,e.capturedAt=function(t){return i(this,void 0,void 0,(function*(){return v.thenMap(U(t),t=>t.capturedAt)}))},e.mimetype=H,e.rotation=function(t){return i(this,void 0,void 0,(function*(){return v.thenMap(K(t,!0),L.extractRotation)}))},e.isMimetype=function(t,e){return i(this,void 0,void 0,(function*(){const n=yield H(t);return null!=n&&e.has(n)}))},e.duration=function(t){return i(this,void 0,void 0,(function*(){return v.thenMap(K(P.PosixFile.for(t)),t=>t.Duration)}))},e.sizeInfo=$,e.sizeInfo2=function(t){return i(this,void 0,void 0,(function*(){const e=P.PosixFile.for(t);return v.thenMap(K(e),t=>v.thenOrElse(L.extractSizeInfo(t,L.extractRotation(t)),()=>f.toS(t.MIMEType).startsWith("video/")?v.thenMap(E.extractVideoFrame(e,t.MIMEType),$):void 0))}))},e.moveOriginal=J,e.deleteAllTags=function(t){return i(this,void 0,void 0,(function*(){yield z().deleteAllTags(t.nativePath),yield t.sibling(t.base+"_original").unlink()}))},e.writeTags=function(t,e){return i(this,void 0,void 0,(function*(){const n=yield t.sidecar(),i=T.Settings.writeMetadataToSidecars.valueOrDefault||(yield n.exists())?n:t;yield z().write(i.nativePath,e);const r=yield J(i);return s.uniq([t.nativePath,i.nativePath]).forEach(S.emitFileChanged),i.clearThisAndParent(),{original:r,dest:i}}))},e.readRawTags=K;const Q=new g.Latch,Y=new g.Latch;function X(t){return i(this,void 0,void 0,(function*(){return e.rawTagsCache.getOrSet(t,()=>i(this,void 0,void 0,(function*(){N.debug("readRawTags("+t+")");const e=Q.pending;e?Q.resolve():yield Y.promise;const n=yield v.thenOrTimeout(w.thenElapsed(z().read(t).catch(e=>{N.info("Failed to read "+t,e)})),30*a.secondMs);return e&&Y.resolve(),c.map(n,e=>(N.debug("read("+t+") in "+e.elapsedMs+"ms"),c.map(e.result,t=>{const n=s.compactBlanks([t.Error,...c.orElse(t.errors,[]),t.Warning].map(f.toS));return s.isNotEmpty(n)&&(t.problems=n),t.exiftoolMs=e.elapsedMs,t})))})))}))}function Z(t,e){return i(this,void 0,void 0,(function*(){if(null==e)return;const n=e.MIMEType,i=t.nativePath;if(o.blank(n))return void N.debug("No mimetype for "+t);const r=t.nativePath.startsWith(p.App.getPath("temp"))||t.pathnames.includes(".photostructure");r||(yield R.inferMakeAndModel(t,e)),e.Make=C.make(e.Make),e.Model=C.model(e.Make,e.Model);const s=D.extractLensMakeModel(e),a=yield F.extractCapturedAt(t,e,r);if(null==a)return void N.info("No capturedAt for "+t);const u=k.extractExposureSettings(e),l=yield $(t,e);if(null==l)return void N.info("No size info for "+i);const d=Object.assign(Object.assign(Object.assign({mimetype:n,exposureSettings:u},s),l),{rotation:L.extractRotation(e),capturedAt:a,geohash:x.geohashNumeric(e.GPSLatitude,e.GPSLongitude),tz:e.tz});return N.debug("parsedTags",Object.assign(Object.assign({nativePath:i},d),{tzSource:e.tzSource,capturedAt:c.map(a,t=>({date:t.date,src:t.src}))})),Object.assign(Object.assign({},e),d)}))}O.isWin||(Q.resolve(),Y.resolve()),e.parseTags=Z},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(55),r=n(43),s=n(19),o=n(1),a=n(4),u=n(0),l=n(9),c=n(35),d=n(144),h=n(145),f=n(12),p=n(27),m=n(25);var g;e.AppPaths=c.strEnum("exe","home","appData","userData","pictures","temp"),function(t){t.getName=function(){return h.AppName},t.exe=a.lazy(()=>s.execPath),t.home=a.lazy(()=>u.orElse(f.first(o.compactBlanks([r.homedir(),s.env.HOME,s.env.HOMEPATH,s.env.USERPROFILE]).map(t=>p.resolve(t)),t=>u.map(i.statSync(t),()=>t)),r.homedir())),t.appData=a.lazy(()=>d.appData()),t.appName=a.lazy(()=>h.AppName+(m.isProd?"":`-${m.nodeEnv}`)),t.userData=a.lazy(()=>p.resolve(t.appData(),t.appName())),t.pictures=a.lazy(()=>p.resolve(t.home(),"Pictures")),t.temp=a.lazy(()=>p.resolve(r.tmpdir(),h.AppName+"-"+r.userInfo().username)),t.getPath=function(e){return l.maybeCall(t,e)},t.setPath=function(e,n){t[e].set(p.resolve(n))}}(g=e.App||(e.App={})),g.appName.onChange(()=>g.userData.clear())},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(36),r=n(6);function s(t){return o(t,!1)}function o(t,e){return new Promise(n=>{if(t<=0)n();else{const r=i.setTimeout(()=>n(),Math.round(t+1));e&&r.unref()}})}e.unrefDelay=function(t){return o(t,!0)},e.delay=s,e.delayUntil=function(t){const e=(r.gt0(t)?t:t.getTime())-Date.now();if(e<0){if(e>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-e+"ms")}return s(e).then(()=>e)},e.later=function(t,e=1){return i.setTimeout(t,Math.max(1,Math.round(e)))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(91),s=n(2),o=n(5),a=n(4),u=n(0),l=n(22),c=n(7),d=n(147),h=n(17),f=n(18),p=n(13),m=n(75),g=n(3),v=n(25),y=n(10),b=n(24),w=10*o.minuteMs,S="{ready}",M=" | ConvertTo-Json -Compress";p.onClearCache(()=>u.map(x.instance.prior(),t=>t.clearMockResults()));const P=[{re:/'/g,replace:"`'"},{re:/`/g,replace:"``"},{re:/"/g,replace:'`"'},{re:/\0/g,replace:"`0"},{re:/#/g,replace:"`#"},{re:/\n/g,replace:"`n"},{re:/\r/g,replace:"`r"},{re:/\t/g,replace:"`t"}];e.pwshQuote=function(t){for(const e of P)t=t.replace(e.re,e.replace);return`'${t}'`};class x{constructor(){this.logger=g.mkLogger("PowerShell"),this.mockResults=new Map,this.pwsh=d.observeBatchCluster(new r.BatchCluster({processFactory:()=>h.execFile("powershell",[],w),versionCommand:`function prompt {"${S}"}`,pass:S,fail:"Error",exitCommand:"exit",maxProcs:2,maxTasksPerProcess:150,taskTimeoutMillis:b.cmdTimeoutMs,cleanupChildProcs:!1}),"PowerShell",l.EndableRanks.db)}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockResult(t,e){this.mockResults.set(y.ensureSuffix(t,M),e)}clearMockResults(){this.mockResults.clear()}execute(t,e){return i(this,void 0,void 0,(function*(){if(this.pwsh.ended||l.ending())this.logger.warn("execute() failed (ended)",{cmd:t});else{if(v.isTest&&this.mockResults.has(t)){const n=this.mockResults.get(t);return e(n.stdout,n.stderr,n.passed)}try{this.logger.debug("execute()",{cmd:t});const n=yield f.elapsedAsync(()=>this.pwsh.enqueueTask(new r.Task(t,(n,i,r)=>e(u.map(n,e=>y.stripPrefix(e,t)),i,r))));return this.logger.log(m.ms2level(n.elapsedMs,7*o.secondMs),"execute()",{cmd:t,elapsedMs:n.elapsedMs}),n.result}catch(e){return void this.logger.warn("execute() failed: "+e,{cmd:t})}}}))}executeJson(t){return i(this,void 0,void 0,(function*(){const e=yield this.execute(y.ensureSuffix(t,M),(t,e,n)=>({stdout:t,stderr:e,passed:n}));if(null!=e)if(s.blank(e.stdout)||s.notBlank(e.stderr)||!e.passed)this.logger.warn("executeJson(): failed result",Object.assign({cmd:t},e));else try{return JSON.parse(e.stdout)}catch(t){const n=e.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:y.ellipsize(e.stdout),after:y.ellipsize(n)}),JSON.parse(n)}else this.logger.warn("executeJson(): null result",{cmd:t})}))}executeJsonToA(t){return i(this,void 0,void 0,(function*(){return c.thenMap(this.executeJson(t),t=>Array.isArray(t)?t:[t])}))}}e.PowerShell=x,x.instance=a.lazy(()=>new x)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(87),r=n(86),s=n(1),o=n(2),a=n(5),u=n(45),l=n(4),c=n(0),d=n(6),h=n(14),f=n(8),p=n(12),m=n(113),g=n(16),v=n(21),y=n(10);function b(t,e=2){return null==t?"":y.leftPad(t,e,"0")}function w(t){if(null==t||"string"==typeof t||0===t)return!1;return 0!==it(t)&&(!!x(q(t),V(t),U(t))&&(!ut(t)||c.mapOr(tt(t),t=>t.isValid,()=>!1)))}function S(t){return g.within(e.minYear,e.maxYear,t)}function M(t){return g.within(1,12,t)}function P(t,e,n){return null!=n&&r.DateTime.fromObject({year:t,month:e,day:n}).isValid}function x(t,e,n){return S(t)&&(null==e||M(e)&&(null==n||P(t,e,n)))}e.validDate=w,e.mapValidDate=function(t,e){return w(t)?e(t):void 0},e.minYear=1826,e.maxYear=(new Date).getFullYear()+2,e.validYear=S,e.validMonth=M,e.validDay=P,e.validYMD=x;class E{constructor(t,e,n){this.year=t,this.month=e,this.day=n}static for(t,e,n){return x(t,e,n)?new E(t,e,n):void 0}static localToday(){return ot(new Date)}toString(){return s.compact([this.year,this.month,this.day]).map(t=>b(t)).join("-")}toISOString(){return this.toString()}toDateTime(){return r.DateTime.fromObject(this)}}e.FuzzyDate=E;class _{constructor(t,e,n,i,r){this.monthsToMonth=t,this.re=e,this.yearIndex=n,this.monthIndex=i,this.dayIndex=r}apply(t){const e=this.re.exec(t);if(null!=e){const t=parseInt(e[this.yearIndex],10),n=this.month(e),i=null==this.dayIndex?void 0:parseInt(e[this.dayIndex],10);return E.for(t,n,i)}}month(t){if(null==this.monthIndex)return;const e=t[this.monthIndex].toLowerCase();return this.monthsToMonth.has(e)?this.monthsToMonth.get(e):d.toInt(e)}}const O="((?:19|20)[0-9]{2})",T="(1[0-2]|0?[1-9])",F="([1-3][0-9]|0?[1-9])",k="([0-5][0-9])",A=k,I=k,D="([-\\.\\,:_/ |])?",C="(?:(Z)|(?:([+-])([01][0-9]):?([0-5][0-9])))",L=new RegExp("\\d\\d"+C+"(?:\\/|$)","i");function R(t,e){if(s.isEmpty(t))return e;const[n,i]=t.splice(0,2),[r,o]=t.splice(0,2).map(t=>d.toInt(t));return y.equalsIgnoreCase(n,"z")?0:p.anyNotDefined([i,r,o])?e:("-"===i?-1:1)*(60*r+o)}function N(t){return o.mapNotBlank(t,t=>v.firstTrueThunk([()=>i.ExifDateTime.fromEXIF(t),()=>X(t)],t=>w(t)))}e.isoToOffsetMinutes=function(t){return c.map(L.exec(t),t=>R(t.slice(1)))},e.dateTimeBetween=function(t,e){return t.until(e).divideEqually(2)[0].end},e.agoMs=function(t){return d.mapNumeric(it(t),t=>Date.now()-t)},e.parseDateTime=N,e.parseDated=function(t){return o.mapNotBlank(t,t=>v.firstTrueThunk([()=>m.DateInterval.fromISO(t),()=>N(t),()=>i.ExifDate.fromEXIF(t),()=>z().parseYMD(t)],t=>w(t)))};class j{constructor(t){this.locale=t,this.monthsToMonth=new Map,this.ymdPatterns=[],this.ymPatterns=[],this.setup()}parseYMD(t){return p.first(this.ymdPatterns,e=>e.apply(t))}addParser(t,e,n,i){const r=new _(this.monthsToMonth,new RegExp(t+"(?:$|[^\\d])","i"),e,n,i);null!=i&&null!=n?this.ymdPatterns.push(r):null!=n&&this.ymPatterns.push(r)}setup(){["short","long"].forEach(t=>{const e=new Intl.DateTimeFormat(this.locale,{month:t});d.times(12,t=>{const n=e.format(new Date(2017,t));this.monthsToMonth.set(n.toLowerCase(),t+1)})});const t="("+s.sort([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(O+D+T+"\\2"+F,1,3,4),this.addParser(O+D+t+"\\2"+F,1,3,4),this.addParser(t+D+F+",?\\2"+O,4,1,3),this.addParser(F+D+t+",?\\2"+O,4,3,1),this.addParser(t+D+O,3,1),this.addParser(O+D+t,1,3)}extractDateFromPath(t){W.forEach(e=>{s.startsWith(t,e)&&t.splice(0,e.length)}),t=t.filter(e=>o.notBlank(e)&&null==t[0].match(B));const e=[...t].reverse();return v.firstThunk(()=>p.first(e,t=>this.parseYMD(t)),()=>this.parseYMD(t.join(" ")),()=>this.parseYMD(e.join(" ")),()=>p.first(this.ymPatterns,e=>e.apply(t.join(" "))),()=>p.first(this.ymPatterns,t=>t.apply(e.join(" "))))}}e.FuzzyDateParser=j;const B=/^((DCIM)|(DSC[_0F]?|IMG_|GOPRO|MOV_|P)\d+)$/i,z=l.lazy(()=>new j(void 0)),W=[];function q(t){return c.map(t,t=>t instanceof Date?t.getFullYear():t.year)}function V(t){return c.map(t,t=>t instanceof Date?t.getMonth()+1:t.month)}function U(t){return c.map(t,t=>t instanceof Date?t.getDate():t.day)}function G(t){return ut(t)?t instanceof Date?t.getHours():t.hour:void 0}function H(t){return ut(t)?t instanceof Date?t.getMinutes():t.minute:void 0}function $(t){return ut(t)?t instanceof Date?t.getSeconds():t.second:void 0}function J(t){return ut(t)?t instanceof Date?t.getMilliseconds():t.millisecond:void 0}function K(t,e=!0){if(null==t)return;if(0===t)return e?"UTC":"";const n=t<0?"-":"+",i=15*d.round(t/15),r=Math.abs(i),s=Math.floor(r/60),o=Math.floor(Math.abs(r%60));return`${e?"UTC":""}${n}${b(s)}:${b(o)}`}function Q(t){return t instanceof i.ExifDateTime?t.hasZone:t instanceof r.DateTime&&(null!=t.zone&&"local"!==t.zone.type)}function Y(t){return t instanceof r.DateTime?c.map(t.zone,t=>t.name):t instanceof i.ExifDateTime?t.zone:void 0}function X(t,e=Z){const n=e.exec(t);if(null==n)return;const i=[...n.slice(1)],[s,o,a,u,l,c]=i.splice(0,6).map(t=>d.toInt(t)),f=d.clamp(0,999,1e3*d.toFloat(i.shift(),{defaultValue:0})),p=K(R(i));return h.Opt(r.DateTime.fromObject({year:s,month:o,day:a,hour:u,minute:l,second:c,millisecond:f,zone:p})).filter(t=>t.isValid).flatMap(t=>et(t,p)).get()}e.addIgnorableSubpath=function(t){W.push(t)},e.clearIgnorableSubpaths=function(){W.length=0},e.extractDateFromPath=function(t){return z().extractDateFromPath(t)},e.parseYMD=function(t){return z().parseYMD(t)},e.isDated=function(t){return null!=t&&(t instanceof E||t instanceof i.ExifDate||t instanceof i.ExifDateTime||t instanceof Date||t instanceof m.DateInterval||t instanceof r.DateTime||c.allDefined([t.year,t.month,t.day]))},e.getYear=q,e.getMonth=V,e.getDay=U,e.getHour=G,e.getMinute=H,e.getSecond=$,e.getMillisecond=J,e.hasSeconds=function(t){return ut(t)&&(d.gt0(H(t))||d.gt0($(t))||d.gt0(J(t)))},e.getSecMs=function(t){return c.map($(t),e=>{const n=c.orElse(J(t),0);let i=(e+n/1e3).toString();for(e<10&&(i="0"+i),0===n&&(i+=".");i.length<6;)i+="0";return i})},e.zoneOffsetToName=K,e.hasZone=Q,e.getZoneName=Y,e.parseExifDateTime=X;const Z=new RegExp([O,"(1[0-2]|0[1-9])","([1-3][0-9]|0[1-9])","(1[0-9]|2[0-3]|0[0-9])",A,I,"(?:(\\.[0-9]+))?"].join("[-:_ ]?")+C+"?","i");function tt(t){return t instanceof r.DateTime?t:t instanceof i.ExifDateTime?t.toDateTime():t instanceof m.DateInterval?t.middle.toDateTime():t instanceof Date?r.DateTime.fromJSDate(t):void 0}function et(t,e){if(null==t||!ut(t))return;if(t instanceof r.DateTime)return i.ExifDateTime.fromDateTime(t);const n=it(t);if(null==n)return;const s=o.blank(e)?Q(t)?Y(t):void 0:e,a=o.mapNotBlank(s,t=>lt(n,t));if(null!=e&&null==a)return;const u=c.map(q(t),e=>c.map(V(t),n=>c.map(U(t),r=>c.map(G(t),s=>new i.ExifDateTime(e,n,r,s,c.orElse(H(t),0),c.orElse($(t),0),J(t),a,t.rawValue)))));return w(u)?u:void 0}function nt(t){if(null==t)return;if("number"==typeof t)return new Date(t);if(t instanceof Date)return t;if(t instanceof r.DateTime)return t.toJSDate();if(t.toDate)return t.toDate();if(d.gt0(t.year)&&d.gt0(t.month)&&d.gt0(t.day))return new Date(t.year,c.orElse(t.month,1)-1,t.day,12);const e=f.toS(t);return o.notBlank(e)?c.map(rt(e),nt):void 0}function it(t){if(null!=t)return d.isNumber(t)?t:t instanceof Date?t.getTime():t instanceof r.DateTime?t.toMillis():c.map(nt(t),t=>t.getTime())}function rt(t,e){return"string"!=typeof t||o.blank(t)?void 0:h.Opt(i.ExifDateTime.fromISO(t,e)).orElse(()=>i.ExifDate.fromISO(t)).orElse(()=>i.ExifTime.fromEXIF(t)).get()}function st(t){return s.compact([q(t),V(t),U(t)]).map(t=>b(t)).join("-")}function ot(t){return c.map(t,t=>c.map(q(t),e=>new E(e,V(t),U(t))))}function at(t,e){const[n,i]=[t,e].map(it);return null==n||null==i?void 0:n-i}function ut(t){return t instanceof Date||t instanceof i.ExifDateTime||t instanceof r.DateTime}function lt(t,e){const n=r.Info.normalizeZone(e);return n.isValid?n.offset(t):void 0}e.toDateTime=tt,e.toExifDateTime=et,e.toDate=nt,e.datedToMillis=it,e.datedToOffsetMinutes=function(t){return c.map(t,t=>t instanceof i.ExifDateTime?t.tzoffsetMinutes:t instanceof r.DateTime?t.offset:void 0)},e.datedToPrecisionMs=function(t){return c.map(t,t=>t instanceof r.DateTime||t instanceof i.ExifDateTime||t instanceof Date?0:t instanceof i.ExifDate?a.dayMs:t instanceof m.DateInterval?t.intervalMs:void 0)},e.datedToISO=function(t,e=!0){if(t instanceof m.DateInterval)return t.toString(e);const n=d.isNumber(t)?new Date(t):t;return ut(n)?c.map(et(n),t=>t.toISOString({includeOffset:e})):st(n)},e.fromISO=rt,e.datedToYMD=st,e.toFuzzyDate=ot,e.sameDay=function(t,e){return u.eql(ot(t),ot(e))},e.diffMillis=at,e.closeTo=function(t,e,n){return c.mapOr(at(t,e),t=>Math.abs(t)<n,()=>!1)},e.gtDate=function(t,e){const n=it(t),i=it(e);return null!=n&&null!=i&&n>i},e.nowish=function(t,e=2500){const n=it(t),i=Date.now();return g.within(i-e,i+e,n)},e.dateBetween=function(t,e,n=1,i=1){if(null==it(t)||null==it(e))return;const[s,o]=[t,e].map(t=>it(t)).sort(),a=(o-s)/(i+1),u=Y(t),l=u===Y(e)?u:void 0,c=r.DateTime.fromMillis(s+a*n,{zone:l});return[t,e].some(t=>!ut(t))?ot(c):c},e.hasTime=ut,e.zoneToOffset=lt,e.setZone=function(t,e){return t instanceof r.DateTime?t.setZone(e,{keepLocalTime:!0}):et(t,e)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(36),r=n(34),s=n(47),o=n(0),a=n(3),u=n(25),l=n(10),c=n(7),d=n(59);e.Deferred=class{constructor(t){this.name=t,this.start=Date.now(),this.state=c.PromiseStates.pending,this.promise=new Promise((t,e)=>{this._resolve=t,this._reject=e}),this.logger=a.mkLogger("Deferred("+this.toString()+")")}toString(){return l.isString(this.name)?this.name:JSON.stringify(this.name)}[r.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(t){return t.then(t=>{this.resolve(t)}).catch(t=>{this.logger.log(u.isTest?"warn":"error","observeQuietly.reject()",t),this.resolve(void 0)}),this}observe(t){return t.then(t=>{this.resolve(t)}).catch(t=>{this.reject(t)}),this}setTimeout(t){return o.map(this.priorTimeout,i.clearTimeout),this.priorTimeout=d.setUnrefTimeout(()=>{if(this.pending){const t="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(t)}},t),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===c.PromiseStates.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==c.PromiseStates.pending}get resolved(){return this.state===c.PromiseStates.resolved}get rejected(){return this.state===c.PromiseStates.rejected}get settledMs(){return null==this.end?void 0:this.end-this.start}resolve(t){return this.settle(()=>{this.state=c.PromiseStates.resolved,this._value=t,this._resolve(t)})}maybeResolve(t){return this.pending?this.resolve(t):this}reject(t){this.logger.log(u.isTest?"warn":"error",".reject()",t);const e=s.asError(t);return this.settle(()=>{this._error=e,this.state=c.PromiseStates.rejected,this._reject(e)})}maybeReject(t){return this.pending?this.reject(t):this}finally(t){return this.promise.finally(t),this}then(t){return this.promise.then(t)}settle(t){if(this.state===c.PromiseStates.pending){o.map(this.priorTimeout,i.clearTimeout),t(),this.end=Date.now();const e=this.settledMs;if(this.resolved&&e>5e3){const t=e>5e3?"info":"debug";this.logger.log(t,"Completed in "+e+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}}},function(t,e){t.exports=require("os")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(0),o=n(35),a=n(8),u=n(10);e.fileExtsToDesc=[[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["DNG"],"Digital Negative (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PNG"],"Portable Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["THM"],"Thumbnail image (JPEG)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["XMP"],"Extensible Metadata Platform sidecar file"]];const l=e.fileExtsToDesc.map(([t])=>t);function c(t){return i.flatten(i.compact(t.map(t=>t.toUpperCase()).map(t=>l.find(e=>e.includes(t))))).map(d)}function d(t){return u.ensurePrefix(t,".").toUpperCase()}function h(t){return r.mapNotBlank(t,d)}function f(t){const e=new Set(i.compactBlanks(t.map(h)));return t=>s.orElse(s.map(h(t),t=>e.has(t)),!1)}e.asExt=d,e.BaseSharpImageExts=["GIF","JPEG","PNG","PPM","TIFF","THM","WEBP"],e.SharpImageExts=c(e.BaseSharpImageExts),e.isSharpExt=f(e.SharpImageExts),e.sharpSupportedMimeTypes=new Set(["image/gif","image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"]),e.isSharpMimetype=function(t){return e.sharpSupportedMimeTypes.has(a.toS(t).toLowerCase())},e.BaseRawImageExts=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"],e.RawImageExts=c(e.BaseRawImageExts),e.isRawImageExt=f(e.RawImageExts),e.BaseVideoExts=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"],e.VideoExts=c(e.BaseVideoExts),e.isVideoExt=f(e.VideoExts),e.SidecarExtsEnum=o.strEnum("EXIF","EXV","MIE","XMP"),e.SidecarExts=c(o.strEnumValues(e.SidecarExtsEnum)),e.isSidecarExt=f(e.SidecarExts),e.AssetFileExts=[...e.SharpImageExts,...e.RawImageExts,...e.VideoExts].sort(),e.isAssetFileExt=f(e.AssetFileExts),e.AllExifExts=[...e.AssetFileExts,...e.SidecarExts].sort(),e.isExifExt=f(e.AllExifExts),e.BrowserImgExts=c(["JPEG","PNG"]),e.BrowserExts=c(["GIF","JPEG","MP4","PNG","WEBM","WEBP"]),e.isBrowserExt=f(e.BrowserExts),e.ExtTypes=o.strEnum("image","raw","video"),e.extType=function(t){return e.isSharpExt(t)?e.ExtTypes.image:e.isRawImageExt(t)?e.ExtTypes.raw:e.isVideoExt(t)?e.ExtTypes.video:void 0};const p=/\.[a-z0-9]{2,4}$/i;e.extractShortExt=function(t){return s.map(p.exec(a.toS(t)),t=>t[0])}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(9),o=n(33),a=new Map;function u(t,e){return i(this,void 0,void 0,(function*(){const n=yield t,i=yield e;return null!=n&&null!=i&&c(n,i)}))}function l(t,e){return null==t||null==e?`${t} and ${e} were not both defined`:d(t,e)}function c(t,e){return null==d(t,e)}function d(t,e,n){switch(o.objectType(t)){case o.ObjectType.Empty:case o.ObjectType.Symbol:case o.ObjectType.Primitive:return(null==n||null==a.get(n)?t===e:a.get(n)(t,e))?void 0:`${t} !== ${e}`;case o.ObjectType.Array:return h(t,e);case o.ObjectType.Iterable:return h([...t],[...e]);default:return t instanceof Set?f(t,e):t instanceof Map?p(t,e):m(t,e)}}function h(t,e){if(!Array.isArray(t))return"a is not an Array";if(!Array.isArray(e))return"b is not an Array";if(t.length!==e.length)return`length mismatch (${t.length} != ${e.length})`;const n=r.compact(t.map((t,n)=>{const i=d(t,e[n]);return null==i?void 0:"["+n+"] not eql: "+i}));return 0===n.length?void 0:n.join(", ")}function f(t,e){if(!(t instanceof Set))return"a is not a Set";if(!(e instanceof Set))return"b is not a Set";if(t.size!==e.size)return`size mismatch (${t.size} != ${e.size})`;const n=[...t.keys()].filter(t=>!e.has(t));return 0===n.length?void 0:"Missing keys in b: "+n}function p(t,e){if(!(t instanceof Map))return"a is not a Map";if(!(e instanceof Map))return"b is not a Map";if(t.size!==e.size)return`size mismatch (${t.size} != ${e.size})`;const n=[...t.keys()].filter(t=>!e.has(t));if(n.length>0)return"Missing keys in b: "+n;const i=r.compact([...t.entries()].map(([t,n])=>d(n,e.get(t))));return 0===i.length?void 0:"Mismatched entries: "+i.join(", ")}function m(t,e){const n=s.keys(t),i=s.keys(e),o=h(n.sort(),i.sort());if(null!=o)return o;const a=r.compact(n.map(n=>{const i=d(t[n],e[n],n);return null==i?void 0:"Mismatch at ["+n+"]: "+i}));return 0===a.length?void 0:a.join(", ")}e.addFieldComparator=function(t,e){a.set(t,e)},e.eqlAsync=u,e.notEqlAsync=function(t,e){return i(this,void 0,void 0,(function*(){return!(yield u(t,e))}))},e.definedEql=function(t,e){return null==l(t,e)},e.whyDefinedNotEql=l,e.eql=c,e.notEql=function(t,e){return!c(t,e)},e.whyNotEql=d,e.arrayEql=function(t,e){return null==h(t,e)},e.whyNotArrayEql=h,e.setEql=function(t,e){return null==f(t,e)},e.whyNotSetEql=f,e.mapEql=function(t,e){return null==p(t,e)},e.whyNotMapEql=p,e.whyNotObjEql=m},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getOrSet=function(t,e,n){if(null==e)throw new Error("null key");if(t.has(e))return t.get(e);{const i=n();return t.set(e,i),i}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(0),o=n(8);e.errorToS=function(t){return t instanceof Error?i.compactBlanks([t.name,s.map(t.code,t=>`code ${t}`),t.message]).join(": "):o.toS(t)},e.asError=function(t){if(r.blank(t))throw new Error("undefined error");if(t instanceof Error)return t;if(Array.isArray(t)){const e=t[0];return e instanceof Error?(t.length>1&&(e.errors=t.slice(1)),e):new Error(t.map(t=>o.toS(t)).filter(r.notBlank).join(", "))}return new Error(o.toS(t))},e.isError=function(t){return"object"==typeof t&&t instanceof Error}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(6),s=n(142),o=n(85);function a(t,e){const n=new s.CountingSet;return t.forEach(t=>r.mapFinite(t,t=>n.incr(t))),n.topKeys(e)}function u(t){return t.reduce((t,e)=>t+e,0)}function l(t){return i.isEmpty(t)?NaN:u(t)/t.length}function c(t){const e=l(t);return l(t.map(t=>Math.pow(t-e,2)))}function d(t){return Math.sqrt(t.reduce((t,e)=>t+e*e,0))}function h(t,e){return t.reduce((t,n,i)=>t+n*e[i],0)}e.min=function(t){return t.reduce((t,e)=>null==t?e:null==e||t<=e?t:e,void 0)},e.max=function(t){return t.reduce((t,e)=>null==t?e:null==e||t>=e?t:e,void 0)},e.deltas=function(t){return null==t||t.length<=1?[]:t.slice(1).map((e,n)=>e-t[n])},e.modes=a,e.mode=function(t){return a(t,1)[0]},e.sum=u,e.avg=l,e.avgMaybe=function(...t){const e=i.compact(t);return i.isEmpty(e)?void 0:u(e)/e.length},e.variance=c,e.stdDev=function(t){return Math.sqrt(c(t))},e.weightedAvg=function(t){let e;for(const n of t)e=null==e?n:(e+n)/2;return null==e?NaN:e},e.euclidean=function(t,e){return Math.sqrt(t.reduce((t,n,i)=>t+Math.pow(n-e[i],2),0))},e.l2norm=d,e.dot=h,e.cosineSimilarity=function(t,e){return r.finiteOrElse(h(t,e)/(d(t)*d(e)),void 0)},e.jaccard=function(t,e){return i.isEmpty(t)&&i.isEmpty(e)?0:r.finiteOrElse(o.intersection(t,e).size/o.union(t,e).size,void 0)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0);class r{constructor(t){this.value=t,this.ctime=Date.now()}touch(){this.ctime=Date.now()}}e.Entry=r;e.TTLMap=class{constructor(t,e=new Map){this.ttlMs=t,this.store=e,this.expireListeners=[]}get size(){return this.vacuum(),this.store.size}clear(){return this.store.clear(),this}delete(t){return this.store.delete(t)}deleteIf(t){this.store.forEach((e,n)=>{t(n,e.value)&&this.store.delete(n)})}entries(){const t=this;return function*(){for(const[e,n]of t.store.entries())t.expired(e,n)||(yield[e,n.value])}()}forEach(t){this.store.forEach((e,n)=>{this.expired(n,e)||t(e.value,n,this)})}get(t){return i.map(this.store.get(t),e=>this.expired(t,e)?void 0:e.value)}touch(t){i.map(this.store.get(t),t=>t.touch())}pop(t){const e=this.store.get(t);return this.store.delete(t),i.map(e,e=>this.expired(t,e)?void 0:e.value)}has(t){return!this.expired(t,this.store.get(t))}keys(){const t=this;return function*(){for(const[e,n]of t.store.entries())t.expired(e,n)||(yield e)}()}set(t,e){return i.map(this.store.get(t),e=>this.expireListeners.forEach(n=>n(t,e.value))),this.store.set(t,new r(e)),this}values(){const t=this;return function*(){for(const[e,n]of t.store.entries())t.expired(e,n)||(yield n.value)}()}[Symbol.iterator](){return this.entries()}getOrSet(t,e){const n=this.store.get(t);if(this.valid(t,n))return n.touch(),n.value;{const n=e();return this.set(t,n),n}}on(t,e){this.expireListeners.push(e)}valid(t,e){return!this.expired(t,e)}expired(t,e){return null!=e&&e.ctime+this.ttlMs<=Date.now()?(this.store.delete(t),this.expireListeners.forEach(n=>n(t,e.value)),!0):null==e}vacuum(){this.store.forEach((t,e)=>{this.expired(e,t)})}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(148),r=n(2),s=n(0),o=n(21),a=n(10),u=BigInt(0);class l{constructor(t,e,n=o.identity){this.name=t,this.numerals=e,this.decodePreparser=n,this.base=e.length}digitsToNumerals(t){return t.map(t=>this.numerals[t]).join("")}encode(t,e=0){const n=[],i=t<0;if(i&&e--,0===(t=Math.abs(t)))n.push(0);else for(;t>0;)n.push(t%this.base),t=Math.floor(t/this.base);for(;n.length<e;)n.push(0);return(i?"-":"")+this.digitsToNumerals(n.reverse())}encodeBigInt(t){if("bigint"!=typeof t)throw new Error("bad input");if(t===u)return this.numerals[0];const e=[],n=BigInt(this.base);let i=t;for(;i>u;)e.push(Number(i%n)),i/=n;return this.digitsToNumerals(e.reverse())}encodeBuffer(t){if(null==t||0===t.length)return"";const e=[0];for(let n of t)for(e.forEach((t,i)=>{n+=t<<8,e[i]=n%this.base,n=Math.floor(n/this.base)});n>0;)e.push(n%this.base),n=Math.floor(n/this.base);return this.digitsToNumerals(e.reverse())}decode(t){return s.map(this.decodeBigInt(t),e=>{if(e>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+t+") is > 2^53");return Number(e)})}decodeBigInt(t){if(null==t||r.blank(t))return;const e="-"===(t=this.decodePreparser(t))[0];e&&(t=t.slice(1));const n=BigInt(this.base);let i=BigInt(0);for(const e of t){const t=this.numerals.indexOf(e);if(t<0)return;i=i*n+BigInt(t)}return e?BigInt(-1)*i:i}randomChars(t){return this.encodeBuffer(i.randomBytes(t+3)).slice(1,t+1)}randomUid(t=25,e=5){return a.splitEvery(this.randomChars(t),e).join("-")}}e.Radix=l,e.Hex=new l("hex","0123456789abcdef",t=>t.toLowerCase()),e.Radix58=new l("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),e.RadixAlphaNum=new l("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",t=>t.toLowerCase()),e.GeoRadix=new l("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",t=>t.toLowerCase())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(65),o=n(4),a=n(0),u=n(12),l=n(15),c=n(3),d=n(42),h=n(7);e.keyedLazy=function(t,e,n,f){const p=o.lazy(()=>c.mkLogger("KeyedLazy("+t+")")),m=[],g=()=>i(this,void 0,void 0,(function*(){try{return yield e()}catch(t){return void p().warn("key() failed: "+t)}})),v=()=>i(this,void 0,void 0,(function*(){const e=yield g();if(r.filterInPlace(m,t=>(null==e||t.name===e)&&t.start+f.priorResultTtlMs>Date.now()&&!t.rejected),r.sortByInPlace(m,t=>[t.resolved,t.start]),null==e||m.length>0)return a.map(m[m.length-1],t=>t.promise);const i=new d.Deferred(e).setTimeout(f.timeoutMs).observe((()=>f.maxRetries<=0?n():s.retryOnReject(n,{maxRetries:f.maxRetries}))());return i.promise.catch(n=>{p().warn("Caught error",{newKey:e,startAgoMs:Date.now()-i.start,error:n}),l.onError(t+" failed",n)}),m.push(i),i.promise}));return v.clear=()=>m.length=0,v.prior=()=>{u.greatestBy(m,t=>t.start)},v.refresh=()=>(v.clear(),v()),v.set=t=>h.thenMap(g(),e=>{m.length=0,m.push(new d.Deferred(e).resolve(t))}),v}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(49),r=n(198);class s extends i.TTLMap{constructor(t,e,n){super(t,new r.MRUMap(e,n)),this.maxSize=e,this.fifo=n}}e.BoundedMap=s},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(33),o=n(57),a=n(42),u=n(54),l=n(162);class c{constructor(){this._pushCount=0,this._arr=[],this.nextSettledLatches=[],this.serialLatencyAvg=new o.Average}get arr(){return r.filterInPlace(this._arr,t=>t.pending),this._arr}get pushCount(){return this._pushCount}push(t,e){this._pushCount++;const n=s.isFunction(e)?e():e;return this.arr.push(new a.Deferred(t).observeQuietly(n).finally(()=>this.emitSettled())),n}emitSettled(){this.nextSettledLatches.forEach(t=>t.resolve()),this.nextSettledLatches.length=0}awaitNextSettled(){const t=new u.Latch;return this.nextSettledLatches.push(t),t}serial(t,e){const n=Date.now();return this.push(t,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-n),e())))}oneRunAtATime(t,e){return this.pending?this.awaitAll():this.serial(t,e)}maybeRun(t,e){return this.maybeRunConcurrent(t,e,1)}maybeRunConcurrent(t,e,n=l.maxCpus()){return this.pendingCount>=n?void 0:this.push(t,e)}get pendingCount(){return r.count(this._arr,t=>t.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(t=>t.name)}get settled(){return 0===this.arr.length}awaitAll(){return 0===this.arr.length?Promise.resolve(void 0):Promise.all(this.arr.map(t=>t.promise)).then(()=>void 0)}}e.Promises=c,e.oneRunAtATime=function(t,e){const n=new c;return()=>n.oneRunAtATime(t,e)},e.maybeRun=function(t,e){const n=new c;return()=>n.maybeRun(t,e)},e.serially=function(t,e){const n=new c;return()=>n.serial(t,e)},e.withBoundedConcurrency=function({name:t,laters:e,maxConcurrent:n=4}){return i(this,void 0,void 0,(function*(){const i=[],r=new c;for(const s of e){for(;r.pendingCount>=n;)yield r.awaitNextSettled();i.push(r.push(t,s))}return Promise.all(i)}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.Latch=class{constructor(t){this.id=t,this._state="pending",this.promise=new Promise((t,e)=>{this._resolve=t,this._reject=e})}resolve(){return this.pending&&this._resolve(),this._state="resolved",this}reject(t){return this.pending&&this._reject(t),this._state="rejected",this}observe(t){return t.then(()=>this.resolve()).catch(t=>this.reject(t)),this}observeQuietly(t){return t.then(()=>this.resolve()).catch(()=>this.resolve()),this}get pending(){return"pending"===this._state}get settled(){return!this.pending}get resolved(){return"resolved"===this._state}get rejected(){return"rejected"===this._state}get state(){return this._state}then(t){return this.promise.then(t)}}},function(t,e){t.exports=require("fs")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6),r=n(136),s=n(28),o=n(16);function a(t){return{width:t.height,height:t.width}}function u(t){return s.megapixels(t.width*t.height)}e.dimToS=function(t){return`${t.width}×${t.height}`},e.maybeFlip=function(t,e){return r.flippable(e)?a(t):t},e.maybeFlipInPlace=function(t,e){r.flippable(e)&&([t.width,t.height]=[t.height,t.width])},e.flip=a,e.isPortrait=function(t){return t.height/t.width>=4/3},e.dmegapixels=u,e.tmegapixels=function(t){return null!=t.dimensions?u(t.dimensions):i.gt0(t.Megapixels)?t.Megapixels:void 0},e.ltBoth=function(t,e){return o.lt(t.width,e.width)&&o.lt(t.height,e.height)},e.ltEither=function(t,e){return o.lt(t.width,e.width)||o.lt(t.height,e.height)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(6),o=n(141),a=n(142),u=n(48);e.Average=class{constructor(t=10,e=0,n=0){this.maxSamples=t,this._k=e,this._avg=n,this._weightedTotalAvg=n,this._samples=new o.BoundedList(t)}push(t){if(!isFinite(t))throw new Error("Average.push("+t+"): not a number");if(this._k++,this._samples.push(t),this._min=null==this._min?t:Math.min(t,this._min),this._max=null==this._max?t:Math.max(t,this._max),1===this._k)this._m=t,this._v=0,this._avg=t,this._weightedTotalAvg=t;else{const e=this._m;this._m+=(t-this._m)/this._k,this._v+=(t-e)*(t-this._m),this._avg=this._avg*(this._k-1)/this._k+t/this._k,this._weightedTotalAvg=(this._weightedTotalAvg+t)/2}return t}stats(t=2){const e={k:s.sigFigs(this.k,t)};if(!this.empty){const n=e=>r.map(e,e=>s.sigFigs(e,t));e.mean=n(this.avg),e.max=n(this.max),e.min=n(this.min)}return e}get empty(){return 0===this._k}get k(){return this._k}get avg(){return this.empty?void 0:s.sigFigs(this._avg,4)}get max(){return this._max}get min(){return this._min}get stdDev(){return this._k<2?void 0:Math.sqrt(this._v/(this._k-1))}get sampleMode(){return r.map(this.sampleModes(1),t=>t[0])}sampleModes(t){if(this.empty)return;const e=new a.CountingSet;return this._samples.forEach(t=>e.incr(t)),e.topKeys(t)}get sampleStdDev(){return i.mapNotEmpty(this._samples,u.stdDev)}get sampleAvg(){return i.mapNotEmpty(this._samples,u.avg)}get samples(){return[...this._samples]}p(t){if(0===this._samples.length)return 0;const e=[...this._samples].sort((t,e)=>t-e);return e[Math.floor(e.length*(t/100))]}get weightedAvg(){return i.mapNotEmpty(this._samples,t=>s.sigFigs(u.weightedAvg(t),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._k=0,this._weightedTotalAvg=0,this._samples.length=0}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.thenTap=function(t,e=console.dir.bind(console)){return i(this,void 0,void 0,(function*(){const n=yield t;return yield e(n),n}))},e.isPromise=function(t){return null!=t&&"function"==typeof t.then&&"function"==typeof t.catch}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(36),r=n(9);e.setUnrefTimeout=function(t,e,...n){return r.tap(i.setTimeout(t,Math.round(e),n),t=>t.unref())},e.setUnrefInterval=function(t,e,...n){return r.tap(i.setInterval(t,Math.round(e),n),t=>t.unref())},e.unref=function(t){return r.maybeCall(t,"unref"),t}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.version="0.6.0-beta.11",e.release="0.6.0-beta.11+20191107192450",e.gitSha="10bc2255efa805839f9dbabc9ce5a2086e3dd62e",e.gitDate=new Date(157315469e4)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.wmic=()=>"wmic",e.fsutil=()=>"fsutil",e.nslookupWin=()=>"nslookup",e.pingWin=()=>"ping",e.arpWin=()=>"arp"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(180),r=n(54),s=n(3),o=n(248),a=n(11),u=n(4),l=n(0),c=n(64),d=s.mkLogger("DbClient");e.dbClient=u.lazy(()=>{if(c.dbRpc()){const t=a.Settings.rpcPort.valueOrDefault;return d.info("Creating new dbClient to "+t),new o.Client("db@localhost:"+t,()=>(function(t){const e=new r.Latch,n=new i.Socket;return n.on("error",t=>e.reject(t)),n.connect(t,"localhost",()=>{d.info("Connected to "+t),e.resolve()}),e.then(()=>n)})(t))}}),e.dbClientReady=u.lazy(()=>l.map(e.dbClient(),t=>t.ping().then(t=>(d.debug("dbClientReady(): ping returned "+t),!0)).catch(t=>(d.warn("dbClientReady(): ping failed",t),!1))),5e3),e.dbClientEnd=function(){const t=e.dbClient.prior();return e.dbClient.clear(),l.map(t,t=>t.end())}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(109),s=n(1),o=n(39),a=n(47),u=n(0),l=n(9),c=n(22),d=n(15),h=n(21);class f extends r.Readable{constructor(t){super(),this.push(t),this.push(null)}}e.ReadableBuffer=f,e.end=function(t){return i(this,void 0,void 0,(function*(){null!=t&&(h.Try(()=>l.maybeCall(t,"unref")),c.ending()?t.end(null):yield new Promise(e=>t.end(null,e)),yield o.delay(50),h.Try(()=>l.maybeCall(t,"destroy")))}))},e.close=function(t){return i(this,void 0,void 0,(function*(){null!=t&&(h.Try(()=>l.maybeCall(t,"unref")),c.ending()?t.close(()=>{}):yield new Promise(e=>t.close(e)),yield o.delay(50),h.Try(()=>l.maybeCall(t,"destroy")))}))},e.onError=function(t,e){[{name:"cp",ea:t},{name:"stdin",ea:t.stdin},{name:"stdout",ea:t.stdout},{name:"stderr",ea:t.stderr}].forEach(({name:t,ea:n})=>u.map(n,n=>n.on("error",n=>{d.isIgnorableError(n)||e(t,n)})))},e.closeStreams=function(t){null!=t&&[t.stdin,t.stdout,t.stderr].forEach(t=>h.Try(()=>u.map(t,t=>t.destroy())))},e.pipelinePromise=function(t){return new Promise((e,n)=>{const i=[];t.forEach(t=>t.on("error",t=>{i.push(t)})),r.pipeline(t,t=>o.later(()=>{null!=t?n(t):s.isNotEmpty(i)?n(a.asError(i)):e()},10))})},e.remoteDesc=function(t){return t.destroyed?"destroyed":`${t.remoteFamily}:${t.remoteAddress}:${t.remotePort}`}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(13),s=n(31),o=n(76),a=n(4),u=n(0),l=n(62);let c=!0;function d(){return c}e.dbRpc=d,e.setDbRpc=function(t){c=t,t===(null==l.dbClient.prior())&&l.dbClientEnd(),t?(s.setRpcMountpointsImpl(e.rpcMountpoints),o.setRpcVolumesImpl(e.rpcVolumes)):(s.setRpcMountpointsImpl(void 0),o.setRpcVolumesImpl(void 0))},e.rpcMountpoints=a.lazy(()=>u.mapOr(l.dbClient(),t=>t.request("mountpoints"),s.nonRpcMountpoints),1e3),e.rpcVolumes=a.lazy(()=>i(void 0,void 0,void 0,(function*(){return u.mapOr(l.dbClient(),t=>t.request("volumes"),o.nonRpcVolumes)})),1e3),r.onClearCache(()=>{e.rpcMountpoints.clear(),e.rpcVolumes.clear()}),e.assertLocalDb=function(){if(d())throw new Error("only supported on db-local processes")},e.assertDbRpc=function(){if(!d())throw new Error("only supported on db-remote processes")}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(14);e.retryOnReject=function(t,e){const n=r.Opt(e.errorIsRetriable).getOrElse(()=>()=>!0),s=r.Opt(e.onRetryWaitUntil).getOrElse(()=>()=>Promise.resolve());let o=0;const a=()=>i(this,void 0,void 0,(function*(){try{return yield t()}catch(t){if(n(t)&&o<e.maxRetries)return o++,yield s(o),a();throw t}}));return a()}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(143),r=n(2);function s(t){return e=>r.blank(e)?"":t(e)}e.black=s(i.default.black),e.blue=s(i.default.blue),e.cyan=s(i.default.cyan),e.green=s(i.default.green),e.grey=s(i.default.grey),e.magenta=s(i.default.magenta),e.red=s(i.default.red),e.yellow=s(i.default.yellow)},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(0),o=n(20),a=n(12);function u(t){const e=r.compact(t).filter(([t,e])=>null!=t&&null!=e);return new Map(e)}function l(t,e){return new Map([...t.entries()].filter(([t,n])=>e(t,n)))}e.hasAll=function(t,e){return e.every(e=>t.has(e))},e.getOrSetAsync=function(t,e,n){return i(this,void 0,void 0,(function*(){const i=t.get(e);if(null!=i)return i;const r=Promise.resolve(n());return t.set(e,r),r.then(n=>{null==n?t.delete(e):t.set(e,n)}).catch(()=>t.delete(e)),r}))},e.flatMap=function(t,e){return new Map(a.concat(...t.map(t=>e(t))))},e.compactMap=u,e.toMap=function(t,e){return u(r.compact(t).map(e))},e.toMapAsync=function(t,e){return i(this,void 0,void 0,(function*(){if(null==t)return new Map;return u(yield Promise.all(r.compact(o.toA(t)).map(t=>e(t))))}))},e.toObj=function(t){const e={};for(const[n,i]of t)e[n]=i;return e},e.filter=l,e.filterInPlace=function(t,e){[...t.entries()].forEach(([n,i])=>e(n,i)||t.delete(n))},e.pickKeys=function(t,e){return l(t,t=>e.indexOf(t)>=0)},e.getLike=function(t,e){return s.map([...t.entries()].find(([t])=>e(t)),([,t])=>t)},e.inverse=function(t){return new Map([...t.entries()].map(([t,e])=>[e,t]))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(4),o=n(0),a=n(6),u=n(9),l=n(20),c=n(8),d=n(12),h=n(3),f=n(85),p=n(10);class m{constructor(t){this.h=t,this.text=o.orElse(t.text,c.toS(t)),this.greedyLeft=o.orElse(t.greedyLeft,!1)}toEntry(t){return[this.text,t.substring(this.leftIdx,this.rightIdx).trim()]}}const g=s.lazy(()=>h.mkLogger("Fixed"));e.parseFixed=function(t,e,n=!0){return new v(t,e,n).entries};class v{constructor(t,e,n=!0){this.warnIfMissingHeaders=n;const s=e.split(/[\r\n]{1,2}/);this.headerRow=s[0],this.rows=s.slice(1);const o=Math.max(...this.rows.map(t=>t.length));this.col2blanks=new Map(a.times(o,t=>[t,i.count(this.rows,e=>r.blank(e[t]))])),this.headers=this.extractHeaders(t.map(t=>new m(t))),this.entries=this.rows.map(t=>this.headers.map(e=>e.toEntry(t))).map(t=>u.fromEntries(t)).filter(t=>u.values(t).some(r.notBlank))}extractHeaders(t){let e=this.headerRow;i.sortBy(t,t=>-t.text.length),g().trace("extractHeaders()",t),t.forEach(t=>{const n=new RegExp(`\\b${t.text}\\b`,"i"),i=n.exec(e);null==i?this.warnIfMissingHeaders&&g().warn("extractHeaders(): Failed to find header!",{re:n,headerLine:e}):(t.indexOf=i.index,e=p.padReplace(e,i.index,t.text.length," "))});const n=t.filter(t=>null!=t.indexOf),r=i.sortBy(n,t=>t.indexOf);g().trace("extractHeaders()",{byAppearance:r}),r.forEach((t,e)=>{const n=t.indexOf,i=r[e-1],s=0===e?0:i.indexOf+i.text.length-1,[a,u]=t.greedyLeft?[s,n]:[n,s];t.leftIdx=o.map(this.firstBlankColumn(a,u),t=>t+1),0===e&&null==t.leftIdx&&(t.leftIdx=0),g().trace("extractHeaders(): finding leftIdx",{from:n,to:s,header:t}),null==t.leftIdx&&g().warn("no blank column for "+t.text+" between "+n+" and "+s)}),i.filterInPlace(r,t=>null!=t.leftIdx),r.slice(0,-1).forEach((t,e)=>{const n=r[e+1];t.rightIdx=n.leftIdx-1});const s=l.toA(f.diff(t.map(t=>t.text),r.map(t=>t.text)));return s.length>0&&g().warn("Missing headers",{missingHeaders:s}),r}firstBlankColumn(t,e){return d.range(t,e).find(t=>this.col2blanks.get(t)===this.rows.length)}}e.Fixed=v},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=["number","string","boolean"];function s(t){return-1!==r.indexOf(typeof t)}function o(t,e){return null==t&&null==e?0:null==t?-1:null==e?1:"string"==typeof t&&"string"==typeof e?t.localeCompare(e):Array.isArray(t)&&Array.isArray(e)?a(t,e):t>e?1:t<e?-1:0}function a(t,e){if(i.isEmpty(t)&&i.isEmpty(e))return 0;const n=Math.min(t.length,e.length);for(let i=0;i<n;i++){const n=o(t[i],e[i]);if(0!==n)return n}return o(t.length,e.length)}e.isPrimitive=s,e.isPrimitiveArray=function(t){return Array.isArray(t)&&t.every(s)},e.cmp=o,e.cmpArr=a},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(0);e.thenOpt=function(t){return o(t)?t:new s(()=>t)};class s{constructor(t){this.a=t}_map(t,e){return i(this,void 0,void 0,(function*(){const n=null!=this.a?yield this.a():void 0,i=o(n)?yield n.get():n;return null!=i?t(i):e()}))}isDefined(){return i(this,void 0,void 0,(function*(){return this._map(()=>!0,()=>!1)}))}isEmpty(){return i(this,void 0,void 0,(function*(){return this._map(()=>!1,()=>!0)}))}get(){return i(this,void 0,void 0,(function*(){return this._map(t=>t,()=>void 0)}))}getRequired(){return i(this,void 0,void 0,(function*(){return this._map(t=>t,()=>{throw new Error("unexpectedly undefined")})}))}exists(t){return i(this,void 0,void 0,(function*(){return this._map(t,()=>!1)}))}map(t){return new s(()=>i(this,void 0,void 0,(function*(){return this._map(t,()=>void 0)})))}flatMap(t){return new s(()=>i(this,void 0,void 0,(function*(){return this._map(t,()=>void 0)})))}filter(t){return new s(()=>i(this,void 0,void 0,(function*(){return this._map(e=>i(this,void 0,void 0,(function*(){return(yield t(e))?e:void 0})),()=>void 0)})))}catch(t){return new s(()=>this.get().catch(e=>i(this,void 0,void 0,(function*(){return t(e)}))))}forEach(t){return new s(()=>i(this,void 0,void 0,(function*(){const e=yield this.get();return yield r.map(e,t),e})))}getOrElse(t){return i(this,void 0,void 0,(function*(){return r.orElse(yield this.get(),t)}))}orElse(t){return new s(()=>i(this,void 0,void 0,(function*(){const e=yield this.get(),n=null==e?yield t():e;return o(n)?n.get():n})))}}function o(t){return t instanceof s}e.OptAsync=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(9),r=n(58),s=n(52);e.memoize=function(t,e,n){let o=0;const a=new s.BoundedMap(e,n,!0),u=e=>(o++,a.getOrSet(JSON.stringify(e),()=>i.tap(t(e),t=>{r.isPromise(t)&&t.catch(()=>u.clear())})));return u.clear=t=>null==t?a.clear():a.delete(JSON.stringify(t)),u.prior=()=>new Map(a.entries()),u.size=()=>a.size,u.callCount=()=>o,u}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(46),s=n(0),o=n(9),a=n(20),u=n(12),l=n(48);function c(t,e){const n=new d;return t.forEach(t=>s.map(e(t),e=>n.add(e,t))),n}e.groupBy=c,e.groupByValues=function(t,e){const n=c(t,e);return i.sortBy(a.toA(n.values()),t=>e(t[0]))};class d{constructor(t=new Map){this.store=t}get(t){return this.store.get(t)}has(t){return this.store.has(t)}get keyCount(){return this.store.size}get valueCount(){return l.sum([...this.store.values()].map(t=>t.length))}add(t,e){return o.tap(r.getOrSet(this.store,t,()=>[]),t=>t.push(e))}delete(t,e){if(null==e)return this.store.delete(t);{const n=this.store.get(t);if(null==n)return!1;{const i=u.remove(n,e);return i&&0===n.length&&this.store.delete(t),i}}}clear(){return this.store.clear(),this}keys(){const t=this;return function*(){for(const[e,n]of t.store.entries())n.length>0&&(yield e)}()}values(){const t=this;return function*(){for(const[,e]of t.store.entries())e.length>0&&(yield e)}()}flatValues(){const t=this;return function*(){for(const[,e]of t.store.entries())if(e.length>0)for(const t of e)yield t}()}entriesArray(){return[...this.store.entries()].filter(([,t])=>i.isNotEmpty(t))}entries(){const t=this;return function*(){for(const[e,n]of t.store.entries())n.length>0&&(yield[e,n])}()}tuples(){const t=this;return function*(){for(const[e,n]of t.store.entries())for(const t of a.toA(n))null!=t&&(yield[e,t])}()}filterInPlace(t){let e=!1;for(const[n,r]of this.store.entries()){const s=r.length;i.filterInPlace(r,e=>t(n,e)),e=e||s!==r.length}return e}}e.MultiMap=d},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(19),r=n(9);e.getEnv=function(t){return r.firstValueCaseInsensitive(i.env,t)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(91),s=n(19),o=n(1),a=n(2),u=n(5),l=n(4),c=n(0),d=n(6),h=n(14),f=n(20),p=n(8),m=n(38),g=n(22),v=n(7),y=n(53),b=n(59),w=n(18),S=n(15),M=n(29),P=n(27),x=n(3),E=n(67),_=n(16),O=n(21),T=n(23),F=n(201),k=n(40),A=l.lazy(()=>x.mkLogger("Pids"));function I(t,e){return i(this,void 0,void 0,(function*(){return null!=t&&null!=e&&(t.name===p.toS(e.pid)&&C(yield t.readJSON(),e))}))}e.addPid=function(t,e){return L.instance().addPid(t,e)};const D=10*u.secondMs;function C(t,e){if(null==t||null==e)return!1;const n=c.map(e.start,t=>t.getTime()),i=t.startTime;return d.gt0(n)&&d.gt0(i)&&Math.abs(n-i)<D}class L{constructor(t=M.BaseFile.for(m.App.userData()).join("pids")){this.pidsDir=t,this.p=new y.Promises,this.killOldProcs=(t={})=>this.p.serial("killOldProcs()",()=>i(this,void 0,void 0,(function*(){const e=c.orElse(t.everything,!1),n=c.orElse(t.force,T.isWin),i=yield this.pidfiles(),r=yield E.toMapAsync(i,t=>v.thenMap(t.readJSON(),t=>[t.pid,t])),a=o.uniq(o.flatten(f.toA(r.values()).map(t=>[t.pid,t.ppid])));if(o.isEmpty(a))return A().debug("killOldProcs(): no pidfiles"),[];const u=yield F.pidInfos(a);if(A().debug("killOldProcs()",{pids:a,allEntries:u}),null==u)return void S.onError("Pids.killOldProcs(): failed to get process information");const l=new Set(u.map(t=>t.pid)),h=u.filter(t=>r.has(t.pid)),p=o.sortBy(o.compact(h.map(t=>c.map(r.get(t.pid),e=>C(e,t)?Object.assign(Object.assign({},e),t):void 0))),t=>t.pid).filter(t=>s.pid!==t.pid),m=e?p:p.filter(e=>!l.has(e.ppid)||!l.has(e.pid)||d.gt0(e.timeoutTime)&&Date.now()>=e.timeoutTime||null!=t.everythingBefore&&e.startTime<t.everythingBefore);A().debug("killOldProcs()",{trackedEntries:h,victims:m,pidfiles:f.toA(r.values())});for(const t of m)A().info("killOldProcs(): killing",{entry:t}),R(t.pid,n,!1);return yield this.vacuumPids(),o.sortBy(m,t=>t.pid)})))}addPid(t,e){return i(this,void 0,void 0,(function*(){if(null==t)throw new Error("undefined info");const n=t.pid;if(!d.gt0(n))throw new Error("undefined pid");const i=this.pidsDir.join(t.pid+".json"),r=h.Opt(O.Try(()=>P.parseNativePath(t.cmd).base)).filter(a.notBlank).getOrElse(()=>t.cmd),s=e.getTime(),o=_.mapGt0(t.maxAgeMs,t=>s+t),u=Object.assign(Object.assign({},t),{cmd:r,startTime:s,timeoutTime:o});if(null==(yield i.writeJSON(u)))throw new Error("Failed to write to "+i);return A().debug("addPid() wrote "+i,u),i}))}pidfiles(){return this.pidsDir.clear().children(t=>".json"===t.ext&&null!=d.toInt(t.name))}onKill(t){return i(this,void 0,void 0,(function*(){const e=this.pidsDir.join(t+".json");return v.thenMap(e.clear().readJSON(),e=>this.addPid(Object.assign(Object.assign({},e),{maxAgeMs:1}),w.ago(u.minuteMs)).catch(e=>{A().info("onKill(): failed to rewrite pidfile: "+e,{pid:t})}))}))}vacuumPids(){return i(this,void 0,void 0,(function*(){const t=yield this.pidfiles(),e=f.toA(t).map(t=>d.toInt(t.name)).filter(d.gt0);if(o.isEmpty(e))return;const n=yield F.pidInfos(e);if(null!=n){A().info("vacuumPids",{pids:e,pidfiles:f.toA(t).map(t=>t.base),entries:n});for(const e of t){const t=n.find(t=>p.toS(t.pid)===e.name);null!=t&&(yield I(e,t))||(A().info("vacuumPids(): Removing old pidfile "+e.base,{psEntry:t,pidfile:yield e.readFile().then(p.toS).catch(t=>"(failed to read file: "+t+")")}),yield e.unlink())}}else S.onError("Failed to get pidInfo for pids "+e)}))}}function R(t,e=!1,n=!0){if(t===s.pid||t===s.ppid)throw new Error("cannot self-terminate");return e&&n&&L.instance().onKill(t),T.isWin?function(t,e=!1){return i(this,void 0,void 0,(function*(){if(g.ending()||k.PowerShell.instance().ended)return r.kill(t,e);try{const n=o.compact(["Stop-Process","-Id",d.toInt(t),e?"-Force":void 0]).join(" ");yield k.PowerShell.instance().execute(n,O.identity)}catch(n){A().warn("killWin(): pwsh error, using TASKKILL: "+n),r.kill(t,e)}}))}(t,e):function(t,e=!1){return i(this,void 0,void 0,(function*(){try{s.kill(t,e?"SIGKILL":"SIGTERM")}catch(t){if(!String(t).includes("ESRCH"))throw t}}))}(t,e)}function N(t){return i(this,void 0,void 0,(function*(){return null!=(yield F.pidInfo(t))}))}e.Pids=L,L.instance=l.lazy(()=>new L),e.kill=R,e.pidExists=N,e.pidNotExists=function(t){return v.thenNot(N(t))},e.ProcCleaner=l.lazy(()=>{const t=[{everything:!1,force:!1,intervalMs:5*u.minuteMs},{everything:!1,force:!0,intervalMs:17*u.minuteMs}].map(t=>b.setUnrefInterval(()=>L.instance().killOldProcs(t),t.intervalMs));return g.addCleanupEndable(new g.EndableWrapper("ProcCleaner",()=>(t.map(clearInterval),L.instance().killOldProcs())))})},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(34),s=n(1),o=n(47),a=n(46),u=n(0),l=n(35),c=n(8),d=n(141),h=n(15),f=n(21);e.LogLevels=l.strEnum("error","warn","info","debug","trace"),e.ms2level=function(t,e){return t>=e?"error":t>=e/2?"warn":t>=e/4?"info":"debug"};const p=()=>void 0;function m(t){return i(this,void 0,void 0,(function*(){try{return yield t()}catch(t){return}}))}e.NoOpLogger={enabled:()=>!1,log:p,flush:()=>Promise.resolve(),close:p,error:p,warn:p,info:p,debug:p,trace:p},e.safeLogger=function(t){return{enabled:(e,n)=>f.Try(()=>t.enabled(e,n),()=>!1),log:(e,n,i,r)=>f.Try(()=>t.log(e,n,i,r)),flush:()=>m(()=>t.flush()),close:()=>m(()=>t.close())}};const g=/^[a-z]*/i;e.MaxRecentLogEntriesByLevel=20;const v=new Map;e.clearRecentLogEntries=function(){v.clear()},e.recentLogEntries=function(){const t=[];for(const e of v.values())t.push(...e.toA());return s.sortBy(t,t=>t.timestamp)};e.ContextualLogger=class{constructor(t,e){this.context=t,this.logger=e,this.error=(t,e)=>{this.log("error",t,e)},this.warn=(t,e)=>{this.log("warn",t,e)},this.info=(t,e)=>{this.log("info",t,e)},this.debug=(t,e)=>{this.log("debug",t,e)},this.trace=(t,e)=>{this.log("trace",t,e)},this.filterContext=u.mapOr(g.exec(c.toS(this.context)),t=>t[0],()=>this.context)}throw(t,e){const n=new h.WrappedError({cause:o.asError(t),message:this.context+u.mapOr(e,r.inspect,()=>"")});throw this.log("error",o.errorToS(t),e),n}tap(t){return this.log(u.orElse(t.level,"debug"),t.msg,Object.assign({result:t.result},t.meta)),t.result}log(t,n,i){var r;"trace"!==t&&(r={timestamp:Date.now(),level:t,context:this.context,msg:n,meta:i},a.getOrSet(v,r.level,()=>new d.BoundedList(e.MaxRecentLogEntriesByLevel)).push(r)),this.enabled(t)&&u.map(this.logger(),e=>e.log(t,this.context,n,o.isError(i)?o.errorToS(i):i))}enabled(t){const e=this.logger();return null!=e&&e.enabled(t,this.filterContext)}flush(){return this.logger().flush()}close(){return u.map(this.logger(),t=>t.close())}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(2),o=n(5),a=n(45),u=n(4),l=n(14),c=n(58),d=n(12),h=n(51),f=n(7),p=n(26),m=n(73),g=n(15),v=n(13),y=n(27),b=n(3),w=n(150),S=n(23),M=n(10),P=n(212),x=n(213),E=n(215),_=n(216),O=n(218),T=n(31),F=n(219),k=n(151),A=n(24),I=u.lazy(()=>b.mkLogger("Volumes"));let D;e.nonRpcVolumes=h.keyedLazy("volumes",T.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const t=yield S.isWin?x.dfWin():P.dfPosix();if(null==t)return void I().warn("df failed");if(t.some(t=>t.remote&&s.blank(t.remoteHost))&&(yield f.thenOrTimeout(S.isWin?k.addRemoteVolumeInfoWin(t):F.addRemoteVolumeInfoPosix(t),10*o.secondMs).catch(t=>{g.onError("Failed to get remote volume info",t)})),null==(yield(S.isWin?O.addLocalVolumeInfoWin(t):S.isMac?E.addLocalVolumeInfoMac(t):_.addLocalVolumeInfoPosix(t)).catch(t=>{g.onError("Failed to get local volume info",t)})))return void I().warn("addLocalVolumeInfo failed");t.forEach(t=>s.mapNotBlank(t.remoteHost,e=>t.remoteHost=e.toLowerCase().normalize().trim())),t.forEach(t=>{t.remote=!!p.truthy(t.remote),!t.remote&&s.blank(t.uuid)&&(t.uuid=JSON.stringify({size:t.size}))});const e=r.sortBy(t,t=>t.mountpoint).filter(t=>!p.truthy(t.ignorable));return I().info("_volumes(): final result",e),Object.freeze(e)}))}),{maxRetries:2,timeoutMs:1.5*A.cmdTimeoutMs,priorResultTtlMs:A.longTtlMs}),v.onClearCache(()=>e.nonRpcVolumes.clear()),e.setRpcVolumesImpl=function(t){D=t};let C=[];function L(){return i(this,void 0,void 0,(function*(){try{return yield c.thenTap((D||e.nonRpcVolumes)(),t=>{r.mapNotEmpty(t,t=>{const e=t.map(t=>t.mountpoint).sort();a.eql(C,e)||(v.emitVolumesChanged(),C=e)})})}catch(t){return void g.onError("volumes() failed",t)}}))}function R(t){return i(this,void 0,void 0,(function*(){return f.thenMap(L(),e=>N(e,t))}))}function N(t,e){const n=t.filter(t=>y.containedByNativePath(e,t.mountpoint));return d.greatestBy(n,t=>r.commonPrefixLength(t.mountpoint,e))}function j(t,e,n){return i(this,void 0,void 0,(function*(){const o=n.filter(t=>M.equalsIgnoreCase(e,t.remoteShare));if(r.isEmpty(o))return;const a=o.find(e=>p.truthy(e.remote)&&s.notBlank(e.remoteHost)&&M.equalsIgnoreCase(t,e.remoteHost));if(null!=a)return a;const u=yield w.friendlyname(t);return f.asyncFind(o,t=>i(this,void 0,void 0,(function*(){return M.equalsIgnoreCase(u,yield w.friendlyname(t.remoteHost))})))}))}e.volumes=L,e.rootPath=u.lazy(()=>S.isWin?l.Opt(m.getEnv("SystemDrive")).filter(s.notBlank).orElse(()=>"C:").map(t=>M.ensureSuffix(t,"\\")).get():"/"),e.rootVolume=function(){return R(e.rootPath())},e.volumeFor=R,e.bestVolume=N,e.remoteVolumeFor=function(t,e){return i(this,void 0,void 0,(function*(){return f.thenMap(L(),n=>j(t,e,n))}))},e.bestRemoteVolume=j},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(30),r=n(1),s=n(9),o=n(8);e.joinQuery=function(t,e){if(null==e)return t;const n=s.entries(e).filter(([,t])=>null!=t);return r.isEmpty(n)?t:t+"?"+n.map(t=>t.map(o.toS).map(encodeURIComponent).join("=")).join("&")},e.parent=function(t){return i.posix.parse(t).dir},e.PS_LIBRARY_PROTOCOL="pslib:",e.PS_LOCAL_FILE_PROTOCOL="psfile:",e.PS_NETWORK_FILESYSTEM_PROTOCOL="psnet:"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(18),r=n(41),s=n(16),o=n(0),a=n(8),u=n(139);class l extends u.Model{static touch(t){return this.dbr(e=>e.exec(this.query().whereIn("id",t).update("updatedAt",Date.now())))}toID(){return h(this)}get createdAtDate(){return s.mapGt0(this.createdAt,t=>new Date(t))}get updatedAtDate(){return s.mapGt0(this.updatedAt,t=>new Date(t))}$beforeUpsert(){null==this.createdAt&&(this.createdAt=Date.now()),this.updatedAt=Date.now()}$beforeInsert(){this.$beforeUpsert()}$beforeUpdate(){this.$beforeUpsert()}}e.TimestampedModel=l;const c=Math.pow(2,16);function d(t){const e=o.orElse(r.datedToMillis(t),Date.now());return a.toS(i.unixtime(e)%c)}function h(t){return o.map(t,t=>({id:t.id,ts:d(t.updatedAt)}))}e.encodeVersion=d,e.toID=h},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(34),r=n(5),s=n(6),o=n(12),a=n(13),u=n(16),l=n(178),c=n(48);a.onClearCache(()=>d.clearCaches());class d{constructor(t){if(this.ttlMs=t,this._eventCount=0,this._firstEventTime=0,this._lastEventTime=0,t<=0)throw new Error("ttlMs must be positive");this.start=Date.now(),this.eventTimes=new l.TTLArray(t),d.instances.push(this),o.retainLastN(d.instances,1e3)}static clearCaches(){this.instances.forEach(t=>t.clear())}[i.inspect.custom](){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){const t=Date.now();0===this._eventCount&&(this._firstEventTime=t),this._lastEventTime=t,this.eventTimes.push(t),this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventTimes.clear()}get firstEventTime(){return this._firstEventTime}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return 0===this.eventTimes.length?0:c.weightedAvg(c.deltas([...this.eventTimes.values,Date.now()]))}get eventsPerMs(){return this.eventTimes.length/this.ttlMs}get msPerEvent(){return u.mapGt0(this.eventTimes.length,t=>this.ttlMs/t)}get eventsPerSecond(){return s.sigFigs(this.eventsPerMs*r.secondMs,3)}get eventsPerMinute(){return s.sigFigs(this.eventsPerMs*r.minuteMs,3)}}e.Rate=d,d.instances=[]},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(148),r=n(55),s=n(14),o=n(50);function a(t,n=e.HashBits){return i.createHash("sha512").update(t).digest().slice(0,n/8)}e.HashBits=192,e.fileSha=function(t,n){const o=r.createReadStream(t,{autoClose:!0}),a=i.createHash("sha512");let u=0;const l=s.Opt(n).flatMap(t=>t.msbits).getOrElse(()=>e.HashBits)/8;return new Promise((t,e)=>{o.on("error",t=>e(t)),o.on("data",t=>{u+=t.length,null!=n&&null!=n.observer&&n.observer.onProgress(u),a.update(t)}),o.on("end",()=>t(a.digest().slice(0,l)))})},e.stringSha=a,e.shortStringSha=function(t,e=9,n=o.Radix58,i=224){return n.encodeBuffer(a(t,i)).substring(0,e)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0),r=n(6),s=n(136),o=n(56),a=n(21);e.extractRotation=function(t){return a.firstThunk(()=>l(t.Orientation),()=>l(t.CameraOrientation),()=>r.toInt(t.Rotation))};const u=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function l(t){return i.map(t,t=>u.get(t))}e.orientationToRotation=l;const c=new Map([[0,1],[90,6],[180,3],[270,8]]);function d(t){return i.map(t,t=>c.get(t))}e.rotationToExifOrientation=d,e.extractSizeInfo=function(t,e){if(!r.gte0(t.ImageHeight)||!r.gte0(t.ImageWidth))return;const n=o.maybeFlip({width:t.ImageWidth,height:t.ImageHeight},e),i=r.sigFigs(n.width/n.height,5);return{ImageHeight:n.height,ImageWidth:n.width,aspectRatio:i,dimensions:n,fileDimensions:{width:t.ImageWidth,height:t.ImageHeight}}},e.isRotation=function(t){return r.isNumber(t)&&[0,90,180,270].includes(t)},e.rotationToWriteTag=function(t,e){return i.map(s.normalizeRotation(t),t=>e.startsWith("video/")?{Rotation:t}:i.map(d(t),t=>({"Orientation#":t})))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(12),s=n(7),o=n(26),a=n(18),u=n(15),l=n(13),c=n(67),d=n(21),h=n(120),f=n(83),p=n(1),m=n(166),g=n(104),v=n(4),y=n(0),b=n(9),w=n(20),S=n(229),M=n(105),P=n(62),x=n(90),E=n(130),_=n(106),O=n(78);class T{constructor(t,e){this.before=t,this.after=e,this.id=t.valueOf()+"-"+e.valueOf()}valueOf(){return this.id}}e.AssetStream=T;e.TaggedAssetStream=class extends T{constructor(t,e,n){super(e,n),this.tags=t}addTags(t){this.tags.push(...t),r.uniqInPlace(this.tags)}toApi(){return{tags:this.tags.map(t=>t.toApiTag()),assetIdsBefore:this.before.map(t=>t.toID()),assetIdsAfter:this.after.map(t=>t.toID())}}};class F extends O.TimestampedModel{constructor(){super(...arguments),this.attrs={},this.urls=v.lazy(()=>new m.AssetUrls(this.toID()))}static outdatedQuery(){return this.query().where("version","<",h.AssetVersion)}static nextOutdated(t=d.identity){return this.ops().findOne(t(this.outdatedQuery()))}static outdatedCount(t=d.identity){return this.dbr(e=>e.pluckFirst(t(this.outdatedQuery()).count()))}static findFirstByFile(t,e){return this.ops().findOne(t(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")),e)}static addTags(t,e){const n=p.uniqBy(e,t=>M.joinTagPath(t));this.logger().debug("addTags()",{assetId:t,tagPaths:e,uniqTagPaths:n});const i=P.dbClient();if(null!=i)return i.request("assetAddTags",{assetId:t,tagPaths:n});{const e=n.map(t=>_.Tag._findOrCreate(t)).map(t=>t.id);return E.AssetTag.addTagsToAsset(t,e)}}static removeTags(t,e){if(p.isEmpty(e))return;const n=P.dbClient();if(null!=n)return n.request("assetRemoveTags",{assetId:t,tagPaths:e});{const n=p.compact(e.map(t=>_.Tag.findByPath(t)));return this.logger().info("removeTags()",{assetId:t,tags:n.map(t=>b.pick(t,"id","path")),tagPaths:e}),E.AssetTag.removeTagsFromAsset(t,p.compact(n.map(t=>t.id)))}}static unshownAssetIds(){return this.dbr(t=>t.pluckAll("\n        SELECT DISTINCT af1.assetId\n        FROM AssetFile af1\n          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 \n            ON af1.assetId = af2.assetId\n        WHERE af2.assetId IS NULL"))}static archive(t){const e=P.dbClient();if(null!=e)return e.request("assetArchive",{assetId:t});{const e=F.opsLocal().findById(t);if(null==e)return;return e.getFiles(),e.getTags(),l.eventEmitter.emit("modelArchive",e),E.AssetTag.opsLocal().exec(E.AssetTag.query().where({assetId:t}).delete()),x.AssetFile.opsLocal().exec(x.AssetFile.query().where({assetId:t}).delete()),void F.opsLocal().delete([t])}}get capturedAt(){return a.localToDateObject(this.capturedAtLocal)}get capturedAtMs(){return a.localToMs(this.capturedAtLocal)}renderCaption(t){return y.map(this.capturedAtMs,e=>"Taken "+a.fmtShort(e,t))}whenTagPath(){return s.thenMap(S.dateTag(this.capturedAt),M.tagPathToStringArray)}addTagPaths(t){return F.addTags(this.id,t)}findAssetFileByUri(t){return i(this,void 0,void 0,(function*(){return yield this.getFiles(),this.files.find(e=>e.uri===t)}))}addAssetFile(t){return i(this,void 0,void 0,(function*(){return null==(yield this.findAssetFileByUri(t.uri))&&(this.files.push(t),t.asset=this,t.assetId=this.id),t}))}getTags(t){if(null!=this.tags)return this.tags;const e=_.Tag.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",this.id);return f.atap(_.Tag.ops().all(e,t),t=>this.tags=t)}tagPaths(){return i(this,void 0,void 0,(function*(){return(yield this.getTags()).map(t=>t.path.join("/")).sort()}))}getStreams(t){if(null==this.streams){const e=this.getTags();this.logger().info("Fetched tags "+e);const n=e.map(e=>e.getAssetStream(this,t));this.streams=function(t){const e=new Map;return t.forEach(t=>{const n=t.valueOf();e.has(n)?e.get(n).addTags(t.tags):e.set(n,t)}),[...e.values()]}(p.compact(n)),this.streams.forEach(t=>t.tags.forEach(t=>t.getAncestors()))}return this.streams}getBeforeAfterId(){return f.atap(F.dbr(t=>t.all(F.query().select("id","updatedAt").where("capturedAtLocal",this.capturedAtLocal).andWhere("shown",1).andWhere("hidden",0).orderBy("id"))),t=>{const e=p.indexOf(t,t=>t.id===this.id);if(null==e)throw new u.WrappedError({message:"missing asset id",retriable:!1});return this.beforeId=y.map(t[e-1],O.toID),this.afterId=y.map(t[e+1],O.toID),f.awaitAll([y.orElse(this.beforeId,()=>this.getBeforeId()),y.orElse(this.afterId,()=>this.getAfterId())])})}getBeforeId(){return f.amap(F.dbr(t=>t.first(F.query().select("id","updatedAt").where("capturedAtLocal","<",this.capturedAtLocal).andWhere("shown",1).andWhere("hidden",0).orderBy("capturedAtLocal","desc").orderBy("createdAt","desc"))),t=>this.beforeId=O.toID(t))}getAfterId(){return f.amap(F.dbr(t=>t.first(F.query().select("id","updatedAt").where("capturedAtLocal",">",this.capturedAtLocal).andWhere("shown",1).andWhere("hidden",0).orderBy("capturedAtLocal","asc").orderBy("createdAt","asc"))),t=>this.afterId=O.toID(t))}getTagPaths(t){return Promise.resolve(this.getTags(t)).then(t=>t.map(t=>t.path))}getFiles(t){return null!=this.files?this.files:null==this.id?this.files=[]:f.atap(x.AssetFile.ops().findBy({assetId:this.id},t),t=>this.files=p.sortBy(t,t=>[o.truthy(t.shown),t.mtime]).reverse())}getShown(t){return null!=this.files?this.files.find(t=>o.truthy(t.shown)):f.atap(x.AssetFile.ops().findOneBy({assetId:this.id,shown:1},t),t=>y.map(t,t=>t.asset=this))}getCapturedAt(){return i(this,void 0,void 0,(function*(){const t=yield this.getFiles();return s.thenCompact(w.toA(t).map(t=>t.toCapturedAt()))}))}link(){return"/asset/"+this.id}sqAttrs(t=!0){return Object.assign(Object.assign(Object.assign({},this.urls().sqImgAttrs(t)),{title:this.renderCaption()}),this.attrs)}getImgAttrs(t,e,n=!1){return i(this,void 0,void 0,(function*(){return null==this.imgAttrs&&(this.imgAttrs=new Map),yield c.getOrSetAsync(this.imgAttrs,e,()=>i(this,void 0,void 0,(function*(){const r=t.ap(this.toID());yield s.thenMap(r.readInfo(),t=>i(this,void 0,void 0,(function*(){t.mimetype.startsWith("video/")&&(this.poster=yield r.posterLink())})));return r.imgAttrs(e,!0,n)}))),this.imgAttrs}))}fitAttrs(){const t=y.map(this.imgAttrs,t=>t.get(g.ReducerNames.fit));if(null==t)throw new Error("fitAttrs() called before getImgAttrs()");return Object.assign(Object.assign({},t),this.attrs)}isVideo(){if(null==this.files)throw new Error(".video called before getFiles()");return this.files.some(t=>t.isVideo)}videoAttrs(){return Object.assign({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(null==this.existingFiles)throw new Error(".videoSources called before getExistingFiles()");const t=this.existingFiles.filter(t=>t.isVideo).map(t=>({src:this.urls().videoLink(t.id),type:t.mimetype})),e=p.uniqBy(t,t=>t.type);if(e.every(t=>"video/mp4"!==t.type)){const t=this.existingFiles[0];e.unshift({src:this.urls().videoLink(t.id)+".mp4",type:"video/mp4"})}return e}getExistingFiles(t){return i(this,void 0,void 0,(function*(){if(null!=this.existingFiles)return this.existingFiles;const e=yield this.getFiles(t);return!0===(yield y.map(e[0],t=>t.exists()))?this.existingFiles=e.slice(0,1):this.existingFiles=yield s.asyncFilter(e,t=>s.thenMapOr(t.posixFile(),t=>t.exists(),()=>!1))}))}findOrCreateByFile(t){return i(this,void 0,void 0,(function*(){const e=yield t.uri();if(null==e)return;const n=w.toA(yield x.AssetFile.findByAsset({id:this.id},{uri:e}))[0];return y.orElse(n,()=>i(this,void 0,void 0,(function*(){const e=new x.AssetFile;return e.asset=this,e.assetId=this.id,yield e.setFile(t),e})))}))}clear(){return this.files=void 0,this.tags=void 0,this.existingFiles=void 0,this}}e.Asset=F,F.tableName="Asset",F.uniqueColumnName="id",F.booleanFields=["shown","hidden","favorite"]},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(9),r=n(58);e.atap=function(t,e){return r.isPromise(t)?r.thenTap(t,e):i.tap(t,e)},e.amap=function(t,e){return r.isPromise(t)?t.then(t=>e(t)):e(t)},e.awaitAll=function(t){return t.some(t=>r.isPromise(t))?Promise.all(t):t}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(10),r=n(9),s=n(33),o=n(176);function a(t){return null!=t&&i.isString(t.sql)&&(null==t.bindings||o.isDbValued(t.bindings))}function u(t){if(null==t)throw new Error("null sql");if(a(t))return t;if(i.isString(t))return{sql:t};if(s.isFunction(t.toSQL))return r.without(t.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+JSON.stringify(t))}function l(t){return null!=/\blimit\b/i.exec(u(t).sql)}function c(t){return s.isFunction(t.where)&&s.isFunction(t.limit)}e.isSqlQuery=a,e.toSqlQuery=u,e.hasLimit=l,e.isQueryBuilder=c,e.maybeLimit=function(t,e=1e3){return c(t)&&!l(t)?t.limit(e):t}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(20);function r(t){return t instanceof Set?t:new Set(i.toA(t))}e.asSet=r,e.union=function(t,e){return new Set([...t,...e])},e.intersection=function(t,e){const n=r(e);return new Set([...t].filter(t=>n.has(t)))},e.diff=function(t,e){const n=r(e);return new Set([...t].filter(t=>!n.has(t)))}},function(t,e){t.exports=require("luxon")},function(t,e){t.exports=require("exiftool-vendored")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(54);e.onDataChunked=function(t,e,n){new s(e,n,!0).read(t)};class s{constructor(t,e,n=!0){this.sep=t,this.onData=e,this.filterBlanks=n,this.incompleteChunk="",this.done=new r.Latch}onChunk(t){if(null==t)return;const e=(this.incompleteChunk+t.toString()).split(this.sep);this.incompleteChunk=e.pop(),e.forEach(t=>{this.filterBlanks&&!i.notBlank(t)||this.onData(t)})}clear(){this.onChunk(""),i.notBlank(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(t){return t.on("data",t=>this.onChunk(t)),t.on("close",()=>{this.clear(),this.done.resolve()}),this}}e.Chunker=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1);function r(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}function s(t,e){return Math.random()*(e-t)+t}function o(){return e.RandomChars[r(0,e.RandomChars.length)]}function a(t){const e=Array(...t);for(let t=e.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));t!==n&&([e[t],e[n]]=[e[n],e[t]])}return e}e.randomInt=r,e.randomFloat=s,e.RandomChars="0123456789abcdefghijkmnopqrstuvwxyz",e.randomChars=function(t){let e="";for(let n=0;n<t;n++)e+=o();return e},e.randomChar=o,e.pickRandom=function(...t){return t[r(0,t.length)]},e.shuffle=a,e.sample=function(t,e){if(e<t.length/10){const n=new Set;for(;n.size<e;)n.add(r(0,t.length));return[...n.keys()].map(e=>t[e])}return a([...t]).slice(0,e)},e.pickWeightedRandom=function(t){if(i.isEmpty(t))return;let e=s(0,i.sum(t,t=>t.priority));return t.find(t=>(e-=t.priority)<=0)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(99),s=n(7),o=n(26),a=n(18),u=n(32),l=n(126),c=n(56),d=n(191),h=n(21),f=n(120),p=n(11),m=n(10),g=n(102),v=n(37),y=n(230),b=n(81),w=n(83),S=n(31),M=n(1),P=n(2),x=n(4),E=n(0),_=n(6),O=n(9),T=n(8),F=n(124),k=n(82),A=n(78);class I extends A.TimestampedModel{constructor(){super(...arguments),this.posixFile=x.lazy(()=>u.PosixFile.forUri(this.uri,this.mountpoint))}static recentAssetIdsByUriRoot(t,e,n=64){const i=Date.now()-e,r=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",i).andWhere("AssetFile.uri","like",t+"%").andWhere("Asset.shown",1).andWhere("Asset.hidden",0);return r.orderBy("AssetFile.updatedAt","desc").limit(n),this.logger().info("recentAssetIdsByUriRoot",r.toSQL()),this.dbLocal().pluckAll(r)}static assetCountByMimetype(t){const e=this.query().select(F.knex.raw("mimetype, count(*) as count"));return P.notBlank(t)&&e.andWhere("uri","like",t+"%"),e.groupBy("mimetype").orderBy("mimetype"),this.dbr(t=>t.all(e))}static children(t,e){const n=this.query().where("uri","like",t+"/%").andWhere("uri","regexp",`^${m.escapeRegExp(t)}/[^/]+$}`);return this.ops().all(E.mapOr(e,t=>t(n),()=>n))}get capturedAtDateTime(){return a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(t){return a.fmtDateTime(this.capturedAtDateTime,t)}static outdatedQuery(t){const e=this.query().where("version","<",f.AssetFileVersion);return M.isEmpty(t)?e:e.andWhere((function(){this.whereIn("mountpoint",t).orWhereNull("mountpoint")}))}static nextOutdated(t=h.identity){return i(this,void 0,void 0,(function*(){return this.ops().findOne(t(this.outdatedQuery(yield S.mountpoints())))}))}static outdatedCount(t=h.identity){return i(this,void 0,void 0,(function*(){const e=this.outdatedQuery(yield S.mountpoints());return this.dbr(n=>n.pluckFirst(t(e.count())))}))}static setShown(t,e,n){if(this.logger().info("setShown()",{assetId:t,assetFileId:e}),!_.gt0(t)||!_.gt0(e))throw new Error("setShown(): invalid IDs: "+JSON.stringify({assetId:t,assetFileId:e}));this.dbr(e=>e.run(I.query().update("shown",0).where("assetId",t)),n);const i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),r={assetId:t,assetFileId:e,updatedAt:Date.now()};return this.dbr(t=>t.run({sql:i,bindings:r}),n)}static findByAsset(t,e,n){const i=this.query().select("AssetFile.*");return E.map(O.compactValues(t),t=>{i.join("Asset","Asset.id","AssetFile.assetId").where(O.mapFields(t,(t,e)=>["Asset."+t,e]))}),E.map(O.compactValues(e),t=>{i.where(O.mapFields(t,(t,e)=>["AssetFile."+t,e]))}),this.ops().all(i,n)}matchesFile(t){return i(this,void 0,void 0,(function*(){return!(null==this.version||this.version<f.AssetFileVersion)&&(!p.Settings.forceSync.valueOrDefault&&null!=t&&null!=this.fileSize&&null!=this.mtime&&this.uri===(yield t.uri())&&this.fileSize===(yield t.size())&&this.mtime===(yield t.thisOrSidecareMaxMtimeMs()))}))}isUpdated(){return null!=this.version&&this.version>=f.AssetFileVersion}updateIfNeeded(){return i(this,void 0,void 0,(function*(){return this.isUpdated()?this:(yield this.exists())?s.thenMap(this.updateFromFile(),()=>this.upsert()):void 0}))}updateFromFile(t){return i(this,void 0,void 0,(function*(){const e=Date.now();if(this.logger().debug("updateFromFile() before",this),null!=this.id&&(yield this.matchesFile(t)))return void this.logger().info("updateFromFile() no-op, file times match and exifUID wasn't updated since last update",this);null!=t&&(yield this.setFile(t)),null==t&&(t=yield this.posixFile());const n=yield E.map(t,t=>t.stat());if(null==t||null==n||0===n.size)return this.logger().throw("Cannot update",{file:t,stat:n,uri:this.uri});this.fileSize=n.size,this.mtime=E.orElse(yield t.thisOrSidecareMaxMtimeMs(),()=>n.mtimeMs);const i=s.thenMap(t.sha(),t=>this.sha=t),r=yield v.readTags(t);if(null==r)return this.logger().throw("missing tags for "+t);if(P.blank(r.MIMEType))return this.logger().throw("missing MIMEType for "+t);this.mimetype=r.MIMEType;const o=r.capturedAt,a=o.toLocal();if(null==a)return this.logger().throw("Bad CapturedAt",o);this.capturedAtLocal=a,this.capturedAtOffset=o.toOffset(),this.capturedAtPrecisionMs=o.toPrecisionMs(),this.capturedAtSrc=o.src,E.map(r.exposureSettings,t=>{this.focalLength=t.focalLength,this.aperture=t.aperture,this.shutterSpeed=t.shutterSpeed,this.iso=t.iso});const u=r.dimensions;if(this.width=u.width,this.height=u.height,this.rotation=r.rotation,this.make=r.Make,this.model=r.Model,this.cameraId=y.cameraId(r),this.imageId=E.map(y.imageId(r),T.toS),this.lensId=y.lensId(r),this.geohash=l.geohashNumericShort(r.GPSLatitude,r.GPSLongitude),p.Settings.useImageHashes.valueOrDefault&&(yield s.thenMap(d.imageHash(t),t=>{this.meanHash=t.meanHash,this.rightHash=t.rightHash,this.mode8b6=t.mode8b6})),null==(yield i))return this.logger().throw("missing SHA for "+t);this.version=f.AssetFileVersion;const c=Date.now()-e;return this.logger().log(c>250?"info":"debug","updateFromFile() after ("+c+"ms)",this),this}))}updateFromShaSibling(t){return i(this,void 0,void 0,(function*(){return this.isUpdated()?this:null!=t.sha&&t.sha===this.sha&&t.isUpdated()?(h.assignMissingPrimitives(this,O.without(t,"id","assetId","asset","shown","uri","mountpoint","mtime","createdAt","updatedAt")),this.version=f.AssetFileVersion,this.upsert()):this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:t})}))}getAsset(t){return null==this.assetId||null!=this.asset?this.asset:w.atap(k.Asset.ops().findById(this.assetId,t),t=>this.asset=t)}exists(){return i(this,void 0,void 0,(function*(){return s.thenMapOr(this.posixFile(),t=>t.exists(),()=>!1)}))}notExists(){return i(this,void 0,void 0,(function*(){return s.thenNot(this.exists())}))}setFile(t){return i(this,void 0,void 0,(function*(){const e=yield t.uriObject();if(null==e)throw this.logger().error("setFile(): cannot determine voluri",t),new Error("no URI for "+t);const n=r.format(e);if(null==n)throw new Error(t+" had no URI");if(null!=this.uri&&n!==this.uri)throw new Error("Cannot reassign URIs");return this.uri=n,this.mountpoint=E.map(e.volume,t=>t.mountpoint),this.posixFile.set(Promise.resolve(t)),n}))}nativePath(){return s.thenMap(this.posixFile(),t=>t.nativePath)}toCapturedAt(){return E.map(a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset),t=>s.thenMap(this.posixFile(),e=>new g.CapturedAt(e,t,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}toApi(){return i(this,void 0,void 0,(function*(){return s.thenMap(this.posixFile(),t=>i(this,void 0,void 0,(function*(){return O.reqValuedOrElse({assetId:this.assetId,assetFileId:this.id,nativePath:t.nativePath,wbrNativePath:m.wbrPath(t.nativePath),basename:t.base,exists:yield t.isNonEmpty(),mimetype:this.mimetype,shown:o.truthy(this.shown),width:this.width,height:this.height,rotation:this.rotation,fileSize:this.fileSize,mtime:this.mtime,createdAt:this.createdAt,updatedAt:this.updatedAt})})))}))}get isVideo(){return T.toS(this.mimetype).startsWith("video/")}setRotation(t,e){return i(this,void 0,void 0,(function*(){const n=yield this.posixFile();null==n&&this.logger().throw("setRotation(): Cannot rotate: file is missing");const i=yield E.map(b.rotationToWriteTag(t,this.mimetype),t=>v.writeTags(n,t));null==i&&this.logger().throw("setRotation(): writeTags was null");const r=yield this.getAsset();null==r&&this.logger().throw("setRotation(): asset was null");const s=[this,r];if(null==(yield this.updateFromFile(n))&&this.logger().throw("setRotation(): updateFromFile returned null"),null!=i.original&&!i.original.isSidecar()){const t=yield r.findOrCreateByFile(i.original);null==t?this.logger().throw("setRotation(): findOrCreateByFile returned null",i):s.push(t)}const o=e.ap(this.assetId);return yield o.setRotation(t),e.clearAssetId(this.assetId),c.maybeFlipInPlace(this,E.orElse(this.rotation,0)-t),this.rotation=t,s}))}}e.AssetFile=I,I.tableName="AssetFile",I.uniqueColumnName="uri",I.booleanFields=["shown"]},function(t,e){t.exports=require("batch-cluster")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(13);let r=new(n(277).PermissiveWorkPlanner);e.getWorkPlanner=function(){return r},e.setWorkPlanner=function(t){r=t},e.work=function(t,e){return r.work(t,e)},e.isPaused=function(){return r.isPaused()},e.pause=function(){r.isPaused()||(r.pause(),i.emitPause())},e.resume=function(){r.isPaused()&&(r.resume(),i.emitResume())}},function(t,e){t.exports=require("sharp")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(36),r=n(169),s=n(0),o=n(6),a=n(118),u=n(7),l=750;e.PushProgressObserver=class{constructor(t,e){this.context=t,this.total=e,this.start=Date.now(),this.emit=a.throttle(()=>{r.emitProgressEvt(Object.assign(Object.assign({},this.context),{pct:o.sigFigs(100*this.current/this.total,3),elapsedMs:Date.now()-this.start}))},l,!0)}onProgress(t){this.current=o.clamp(0,this.total,s.orElse(t,s.orElse(this.current,0)+1)),this.emit()}};e.PullProgressObserver=class{constructor(t,e,n){this.ctx=t,this.total=e,this.progress=n,this.start=Date.now(),this.onInterval=a.throttle(()=>u.thenMap(this.progress(),t=>this.emit(t)),l),this.timer=i.setInterval(()=>this.onInterval(),l)}observe(t){return t.then(()=>this.completed()).catch(()=>this.end()),t}emit(t){s.map(t,t=>r.emitProgressEvt(Object.assign(Object.assign({},this.ctx),{pct:100*o.clamp(0,this.total,t)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>l&&this.emit(this.total),this.end()}end(){s.map(this.timer,t=>i.clearInterval(t)),this.timer=void 0}}},function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0});const i=n(55),r=n(30),s=n(19),o=n(4);function a(t){const e=[];for(;t!==r.dirname(t);)t=r.dirname(t),e.push(t);return e}function u(t){try{return i.readdirSync(t)}catch(t){return[]}}function l(t,e){const n=u(t);return e.every(t=>n.includes(t))}e.execDir=o.lazy(()=>r.dirname(process.execPath)),e.ancestors=a,e.childrenSync=u,e.ancestorWithChildren=function(t,e){return a(t).find(t=>l(t,e))},function(n){function i(t){return o.lazy(()=>r.join(n.Root(),t))}n.Root=o.lazy(()=>{const n=["migrations","public","tools","views"],i=[r.join(e.execDir(),"resources"),r.join(e.execDir(),"..","Resources"),e.execDir(),s.cwd(),t];for(const t of i){if(l(t,n))return t;for(const e of a(t).slice(0,4)){if(l(e,n))return e;const i=r.join(t,"node_modules","photostructure");if(l(i,n))return i}}throw new Error("Failed to find project root. Looked in "+i)}),n.Migrations=i("migrations"),n.Public=i("public"),n.Tools=i("tools"),n.Views=i("views")}(e.ProjectPath||(e.ProjectPath={}))}).call(this,"/")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(2),o=n(4),a=n(8),u=n(25),l=n(11);function c(t){const n=e.LogLevels.indexOf(t.toLowerCase());return-1===n?e.LogLevels.length-1:n}e.LogLevels=["error","warn","info","debug","trace"],e.levelIndex=c,e.silently=function(t){try{return e.logFilter().silent=!0,t()}finally{e.logFilter().silent=!1}},e.silentlyAsync=function(t){return i(this,void 0,void 0,(function*(){try{return e.logFilter().silent=!0,yield t()}finally{e.logFilter().silent=!1}}))},function(t){t.highlight=()=>!1,t.enabled=()=>!t.silent,t.defaultLevelIndex=c("trace"),t.silent=!1}(e.PermissiveLogFilter||(e.PermissiveLogFilter={}));const d=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i;class h{constructor(t){this.silent=!1,this.contexts=[];let e=c(l.Settings.logLevel.defaultValue);const n=s.notBlank(t)?t:l.Settings.logLevel.valueOrDefault;r.compactBlanks(n.split(",")).forEach(n=>{const i=d.exec(n.trim());if(null==i)u.isTest||console.error("EnvLogFilter: Ignoring '"+n+"' from "+t);else{const t=a.toS(i[1]).toLowerCase(),n=c(i[2]);s.blank(t)?e=n:this.contexts.push({prefix:t,levelIndex:n})}}),this.defaultLevelIndex=e}contextOverride(t){if(0===this.contexts.length&&s.blank(t))return;const e=a.toS(t).toLowerCase();return this.contexts.find(t=>e.startsWith(t.prefix))}enabled(t,e){if(this.silent)return!1;const n=c(t),i=this.contextOverride(e);return n<=(null!=i?i.levelIndex:this.defaultLevelIndex)}highlight(t){const e=this.contextOverride(t);return null!=e&&e.levelIndex>=this.defaultLevelIndex}}e.LogFilterImpl=h,e.logFilter=o.lazy(()=>new h),l.Settings.logLevel.addListener(()=>e.logFilter.clear())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(204),s=n(1),o=n(2),a=n(45),u=n(0),l=n(9),c=n(14),d=n(8),h=n(38),f=n(7),p=n(29),m=n(131),g=n(3),v=n(10),y=n(60),b=n(134),w=n(146),S=n(11),M=g.mkLogger("SettingsIO");e.systemSettingsFile=()=>p.BaseFile.for(h.App.getPath("userData")).join("settings.toml"),e.librarySettingsFile=t=>c.Opt(t).filter(o.notBlank).orElse(()=>S.Settings.libraryPath.value).filter(o.notBlank).flatMap(t=>b.libraryDataDir(t)).map(t=>t.join("settings.toml")).get(),e.libraryTxtFile=()=>p.BaseFile.for(h.App.getPath("userData")).join("library.txt"),e.readSystemSettings=function(){return i(this,void 0,void 0,(function*(){const t=yield f.thenOrElse(k(e.systemSettingsFile()),()=>[]);return o.blank(S.Settings.libraryPath.value)&&o.notBlank(yield function(){return i(this,void 0,void 0,(function*(){if(!S.Settings.libraryPath.hasValue()){const t=e.libraryTxtFile().clear();if(yield t.isNonEmpty()){const e=d.toS(yield t.readFile());if(o.notBlank(e))return M.info("Importing old library.txt file",{priorPath:e,libraryTxt:t}),S.Settings.libraryPath.value=e,(yield T())&&(yield t.renameWithNameSuffix("-obsolete")),e}}}))}())&&s.pushUniq(t,S.Settings.libraryPath),t}))},e.savedLibraryPath=function(){return f.thenMap(F(e.systemSettingsFile()),t=>t[S.Settings.libraryPath.name])},e.systemSettingsVersion=function(){return i(this,void 0,void 0,(function*(){return x(e.systemSettingsFile())}))},e.librarySettingsVersion=function(t){return i(this,void 0,void 0,(function*(){return u.map(e.librarySettingsFile(t),t=>x(t))}))};const P=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;function x(t){return i(this,void 0,void 0,(function*(){return f.thenMap(t.firstMatchingLine(P),t=>t[1])}))}const E={maxLineLen:78,prefix:"# "};function _(t,e){return i(this,void 0,void 0,(function*(){const n=yield t.clear().isNonEmpty(),r=n?yield t.wip():t;M.info("maybeWriteFile(): writing settings",{file:t});const o=yield function(t,e){return i(this,void 0,void 0,(function*(){const n=s.flatten(["","Hello!","","These are settings for PhotoStructure, and are formatted using TOML. See <https://github.com/toml-lang/toml>.","","NOTE: Please shut down PhotoStructure before editing this file.","",'Most settings have reasonable defaults, which are provided after the description. Remove the "#" from the beginning of the line to override the default.',"","Visit <https://support.photostructure.com> or email <mailto:hello@photostructure.com>.","","-- ","","PhotoStructure v"+y.version,""].map(t=>v.wrap(t,E)));e.forEach(t=>{n.push("","",...v.wrap(t.opts.description,E),"# (env: "+t.key+")");const e=t.addToJSON();if(s.isNotEmpty(l.keys(e))&&n.push("# "+JSON.stringify(e)),n.push("#"),t.defaultValue!==t.value){const e={};e[t.name]=t.defaultValue,n.push(...O(e).map(t=>"# "+t))}if(t.hasValueToPersist()){const e={};e[t.name]=t.valueOrDefault,n.push(...O(e))}});try{return t.writeTxt("\n"+n.map(t=>t.trimRight()).join("\n")+"\n\n")}catch(e){return M.error("Failed to write "+t+": "+e),!1}}))}(r,e);return o&&n&&((yield f.thenNot(a.eqlAsync(F(r),F(t))))&&(M.info("Archiving prior, different contents",{dest:r,file:t}),yield t.renameYMD()),yield r.unwip()),o}))}function O(t){return m.splitLines(...l.entries(t).map(([t,e])=>(null==e?"# ":"")+t+" = "+JSON.stringify(e,void 0,2)))}function T(){return _(e.systemSettingsFile(),S.persistedSystemSettings())}function F(t){return i(this,void 0,void 0,(function*(){return f.thenMap(t.readFile(),t=>r.parse(v.dumbquote(t.toString())))}))}function k(t){return i(this,void 0,void 0,(function*(){const e=g.mkLogger("FileSettings.importFileSettings("+t.baseWithGrandparent+")");try{e.debug("ENV before",S.psenv());const n=yield F(t);if(null==n){if(yield t.isNonEmpty())throw new Error("Failed to read "+t);return[]}const i=new Map(l.entries(S.Settings).filter(([,t])=>t instanceof w.Setting&&t.opts.persisted)),r=s.compact(l.keys(n).map(t=>{const r=n[t],s=i.get(t);return null==s?e.warn("Failed to import",{key:t}):s.hasValue()?e.debug("deferring to ENV",{key:t,tomlValue:r,currentValue:s.value}):s.value=r,s}));return e.info("loaded",{file:t.baseWithGrandparent,envAfter:S.psenv()}),r}catch(t){return void e.error("Cannot read",t)}}))}e.stringify=O,e.writeSystemSettings=T,e.readLibrarySettings=function(t){return i(this,void 0,void 0,(function*(){return u.map(e.librarySettingsFile(t),t=>k(t))}))},e.writeLibrarySettings=function(t){return i(this,void 0,void 0,(function*(){return yield b.setupLibraryDataDir(o.firstNotBlank(t,S.Settings.libraryPath.value)),u.map(e.librarySettingsFile(t),t=>_(t,S.persistedLibrarySettings()))}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(19),s=n(158),o=n(3),a=n(25),u=n(11),l=n(92),c=n(1),d=n(2),h=n(5),f=n(4),p=n(28),m=n(62),g=n(64),v=n(128),y=n(271),b=n(115);function w(){const t=r.memoryUsage();return t.external+t.heapTotal}function S(){const t=u.Settings.maxMemoryMb.valueOrDefault,e=w(),n=Math.floor(e/p.MB),i=`Memory usage for ${b.serviceName()} (${p.fmtBytes(e,2)}, max: ${p.fmtBytes(t*p.MB,2)})`;return n>t?(o.mkLogger("HealthChecks.memoryCheck()").warn(i),{bad:[`${i} is high`]}):{ok:[`${i} is OK`]}}e.memoryUsageBytes=w,e.memoryUsageIsHigh=function(){return u.Settings.maxMemoryMb.valueOrDefault<w()/p.MB},e.memoryCheck=S,e.syncSettingsCheck=function(){return a.isTest||u.Settings.scanMyPictures.valueOrDefault||u.Settings.scanAllDrives.valueOrDefault||!c.isEmpty(u.Settings.scanPaths.values)?{}:{warn:["Nothing to scan: scanMyPictures and scanAllDrives are false and scanPaths is empty."]}},e.healthChecks=f.lazy(()=>i(void 0,void 0,void 0,(function*(){try{return null==v.Library.instance.prior()||u.Settings.libraryPath.hasValue()?s.concatHealthChecks(yield g.dbRpc()?function(){return i(this,void 0,void 0,(function*(){const t=m.dbClient();return null!=t&&!0===(yield m.dbClientReady())?t.request("healthChecks"):{fail:["RPC client is not connected"]}}))}():y.libraryHealthChecks(),S()):s.fullhc({fail:["Missing Library path"]})}catch(t){return s.fullhc({fail:[d.notBlankOr(t,"healthChecks failed")]})}})),7*h.secondMs),u.Settings.libraryPath.addListener(()=>e.healthChecks.clear()),e.runvalve=function(){return i(this,void 0,void 0,(function*(){if(l.isPaused())return!1;const t=yield e.healthChecks();return null!=t&&c.isNotEmpty(t.ok)&&c.isEmpty(t.fail)&&c.isEmpty(t.warn)}))}},function(t,e){t.exports=require("url")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(209),s=n(99),o=n(1),a=n(2),u=n(5),l=n(4),c=n(0),d=n(9),h=n(8),f=n(77),p=n(12),m=n(71),g=n(7),v=n(26),y=n(13),b=n(3),w=n(150),S=n(10),M=n(76),P=n(29),x=n(80),E=n(27),_=n(32),O=l.lazy(()=>b.mkLogger("FileURI")),T=["http:","https:","file:",f.PS_LOCAL_FILE_PROTOCOL,f.PS_NETWORK_FILESYSTEM_PROTOCOL].map(t=>t+"//");function F(t,n){return i(this,void 0,void 0,(function*(){if(v.truthy(t.remote)){if(a.notBlank(t.remoteHost)&&a.notBlank(t.remoteShare)){const e=encodeURI(n.posixPathFrom(_.PosixFile.for(t.mountpoint)));return{protocol:f.PS_NETWORK_FILESYSTEM_PROTOCOL,hostname:r.toASCII(yield w.friendlyname(t.remoteHost)),pathname:r.toASCII(t.remoteShare)+(a.blank(e)?e:"/"+e),slashes:!0,volume:t}}}else if(a.notBlank(t.uuid))return{protocol:f.PS_LOCAL_FILE_PROTOCOL,hostname:e.volsha(t.uuid),pathname:encodeURI(n.posixPathFrom(_.PosixFile.for(t.mountpoint))),slashes:!0,volume:t}}))}e.isUri=function(t){const e=h.toS(t).toLowerCase();return T.some(t=>e.startsWith(t))},e.FileToFileUri=t=>{if(null==t||a.blank(t.posixPath))return;const e=h.toS(t.hostname),n={pathname:encodeURI(S.stripPrefix(t.posixPath,"//"+e)),protocol:"file:",slashes:!0};return a.notBlank(e)&&(n.hostname=r.toASCII(e)),n},e.volsha=m.memoize(t=>d.tap(a.mapNotBlank(t,x.shortStringSha),e=>O().debug("volsha",{uuid:t,ea:e})),1*u.hourMs,128),y.onClearCache(()=>e.volsha.clear()),e.volumeURI=F,e.FileToPsUri=t=>{const e=_.PosixFile.for(E.posix2native(t.posixPath));return g.thenMap(M.volumeFor(e.nativePath),t=>F(t,e))};const k=[e.FileToPsUri,e.FileToFileUri];function A(t){return i(this,void 0,void 0,(function*(){if(null!=t&&!a.blank(t.posixPath))return p.firstAsync(k,e=>e(t)).catch(e=>{O().warn("file2voluri failed",{file:t,err:e})})}))}e.addUriFormatter=function(t){k.unshift(t),p.uniqInPlace(k)},e.file2fileuri=function(t){return s.format(e.FileToFileUri(t))},e.nativePath2uriString=function(t){return g.thenMap(A({posixPath:E.native2posix(t)}),s.format)},e.file2voluri=A,e.uriToString=function(t){if(null==t||"string"==typeof t)return t;try{return s.format(t)}catch(e){return void O().warn("toString failed",{uri:t,err:e})}};const I=/^[a-z]+:\/\/([a-z0-9-\.]+?)(?:\/(.+)?)?$/i;e.PsfileUriToFile=(t,n)=>i(void 0,void 0,void 0,(function*(){if(null==t||a.blank(n))return;if(!S.equalsIgnoreCase(t.protocol,f.PS_LOCAL_FILE_PROTOCOL))return;const i=yield M.volumes();if(o.isEmpty(i))return void O().warn("PsfileUriToFile(): volumes() was empty: Can't resolve "+n);const r=n.match(I);if(null==r)return void O().warn("PsfileUriToFile(): didn't match regex",{raw:n});const s=r[1];if(a.blank(s))return void O().warn("PsfileUriToFile(): no volsha",{raw:n});const u=S.stripSuffix(decodeURI(h.toS(r[2])),"/").split("/"),l=i.find(t=>!t.remote&&a.notBlank(t.uuid)&&s===e.volsha(t.uuid));if(null!=l)return{posixPath:P.BaseFile.for(l.mountpoint).join(...u).posixPath};{const t=i.filter(t=>null!=t.uuid).map(t=>e.volsha(t.uuid));O().warn("PsfileUriToFile(): no volume had matching volsha",{raw:n,volid:s,volshas:t})}})),e.PsnetUriToFile=t=>i(void 0,void 0,void 0,(function*(){if(null==t)return;if(!S.equalsIgnoreCase(t.protocol,f.PS_NETWORK_FILESYSTEM_PROTOCOL))return;if(a.blank(t.pathname)||a.blank(t.hostname))return;const e=r.toUnicode(h.toS(t.hostname)),n=S.stripPrefix(h.toS(t.pathname),"/").split("/"),i=r.toUnicode(n.shift());if(a.blank(i))return;const s=n.map(decodeURIComponent);return g.thenMap(M.remoteVolumeFor(e,i),t=>({posixPath:P.BaseFile.for(t.mountpoint).join(...s).posixPath}))})),e.FileUriToFile=t=>{if(null==t)return;if(!S.equalsIgnoreCase(t.protocol,"file:")||a.blank(t.pathname))return;const e=decodeURI(h.toS(t.hostname)),n=decodeURI(h.toS(t.pathname));return a.notBlank(e)?{hostname:e,posixPath:n}:{posixPath:null!=n.match(/^\/[A-Z]:\//i)?n.substring(1):n}};const D=[e.PsfileUriToFile,e.PsnetUriToFile,e.FileUriToFile];function C(t){if(null!=t){if("string"!=typeof t&&[t.protocol,t.pathname,t.hostname].every(a.notBlank))return t;try{return s.parse(h.toS(t),!0)}catch(e){return void O().warn("toUrl failed",{uri:t,err:e})}}}e.addUriParser=function(t){D.unshift(t),p.uniqInPlace(D)},e.uri2file=function(t,e){return i(this,void 0,void 0,(function*(){if(a.blank(t))return;const n=function(t){try{return s.parse(t,!1,!0)}catch(e){return void O().warn("bad URI",{uri:t,err:e})}}(t);return null!=n?p.firstAsync(D,e=>e(n,t)).catch(i=>{if(O().warn("uri2file failed",{uri:t,err:i}),a.notBlank(e)&&null!=n.pathname){const t=n.pathname.split("/").slice(1);return{posixPath:_.PosixFile.for(e).join(...t).posixPath}}}):void 0}))},e.uri2protocol=function(t){return c.map(C(t),t=>t.protocol)},e.toUrl=C},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),s=n(0),o=n(6),a=n(94),u=n(3),l=n(170),c=n(16),d=n(11),h=n(242),f=n(37),p=n(81),m=n(173),g=n(112),v=n(103),y=n(137),b=n(123),w=n(188),S=n(165);function M(t,n){const i=u.mkLogger("img/Video.dim("+t+")"),r=d.Settings.minVideoDimension.valueOrDefault,a=n.ImageWidth;if(null!=a&&!c.gte(a,r))return i.throw("invalid width: "+a);const l=n.ImageHeight;if(null!=l&&!c.gte(l,r))return i.throw("invalid height: "+l);const f=s.orElse(h.extractBitrateKbps(n),e.MaxBitrateKbps),p=c.mapGt0(a,t=>c.mapGt0(l,n=>o.clamp(0,f,e.bitrateKps(t*n)))),m={width:a,height:l,videoBitrateKbps:p};return i.debug("dim()",{src:t,result:m}),m}e.MaxBitrateKbps=18e3,e.bitrateKps=t=>o.sigFigs(l.lerp2d({x:76800,y:800},{x:8294400,y:e.MaxBitrateKbps},t),2),e.extractVideoFrame=function(t,e,n=1){return i(this,void 0,void 0,(function*(){if(!w.isSupportedVideoMimeType(e))return;const r=yield m.isFFmpegSupported(),s=!r&&(yield S.isVlcSupported());if(!r&&!s)return;const o=u.mkLogger("img/Video.extractVideoFrame("+t+")"),a=yield v.tmpImgFile(t,"frame",".jpg");o.debug("extractVideoFrame",{src:t,dest:a,mimetype:e});const l=yield t.mtimeMs();if(null==l)return o.throw("null mtime");const c=yield f.readRawTags(t);if(null==c)return o.throw("no tags");const{width:d,height:h}=M(t,c),b=yield a.stat(),P=null!=b?yield g.dimensions(a):void 0;return!(null!=b&&b.mtimeMs>l&&null!=P)||null!=h&&P.height!==h||null!=d&&P.width!==d?(yield a.applyWip(e=>i(this,void 0,void 0,(function*(){const i={src:t,dest:e,durationSeconds:n,width:d,height:h};yield r?m.ffmpegFrame(i):S.vlcFrame(i);const s=p.extractRotation(c);yield f.deleteAllTags(e),null!=s&&0!==s&&(yield y.rotateInPlace(e,s))}))),a):(o.debug("sharpReadable("+t+"): prior dest, "+a+" seems reasonable"),a)}))},e.isVideoTranscodingSupported=function(){return i(this,void 0,void 0,(function*(){return d.Settings.transcodeVideos.valueOrDefault&&((yield m.isFFmpegSupported())||(yield S.isVlcSupported()))}))},e.transcode=function(t,e){return i(this,void 0,void 0,(function*(){if(!d.Settings.transcodeVideos.valueOrDefault)return;const n=yield t.size();if(!o.gt0(n))throw new Error("transcode(): cannot read "+t);const u=yield f.readRawTags(t);if(null==u)throw new Error("Cannot transcode files that exiftool can't read");if("video/mp4"===u.MIMEType)return;if(!w.isSupportedVideoMimeType(u.MIMEType))return;const l=yield m.isFFmpegSupported(),c=!l&&(yield S.isVlcSupported());return l||c?e.applyWip(o=>i(this,void 0,void 0,(function*(){const c=Object.assign({src:t,dest:o,timeoutMs:b.transcodeTimeout({bytes:n,durationMs:s.orElse(u.Duration,30)*r.secondMs,ext:t.ext})},M(t,u)),d=s.mapOr(u.Duration,t=>t*s.orElse(c.videoBitrateKbps,1e3)*300,()=>n),h=new a.PullProgressObserver({path:t.nativePath,op:"Transcoding video..."},d,()=>i(this,void 0,void 0,(function*(){return s.orElse(yield e.clear().size(),0)}))),f=yield h.observe(l?m.ffmpegTranscode(c):S.vlcTranscode(c));if(0!==f.code)throw new Error("transcode failed with code "+f.code)}))):void 0}))},e.validVideo=function(t){return i(this,void 0,void 0,(function*(){return(yield m.isFFmpegSupported())?m.ffmpegValidVideo(t):void 0}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(86),s=n(1),o=n(4),a=n(0),u=n(20),l=n(8),c=n(12),d=n(7),h=n(18),f=n(41),p=n(21),m=n(164);function g(t){return l.toS(t).toLowerCase().startsWith("tags")}e.capturedAtSrcFromTags=g;class v{constructor(t,e,n,i,r){this.file=t,this.date=e,this.src=n,this.mtime=i,this.precisionMs=r,this.toISOString=o.lazy(()=>f.datedToISO(this.date))}spread(t){const e=Object.assign(Object.assign({},this),t);return new v(e.file,e.date,e.src,e.mtime)}toLocal(){return h.isoToLocal(this.toISOString())}toOffset(){return f.datedToOffsetMinutes(this.date)}get isFromTags(){return g(this.src)}toPrecisionMs(){return a.orElse(this.precisionMs,()=>f.datedToPrecisionMs(this.date))}toString(){return JSON.stringify({file:this.file.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return f.hasZone(this.date)}hasTime(){return f.hasTime(this.date)}}function y(t,e){return i(this,void 0,void 0,(function*(){if(!f.validDate(e))return;if(f.hasZone(e))return e;const n=yield m.nearestSiblingTzOffset(t);if(null!=n){const t=f.toExifDateTime(e,n);if(f.validDate(t))return t}return e}))}function b(t){return a.map(t,t=>c.first(["SubSecDateTimeOriginal","DateTimeOriginal","SubSecCreateDate","CreateDate","SubSecMediaCreateDate","MediaCreateDate","OriginalCreateDateTime","DateTimeCreated","DateTimeUTC","GPSDateTime"],e=>f.mapValidDate(t[e],t=>({date:t,src:e}))))}e.CapturedAt=v,e.bestCapturedAt=function(t){return i(this,void 0,void 0,(function*(){const e=s.sortBy(t,t=>-t.mtime.getTime());return p.firstThunk(()=>e.find(t=>t.src.startsWith("tags")),()=>e.find(t=>t.src.startsWith("bname+stat")),()=>e.find(t=>t.src.startsWith("siblings")),()=>e.find(t=>t.src.startsWith("path")),()=>t[0])}))},e.capturedAtTags=function(t){return t=s.sortBy(u.toA(t),t=>-t.mtime),c.firstNonEmptyThunk(()=>t.filter(t=>t.src.startsWith("tags")),()=>t.filter(t=>t.src.startsWith("bname+stat")),()=>t.filter(t=>t.src.startsWith("siblings")),()=>t.filter(t=>t.src.startsWith("path")),()=>t.filter(t=>t.src.startsWith("stat")).slice(1,1),()=>[])},e.hasSubSecCapturedAt=function(t){return null!=t&&c.anyDefined([t.SubSecTime,t.SubSecTimeDigitized,t.SubSecTimeOriginal,t.SubSecCreateDate,t.SubSecDateTimeOriginal])},e.addTzFromSibs=y,e.extractCapturedAt=function(t,e,n){return i(this,void 0,void 0,(function*(){const o=yield t.mtime(),u=(a,u)=>i(this,void 0,void 0,(function*(){return d.thenMap(u,u=>d.thenMap(function(t,e,n,s){return i(this,void 0,void 0,(function*(){const i=yield n;if(f.validDate(i))return f.hasZone(i)?i:null!=e&&null!=e.tz&&r.Info.isValidIANAZone(e.tz)?f.setZone(i,e.tz):s?i:y(t,i)}))}(t,e,u.date,n),e=>new v(t,e,s.compactBlanks([a,u.src]).join(":"),o)))}));return d.firstDefinedPromise([()=>u("tags",b(e)),()=>u("bname+stat",m.extractStatname(t)),()=>n?void 0:u("siblings",m.inferCapturedAtFromSiblings(t)),()=>n?void 0:u("bname",a.map(f.parseDated(m.bname(t)),t=>({src:"",date:t}))),()=>n?void 0:u("path",a.map(f.extractDateFromPath(t.pathnamesWithoutDrive),t=>({src:"",date:t}))),()=>u("stat",d.thenMap(t.minStatDate(),t=>({src:"",date:t})))])}))},e.capturedAtFromTags=b},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),s=n(4),o=n(38),a=n(7),u=n(32),l=n(3),c=n(50),d=n(10),h=s.lazy(()=>l.mkLogger("ImgTmp"));function f(t,n,r){return i(this,void 0,void 0,(function*(){if(null==(yield t.stat()))throw new Error(`tmpImgFile(${t}): unreadable`);const i=yield e.imgtmpDir();if(null==i)throw new Error(`tmpImgFile(${t}): imgtmpDir() was null`);const s=yield a.thenMap(t.shaResult(),t=>t.buffer);if(null==s)throw new Error(`tmpImgFile(${t}): Could not read file`);const o=c.GeoRadix.encodeBuffer(s);r=d.ensurePrefix(r,".");const u=i.join(...d.splitEvery(o.slice(0,24),2,3),n+r);if(null==(yield u.parent().mkdirp()))throw new Error("Cannot make dest dir, "+u.parent());return h().info("tmpImgFile("+t.baseWithGrandparent+")",{desc:n,ext:r,result:u}),u}))}e.imgtmpDir=s.lazy(()=>i(void 0,void 0,void 0,(function*(){return u.PosixFile.for(o.App.temp()).mkNoMedia()})),r.minuteMs),e.tmpImgFile=f,e.readableToFile=function(t,e,n,r){return i(this,void 0,void 0,(function*(){try{return yield a.thenMap(f(t,e,n),t=>t.applyIfEmpty(t=>i(this,void 0,void 0,(function*(){return a.thenMap(r(),e=>t.writeStream(e))}))))}catch(e){throw h().warn("readableToFile("+t+"): "+e),e}}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(35);e.ReducerNames=i.strEnum("fit","sq"),e.isReducerName=function(t){return i.enumHas(e.ReducerNames,t)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(85),r=n(1),s=n(0),o=n(20),a=n(8);function u(t){return s.map(t,t=>s.orElse(t.name,a.toS(t)))}function l(t){return t.map(u)}function c(t){return l(t).join(e.sep).toLowerCase()}function d(t,e){const n=new Set(r.compact(e).map(t=>c(t)));return r.compact(t).filter(t=>!n.has(c(t)))}function h(t){return u(o.toA(t)[0])}function f(t){return new Set(r.compact(o.toA(t).map(h)))}e.sep=String.fromCharCode(31),e.When="When",e.Camera="Camera",e.Lens="Lens",e.Keywords="Keywords",e.Roots=[{name:e.When,ordinal:1},{name:e.Camera,ordinal:5},{name:e.Lens,ordinal:6},{name:e.Keywords,ordinal:7}],e.tagRefToS=u,e.tagPathToStringArray=l,e.joinTagPath=function(t,n=e.sep){return l(t).join(n)},e.tagPathEql=function(t,e){return null!=t&&null!=e&&c(t)===c(e)},e.tagDiff=d,e.tagDeltas=function(t,e,n=!0){const r=d(e,t),s=d(t,e),o=n?i.diff(f(s),f(r)):new Set;return{add:r,remove:s.filter(t=>!o.has(h(t)))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(12),s=n(13),o=n(260),a=n(16),u=n(83),l=n(1),c=n(2),d=n(5),h=n(4),f=n(0),p=n(6),m=n(14),g=n(262),v=n(49),y=n(28),b=n(105),w=n(62),S=n(64),M=n(82),P=n(130),x=n(78);const E=S.dbRpc()?3*d.minuteMs:30*d.secondMs;function _(t){return O.cacheTag(t),t}s.onClearCache(()=>O.clear()),e.DefaultRelatedAssetLimit=24;class O extends x.TimestampedModel{constructor(){super(...arguments),this.urls=h.lazy(()=>new g.TagUrls(this.id))}static clear(){this.root.clear(),this.roots.clear(),this._upsertDefaultRoots.clear(),this.recentTagsByPath.clear(),this.tagById.clear(),this._assetCountById.clear()}static onAssetTagChange(){this._assetCountById.clear()}static cacheTag(t){return i(this,void 0,void 0,(function*(){const e=yield t;null!=e&&(Array.isArray(e)?e.forEach(t=>this.cacheTag(t)):e instanceof O&&null!=e.id&&c.notBlank(e._path)&&(this.recentTagsByPath.set(e._path,e),f.map(e.id,t=>this.tagById.set(t,e))))}))}static newTag(t){const e=new O;e._path=b.joinTagPath(t);const n=t[t.length-1];return f.map(n.ordinal,t=>e.ordinal=t),e}static findByIdOrPath(t,e,n){return p.gt0(t)?this.findById(t,n):this.findByPath(e,n)}static findById(t,e){return 0===t?O.root():f.orElse(O.tagById.get(t),()=>_(this.ops().findById(t,e)))}static findByPath(t,e){if(l.isEmpty(t))return O.root();{const n=b.joinTagPath(t);return f.orElse(O.recentTagsByPath.get(n),()=>_(this.ops().findOneBy({_path:n},e)))}}static getPagedAssets(t,e){const n=new O;return n.id=t,n.getPagedAssets(e)}static findOrCreate(t){const e=w.dbClient();return null!=e?e.request("tagFindOrCreate",t).then(t=>O.fromJSON(t)):this._findOrCreate(t)}static _findOrCreate(t){if(S.assertLocalDb(),l.isEmpty(t))throw new Error("empty tagPath");const e=b.joinTagPath(t,"/"),n=this.findByPath(t);if(this.logger().debug("_findOrCreate("+e+")",{prior:n}),null!=n)return n;const i=this.newTag(t),r=i.isRoot?void 0:this._findOrCreate(t.slice(0,-1));f.map(r,t=>i.parentId=t.id);const s=_(this.opsLocal().upsertOne(i));return this.logger().debug("_findOrCreate("+e+") upserted",{newTag:i,result:s,parent:r}),s}set name(t){const e=null!=this.parent?this.parent.path:[];this._path=r.concat(e,[t]).join(b.sep)}get name(){const t=this.path;return t[t.length-1]}get path(){return f.orElse(c.mapNotBlank(this._path,t=>t.split(b.sep)),[])}get isRoot(){return-1===this._path.indexOf(b.sep)}get parentPath(){return this.path.slice(0,-1)}$childrenQuery(){return O.query().where({parentId:this.id}).orderByRaw("COALESCE(ordinal, _path)")}$assetsQuery(){return M.Asset.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0)}setAncestors(t){this.ancestors=t,this.parent=t[t.length-1],f.map(this.parent,e=>e.setAncestors(t.slice(0,-1)))}toApiTag(){return S.assertLocalDb(),{tagId:this.id,tagPath:this.path,assetCount:this.getAssetCount()}}toStringId(){return"Tag("+this.path.join("/")+")"}getParent(t){if(!this.isRoot)return null!=this.parentId&&null==this.parent?u.atap(O.findById(this.parentId,t),t=>this.parent=t):this.parent}getRoot(t){return this.isRoot?this:null!=this.root?this.root:u.atap(O.findByPath(this.path.slice(0,1),t),t=>this.root=t)}getPagedChildren(t,e){if(0===this.id)return this.children;let n=this.$childrenQuery();return a.mapGt0(t.offset,t=>n=n.offset(t)),a.mapGt0(t.limit,t=>n=n.limit(t)),O.ops().all(n,e)}getChildren(t){return u.atap(O.ops().all(this.$childrenQuery(),t),t=>{this.children=t,t.forEach(t=>{t.parent=this})})}link(){return"/tag/"+this.path.join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}getAncestors(t){const e=r.ancestry(this.parentPath).map(t=>b.joinTagPath(t)),n=e.map(t=>O.recentTagsByPath.get(t));if(n.every(t=>null!=t))return this.ancestors=n;const i=O.query().whereIn("_path",e).orderBy("_path");return u.atap(O.ops().all(i,t),t=>{_(t),this.ancestors=t,this.parent=f.orElse(this.parent,t[t.length-1])})}getPagedAssets(t,e){let n=this.$assetsQuery(),i="desc";return a.mapGte0(t.capturedAtLt,t=>{n=n.where("capturedAtLocal","<",t)}),a.mapGte0(t.capturedAtGt,t=>{n=n.where("capturedAtLocal",">",t),i="asc"}),a.mapGte0(t.limit,t=>n=n.limit(t)),n=n.orderBy("capturedAtLocal",i),M.Asset.ops().all(n,e)}getAssets(t){const e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return M.Asset.ops().all(e,t)}assetCountDesc(t){const e=this.getAssetCount();return(null==t||t.length===e||0===t.length?"":y.fmt(t.length)+" of ")+a.plur(e,"asset")}getDirectAssetCount(){return this._getAssetCountWithQuery(t=>t.where({tagId:this.id}))}getAssetCount(){const t=()=>this._getAssetCountWithQuery(t=>t.join("Tag as t","t.id","AssetTag.tagId").where("t._path","like",this._path+"%"));return S.dbRpc()?t():O._assetCountById.getOrSet(this.id,t)}_getAssetCountWithQuery(t){if(null==this.id)return 0;const e=P.AssetTag.query().countDistinct("AssetTag.assetId");return c.notBlank(this._path)&&t(e),P.AssetTag.ops().count(e)}$assetStreamQuery(t,e,n){return this.$assetsQuery().orderBy("capturedAtLocal",n?"desc":"asc").where("capturedAtLocal",n?"<":">",t.capturedAtLocal).limit(e)}getAssetStream(t,e){e=p.gt0(e)?e:8;const n=M.Asset.opsLocal().all(this.$assetStreamQuery(t,e,!0)),i=M.Asset.opsLocal().all(this.$assetStreamQuery(t,e,!1)).reverse();return new M.TaggedAssetStream([this],n,i)}getRelatedAssetIds(t,n=e.DefaultRelatedAssetLimit){const i=P.AssetTag.query().distinct("Asset.id","Asset.capturedAtLocal","Asset.updatedAt").join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).orderByRaw(o.prngOrderByClause(t+f.orElse(this.id,0),"Asset.id",f.orElse(T(),Math.pow(2,20)))).limit(n),r=M.Asset.opsLocal().all(i);return l.sortByInPlace(r,t=>m.Opt(t.capturedAtLocal).map(t=>-t).getOrElse(()=>0)),this.logger().debug(this.path+": Found "+r.length+" related assets"),r.map(t=>t.toID())}get attrs(){return{href:this.link(),title:this.name}}}e.Tag=O,O.tableName="Tag",O.uniqueColumnName="_path",O.recentTagsByPath=new v.TTLMap(E),O.tagById=new v.TTLMap(E),O._assetCountById=new v.TTLMap(30*d.secondMs),O.root=h.lazy(()=>{const t=new O;return t.id=0,t.name="",t._path="",t.parentId=void 0,u.atap(O.roots(),e=>t.children=e),t.ancestors=[],t.upsert=()=>{throw new Error("upsert not supported")},t},E),O._upsertDefaultRoots=h.lazy(()=>O.ops().upsert(b.Roots.map(t=>({_path:t.name,ordinal:t.ordinal})))),O.roots=h.lazy(()=>{const t=w.dbClient();if(null!=t)return t.request("tagRoots").then(t=>t.map(t=>O.fromJSON(t)));{O._upsertDefaultRoots();const t=O.query().whereNull("parentId").orderByRaw("coalesce(ordinal, _path)");return u.atap(O.ops().all(t),t=>{O.logger().info("roots()",t),t.forEach(t=>{t.parentId=void 0,t.ancestors=[],_(t)})})}});const T=h.lazy(()=>p.base10Ceil(M.Asset.dbLocal().pluckFirst(M.Asset.query().count("id"))),d.minuteMs)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isIterable=function(t){return null!=t&&"string"!=typeof t&&"function"==typeof t[Symbol.iterator]}},function(t,e){t.exports=require("fs-extra")},function(t,e){t.exports=require("stream")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(4),o=n(0),a=n(14),u=n(71),l=n(7),c=n(17),d=n(29),h=n(3),f=n(23),p=n(10),m=n(111),g=n(24);e.isGioSupported=s.lazy(()=>i(void 0,void 0,void 0,(function*(){if(!f.isLinux)return!1;try{return 0===(yield c.stdoutResult(e.GioCommand,["version"],{timeout:g.cmdTimeoutMs,ignoreStderr:!0})).code}catch(t){return!1}}))),e.GioCommand="gio",e.GioMountMonitorArgs=["mount","--monitor","--anonymous"];const v=h.mkLogger("Gio.gioVolumes()");e.gioVolumes=s.lazy(()=>i(void 0,void 0,void 0,(function*(){const t=yield function(){return i(this,void 0,void 0,(function*(){return(yield e.isGioSupported())?l.thenFlatten(yield l.thenMap(e.mtabEntries(),t=>t.map(t=>d.BaseFile.for(t).clear().childDirectories()))):[]}))}(),n=(yield l.thenFlatten(t.map(t=>i(void 0,void 0,void 0,(function*(){const e=yield m.dfPosixRaw(!1,t.nativePath).catch(e=>{v.warn("Failed to df "+t+": "+e)}),n=o.map(e,t=>t[0]);return o.map(n,e=>e.mountpoint=t.nativePath),n}))))).filter(t=>t.size>0);return Promise.all(n.map(t=>i(void 0,void 0,void 0,(function*(){return l.thenMapOr(b(t.mountpoint),e=>(t.remoteHost=e.remoteHost,t.remoteShare=e.remoteShare,t.label=e.displayName,t.remote=!0,t),()=>t)}))))})),g.dfTtlMs);const y=h.mkLogger("Gio.getRemoteInfo()"),b=u.memoize(t=>i(void 0,void 0,void 0,(function*(){try{const n=(yield c.stdout(e.GioCommand,["info",t],{timeout:g.cmdTimeoutMs})).split(/[\n\r]+/),i=r.mapNotBlank(n.find(t=>t.startsWith("uri: ")),t=>new URL(p.stripPrefix(t,"uri: ")));return{displayName:o.map(n.find(t=>t.startsWith("display name: ")),t=>p.stripPrefix(t,"display name: ")),remoteHost:o.map(i,t=>t.hostname),remoteShare:a.Opt(i).flatMap(t=>t.pathname).flatMap(t=>p.stripPrefix(t,"/")).flatMap(t=>p.stripSuffix(t,"/")).flatMap(decodeURIComponent).filter(r.notBlank).get()}}catch(e){return void y.warn("gio info failed",{mountpoint:t,err:e})}})),g.dfTtlMs,1e3);e.mtabEntries=s.lazy(()=>i(void 0,void 0,void 0,(function*(){return l.thenMap(d.BaseFile.for("/proc/mounts").readLines(),t=>t.filter(t=>t.startsWith("gvfsd-fuse ")).map(t=>t.split(" ")[1]))})),g.dfTtlMs)},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(6),o=n(8),a=n(17),u=n(68),l=n(23),c=n(206),d=n(24);function h(t){return 1024*s.toInt(t,{defaultValue:0})}const f=l.isMac?["devfs"]:["udev","tmpfs","devtmpfs"],p=["/boot/efi"];e.dfPosixRaw=function(t,e){return i(this,void 0,void 0,(function*(){const n=l.isMac?yield c.ignorableMacFilesystems():[],i=["-k","-P"];t&&i.push("-l"),r.notBlank(e)&&i.push(e);const s=yield a.stdout("df",i,{timeout:d.cmdTimeoutMs});return u.parseFixed(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],s).map(t=>({filesystem:t.Filesystem,size:h(t["1024-blocks"]),used:h(t.Used),available:h(t.Available),mountpoint:t["Mounted on"]})).filter(t=>{const e=o.toS(t.filesystem),i=o.toS(t.mountpoint);return r.notBlank(i)&&!p.includes(i)&&r.notBlank(e)&&!n.includes(e)&&!f.includes(e)})}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(93),s=n(5),o=n(6),a=n(49),u=n(7),l=n(179),c=n(37),d=n(44),h=new a.TTLMap(2*s.minuteMs);e.dimensions=function(t){return l.getOrSetByNativePath(t,()=>(function(t){return u.firstDefinedPromise([()=>u.thenMap(c.cachedTags(t),t=>t.dimensions),()=>(function(t){return i(this,void 0,void 0,(function*(){return d.isSharpExt(t.ext)?u.thenMap(function(t){return r(t.nativePath).metadata()}(t),t=>{const e=[t.width,t.height];o.gt0(t.orientation)&&[5,6,7,8].includes(t.orientation)&&e.reverse();const[n,i]=e;return o.gt0(n)&&o.gt0(i)?{width:n,height:i}:void 0}):void 0}))})(t),()=>u.thenMap(c.sizeInfo(t.nativePath),t=>({width:t.ImageWidth,height:t.ImageHeight}))])})(t),h)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(87),r=n(0),s=n(6),o=n(8),a=n(41),u=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/;class l{constructor(t,e,n,i=0,r=1){this.start=t,this.middle=e,this.end=n,this.index=i,this.splits=r,this.toISOString=this.toString.bind(this),this.year=a.getYear(this.middle),this.month=a.getMonth(this.middle),this.day=a.getDay(this.middle)}static fromISO(t){t=o.toS(t).trim();const e=u.exec(t);if(null==e)return;const n=i.ExifDateTime.fromISO(e[1]),r=i.ExifDateTime.fromISO(e[2]),a=s.toInt(e[3]),l=s.toInt(e[4]);return this.for(n,r,a,l)}static for(t,e,n=0,i=1){if(!a.validDate(t)||!a.validDate(e))return;const o=a.toExifDateTime(t),u=a.toExifDateTime(e);if(null==o||null==u)return;i=s.clamp(1,1e3,s.toInt(i,{defaultValue:1})),n=s.clamp(0,i-1,s.toInt(n,{defaultValue:0}));const c=r.map(o.toDateTime().until(u.toDateTime()).divideEqually(i+1)[n],t=>t.end);return null!=c?new l(o,a.toExifDateTime(c,r.orElse(o.zone,u.zone)),u,n,i):void 0}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return r.orElse(this.start.zone,this.end.zone)}get hasTimes(){return a.hasTime(this.start)&&a.hasTime(this.end)}toString(t=!0){return`${a.datedToISO(this.start,t)}/${a.datedToISO(this.end,t)}`+(0===this.index&&1===this.splits?"":`/${this.index}/${this.splits}`)}includes(t){if(null==t)return!1;const e=a.toExifDateTime(t);return null!=e?this.interval().contains(e.toDateTime()):this.year===a.getYear(t)&&this.month===a.getMonth(t)&&this.day===a.getDay(t)}}e.DateInterval=l},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(5),o=n(6),a=n(8),u=n(52),l=n(50),c=n(16),d=n(21),h=n(85);function f(t,e){if(null==t)return e;if(null==e)return t;if((t=t.normalize())===(e=e.normalize())||e.includes(t))return t;if(t.includes(e))return e;const n=new c.Array2D(t.length);let i=0,r="";for(let s=0;s<t.length;s++)for(let o=0;o<e.length;o++)t[s]===e[o]&&(0===s||0===o?n.set(s,o,1):n.set(s,o,n.get(s-1,o-1)+1),n.get(s,o)>=i&&(i=n.get(s,o),r=t.substr(s-i+1,i)));return r}function p(t,e){if(null!=t&&null!=e)return t=t.normalize(),e=e.normalize(),t.length!==e.length?void 0:t.split("").reduce((t,n,i)=>n===e.charAt(i)?t:t+1,0)}e.commonSubstringRatio=function(t,e){return[t,e].some(r.blank)?0:f(t,e).length/Math.max(t.length,e.length)},e.lcs=f,e.hamming=p;const m=new u.BoundedMap(10*s.minuteMs,1e4,!0),g=String.fromCharCode(31);function v(t,e){return t=t.normalize(),e=e.normalize(),m.getOrSet(i.sort([t,e]).join(g),()=>{if(0===t.length)return e.length;if(0===e.length)return t.length;const n=t.charAt(t.length-1)===e.charAt(e.length-1)?0:1,i=t.slice(0,-1),r=e.slice(0,-1);return Math.min(v(i,e)+1,v(t,r)+1,v(i,r)+n)})}function y(t,e){const n=t.toUpperCase().normalize(),i=e.toUpperCase().normalize();return d.firstThunk(()=>n===i?1:void 0,()=>r.blank(t)!==r.blank(e)?0:void 0,()=>1===t.length&&1===e.length?0:void 0,()=>{const t=b(n),e=b(i);return 2*w(t,e).length/(t.length+e.length)})}function b(t){return null==t||0===t.length?[]:t.slice(0,-1).split("").map((e,n)=>e+t[n+1])}function w(t,e){const n=h.intersection(t,e),r=[];return n.forEach(n=>{const s=Math.min(i.count(t,t=>t===n),i.count(e,t=>t===n));o.times(s,()=>r.push(n))}),r}function S(t,e,n){const r=i.commonPrefixLength(t,e);return n(t.substr(r))-n(e.substr(r))}function M(t){const e=i.compactBlanks(a.toS(t).split(/[^\d]+/));return i.sortBy(e,t=>-t.length)[0]}function P(t,e){const[n,i]=[t,e].map(M).map(t=>r.blank(t)?"":t);return S(n,i,t=>o.toInt(t,{defaultValue:0}))}e.levenshtein=v,e.diceCoeff=y,e.bigrams=b,e.nonUniqIntersection=w,e.lnsDiff=P;const x=/[^0-9a-z]+/gi;function E(t,e){const[n,i]=[t,e].map(t=>a.toS(t).replace(x,"").toLowerCase());return S(n,i,t=>l.RadixAlphaNum.decode(t))}e.radixDiff=E,e.str=function(t,e){return{pref:i.commonPrefixLength(t,e),lev:v(t,e),ham:p(t,e),dice:y(t,e),lns:P(t,e),radixDiff:E(t,e)}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});let i="";e.serviceName=function(){return i},e.setServiceName=function(t){i=t},e.isMainService=function(){return"main"===i}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(0),o=n(7);e.True=()=>!0,e.not=function(t){return e=>!t(e)},e.and=function(...t){return e=>{for(const n of t)if(!n(e))return!1;return!0}},e.or=function(...t){return e=>{for(const n of t)if(n(e))return!0;return!1}},e.all=function(t,e){for(const n of t)if(!e(n))return!1;return!0},e.some=function(t,e){for(const n of t)if(e(n))return!0;return!1},e.none=function(t,e){for(const n of t)if(e(n))return!1;return!0},e.find=function(t,e){for(const n of t)if(e(n))return n},e.filter=function(t,e){return i(this,void 0,void 0,(function*(){return null==t||null==e?s.mapOr(t,r.compact,()=>[]):o.asyncFilter(t,e)}))},e.apply=function(t,e){return i(this,void 0,void 0,(function*(){return null==t||null==e?t:(yield e(t))?t:void 0}))}},function(t,e){t.exports=require("semver")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.throttle=function(t,e,n=!1){let i=n?Date.now()+e:0,r=0;const s=()=>{const n=Date.now();return n>=i?(i=n+e,r++,t()):void 0};return s.count=()=>r,s}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(9),s=n(58),o=n(12),a=n(66),u=n(10),l=n(116);class c{constructor(t){this.apply=t}static lift(t){return new c(t)}static and(...t){return new c(e=>i(this,void 0,void 0,(function*(){for(const n of t){const t=yield n.apply(e);if(!t)return t}return!0})))}static or(...t){return new c(e=>i(this,void 0,void 0,(function*(){for(const n of t){const t=yield n.apply(e);if(t)return t}return!1})))}static andLogged(t,...e){return this.and(...o.flatMap(e,e=>r.entries(e).map(([e,n])=>n.asAsync().logged(t,e))))}static orLogged(t,...e){return this.or(...o.flatMap(e,e=>r.entries(e).map(([e,n])=>n.asAsync().logged(t,e))))}static andExplain(t,e){return i(this,void 0,void 0,(function*(){const n=[],i=[];for(const s of e)for(const[e,o]of r.entries(s))((yield o.apply(t))?n:i).push(e);return{accepted:n,rejected:i}}))}asAsync(){return this}and(...t){return c.and(this,...t)}not(){return c.lift(t=>this.apply(t).then(t=>!t))}or(t){return new c(e=>i(this,void 0,void 0,(function*(){return(yield this.apply(e))||(yield t.apply(e))})))}filter(t){return i(this,void 0,void 0,(function*(){return l.filter(t,t=>this.apply(t))}))}logged(t,e){return new c(n=>s.thenTap(this.apply(n),i=>{t.log(i?"debug":"info",[a.grey(e),i?a.green("ACCEPT"):a.red("REJECT"),u.ellipsize(n)].join(" "))}))}}e.AsyncFilter=c},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AssetFileVersion=8,e.AssetVersion=1},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(7),s=n(3),o=n(192),a=n(5),u=n(46),l=n(89);class c{constructor(t){this.db=t,this.recentTx=new o.TTLSet(30*a.secondMs),this.logger=s.mkLogger("Transactions("+t.name+")")}static for(t){return u.getOrSet(c.instances,t.name,()=>new c(t))}tx(t,e){return i(this,void 0,void 0,(function*(){try{if(this.recentTx.add(t),this.db.inTransaction&&(this.logger.warn("ALREADY IN TRANSACTION, I'll wait...",{ctx:t,recent:this.recentTx.toA()}),yield r.until(()=>!this.db.inTransaction,15e3,l.randomInt(20,100))),this.db.inTransaction)throw new Error("UNEXPECTEDLY IN A TRANSACTION YIKES");return this.db.transaction(()=>e())()}catch(e){throw this.logger.error("tx("+t+") error: "+e),e}}))}}e.Transactions=c,c.instances=new Map,e.tx=function(t,e,n){return c.for(t).tx(e,n)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(12),r=n(3),s=n(1),o=n(5),a=n(4),u=n(46),l=n(0),c=n(6),d=n(9),h=n(20),f=n(49),p=n(140),m=n(176),g=n(84),v=n(257);e.MaxBatchSize=99;class y{constructor(t){this.model=t,this.dbr=a.lazy(()=>new p.DbRequestLocal(this.model.db)),this.columnNames=a.lazy(()=>this.db.pragma(`table_info(${this.tableName})`).map(t=>t.name)),this.stmts=new f.TTLMap(30*o.secondMs),this.logger=r.mkLogger("ModelOpsLocal("+t.$ctor+")")}static forTableName(t){return this.instances.get(t)}static forModel(t){const e=t;return u.getOrSet(this.instances,e.tableName,()=>new y(e))}get db(){return this.model.db}get dbOpen(){return null!=this.model.db&&this.model.db.open}get tableName(){return this.model.tableName}toDbValued(t){const e=this.model.fromJSON(t),n=m.toDbValued(e);return d.pick(n,...this.columnNames())}exec(t,e){return this.dbr().exec(t)}run(t){return this.dbr().run(t)}first(t,e){return l.map(this.dbr().first(t),t=>this.model.fromJSON(t))}all(t,e){return this.dbr().all(g.maybeLimit(t)).map(t=>this.model.fromJSON(t))}findOne(t,e){return l.map(this.dbr().first(t.first()),t=>this.model.fromJSON(t))}findOneBy(t,e){return this.findOne(this.model.query().where(t))}findById(t,e){return this.findOneBy({id:t})}findByIds(t,n){const r=h.toA(t),o=s.flatten(i.batches(r,e.MaxBatchSize).map(t=>this.all(this.model.query().where("id","in",h.toA(t)))));return s.sortBy(o,t=>r.indexOf(t.id))}findBy(t,e){return this.all(this.model.queryBy(t))}rows(){return this.count(this.model.query())}count(t,e){return l.orElse(this.dbr().pluckFirst(t),0)}insert(t){const e=this.model.fromJSON(t);if(null!=e.id)throw new Error("insert called for "+JSON.stringify(t));e.$beforeUpsert();const n=e.$toDbJSON(this.columnNames()),i=this.run(this.model.query().insert(n));return this.findById(i.lastInsertRowid)}upsertOne(t,e){return this.upsert([t])[0]}get ucn(){return this.model.uniqueColumnName}upsert(t,n){if(t.length>e.MaxBatchSize)return s.flatten(i.batches(t,e.MaxBatchSize).map(t=>this.upsert(t)));const r=(Array.isArray(t)?t:[t]).map(t=>this.model.fromJSON(t)),o=r.map(t=>t[this.ucn]);r.forEach(t=>t.$beforeUpsert());const a=this.columnNames(),u=r.map(t=>t.$toDbJSON(a)).map(t=>{const e=g.toSqlQuery(v.mkUpsertSql(this.tableName,this.ucn,t));try{return this.stmts.getOrSet(e.sql,()=>this.db.prepare(e.sql)).run(e.bindings)}catch(t){throw this.logger.warn("upsert(): bad SQL",{tableName:this.tableName,sq:e}),t}}),c=o.map((t,e)=>l.orElse(t,u[e].lastInsertRowid)),d=this.all(this.model.query().whereIn(this.ucn,c)),h=s.sortBy(d,t=>o.indexOf(t[this.ucn]));return this.logger.debug("upsert()",{result:h}),h}delete(t,e){return s.mapNotEmpty(t.filter(c.gt0),t=>this.run(this.model.query().delete().whereIn("id",t)))}}e.ModelOpsLocal=y,y.instances=new Map},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(170),s=n(5),o=n(0),a=n(6),u=n(28),l=n(7),c=n(16),d=n(11),h=n(37),f=n(44),p=n(24);e.MinSyncFileTimeoutMs=30*s.secondMs,e.MaxSyncFileTimeoutMs=15*s.minuteMs,e.DurationMultiplier=10;const m={p0:{x:.8*u.MB,y:4*s.secondMs},p1:{x:20*u.MB,y:12*s.secondMs}},g={p0:{x:11*u.MB,y:12*s.secondMs},p1:{x:26*u.MB,y:24*s.secondMs}},v={p0:{x:7*u.MB,y:45*s.secondMs},p1:{x:32*u.MB,y:90*s.secondMs}};function y(t){return f.isVideoExt(t.ext)?Math.max(o.orElse(c.mapGt0(t.durationMs,t=>t*e.DurationMultiplier),0),r.lerp2d(v.p0,v.p1,t.bytes)):0}function b(t){return l.thenMap(w(t),S)}function w(t){return l.thenMap(t.size(),e=>i(this,void 0,void 0,(function*(){return{bytes:e,ext:t.ext,durationMs:f.isVideoExt(t.ext)?yield l.thenMap(h.readRawTags(t),t=>c.mapGt0(t.Duration,t=>t*s.secondMs)):void 0}})))}function S(t){const n=a.clamp(.5*u.MB,64*u.GB,t.bytes),i=5*s.secondMs,o=p.cmdTimeoutMs,l=2*n*p.MinIoRate,c=t=>r.lerp2d(t.p0,t.p1,a.clamp(.5*u.MB,50*u.MB,n)),h=c(m),v="raw"===f.extType(t.ext)?c(g):0,b=y(t),w=d.Settings.validateVideos.valueOrDefault?b:0;return{result:a.clamp(e.MinSyncFileTimeoutMs,e.MaxSyncFileTimeoutMs,Math.round(i+o+l+h+v+b+w)),dbMs:i,tagMs:o,copyMs:l,thumbMs:h,rawDecodeMs:v,transcodeMs:b,validateMs:w}}e.transcodeTimeoutForFile=function(t){return f.isVideoExt(t.ext)?l.thenMap(w(t),y):void 0},e.transcodeTimeout=y,e.syncFileTimeoutForFileMs=function(t){return l.thenMap(b(t),t=>t.result)},e.syncFileTimeoutForFile=b,e.syncFileTimeout=S},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(256),s=n(7),o=n(0),a=n(9);e.knex=r({client:"sqlite3",useNullAsDefault:!0}),e.firstMigratedAt=function(t){return i(this,void 0,void 0,(function*(){return s.thenMap(t("migrations").min("migration_time").first(),t=>o.map(a.values(t)[0],t=>new Date(t)))}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(30),s=n(2),o=n(5),a=n(4),u=n(6),l=n(7),c=n(26),d=n(52),h=n(18),f=n(13),p=n(3),m=n(29),g=n(135),v=n(27),y=/^\.?NoMedia$/i;function b(t){return null!=y.exec(t)}e.isNoMediaName=b,f.onClearCache(()=>S.clear()),f.onFileChanged(t=>{if(s.blank(t))S.clear();else for(const e of S.keys())e.startsWith(t)&&S.delete(e)});const w=15*o.secondMs,S=new d.BoundedMap(3*o.minuteMs,2e3,!1),M=a.lazy(()=>p.mkLogger("hasNoMedia()"));e.hasNoMedia=function t(e){return i(this,void 0,void 0,(function*(){if(e instanceof m.BaseFile)return t(yield e.directoryEntry());if(g.pathIsNeverIgnored(e.nativePath))return M().debug(e+" is never ignoed"),!1;if(b(e.base))return M().debug(e+" basename is NoMedia"),!0;const n=v.pathnames(e.nativePath);if(n.some(b))return M().debug(e+" parent path is NoMedia"),!0;for(let t=n.length-1;t>0;t--){const i=n.slice(0,t).join(r.sep),s=S.get(i);if(!0===s)return M().debug(e+" ancestor is NoMedia, "+i),!0;if(!1!==s&&(u.isNumber(s)&&(yield l.until(()=>c.isBoolean(S.get(i)),w))&&!0===S.get(i)))return M().debug(e+" ancestor is NoMedia, "+i),!0}const i=S.get(e.nativePath);if(c.isBoolean(i))return M().debug(e+" returning cached result, "+i),i;const s=yield e.isDirectory();if(s){if(null!=i&&h.isRecentMs(i,w)&&(M().debug(e+" is a work-in-progress. Waiting for prior result."),yield l.until(()=>c.isBoolean(S.get(e.nativePath)),w)))return t(e);M().debug(e+" has no cached result, I'll do it.");const n=Date.now();S.set(e.nativePath,n);const r=yield e.children();if(null==r)return M().debug(e+" is a directory but has no children.",{result:!1}),S.set(e.nativePath,!1),!1;if(r.some(t=>b(t.base)))return M().debug(e+" is a directory and has a noMedia child",{result:!0}),S.set(e.nativePath,!0),!0}const o=yield e.parent();if(null==o||e.nativePath===o.nativePath)return M().debug(e+" root",{result:!1}),S.set(e.nativePath,!1),!1;{M().debug(e+" deferring to parent");const n=yield t(o);return M().debug(e+" got result from parent",{result:n}),s&&S.set(e.nativePath,n),M().debug(e+" from parent",{result:n}),n}}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0),r=n(127),s=n(50),o=n(16);function a(t,e){return o.within(-90,90,t)&&o.within(-180,180,e)&&0!==t&&0!==e}function u(t,e,n=50){return a(t,e)?r.bitZip({dims:[{min:-180,value:e,max:180},{min:-90,value:t,max:90}],bitDepth:n}):void 0}function l(t,e=52){return i.map(r.bitUnzip(t,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:e}),t=>t.reverse())}e.validLatLon=a,e.geohash=function(t,e,n=52){return i.map(u(t,e,n),t=>s.GeoRadix.encode(t))},e.geohashNumericShort=function(t,e){return u(t,e,30)},e.geohashNumeric=u,e.ungeohash=function(t,e=52){return i.map(s.GeoRadix.decode(t),t=>l(t,e))},e.ungeohash_num=l},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(6),o=n(12),a=n(48);function u(t,e){const n=Math.pow(2,e),i=[];for(;t>0;)i.unshift(t%n),t=Math.floor(t/n);return i}function l(t){return t.toString(2).split("").reverse().map((t,e)=>"1"===t?e:-1).filter(t=>-1!==t)}e.concatBits=function(t,e){const n=Math.pow(2,e);return t.reduce((t,e)=>t*n+s.clamp(0,n,s.toInt(e,{defaultValue:0})),0)},e.splitBits=u,e.diffConcattedBits=function(t,e,n){return r.map2(t,e,(t,e)=>i.sum(o.zip(u(t,n),u(e,n)),([t,e])=>s.absdiff(t,e)))},e.bitZip=function(t){t.dims.forEach(t=>t.value=s.clamp(t.min,t.max,t.value));let e=0;for(let n=0;n<t.bitDepth;n++){e*=2;const i=n%t.dims.length,r=t.dims[i],s=a.avg([r.min,r.max]);r.value>s?(e+=1,r.min=s):r.max=s}return e},e.bitUnzip=function(t,e){if(e.bitDepth>52||e.bitDepth<0)return;const n=l(t);for(let t=0;t<e.bitDepth;t++){const i=t%e.dims.length,r=e.dims[i],s=a.avg([r.min,r.max]);n.includes(e.bitDepth-t-1)?r.min=s:r.max=s}return e.dims.map(t=>a.avg([t.min,t.max]))},e.bitsSet=l,e.pop=function(t){return t=(t=(858993459&(t-=t>>1&1431655765))+(t>>2&858993459))+(t>>4)&252645135,t+=t>>8,63&(t+=t>>16)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(22),s=n(54),o=n(7),a=n(15),u=n(32),l=n(189),c=n(103),d=n(282),h=n(3),f=n(227),p=n(287),m=n(134),g=n(11),v=n(97),y=n(65),b=n(2),w=n(39),S=n(4),M=n(0),P=n(9),x=n(267),E=n(64),_=n(228),O=n(263),T=n(264),F=n(291),k=n(292),A=n(265),I=n(268),D=n(299),C=n(159),L=n(270),R=h.mkLogger("Library");g.Settings.libraryPath.addListener(t=>i(void 0,void 0,void 0,(function*(){const e=M.map(N.instance.prior(),t=>t.rootDir);t!==e&&M.map(N.instance.clear(),r.end)})));class N extends r.EndableWrapper{constructor(t){super(`Library(${t})`,()=>this.onEnd()),this._ready=new s.Latch,this.setup=S.lazy(()=>i(this,void 0,void 0,(function*(){try{if(yield m.setupLibraryDataDir(this.rootDir),yield v.readLibrarySettings(this.rootDir.nativePath),!E.dbRpc()){if(null==(yield this.cacheDir()))throw new Error("Could not create cache dir"+a.FatalErrorFlag);if(null==(yield c.imgtmpDir()))throw new Error("Could not create cache dir"+a.FatalErrorFlag);if(yield y.retryOnReject(()=>this.assertNotOpen(),{maxRetries:5,onRetryWaitUntil:t=>w.delay(500*(t+1))}),null==(yield this.openedBy().write()))throw new Error("Failed to write to opened-by.json"+a.FatalErrorFlag);if(null==(yield this.modelDbJanitor()))throw new Error("Failed to set up model DB"+a.FatalErrorFlag);R.info("Setting up db RPC..."),yield this.dbServer()}T.installLibraryUriSupport(),this._ready.resolve()}catch(t){this._ready.reject(t)}}))),this.openedBy=S.lazy(()=>new I.OpenedByWriter(this.dataDir)),this.uidStore=S.lazy(()=>new l.UIDStore(this.dataDir)),this.uid=S.lazy(()=>this.uidStore().readUid()),this.cacheDir=S.lazy(()=>x.cacheDir()),this.localDbDir=S.lazy(()=>F.localDbDir()),this.previews=S.lazy(()=>new d.Previews(this.dataDir.join("previews"),O.RpcAdvisoryLockProvider)),this.assetFileRepository=S.lazy(()=>new L.AssetFileRepository(this.rootDir,()=>g.Settings.copyAssetsToLibrary.valueOrDefault)),this.modelDbJanitor=S.lazy(()=>i(this,void 0,void 0,(function*(){return E.dbRpc()?void 0:new k.ModelDbJanitor(this.dataDir,this.localDbDir)}))),this.statsDbJanitor=S.lazy(()=>i(this,void 0,void 0,(function*(){return D.statsDbJanitor(yield this.cacheDir())}))),this.modelDb=()=>o.thenMap(this.modelDbJanitor(),t=>t.db),this.statsDb=()=>o.thenMap(this.statsDbJanitor(),t=>t.db),this.dbServer=S.lazy(()=>i(this,void 0,void 0,(function*(){const t=yield this.modelDb();A.modelJsonSetup();const e=new _.DbServiceHandlers(t);f.sid.refresh();const n=new p.Server(g.Settings.rpcPort.valueOrDefault,e);return yield n.ready,R.info("dbServer(): RPC service up on "+n.port+" serving "+this.rootDir),C.stdoutWrite(g.Settings.rpcPort.addToEnv({})),n}))),this.rootDir=u.PosixFile.for(t),this.dataDir=m.libraryDataDir(this.rootDir)}assertNotOpen(){return i(this,void 0,void 0,(function*(){const t=yield I.readOpenedBy(this.dataDir);if(null!=t)throw new Error("Library is already open by "+t.hostname+a.FatalErrorFlag)}))}get ready(){return this._ready.promise}requiredFiles(){return i(this,void 0,void 0,(function*(){const t=[];return t.push({desc:"Library folder",isDir:!0,file:()=>this.rootDir}),t.push({desc:"Library model DB",isDir:!1,file:()=>o.thenMap(this.modelDbJanitor(),t=>t.srcDbFile)}),t.push({desc:"Library model DB (local cache)",isDir:!1,file:()=>o.thenMap(this.modelDbJanitor(),t=>t.localDbFile)}),t}))}onEnd(){return i(this,void 0,void 0,(function*(){return o.tryAll([()=>o.thenMap(this.dbServer.clear(),t=>t.end()),()=>o.thenMap(this.statsDbJanitor.clear(),t=>t.end(!0)),()=>o.thenMap(this.modelDbJanitor.clear(),t=>t.end()),()=>R.info("onEnd() finished.")])}))}}e.Library=N,N.instance=S.lazy(()=>b.mapNotBlank(g.Settings.libraryPath.value,t=>(R.log("info","Library.instance now points to "+t),P.tap(new N(t),t=>t.setup()))))},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(42),s=n(3),o=n(0),a=n(9),u=n(62),l=n(84);e.dbr=function(t,e){return i(this,void 0,void 0,(function*(){const n=o.orElse(e,new d),i=t(n);return null==e&&(yield n.submit()),i}))};const c=s.mkLogger("DbRequestRemote");class d{constructor(t=u.dbClient()){this.client=t,this.d=[],this.ops=[]}op(t,e){return this.ops.push(Object.assign(Object.assign({},l.toSqlQuery(e)),{method:t})),a.tap(new r.Deferred("DbRequestRemote."+t),t=>this.d.push(t)).promise}exec(t){return this.op("exec",t)}run(t){return this.op("run",t)}first(t){return this.op("first",t)}all(t){return this.op("all",t)}pluckFirst(t){return this.op("pluckFirst",t)}pluckAll(t){return this.op("pluckAll",t)}submit(){return this.client.request("batch",this.ops).then(t=>{c.debug("submit(): got response",{arr:t}),t.forEach((t,e)=>{const n=this.d[e],i=this.ops[e];c.debug("submit(): got response",{ea:t,sql:i}),n.resolve(t)})})}}e.DbRequestRemote=d},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(13),s=n(83),o=n(174),a=n(1),u=n(5),l=n(0),c=n(6),d=n(139),h=n(106);r.onClearCache(()=>f.clear());class f extends d.Model{static clear(){this.assetId2tagIds.clear()}$pk(){return[l.orElse(this.assetId,()=>l.map(this.asset,t=>t.id)),l.orElse(this.tagId,()=>l.map(this.tag,t=>t.id))].join(":")}static addTagsToAsset(t,e,n){return i(this,void 0,void 0,(function*(){const i=c.id(t);if(null==i)return void this.logger().warn("addTagsToAsset(): got null assetId");const r=a.compact(e.map(c.id));if(a.isEmpty(r))return void this.logger().warn("addTagsToAsset(): no tagIds",{assetId:t,tagIds:e});const s="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+r.map(t=>`(${i},${t})`).join(",");return h.Tag.onAssetTagChange(),e.forEach(e=>this.assetId2tagIds.add(t,e)),this.dbr(t=>t.run(s),n)}))}static removeTagsFromAsset(t,e,n){e=a.compact(e),h.Tag.onAssetTagChange();const i=this.query().whereIn("tagId",e).andWhere({assetId:t}).delete();return s.atap(this.dbr(t=>t.run(i),n),()=>e.forEach(e=>this.assetId2tagIds.delete(t,e)))}}e.AssetTag=f,f.tableName="AssetTag",f.assetId2tagIds=new o.TTLMultiMap(5*u.minuteMs)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(23),s=n(10),o=n(8);e.crlf=function(t){const e=t+"\n";return r.isWin?e.replace(s.newlineRe,"\r\n"):e},e.splitLines=function(...t){return i.flatten(t.map(t=>o.toS(t).split(s.newlineRe)))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(143),r=n(34),s=n(1),o=n(14),a=n(8),u=n(66),l=n(25),c=n(11),d=n(133),h=n(96);e.OnlyMessages={formatLogEntry:t=>t.msg,format:(t,e,n,i)=>n};const f=[{re:/sync-file/,f:i.default.bgCyan},{re:/sync/,f:i.default.bgBlue},{re:/web/,f:i.default.bgGreen},{re:/db/,f:i.default.bgMagenta},{re:/main/,f:i.default.bgRed}];class p{constructor(t={}){this.chalkedLevels=new Map,this.inspectOptions=Object.assign(p.defaultInspectOptions(),t),c.Settings.logColor.valueOrDefault?(i.default.enabled=!0,i.default.level=1):(this.inspectOptions.colors=!1,i.default.enabled=!1),l.isTest&&(this.inspectOptions.breakLength=255),this.chalkedLevels.set("error",u.red("error")),this.chalkedLevels.set("warn",u.yellow("warn ")),this.chalkedLevels.set("info",u.green("info ")),this.chalkedLevels.set("debug",u.blue("debug")),this.prefix=o.Opt(t.prefix).flatMap(t=>o.Opt(f.find(e=>null!=t.match(e.re))).map(e=>e.f(u.black(t))).getOrElse(()=>t)).getOrElse(()=>"")}formatLogEntry(t){return s.compactBlanks([d.dateForLog(t.timestamp),this.chalkedLevels.get(t.level),u.blue(t.context),t.msg,m(t.meta,this.inspectOptions)]).map(t=>a.toS(t)).join(" ")}format(t,e,n,i){const r=h.logFilter().highlight(e)?u.yellow:u.blue;return s.compactBlanks([u.grey((new Date).toISOString()),this.prefix,this.chalkedLevels.get(t),r(e),n,m(i,this.inspectOptions)]).map(t=>a.toS(t)).join(" ")}}function m(t,e){return null==t?t:r.inspect(t,e)}e.ColoredLogFormatter=p,p.defaultInspectOptions=()=>({showHidden:!1,depth:4,compact:!0,colors:!0,customInspect:!0,maxArrayLength:25}),e.DefaultLogFormatter=new p},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(66);e.dateForLog=function(t){return i.grey(new Date(t).toISOString())},e.DefaultLogFlushMs=200},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(32),o=n(60),a=n(11),u=`\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n\nMoving or deleting any files here will cause problems using your library.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v${o.version}`;function l(t=a.Settings.libraryPath.value){return r.mapNotBlank(t,t=>s.PosixFile.for(t).join(".photostructure"))}e.libraryDataDir=l,e.setupLibraryDataDir=function(t){return i(this,void 0,void 0,(function*(){const e=l(t);if(null==e)throw new Error("empty dataDir");if(null==(yield e.mkdirp()))throw new Error("Could not mkdirp "+e);yield e.mkNoMedia();const n=e.join("README.txt");if((yield n.size())!==u.length&&!(yield n.writeTxt(u)))throw new Error("Could not write README to "+e);return e}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(4),s=n(8),o=n(13),a=n(11),u=r.lazy(()=>{a.Settings.neverIgnored.addListener(()=>{l.clear(),o.emitFileChanged()}),a.Settings.scanPaths.addListener(()=>{l.clear(),o.emitFileChanged()}),o.onClearCache(()=>l.clear())}),l=r.lazy(()=>(u(),new Set(i.compactBlanks([...a.Settings.scanPaths.values,...a.Settings.neverIgnored.values]))));function c(t){return l().has(t)||l().has(t.toLowerCase().normalize())}e.pathIsNeverIgnored=c,e.neverIgnore=function(...t){a.Settings.neverIgnored.push(...i.compactBlanks(t.map(s.toS)))},e.pathIsNeverIgnoredPredicate=function(t){return c(t)?{pathIsNeverIgnored:()=>!1}:void 0}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0);function r(t){return i.map(t,t=>t+360*Math.ceil(-t/360))}e.normalizeRotation=r,e.flippable=function(t){const e=r(t);return 90===e||270===e}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),s=n(7),o=n(17),a=n(13),u=n(138),l=n(23),c=n(81),d=n(103),h=l.isWin?"NUL":"/dev/null";function f(t,e,n){return i(this,void 0,void 0,(function*(){const i=yield u.jpegtranNativePath();if(!c.isRotation(n))throw new Error("refusing to rotate("+t+", "+n+")");yield o.stdout(i,["-copy","all","-trim","-rotate",n.toFixed(0),"-outfile",e.nativePath,t.nativePath],{timeout:r.minuteMs})}))}e.validJpeg=function(t){return i(this,void 0,void 0,(function*(){const e=yield u.jpegtranNativePath();yield o.stdoutResult(e,["-outfile",h,t.nativePath],{timeout:30*r.secondMs})}))},e.rotateInPlace=function(t,e){return i(this,void 0,void 0,(function*(){const n=t.wip();yield f(t,n,e),yield n.unwip(),a.emitFileChanged(t.nativePath)}))},e.rotate=f,e.rotateToImgTmp=function(t,e){return i(this,void 0,void 0,(function*(){return null==e||0===e?t:s.thenMap(d.tmpImgFile(t,"r"+e,t.ext),n=>n.applyIfEmpty(n=>f(t,n,e)))}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(43),s=n(4),o=n(0),a=n(7),u=n(15),l=n(23),c=n(10),d=n(29),h=n(95);function f(...t){return i(this,void 0,void 0,(function*(){l.isWin&&t.push(c.ensureSuffix(t.pop(),".exe"));const e=o.map(h.ProjectPath.Tools(),t=>d.BaseFile.for(t));if(null==e||(yield e.isNotDirectory()))throw new Error("Cannot find project path for tools"+u.FatalErrorFlag);function n(n){return e.join(l.platformName+"-"+n,...t)}return a.firstTruePromise(t=>o.map(t,t=>t.exists()),()=>n(r.arch()),()=>"x64"===r.arch()?n("ia32"):void 0,()=>{throw new Error("Cannot find path to tool "+t)})}))}e.toolFile=f,e.dcrawNativePath=s.lazy(()=>f("dcraw","dcraw").then(t=>t.nativePath)),e.jpegtranNativePath=s.lazy(()=>f("jpegtran","jpegtran").then(t=>t.nativePath)),e.sqliteNativePath=s.lazy(()=>f("sqlite3","sqlite3").then(t=>t.nativePath))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(34),r=n(26),s=n(3),o=n(25),a=n(83),u=n(1),l=n(2),c=n(0),d=n(9),h=n(69),f=n(8),p=n(140),m=n(129),g=n(64),v=n(124),y=n(121),b=n(183),w=n(122),S=n(258);class M{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return null==this._logger&&(this._logger=s.mkLogger(this.tableName)),this._logger}static query(){return v.knex(this.tableName)}static queryBy(t){return this.query().where(t)}static queryOneBy(t){return this.queryBy(t)}static dbr(t,e){return g.dbRpc()?m.dbr(t,e):t(this.dbLocal())}static dbLocal(){if(null==this.db)throw new Error("only supported on db-local processes");return new p.DbRequestLocal(this.db)}static txOp(t,e){const n=this;if(null==n.db)throw new Error("only supported on db-local processes");return y.tx(n.db,n.tableName+": "+t,()=>e(n.opsLocal()))}static txDb(t,e){const n=this;if(null==n.db)throw new Error("only supported on db-local processes");return y.tx(n.db,n.tableName+": "+t,()=>e(new p.DbRequestLocal(n.db)))}static ops(){return g.dbRpc()?S.ModelOpsRemote.forModel(this):w.ModelOpsLocal.forModel(this)}static opsLocal(){if(null==this.db)throw new Error("db isn't set: only supported on db-local processes");return w.ModelOpsLocal.forModel(this)}static opsRemote(){return g.assertDbRpc(),S.ModelOpsRemote.forModel(this)}static truncate(){if(o.isProd)throw new Error("rejecting attempt to truncate in prod");return this.dbr(t=>t.exec("DELETE FROM "+this.tableName))}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return f.toS(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${c.orElse(this.id,this[this.class().uniqueColumnName])})`}logger(){return s.mkLogger(f.toS(this.valueOf()))}[i.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(t){return b.fromJSON(this,t)}static toJSON(t){return this.fromJSON(t).toJSON()}static toDbJSON(t,e){return this.fromJSON(t).$toDbJSON(e)}$toShallowJSON(){return this.$_toJSON(r.truthy)}$toDbJSON(t){const e=this.$_toJSON(r.boolToInt);return l.notBlank(t)?d.pick(e,...t):e}toJSON(){return this.$_toJSON(r.truthy)}$_toJSON(t){const e=this.class();return d.mapFields(this,(n,i)=>{if(null!=i&&h.isPrimitive(i))return u.includes(e.booleanFields,n)?[n,t(i)]:[n,i]},{$ctor:e.$ctor})}insert(){return this.$beforeUpsert(),a.atap(this.class().ops().insert(this),t=>{b.assignFromJSON(this,t)})}upsert(){return a.atap(this.class().ops().upsertOne(this),t=>{const e=this.class().uniqueColumnName;if("id"!==e&&this[e]!==t[e])throw this.logger().error("unexpected upsert result",{self:this,upserted:t}),new Error("unexpected upsert result");b.assignFromJSON(this,t)})}$beforeUpsert(){}}e.Model=M,M.schema="models"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(3),r=n(0),s=n(84),o=i.mkLogger("DbRequestLocal");e.DbRequestLocal=class{constructor(t){this.db=t}exec(t){this.db.exec(s.toSqlQuery(t).sql)}prep(t){const e=s.toSqlQuery(t),n=this.db.prepare(e.sql);return r.mapOr(e.bindings,t=>n.bind(t),()=>n)}run(t){return this.prep(t).run()}first(t){return this.prep(t).get()}all(t){const e=Date.now(),n=s.toSqlQuery(t),i=this.prep(n).all(),r=Date.now()-e;return r>10&&o.info("all() took a while",{elapsed:r,sq:n,result:i}),i}pluckFirst(t){return this.prep(t).pluck().get()}pluckAll(t){return this.prep(t).pluck().all()}},e.DbMethods=["exec","run","first","all","pluckFirst","pluckAll"]},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6);e.BoundedList=class{constructor(t){if(this.maxLength=t,this._length=0,this._firstIndex=0,t>1e3)throw new Error("BoundedList.maxLength of "+t);this.store=new Array(...i.times(t,()=>null))}mapIndex(t,e){return t<0||t>this._length-1?void 0:e((t+this._firstIndex+this.maxLength)%this.maxLength)}get(t){return this.mapIndex(t,t=>this.store[t])}set(t,e){return this.mapIndex(t,t=>this.store[t]=e)}get length(){return this._length}set length(t){this._length=i.clamp(0,this._length,t)}[Symbol.iterator](){const t=this;return function*(){for(let e=0;e<t.length;e++)yield t.mapIndex(e,e=>t.store[e])}()}push(...t){for(const e of t)this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,t=>{this.store[t]=e});return this._length}pop(){return this.mapIndex(this._length-1,t=>(this._length--,this.store[t]))}unshift(...t){for(const e of t.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,t=>{this.store[t]=e,this._firstIndex=t});return this._length}shift(){return this.mapIndex(0,t=>(this._firstIndex++,this._length--,this.store[t]))}every(t){for(let e=0;e<this._length;e++)if(!t(this.get(e),e))return!1;return!0}some(t){for(let e=0;e<this._length;e++)if(t(this.get(e),e))return!0;return!1}forEach(t){for(let e=0;e<this._length;e++)t(this.get(e),e)}map(t){const e=[];for(let n=0;n<this._length;n++)e.push(t(this.get(n),n));return e}reduce(t,e){let n=e;for(let e=0;e<this._length;e++)n=t(n,this.get(e),e);return n}reverse(){for(let t=0;t<Math.floor(this._length/2);t++)this.mapIndex(t,e=>{this.mapIndex(this._length-1-t,t=>{const n=this.store[t];this.store[t]=this.store[e],this.store[e]=n})});return this}toA(){return[...this]}slice(t,e){return[...this].slice(t,e)}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(6),o=n(9),a=n(57);e.CountingSet=class{constructor(){this.m=new Map}incr(t,e=1){const n=this.get(t)+e;return 0===n?this.m.delete(t):this.m.set(t,n),this}get(t){return r.orElse(this.m.get(t),()=>0)}has(t){return this.m.has(t)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){const t=new a.Average(0);for(const e of this.keys()){if(!s.isNumber(e))return;t.push(e)}return t.avg}entries(){return this.m.entries()}entriesByCountDesc(){const t=this.keyAvg();return i.sortBy([...this.entries()],([e,n])=>[-n,s.mapNumericOr(t,t=>Math.abs(e-t),0)])}top(t=1){return this.entriesByCountDesc().slice(0,t)}topKeys(t=1){return this.top(t).map(t=>t[0])}get averageCounts(){return o.tap(new a.Average(this.size),t=>[...this.m.values()].forEach(e=>t.push(e)))}forEach(t){this.m.forEach(t)}clear(){this.m.clear()}get toS(){return i.sort([...this.keys()]).map(t=>t+" "+this.get(t)).join("\n")}}},function(t,e){t.exports=require("chalk")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(43),r=n(30),s=n(19),o=n(2),a=n(73);e.appData=function(){const t=a.getEnv("APPDATA");if(o.notBlank(t))return r.resolve(t);switch(i.platform()){case"win32":return r.resolve(i.homedir(),"AppData","Roaming");case"darwin":return r.resolve(i.homedir(),"Library","Application Support");case"linux":return o.firstNotBlank(s.env.XDG_DATA_HOME,s.env.XDG_CONFIG_HOME,r.resolve(i.homedir(),".config"));default:throw new Error("Platform not supported")}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AppName="PhotoStructure"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(30),r=n(19),s=n(1),o=n(2),a=n(45),u=n(0),l=n(6),c=n(9),d=n(33),h=n(14),f=n(35),p=n(20),m=n(8),g=n(26),v=n(25),y=n(21);e.envAtStartup=h.Opt(Object.assign({},r.env)).map(t=>v.isProd?Object.freeze(t):t).get(),e.SettingCategories=f.strEnum("System","Logging","Updates","Reporting","Tools","Web","Sync","Filters"),e.LibraryCategories=Object.freeze([e.SettingCategories.Web,e.SettingCategories.Sync,e.SettingCategories.Filters,e.SettingCategories.Reporting]),e.SystemCategories=Object.freeze(f.strEnumValues(e.SettingCategories).filter(t=>!e.LibraryCategories.includes(t)));class b{constructor(t){this.opts=t,this.listeners=[],b.instances.push(this),this.importFromEnv(),this.addToChildProcs=!0===t.addToChildProcs}static importSavedPref(t){return o.mapNotBlank(t.key,e=>u.map(this.instances.find(t=>t.key===e),e=>y.Try(()=>c.tap(e,e=>e.value=t.value))))}readFromEnv(t){return h.Opt(t).orElse(r.env).flatMap(t=>t[this.opts.key]).filter(o.notBlank).orElse(()=>h.Opt(this.opts.alternateKeys).map(t=>t.map(t=>r.env[t])).flatMap(t=>t.find(o.notBlank))).flatMap(this.opts.fromEnv).get()}importFromEnv(){if(!this.hasValue())return u.map(this.readFromEnv(r.env),t=>this.value=t)}addListener(t){this.listeners.push(t),this.hasValue()&&setImmediate(()=>t(this.value))}removeListener(t){s.filterInPlace(this.listeners,e=>e===t)}onChange(){const t=this.value;this.listeners.forEach(e=>e(t))}get name(){return this.opts.name}get key(){return this.opts.key}get category(){return this.opts.category}get persisted(){return this.opts.persisted}get advanced(){return u.orElse(this.opts.advanced,!0)}get value(){return this._value}set value(t){const e=this._value;this._value=this.opts.fromEnv(this.opts.toEnv(t)),a.eql(e,this._value)||this.onChange()}set valueFromFile(t){this.value!==this.defaultValue&&(this.value=t)}get defaultValue(){return d.isFunction(this.opts.defaultValue)?this.opts.defaultValue():this.opts.defaultValue}get valueOrDefault(){return u.orElse(this.value,this.defaultValue)}addToEnv(t,e){const n=u.orElse(t,r.env);return n[this.opts.key]=w(this.opts.toEnv(u.orElse(e,this.valueOrDefault))),n}deleteFromEnv(t){const e=u.orElse(t,r.env);return delete e[this.opts.key],u.map(this.opts.alternateKeys,t=>t.forEach(t=>{delete e[t]})),e}hasValue(){return null!=this.value&&this.value!==this.defaultValue}hasValueToPersist(){return this.hasValue()&&this.value!==this.readFromEnv(e.envAtStartup)}clear(){return this._value=void 0,this.deleteFromEnv(),this.onChange(),this}addToJSON(){return{}}toJSON(){return{key:this.opts.key,value:this.value,defaultValue:this.opts.defaultValue,description:this.opts.description}}}e.Setting=b,b.instances=[];const w=t=>o.notBlank(t)&&"undefined"!==t?m.toS(t).trim():void 0;function S(t,e){const n=m.toS(t).toLowerCase();return e.find(t=>t.toLowerCase()===n)}e.StringSetting=class extends b{constructor(t){super(Object.assign({toEnv:w,fromEnv:w},t))}hasValue(){return o.notBlank(this.value)}};e.StringEnumSetting=class extends b{constructor(t){if(super(Object.assign({toEnv:e=>S(e,t.validValues),fromEnv:e=>S(e,t.validValues)},t)),this.validValues=t.validValues,!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${t.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}};e.StringArraySetting=class extends b{constructor(t){super(Object.assign({defaultValue:[],fromEnv:t=>o.mapNotBlank(t,t=>{try{return s.compactBlankish(p.toA(JSON.parse(t)))}catch(e){return s.compactBlankish(t.split(i.delimiter))}}),toEnv:t=>u.map(t,t=>JSON.stringify(s.uniq(t)))},t))}get values(){return s.uniq(s.compactBlanks(this.valueOrDefault))}push(...t){this.value=s.uniq(s.compactBlanks(this.valueOrDefault.concat(...t)))}removeValue(t){u.map(this.value,e=>this.value=e.filter(e=>e!==t))}};e.StringEnumsSetting=class extends b{constructor(t){super(Object.assign({defaultValue:t.defaultValue,fromEnv:t=>o.mapNotBlank(t,t=>{try{return this.asValidValues(JSON.parse(t))}catch(e){return this.asValidValues(t.split(i.delimiter))}}),toEnv:t=>u.map(t,t=>JSON.stringify(s.uniq(t)))},t)),this.validValues=t.validValues}asValidValues(t){return s.compactBlankish(p.toA(t).map(t=>S(m.toS(t),this.validValues)))}addToJSON(){return{validValues:this.validValues}}};e.IntegerSetting=class extends b{constructor(t){super(Object.assign(Object.assign({},t),{toEnv:w,fromEnv:l.toInt}))}};e.BoundedIntegerSetting=class extends b{constructor(t){super(Object.assign(Object.assign({},t),{toEnv:w,fromEnv:e=>h.Opt(e).flatMap(parseInt).map(e=>l.clamp(t.min,t.max,e)).get()})),this.options=t}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};e.BooleanSetting=class extends b{constructor(t){super(Object.assign(Object.assign({},t),{toEnv:w,fromEnv:g.toBoolean}))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(91),r=n(19),s=n(5),o=n(0),a=n(22),u=n(15),l=n(3),c=n(74);class d{constructor(t,e){this.name=t,this.bc=e}get ended(){return this.bc.ended}end(){return i.setLogger(i.NoLogger),this.bc.end()}}e.observeBatchCluster=function(t,e,n=a.EndableRanks.service){const h=l.mkLogger(e);return i.setLogger(h),a.addEndable(n,new d(e,t)),t.on("childStart",n=>c.addPid({pid:n.pid,ppid:r.pid,cmd:e,maxAgeMs:t.options.maxProcAgeMillis+s.minuteMs},new Date)),t.on("startError",t=>{u.onError("Failed to start "+e+u.FatalErrorFlag,t)}),t.on("taskError",(t,n)=>{const i=o.map(n,t=>t.command);h.warn("observeBatchCluster.taskError()",{error:t,cmd:i}),u.onError(e+" failed to run "+i,t)}),t.on("internalError",t=>{h.warn("observeBatchCluster.internalError()",t),u.onError("Internal error from "+e,t)}),t.on("endError",t=>{h.warn("observeBatchCluster.endError()",t),h.error("Failed to shut down: "+t)}),t}},function(t,e){t.exports=require("crypto")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(4),s=n(9),o=n(96),a=n(132),u=n(75);class l{constructor(t,e=[["error",console.error]]){this.logFilter=t,this.loggers=s.fromEntries(e)}log(t,e,n,i){(this.loggers[t]||console.log)(a.DefaultLogFormatter.format(t,e,n,i))}enabled(t,e){return this.logFilter.enabled(t,e)}flush(){return i(this,void 0,void 0,(function*(){}))}close(){}}e.ConsoleLogger=l,l.instance=r.lazy(()=>new l(o.logFilter())),e.mkConsoleLogger=function(t){return new u.ContextualLogger(t,()=>l.instance())}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(210),s=n(34),o=n(2),a=n(5),u=n(6),l=n(8),c=n(71),d=n(7),h=n(13),f=n(3),p=n(211),m=n(16),g=new RegExp("^"+p.ipv4Re.source+"$");e.friendlyname=c.memoize(t=>i(void 0,void 0,void 0,(function*(){const n=null==g.exec(t)?t:yield e.nslookup(t);return l.toS(n).toLowerCase().normalize()})),10*a.minuteMs,128);const v=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function y(t){return null!=v.exec(t)}function b(t){const e=t.split(".").map(t=>u.toInt(t)).filter(t=>m.within(0,255,t));return 4===e.length?e:void 0}e.isLoopback=y,e.octets=b;const w=s.promisify(r.reverse),S=s.promisify(r.resolve4),M=f.mkLogger("nslookup");e.nslookup=c.memoize(t=>i(void 0,void 0,void 0,(function*(){try{const e=yield d.thenOrTimeout(()=>y(t)?t.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=b(t)?w(t):S(t),10*a.secondMs);if(null==e)return M.info("nslookup("+t+"): timeout"),t;const n=e.find(o.notBlank);return null==n?(M.warn("No name found for "+t),t):n}catch(e){return M.warn("Failed to look up "+t+", using name.",e),t}})),10*a.minuteMs,256),h.onClearCache(()=>e.nslookup.clear())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(2),o=n(5),a=n(0),u=n(14),l=n(8),c=n(51),d=n(7),h=n(17),f=n(13),p=n(68),m=n(61),g=n(67),v=n(21),y=n(23),b=n(40),w=n(10),S=n(31),M=n(24);e.addRemoteVolumeInfoWin=function(t,e){return i(this,void 0,void 0,(function*(){if(!y.isWin)throw new Error("wtf");return yield d.thenMap(a.orElse(e,()=>F()),e=>{const n=g.toMap(e,t=>[t.mountpoint,t]);t.forEach(t=>{a.map(n.get(t.mountpoint),e=>{t.remote=!0,t.remoteHost=e.host,t.remoteShare=e.share,t.remoteOK=e.ok})})}),t}))};const P=["LocalName","RemoteName","Status"],x=["NETUSE","get",P.join(",")],E=/^\\\\(.+?)\\(.+)$/,_=/^[a-z]:\\?$/i;function O(t){if(!s.blank(t))return u.Opt(t).flatMap(t=>E.exec(t)).map(t=>({host:t[1],share:t[2]})).orElse(()=>u.Opt(t).flatMap(t=>v.Try(()=>new URL(t))).filter(t=>s.notBlank(t.hostname)).map(t=>({host:t.hostname,share:u.Opt(t.pathname).filter(s.notBlank).getOrElse(()=>"/")}))).get()}function T(){return i(this,void 0,void 0,(function*(){const t=m.wmic(),e=yield h.stdout(t,x,{timeout:15*o.secondMs}),n=p.parseFixed(P,e);return r.compact(n.map(t=>a.map(E.exec(l.toS(t.RemoteName)),e=>a.map(_.exec(l.toS(t.LocalName)),n=>({mountpoint:w.ensureSuffix(n[0],"\\"),host:e[1],share:e[2],ok:"OK"===t.Status})))))}))}e.NetInfoCmd="Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status",e.parseRemoteName=O,e._netInfoWinWmic=T;const F=c.keyedLazy("netInfoWin",S.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const t=yield b.PowerShell.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return null==t?T():r.compact(t.filter(t=>s.notBlank(t.LocalName)).map(t=>a.map(O(t.RemoteName),({host:e,share:n})=>a.map(_.exec(l.toS(t.LocalName)),i=>({mountpoint:w.ensureSuffix(i[0],"\\"),host:e,share:n,ok:"OK"===t.Status&&"Connected"===t.ConnectionState})))))}))}),{maxRetries:2,timeoutMs:M.cmdTimeoutMs,priorResultTtlMs:M.longTtlMs});f.onClearCache(()=>F.clear())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),s=n(6),o=n(14),a=n(17),u=n(23),l=n(40);e.hidden=function(t){return!!t.base.startsWith(".")||(u.isWin?function(t){return i(this,void 0,void 0,(function*(){const e=yield l.PowerShell.instance().executeJsonToA(`Get-Item -Force -LiteralPath '${t.nativePath}' -ErrorAction SilentlyContinue | Select-Object -Property Name, Mode`);return o.Opt(e).flatMap(t=>t[0]).flatMap(t=>t.Mode).flatMap(t=>t.includes("h")||t.includes("s")).getOrElse(()=>!1)}))}(t):!!u.isMac&&function(t){return i(this,void 0,void 0,(function*(){try{const e=yield a.stdout("stat",["-f","%f",t.nativePath],{timeout:10*r.secondMs}),n=s.toInt(e);return null!=n&&(32768&n)>0}catch(t){return!1}}))}(t))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(2),o=n(4),a=n(38),u=n(7),l=n(73),c=n(220),d=n(3),h=n(23),f=n(221),p=n(25),m=n(31),g=n(152),v=n(135),y=n(125),b=n(27),w=n(222);function S(t){const e=t.nativePath.toLowerCase().normalize();return v.pathIsNeverIgnored(t.nativePath)||v.pathIsNeverIgnored(e)?{pathIsNeverIgnored:()=>!1}:Object.assign(Object.assign({},P(t.nativePath)),{snapDirectory:()=>i(this,void 0,void 0,(function*(){return h.isLinux&&(yield w.ignorableSnapDir.apply(t))})),noMedia:()=>y.hasNoMedia(t),hidden:()=>g.hidden(t),mountpoint:()=>i(this,void 0,void 0,(function*(){return u.thenMapOr(m.mountpoints(),e=>e.includes(t.nativePath),()=>!1)}))})}e.ignorablePredicates=function(t){return i(this,void 0,void 0,(function*(){return(yield t.isDirectory())?S(t):P(t.nativePath)}))},e.ignorableFile=function(t){return x(t.nativePath)},e.ignorableDirectory=function(t){return i(this,void 0,void 0,(function*(){return c.orLoggedAsync([S(t)],d.mkLogger("ignorableDirectory("+t.nativePath+")"))}))},e.ignorableDirectoryPredicates=S;const M=o.lazy(()=>new E);function P(t){return M().ignorablePathPredicates(t)}function x(t){return M().ignorablePath(t)}e.ignorablePathPredicates=P,e.ignorablePath=x;class E{constructor(t=p.isTest){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","var","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(t=>t.toLowerCase().normalize())),this.ignorableDirectories=new Set(["#recycle","@Recycle","@eaDir","@SynoResource","$Recycle.Bin","Application Data","Application Support","Applications","cache","caches","com.apple.TimeMachine.localsnapshots","cpan","cygwin","cygwin64","DefinitelyTyped","Desktop DB","Desktop DF","DisplayDriver","ehthumbs.db","lost+found","Network Trash Folder","node_modules","Program Files (x86)","Program Files","ProgramData","steamapps","spotifycache","System32","System Volume Information","Temporary Items","tmp","iTunes","iTunes Media","Thumbnails","Thumbs.db","Trash","Windows10Upgrade"].map(t=>t.toLowerCase().normalize())),this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/.*?\.photolibrary\/(?!Masters?\/)/i,/\/ImageMagick[\d\.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Smart Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d\.-]*(\/|$)/i,/\/Python[\d\.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d\.-]+(amd64|x64)?(\/|$)/i],this.systemDirs=r.uniq(r.compactBlanks([a.App.appData(),l.getEnv("APPDATA"),l.getEnv("SYSTEMROOT"),l.getEnv("ProgramFiles"),l.getEnv("ProgramFiles(x86)")]).map(t=>t.toLowerCase().normalize())),this.ignorableSubdirs=new f.SetSet,h.isLinux&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);const e=["bin","etc","games","include","lib","lib32","local","locale","man","sbin","share","src"];this.addIgnorableSubdirs("usr",e),this.addIgnorableSubdirs("local",e),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...e]),this.addIgnorableSubdirs("var",["cache","crash","lib","local","log","snap","spool","tmp"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("go",["bin","blog","doc","lib","misc","pkg","src","test"]);const n=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",n),this.addIgnorableSubdirs("Perl64",n),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),t||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(l.getEnv("APPDATA"),["local","locallow","roaming"])),t&&(this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"))}addIgnorableSubdirs(t,e){if(s.blank(t))return;const n=t.toLowerCase().normalize();r.compactBlanks(e).forEach(t=>this.ignorableSubdirs.add(n,t.toLowerCase().normalize()))}ignorablePathPredicates(t){const e=v.pathIsNeverIgnoredPredicate(t);if(null!=e)return e;const n=t.toLowerCase().normalize(),i=r.compactBlanks(b.pathnames(n));return{hiddenPosix:()=>i.some(t=>t.startsWith(".")),systemDir:()=>this.systemDirs.some(t=>n.startsWith(t)),ignorableRoot:()=>this.ignorableRootDirectories.has(i[0]),ignorableDirectory:()=>i.some(t=>this.ignorableDirectories.has(t)),ignorablePath:()=>this.ignorableSubdirs.has(i),ignorablePattern:()=>{const e=b.native2posix(t);return this.ignorableDirectoryPatterns.some(t=>t.test(e))}}}ignorablePath(t){return c.orLogged([this.ignorablePathPredicates(t)],d.mkLogger("FsAttrs("+t+")"))}}e.Ignorable=E},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(46),r=n(6),s=n(9),o=n(14),a=n(58),u=n(57);e.PromiseTimer=class{constructor(){this.times=new Map}time(t,e,n){const i=Date.now();return a.thenTap(e(),e=>{const r=Date.now()-i;this.push(t,r),null!=n&&n(e,r)}).catch(t=>{throw null!=n&&n(t,Date.now()-i),t})}push(t,e){i.getOrSet(this.times,t,()=>new u.Average).push(e)}weightedAvg(t){return o.Opt(this.times.get(t)).map(t=>t.weightedAvg).get()}callCounts(){return[...this.times.entries()].reduce((t,[e,n])=>Object.assign(Object.assign({},t),{[e]:n.k}),{})}weightedAvgs(){return s.compactValues([...this.times.entries()].reduce((t,[e,n])=>Object.assign(Object.assign({},t),{[e]:r.mapFinite(n.weightedAvg,r.round)}),{}))}report(){return[...this.times.entries()].reduce((t,[e,n])=>Object.assign(Object.assign({},t),{[e]:{cnt:n.k,avgMs:r.mapFinite(n.avg,r.round),minMs:n.min,maxMs:n.max}}),{})}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(34),r=n(4),s=n(28),o=n(12),a=n(11),u=n(56),l=n(250);class c{constructor(t,e,n,i,o=!0){this.name=t,this.maxWidth=e,this.maxHeight=n,this.reducer=i,this.rotational=o,this.megapixels=r.lazy(()=>s.megapixels(this.maxWidth*this.maxHeight)),this.max={width:e,height:n},c._Sizes.push(this)}static sq(){return this._Sizes.filter(t=>t.reducer===l.Square)}static largestSq(){return o.greatestBy(this.sq(),t=>t.megapixels())}static fit(){const t=a.Settings.previewResolutions.valueOrDefault;return this._Sizes.filter(e=>e.reducer===l.Fit&&t.includes(e.name))}static largestFit(){return o.greatestBy(this.fit(),t=>t.megapixels())}[i.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"×"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(t){return this.reducer.reduce(this.rotational&&u.isPortrait(t)?u.flip(this.max):this.max,t)}resize(t,e){return e=e.resize(Object.assign(Object.assign({},t),{fit:this.reducer.fit,withoutEnlargement:!0}))}toJpeg({path:t,sh:e,outputSize:n}){return(u.dmegapixels(n)<2||a.Settings.sharpen.valueOrDefault)&&(e=e.sharpen()),e.jpeg({quality:85,progressive:a.Settings.progressive.valueOrDefault}).toFile(t)}toString(){return this.name}}e.ImageSize=c,c._Sizes=[],c.UHD8k=new c("uhd8k",7680,4320,l.Fit,!1),c.UHD5k=new c("uhd5k",5120,2880,l.Fit,!1),c.UHD=new c("uhd4k",4096,2160,l.Fit),c.QHD=new c("qhd",3120,1440,l.Fit),c.FHD=new c("fhd",1920,1080,l.Fit),c.HD=new c("hd",1280,720,l.Fit),c.WVGA=new c("wvga",720,480,l.Fit),c.QVGA=new c("qvga",320,240,l.Fit),c.QQVGA=new c("qqvga",160,120,l.Fit),c.S480=new c("s480",480,480,l.Square),c.S240=new c("s240",240,240,l.Square),c.S120=new c("s120",120,120,l.Square),c.S60=new c("s60",60,60,l.Square)},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(65),s=n(2),o=n(0),a=n(7),u=n(190),l=n(3),c=n(37),d=n(44),h=n(81),f=n(56),p=n(112),m=n(103),g=n(101),v=l.mkLogger("SharpReadable");function y(t,e,n,r){return i(this,void 0,void 0,(function*(){return o.map(e[n],()=>a.thenMap(b(t,n),e=>a.thenMap(p.dimensions(e),i=>v.tap({msg:"imgFromExif()",result:f.ltEither(r,i)?e:void 0,meta:{src:t.baseWithGrandparent,img:e.nativePath,tag:n,dim:i,minDim:r}}))))}))}function b(t,e){return a.thenMap(m.tmpImgFile(t,e,".jpg"),n=>n.applyIfEmpty(n=>i(this,void 0,void 0,(function*(){return c.extractBinaryTag(e,t.nativePath,n.nativePath)}))))}e.imgFromExif=y,e.sharpReadable=function(t,e){return i(this,void 0,void 0,(function*(){const n=yield c.readRawTags(t,!1),l=o.map(n,t=>t.MIMEType);if(null==n||s.blank(l))throw new Error(t+" is not supported (missing mimetype)");const f=[];if(null!=e){const i=h.extractRotation(n);null!=i&&0!==i||l.startsWith("video/")||f.push(...["PreviewImage","JpgFromRaw"].map(i=>()=>y(t,n,i,e)))}d.isSharpMimetype(l)&&f.push(()=>i(this,void 0,void 0,(function*(){return t}))),u.dcrawSupportedMimeTypes.has(l)&&f.push(()=>m.readableToFile(t,"dcraw",".tiff",()=>u.dcraw(t))),f.push(()=>r.retryOnReject(()=>g.extractVideoFrame(t,l),{maxRetries:1}));const p=[],b=yield a.firstResolvedDefinedPromise(f,e=>{v.warn("strategy failed for "+t+": "+e),p.push(e)});if(null==b)throw o.orElse(p[0],new Error("Cannot read "+t));return b}))},e.extractImageForThumbs=b},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(35);e.FitSizes=i.strEnum("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),e.FitSizeValues=i.strEnumValues(e.FitSizes),e.SqSizes=i.strEnum("s480","s240","s120","s60"),e.SqWidths=[60,120,240,480]},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(20);e.hasFail=function(t){return null!=t&&i.isNotEmpty(t.fail)},e.hasBad=function(t){return null!=t&&i.isNotEmpty(t.bad)},e.fullhc=function(t){return{ok:r.toA(t.ok),warn:r.toA(t.warn),bad:r.toA(t.bad),fail:r.toA(t.fail)}},e.concatHealthChecks=function(...t){function e(e){return i.uniq(i.compact(i.flatten(t.map(e))))}return t=i.compact(t),{ok:e(t=>t.ok),warn:e(t=>t.warn),bad:e(t=>t.bad),fail:e(t=>t.fail)}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(19);e.stdoutWrite=function(t,n=!0){i.stdout.write(JSON.stringify(t)+"\n"),n&&i.stdout.write(e.readyStr+"\n")},e.readyStr=JSON.stringify({ready:!0})},function(t,e){t.exports=require("child_process")},function(t,e){t.exports=require("readline")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(43),r=n(5),s=n(4),o=n(6),a=n(28),u=n(3),l=n(11),c=s.lazy(()=>u.mkLogger("MaxCpus"));e.maxCpus=s.lazy(()=>{const t=(i.freemem(),i.totalmem()/2),e=500*a.MB,n=Math.floor(t/e),r=i.cpus().length;return c().tap({msg:"maxCpus()",result:o.clamp(1,n,Math.ceil(l.Settings.maxCpuPercent.valueOrDefault/100*r)),meta:{maxProcs:n,cpuCount:r}})},5*r.minuteMs)},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(2),o=n(5),a=n(47),u=n(4),l=n(0),c=n(33),d=n(14),h=n(22),f=n(7),p=n(53),m=n(18),g=n(15),v=n(88),y=n(63),b=n(3),w=n(79),S=n(21),M=n(74),P=n(11),x=n(17);e.mkBasicWatchedChild=function(t){return new E(Object.assign({name:r.compact([t.cmd,...t.args]).join(" "),childFactory:()=>x.spawn(t.cmd,t.args,30*o.minuteMs),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},t))};class E{constructor(t){this.startMs=Date.now(),this._stopped=!1,this.logger=u.lazy(()=>b.mkLogger("WatchedChild("+r.compact([this.name,this.pid]).join(":")+")")),this.startRate=new w.Rate(2*o.minuteMs),this.mutex=new p.Promises,this._ended=!1,this.onError=(t,e)=>i(this,void 0,void 0,(function*(){const n=g.isFatalError(t)||g.isFatalError(e);(n||s.notBlank(e))&&(this.lastError=new g.WrappedError({message:t+a.errorToS(e),fatal:n}));const i={src:t,fatal:n,errToS:a.errorToS(e)};if(this.logger().error("onError()",i),!this._ended&&!g.isIgnorableError(e))return g.onError(a.errorToS(e)),n?this.end():this.opts.onError(t,e)?(this.logger().warn("onError requested restart",i),this._restart()):void 0})),this.name=t.name,this.opts=Object.assign({dataSep:"\n",maxErrorsPerMinute:3,endTimeoutMs:10*o.secondMs,endableRank:h.EndableRanks.first,exitCommand:"",restartOnExit:!0},t),h.addEndable(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}end(){return i(this,void 0,void 0,(function*(){return this._ended=!0,this._stop()}))}get proc(){return this.cp}get pid(){return l.map(this.cp,t=>t.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return l.mapOr(this.pid,t=>M.pidExists(t),()=>i(this,void 0,void 0,(function*(){return!1})))}notRunning(){return f.thenNot(this.running())}stop(){return i(this,void 0,void 0,(function*(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}))}_stop(){return i(this,void 0,void 0,(function*(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});const t=this.cp;return this.cp=void 0,null==t||this.stopChild(t)}))}stopChild(t){return i(this,void 0,void 0,(function*(){return yield d.Opt(this.opts.exitCommand).filter(s.notBlank).flatMap(e=>d.Opt(t).flatMap(t=>t.stdin).filter(t=>t.writable).forEach(t=>S.Try(()=>t.write(e+"\n"))).map(y.end).get()),x.endProcess(t,this.opts.endTimeoutMs)}))}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:this.startRate.eventsPerMinute>this.opts.maxErrorsPerMinute,meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}restart(){return i(this,void 0,void 0,(function*(){return this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),!this._ended&&this.mutex.serial(`WatchedChild(${this.name}).restart`,()=>i(this,void 0,void 0,(function*(){return yield this._stop(),this._stopped=!1,this._start()})))}))}start(){return i(this,void 0,void 0,(function*(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,()=>i(this,void 0,void 0,(function*(){return this._stopped=!1,this._start()})))}))}_restart(){return i(this,void 0,void 0,(function*(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,()=>i(this,void 0,void 0,(function*(){return yield this._stop(),!this._stopped&&!this._ended&&(this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),m.isRecentMs(this.startMs,P.Settings.probationMs.valueOrDefault)&&g.onError("Can't restart "+this.name+", failure rate is too high."+g.FatalErrorFlag,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),c.isFunction(this.opts.onRestart)&&this.opts.onRestart(),this._start()))})))}))}_start(){return i(this,void 0,void 0,(function*(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended)return!1;if(yield this.running())return!1;this.startRate.onEvent();const t=this.cp=yield this.opts.childFactory();this.logger.clear(),this.logger().info("_start(): spawned pid "+this.pid);const e="cp("+t.pid+")";return[{o:t,desc:""},{o:t.stdin,desc:".stdin"},{o:t.stdout,desc:".stdout"},{o:t.stderr,desc:".stderr"}].forEach(({o:t,desc:n})=>{l.map(t,t=>t.on("error",t=>this.onError(e+n+".on(error)",t)))}),v.onDataChunked(this.cp.stdout,this.opts.dataSep,t=>{this.logger().debug("onDataChunked()",t),this.opts.onStdout(t)}),this.cp.stderr.on("data",t=>{c.isFunction(this.opts.onStderr)&&!this.opts.onStderr(t)||this.onError(e+".stderr.on(data)",t)}),this.cp.on("exit",(t,e)=>{this.logger().info("onExit",{code:t,signal:e,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?this._restart():(this.logger().info("onExit(): this.opts.restartOnExit is false, so we're done."),this.end())}),this.logger().info("_start(): finished setting up new child "+this.pid),!0}))}}e.WatchedChild=E},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(30),s=n(1),o=n(2),a=n(5),u=n(0),l=n(14),c=n(8),d=n(49),h=n(12),f=n(7),p=n(18),m=n(113),g=n(187),v=n(41),y=n(3),b=n(21),w=n(114),S=n(102),M=n(37),P=n(44),x=y.mkLogger("TagInference"),E=y.mkLogger("TagInference.inferMakeAndModel()");e.inferMakeAndModel=function(t,e){return i(this,void 0,void 0,(function*(){if(x.debug("inferMakeAndModel("+t+")",{Make:e.Make,Model:e.Model}),o.notBlank(e.Make)&&o.notBlank(e.Model))return;if(o.blank(e.Make)&&(c.toS(e.HandlerDescription)+c.toS(e.CompressorName)).includes("GoPro"))return void(e.Make="GoPro");const n=A(t),{younger:i,older:r}=yield L(t),a=s.compact(s.flatten(h.zip(i,r))).slice(0,50).filter(t=>w.diceCoeff(A(t),n)>.7).slice(0,10);x.info("inferMakeAndModel("+t+"): looking at nearby siblings",a.map(t=>t.base));for(const n of a){const i=yield M.readRawTags(n);if(null!=i&&h.allNotBlank(i.Make,i.Model))return E.info("Inferring Make and Model",{file:t.nativePath,sibling:n.base,Make:i.Make,Model:i.Model}),e.Make=i.Make,void(e.Model=i.Model)}}))};const _=y.mkLogger("TagInference.inferCapturedAtFromSiblings()");function O(t,e=7){return i(this,void 0,void 0,(function*(){return h.firstAsync(t.slice(0,e),(t,e)=>f.thenMap(M.readRawTags(t),t=>f.thenMap(S.capturedAtFromTags(t),t=>Object.assign(Object.assign({},t),{index:e}))))}))}e.inferCapturedAtFromSiblings=function(t){return i(this,void 0,void 0,(function*(){return f.thenMap(function(t){return T.getOrSet(t.nativePath,()=>i(this,void 0,void 0,(function*(){const{younger:e,older:n}=yield L(t),i=yield O(e),r=yield O(n);return null==i||null==r?void 0:{before:i,after:r,index:i.index,slots:i.index+r.index+1}})))}(t),({before:e,after:n,index:i,slots:r})=>{if(v.sameDay(e.date,n.date))return u.map(m.DateInterval.for(e.date,n.date,i,r),t=>({date:t,src:`before:${e.src},after:${n.src}`}));_.debug("rejecting, not same day",{file:t.nativePath,before:c.toS(e),after:c.toS(n)})})}))};const T=new d.TTLMap(2*a.minuteMs);const F=/^(?:(?:mvimg|img|vid|mov|gp|gf|p|gopr)(?:[-_ ]|(?=\d)))?(\S.+)$/i,k=/[\d_]{4,}$/;function A(t){return I(t.nameWithoutCount)}function I(t){return o.blank(t)?"":l.Opt(b.Try(()=>r.posix.parse(t))).flatMap(t=>t.name).flatMap(t=>l.Opt(k.exec(t.replace(/_cover$/i,""))).flatMap(t=>t[0]).orElse(()=>l.Opt(F.exec(t)).flatMap(t=>t[1]))).getOrElse(()=>t).replace(/^[\s-_]*/,"").replace(/[\s-_]*$/,"").toLowerCase().normalize()}e.bname=A,e.bnameString=I;const D=g.extFilter(P.AllExifExts),C=new d.TTLMap(2*a.minuteMs);function L(t,e=7){return i(this,void 0,void 0,(function*(){return C.getOrSet(t.nativePath,()=>i(this,void 0,void 0,(function*(){const n=A(t),i=(yield t.siblings()).filter(t=>!t.base.startsWith(".")&&D.apply(t)&&!P.isSidecarExt(t.ext)&&w.diceCoeff(A(t),n)>.7),r=s.sortBy(i,t=>A(t)),[o,a]=h.partition(r,t=>A(t)<n);return o.reverse(),{younger:o.slice(0,e),older:a.slice(0,e)}})))}))}e.nearestSiblings=L,e.nearestSiblingTzOffset=function(t){return i(this,void 0,void 0,(function*(){const{younger:e,older:n}=yield L(t),r=h.flatZip(e,n).slice(0,10),s=yield f.thenMap(function(t,e=7){return i(this,void 0,void 0,(function*(){return h.firstAsync(t.slice(0,e),(t,e)=>f.thenMap(M.readRawTags(t),t=>f.thenMap(S.capturedAtFromTags(t),t=>l.Opt(t).filter(t=>v.hasZone(t.date)).flatMap(t=>v.getZoneName(t.date)).map(t=>({zoneName:t,index:e})).get())))}))}(r),t=>t.zoneName);return x.info("nearestSiblingTzOffset()",{f:t.baseWithGrandparent,result:s}),s}))},e.extractStatname=function(t){return i(this,void 0,void 0,(function*(){const e=v.parseDateTime(A(t));if(null==e)return;const n=v.datedToMillis(e);if(null==n)return;const i=yield t.stat();return null!=i?h.first(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],t=>Math.abs(i[t]-n)<p.MaxTzOffsetHours?{src:t,date:e}:void 0):void 0}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(30),s=n(117),o=n(1),a=n(2),u=n(5),l=n(4),c=n(0),d=n(6),h=n(9),f=n(14),p=n(7),m=n(17),g=n(73),v=n(15),y=n(32),b=n(3),w=n(16),S=n(23),M=n(40),P=n(11),x=n(10),E=n(24),_=l.lazy(()=>b.mkLogger("vlc"));e.vlcVersionDescription=l.lazy(()=>p.thenMapOr(e.vlcInfo().catch(()=>void 0),t=>t.version+("vlc"===t.path?" (found on $PATH)":" from "+t.path),()=>"(not found on $PATH)"));const O=/VLC version (\S+)/i,T=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"];function F(t){return i(this,void 0,void 0,(function*(){return p.thenMap(m.stdoutResult(t,[...T,"--version"],{timeout:E.cmdTimeoutMs,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),t=>f.Opt(t.result).filter(a.notBlank).map(t=>t.trim()).flatMap(t=>O.exec(t)).flatMap(t=>s.parse(t[1])).get())}))}function k(t){return p.thenMap(M.PowerShell.instance().execute(`(Get-Item -path ${M.pwshQuote(t)}).VersionInfo.FileVersion`,t=>t).catch(e=>{_().warn("Failed to run vlcInfoWin: "+t+": "+e)}),t=>c.denull(s.parse(t.trim())))}e.vlcInfo=l.lazy(()=>(function(){return i(this,void 0,void 0,(function*(){const t=[P.Settings.vlcPath.valueOrDefault];function e(...e){t.push(y.PosixFile.for(r.join(...e)))}const n=[];if(S.isMac){const t="/Applications/VLC.app/Contents/MacOS/VLC";a.mapNotBlank(g.getEnv("HOME"),n=>e(n+t)),e(t)}if(S.isWin){const t=["VideoLAN","VLC","vlc.exe"];a.mapNotBlank(g.getEnv("LOCALAPPDATA"),n=>{e(n,"Apps",...t)}),a.mapNotBlank(g.getEnv("HOMEPATH"),n=>{e(n,"AppData","Local","Apps",...t)}),a.mapNotBlank(g.getEnv("ProgramFiles"),n=>{e(n,...t)}),a.mapNotBlank(g.getEnv("ProgramFiles(x86)"),n=>{e(n,...t)})}for(const e of t)try{if(e instanceof y.PosixFile&&(yield e.clear().notExists()))continue;const t=e.toString(),i=yield S.isWin?k(t):F(t);if(null==i){_().info("No VLC version found for "+e);continue}if(3===i.major&&0===i.minor)return h.tap({path:t,version:i},t=>_().info("VLC version found!",t));n.push({path:t,unsupportedVersion:i})}catch(t){_().warn("vlcInfo(): err:"+t,{path:e})}return n[0]}))})()),e.checkVlcInfo=function(){return i(this,void 0,void 0,(function*(){const t=yield e.vlcInfo.prior();return null!=t&&null!=t.version?t:yield e.vlcInfo.refresh()}))},e.isVlcSupported=function(){return i(this,void 0,void 0,(function*(){return p.thenMapOr(e.vlcInfo(),t=>null!=t.version,()=>!1)}))},e.vlcPath=l.lazy(()=>p.thenMap(e.vlcInfo(),t=>null==t.version?void 0:t.path)),e.vlcFrame=function(t){return i(this,void 0,void 0,(function*(){const n=yield e.vlcPath();if(a.blank(n))throw new Error(t.src+" is not supported (no vlc)");const i=x.stripPrefix(t.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(i))return _().throw("vlcFrame(): Invalid destination extension"+v.NonRetriableErrorFlag,{format:i,args:t});const r=yield m.stdoutResult(n,o.compact([...T,"--avcodec-hw=none","--video-filter=scene","--scene-format="+i,"--scene-replace","--scene-ratio=200",c.map(t.width,t=>"--scene-width="+t),c.map(t.height,t=>"--scene-height="+t),"--scene-path="+t.dest.dir,"--scene-prefix="+t.dest.name,"--start-time=0","--stop-time=1",t.src.nativePath,"vlc://quit"]),{timeout:u.minuteMs,ignoreStderr:!0});if(t.dest.clear(),d.gt0(r.code))throw new Error("vlc failed: "+JSON.stringify(r));return r}))},e.vlcTranscode=function(t){return i(this,void 0,void 0,(function*(){const n=yield e.vlcPath();if(a.blank(n))throw new Error("vlc.transcode(): VLC is not installed, cannot transcode "+t.src);const i=o.compact(["vcodec=h264",w.mapGt0(t.videoBitrateKbps,t=>"vb="+t),w.mapGt0(t.width,t=>"width="+Math.floor(t)),w.mapGt0(t.height,t=>"height="+Math.floor(t)),"venc=x264{ref=2:me=hex:mixed_ref=0:chroma_qp_offset=0:b_adapt=1:direct=1:weightp=1:rc_lookahead=20}","acodec=mp4a","ab=128","channels=2","samplerate=44100","scodec=none","deinterlace"]).join(","),r=["access=file{overwrite}","mux=mp4","dst="+t.dest.base].join(",");return m.stdoutResult(n,[...T,"--no-repeat","--no-loop",t.src.fileuri(),`--sout=#transcode{${i}}:standard{${r}}`,"vlc://quit"],{cwd:t.dest.dir,timeout:t.timeoutMs,ignoreStderr:!0})}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(104),s=n(157),o=n(0),a=n(6),u=n(8);class l{constructor(t){a.isNumber(t)?(this.assetId=t,this.query=""):(this.assetId=t.id,this.query="?ts="+t.ts)}static onNewPage(){this.pageImageCount=0}assetUrl(){return`/asset/${this.assetId}${this.query}`}linkAttrs(){return{href:this.assetUrl()}}imgLink(t,e){return`/img/${this.assetId}/${t}/${e}${this.query}`}imgActualLink(t){return`/img/${i.compact([this.assetId,t]).join("/")}/actual${this.query}`}videoLink(t){return`/video/${this.assetId}-${t}${this.query}`}sqImgAttrs(t){return this.imgAttrs("sq",s.SqWidths,t)}imgAttrs(t,e,n,i){const s=Math.min(...e),a={width:u.toS(s)},d=this.imgLink(t,s);l.pageImageCount++,(n=o.orElse(n,()=>l.pageImageCount>64))?(a.src="/images/clear-256.png",a["data-src"]=d):a.src=d,t===r.ReducerNames.sq&&(a.sizes="(min-width: 900px) 12.5vw, (min-width: 540px) 25vw, 50vw",a.height=u.toS(s));const h=e.map(e=>c(this.imgLink(t,e),e));o.map(i,t=>h.push(c(this.imgActualLink(),t.width)));const f=h.join(",");return n?a["data-srcSet"]=f:a.srcSet=f,a}}function c(t,e){return t+" "+e+"w"}e.AssetUrls=l,l.pageImageCount=0},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(17),s=n(18),o=n(138),a=n(3),u=n(5),l=n(8),c=a.mkLogger("SQLite");function d(t,e){return i(this,void 0,void 0,(function*(){const n=yield o.sqliteNativePath(),i=yield s.elapsedAsync(()=>r.stdout(n,[t.nativePath,e],{timeout:1*u.minuteMs}));return c.debug("ops on "+t+" in "+i.elapsedMs+"ms",i.result),i.result}))}e.sqlite=d,e.backupDb=function(t,e){return i(this,void 0,void 0,(function*(){if(null==(yield e.parent().mkdirp()))return!1;try{return yield d(t,`.backup '${e.nativePath}'`),c.info("backupDb(): copied",{srcDb:l.toS(t),destDb:l.toS(e)}),!0}catch(n){return c.warn("backupDb(): copy failed",{srcDb:l.toS(t),destDb:l.toS(e),err:n}),!1}}))},e.verifyDb=function(t){return i(this,void 0,void 0,(function*(){const e=yield d(t,"VACUUM ; PRAGMA integrity_check").catch(t=>t);return"ok"===e.trim()?(c.info("verifyDb("+t+"): OK"),!0):(c.warn("verifyDb("+t+"): NOT OK",e),!1)}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SqliteExt=".sqlite3",e.pathToDb=function(t,n){return t.join(n,"db"+e.SqliteExt)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(6),s=n(16),o=n(13);function a(t){return null!=t&&i.notBlank(t.path)&&i.notBlank(t.op)&&s.within(0,100,t.pct)}e.isProgressEvt=a;const u="progress";e.emitProgressEvt=function(t){a(t)&&o.eventEmitter.emit(u,Object.assign(Object.assign({},t),{pct:r.sigFigs(r.clamp(0,100,t.pct),2)}))},e.onProgressEvt=function(t){o.eventEmitter.on(u,t)},e.removeProgressEvtListener=function(t){return o.eventEmitter.removeListener(u,t)}},function(t,e,n){"use strict";function i(t,e,n=.5){return(1-n)*t+n*e}Object.defineProperty(e,"__esModule",{value:!0}),e.lerp=i,e.lerp2d=function(t,e,n){const r=e.x-t.x,s=(n-t.x)/r;return i(t.y,e.y,s)},e.lerp2d_=function(t,e,n){return(t.y*(e.x-n)+e.y*(n-t.x))/(e.x-t.x)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(10),o=n(172);function a(t){return t.filter(t=>r.notBlank(t)&&"n/a"!==t.trim())}e.extractLensMakeModel=function(t){const e=o.make(t.LensMake),n=o.make(t.Make),u=a([e,t.LensMake,n,t.Make]),l=t=>u.reduce((t,e)=>s.stripPrefixIgnoreCase(t,e).trim(),t);if(r.notBlank(e)&&r.notBlank(t.LensModel))return{lensMake:e,lensModel:l(t.LensModel)};const c=a([t.LensID,t.LensType,t.LensInfo,t.LensModel]);for(const t of c){if(r.notBlank(e))return{lensMake:e,lensModel:l(t)};if(t.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:l(t)};for(const r of i.compactBlanks([e,n,"Canon","Carl Zeiss","Fujifilm","Konica","Leica","Olympus","Sigma","Sony"]))if(t.toLowerCase().includes(r.toLowerCase()))return u.unshift(r),{lensMake:r,lensModel:l(t)}}return i.isNotEmpty(u)&&i.isNotEmpty(c)?{lensMake:u[0],lensModel:s.stripPrefixIgnoreCase(c[0],"unknown").trim()}:void 0}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(0),s=n(10),o=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|"),a=new RegExp(`[\\s\\.,_-]*(?:${o})[\\s\\.,_-]*$`,"i");function u(t,e,n=""){const i=t.replace(e,n);return i===t?t:u(i,e,n)}function l(t){const e=t.trim();return"gopro"===e.toLowerCase()?"GoPro":"benq"===e.toLowerCase()?"BenQ":e.length<4?e:e.toLowerCase().replace(/(?:^|\s|-)\S/g,t=>t.toUpperCase())}e.companyCased=l,e.make=function(t){return i.mapNotBlank(t,t=>t=l(t=u(t=s.stripQuotes(t),a).replace("LGE","LG")))};const c=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i],d=new Map([["Samsung",[[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10E"],[/^SM-G973/,"Galaxy S10"],[/^SM-G975/,"Galaxy S10+"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]]],["LG",[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]]]]);e.model=function(t,e){if(i.blank(t)||i.blank(e))return;e=s.stripQuotes(e);const n=r.map(d.get(t),t=>t.find(([t])=>null!=e.match(t)));return null!=n?n[1]:("Sony"===t&&(e=e.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"α").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV")),c.forEach(t=>e=u(e,t).trim()),e=e.replace(new RegExp(`^${t}\\s+`,"i"),""),null!=t.match(/^HP|Hewlett.Packard$/i)&&null!=e.match(/^hp\b/i)&&(e=e.slice(2).trim()),e)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(117),s=n(1),o=n(5),a=n(47),u=n(4),l=n(0),c=n(6),d=n(14),h=n(7),f=n(17),p=n(3),m=n(11),g=n(24),v=n(123),y=u.lazy(()=>p.mkLogger("ffmpeg")),b=/ffmpeg version (\S+)/i;e.ffmpegVersion=u.lazy(()=>i(void 0,void 0,void 0,(function*(){try{const t=yield f.stdoutResult(m.Settings.ffmpegPath.valueOrDefault,["-version"],{timeout:g.cmdTimeoutMs,ignoreStderr:!0,isIgnorableError:()=>!0}),e=l.map(b.exec(t.result),t=>l.orElse(r.parse(t[1]),t[1]));return y().info("ffmpegVersion",Object.assign({version:e},t)),0===t.code?e:void 0}catch(t){return}}))),e.checkFFmpegVersion=function(){return i(this,void 0,void 0,(function*(){return h.thenOrElse(e.ffmpegVersion.prior(),()=>e.ffmpegVersion.refresh())}))},e.isFFmpegSupported=function(){return i(this,void 0,void 0,(function*(){return null!=(yield e.ffmpegVersion())}))},e.ffmpegFrame=function(t){return i(this,void 0,void 0,(function*(){return(yield t.dest.exists())&&(yield t.dest.isEmpty())&&(yield t.dest.unlink()),f.stdoutResult(m.Settings.ffmpegPath.valueOrDefault,s.compact(["-loglevel","error","-i",t.src.nativePath,"-vframes","1",...null!=t.width&&null!=t.height?["-s",`${c.round(t.width)}x${c.round(t.height)}`]:[],"-f","singlejpeg",t.dest.nativePath]),{timeout:o.minuteMs,isIgnorableError:S})}))},e.ffmpegTranscode=function(t){return i(this,void 0,void 0,(function*(){const e=d.Opt(t.videoBitrateKbps).filter(c.gt0).map(t=>c.sigFigs(t,2)).map(t=>["-b:v",t+"k","-maxrate",t+"k","-bufsize",c.sigFigs(t/2,2)+"k"]).getOrElse(()=>[]);return f.stdoutResult(m.Settings.ffmpegPath.valueOrDefault,["-loglevel","error","-i",t.src.nativePath,"-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high",...e,"-c:a","aac",t.dest.nativePath],{timeout:t.timeoutMs,isIgnorableError:S})}))};const w=/(?:corrupt|invalid|error.*decoding|decode.*failed|nothing.*output|partial file)/i;function S(t){return null==a.errorToS(t).match(w)}e.ffmpegValidVideo=function t(e,n=1){return i(this,void 0,void 0,(function*(){const i=yield f.stdoutResult(m.Settings.ffmpegPath.valueOrDefault,["-v","error","-i",e.nativePath,"-f","null","-"],{timeout:l.orElse(yield v.syncFileTimeoutForFileMs(e),2*o.minuteMs),isIgnorableError:S,ignoreExitCode:!0,quiet:!1});return null!=i.code||n<=0?i:t(e,n-1)}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(49),r=n(72);class s extends r.MultiMap{constructor(t){super(new i.TTLMap(t)),this.ttlMs=t,this.m=this.store}add(t,e){return this.m.touch(t),super.add(t,e)}}e.TTLMultiMap=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6),r=n(12),s=n(57),o=n(48);function a(t,e,n,i){const r=Math.floor(Math.max(0,e.row)),s=Math.ceil(Math.min(t.row,n.row)),o=Math.floor(Math.max(0,e.col)),a=Math.ceil(Math.min(t.col,n.col));for(let e=r;e<s;e++)for(let n=o;n<a;n++)i(e*t.col+n)}function u(t,e,n,r){let s=0;return a(e,n,r,e=>i.mapFinite(t[e],t=>s+=t*t)),Math.sqrt(s)}function l(t,e,n,r){const s=[];return a(e,n,r,e=>i.mapFinite(t[e],t=>s.push(t))),o.mode(s)}e.vecXvec=function(t,e){return t.map((t,n)=>t*e[n])},e.matXvec=function(t,e){return t.map((t,n)=>{if(t.length!==e.length)throw new Error("misshaped matrix on row "+n);return o.sum(t.map((t,n)=>t*e[n]))})},e.slice=function(t,e,n){const i=Math.max(0,e.row),s=Math.min(t.length,n.row),o=Math.max(0,e.col),a=Math.min(t[0].length,n.col);return r.range(i,s,e=>t[e].slice(o,a))},e.index1D=function(t,e,n){return e*t.col+n},e.submatrixForEach=a,e.submatrixMagnitude=u,e.subMatrixMode=l,e.leastQuarter=function(t,e){const n=e.col,i=e.row,s=[u(t,e,{col:n/2,row:0},{col:n,row:i/2}),u(t,e,{col:0,row:0},{col:n/2,row:i/2}),u(t,e,{col:0,row:i/2},{col:n/2,row:i}),u(t,e,{col:n/2,row:i/2},{col:n,row:i})];return r.leastIndex(s)},e.greatestHalf=function(t,e){const n=e.col,i=e.row,s=[l(t,e,{col:0,row:0},{col:n,row:i/2}),l(t,e,{col:0,row:0},{col:n/2,row:i}),l(t,e,{col:0,row:i/2},{col:n,row:i}),l(t,e,{col:n/2,row:0},{col:n,row:i})];return r.greatestIndex(s)},e.submatrixCollect=function(t,e,n){const i=[];return a(t,e,n,t=>i.push(t)),i},e.modeReduce=function(t,e,n){const o=Math.floor(e.col/n.col),u=Math.floor(e.row/n.row),l=new s.Average(Math.ceil(o*u));return r.concat(...r.stepRange(0,e.row,u,n=>r.stepRange(0,e.col,o,r=>{return l.clear(),a(e,{col:r,row:n},{col:r+o,row:n+u},e=>i.mapFinite(t[e],t=>l.push(t))),l.sampleMode})))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(41),r=n(1),s=n(9);function o(t){return r.includes(["number","string"],typeof t)}e.isDbValue=o,e.isDbValued=function(t){return null!=t&&s.entries(t).every(([,t])=>o(t))},e.toDbValued=function(t){return s.mapFields(t,(t,e)=>{if(!t.startsWith("$"))return"boolean"==typeof e?[t,e?1:0]:o(e)?[t,e]:i.isDated(e)?[t,i.datedToMillis(e)]:void 0})}},,function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6);e.TTLArray=class{constructor(t,e){this.ttlMs=t,this.maxLength=e,this.times=[],this.a=[]}push(...t){i.times(t.length,()=>this.times.push(Date.now())),this.a.push(...t),null!=this.maxLength&&this.vacuum()}pushUniq(...t){t.forEach(t=>{this.includes(t)||this.push(t)})}includes(t){return this.vacuum(),this.a.indexOf(t)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;if(null!=this.maxLength){const t=this.a.length-this.maxLength;this.times.splice(0,t),this.a.splice(0,t)}const t=Date.now()-this.ttlMs,e=this.times.findIndex(e=>e>t);-1===e?this.clear():e>0&&(this.times.splice(0,e),this.a.splice(0,e))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(20),s=n(13),o=new(n(174).TTLMultiMap)(10*i.minuteMs);function a(t){return[t.toString(),...r.toA(o.get(t.toString()))]}s.onFileCopied((t,e)=>{o.add(t,e),o.add(e,t)}),e.sameNativePaths=a,e.getOrSetByNativePath=function(t,e,n){for(const e of a(t)){const t=n.get(e);if(null!=t)return t}const i=e(t);return n.set(t.toString(),i),i}},function(t,e){t.exports=require("net")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(19),r=n(1),s=n(50);let o=0;e.geopid=s.GeoRadix.encode(i.pid),e.uid=function(t=0){return e.geopid+"-"+s.GeoRadix.encode(++o,t)},e.parseUid=function(t){const e=r.compact(t.split("-").map(t=>s.GeoRadix.decode(t)));return 2===e.length?{pid:e[0],i:e[1]}:void 0}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(19),s=n(1),o=n(2),a=n(5),u=n(4),l=n(0),c=n(9),d=n(70),h=n(7),f=n(17),p=n(23),m=n(40),g=n(10);function v(t=r.env){return l.firstDefined(t.LC_ALL,t.LC_MESSAGES,t.LANG,t.LANGUAGE)}e.defaultLocale="en",e.locale=u.lazy(()=>i(void 0,void 0,void 0,(function*(){return b(yield h.firstDefinedPromise([()=>v(),()=>p.isWin?w():void 0,()=>p.isMac?M():void 0,()=>p.isPosix?x():void 0]))})));const y=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function b(t){if(o.blank(t)||g.equalsIgnoreCase("c",t)||g.equalsIgnoreCase("posix",t))return e.defaultLocale;{const n=y.exec(t);return null==n?e.defaultLocale:s.compact([n[1],n[2]]).join("-")}}function w(){return h.thenMap(m.PowerShell.instance().executeJson("GET-WinSystemLocale | Select-Object -Property Name"),t=>t.Name)}e.lc2locale=b,e.winLocale=w;const S={timeout:10*a.secondMs};function M(){return d.thenOpt(f.stdout("defaults",["read","-globalDomain","AppleLocale"],S)).flatMap(b).get()}e.macLocale=M;const P=/^([a-z_]+)\s*=\s*"(.+)"$/i;function x(){return d.thenOpt(f.stdout("locale",[],S)).flatMap(t=>t.split("\n").map(t=>l.map(t.match(P),t=>[t[1],t[2]]))).flatMap(c.fromEntries).flatMap(v).flatMap(b).get()}e.posixLocale=x},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(26),r=n(3),s=n(10),o=n(1),a=n(2),u=n(9),l=n(14),c=new Map;function d(t){c.set(t.$ctor,t)}e.addModelClass=d;const h=([t,e])=>null!=t&&null!=e;function f(t,e,n=[]){const r=t.class();return u.keys(e).filter(t=>"$ctor"!=t).filter(t=>null!=e[t]).map(t=>{const a=e[t];return n.forEach(e=>t=s.stripPrefix(t,e)),o.includes(r.booleanFields,t)?[t,i.truthy(a)]:[t,a]}).filter(h).forEach(([e,n])=>t[e]=n),t}e.fromJSON=function(t,e){if(null==e)throw new Error("json is null");if(null!=t&&a.notBlank(t.$ctor)&&!c.has(t.$ctor)&&d(t),e instanceof t)return e;const n=l.Opt(e.$ctor).flatMap(t=>c.get(t)).getOrElse(()=>t);if(e instanceof n)return e;const i=new n;return null==e?i:f(i,e,o.uniq([t.tableName+".",n.tableName+"."]))},e.assignFromJSON=f,e.toJSON=function t(e,n,i){if(null!=e)return Array.isArray(e)?e.map((e,r)=>t(e,n,`${i}[${r}]`)):"function"==typeof e.toJSON?e.toJSON():void r.mkLogger("ModelJSON.toJSON()").warn("Failed",{m:e,key:i,mc:n.$ctor})}},,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(55),s=n(108),o=n(30),a=n(1),u=n(0),l=n(7),c=n(10),d=n(27);class h{constructor(t,e){this.dir=t,this.nativePath=o.join(this.dir,e.name),this.ext=d.extname2(e.name),this.base=e.name,this.name=c.stripSuffix(this.base,this.ext),this._isFile=e.isFile(),this._isDirectory=e.isDirectory(),this._isSymbolicLink=e.isSymbolicLink()}static for(t){return i(this,void 0,void 0,(function*(){const e=d.parseNativePath(t);return s.stat(t).then(t=>new h(e.dir,{name:e.base,isFile:t.isFile.bind(t),isDirectory:t.isDirectory.bind(t),isSymbolicLink:t.isSymbolicLink.bind(t)})).catch(()=>void 0)}))}toString(){return this.nativePath}isFile(){return this._isFile}isDirectory(){return this._isDirectory}isSymbolicLink(){return this._isSymbolicLink}parent(){const t=d.parseNativePath(this.dir);return t.dir===this.dir?this:new h(t.dir,{name:t.base,isFile:function(){return!1},isDirectory:function(){return!0},isSymbolicLink:function(){return!1}})}children(){return this.isDirectory()?new Promise((t,e)=>{r.readdir(this.nativePath,{withFileTypes:!0},(n,i)=>{null!=n?e(n):t(u.map(i,t=>a.sortBy(t,t=>t.name.toLowerCase().normalize()).map(t=>new h(this.nativePath,t))))})}):void 0}stat(){return s.stat(this.nativePath).catch(()=>void 0)}size(){return i(this,void 0,void 0,(function*(){return l.thenMap(this.stat(),t=>t.size)}))}mtimeMs(){return i(this,void 0,void 0,(function*(){return l.thenMap(this.stat(),t=>t.mtimeMs)}))}}e.DirectoryEntry=h},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(55),s=n(36),o=n(0),a=n(22),u=n(53),l=n(59),c=n(18),d=n(63),h=n(11),f=n(149),p=n(133),m=n(96),g=n(132);e.CaptureLogger=class{constructor(){this.logEntries=[]}log(t,e,n,i){this.logEntries.push({timestamp:Date.now(),level:t,context:e,msg:n,meta:i})}enabled(){return!0}close(){}flush(){return i(this,void 0,void 0,(function*(){}))}};e.LogWriter=class{constructor(t,e,n={}){this.logDir=t,this.prefix=e,this.ended=!1,this.mutex=new u.Promises,this._linesSinceRotate=0,this.pendingWrites=[],this._startIndex=0,this.maybeFlush=()=>{this.mutex.maybeRun("maybeFlush",()=>this._flush())},this.shouldRotate=()=>null==this._stream||this._linesSinceRotate>=this.opts.maxLinesPerFile,this.flush=()=>this.mutex.serial("flush",()=>this._flush()),this.name="GzLogWriter("+t+")",this.opts=Object.assign({filter:m.logFilter(),maxLinesPerFile:25e4,logFormatter:new g.ColoredLogFormatter({prefix:e}),errorLogger:f.ConsoleLogger.instance(),flushEveryMs:p.DefaultLogFlushMs},n),this.flushInterval=l.setUnrefInterval(()=>this.maybeFlush(),this.opts.flushEveryMs),a.addLoggerEndable(this)}enabled(t,e){return this.opts.filter.enabled(t,e)}log(t,e,n,i){this.opts.filter.enabled(t,e)&&(this.ended&&m.levelIndex(t)<=1?this.opts.errorLogger.log(t,e,n,i):this.pendingWrites.push(this.opts.logFormatter.format(t,e,n,i)+"\n"))}end(){return i(this,void 0,void 0,(function*(){return this.ended=!0,o.map(this.flushInterval,s.clearInterval),this.flushInterval=void 0,this.close()}))}close(){return i(this,void 0,void 0,(function*(){return yield this.flush(),this.mutex.serial("close",()=>this._closeCurrent())}))}_flush(){return i(this,void 0,void 0,(function*(){const t=[...this.pendingWrites];for(this.pendingWrites.length=0;t.length>0;){this.shouldRotate()&&(yield this._rotate());const e=this._stream;if(null==e)return void this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const n=this.opts.maxLinesPerFile-this._linesSinceRotate,i=t.splice(0,n);this._linesSinceRotate+=i.length,e.write(i.join(""))}}))}errback(t){return e=>this.opts.errorLogger.log("error","Caught error from "+t,e)}_rotate(){return i(this,void 0,void 0,(function*(){yield this._closeCurrent(),this._currentFile=yield this.logDir.join(c.datestamp(),this.prefix+".log").ensureNew({emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=r.createWriteStream(this._currentFile.nativePath).on("error",this.errback("file write stream"))}))}_closeCurrent(){return i(this,void 0,void 0,(function*(){yield o.map(this._stream,t=>d.end(t)),this._stream=void 0,this._linesSinceRotate=0,h.Settings.logCompression.valueOrDefault&&(yield o.map(this._currentFile,t=>t.gzip())),this._currentFile=void 0}))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(14),o=n(245),a=n(10),u=n(44),l=n(27);function c(t){const e=new Set(i.compactBlanks(t.map(t=>a.ensurePrefix(t.toLowerCase().normalize(),"."))));return o.Filter.lift(t=>s.Opt(t).flatMap(t=>r.firstNotBlank(t.ext,t.base)).map(t=>e.has(t.toLowerCase().normalize())).getOrElse(()=>!1))}e.excludedPathFilter=function(t){const e=new Set(t.map(t=>t.toLowerCase()));return o.Filter.lift(t=>l.pathnames(t.nativePath).every(t=>!e.has(t.toLowerCase())))},e.extFilter=c,e.browserImgExtFilter=c(u.BrowserImgExts),e.browserExtFilter=c(u.BrowserExts),e.videoExtFilter=c(u.VideoExts)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2);e.isSupportedVideoMimeType=function(t){return i.notBlank(t)&&t.startsWith("video/")}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(4),s=n(38),o=n(7),a=n(18),u=n(50),l=n(60),c=n(281),d=n(32);class h{constructor(t){this.rootDir=t,this.jfs=new c.JsonFileStore(t.join("uid.json"),()=>this.mkUid())}readUid(){return i(this,void 0,void 0,(function*(){return this.jfs.read()}))}mkUid(){return i(this,void 0,void 0,(function*(){return{uid:u.GeoRadix.randomUid(),version:l.version,createdAtIso:a.isoNow()}}))}}e.UIDStore=h,e.SystemUIDStore=r.lazy(()=>new h(d.PosixFile.for(s.App.userData()))),s.App.userData.onChange(()=>e.SystemUIDStore.clear()),e.systemUID=function(){return o.thenMapOr(e.SystemUIDStore().readUid(),t=>t.uid,()=>"missing!").catch(t=>"Failed to fetch System UID: "+t)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),s=n(28),o=n(17),a=n(15),u=n(251),l=n(94),c=n(138),d=n(3),h=n(37),f=n(56),p=n(155);e.dcrawSupportedMimeTypes=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-fuji-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);const m=d.mkLogger("dcraw");function g(t){return h.isMimetype(t.nativePath,e.dcrawSupportedMimeTypes)}e.dcrawSupported=g;const v=p.ImageSize.largestFit().megapixels();e.dcraw=function(t){return i(this,void 0,void 0,(function*(){if(!(yield g(t)))throw new Error(t+" is unsupported");const e=Date.now(),n=yield h.readTags(t.nativePath),d=f.tmegapixels(n),p=null!=d&&d>4*v,y=yield c.dcrawNativePath(),b=["-T","-c","-H","2","-w","-o","1",...p?["-h"]:[],"-q","2",t.nativePath],w=2*r.minuteMs,S={encoding:"buffer",timeout:w,maxBuffer:250*s.MB};m.debug("dcraw()",{cmd:y,args:b,opts:S});const M=yield o.execFile(y,b,w,S),P=e=>i(this,void 0,void 0,(function*(){(yield u.emitSafely(M.stdout,"error","Problem from "+t+": "+a.cleanError(e,t.nativePath)))||m.error("No listeners for error when reading "+t,e),M.kill("SIGINT")}));M.on("error",P),M.stderr.on("data",P);const x=new l.PullProgressObserver({path:t.nativePath,op:"Converting raw image..."},30*r.secondMs,()=>Date.now()-e);return M.on("close",()=>x.end()),M.stdout}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(93),s=n(1),o=n(0),a=n(6),u=n(9),l=n(12),c=n(52),d=n(18),h=n(13),f=n(3),p=n(57),m=n(253),g=n(127),v=n(175),y=n(254),b=n(48),w=n(16),S=n(11),M=n(255),P=n(156);e.DefaultDim=8;const x=f.mkLogger("ImageHash"),E=new c.BoundedMap(3e5,500,!0);function _(t){return i(this,void 0,void 0,(function*(){return E.getOrSet(t.nativePath,()=>d.elapsedAsync(()=>(function(t){return i(this,void 0,void 0,(function*(){const n=f.mkLogger("ImageHash("+t.baseWithGrandparent+")");try{n.debug("starting");const i=e.DefaultDim,a=6*i,u=yield P.sharpReadable(t,{width:2*a,height:2*a});if(null==u)return void x.warn("Cannot build readable stream for "+t);const c=(yield r(u.nativePath).trim().resize({width:a,height:a,fit:"fill",fastShrinkOnLoad:!0}).toColorspace("srgb").raw()).toBuffer();n.debug("big resize done");const d=yield r(u.nativePath).trim().resize({width:i,height:i,fit:"fill",fastShrinkOnLoad:!0}).toColorspace("srgb").raw().toBuffer();n.debug("small resize done");const h=[...d.values()],f=[[],[],[]],m=[new p.Average,new p.Average,new p.Average];for(let t=0;t<h.length;t+=3){const e=M.rgb2lab(h.slice(t,t+3));for(let t=0;t<3;t++)f[t].push(e[t]),m[t].push(e[t])}n.debug("Mean values: ",{l:m[0].stats(),a:m[1].stats(),b:m[2].stats()});const w=v.leastQuarter(f[0],{col:i,row:i});n.debug("rotating "+90*w+" degrees");const S=f.map(t=>new y.SquareMatrix(t,i).rotate(90*w).m),E=S.map((t,e)=>{const n=m[e].avg;return t.map(t=>t>n?1:0)}),_=D(s.flatten(E)),O=S.map(t=>t.map((e,n)=>e<o.orElse(t[n+1],0)?1:0).slice(0,-1)),T=D(s.flatten(O)),F=yield c,k=l.stepRange(0,F.length,3,t=>M.rgb2lab([F[t],F[t+1],F[t+2]])),A=6,I=Math.floor(52/A),C=b.modes(k.map(t=>M.labhash(t,A)),I),L={meanHash:_,rightHash:T,mode8b6:g.concatBits(C,A)};return n.debug("final result",L),L}catch(e){return void n.warn("Failed to labUid("+t.nativePath+"): "+e)}}))})(t)).then(({elapsedMs:t,result:n})=>(e.elapsedAvg.push(t),x.tap({level:t>50?"info":"debug",msg:"imageHash()",result:n}))))}))}function O(t){return o.map(t,t=>a.sigFigs(t,2))}function T(t,e){return o.map2(t,e,(t,e)=>b.jaccard(g.splitBits(t,6),g.splitBits(e,6)))}function F(t,e){if(null==t||null==e)return;const n={meanHamm:O(m.b64hammRatio(t.meanHash,e.meanHash)),rightHamm:O(m.b64hammRatio(t.rightHash,e.rightHash)),mode8b6jacc:T(t.mode8b6,e.mode8b6)};return x.debug("imageHashCompare()",n),u.reqValuedOrElse(n)}function k(t,e){return A(F(t,e))}function A(t){if(null==t)return!1;const e=S.Settings.minImageCorrPct.valueOrDefault/100,n=S.Settings.minDominantColorCorrPct.valueOrDefault/100;return(w.gte(t.meanHamm,e)||w.gte(t.rightHamm,e))&&w.gte(t.mode8b6jacc,n)}function I(t){return null!=t&&(w.gte(t.meanHamm,.95)&&w.gte(t.rightHamm,.9)&&w.gte(t.mode8b6jacc,.9))}function D(t){return m.b64encode(BigInt("0b0"+t.map(t=>1===t?1:0).join("")))}e.elapsedAvg=new p.Average,e.imageHash=_,h.onFileCopied((t,e)=>o.map(E.get(t),t=>E.getOrSet(e,()=>t))),e.mode8b6jacc=T,e.imageHashCompare=F,e.isSimilarImage=function(t,e){return i(this,void 0,void 0,(function*(){return o.map2(yield _(t),yield _(e),k)}))},e.isSimilarImageHash=k,e.isSimilarComparison=A,e.isVerySimilarImageHash=function(t,e){return I(F(t,e))},e.isVerySimilarComparison=I,e.imageHashSimilarity=function(t,e){return o.map(F(t,e),t=>b.avgMaybe(t.meanHamm,t.rightHamm))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(9);e.TTLSet=class{constructor(t){this.ttlMs=t,this.expireListeners=[],this.delegate=new Map,this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(t,e=this.ttlMs){return this.delegate.set(t,Date.now()+(e-this.ttlMs)),this}addIfMissing(t,e){const n=this.delegate.get(t);return null==n||n&&this.expired(t,n)?(this.add(t),e()):void 0}clear(){return this.delegate.clear(),this}delete(t){return this.delegate.delete(t)}forEach(t,e){for(const[e,n]of this.delegate)this.expired(e,n)||t(e,e,this)}has(t){return!this.expired(t,this.delegate.get(t))}values(){const t=this;return function*(){for(const[e,n]of t.delegate.entries())t.expired(e,n)||(yield e)}()}entries(){const t=this;return function*(){for(const[e,n]of t.delegate.entries())t.expired(e,n)||(yield[e,e])}()}toA(){return this.vacuum(),[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}on(t,e){this.expireListeners.push(e)}expired(t,e){return i.tap(null==e||e+this.ttlMs<=Date.now(),n=>{null!=e&&n&&(this.expireListeners.forEach(e=>e(t)),this.delegate.delete(t))})}vacuum(){this.delegate.forEach((t,e)=>{this.expired(e,t)})}}},function(t,e){("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"0.6.0-beta.11+20191107192450"}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(33);e.isList=function(t){return null!=t&&(Array.isArray(t)||isFinite(t.length)&&i.isFunction(t[Symbol.iterator])&&i.isFunction(t.push)&&i.isFunction(t.pop)&&i.isFunction(t.forEach)&&i.isFunction(t.some))}},function(t,e){t.exports=require("he")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(33);e.asPromise=function(t){return i(this,void 0,void 0,(function*(){return r.isFunction(t)?t():t}))}},function(t,e){t.exports=require("zlib")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(9);e.MRUMap=class{constructor(t=1e3,e=!1){if(this.maxSize=t,this.fifo=e,this.delegate=new Map,this.expireListeners=[],t<1)throw new Error("maxSize must be positive")}get size(){return this.delegate.size}clear(){return this.delegate.clear(),this}delete(t){return this.delegate.delete(t)}entries(){return this.delegate.entries()}forEach(t){this.delegate.forEach(t)}get(t){if(this.delegate.has(t)){const e=this.delegate.get(t);return this.fifo||(this.delegate.delete(t),this.delegate.set(t,e)),e}}getOrSet(t,e){return this.delegate.has(t)?this.get(t):i.tap(e(),e=>this.set(t,e))}has(t){return this.delegate.has(t)}keys(){return this.delegate.keys()}set(t,e){return this.delegate.set(t,e),this.vacuum(),this}values(){return this.delegate.values()}[Symbol.iterator](){return this.entries()}on(t,e){this.expireListeners.push(e)}vacuum(){if(this.delegate.size>this.maxSize)for(const[t,e]of this.delegate)if(this.delegate.delete(t),this.expireListeners.forEach(n=>n(t,e)),this.delegate.size<=this.maxSize)return}}},function(t,e){t.exports=require("events")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(117),r=n(4),s=n(60);e.Version=r.lazy(()=>i.parse(s.version)),e.isAlphaVersion=r.lazy(()=>s.version.includes("-alpha")),e.isBetaVersion=r.lazy(()=>s.version.includes("-beta")),e.channel=r.lazy(()=>e.isAlphaVersion()?"alpha":e.isBetaVersion()?"beta":"latest")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(19),s=n(1),o=n(2),a=n(5),u=n(4),l=n(0),c=n(6),d=n(9),h=n(58),f=n(20),p=n(8),m=n(22),g=n(7),v=n(17),y=n(18),b=n(68),w=n(61),S=n(3),M=n(23),P=n(40),x=u.lazy(()=>S.mkLogger("Ps"));function E(t){return null!=t&&c.gt0(t.pid)&&null!=t.start&&o.notBlank(t.cmd)}function _(t){return i(this,void 0,void 0,(function*(){const e=f.toA(t).filter(c.gt0);if(s.isEmpty(e))throw new Error("Invalid pids: "+JSON.stringify(t));return h.thenTap(g.thenMap(M.isWin?function(t){return i(this,void 0,void 0,(function*(){if(m.ending()||P.PowerShell.instance().ended)return D(t);const e=[T,"-Id",k(t),"-ErrorAction SilentlyContinue",F].join(" ");return g.thenMap(P.PowerShell.instance().executeJsonToA(e),t=>O(t))}))}(e):function(t){return i(this,void 0,void 0,(function*(){return C((yield v.stdoutResult("ps",["-p",k(t),"-wwwo","pid,lstart,command"],Object.assign(Object.assign({},A),{ignoreExitCode:!0}))).result)}))}(e),t=>t.filter(t=>E(t)&&e.includes(t.pid))),t=>x().debug("pidInfo()",{pids:e,result:t}))}))}function O(t){return t.map(t=>({pid:t.Id,start:y.pwshJsonDate(t.StartTime),cmd:t.ProcessName}))}e.ps=function(){return i(this,void 0,void 0,(function*(){const t=yield M.isWin?function(){return i(this,void 0,void 0,(function*(){if(m.ending()||P.PowerShell.instance().ended)return D();const t=yield P.PowerShell.instance().executeJsonToA([T,F].join(" "));return null==t?D():O(t)}))}():function(){return i(this,void 0,void 0,(function*(){return C(yield v.stdout("ps",["-ewwwo","pid,lstart,command"],A))}))}();return l.orElse(s.sortBy(t.filter(E),t=>t.pid),[])}))},e.pidInfo=function(t){return i(this,void 0,void 0,(function*(){return g.thenMap(_([t]),e=>f.toA(e).find(e=>e.pid===t))}))},e.pidInfos=_;const T="Get-Process",F="| Select-Object -Property Id,ProcessName,StartTime";function k(t){return s.uniq([...t.filter(c.gt0),r.pid]).join(",")}const A={maxBuffer:1048576,timeout:15*a.secondMs,ignoreExitCode:!0,ignoreStderr:!0},I=["CommandLine","CreationDate","ProcessId"];function D(t){return i(this,void 0,void 0,(function*(){const e=["process"];if(s.isNotEmpty(t)){const n=s.uniq([...t.filter(c.gt0),r.pid]).map(t=>`ProcessId=${t}`).join(" or ");e.push("where",n)}e.push("get",I.join(","));const n=yield v.stdoutResult(w.wmic(),e,A);return d.onlyReqValued(b.parseFixed(I,n.result).map(t=>({pid:c.toInt(t.ProcessId,{defaultValue:-1}),start:y.wmiDate(t.CreationDate),cmd:p.toS(t.CommandLine)})))}))}function C(t){return b.parseFixed(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],t).map(t=>({pid:c.toInt(t.PID,{defaultValue:-1}),start:new Date(t.STARTED),cmd:p.toS(t.COMMAND)}))}e.psWinWmic=D},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(42),r=n(109);class s extends r.Duplex{constructor(t){super(t),this.deferred=new i.Deferred("WritableToBuffer"),this._buf=[],this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",t=>{this.deferred.reject(t)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_read(){}_write(t,e,n){const i=Buffer.isBuffer(t)?t:Buffer.from(t,e);this._buf.push(i),n()}}e.WritableToBuffer=s},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});e.CompoundLogger=class{constructor(t,...e){if(this.primary=t,null==t)throw new Error("null primary logger");this.delegates=[t,...e]}enabled(t,e){return this.primary.enabled(t,e)}log(t,e,n,i){this.enabled(t,e)&&this.delegates.forEach(r=>r.log(t,e,n,i))}flush(){return i(this,void 0,void 0,(function*(){yield Promise.all(this.delegates.map(t=>t.flush()))}))}close(){this.delegates.forEach(t=>t.close())}}},function(t,e){t.exports=require("@iarna/toml")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0);e.debounce=function(t,e){let n;const r=()=>{i.map(n,global.clearTimeout),n=global.setTimeout(()=>t(),e)};return r.reset=()=>{i.map(n,global.clearTimeout),n=void 0},r.now=()=>{r.reset(),t()},r}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(45),o=n(4),a=n(0),u=n(7),l=n(17),c=n(29),d=n(24),h=/^([a-z0-9\/ -_]+) on (.+?) \((.+)\)$/i;function f(){return i(this,void 0,void 0,(function*(){const t=yield l.stdout("mount",[],{timeout:d.cmdTimeoutMs});return r.compact(t.split("\n").map(t=>a.map(h.exec(t),t=>{const[e,n,i]=t.slice(1);return{filesystem:e,mountpoint:n,options:i.split(",").map(t=>t.trim())}})))}))}function p(t){return i(this,void 0,void 0,(function*(){const e=c.BaseFile.for(t),n=yield u.thenMapOr(yield e.childNames(),t=>t.filter(t=>!t.startsWith(".")).map(t=>t.toLowerCase()).sort(),()=>[]);return s.arrayEql(n,["applications","photostructure.app"])}))}e.mounts=f,e.ignorableMacFilesystems=o.lazy(()=>i(void 0,void 0,void 0,(function*(){return u.asyncFilter(yield f(),t=>i(void 0,void 0,void 0,(function*(){return t.options.includes("nobrowse")||t.options.includes("quarantine")||(yield p(t.mountpoint))}))).then(t=>t.map(t=>t.filesystem))})),d.mountpointsTtlMs),e.isInstallDmg=p},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(0),o=n(7),a=n(111),u=n(110);e.mountpointsPosix=function(){return i(this,void 0,void 0,(function*(){const t=yield o.thenMap(a.dfPosixRaw(!1),t=>r.compactBlanks(t.map(t=>t.mountpoint)));if(null!=t&&(yield u.isGioSupported())){const e=yield u.gioVolumes();t.push(...e.map(t=>t.mountpoint))}return s.map(t,t=>t.filter(t=>!t.startsWith("/snap/")&&"/dev"!==t))}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(5),o=n(4),a=n(70),u=n(17),l=n(61),c=n(40),d=n(24),h=/\s([A-Z]:\\)/g;e.mountpointsWin=o.lazy(()=>i(void 0,void 0,void 0,(function*(){return a.thenOpt(c.PowerShell.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(t=>t.map(t=>t.Root)).filter(r.isNotEmpty).orElse(()=>e.mountpointsWinFsutil()).map(t=>t.sort()).getRequired()})),d.mountpointsTtlMs),e.mountpointsWinFsutil=o.lazy(()=>i(void 0,void 0,void 0,(function*(){const t=(yield u.stdout(yield l.fsutil(),["fsinfo","drives"],{timeout:10*s.secondMs})).trim(),e=[];let n;for(;null!==(n=h.exec(t));)e.push(n[1]);return e})),d.mountpointsTtlMs)},function(t,e){t.exports=require("punycode")},function(t,e){t.exports=require("dns")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(5),o=n(6),a=n(14),u=n(8),l=n(71),c=n(17),d=n(61),h=n(23);e.ping=l.memoize(t=>i(void 0,void 0,void 0,(function*(){const e=h.isWin?yield d.pingWin():"ping";return c.stdout(e,[h.isWin?"-n":"-c","1",t],{timeout:5*s.secondMs})})),5*s.minuteMs,255),e.ipv4Re=new RegExp("\\b"+o.times(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),e.ipAddrFromPing=l.memoize(t=>i(void 0,void 0,void 0,(function*(){return a.Opt(yield e.ping(t).catch(t=>{console.warn("failed to ping: "+t)})).filter(r.notBlank).flatMap(t=>e.ipv4Re.exec(u.toS(t))).map(t=>t[0]).get()})),5*s.minuteMs,255)},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(51),s=n(7),o=n(111),a=n(110),u=n(31),l=n(24),c=r.keyedLazy("localMountpoints",u.mountsCacheKey,()=>s.thenMap(o.dfPosixRaw(!0),t=>t.map(t=>t.mountpoint)),{maxRetries:2,timeoutMs:l.cmdTimeoutMs,priorResultTtlMs:l.longTtlMs});e.dfPosix=r.keyedLazy("dfPosix",u.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const t=yield o.dfPosixRaw(!1);if(null!=t)return yield s.thenMap(c(),e=>{t.forEach(t=>{t.remote=!e.includes(t.mountpoint)})}),(yield a.isGioSupported())&&(yield s.thenMap(a.gioVolumes(),e=>t.push(...e))),t}))}),{maxRetries:2,timeoutMs:l.cmdTimeoutMs,priorResultTtlMs:l.dfTtlMs})},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(0),o=n(6),a=n(51),u=n(15),l=n(13),c=n(3),d=n(40),h=n(10),f=n(214),p=n(31),m=n(151),g=n(24),v=c.mkLogger("DfWin");function y(){return i(this,void 0,void 0,(function*(){const t=yield d.PowerShell.instance().executeJsonToA(e.LocalAndNetCmd).catch(t=>{u.onError("_localAndNet(): PowerShell failed, trying wmic",t)});return null==t?f._localAndNet():t.map(t=>Object.assign({mountpoint:t.Root,filesystem:"",label:t.Description,size:t.Used+t.Free,used:t.Used,available:t.Free,remote:r.notBlank(t.DisplayRoot)},s.map(m.parseRemoteName(t.DisplayRoot),t=>({remoteHost:t.host,remoteShare:t.share}))))}))}function b(){return i(this,void 0,void 0,(function*(){const t=yield d.PowerShell.instance().executeJsonToA(e.LocalCmd);return null==t?f._local():t.filter(t=>r.notBlank(t.DriveLetter)&&(r.notBlankAnd(t.HealthStatus,t=>h.equalsIgnoreCase(t,"Healthy"))||r.notBlankAnd(t.OperationalStatus,t=>h.equalsIgnoreCase(t,"OK")))).map(t=>({mountpoint:t.DriveLetter+":\\",filesystem:t.FileSystem,label:t.FileSystemLabel,size:t.Size,used:t.Size-t.SizeRemaining,available:t.SizeRemaining,remote:!1}))}))}e.dfWin=a.keyedLazy("dfWin",p.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){return(yield y().catch(t=>(v.warn("_localAndNet timed out, using local volumes.",t),b()))).filter(t=>r.notBlank(t.mountpoint)&&o.gt0(t.size))}))}),{maxRetries:2,timeoutMs:g.cmdTimeoutMs,priorResultTtlMs:g.dfTtlMs}),l.onClearCache(()=>e.dfWin.clear()),e.LocalAndNetCmd="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free",e._localAndNet=y,e.LocalCmd="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus",e._local=b},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(6),o=n(12),a=n(51),u=n(17),l=n(68),c=n(61),d=n(3),h=n(16),f=n(10),p=n(31),m=n(24);e.REMOVABLE_DISK=2,e.LOCAL_DISK=3,e.NETWORK_DRIVE=4;const g=d.mkLogger("DfWinWmic");e.dfWin=a.keyedLazy("dfWin",p.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){return(yield y().catch(t=>(g.warn("_localAndNet timed out, using local volumes.",t),w()))).filter(t=>o.allNotBlank([t.mountpoint,t.filesystem])&&t.size>0)}))}),{maxRetries:2,timeoutMs:m.cmdTimeoutMs,priorResultTtlMs:m.dfTtlMs});const v="LOGICALDISK get DeviceID,DriveType,FileSystem,FreeSpace,Size,VolumeName /format:table".split(" ");function y(){return i(this,void 0,void 0,(function*(){const t=c.wmic(),n=yield u.stdout(t,v,{timeout:m.cmdTimeoutMs});return S(l.parseFixed(["DeviceID","DriveType","FileSystem","FreeSpace","Size","VolumeName"],n,!1).map(t=>{const n=r.mapNotBlank(t.DeviceID,t=>f.ensureSuffix(t,"\\")),i=t.FileSystem,o=t.VolumeName,a=s.toInt(t.Size,{defaultValue:0}),u=s.toInt(t.FreeSpace,{defaultValue:0});return{mountpoint:n,filesystem:i,label:o,size:a,used:a-u,available:u,remote:s.toInt(t.DriveType,{defaultValue:e.LOCAL_DISK})===e.NETWORK_DRIVE}}))}))}e._localAndNet=y;const b="VOLUME get Capacity,DriveLetter,FileSystem,FreeSpace,Label /format:table".split(" ");function w(){return i(this,void 0,void 0,(function*(){const t=c.wmic(),e=yield u.stdout(t,b,{timeout:m.cmdTimeoutMs});return S(l.parseFixed(["Capacity","DriveLetter","FileSystem","FreeSpace","Label"],e,!1).map(t=>{const e=r.mapNotBlank(t.DriveLetter,t=>f.ensureSuffix(t,"\\")),n=t.FileSystem,i=t.Label,o=s.toInt(t.Capacity,{defaultValue:0}),a=s.toInt(t.FreeSpace,{defaultValue:0});return{mountpoint:e,filesystem:n,label:i,size:o,used:o-a,available:a,remote:!1}}))}))}function S(t){return t.filter(t=>o.allNotBlank(t.mountpoint,t.filesystem)&&h.gte(t.size,0))}e._local=w},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(0),o=n(51),a=n(17),u=n(67),l=n(10),c=n(31),d=n(24);e.addLocalVolumeInfoMac=function(t){return i(this,void 0,void 0,(function*(){const n=yield e.mnt2uuidMac();if(null!=n)return t.forEach(t=>{s.map(n.get(t.mountpoint),e=>{t.uuid=e.uuid,t.label=e.label})}),t}))},e.mnt2uuidMac=o.keyedLazy("mnt2uuidMac",c.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const t=(yield a.stdout("diskutil",["info","-all"],{timeout:d.cmdTimeoutMs})).split(/^\s*\*{3,}\s*$/m);return u.toMap(t,t=>{const e=u.toMap(t.split(/\s*\n+\s*/),t=>{const[e,n]=t.split(":").map(t=>t.trim());return l.includesIgnoreCase(["not applicable","no file system"],n)?void 0:[e.toLowerCase(),n]}),n=e.get("mount point"),i=e.get("volume name"),s=e.get("volume uuid");return r.blank(n)?void 0:[n,{label:i,uuid:s}]})}))}),{maxRetries:2,timeoutMs:d.cmdTimeoutMs,priorResultTtlMs:d.longTtlMs})},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(0),o=n(8),a=n(51),u=n(17),l=n(217),c=n(31),d=n(24);e.addLocalVolumeInfoPosix=function(t){return i(this,void 0,void 0,(function*(){const e=yield h();if(null!=e)return t.forEach(t=>{e.ignorablePaths.includes(t.mountpoint)?t.ignorable=!0:s.map(e.mnt2info.get(t.mountpoint),e=>{t.uuid=e.uuid,t.label=e.label})}),t}))};const h=a.keyedLazy("volumeInfoLinux",c.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const t=yield u.stdout("lsblk",["-P","--output","mountpoint,label,uuid"],{timeout:d.cmdTimeoutMs}),e=new Map,n=[];return t.split(/[\r\n]+/).forEach(t=>{s.map(l.parseEnvTokens(t),t=>{o.toS(t.mountpoint).startsWith("/")&&(r.blank(t.uuid)?n.push(t.mountpoint):e.set(t.mountpoint,t))})}),{mnt2info:e,ignorablePaths:n}}))}),{maxRetries:2,timeoutMs:d.cmdTimeoutMs,priorResultTtlMs:d.longTtlMs})},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.parseEnvTokens=function(t){const e=/([a-z]+)="(.*?)"/gi,n={};let i;for(;null!=(i=e.exec(t));){const[,t,e]=i;n[t.toLowerCase()]=e}return n}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(5),o=n(0),a=n(51),u=n(17),l=n(13),c=n(61),d=n(67),h=n(40),f=n(10),p=n(31),m=n(24);function g(){return i(this,void 0,void 0,(function*(){const t=yield c.fsutil(),e=yield u.stdout(t,["volume","list"],{timeout:7*s.secondMs}),n=new Map;let i;const r=/^\\\\.+\{([a-z0-9-]+)\}\\[\r\n]+([a-z]:\\)/gim;for(;null!=(i=r.exec(e));){const t=i[1],e=i[2];n.set(e,t)}return n}))}e.addLocalVolumeInfoWin=function(t){return i(this,void 0,void 0,(function*(){const e=yield v();if(null!=e)return t.forEach(t=>{o.map(e.get(t.mountpoint),e=>{t.remote=!1,t.uuid=e})}),t}))},e.UuidCmd="Get-Partition | Select-Object -Property DriveLetter,Guid,IsOffline",e._mnt2uuidWinFsutil=g;const v=a.keyedLazy("mnt2uuidWin",p.mountsCacheKey,(function(){return i(this,void 0,void 0,(function*(){const t=yield h.PowerShell.instance().executeJsonToA(e.UuidCmd);return null==t?g():d.toMap(t.filter(t=>r.notBlank(t.DriveLetter)&&!t.IsOffline&&r.notBlank(t.Guid)),t=>[t.DriveLetter+":\\",f.stripPreSuff(t.Guid,"{","}")])}))}),{maxRetries:2,timeoutMs:m.cmdTimeoutMs,priorResultTtlMs:m.longTtlMs});l.onClearCache(()=>v.clear())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(0),s=n(8),o=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i;e.addRemoteVolumeInfoPosix=function(t){return i(this,void 0,void 0,(function*(){return t.filter(t=>t.remote).forEach(t=>{r.map(o.exec(s.toS(t.filesystem)),e=>{t.remoteHost=e[1],t.remoteShare=e[2]})}),t}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(9),s=n(8),o=n(26),a=n(66);function u({logger:t,name:e,result:n}){const i=null==n?"warn":"debug";t.enabled(i)&&t.log(i,a.grey(e)+": "+(!0===n?a.green:a.red)(s.toS(n)))}e.orLogged=function(t,e){return t.some(t=>r.keys(t).some(n=>o.truthy(r.tap(t[n](),t=>u({logger:e,name:n,result:t})))))},e.orLoggedAsync=function(t,e){return i(this,void 0,void 0,(function*(){for(const n of t)for(const t of r.keys(n)){const i=yield n[t]();if(u({logger:e,name:t,result:i}),i)return i}return!1}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(46),s=n(0),o=n(12);e.SetSet=class{constructor(){this.store=new Map}add(t,...e){r.getOrSet(this.store,t,()=>new Set).add(e)}find(t){for(let e=0;e<t.length-1;e++){const n=s.map(this.store.get(t[e]),n=>{const r=t.slice(e+1),s=[...n].filter(t=>i.startsWith(r,t));return o.greatestBy(s,t=>t.length)});if(i.isNotEmpty(n))return[t[e],...n]}}has(t){return null!=this.find(t)}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(5),s=n(4),o=n(20),a=n(119),u=n(17),l=n(68),c=n(3),d=n(23),h=n(27),f=c.mkLogger("Snap");e.ignorableSnapDir=a.AsyncFilter.lift(t=>i(void 0,void 0,void 0,(function*(){if(!d.isLinux||!(yield e.hasSnap()))return!1;const n=h.pathnames(t.nativePath).indexOf("snap");return!(n<0)&&o.toA(yield e.snaps()).includes(h.pathnames[n+1])}))),e.hasSnap=s.lazy(()=>i(void 0,void 0,void 0,(function*(){try{return yield u.stdout("snap",["--version"],{timeout:10*r.secondMs}),!0}catch(t){return!1}}))),e.snaps=s.lazy(()=>i(void 0,void 0,void 0,(function*(){try{return yield l.parseFixed(["Name","Version"],yield u.stdout("snap",["list"],{timeout:10*r.secondMs})).map(t=>t.Name)}catch(t){return f.warn("snap failed",t),[]}})),30*r.secondMs)},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(108),s=n(0),o=n(7),a=n(16);e.readFilePart=function(t,e=0,n){return i(this,void 0,void 0,(function*(){let i=-1;try{const u=yield s.orElse(n,()=>o.thenMap(r.stat(t),t=>t.size-e)),l=Buffer.alloc(u);return i=yield r.open(t,"r"),yield r.read(i,l,0,u,e)}finally{yield a.mapGte0(i,r.close)}}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(19),s=n(161),o=n(38),a=n(22),u=n(54),l=n(7),c=n(241),d=n(73),h=n(15),f=n(13),p=n(3),m=n(79),g=n(21),v=n(225),y=n(11),b=n(97),w=n(10),S=n(60),M=n(235),P=n(92),x=n(2),E=n(5),_=n(39),O=n(45),T=n(47),F=n(0),k=n(6),A=n(70),I=n(8),D=n(64),C=n(98),L=n(128),R=n(300),N=n(301),j=n(115),B=n(159);e.start=Date.now(),e.StartupTimeoutMs=30*E.secondMs;e.Service=class{constructor(t){this.opts=t,this.errorRate=new m.Rate(2*E.minuteMs),this.exitted=!1,this._ready=new u.Latch,this.onFatalHandlers=[],this.inputHandlers=new Map,this.onError=(t,e,n)=>i(this,void 0,void 0,(function*(){if(!h.isIgnorableError(n))if(h.isFatalError(n)&&(t=!0),this.errorRate.onEvent(),a.ending()||this.exitted)this.logger.warn("onError(): We're already ending.",{fatal:t,context:e,error:n});else if(!t&&k.gt0(this.opts.maxErrorsPerMinute)&&this.errorRate.eventsPerMinute>this.opts.maxErrorsPerMinute&&(this.logger.error("Error rate is too high. Upgrading this error to fatal.",{context:e,error:n}),t=!0),this.logger.log(t?"error":"warn","propagating error",{context:e,error:n}),t){const t=e+F.mapOr(n,t=>": "+T.errorToS(t),()=>"");return this.exit(t,12)}})),j.setServiceName(this.name=this.opts.name),y.Settings.logDir.addListener(()=>this.setupLogger()),this.logger=p.mkSafeLogger("Service("+this.name+")"),this.addDefaultInputHandlers(),l.thenOrTimeout(this.setup(),e.StartupTimeoutMs,()=>this.exit("setup timed out",13))}setupLogger(){p.setLoggerProcessName(this.name)}get isDbService(){return v.DbServices.includes(this.name)}get isNoDbService(){return v.NoDbServices.includes(this.name)}get isMainService(){return this.name===v.ServiceNames.main}get isWelcomeService(){return v.WelcomeServices.includes(this.name)}get isDbRpcService(){return!this.isDbService&&!this.isNoDbService}get ready(){return this._ready.promise}on(t,e){this.onFatalHandlers.push(e)}setTitle(){const t=o.App.getName()+(this.name===v.ServiceNames.main?"":` ${this.name}`);g.Try(()=>r.title=t)}setup(){return i(this,void 0,void 0,(function*(){try{yield b.readSystemSettings(),this.setTitle(),x.mapNotBlank(d.getEnv("PS_FATAL_"+this.name),t=>{throw new h.WrappedError({fatal:!0,message:t})}),x.mapNotBlank(d.getEnv("PS_CRASH_"+this.name),t=>{_.later(()=>{throw new h.WrappedError({message:t})},5*E.secondMs)}),D.setDbRpc(this.isDbRpcService),this.logger.info("setup()",Object.assign({version:S.version,argv:r.argv,arch:r.arch,platform:r.platform,versions:r.versions,settings:{logLevel:y.Settings.logLevel.valueOrDefault,httpPort:y.Settings.httpPort.valueOrDefault,rpcPort:y.Settings.rpcPort.valueOrDefault,libraryPath:y.Settings.libraryPath.valueOrDefault}},y.psenv())),M.NiceWorkPlanner.instance(),yield this.setupStdin(),this.isDbRpcService?yield this.setupDbRpc():this.isDbService&&(yield A.thenOpt(L.Library.instance()).flatMap(t=>t.dbServer()),yield this.maybeWriteSystemSettings(),yield this.maybeWriteLibrarySettings(),this.logger.debug("wrote settings.")),yield this.setupErrorHandling(),this.logger.debug("set up error handling.");const t=this.exitted||a.ending();this.logger.debug("setup done.",{reject:t}),t?this._ready.reject():this._ready.resolve()}catch(t){return this._ready.reject(t),this.exit(w.ensureSuffix(this.name+" setup failed: "+t,h.FatalErrorFlag),14)}}))}maybeWriteSystemSettings(){return i(this,void 0,void 0,(function*(){(yield O.notEqlAsync(S.version,b.systemSettingsVersion()))&&(yield b.writeSystemSettings())}))}maybeWriteLibrarySettings(){return i(this,void 0,void 0,(function*(){y.Settings.libraryPath.hasValue()&&(yield O.notEqlAsync(S.version,b.librarySettingsVersion()))&&(yield b.writeLibrarySettings())}))}setupErrorHandling(){return i(this,void 0,void 0,(function*(){N.installSentry(this),r.on("unhandledRejection",t=>this.onError(!0,"unhandledRejection",t)),r.on("uncaughtException",t=>this.onError(!0,"uncaughtException",t)),f.onFatal((t,e)=>this.onError(!0,t,e)),f.onNonFatal((t,e)=>this.onError(!1,"on(nonfatal): "+t,e)),f.eventEmitter.on("error",t=>this.onError(!1,"on(error):",t)),r.on("SIGINT",()=>this.exit("SIGINT",0)),r.on("SIGTERM",()=>this.exit("SIGTERM",0)),r.on("disconnect",()=>this.exit("disconnect",0)),r.stdin.on("close",()=>this.exit("stdin.close",0)),r.stdin.on("error",t=>this.logger.warn("stdin.error: "+t)),r.stdin.on("disconnect",()=>this.exit("stdin.disconnect",0)),r.stdout.on("disconnect",()=>this.exit("stdout.disconnect",0)),r.stdout.on("error",t=>this.logger.warn("stdout.error: "+t)),r.stderr.on("disconnect",()=>this.exit("stderr.disconnect",0)),r.stderr.on("error",t=>this.logger.warn("stderr.error: "+t))}))}setupStdin(){s.createInterface({input:r.stdin}).on("line",t=>this.onLine(I.toS(t)))}setupDbRpc(){return i(this,void 0,void 0,(function*(){if(!this.isDbRpcService)return;const t=yield R.remoteLibraryPath();if(x.blank(t))throw new Error("Could not get libraryPath from remote");t!==y.Settings.libraryPath.value&&this.logger.error("Saved library path doesn't match db. Using remote.",{local:y.Settings.libraryPath.value,remote:t}),y.Settings.libraryPath.value=t}))}exit(t,e){return i(this,void 0,void 0,(function*(){if(!this.exitted){if(this.exitted=!0,this.logger.info("exit()",{status:e,reason:t,ending:a.ending()}),yield this.logger.flush(),0!==e){yield Promise.all(this.onFatalHandlers.map(e=>e(t)));const n={fatal:!0,exit:!0,status:e,pid:r.pid,ppid:r.ppid};n.error=t,g.Try(()=>B.stdoutWrite(n,!1))}return yield a.endEndables(),r.exit(e)}}))}setInputHandler(t,e){this.inputHandlers.set(t.trim().toLowerCase(),e)}addDefaultInputHandlers(){this.setInputHandler("--version",()=>i(this,void 0,void 0,(function*(){return B.stdoutWrite({version:S.version})}))),this.setInputHandler("--quit",()=>this.exit("--quit from stdin",0)),this.setInputHandler(c.ChildServiceExitCommand,()=>this.exit(c.ChildServiceExitCommand+" from stdin",0)),this.setInputHandler("--pause",()=>(P.pause(),B.stdoutWrite({paused:P.isPaused()}))),this.setInputHandler("--resume",()=>(P.resume(),B.stdoutWrite({paused:P.isPaused()}))),this.setInputHandler("--status",()=>i(this,void 0,void 0,(function*(){return B.stdoutWrite({healthChecks:yield C.healthChecks()})}))),this.setInputHandler("--boom",f.emitBoom)}onLine(t){return i(this,void 0,void 0,(function*(){if(this.logger.debug("onLine",t),t.trim().startsWith("--")){const e=t.split(" ",1)[0],n=this.inputHandlers.get(e);null==n?console.warn("unknown command "+t):yield n(t.substr(e.length).trim())}else try{yield F.map(this.opts.stdinReceiver,e=>e(t))}catch(e){this.logger.error("onLine(): failed to process",{line:t,error:e})}}))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(35),s=n(38);e.ServiceNames=r.strEnum("main","web","sync","sync-file","db"),e.NoDbServices=["main"],e.DbServices=["web","db"],e.RestartOnRpcChangeServices=["sync-file"],e.WelcomeServices=["main","web"],e.title=function(t){return s.App.getName()+" "+t},e.serviceShutdownTimeoutMs=function(t){switch(t){case"main":case"web":case"db":return i.minuteMs;case"sync":case"sync-file":default:return 30*i.secondMs}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(45),r=n(6);function s(t){return r.isNumber(t)?t:t.id}e.id2id=s,e.idEql=function(t,e){return null!=t&&null!=e&&(r.isNumber(t)?t===s(e):r.isNumber(e)?e===s(t):i.eql(t,e))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(4),r=n(50);e.sid=i.lazy(()=>r.Radix58.randomChars(12))},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(288),s=n(15),o=n(3),a=n(9),u=n(82),l=n(122),c=n(106),d=n(140),h=n(289),f=n(121),p=n(290);class m extends h.RpcServiceHandlers{constructor(t){super(),this.db=t,this.advisoryLocks=new r.AdvisoryLocks,this.logger=o.mkLogger("DbServiceHandlers"),this.txs=f.Transactions.for(t),this.drl=new d.DbRequestLocal(t),m._instance=this}static instance(){if(null==this._instance)throw new s.WrappedError({message:"no DbServiceHandler instance",fatal:!0});return this._instance}acquireAdvisoryLocks(t){return i(this,void 0,void 0,(function*(){return this.advisoryLocks.acquireAdvisoryLocks(t.names)}))}releaseAdvisoryLocks(t){return this.advisoryLocks.releaseAdvisoryLocks(t.locks)}truncate(){return this.txs.tx("truncate",()=>{p.truncateTables(this.db)})}tableInfo(t){return this.txs.tx("tableInfo",()=>this.db.pragma(`table_info(${t})`))}tagRoots(){return this.txs.tx("tagRoot",()=>c.Tag.roots())}tagFindOrCreate(t){return this.txs.tx("tagFindOrCreate",()=>c.Tag.findOrCreate(t))}assetAddTags(t){return this.txs.tx("assetAddTags",()=>u.Asset.addTags(t.assetId,t.tagPaths))}assetRemoveTags(t){return this.txs.tx("assetRemoveTags",()=>u.Asset.removeTags(t.assetId,t.tagPaths))}assetArchive(t){return this.txs.tx("assetArchive",()=>u.Asset.archive(t))}findByIds(t){return this.txs.tx("findByIds",()=>l.ModelOpsLocal.forTableName(t.tableName).findByIds(t.ids))}insert(t){return this.txs.tx("insert",()=>{return l.ModelOpsLocal.forTableName(t.tableName).insert(t.model)})}upsert(t){return this.txs.tx("upsert",()=>l.ModelOpsLocal.forTableName(t.tableName).upsert(t.models))}batch(t){if(this.logger.debug("batch()",{requests:t}),!Array.isArray(t))throw new Error("Missing batch.requests");return this.txs.tx("batch",()=>t.map(t=>{const e=t.method;if(!d.DbMethods.includes(e))throw new Error("unknown method "+e);try{return this.logger.tap({msg:"batch()."+t.method,result:a.maybeCall(this.drl,e,t),meta:{req:t}})}catch(e){throw this.logger.warn("batch() failed",{req:t,err:e}),e}}))}}e.DbServiceHandlers=m},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(12),s=n(41),o=n(182),a=n(16),u=n(102),l=n(37),c=n(4),d=n(0),h=n(70),f=n(8),p=n(105),m=c.lazy(()=>i(void 0,void 0,void 0,(function*(){return new Intl.DateTimeFormat(yield o.locale(),{month:"short"})}))),g=c.lazy(()=>i(void 0,void 0,void 0,(function*(){const t=yield m();return r.range(0,12,e=>t.format(new Date(2016,e)))})));function v(t){return 1e4-t}function y(t){return{name:f.toS(t),ordinal:v(t)}}function b(t){return i(this,void 0,void 0,(function*(){if(a.within(1,12,t))return d.map((yield g())[t-1],e=>({name:e,ordinal:w(t)}))}))}function w(t){return 13-t}function S(t){return i(this,void 0,void 0,(function*(){const e=[p.When];return h.thenOpt(s.getYear(t)).forEach(t=>e.push(y(t))).flatMap(()=>b(s.getMonth(t))).forEach(t=>e.push(t)).map(()=>e).get()}))}e.yearToOrdinal=v,e.yearTagRef=y,e.monthTagRef=b,e.monthToOrdinal=w,e.dateTag=S,e.dateTagFile=function(t,e=[]){return i(this,void 0,void 0,(function*(){return h.thenOpt(l.readTags(t)).flatMap(t=>u.bestCapturedAt([t.capturedAt,...e])).flatMap(t=>S(t.date)).get()}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(2),s=n(4),o=n(0),a=n(6),u=n(9),l=n(8),c=n(80),d=n(126),h=n(3),f=n(171);e.zeroesRe=/^[\s0]*$/;const p=s.lazy(()=>h.mkLogger("ExifUid"));function m(t){return null==t||a.isNumber(t)?0===t:null!=e.zeroesRe.exec(l.toS(t))}function g(t){return null!=t&&r.notBlank(t)&&!m(t)}function v(t,e){return l.toS(t).split(e).map(t=>a.mapIntOr(t,t=>l.toS(a.sigFigs(t,2)),()=>t)).join(e)}e.zeroish=m,e.compactZeroes=function(t){return u.mapFields(t,(t,e)=>m(e)?void 0:[t,e])},e.present=g,e.sigfigish=v,e.normalizeExposureSettings=function(t){if(null==t)return;const e={focalLength:o.map(t.focalLength,t=>l.toS(t).trim()),aperture:a.mapNumeric(t.aperture,t=>a.sigFigs(t,2)),shutterSpeed:o.map(t.shutterSpeed,t=>v(t,"/")),iso:a.mapInt(t.iso,t=>a.sigFigs(t,2))};return p().debug("normalizeExposureSettings("+l.toS(t.FileName)+")",e),u.reqValuedOrElse(e)},e.cameraId=function(t){return u.pickFirst(t,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"],t=>r.notBlank(t)&&!m(t))},e.lensId=function(t){return o.map(f.extractLensMakeModel(t),({lensMake:t,lensModel:e})=>`${t.toLowerCase()}/${e.toLowerCase()}`)},e.imageId=function(t){return u.pickFirst(t,i.compact(["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"]),g)},e.uidGeoHash=function(t,e){return d.geohash(a.toFixed(t,4),a.toFixed(e,4))},e.serializeUidPojo=function(t,e=28){return o.map(t,t=>c.shortStringSha(JSON.stringify(t),e)+":v"+t.version)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(7),s=n(18),o=n(5),a=n(295);e.sqliteFiles=function(t){return r.asyncFilter([t,...a.SqliteSuffixes.map(e=>t.sibling(t.base+e))],t=>t.exists())},e.isDbOpen=function(t,e=10*o.minuteMs){return i(this,void 0,void 0,(function*(){const n=n=>i(this,void 0,void 0,(function*(){return r.thenMapOr(t.sibling(t.base+n).clear().maxStatMs(),t=>s.isRecentMs(t,e),()=>!1)}));return(yield t.clear().isNonEmptyFile())&&((yield n("-wal"))||(yield n("-journal")))}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(296),s=n(22),o=n(18),a=n(29),u=n(95),l=n(3),c=n(11),d=n(4),h=n(28),f=n(168),p=n(297),m=n(167),g=l.mkLogger("DbSetup");function v(t){return t.pragma('encoding = "UTF-8"'),t.pragma("threads = 2"),t.pragma("foreign_keys = ON"),t.pragma("page_size = "+16*h.KiB),t.pragma("cache_size = -"+c.Settings.dbCacheSizeMb.valueOrDefault*h.MiB),t.pragma("locking_mode = NORMAL"),t.pragma("journal_mode = WAL"),t.pragma("synchronous = NORMAL"),t.pragma("case_sensitive_like = ON"),t.pragma("auto_vacuum = INCREMENTAL"),t}e.dbSetup=function(t,e){return i(this,void 0,void 0,(function*(){const n=f.pathToDb(t,e);if(null==(yield n.ensureFile()))throw new Error("Cannot create dbFile "+n);const l=new r(n.nativePath,{memory:!1,fileMustExist:!1,readonly:!1,timeout:2500});s.addDbEndable(new s.EndableWrapper("db("+n.baseWithGrandparent+")",()=>l.close())),v(l);const c=new p.Migration(a.BaseFile.for(u.ProjectPath.Migrations()).join(e),l),h=d.lazy(()=>i(this,void 0,void 0,(function*(){try{if(yield n.notExists())return;const t=yield n.parent().join("version-backup",o.filestamp()+"-"+n.base).ensureNew();yield m.backupDb(n,t)}catch(t){g.error("Failed to back up "+n,t)}})));return yield c.latest(h),l}))},e.setPragmas=v},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(36),s=n(22),o=n(21),a=n(39),u=n(0),l=["wal_checkpoint(PASSIVE)","incremental_vacuum","optimize"];e.SqliteJanitor=class{constructor(t,e){this.db=e,this.ended=!1,this.name="SqliteJanitor("+t+")",s.addFirstEndable(this)}setInterval(t){u.map(this.timer,t=>r.clearInterval(t)),this.timer=r.setInterval(()=>this.run(),t)}run(){return i(this,void 0,void 0,(function*(){for(const t of l)yield a.later(()=>this.db.transaction(()=>this.db.pragma(t))())}))}end(t=!1){this.ended||(this.ended=!0,o.Try(()=>this.db.exec("VACUUM")),t&&this.db.close()),u.map(this.timer,t=>r.clearInterval(t)),this.timer=void 0}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(121),r=n(78);class s extends r.TimestampedModel{static ping(t="ping"){return i.tx(this.db,t,()=>this.ops().upsertOne({name:"ping"}))}}e.Example=s,s.tableName="Example",s.uniqueColumnName="name",s.booleanFields=["isExample"]},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(36),s=n(1),o=n(5),a=n(39),u=n(4),l=n(0),c=n(6),d=n(89),h=n(118),f=n(12),p=n(22),m=n(154),g=n(13),v=n(3),y=n(57),b=n(79),w=n(25),S=n(11),M=n(279),P=n(92),x=n(280),E=u.lazy(()=>v.mkLogger("NiceWorkPlanner"));class _{constructor(t=S.Settings.maxCpuPercent.valueOrDefault,e=M.CpuUsage.instance(),n=500){this.maxCpuPercent=t,this.cpuUsage=e,this.workIntervalMs=n,this.name="NiceWorkPlanner",this.promiseTimer=new m.PromiseTimer,this.startWorkRate=new b.Rate(o.minuteMs),this.finishWorkRate=new b.Rate(o.minuteMs),this.idleEventListener=()=>this.onIdle(),this.availableCpuAvg=new y.Average,this.runningCountAvg=new y.Average,this.unstartedCountAvg=new y.Average,this.idleListeners=[],this.workCount=0,this.pendingWork=[],this._ended=!1,this.availableCpus=u.lazy(()=>c.mapFinite(this.cpuUsage.busyPct(),t=>c.mapFinite(this.cpuUsage.cpuCount,e=>this.availableCpuAvg.push(Math.ceil(e*c.clamp(0,1.5,(this.maxCpuPercent-t)/100))))),this.cpuUsage.checkIntervalMs/2),this.priorWorkCount=0,this.logState=h.throttle(()=>{this.priorWorkCount!==this.workCount&&(this.priorWorkCount=this.workCount,E().info("status",this.status))},(w.isTest?5:60)*o.secondMs),this.paused=S.Settings.startPaused.valueOrDefault,this._workInterval=r.setInterval(()=>this.maybeDoWork(),n),g.onIdle(this.idleEventListener),p.addServiceEndable(this)}static instance(){const t=P.getWorkPlanner();if(t instanceof _&&!t.ended)return t;const e=new _;return P.setWorkPlanner(e),e}isPaused(){return this.paused}pause(){E().info("pause()"),this.paused=!0}resume(){E().info("resume()"),this.paused=!1,this.maybeDoWorkLater()}end(){this._ended||(this._ended=!0,E().info("timings:",this.promiseTimer.report()),l.map(this._workInterval,r.clearInterval),g.eventEmitter.removeListener("idle",this.idleEventListener),this._workInterval=void 0,this.cpuUsage.end())}get ended(){return this._ended}work(t,e){this.workCount++;const n=new x.Work(t,e);return this.pendingWork.push(n),n.promise.then(()=>{this.finishWorkRate.onEvent(),this.maybeDoWorkLater()}),this.maybeDoWorkLater(),n.promise}addIdleListener(t){this.idleListeners.push(t),this.maybeDoWorkLater()}removeIdleListener(t){f.remove(this.idleListeners,t)}get runningCount(){return this.runningCountAvg.push(s.count(this.pendingWork,t=>t.running))}get unstartedCount(){return this.unstartedCountAvg.push(s.count(this.pendingWork,t=>!t.started))}get pausedOrShutdown(){return this.isPaused()||this._ended||p.ending()}get done(){return s.filterInPlace(this.pendingWork,t=>t.pending),s.isEmpty(this.pendingWork)}get status(){return{done:this.done,workRate:this.startWorkRate.eventsPerMinute,availProcs:this.availableCpus(),availProcsStats:this.availableCpuAvg.stats(),unstartedCount:this.unstartedCount,unstartedStats:this.unstartedCountAvg.stats(),runningCount:this.runningCount,runningStats:this.runningCountAvg.stats(),pendingWorkers:this.pendingWork.slice(0,25).map(t=>t.name)}}maybeDoWorkLater(){a.later(()=>this.maybeDoWork())}maybeDoWork(){this.pausedOrShutdown||(this.logState(),c.times(this.idleProcCount(),()=>{l.map(this.pendingWork.find(t=>!t.started),t=>{E().trace("Starting "+t.name),t.start()})}),this.onIdle())}idleProcCount(){return l.mapOr(this.availableCpus(),t=>Math.ceil(t-this.runningCount),()=>0)}onIdle(){return i(this,void 0,void 0,(function*(){const t=this.idleProcCount();for(let e=0;e<t;e++){if(this.pausedOrShutdown||this.idleProcCount()<1)return;l.map(d.pickWeightedRandom(this.idleListeners),t=>{this.workCount++,t.onIdle()}),yield a.delay(1)}}))}}e.NiceWorkPlanner=_},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(2),o=n(5),a=n(0),u=n(6),l=n(9),c=n(77),d=n(12),h=n(100),f=n(27),p=n(44),m=n(112),g=[c.PS_NETWORK_FILESYSTEM_PROTOCOL,"file:",c.PS_LOCAL_FILE_PROTOCOL,c.PS_LIBRARY_PROTOCOL],v=g.indexOf(c.PS_LIBRARY_PROTOCOL);function y(t){return a.map(t,t=>u.map2Numeric(t.width,t.height,(t,e)=>Math.ceil(Math.pow(t*e,.15))))}function b(t){return Math.round(t/(2*o.minuteMs))}function w(t){const e=y(t),n=h.toUrl(t.uri);if(null==n||s.blank(n.protocol)||s.blank(n.pathname)||null==t.mtime)return;const i=g.indexOf(n.protocol);if(null==i)return;const r=f.parsePosixPath(n.pathname),o=r.base.toLowerCase().includes("cover"),u=p.isBrowserExt(r.ext),l=a.orElse(f.countFromName(r.base),0);return{size:e,mtime:b(t.mtime),schemeIdx:i,isCover:o,count:l,isBrowserSupported:u,uri:t.uri}}e.dim2sort=y,e.mtime2sort=b,e.file2sortableAssetFile=function(t){return i(this,void 0,void 0,(function*(){return l.reqValuedOrElse(Object.assign({uri:yield t.uri(),mtime:yield t.thisOrSidecareMaxMtimeMs(),sha:yield t.sha()},yield m.dimensions(t)))}))},e.sortAssetFiles=function(t){const e=r.sortBy(r.compact(t.map(t=>a.map(w(t),e=>a.map(function(t){const e=l.values(t);return e.some(t=>null==t)?void 0:e}(e),n=>({f:t,crit:n,pojo:e}))))),({crit:t})=>t),n=e[e.length-1];if(null!=n)return n.pojo.schemeIdx!==v&&a.map(e.find(t=>t.f.sha===n.f.sha&&t.pojo.schemeIdx===v),t=>d.moveToEnd(e,t)),e.map(t=>t.f)},e.assetFileSortCriteriaPojo=w},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(89);e.primesPerBin=6,e.SeedCount=Math.pow(e.primesPerBin,6),e.prngSeed=function(){return i.randomInt(0,e.SeedCount)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(5),s=n(0),o=n(49),a=n(78);class u extends a.TimestampedModel{toSyncState(){return{volume:this.volume,uri:this.uri,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return s.orElse(i.mapNotBlank(this.dekJSON,()=>JSON.parse(this.dekJSON)),()=>[])}set dek(t){this.dekJSON=JSON.stringify(t)}afterUpsert(){u.recentProgressByVolume.set(this.volume,this)}static findByUri(t){return u.ops().findOne(this.query().where({uri:t}))}}e.Progress=u,u.recentProgressByVolume=new o.TTLMap(2*r.minuteMs),u.tableName="Progress",u.uniqueColumnName="uri"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(122),r=n(78);class s extends r.TimestampedModel{static ops(){return i.ModelOpsLocal.forModel(this)}static dbr(t,e){return t(this.dbLocal())}}e.StatsModel=s,s.schema="stats"},function(t,e){t.exports=require("source-map-support")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(19),s=n(36),o=n(1),a=n(2),u=n(5),l=n(4),c=n(0),d=n(9),h=n(33),f=n(20),p=n(38),m=n(22),g=n(7),v=n(53),y=n(59),b=n(15),w=n(29),S=n(3),M=n(11),P=n(10),x=n(17),E=n(158),_=n(163);e.ChildServiceExitCommand="--exit";const O=l.lazy(()=>S.mkLogger("ChildService"));function T(t){return i(this,void 0,void 0,(function*(){const e=P.ensureSuffix(t,".js"),n=yield g.firstTruePromise(t=>t.isNonEmpty(101),()=>w.BaseFile.projectRoot().join("app",e),()=>w.BaseFile.projectRoot().join("app.asar",e),()=>w.BaseFile.for(r.cwd()).join("dist","library",e),()=>w.BaseFile.for(r.cwd()).join("dist","app",e),()=>w.BaseFile.for(r.cwd()).join("dist","js","library",e));return O().info("pathToService()",{cmdBase:t,result:n}),n}))}e.pathToService=T;let F=0;function k(t){switch(t){case"main":return 9222;case"web":case"db":return 9223;case"sync":return 9224;case"sync-file":return 9225+F++%20}}function A(t){const e=[];return M.Settings.inspect.valueOrDefault&&e.push("--inspect="+k(t)),e}e.inspectPort=k,e.nodeArgs=A;class I{constructor(t,n,r){this.name=t,this.cmd=n,this.opts=r,this.healthCheck=v.serially("ChildService.healthCheck",()=>i(this,void 0,void 0,(function*(){if(m.ending()||this.ended)return;if(h.isFunction(this.opts.healthy)){if(!1===(yield this.opts.healthy()))return b.onError("healthCheck for "+this.name+": !healthy(), restarting."),this.restart()}const t=Date.now();(yield this.write("--status"))||this.logger.warn("Failed to write?"),yield g.until(()=>null!=this.lastStatus&&this.lastStatus.ts>=t,20*u.secondMs);const e=this.lastStatus;if(null==e||e.ts<t)return b.onError("healthCheck for "+this.name+": no response from --status, restarting."),this.restart();const n=e.healthChecks;return this.logger.debug("healthCheck(): ",n),E.hasBad(n)||E.hasFail(n)?(b.onError("healthCheck for "+this.name+": unhealthy, restarting."),this.restart()):void this.logger.debug("healthCheck: all is well",n)}))),this.logger=S.mkLogger("ChildDaemon("+t+")");const a=[...f.toA(r.nodeArgs),n.nativePath];o.isNotEmpty(r.args)&&a.push(...r.args);const l=d.pick(this.opts,"argv0","cwd","detached","env","gid","shell","stdio","timeout","uid","windowsHide","windowsVerbatimArguments");this.wc=new _.WatchedChild(Object.assign({name:t,childFactory:()=>x.spawn(p.App.getPath("exe"),a,-1,l),endableRank:m.EndableRanks.service,onStdout:this.onStdout.bind(this),onError:c.orElse(this.opts.onError,()=>()=>!0),ignoreStopErrors:!1,exitCommand:e.ChildServiceExitCommand},r)),this.healthCheckTimer=y.setUnrefInterval(()=>this.healthCheck(),30*u.secondMs),m.addFirstEndable(new m.EndableWrapper("ChildService.healthCheckTimer",()=>s.clearInterval(this.healthCheckTimer)))}static mk(t,e={}){return i(this,void 0,void 0,(function*(){const n=c.orElse(e.pathToService,yield T(t));if(a.blank(n))throw new Error("Failed to find path to "+t);return M.Settings.inspect.valueOrDefault&&(e.nodeArgs=[...A(t),...f.toA(e.nodeArgs)]),new I(t,n,e)}))}get startMs(){return this.wc.startMs}get lastStatus(){return this._lastStatus}onStdout(t){return i(this,void 0,void 0,(function*(){if(!a.blank(t))try{const e=JSON.parse(t);a.notBlank(e.fatal)?this.wc.onError("onStdout()",e.error):a.notBlank(e.healthChecks)?this._lastStatus=Object.assign(Object.assign({},e),{ts:Date.now()}):null!=this.opts.onData&&this.opts.onData(e)}catch(e){console.log(t)}}))}start(){return this.wc.start()}stop(){return this.wc.stop()}restart(){return this.wc.restart()}get ended(){return this.wc.ended}end(){return i(this,void 0,void 0,(function*(){return this.wc.ended||(yield this.write("--quit")),this.wc.end()}))}get pid(){return this.wc.pid}get msSinceLastStart(){return this.wc.msSinceLastStart}running(){return this.wc.running()}notRunning(){return this.wc.notRunning()}write(t,e=2){return i(this,void 0,void 0,(function*(){if(e<0)return this.logger.warn("write(): no more retries",{toStdin:t}),!1;try{const e=this.wc.proc;return null!=e&&null!=e.stdin&&e.stdin.writable?e.stdin.write(P.ensureSuffix(t,"\n")):(this.logger.warn("write(): childProc isn't open, ignoring",{toStdin:t}),!1)}catch(n){return this.logger.warn("write(): caught "+n),yield this.wc.onError("onStdout()",n),this.write(t,e-1)}}))}}e.ChildService=I},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0),r=n(8),s=n(12),o=n(16);e.extractBitrateKbps=function(t){return s.first(["AvgBitrate","MaxDataRate"],e=>(function(t){return i.map(o.extractFloat(t),e=>{const n=r.toS(t).toLowerCase();return i.map(s.first(a,t=>n.includes(t.pat)?t.fac:void 0),t=>e*t)})})(t[e]))};const a=[{pat:"mb/s",fac:1024},{pat:"mbps",fac:1024},{pat:"kb/s",fac:1},{pat:"kbps",fac:1}]},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(244),s=n(5),o=n(52),a=n(13),u=n(223),l=new o.BoundedMap(7*s.minuteMs,2048,!1);a.onClearCache(()=>l.clear()),a.onFileChanged(t=>null==t?l.clear():l.delete(t)),e.readFileType=function(t){return i(this,void 0,void 0,(function*(){return l.getOrSet(t,()=>i(this,void 0,void 0,(function*(){const{buffer:e}=yield u.readFilePart(t,0,248);return r(e)})))}))}},function(t,e){t.exports=require("file-type")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0),r=n(119);class s{static lift(t){return new class extends s{apply(e){return t(e)}}}and(t){return s.lift(e=>this.apply(e)&&t.apply(e))}or(t){return s.lift(e=>this.apply(e)||t.apply(e))}filter(t){return t.filter(t=>this.apply(t))}asAsync(){return r.AsyncFilter.lift(t=>Promise.resolve(this.apply(t)))}}e.Filter=s,e.definedFilter=s.lift(i.defined),e.trueFilter=s.lift(()=>!0)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(9),s=n(3),o=n(16),a=s.mkLogger("ExposureSettings");e.extractExposureSettings=function(t){const e={focalLength:t.FocalLength,iso:o.firstNonZero(t.ISO,t.ISOSpeed,t.SonyISO),aperture:o.firstNonZero(t.FNumber,t.Fnumber,t.ApertureValue,t.SonyFNumber),shutterSpeed:i.firstNotBlank(t.ExposureTime,t.ShutterSpeed,t.SonyExposureTime)};return a.debug("extracted from "+t.FileName,{exposureSettings:e}),r.reqValuedOrElse(e)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(87),s=n(86),o=n(2),a=n(6),u=n(14),l=n(3).mkLogger("JsonSidecar");function c(t,e,n){for(const i of e)if(t&&t[i]&&a.isNumber(t[i][n]))return t[i][n]}e.readJsonSidecar=function(t){return i(this,void 0,void 0,(function*(){const e=yield t.readJSON(),n=null==e?void 0:{DateTimeOriginal:u.Opt(e.photoTakenTime).flatMap(t=>t.timestamp).flatMap(a.toInt).filter(a.gt0).flatMap(t=>r.ExifDateTime.fromDateTime(s.DateTime.fromMillis(1e3*t))).get(),GPSLatitude:c(e,["geoDataExif","geoData"],"latitude"),GPSLongitude:c(e,["geoDataExif","geoData"],"longitude"),GPSAltitude:c(e,["geoDataExif","geoData"],"altitude"),Title:o.ifNotBlank(e.title),Description:o.ifNotBlank(e.description)};return null!=n&&l.debug("read "+t,n),n}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(65),s=n(2),o=n(5),a=n(39),u=n(0),l=n(8),c=n(49),d=n(22),h=n(7),f=n(53),p=n(154),m=n(15),g=n(13),v=n(88),y=n(63),b=n(3),w=n(79),S=n(25),M=n(181),P=n(249),x=o.minuteMs,E=2,_=5*o.secondMs,O={requestTTL:x,retriesPerRequest:5,delayBetweenRetries:S.isTest?100:_,maxPendingRequests:10,ee:g.eventEmitter};let T=0;e.Client=class{constructor(t,e,n={}){this.streamFactory=e,this._ended=!1,this.mkStreamRate=new w.Rate(o.minuteMs),this.times=new p.PromiseTimer,this.mkStream=f.oneRunAtATime(this.name+".mkStream",()=>i(this,void 0,void 0,(function*(){const t=this.needNewStream();if(this.logger.info("mkStream()",{needNewStream:t}),t){this.mkStreamRate.onEvent(),this.logger.info("Making new stream...");try{const t=yield this.streamFactory();if(null==t)throw new Error("streamFactory() returned null");this.logger.info("Opened stream"),t.on("end",t=>this.onFinish("on(end)",t)),t.on("close",t=>this.onFinish("on(close)",t)),t.on("error",t=>this.onError("stream error",t)),v.onDataChunked(t,"\n",t=>this.onData(t)),this._stream=t}catch(t){return this._stream=void 0,this.onError("streamFactory rejection",t)}}}))),this.name="rpc.Client("+t+"#"+T+++")",this.logger=b.mkLogger(this.name),this.opts=Object.assign(Object.assign({},O),n),this.pending=new c.TTLMap(3*this.opts.requestTTL),d.addServiceEndable(this)}get ended(){return this._ended}get eventEmitter(){return this.opts.ee}end(){return this.logger.info("end()",{ending:d.ending(),timings:this.times.report(),pendingSize:this.pending.size}),this._ended=!0,this.pending.clear(),this.close()}ping(){return this.request("ping")}ready(t=E){return i(this,void 0,void 0,(function*(){if(this.ended)return this.logger.debug("ready(): false (ended)"),!1;const e=[...this.pending.values()],n=e.filter(t=>t.pending).length,i=e.filter(t=>t.rejected).length;return n>this.opts.maxPendingRequests||i>=t?(this.logger.warn("Client is not ready",{pendingReqCnt:n,recentErrCnt:i}),!1):null!=(yield this.stream())}))}request(t,e){return i(this,void 0,void 0,(function*(){if(this.ended)throw new m.WrappedError({message:"client is ending",fatal:d.ending()});return r.retryOnReject(()=>this.submit(t,e),{maxRetries:this.opts.retriesPerRequest,onRetryWaitUntil:t=>a.delay(this.opts.delayBetweenRetries*t).then(()=>h.until(()=>this.ready(),this.opts.requestTTL)),errorIsRetriable:t=>l.toS(t).includes("(retry)")})}))}submit(t,e){return i(this,void 0,void 0,(function*(){if(this.ended){if(d.ending())return;throw new Error("client is ending")}if(s.blank(t))throw new Error("method cannot be blank");const n=yield this.stream();if(null==n)throw this.logger.error("Stream is closed, cannot submit",{ended:this.ended,method:t,params:e}),new Error("closed stream");const i=M.uid(),r=new P.RequestResponse(i,t,e,this.times);return r.setTimeout(this.opts.requestTTL),this.pending.set(i,r),this.logger.debug("sending request",{id:i,method:t,params:e}),n.write(JSON.stringify({id:i,method:t,params:e})+"\n"),r.response}))}close(){this.logger.info("close()",{ended:this.ended});const t=this._stream;return this._stream=void 0,y.end(t)}onData(t){if(!s.blank(t))try{const e=JSON.parse(t);if(s.blank(e.sid))throw new Error("response is missing server id");if(this.sid!==e.sid&&(null!=this.sid&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:e.sid}),this.eventEmitter.emit("rpcServerChange")),this.sid=e.sid,d.ending()))return;if(null==e.id){if(s.notBlank(e.event))return this.logger.info("re-broadcasting event",e),void this.eventEmitter.emit(e.event,...u.orElse(e.args,[]));throw new Error("missing request id from response")}const n=this.pending.pop(e.id);null==n?this.logger.warn("unknown or stale request ID",{resp:e,pendingIds:[...this.pending.keys()]}):e.error?(n.reject(e.error.message||e.error),this.logger.warn("Rejected",{resp:e,rr:n})):(n.resolve(e.result),this.logger.debug("Resolved",e.result))}catch(e){this.logger.warn("invalid input: "+t,e)}}onError(t,e){return i(this,void 0,void 0,(function*(){this.logger.warn(t+" onError(): "+u.map(e,t=>t.stack||t)),yield this.close(),this.ended||!1!==(yield this.restart())||this.logger.warn("Too many recent errors, we'll try reconnecting again in a bit")}))}restart(){return i(this,void 0,void 0,(function*(){if(this.logger.info("restart()",{ended:this.ended}),this.ended)return!1;if(this.mkStreamRate.msSinceLastEvent<5*o.secondMs||this.mkStreamRate.eventsPerMinute>10)return this.logger.warn("restart(): rate too high. Vetoing...",this.mkStreamRate),!1;if(this.close(),null!=(yield this.stream())){const t=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+t.length+" jobs now:"),t.forEach(t=>t.reject("restarting (retry)")),t.forEach(t=>t.d.promise.catch(()=>{})),!0}return this.logger.warn("restart(): no new stream."),!1}))}needNewStream(){return!this.ended&&null==this._stream}stream(){return i(this,void 0,void 0,(function*(){return this.needNewStream()&&(yield this.mkStream()),this._stream}))}onFinish(t,e){if(!this.ended)return this.logger.info("onFinish",{source:t,error:e}),null==e||!1===e?this.restart():this.onError(t,e)}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(34),r=n(0),s=n(42);e.RequestResponse=class{constructor(t,e,n,i){this.id=t,this.method=e,this.params=n,this.timer=i;const r="rpc.RequestResponse("+e+")#"+t;this.d=new s.Deferred(r)}[i.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(t){this.d.setTimeout(t)}resolve(t){this.d.pending&&(this.d.resolve(t),r.map(this.d.settledMs,t=>this.timer.push(this.method,t)))}reject(t){this.d.reject(t)}get rejected(){return this.d.rejected}get response(){return this.d.promise}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(104),r=n(35),s=n(3),o=n(11),a=n(56),u=n(4);e.SharpFits=r.strEnum("cover","contain","fill","inside","outside"),function(t){t.name=i.ReducerNames.sq,t.fit="cover",t.reduce=function(t,e){const n=e.width!==e.height;if(a.ltBoth(t,e))return n?Object.assign(Object.assign({},t),{fit:"cover",position:o.Settings.squareThumbStrategy.valueOrDefault}):t}}(e.Square||(e.Square={})),function(t){const e=u.lazy(()=>s.mkLogger("Reducers.Fit"));t.name=i.ReducerNames.fit,t.fit="inside",t.reduce=function(t,n){if(a.ltBoth(n,t))return void e().debug("reduce(): input is too small for max",{input:n,max:t});const i=n.width/n.height;return i>=t.width/t.height?{width:t.width,height:Math.ceil(t.width/i)}:{width:Math.ceil(t.height*i),height:t.height}}}(e.Fit||(e.Fit={}))},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(7);e.emitSafely=function(t,e,n,o=1e3){return i(this,void 0,void 0,(function*(){const i=yield s.until(()=>r.isNotEmpty(t.listeners(e)),o);return i&&t.emit(e,n),i}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(93),s=n(5),o=n(4),a=n(14),u=n(7),l=n(52),c=n(15),d=n(13),h=n(32),f=n(179),p=n(3),m=n(11),g=n(37),v=n(137),y=n(156),b=n(101),w=o.lazy(()=>p.mkLogger("ValidFile")),S=new l.BoundedMap(10*s.minuteMs,1024,!0);function M(t){return i(this,void 0,void 0,(function*(){if(m.Settings.validateJpegImages.valueOrDefault||m.Settings.validateVideos.valueOrDefault)return f.getOrSetByNativePath(t,P,S);w().debug("no validation for "+t,{validateJpegImages:m.Settings.validateJpegImages.valueOrDefault,validateVideos:m.Settings.validateVideos.valueOrDefault})}))}function P(t){return i(this,void 0,void 0,(function*(){const e=h.PosixFile.for(t);try{const t=yield g.mimetype(e);if(null==t)throw new Error("Cannot validate, no mimetype");if(t.startsWith("video/"))m.Settings.validateVideos.valueOrDefault&&(w().debug("validating "+e),yield b.validVideo(e));else{if(!t.startsWith("image/"))throw new Error("Unsupported mimetype, "+t);if("image/jpeg"===t){if(m.Settings.validateJpegImages.valueOrDefault)return yield v.validJpeg(e)}else if(m.Settings.validateRawImages.valueOrDefault){const t=yield y.sharpReadable(e);if(null==t)throw new Error("Cannot read");yield r(t.nativePath,{failOnError:!0}).tiff().toBuffer()}}}catch(t){throw new c.WrappedError({cause:t,message:"invalid file "+e,retriable:!1,ignorable:!0})}}))}d.onClearCache(()=>S.clear()),d.onFileChanged(t=>a.Opt(t).forEach(t=>{S.delete(t)}).orElse(()=>{S.clear()})),e.isValidFile=function(t){return i(this,void 0,void 0,(function*(){return u.resolved(M(t))}))},e.validFile=M},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(0),s=n(6),o=n(12),a=n(16),u=n(48);function l(t){return"number"==typeof t&&t<e.b64charset.length?e.b64charset[t]:Buffer.from(t.toString(16),"hex").toString("base64")}function c(t){return BigInt("0x0"+Buffer.from(t,"base64").toString("hex"))}function d(t){if(null==t||0===t.length)return-1;const n=t.split("");let i=0;for(const r of n){const n=e.b64charset.indexOf(r);if(-1===n)return-1;if(i>Math.pow(2,46))throw new Error("b64decodeSmall("+t+"): overflow");i=64*i+n}return i}function h(t,e=6){const n=e/6;return o.stepRange(0,t.length,n,e=>d(t.substr(e,n)))}e.hex2b64=function(t){return Buffer.from(t,"hex").toString("base64")},e.b64charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e.b64encode=l,e.b64decode=c,e.b64hammRatio=function(t,e){return i.mapNotBlank(t,t=>i.mapNotBlank(e,e=>a.hammRatioBigInt(c(t),c(e))))},e.b64decodeSmall=d,e.uint8toB64=function(t){return Buffer.from(Uint8ClampedArray.from(t).buffer).toString("base64")},e.uint6toB64=function(t){return t.map(t=>e.b64charset[63&t]).join("")},e.uint12toB64=function(t){const e=[];return t.forEach(t=>{e.push(l(t>>6&63)),e.push(l(63&t))}),e.join("")},e.b64corr=function(t,e,n=6){if(t===e)return 1;const i=h(t,n),r=h(e,n),s=Math.pow(2,n-1);return u.cosineSimilarity(i.map(t=>t-s),r.map(t=>t-s))},e.b64diff=function(t,e,n=6){return t===e?0:o.zip(h(t,n),h(e,n)).reduce((t,e)=>r.orElse(s.absdiff(e[0],e[1]),0)+t,0)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.SquareMatrix=class{constructor(t,e){if(this.m=t,this.rows=e,t.length!==e*e)throw new Error("Only square matrices are supported ("+e+"x"+e+"!="+t.length+")")}transpose(){for(let t=0;t<this.rows;t++)for(let e=t+1;e<this.rows;e++){const n=e+t*this.rows,i=t+e*this.rows;[this.m[i],this.m[n]]=[this.m[n],this.m[i]]}return this}reverseRows(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.rows/2;e++){const n=e+t*this.rows,i=this.rows-1-e+t*this.rows;[this.m[i],this.m[n]]=[this.m[n],this.m[i]]}return this}reverseCols(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.rows/2;e++){const n=t+e*this.rows,i=t+(this.rows-1-e)*this.rows;[this.m[i],this.m[n]]=[this.m[n],this.m[i]]}return this}rotate(t){switch(t){case 0:case 360:break;case 90:case-270:this.transpose(),this.reverseRows();break;case 180:case-180:this.m.reverse();break;case 270:case-90:this.transpose(),this.reverseCols();break;default:throw new Error("unsupported rotate("+t+")")}return this}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(6),r=n(127),s=n(175),o=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],a=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];function u(t){const e=t.map(t=>t/255).map(t=>t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92);return s.matXvec(o,e)}e.rgb2lab=function(t){return h(u(t.map(t=>i.clamp(0,255,t))))},e.lab2rgb=function(t){return p(f(t)).map(t=>i.clamp(0,255,t))},e.rgb2xyz=u;const l={X:.95047,Y:1,Z:1.08883},c=216/24389,d=24389/27;function h(t){const[e,n,i]=s.vecXvec(t,[1/l.X,1/l.Y,1/l.Z]).map(t=>t>c?Math.pow(t,1/3):(d*t+16)/116);return[116*n-16,500*(e-n),200*(n-i)]}function f(t){const[e,n,i]=t,r=(e+16)/116,s=n/500+r,o=r-i/200,a=s*s*s,u=o*o*o,h=a>c?a:(116*s-16)/d,f=e>8?Math.pow(r,3):e/d,p=u>c?u:(116*o-16)/d;return[h*l.X,f*l.Y,p*l.Z]}function p(t){return s.matXvec(a,t).map(t=>{const e=t<0?-1:1,n=t*e;return i.round(255*e*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055))})}e.xyz2lab=h,e.lab2xyz=f,e.xyz2rgb=p,e.labhash=function(t,e){return r.bitZip({dims:[{value:t[0],min:0,max:100},{value:t[1],min:-100,max:100},{value:t[2],min:-110,max:100}],bitDepth:e})},e.unlabhash=function(t,e){return r.bitUnzip(t,{dims:[{min:0,max:100},{min:-100,max:100},{min:-110,max:100}],bitDepth:e})}},function(t,e){t.exports=require("knex")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(3),r=n(2),s=n(9),o=n(124),a=n(84),u=i.mkLogger("mkUpsertSql");e.mkUpsertSql=function(t,e,n){if("id"===e&&null==n[e]){const e=a.toSqlQuery(o.knex(t).insert(n));return u.info("no ucn, using simple insert",e),e}if("id"!==e&&null==n[e])throw new Error("Invalid "+t+": missing UCN "+e);const i=s.keys(s.without(n,e,"id","createdAt")).map(t=>t+"=$"+t).join(","),l=s.keys(n),c=l.map(t=>"$"+t),d=["INSERT INTO `",t,"`(",l.join(","),") VALUES (",c.join(","),`) ON CONFLICT(${e}) DO `];return r.blank(i)?d.push("NOTHING "):d.push(`UPDATE SET ${i} WHERE ${e} = $${e}`),{sql:d.join(""),bindings:n}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(7),s=n(1),o=n(4),a=n(46),u=n(0),l=n(6),c=n(20),d=n(62),h=n(129),f=n(84),p=n(259);e.batchedUnion=function(t,e){return i(this,void 0,void 0,(function*(){const n=new h.DbRequestRemote,s=new m(t.model,n),o=[],a=e.map(t=>i(this,void 0,void 0,(function*(){return r.thenMap(t(s),t=>o.push(...c.toA(t)))})));return yield n.submit(),yield Promise.all(a),o}))};class m{constructor(t,e){this.model=t,this._dbr=e,this.columnNames=o.lazy(()=>r.thenMap(d.dbClient().request("tableInfo",this.tableName),t=>t.map(t=>t.name)))}static forModel(t){const e=t;return a.getOrSet(this.instances,e.tableName,()=>new m(e))}get tableName(){return this.model.tableName}toModel(t){return r.thenMap(t,t=>this.model.fromJSON(t))}toModels(t){return t.then(t=>c.toA(t).map(t=>this.model.fromJSON(t)))}first(t,e){return h.dbr(e=>this.toModel(e.first(t)),u.orElse(e,this._dbr))}all(t,e){return h.dbr(e=>this.toModels(e.all(f.maybeLimit(t))),u.orElse(e,this._dbr))}findOne(t,e){return h.dbr(e=>this.toModel(e.first(t)),u.orElse(e,this._dbr))}findById(t,e){return this.findOne(this.model.query().where({id:t}),u.orElse(e,this._dbr))}findByIds(t){return this.toModels(d.dbClient().request("findByIds",{tableName:this.tableName,ids:t}))}findOneBy(t,e){return this.first(this.model.queryBy(t),u.orElse(e,this._dbr))}findBy(t,e){return this.all(this.model.queryBy(t),u.orElse(e,this._dbr))}rows(t){return this.count(this.model.query(),u.orElse(t,this._dbr))}count(t,e){return h.dbr(e=>e.pluckFirst(t),u.orElse(e,this._dbr))}insert(t){return this.toModel(d.dbClient().request("insert",{tableName:this.tableName,model:this.model.toDbJSON(t)}))}upsertOne(t){return this.upsert([t]).then(t=>t[0])}get ucn(){return this.model.uniqueColumnName}upsert(t){return i(this,void 0,void 0,(function*(){const e=yield this.columnNames();return this.toModels(d.dbClient().request("upsert",{tableName:this.tableName,models:t.map(t=>this.model.toDbJSON(t,e))}))}))}delete(t,e){return s.mapNotEmpty(t.filter(l.gt0),t=>h.dbr(e=>e.run(this.model.query().delete().whereIn("id",t)),e))}}e.ModelOpsRemote=m,m.instances=new Map,m.fetchTableInfo=o.lazy(()=>p.remoteTableInfo().then(t=>m.tableInfo=t))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(72),r=n(129);function s(t){const e=new i.MultiMap;return t.forEach(t=>e.add(t.tableName,{name:t.columnName,type:t.columnType})),e.entriesArray().map(([t,e])=>({tableName:t,columns:e}))}e.parseTableInfo=s;const o="SELECT \nm.tbl_name as tableName,\np.name AS columnName,\np.type AS columnType,\nFROM sqlite_master AS m\nLEFT JOIN pragma_table_info(m.name) AS p\nORDER BY m.tbl_name, p.cid";e.localTableInfo=function(t){return s(t.prepare(o).all())},e.remoteTableInfo=function(){return r.dbr(t=>t.all(o)).then(s)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(5),r=n(4),s=n(6),o=n(237),a=n(12),u=n(71),l=n(261);function c(t){return a.zip(e.primeLists(),l.digits(t,o.primesPerBin,6).reverse()).map(([t,e])=>t[e])}e.prngOrderByClause=function(t,n,i){const[r,s,o,a,u]=e.primes(t),l=`(${n}%${a})`;return`ROUND(${`(${r}*${l}*${l}+${s}*${l})`}*${`(${o}*${l}+${a})`}+${`${u}+${n}`})${i?"%"+i:""}`},e.prng=function(t,n,i){const[r,s,o,a,u]=e.primes(t),l=n%a,c=(r*l*l+s*l)*(o*l+a)+u+n;return Math.round(c)%i},e.primeLists=r.lazy(()=>[[21683,39301,45853,57427,58991,65543],[262139,314569,366997,419429,471871,524309],[1048573,1258291,1468079,1677811,1887539,2097257],[10392467,22222223,32457869,42638597,58947631,68956417,84619573],[353868013,472882027,573259391,694847533,756065159,899809343],[2147483647,3743895347,4295032837,5949670231,6607882123,8753196421]]),e.primeSeeds=c,e.primes=u.memoize(t=>{const[e,n,i,r,a,u]=c(t%o.SeedCount);return[...[i/e,r/n,a/i,u/r].map(t=>s.sigFigs(t,5)),i]},1*i.minuteMs,256)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.digits=function(t,e,n){const i=[];for(;t>0;){const n=t%e;i.push(n),t=Math.floor(t/e)}for(;null!=n&&i.length<n;)i.push(0);return i.reverse()}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(0),r=n(77);e.TagUrls=class{constructor(t){this.id=t}nextAssetBatch(t){const e={};return i.map(t,t=>e.capturedAtLt=t.getTime()),r.joinQuery(`/tag-gallery/${this.id}`,e)}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(26),s=n(18),o=n(15),a=n(3),u=n(2),l=n(62),c=n(64),d=n(228),h=a.mkLogger("withAdvisoryLock()");function f(t,e){return i(this,void 0,void 0,(function*(){const n=yield p(t,e);if(null==n)throw new o.WrappedError({message:"Failed to get advisory lock for "+t,retriable:!0});return n.result}))}function p(t,e){return i(this,void 0,void 0,(function*(){const{result:n,elapsedMs:a}=yield s.elapsedAsync(()=>{const e={names:t};return c.dbRpc()?l.dbClient().request("acquireAdvisoryLocks",e):d.DbServiceHandlers.instance().acquireAdvisoryLocks(e)});if(u.blank(n))return void h.error("failed to get advisory lock, giving up",{lockNames:t,acquireMs:a});h.info("acquired",{lockNames:t,locks:n});const f=()=>i(this,void 0,void 0,(function*(){const t={locks:n},e=yield s.elapsedAsync(()=>i(this,void 0,void 0,(function*(){return c.dbRpc()?l.dbClient().request("releaseAdvisoryLocks",t):d.DbServiceHandlers.instance().releaseAdvisoryLocks(t)})));return r.truthy(e.result)?h.info("released",{locks:n,released:e}):(h.error("failed to release",{locks:n,released:e}),o.onError("statsWithAdvisoryLock(): failed to release")),e}));try{const{result:t,elapsedMs:i}=yield s.elapsedAsync(()=>e(n)),{result:r,elapsedMs:o}=yield f();return{result:t,acquireMs:a,locks:n,runMs:i,releaseMs:o,released:r}}catch(t){throw yield f(),t}}))}e.RpcAdvisoryLockProvider={withAdvisoryLocks:f},e.withAdvisoryLocks=f,e.statsWithAdvisoryLocks=p},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(100),r=n(27),s=n(32),o=n(11),a=n(10),u=n(2),l=n(4),c=n(14),d=n(77);e.installLibraryUriSupport=l.lazy(()=>{i.addUriParser(p),i.addUriFormatter(f)});const h=l.lazy(()=>c.Opt(o.Settings.libraryPath.value).filter(u.notBlank).map(t=>s.PosixFile.for(t)));function f(t){const e=s.PosixFile.for(r.posix2native(t.posixPath));return h().filter(t=>e.isDescendantOf(t)).map(e=>({pathname:encodeURI(s.PosixFile.for(t.posixPath).posixPathFrom(e)),protocol:d.PS_LIBRARY_PROTOCOL,slashes:!0})).get()}function p(t){return c.Opt("").filter(()=>a.equalsIgnoreCase(t.protocol,d.PS_LIBRARY_PROTOCOL)).flatMap(()=>h()).map(e=>u.blank(t.pathname)?e:e.join(decodeURIComponent(t.pathname))).get()}o.Settings.libraryPath.addListener(()=>h.clear()),e.uriFromLibraryPath=f,e.posixPathFromUri=p},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(82),r=n(90),s=n(130),o=n(234),a=n(183),u=n(122),l=n(238),c=n(106);e.modelJsonSetup=function(){[i.Asset,r.AssetFile,s.AssetTag,o.Example,l.Progress,c.Tag].forEach(t=>{a.addModelClass(t),u.ModelOpsLocal.forModel(t)})}},function(t,e){t.exports=require("@sentry/node")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(34),s=n(38),o=n(7),a=n(80),u=n(32),l=n(101),c=n(3),d=n(50),h=n(120),f=n(11),p=n(1),m=n(4),g=n(0),v=m.lazy(()=>c.mkLogger("CacheDir"));function y(){return o.thenMapOr(u.PosixFile.for(s.App.getPath("userData")).children(),t=>t.filter(t=>t.name.startsWith(e.CacheDirPrefix)),()=>[])}function b(){return i(this,void 0,void 0,(function*(){const t=[f.Settings.libraryPath,...f.persistedLibrarySettings()].map(t=>[t.key,t.valueOrDefault]);t.push(["ASSET_FILE_VERSION",h.AssetFileVersion]),t.push(["ASSET_VERSION",h.AssetVersion]),t.push(["TRANSCODE",yield l.isVideoTranscodingSupported()]);const n=p.sortBy(t,([t])=>t),i=a.shortStringSha(JSON.stringify(n),9,d.GeoRadix),o=(yield u.PosixFile.for(s.App.getPath("userData")).mkNoMedia()).join(e.CacheDirPrefix+i);return yield o.join("README.txt").applyIfEmpty(t=>t.writeTxt(`\nThis folder is a library synchronization cache for\n\n${f.Settings.libraryPath.value}\n\nIf you delete or modify the contents of this directory, you will need to\nrestart PhotoStructure, and the next sync will need to rescan all your drives.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSettings used by this cache: \n\n`+r.inspect(n,{colors:!1,breakLength:80}))),v().info("Set up cache dir"+o),o}))}function w(t){return i(this,void 0,void 0,(function*(){const n=g.orElse(t,yield b());if(!n.name.startsWith(e.CacheDirPrefix))throw new Error("Refusing to remove directory "+n);yield n.remove()}))}e.cacheDirs=y,e.CacheDirPrefix="ps-cache-",e.cacheDir=b,e.clearCacheDir=w,e.vacuumCacheDirs=function(){return i(this,void 0,void 0,(function*(){const t=yield b();for(const e of yield y())e.eql(t)||(yield w(e))}))},e.clearCacheDirs=function(){return i(this,void 0,void 0,(function*(){for(const t of yield y())yield w(t)}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(43),s=n(19),o=n(36),a=n(22),u=n(3),l=n(74),c=n(5),d=n(4).lazy(()=>u.mkLogger("OpenedBy"));function h(t){return t.join("opened-by.json")}e.OpenedByTimeout=10*c.minuteMs,e.readOpenedBy=function(t){return i(this,void 0,void 0,(function*(){const n=h(t),i=yield n.readJSON();if(null!=i)return i.hostname===r.hostname()?(yield l.pidExists(i.pid))?(d().warn("library is still running locally",i),i):(d().warn("Cleaning up opened-by file (pid doesn't exist)",i),void(yield n.unlink())):i.lastTouchedMs<Date.now()-e.OpenedByTimeout?(d().warn("Cleaning up expired opened-by file"),void(yield n.unlink())):i}))};class f extends a.EndableWrapper{constructor(t){super("opened-by writer",()=>this.onEnd()),this.libraryDataDir=t,this.file=h(t),this.timer=o.setInterval(()=>this.write(),.5*e.OpenedByTimeout),a.addLoggerEndable(this)}write(){return this.file.writeJSON({hostname:r.hostname(),pid:s.pid,lastTouchedISO:(new Date).toISOString(),lastTouchedMs:Date.now()},{spaces:2})}onEnd(){return clearInterval(this.timer),this.file.unlink()}}e.OpenedByWriter=f},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(7),s=n(5),o=n(4),a=n(0),u=n(89);let l=0;e.rpcAllowed=function(t,e){return i(this,void 0,void 0,(function*(){return r.until(()=>0===l,a.orElse(t,()=>u.randomInt(5*s.secondMs,15*s.secondMs)),a.orElse(e,()=>u.randomInt(250,1e3)))}))},e.pauseRpc=function(t=s.secondMs){l++;const e=o.lazy(()=>l--);return setTimeout(e,t),e}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(116),s=n(13),o=n(41),a=n(3),u=n(11),l=n(37),c=n(1),d=n(0);function h(t){return t.toDateTime().toFormat(u.Settings.assetSubdirectoryDatestampFormat.valueOrDefault).split(/[\\/]/)}e.directoryForDate=h;e.AssetFileRepository=class{constructor(t,e){this.root=t,this.copyAssets=e,this.logger=a.mkLogger("AssetFileRepository")}directoryForDate(t){return this.root.join(...h(t))}importFile(t){return i(this,void 0,void 0,(function*(){if(!this.copyAssets())return t;if(yield t.isDescendantOf(this.root))return this.logger.debug("no-op: "+t+" already contained by "+this.root),t;this.logger.debug("importing "+t);const e=yield l.readTags(t);if(null==e)throw new Error(t.nativePath+" has no tags (so, no createdAt)");const n=d.map(e.capturedAt,t=>o.toFuzzyDate(t.date));if(null==n)throw new Error(t.nativePath+" has no capturedAt");if(null==n.year||null==n.month||null==n.day)throw new Error(t.nativePath+" capturedAt has insufficient precision: "+e.capturedAt);const i=this.directoryForDate(n);if(null==(yield i.mkdirp()))throw new Error("Cannot create destination directory, "+i.nativePath+" for "+t.nativePath);const s=yield i.children(),a=yield t.size(),u=yield r.filter(s,t=>t.size().then(t=>t===a)),c=yield t.sha();if(u.length>0){const e=yield r.filter(u,t=>t.sha().then(t=>t===c));if(e.length>0){const n=e[0];return this.logger.info(t+" matches "+n),this.handleSidecars(t,n)}}const h=yield i.join(t.base).ensureNew();this.logger.info("Copying...",{src:t.nativePath,dest:h.nativePath});const f=yield t.copyFile(h);return this.handleSidecars(t,f)}))}handleSidecars(t,e){return i(this,void 0,void 0,(function*(){const n=d.orElse(yield t.sidecars(),[]);for(const t of n)yield this.handleSidecar(t,e);return c.isNotEmpty(n)&&s.emitFileChanged(e.nativePath),e}))}handleSidecar(t,e){return i(this,void 0,void 0,(function*(){for(const n of d.orElse(yield e.sidecars(),[]))if(yield l.sidecarEql(t,n))return void this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:t,destSidecar:n,dest:e});const n=yield e.parent().join(e.name+t.ext).ensureNew({emptyIsNew:!0});return t.copyFile(n)}))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(19),s=n(158),o=n(15),a=n(13),u=n(29),l=n(95),c=n(41),d=n(3),h=n(11),f=n(76),p=n(1),m=n(2),g=n(5),v=n(47),y=n(4),b=n(89),w=n(20),S=n(28),M=n(64),P=n(98),x=n(128),E=d.mkLogger("LibraryHealthChecks");function _(t){return i(this,void 0,void 0,(function*(){const e=w.toA(yield u.BaseFile.for(l.ProjectPath.Public()).join("images").children()).find(t=>t.name.startsWith("splash"));if(null==e)return E.throw("copyExampleImageToLibraryDir(): missing validation image");const n=t.join(".tmp-"+b.randomChars(6),"test.jpg");try{if(yield e.copyFile(n),(yield e.sha())!==(yield n.sha()))return E.throw("Failed to copy sample file to library. Is "+t+" writable?");E.debug(`Library root directory, ${t}, is writable`)}finally{yield n.unlink(),yield n.parent().unlink()}}))}h.Settings.libraryPath.addListener(()=>{e.libraryHealthChecks.clear()}),a.onVolumesChanged(()=>e.libraryHealthChecks.refresh()),a.onNonFatal(()=>e.libraryHealthChecks.refresh()),e.libraryHealthChecks=y.lazy((function(){return i(this,void 0,void 0,(function*(){if(M.dbRpc())return{};const t=x.Library.instance();if(null==t)return h.Settings.libraryPath.hasValue()?{fail:["Missing library"]}:{};const e=[],i=[],a=[],u=yield f.volumes().catch(t=>(a.push("Cannot get volume information: "+v.errorToS(t)),[]));yield _(t.rootDir).catch(e=>a.push("Cannot write to "+t.rootDir+": "+e));for(const e of yield t.requiredFiles())try{const t=yield e.file();if(null==t)continue;if(t.clear(),e.isDir&&!(yield t.isDirectory()))a.push(`${e.desc}, ${t}, is missing`+o.FatalErrorFlag);else if(p.isNotEmpty(u)){const n=f.bestVolume(u,t.nativePath);E.debug("checkDir()",{dir:t.nativePath,desc:e.desc,bestVolume:n,vols:u.map(t=>t.mountpoint)}),null==n?a.push(`${e.desc}, ${t}, doesn't seem to have a mountpoint (?!)`):n.available<h.Settings.minDiskFreeGb.valueOrDefault*S.GB&&i.push(`Only ${S.fmtBytes(n.available)} are available on ${n.mountpoint}.`)}}catch(t){a.push("Failed to check "+e.desc+": "+t)}p.isEmpty(a)&&p.isEmpty(i)&&e.push("Library and support directories are OK"),m.notBlank(r.env.TEST_FAIL)&&a.unshift(...r.env.TEST_FAIL.split(",")),m.notBlank(r.env.TEST_WARN)&&i.unshift(...r.env.TEST_WARN.split(","));try{yield t.modelDb();const i=yield n(234).Example.ping();if(!c.nowish(i.updatedAt))throw new Error("Stale upsert in Model DB");e.push("Model DB is OK")}catch(t){E.error("Failed to validate DB",t),a.push("Failed to validate DB: "+v.errorToS(t))}return a.map(t=>o.onError(t)),s.concatHealthChecks({ok:e,warn:i,fail:a},P.syncSettingsCheck())}))}),g.minuteMs),e.copyExampleImageToLibraryDir=_},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(43),r=n(5),s=n(4),o=n(12);e.OS=s.lazy(()=>[i.platform(),i.release(),"on",i.arch()].join(" ")),e.CPUs=s.lazy(()=>o.uniqCount(i.cpus().map(t=>t.model)).map(t=>`${t.count} × ${t.t}`).join(", "),r.minuteMs)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(25),r=n(11),s=n(4);e.sentryEnabled=s.lazy(()=>i.isProd&&r.Settings.reportErrors.valueOrDefault),r.Settings.reportErrors.addListener(()=>e.sentryEnabled.clear())},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(160),s=n(275),o=n(276),a=n(19),u=n(7),l=n(26),c=n(29),d=n(74),h=n(11),f=n(97),p=n(60),m=n(1),g=n(2),v=n(6),y=n(115),b=[{name:"version",type:Boolean,description:"Display the current version."},{name:"pidfile",alias:"p",type:String,description:"The absolute path to write the running process PID file."},{name:"daemon",alias:"d",type:Boolean,description:"Daemonize the process. Enabled by default when --pidfile is provided."},{name:"verbose",alias:"v",type:Boolean,description:'Set LOG_LEVEL to "info".'},{name:"help",alias:"h",type:Boolean,description:"Display this usage guide."},{name:"stop",type:Boolean,description:"Shuts down PhotoStructure. Requires --pidfile."}];function w(){return console.log([o([{header:"PhotoStructure™",content:"Welcome to your new home for all your photos and videos!\n\nVisit <https://support.photostructure.com/> for usage and configuration instructions."},{header:"Options",optionList:b}]),"Version "+p.version+" built on "+p.gitDate.toUTCString(),"Copyright © 2019, PhotoStructure Inc. <https://photostructure.com/eula.html>",""].join("\n")),a.exit(0)}e.handleArgv=function(){return i(this,void 0,void 0,(function*(){const t=s(b,{stopAtFirstUnknown:!1,partial:!0});if(t.version)return console.log(p.version),a.exit(0);if(t.help)return w();if(y.isMainService()&&m.isNotEmpty(t._unknown))return console.error("Unknown arguments: ",t._unknown),w();g.mapNotBlank(t.pidfile,t=>h.Settings.pidfile.value=t);const e=l.truthy(a.env.__is_daemon),n=!e&&(t.daemon||h.Settings.pidfile.hasValue());if((t.verbose||t.debug)&&(h.Settings.logColor.value=!0,h.Settings.logStdout.value=!e,h.Settings.logLevel.value=t.debug?"debug":"info"),t.stop){if(!h.Settings.pidfile.hasValue()&&(yield f.readSystemSettings(),!h.Settings.pidfile.hasValue()))return console.error("--stop requires --pidfile to be set."),a.exit(1);const t=c.BaseFile.for(h.Settings.pidfile.value);if(yield t.notExists())return console.error("Pidfile "+t+" does not exist."),a.exit(1);const e=v.toInt(yield u.thenMap(t.readFile(),t=>t.toString()));return v.gt0(e)?(yield d.pidNotExists(e))?(console.error("Pid "+e+" does not exist."),a.exit(1)):(console.log("Shutting down "+e),yield d.kill(e),a.exit(0)):(console.error("Pidfile "+t+" is invalid."),a.exit(1))}if(n){const t=a.argv.findIndex(t=>!t.includes("npx")&&!t.includes("node")),e=a.argv.slice(-1===t?0:t),n=process.execPath,i=Object.assign(Object.assign({},h.childEnv()),{__is_daemon:"1"}),s=r.spawn(n,e,{env:i,detached:!0,shell:!1,stdio:["ignore","ignore","ignore"]});return s.unref(),console.log("Daemonized PhotoStructure.",{pid:s.pid,cmd:n,args:e}),a.exit(0)}}))}},function(t,e){t.exports=require("command-line-args")},function(t,e){t.exports=require("command-line-usage")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(278),r=n(11);e.PermissiveWorkPlanner=class{constructor(){this.pausedUntil=0,this.queue=[],this.paused=r.Settings.startPaused.valueOrDefault}isPaused(){return this.paused||Date.now()<this.pausedUntil}pause(t){null==t?this.paused=!0:this.pausedUntil=Math.max(Date.now()+t,this.pausedUntil)}resume(){this.paused=!1,this.pausedUntil=0,this.queue.forEach(t=>t()),this.queue.length=0}work(t,e){if(this.isPaused()){const{promise:t,later:n}=i.laterPromise(e);return this.queue.push(n),t}return e()}addIdleListener(){}removeIdleListener(){}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(26);!function(t){t.and=function(...t){return i(this,void 0,void 0,(function*(){for(const e of t)if(!r.truthy(yield e()))return!1;return!0}))},t.or=function(...t){return i(this,void 0,void 0,(function*(){for(const e of t)if(r.truthy(yield e()))return!0;return!1}))}}(e.Later||(e.Later={})),e.laterPromise=function(t){let e,n;return{promise:new Promise((t,i)=>{e=t,n=i}),later:()=>i(this,void 0,void 0,(function*(){try{const n=yield t();return e(n),n}catch(t){throw n(t),t}}))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(43),r=n(36),s=n(4),o=n(0),a=n(6),u=n(22),l=n(3),c=n(57),d=n(25);e.AlwaysIdle={idlePct:()=>100,cpuCount:3,busyPct:()=>0,end:()=>void 0};const h=s.lazy(()=>l.mkLogger("CpuUsage"));e.DefaultCheckIntervalMs=1e3;class f{constructor(t=e.DefaultCheckIntervalMs,n=2){this.checkIntervalMs=t,this.sampleCount=n,this._ended=!1,this.busyPctAvg=new c.Average(n),this.timer=r.setInterval(()=>this.sample(),t),this.sample(),u.addFirstEndable(new u.EndableWrapper("CpuUsage("+t+")",()=>r.clearInterval(this.timer)))}get cpuCount(){return o.map(this.last,t=>t.busyTimes.length)}end(){this._ended||(this._ended=!0,r.clearInterval(this.timer))}idlePct(){return o.map(this.busyPct(),t=>100-t)}busyPct(){return a.mapFinite(this.busyPctAvg.weightedAvg,a.round)}sample(){const t=this.last;if(null!=t&&Date.now()-t.at<this.checkIntervalMs/2)return;const e=new m;null!=t&&t.cpuCount===e.cpuCount?a.mapFinite(e.busyPct(t),t=>{this.last=e,this.busyPctAvg.push(t)}):this.last=e}}function p(t){const e=t.times;return e.user+e.nice+e.sys+e.irq}e.CpuUsage=f,f.instance=s.lazy(()=>d.isTest?e.AlwaysIdle:new f);class m{constructor(t=i.cpus()){this.at=Date.now(),this.busyTimes=t.map(p),this.idleTimes=t.map(t=>t.times.idle)}get cpuCount(){return this.busyTimes.length}busyPct(t){if(t.at>this.at)return t.busyPct(this);{let e=0,n=0;for(let i=0;i<this.cpuCount;i++)e+=this.busyTimes[i]-t.busyTimes[i],n+=this.idleTimes[i]-t.idleTimes[i];const i=e+n,r=a.round(100*e/i),s=isFinite(r)&&r>=0&&r<=100;return s||h().warn("busyPct(): invalid result",{result:r,busyMs:e,idleMs:n}),s?r:void 0}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(42);e.Work=class{constructor(t,e){this.name=t,this.f=e,this._started=!1,this.d=new i.Deferred("Work("+t+")")}get started(){return this._started}get running(){return this.d.pending&&this._started}get settled(){return this.d.settled}get pending(){return this.d.pending}get promise(){return this.d.promise}start(){if(!this._started){this._started=!0;const t=this.f();this.d.observe(t)}return this.d}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(4),s=n(7),o=n(21);e.JsonFileStore=class{constructor(t,e,n=o.identity,i=o.identity){this.file=t,this.onCreate=e,this.onRead=n,this.onWrite=i,this.prior=r.lazy(()=>s.thenAnd(this.file.exists(),()=>this.file.readJSON()))}read(){return i(this,void 0,void 0,(function*(){const t=yield this.prior();return null!=t?this.onRead(t):s.thenMap(this.onCreate(),t=>this.write(t))}))}write(t){return i(this,void 0,void 0,(function*(){return yield this.file.writeJSON(yield this.onWrite(t),{spaces:2}),this.prior.set(Promise.resolve(t)),t}))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(226),s=n(5),o=n(6),a=n(49),u=n(283),l=n(286);e.Previews=class{constructor(t,e){this.root=t,this.alp=e,this.id2ap=new a.TTLMap(2*s.minuteMs)}build(t){return i(this,void 0,void 0,(function*(){return this.apb(t.assetId,t.assetFiles).build(t)}))}apb(t,e){return new u.AssetPreviewBuilder(this.ap(t),e)}ap(t){const e=this.id2ap.get(r.id2id(t));if(null!=e&&r.idEql(t,e.assetId))return e;{const e=new l.AssetPreviews(this.root,t,this.alp);return o.isNumber(t)?e:(this.id2ap.set(r.id2id(t),e),e)}}clearAssetId(t){this.id2ap.delete(t)}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(93),s=n(34),o=n(1),a=n(0),u=n(9),l=n(26),c=n(15),d=n(32),h=n(94),f=n(3),p=n(236),m=n(56),g=n(284),v=n(155),y=n(285),b=n(156),w=n(252);e.AssetPreviewBuilder=class{constructor(t,e){this.ap=t,this.assetFiles=e,this.logger=f.mkLogger("AssetPreviewBuilder("+t.assetId+")")}[s.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build(t){return i(this,void 0,void 0,(function*(){const e=yield p.sortAssetFiles(yield this.assetFiles);for(;o.isNotEmpty(e);){const n=e.pop();try{return yield this._build(n,t)}catch(t){this.logger.warn("Failed to set shown file to "+n,t)}}return this.logger.error("no files built.",e),this.logger.throw("no valid files are available")}))}_build(t,e){return i(this,void 0,void 0,(function*(){if(null==t)return this.logger.throw("_build(): best was undefined");const n=yield d.PosixFile.forUri(t.uri);if(null==n)return this.logger.throw("_build: failed to create PosixFile",{best:t});l.truthy(e.validate)&&(yield w.validFile(n));const i=yield n.size(),s=yield n.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:i,mtime:s,best:t}),null==i||null==s)return this.logger.throw("IE build(): missing stat info for best file "+t);if(null==t.width||null==t.height||null==t.mimetype||null==t.sha)return this.logger.throw("IE build(): missing fields for best file "+n,t);const o=g.fitSizes(t,t.rotation,t.mimetype),f=Object.assign(Object.assign({assetFileId:t.id},u.pick(t,"assetId","uri","width","height","mimetype","sha","rotation")),{path:n.nativePath,mtime:s,filesize:i,fitSizes:o.map(([,t])=>t.name).join(",")});if(!l.truthy(e.force)){const e=yield this.ap.readInfo.refresh();if(null!=e){if(e.assetId!==f.assetId)throw new Error("IE build(): Mismatched asset IDs for "+t+": "+JSON.stringify({priorInfo:e,info:f}));if(null!=e.sha&&e.sha===f.sha&&e.rotation===f.rotation&&g.equivalentFitSizes(e.fitSizes.split(","),f.fitSizes.split(",")))return this.logger.debug("build(): no-op: SHA and rotation match.",{info:f,priorInfo:e}),yield this.ap.writeInfo(f),f}}const p=new h.PushProgressObserver({path:n.nativePath,op:"Building previews..."},v.ImageSize.sq().length+v.ImageSize.fit().length);if(this.logger.debug("Rebuilding all previews from "+t.uri,{assetId:t.assetId,best:t,info:f}),null==(yield this.ap.parent.mkdirp()))throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+t);const S=yield this.ap.existingFiles(),M=yield b.sharpReadable(n,v.ImageSize.largestFit().max);if(null==M)throw new c.WrappedError({message:"build(): "+t+" is not readable by sharp.",retriable:!1});const P=r(M.nativePath);null!=t.rotation&&0!==t.rotation&&(P.rotate(t.rotation),this.logger.debug("build(): rotating "+t.rotation+"°")),M.name.toLowerCase().includes("thumbnail")&&P.trim();const x=[];let E,_;const O=u.pick(t,"width","height");{let t=P.clone(),e=O;for(const[n,i]of o){const r=Date.now(),s=e,o=this.ap.fileForWidth(i.reducer.name,n.width).wip();if(t=yield y.applyAndClone(i.resize(n,t)),e=n,null==_){null!=v.ImageSize.largestSq().outputSize(n)?(_=t.clone(),E=n):(_=P,E=O)}yield i.toJpeg({path:o.nativePath,sh:t.clone(),outputSize:n}),p.onProgress(),this.logger.debug("resize("+i.name+") "+m.dimToS(s)+" -> "+m.dimToS(n)+" in "+(Date.now()-r)+" ms"),x.push(o)}}null==_&&(_=P,E=O);for(const t of v.ImageSize.sq()){const e=Date.now(),n=E,i=t.outputSize(a.orElse(E,O));if(null==i)continue;const r=this.ap.fileForWidth(t.reducer.name,i.width).wip();_=yield y.applyAndClone(t.resize(i,_)),E=i,yield t.toJpeg({path:r.nativePath,sh:_.clone(),outputSize:i}),p.onProgress(),x.push(r),this.logger.debug("resize("+t.name+") "+m.dimToS(n)+" -> "+m.dimToS(i)+" in "+(Date.now()-e)+" ms")}return yield Promise.all(S.map(t=>t.unlink())),yield Promise.all(x.map(t=>t.unwip())),yield this.ap.writeInfo(f),f}))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(6),s=n(3),o=n(56),a=n(155),u=s.mkLogger("FitSizes");function l(t){return"qhd"===t?"wvga":"uhd"===t?"uhd4k":t}e.fitSizes=function(t,e,n){const i=a.ImageSize.fit();u.debug("fitSizes()",{dim:t,rotation:e,sizes:i});const s=i.map(e=>[e.outputSize(t),e]).filter(([t])=>null!=t);let l=t;return s.filter(([t],i)=>(function(t,i){const s=o.dmegapixels(l)/o.dmegapixels(t),a=0===i&&("image/jpeg"!==n||r.gt0(e))||s>3||o.dmegapixels(t)-o.dmegapixels(l)>2.5;return a&&(l=t),a})(t,i))},e.equivalentFitSizes=function(t,e){return i.includesAll(i.compactBlanks(t).map(l),i.compactBlanks(e).map(l))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(93),s=n(9);e.applyAndClone=function(t){return i(this,void 0,void 0,(function*(){const e=yield t.raw().toBuffer({resolveWithObject:!0});return r(e.data,{raw:s.pick(e.info,"width","height","channels")})}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(226),s=n(1),o=n(166),a=n(104),u=n(4),l=n(0),c=n(6),d=n(136),h=n(12),f=n(7),p=n(3),m=n(16),g=n(10),v=n(37),y=n(56),b=n(112),w=n(137);e.AssetPreviews=class{constructor(t,e,n){this.previewsRoot=t,this.alp=n,this.readInfo=u.lazy(()=>this.infoJson().readJSON()),this.logger=p.mkLogger("AssetPreviews(assetId:"+r.id2id(e)+")"),this.assetId=r.id2id(e),this.urls=new o.AssetUrls(e);const i=g.leftPad(this.assetId,8,"0"),s=g.splitEvery(i,3);this.basename=s.pop()+"-",this.parent=t.join(...s)}existingFiles(){return f.thenOrElse(this.parent.childFiles(t=>t.base.startsWith(this.basename)),()=>[])}existingJpgs(){return f.thenOrElse(this.parent.childFiles(t=>t.base.startsWith(this.basename)&&".jpg"===t.ext),()=>[])}deleteAll(){return i(this,void 0,void 0,(function*(){this.parent.clear();const t=yield this.existingFiles();if(t.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return yield Promise.all(t.map(t=>t.unlink())),t}))}file(t){return this.parent.join(this.basename+t)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(t){return this.readInfo.clear(),this.infoJson().writeJSON(t,{spaces:2})}fileForWidth(t,e){return this.file(t+"-w"+e+".jpg")}filesForReducer(t){const e=this.basename+t+"-";return this.existingFiles().then(t=>t.filter(t=>t.base.startsWith(e)))}largestFileForReducer(t){return i(this,void 0,void 0,(function*(){const e=yield this.filesForReducer(t);return h.greatestBy(e,t=>l.orElse(l.map(M(this.previewsRoot,t),t=>t.width),0))}))}widths(t){return i(this,void 0,void 0,(function*(){const e=yield this.filesForReducer(t);return s.sort(s.compact(e.map(t=>l.map(M(this.previewsRoot,t),t=>t.width))))}))}posterLink(){return i(this,void 0,void 0,(function*(){const t=yield this.widths(a.ReducerNames.fit);return this.urls.imgLink(a.ReducerNames.fit,Math.max(...t))}))}imgAttrs(t,e=!1,n=!0){return i(this,void 0,void 0,(function*(){if(e||t!==a.ReducerNames.sq){const e=t===a.ReducerNames.fit?yield this.readInfo():void 0;return this.urls.imgAttrs(t,yield this.widths(t),n,e)}return this.urls.sqImgAttrs(n)}))}setRotation(t){return i(this,void 0,void 0,(function*(){return this.alp.withAdvisoryLocks(["assetId:"+this.assetId],()=>i(this,void 0,void 0,(function*(){const e=l.orElse(d.normalizeRotation(t),0),n=[],i=yield this.readInfo();if(null==i)throw new Error("IE: Missing JSON info for assetId:"+this.assetId);try{const r=l.orElse(i.rotation,0),s=d.normalizeRotation(e-r);if(0===s)return void this.logger.debug("setRotation(): no-op",{priorRotation:r,newRotation:e});const o=yield this.existingJpgs();for(const t of o){const e=M(this.previewsRoot,t),i=yield b.dimensions(t);if(null==e||null==e.reducer||null==i)this.logger.warn("setRotation(): bad thumb "+t,{pi:e,dims:i});else{const r=y.maybeFlip(i,s),o=this.fileForWidth(e.reducer,r.width).wip();yield w.rotate(t,o,s),n.push(o)}}const a=this.mp4();if(yield a.exists()){const e=a.wip();n.push(e),yield a.copyFile(e),yield v.writeTags(e,{Rotation:t})}return yield Promise.all(o.map(t=>t.unlink())),yield Promise.all(n.map(t=>t.unwip())),this.parent.clearThisAndParent(),i.rotation=e,y.maybeFlipInPlace(i,s),yield this.writeInfo(i),i}catch(t){throw yield Promise.all(n.map(t=>t.unlink())),t}})))}))}};const S=p.mkLogger("extractPreviewInfo");function M(t,e){const n=e.posixPathFrom(t).replace(/\//g,"").split("-"),i=c.toInt(n[0]),r=n[1],s=a.isReducerName(r)?r:void 0,o=m.extractInt(n[2]);return c.gt0(i)?{file:e,assetId:i,reducer:s,width:o}:void S.warn("Failed to extract preview info",{file:e,previewsRoot:t,arr:n,assetId:i,reducer:s,width:o})}e.extractPreviewInfo=M},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(180),s=n(19),o=n(2),a=n(5),u=n(4),l=n(0),c=n(9),d=n(118),h=n(8),f=n(12),p=n(22),m=n(54),g=n(7),v=n(154),y=n(59),b=n(18),w=n(15),S=n(13),M=n(88),P=n(63),x=n(75),E=n(3),_=n(11),O=n(227),T=n(269),F=E.mkLogger("rpc.Server");function k(){return"pong from PID "+s.pid+" at "+new Date}!function(t){t.broadcast=function(t,...e){return i(this,void 0,void 0,(function*(){return F.warn("broadcast sent to no-op",{event:t,args:e}),!1}))}}(e.NoOpBroadcaster||(e.NoOpBroadcaster={}));e.Server=class{constructor(t,e,n=!0){this.port=t,this.unref=n,this._ended=!1,this._ready=new m.Latch,this.openSockets=[],this.times=new v.PromiseTimer,this.onPause=()=>this.broadcast("pause"),this.onResume=()=>this.broadcast("resume"),this.handlers={},this.start=d.throttle(()=>i(this,void 0,void 0,(function*(){if(!this.ended)return F.debug("start("+this.port+")"),this.server=r.createServer(this.onConnect.bind(this)),this.server.on("listening",()=>{this._ready.resolve()}),this.server.on("error",t=>i(this,void 0,void 0,(function*(){yield this.onError("createServer",t),y.setUnrefTimeout(()=>this.start(),5e3)}))),this.server.listen(this.port,_.Settings.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise})),5e3),this.end=u.lazy(()=>i(this,void 0,void 0,(function*(){this._ended=!0,S.eventEmitter.removeListener("pause",this.onPause),S.eventEmitter.removeListener("resume",this.onResume),yield this.closeAllConnections(),yield P.close(this.server),F.info("timings:",this.times.report())}))),this.name="Server:"+t,this.addHandlers(e),this.addHandler("ping",k),S.onPause(this.onPause),S.onResume(this.onResume),p.addFirstEndable(this),this.start()}serialize(t){return i(this,void 0,void 0,(function*(){return JSON.stringify(Object.assign({sid:O.sid()},t))+"\n"}))}addHandlers(t){const e=new Set(c.allKeys(new Object));c.allKeys(t).filter(n=>!e.has(n)&&"function"==typeof t[n]).forEach(e=>this.addHandler(e,t[e].bind(t)))}addHandler(t,e){null!=this.handlers[t]&&F.warn("addHandler(): overwriting",{name:t,priorHandler:this.handlers[t],newHandler:e}),this.handlers[t]=e}get ended(){return this._ended||p.ending()}get ready(){return this._ready.promise}closeAllConnections(){const t=this.openSockets.map(P.end);return this.openSockets.length=0,Promise.all(t)}broadcast(t,...e){return this.sendAll({event:t,args:e})}sendAll(t,e="write"){return i(this,void 0,void 0,(function*(){const n=yield this.serialize(t),i=[...this.openSockets];let r=i.length;return i.forEach(t=>t[e](n,()=>r--)),g.until(()=>r<=0,1e3)}))}onConnect(t){F.info("Connection from "+P.remoteDesc(t)),this.unref&&t.unref(),this.openSockets.push(t),t.on("end",()=>{F.info("Closing connection from "+P.remoteDesc(t)),f.remove(this.openSockets,t)}),t.on("error",e=>i(this,void 0,void 0,(function*(){F.warn("on error from "+P.remoteDesc(t)+": "+e),yield this.onError("socket",e),t.end()})));try{M.onDataChunked(t,"\n",e=>this.onRequest(e,t))}catch(e){F.warn("Caught error from "+P.remoteDesc(t)+": "+e),t.end()}}onRequest(t,e){return i(this,void 0,void 0,(function*(){if(F.debug("onRequest()",t),o.blank(t))return;let n="missing",i="missing";try{const r=JSON.parse(t);return o.mapNotBlank(r.id,t=>n=t),o.mapNotBlank(r.method,t=>i=t),yield T.rpcAllowed(),yield this.times.time(i,()=>this.handle(n,i,r.params,e))}catch(i){F.warn("invalid request",{line:t,error:i}),e.write(yield this.serialize({id:n,error:l.orElse(i.message,()=>h.toS(i))}))}}))}handle(t,e,n,r){return i(this,void 0,void 0,(function*(){F.debug("handle() called",{method:e,params:n});const i=this.handlers[e];if(null==i)throw F.warn("bad handler request",{method:e,params:n,supported:c.keys(this.handlers)}),new Error("No handler for "+e);const{elapsedMs:s,result:o}=yield b.elapsedAsync(()=>null==n?i():i(n));F.log(x.ms2level(s,a.secondMs),"handle()",{method:e,elapsedMs:s,id:t,params:n,result:o}),r.write(yield this.serialize({id:t,result:o}))}))}onError(t,e){return i(this,void 0,void 0,(function*(){this.ended||w.onError(t,e)}))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(181),s=n(1),o=n(5),a=n(14),u=n(20),l=n(49),c=n(15),d=n(123),h=n(3),f=n(54),p=n(7);class m{constructor(t){this.id=t,this.released=new f.Latch}}e.AdvisoryLockRequest=m;class g{constructor(t){this.name=t,this.locks=[],this.logger=h.mkLogger("AdvisoryLock("+this.name+")")}get idle(){return 0===this.locks.length}acquire(){const t=r.uid(0),e=new m(t),n=[...this.locks];return this.locks.push(e),n.length>0&&this.logger.info("Waiting for "+n.length+" prior locks to complete..."),p.awaitAll(n.map(t=>t.released.promise)).then(()=>(this.logger.debug("acquired for "+t),t))}release(t){const e=this.locks.find(e=>e.id===t);if(null==e)return this.logger.error("release(): unknown UID",{id:t,currentLockIds:this.locks.map(t=>t.id)}),!1;const n=e.id===this.locks[0].id;return e.released.resolve(),s.filterInPlace(this.locks,e=>e.id!==t),n?this.logger.debug("released for "+t):this.logger.error("release(): premature release by "+t),n}}e.AdvisoryLock=g;e.AdvisoryLocks=class{constructor(t=d.MaxSyncFileTimeoutMs){this.logger=h.mkLogger("AdvisoryLocks"),this.locks=new l.TTLMap(t)}get busyLocks(){return u.toA(this.locks.values()).filter(t=>!t.idle).map(t=>t.name)}lockMaybeAvailable(t){return a.Opt(this.locks.get(t)).flatMap(t=>t.idle).getOrElse(()=>!0)}advisoryLockFor(t){return this.locks.getOrSet(t,()=>new g(t))}acquireAdvisoryLocks(t){return i(this,void 0,void 0,(function*(){this.logger.debug("acquireAdvisoryLocks("+t+")");const e=s.compactBlanks(t).map(t=>this.advisoryLockFor(t)),n=()=>e.every(t=>t.idle),i=[];if(!(n()||(this.logger.info("acquireAdvisoryLocks("+t+"): waiting for locks to be free"),yield p.until(n,30*o.secondMs,250))))throw new c.WrappedError({message:"Cannot acquire locks",retriable:!0});try{for(const t of e){const e=yield t.acquire();i.push({name:t.name,lockId:e})}return this.logger.debug("acquireAdvisoryLocks("+t+"): all locks acquired."),i}catch(e){throw this.logger.warn("acquireAdvisoryLocks("+t+"): failed",e),this.releaseAdvisoryLocks(i),e}}))}releaseAdvisoryLocks(t){return t.reverse().every(t=>this.advisoryLockFor(t.name).release(t.lockId))}withAdvisoryLocks(t,e){return i(this,void 0,void 0,(function*(){const n=[];try{return n.push(...yield this.acquireAdvisoryLocks(t)),yield e(n)}finally{this.releaseAdvisoryLocks(n)}}))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(11),s=n(31),o=n(76),a=n(92),u=n(98);e.RpcServiceHandlers=class{libraryPath(){return r.Settings.libraryPath.value}healthChecks(){return i(this,void 0,void 0,(function*(){return u.healthChecks()}))}mountpoints(){return s.mountpoints()}volumes(){return o.volumes()}paused(){return a.isPaused()}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(13),r=n(3),s=n(25),o=n(1),a=r.mkLogger("truncateTables()");e.truncateTables=function(t,...e){if(s.isProd)throw new Error("rejecting attempt to truncate in prod");i.emitClearCache();const n=o.isNotEmpty(e)?e:["AssetFile","AssetTag","Example","Progress","Tag","Asset"];return a.warn("truncating",n),n.map(e=>t.exec("DELETE FROM "+e))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(38),s=n(32),o=n(4);e.localDbDir=o.lazy(()=>i(void 0,void 0,void 0,(function*(){const t=s.PosixFile.for(r.App.getPath("userData")).join("localdb");return yield t.join("README.txt").writeTxt("\nThis folder is only used when your library is on a slow remote filesystem.\n\nYou will corrupt your library if you remove this directory while PhotoStructure is\nrunning.\n\nIf you have any questions, please visit <https://support.photostructure.com/>."),t})))},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(42),s=n(7),o=n(13),a=n(3),u=n(76),l=n(2),c=n(0),d=n(293),h=n(168),f=n(232),p=n(167),m=n(231),g=n(233),v=n(139);e.ModelDbJanitor=class{constructor(t,e){this.dataDir=t,this.localDbDir=e;const n="ModelDbJanitor("+t+")";this.logger=a.mkLogger(n),this.db=new r.Deferred(n+".db"),this.backup=new r.Deferred(n+".backup"),this.srcDbFile=h.pathToDb(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),this.archiveDir=this.backupDir.sibling("archive"),o.eventEmitter.on("modelArchive",this.archive.bind(this)),this.setup()}end(){return o.eventEmitter.removeListener("modelArchive",this.archive.bind(this)),s.tryAll([()=>c.map(this.backup.value,t=>t.onEnd())])}archive(t){return i(this,void 0,void 0,(function*(){try{if(l.blank(t.$pk()))return void this.logger.info("Cannot archive model, missing PK",{model:t});const e=this.archiveDir.join(t.$tableName()).join(t.$pk()+".json");yield e.writeJSON(t.toJSON()),this.logger.info("Saved model to "+e,t)}catch(e){this.logger.info("Failed to save model",{err:e,model:t})}}))}setup(){return i(this,void 0,void 0,(function*(){try{yield this._setup()}catch(t){throw this.logger.error("setup failed: "+t,{dataDir:this.dataDir.nativePath}),this.db.reject(t),this.backup.reject(t),t}}))}_setup(){return i(this,void 0,void 0,(function*(){const t=yield this.backupDir.mkdirp();if(null==t)throw new Error("Failed to create models DB backup dir for "+this.srcDbFile);const e=(yield this.srcDbFile.exists())&&(yield s.thenOrElse(s.thenMap(u.volumeFor(this.dataDir.nativePath),t=>t.remote),()=>!1)),n=e?yield this.srcDbFile.shaMs():void 0,i=e&&null!=n&&n>500?yield this.localDbDir():void 0;if(null!=i){if(this.logger.info("DB is on a slow remote drive. Setting up local db cache."),this.localDbFile=h.pathToDb(i,"models"),null==(yield this.localDbFile.parent().mkdirp()))throw new Error("Failed to make local db cache dir for "+this.localDbFile);const e=yield m.sqliteFiles(this.localDbFile);if(yield Promise.all(e.map(t=>t.unlink())),!(yield p.backupDb(this.srcDbFile,this.localDbFile)))throw new Error("Failed to copy remote db to a local drive");this.logger.info("Local models db set up at "+this.localDbFile);const n=v.Model.db=yield f.dbSetup(i,"models"),r=new g.SqliteJanitor("models",n);this.backup.resolve(new d.DbBackup(r,this.localDbFile,t,this.srcDbFile.parent())),this.db.resolve(n)}else{const e=v.Model.db=yield f.dbSetup(this.dataDir,"models"),n=new g.SqliteJanitor("models",e);this.backup.resolve(new d.DbBackup(n,this.srcDbFile,t)),this.db.resolve(e)}this.logger.info("Finished setup",this.db.value)}))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(36),s=n(22),o=n(59),a=n(18),u=n(294),l=n(3),c=n(5),d=n(0),h=n(167),f=n(231);e.DefaultBackupFrequencyMs=1*c.hourMs,e.DefaultRetentionCount=12,e.stamp=function(t=new Date){return"."+a.filestampUTC(t)+"-"};e.DbBackup=class{constructor(t,n,i,r,a=(()=>void 0),c=e.DefaultRetentionCount,d=e.DefaultBackupFrequencyMs){this.janitor=t,this.srcDb=n,this.backupsDir=i,this.replaceDir=r,this.onBackupFinished=a,this.retentionCount=c,this.backupFrequency=d,d>0&&(this.timer=o.setUnrefInterval(()=>this.backup().catch(t=>this.logger.warn("backup failed",t)),d)),this.hanoi=new u.Hanoi(i,c),this.logger=l.mkLogger("DbBackup("+this.srcDb.baseWithGrandparent+" -> "+this.backupsDir.baseWithGrandparent+")"),s.addCleanupEndable(new s.EndableWrapper("DbBackup",()=>this.onEnd()))}verifyDb(t=this.srcDb){return h.verifyDb(t)}onEnd(){return i(this,void 0,void 0,(function*(){return d.map(this.timer,t=>r.clearInterval(t)),this.timer=void 0,this.backup()}))}backup(t=""){return i(this,void 0,void 0,(function*(){try{if(yield this.srcDb.clear().isEmpty())return this.logger.warn("backup(): srcDb is missing, giving up."),!1;this.logger.info("backup(): housekeeping...",{srcDb:this.srcDb.nativePath,backupsDir:this.backupsDir.nativePath}),yield this.janitor.run(),this.logger.info("backup(): starting backup...");const e=this.backupsDir.join(this.srcDb.base);if(!(yield h.backupDb(this.srcDb,e)))return!1;if(this.logger.info("backup(): backup taken. Verifying."),!(yield this.verifyDb(e)))return!1;this.logger.info("backup(): verified. Rotating files.");const n=yield f.sqliteFiles(e);if(null!=this.replaceDir)for(const t of n)yield t.copyFile(this.replaceDir);const i=(yield this.hanoi.next(t)).toFilename();for(const t of n){const e=yield t.mv(t.withPrefix(i));this.logger.debug("mv "+t+" "+e)}for(const t of yield this.hanoi.staleFiles())this.logger.info("backup(): removing stale backup "+t),yield t.unlink();return this.logger.info("backup(): finished successfully"),!0}catch(t){return this.logger.error("Failed to back up db: "+t),!1}}))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(0),o=n(6),a=n(18),u=n(48),l=n(72);class c{constructor(t,e,n,i=a.filestampUTC()){this.seq=t,this.set=e,this.name=n,this.stamp=i}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(t){return t.join(this.toFilename())}static fromFile(t){return this.fromBasename(t.base)}static fromBasename(t){return s.map(this.parseRe.exec(t),t=>new c(parseInt(t[2],10),parseInt(t[3],10),t[4],t[1]))}}e.HanoiFile=c,c.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;e.Hanoi=class{constructor(t,e=10){this.root=t,this.sets=e,this.seq=this.fsMaxSeq().then(t=>({max:t+1})),this.mods=o.times(e+1,t=>Math.pow(2,e-t))}set(t){return this.sets-this.mods.findIndex(e=>t%e==0)}fsMaxSeq(){return i(this,void 0,void 0,(function*(){const t=yield this.hanoiFiles();return u.max([0,...t.map(t=>t.seq)])}))}maxSeq(){return this.seq.then(t=>t.max)}next(t){return i(this,void 0,void 0,(function*(){const e=(yield this.seq).max++;return new c(e,this.set(e),t)}))}hanoiFiles(){return i(this,void 0,void 0,(function*(){const t=yield this.root.clear().childNames();return r.compact(s.orElse(t,[]).map(t=>c.fromBasename(t)))}))}staleHanoiFiles(){return i(this,void 0,void 0,(function*(){const t=[],e=new l.MultiMap;return yield this.hanoiFiles().then(t=>t.forEach(t=>e.add(t.set,t))),[...e.keys()].forEach(n=>{const i=e.get(n),r=u.max(i.map(t=>t.seq));i.filter(t=>t.seq<r).forEach(e=>t.push(e))}),t}))}staleFiles(){return i(this,void 0,void 0,(function*(){return this.staleHanoiFiles().then(t=>t.map(t=>t.toFile(this.root)))}))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SqliteSuffixes=["-wal","-journal"]},function(t,e){t.exports=require("better-sqlite3")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(15),s=n(3),o=n(1),a=n(2),u=n(4),l=n(0),c=n(8),d=n(298),h="\nCREATE TABLE IF NOT EXISTS migrations (\n  id integer NOT NULL PRIMARY KEY, \n  name varchar(255) NOT NULL, \n  migration_time integer NOT NULL \n)\n";e.Migration=class{constructor(t,e){this.migrationsDir=t,this.db=e,this.fsMigrations=u.lazy(()=>this.migrationsDir.children(t=>".sql"===t.ext)),this.logger=s.mkLogger("Migration("+t.base+")"),e.exec(h),this.addMigrationName=e.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}latest(t){return i(this,void 0,void 0,(function*(){const e=this.db.prepare("SELECT name from migrations").pluck().all(),n=yield this.fsMigrations();if(null==n)throw new Error("no migration files found for "+this.migrationsDir);this.logger.info("latest()",{currentNames:e,migrationFiles:n,migrationsDir:this.migrationsDir});for(const i of n)e.includes(i.name)?this.logger.info("latest(): already applied "+i.base):(yield l.map(t,t=>t(i)),yield this.applyMigration(i));this.logger.info("up to latest!")}))}applyMigration(t){return i(this,void 0,void 0,(function*(){console.log(JSON.stringify({migration:t.name})),this.logger.info("applyMigration("+t.baseWithGrandparent+")");try{const e=Date.now(),n=d.maybeApplyMigration(t.name,this.db);return null!=n?(yield n,this.logger.info("applyMigration("+t.baseWithGrandparent+"): ran code migration",{elapsedMs:Date.now()-e})):yield this.applySqlMigration(t),this.addMigrationName.run(t.name,Date.now())}catch(e){throw this.logger.error("Failed to apply migration "+t.baseWithParent,e),r.onError("Migration: failed to update "+t.baseWithParent+": "+e),e}}))}applySqlMigration(t){return i(this,void 0,void 0,(function*(){const e=t.base.includes("_nofk");try{const n=c.toS(yield t.readFile());if(a.blank(n))return void this.logger.error("Empty migration: "+t);e&&this.db.pragma("foreign_keys = OFF"),this.db.transaction(()=>{if(n.split(";").forEach(t=>this.db.exec(t.trim())),e){const t=this.db.pragma("foreign_key_check");if(o.isNotEmpty(t))throw this.logger.error("foreign_key_check failed",t),new Error("Foreign key checks failed")}})()}finally{e&&this.db.pragma("foreign_keys = ON")}}))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(18),s=n(41),o=n(3),a=n(11),u=n(97),l=n(10),c=n(4),d=n(9),h=n(14),f=n(77),p=c.lazy(()=>o.mkLogger("Migrations"));e.maybeApplyMigration=function(t,e){const n=t.replace(/^[\d_-]+/,"");return d.maybeCall(g,n,e)};const m=new RegExp(`^(${f.PS_NETWORK_FILESYSTEM_PROTOCOL}//.*?/)(.*)$`);var g;e.lowercase_psnet_function=t=>h.Opt(t).filter(l.isString).flatMap(t=>m.exec(t)).map(t=>t[1].toLowerCase()+t[2]).getOrElse(()=>t),function(t){t.lowercase_psnet_hostname=function(t){return i(this,void 0,void 0,(function*(){t.function("lowercase_psnet_hostname",{deterministic:!0},e.lowercase_psnet_function),t.transaction(()=>{t.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),t.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),t.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")})()}))},t.force_stable_channel=function(){return i(this,void 0,void 0,(function*(){try{yield u.readSystemSettings();const t=a.Settings.updateChannel.value;"stable"!==t&&(a.Settings.updateChannel.value="stable",yield u.writeSystemSettings(),p().info("force_stable_channel(): reset updateChannel",{priorValue:t}))}catch(t){p().error("force_stable_channel(): failed: "+t)}}))},t.numeric_captured_at=function(t){return i(this,void 0,void 0,(function*(){t.function("isoToLocal",{deterministic:!0},r.isoToLocal),t.function("isoToOffsetMinutes",{deterministic:!0},s.isoToOffsetMinutes),t.function("isoToPrecisionMs",{deterministic:!0},r.isoToPrecisionMs),t.transaction(()=>{t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),t.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),t.exec("DROP INDEX asset_captured_at_geohash_idx"),t.exec("DROP INDEX assetfile_exifuid_idx"),t.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")})()}))}}(g=e.Migrations||(e.Migrations={}))},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(3),s=n(5),o=n(4),a=n(168),u=n(232),l=n(233),c=n(239),d=o.lazy(()=>r.mkLogger("StatsDbJanitor"));e.statsDbJanitor=function(t){return i(this,void 0,void 0,(function*(){d().info("Setting up "+t);const e=yield u.dbSetup(a.pathToDb(t,"stats"),"stats");c.StatsModel.db=e;const n=new l.SqliteJanitor("stats",e);return n.setInterval(5*s.minuteMs),n}))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(3),s=n(4),o=n(58),a=n(62),u=r.mkLogger("RemoteLibraryPath");e.remoteLibraryPath=s.lazy(()=>i(void 0,void 0,void 0,(function*(){try{const t=a.dbClient()||a.dbClient.refresh();return yield o.thenTap(t.request("libraryPath"),t=>{u.info("received",{libraryPath:t})})}catch(t){return void u.error("Failed to get remote library path"+t)}})))},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(266),s=n(302),o=n(43),a=n(19),u=n(22),l=n(7),c=n(15),d=n(13),h=n(303),f=n(189),p=n(173),m=n(165),g=n(182),v=n(75),y=n(3),b=n(25),w=n(272),S=n(225),M=n(11),P=n(10),x=n(60),E=n(1),_=n(2),O=n(5),T=n(47),F=n(0),k=n(14),A=n(8),I=n(28),D=n(98),C=n(273),L=n(224),R=n(115),N=y.mkLogger("Sentry"),j=Math.round(3*v.MaxRecentLogEntriesByLevel);e.installSentry=function(t){return i(this,void 0,void 0,(function*(){try{if(!C.sentryEnabled())return!1;const e=new B;return r.init({dsn:"https://0652cdd351054fe9853ff944b1f54e2c@sentry.io/289071",shutdownTimeout:S.serviceShutdownTimeoutMs(t.name),release:x.release,environment:b.nodeEnv,maxBreadcrumbs:j,beforeSend:e.beforeSend,serverName:yield f.systemUID(),onFatalError:t=>c.onError("sentry.onFatalError",t)}),!0}catch(t){return N.warn("Failed to set up sentry: "+t),!1}}))};class B{constructor(){this.eventStore=new h.EventStore,this.beforeSend=(t,e)=>i(this,void 0,void 0,(function*(){if(!C.sentryEnabled())return N.error("Sentry.beforeSend(): not sending event",t),null;const n=M.Settings.email.value;_.notBlank(n)&&(null==t.user&&(t.user={}),t.user.email=n);const i=P.ellipsize(z(t,e),60);if(c.isIgnorableError(i))return N.info("Sentry.beforeSend(): ignorable event. vetoing",{event:t,hint:e,msg:i}),null;null==t.breadcrumbs&&(t.breadcrumbs=[]),t.breadcrumbs.push(...E.compact(v.recentLogEntries().slice(-j).map(q)));const r=F.orElse(t.extra,{});return r.msg=i,r.pid=a.pid,r.serviceName=R.serviceName(),r.serviceEnding=u.ending(),r.runtimeMs=Date.now()-L.start,r.version=x.version,r.os=w.OS(),r.locale=yield g.locale(),r.cpus=w.CPUs(),r.memoryUsageBytes=D.memoryUsageBytes(),r.systemMemory=I.fmtBytes(o.freemem())+" / "+I.fmtBytes(o.totalmem()),r.ffmpegInfo=yield l.thenMap(p.ffmpegVersion(),A.toS),r.vlcInfo=yield m.vlcVersionDescription(),t.extra=r,this.eventStore.maybeSendEvent(i,t)}));const t=(t,e)=>{null!=e?r.captureException(e):r.captureMessage(t)};d.onNonFatal(t),d.onFatal(t),d.onBoom(()=>r.captureMessage("User requested log dispatch")),u.addFirstEndable(new u.EndableWrapper("EventFilter",()=>this.end()))}end(){F.map(r.getCurrentHub().getClient(),t=>t.close(5*O.secondMs))}}function z(t,e){return k.Opt(t).flatMap(t=>t.message).filter(_.notBlank).orElse(()=>k.Opt(e).flatMap(t=>t.originalException).flatMap(T.errorToS).filter(_.notBlank)).orElse(()=>k.Opt(t.exception).flatMap(t=>t.values).flatMap(t=>t.map(W).find(_.notBlank)).filter(_.notBlank)).orElse(()=>"Unknown event").map(P.stripAnsiEsc).map(c.trimErrorMessage).get()}function W(t){return F.map(t,t=>E.compactBlanks([t.type,t.value]).join(": "))}function q(t){return F.map(V(t.level),e=>({timestamp:t.timestamp/O.secondMs,level:e,category:P.stripAnsiEsc(t.context),message:P.stripAnsiEsc(t.msg),data:"object"==typeof t.meta?t.meta:{value:P.isString(t.meta)?P.stripAnsiEsc(t.meta):t.meta}}))}function V(t){switch(t){case"error":return s.Severity.Error;case"warn":return s.Severity.Warning;case"info":return s.Severity.Info;case"debug":return s.Severity.Debug;default:return}}e.EventFilter=B,e.extractMessage=z,e.sentryExceptionToS=W,e.logEntryToBreadcrumb=q,e.logLevelToSeverity=V},function(t,e){t.exports=require("@sentry/types")},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(2),s=n(5),o=n(4),a=n(38),u=n(22),l=n(7),c=n(15),d=n(29),h=n(80),f=n(3),p=n(50),m=n(11),g=o.lazy(()=>f.mkLogger("EventStore"));e.EventStore=class{constructor(t=d.BaseFile.for(a.App.userData()).join("events")){this.root=t}vacuum(){return i(this,void 0,void 0,(function*(){const t=Date.now()-s.dayMs;yield l.awaitAll(yield l.thenMap(this.root.clear().children(),e=>e.map(e=>i(this,void 0,void 0,(function*(){try{if(e.isHiddenPosix()||".json"!==e.ext)return;const n=yield l.thenMapOr(e.readJSON(),t=>t.eventTime,()=>e.mtimeMs());null!=n&&n<t&&(yield e.unlink())}catch(t){g().warn("vacuum(): failed to vacuum "+e+": "+t)}}))))),this.root.clear()}))}maybeSendEvent(t,e){return i(this,void 0,void 0,(function*(){if(u.ending())return g().error("maybeSendEvent(): REJECT: we're ending.",{msg:t,event:e}),null;r.blank(t)&&(t="UNKNOWN EVENT");try{yield l.thenOrTimeout(()=>this.vacuum(),5*s.secondMs);const n=yield l.thenMapOr(this.root.clear().children(),t=>t.length,()=>0);if(n>=m.Settings.maxErrorsPerDay.valueOrDefault+(c.isSendableError(t)?7:0))return g().error("maybeSendEvent(): REJECT: too many events sent in the last day.",{sentEventCount:n,maxErrorsPerDay:m.Settings.maxErrorsPerDay.valueOrDefault,event:e}),null;return null==(yield this.writeEvent({msg:t,event:e}))?(g().error("maybeSendEvent(): REJECT: event was already sent in the last day.",e),null):(g().error("maybeSendEvent(): ACCEPT",{sentEventCount:n,event:e}),e)}catch(t){return g().error("maybeSendEvent(): Failed to determine if we should squelch the event. Failing closed.",t),null}}))}writeEvent({msg:t,eventTime:e=Date.now(),event:n}){return i(this,void 0,void 0,(function*(){const i=this.msg2file(t),r={msg:t,eventTime:e,event:n},s=c.isSendableError(t)?m.Settings.maxErrorsPerDay.valueOrDefault-1:0;return l.thenMap(i.ensureNew({maxVersions:s,emptyIsNew:!1}).catch(()=>void 0),t=>t.writeJSON(r))}))}msg2file(t){return this.root.join(h.shortStringSha(t,8,p.GeoRadix)+".json")}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(1),s=n(2),o=n(6),a=n(8),u=n(12),l=n(119),c=n(7),d=n(190),h=n(188),f=n(3),p=n(16),m=n(11),g=n(37),v=n(44),y=n(187),b=n(153);function w(t){return l.AsyncFilter.lift(e=>i(this,void 0,void 0,(function*(){return c.thenMapOr(g.readRawTags(e,!1),t,()=>!1)})))}function S(t){return w(e=>u.allNotBlank(...t.map(t=>e[t])))}e.onlyFiles=l.AsyncFilter.lift(t=>t.isFile()),e.onlyReadable=l.AsyncFilter.lift(t=>t.isReadable()),e.requiredTagsFilter=S,e.minDimensionsFilter=l.AsyncFilter.lift(t=>i(void 0,void 0,void 0,(function*(){const e=yield g.mimetype(t);if(null==e||!e.startsWith("image/")&&!e.startsWith("video/"))return!1;const n=e.startsWith("video/")?m.Settings.minVideoDimension.valueOrDefault:m.Settings.minImageDimension.valueOrDefault;return c.thenMapOr(g.sizeInfo(t),t=>p.gte(t.ImageWidth,n)&&p.gte(t.ImageHeight,n),()=>!1)}))),e.hasMimeType=S(["MIMEType"]),e.hasMakeAndModel=S(["Make","Model"]),e.notRejected=w(t=>o.toInt(t.Rating,{defaultValue:0})>=0),e.hasBrowserImgMimetype=w(t=>r.includes(["image/jpeg","image/png"],a.toS(t.MIMEType))),e.imageFilter=w(t=>a.toS(t.MIMEType).startsWith("image/")),e.videoFilter=w(t=>a.toS(t.MIMEType).startsWith("video/"));const M=e.imageFilter.and(e.hasMakeAndModel).or(e.videoFilter);function P(t){return!s.blank(t)&&(h.isSupportedVideoMimeType(t)||e.supportedImageMimeTypes.has(t.toLowerCase()))}e.supportedImageMimeTypes=new Set([...v.sharpSupportedMimeTypes,...d.dcrawSupportedMimeTypes]),e.supportedMimeTypeFilter=l.AsyncFilter.lift(t=>i(void 0,void 0,void 0,(function*(){return c.thenMapOr(g.mimetype(t.nativePath),P,()=>!1)}))),e.exifExtFilter=y.extFilter(v.AssetFileExts),e.notHiddenCheap=l.AsyncFilter.lift(t=>i(void 0,void 0,void 0,(function*(){return!b.ignorablePath(t.nativePath)}))),e.fileSizeFilter=l.AsyncFilter.lift(t=>i(void 0,void 0,void 0,(function*(){return c.thenMapOr(t.size(),t=>p.within(m.Settings.minFileSizeBytes.valueOrDefault,m.Settings.maxFileSizeBytes.valueOrDefault,t),()=>!1)}))),e.noStatFileFilter=l.AsyncFilter.andLogged(f.mkLogger("noStatFileFilter"),{exifExtFilter:e.exifExtFilter},{notHiddenCheap:e.notHiddenCheap}),e.cheapFileFilter=l.AsyncFilter.andLogged(f.mkLogger("cheapFileFilter"),{exifExtFilter:e.exifExtFilter},{notHiddenCheap:e.notHiddenCheap},{fileSizeFilter:e.fileSizeFilter}),e.expensiveFileFilters=r.compact([{exifExtFilter:e.exifExtFilter},{fileSizeFilter:e.fileSizeFilter},{notHiddenCheap:e.notHiddenCheap},{hasMimeType:e.hasMimeType},{supportedMimeTypeFilter:e.supportedMimeTypeFilter},m.Settings.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:M}:void 0,{notRejected:e.notRejected},{minDimensionsFilter:e.minDimensionsFilter}]),e.expensiveFileFilter=l.AsyncFilter.andLogged(f.mkLogger("expensiveFileFilter"),...e.expensiveFileFilters),e.extless=l.AsyncFilter.lift(t=>i(void 0,void 0,void 0,(function*(){return s.blank(t.ext)}))),e.onlyDirectories=l.AsyncFilter.lift(t=>i(void 0,void 0,void 0,(function*(){return t.isDirectory()}))),e.fileExtFilter=function(t){return l.AsyncFilter.and(y.extFilter(t),e.onlyFiles)},e.excludeDirnameFilter=function(t){return l.AsyncFilter.and(y.excludedPathFilter(t),e.onlyDirectories)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(18),r=n(191),s=n(16),o=n(21),a=n(230),u=n(310),l=n(311),c=n(1),d=n(2),h=n(5),f=n(45),p=n(0),m=n(9),g=n(35),v=g.strEnum("mimetype","capturedAtSrc","capturedAtLocal","capturedAtPrecisionMs","make","model","cameraId","imageId","lensId","geohash",...l.ExposureSettingsProps,"meanHash","rightHash","mode8b6");function y(t,e,n,i=o.identity){const r=i(t[n]),s=i(e[n]);if(!d.blank(r)&&!d.blank(s))return p.map(f.whyNotEql(r,s),t=>`Different ${String(n)}: ${t}`)}function b(t){return d.mapNotBlank(t,t=>t.toLowerCase().trim())}function w(t,e){if(null==t)return"af1 was undefined";if(null==e)return"af2 was undefined";const n=Math.max(...c.compact([t.capturedAtPrecisionMs,e.capturedAtPrecisionMs,1])),s=i.localToMs(t.capturedAtLocal),o=i.localToMs(e.capturedAtLocal);if(null==s)return"af1 missing capturedAtLocal";if(null==o)return"af2 missing capturedAtLocal";if(Math.abs(s-o)>n){return`Different Captured-at times: ${[t,e].map(t=>`${t.capturedAtLocal}${"±"+i.fmtDuration(n)}`).join(" != ")}`}const l=p.map(t,a.normalizeExposureSettings),d=p.map(e,a.normalizeExposureSettings),h=u.firstDefinedThunk([()=>y(t,e,"make",b),()=>y(t,e,"model",b),()=>y(t,e,"cameraId"),()=>y(t,e,"imageId"),()=>y(t,e,"lensId"),()=>y(t,e,"geohash"),()=>p.map(l,t=>p.map(d,e=>f.whyNotEql(t,e)))]);if(null!=h)return h;if(c.count([f.definedEql(t.cameraId,e.cameraId),f.definedEql(t.imageId,e.imageId),f.definedEql(t.lensId,e.lensId),f.definedEql(t.geohash,e.geohash),f.definedEql(l,d)],t=>t)>=2)return;const m=r.imageHashCompare(t,e);return r.isSimilarComparison(m)?void 0:"low image correlation"}e.MetadataFieldValues=g.strEnumValues(v),e.isSimilar=function(t,e){return null==w(t,e)},e.whyNotSimilar=w,e.metadataQualityScore=function(t){return null==t?-100:m.entries(t).filter(([t,n])=>null!=n&&e.MetadataFieldValues.includes(t)).length+(s.gt(t.capturedAtPrecisionMs,h.hourMs)?-5:s.gt(t.capturedAtPrecisionMs,h.minuteMs)?-1:0)}},,function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),r=n(21);e.parseMaybe=function(t){return i.mapNotBlank(t,t=>r.Try(()=>JSON.parse(t)))}},,function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(7),r=n(37),s=n(2),o=n(0),a=n(105);function u(t){return o.map(t,t=>s.mapNotBlank(t.Make,e=>s.mapNotBlank(t.Model,t=>[a.Camera,e,t])))}e.cameraTag=u,e.cameraTagFile=function(t){return i.thenMap(r.readTags(t),u)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.firstDefinedThunk=function(t){for(const e of t){const t=e();if(null!=t)return t}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(0),s=n(8);e.ExposureSettingsProps=["focalLength","aperture","shutterSpeed","iso"],e.exposureSettingsDesc=function(t){return r.map(t,t=>i.compactBlanks([t.focalLength,r.map(t.aperture,t=>`ƒ/${t}`),s.toS(t.shutterSpeed),r.map(t.iso,t=>`ISO ${t}`)]).join(", "))}},,,,,,,,,,,,function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(7),s=n(3),o=n(82),a=n(309),u=n(229),l=n(380),c=n(381),d=n(105),h=s.mkLogger("AssetTagger");function f(t,e,n=[]){return i(this,void 0,void 0,(function*(){const i=[];yield r.thenMap(a.cameraTagFile(t),e=>{h.debug("Camera tag for "+t+": "+d.joinTagPath(e,"|")),i.push(e)}),yield r.thenMap(c.lensTagFile(t),e=>{h.debug("Lens tag for "+t+": "+d.joinTagPath(e,"|")),i.push(e)}),yield r.thenMap(u.dateTagFile(t,n),e=>{h.debug("Date tag for "+t+": "+d.joinTagPath(e,"|")),i.push(e)}),yield r.thenMap(l.keywordTagFile(t),e=>{h.debug("Keyword tags for "+t+": "+e),i.push(...e)});const s=d.tagDeltas(e,i,!0);return h.debug("tagAsset("+t+")",s),s}))}e.tagAndUpsertAsset=function(t,e){return i(this,void 0,void 0,(function*(){return r.thenMap(f(e,yield t.getTagPaths(),yield t.getCapturedAt()),e=>i(this,void 0,void 0,(function*(){yield o.Asset.addTags(t.id,e.add),yield o.Asset.removeTags(t.id,e.remove),t.tags=void 0})))}))},e.tagAsset=f},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(t,e,n){n(193),t.exports=n(377)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});try{n(240).install()}catch(t){}const i=n(274),r=n(378);i.handleArgv(),new r.SyncFileService,e.load=!0},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(19),s=n(119),o=n(22),a=n(7),u=n(53),l=n(158),c=n(15),d=n(13),h=n(169),f=n(131),p=n(32),m=n(304),g=n(307),v=n(3),y=n(11),b=n(37),w=n(1),S=n(2),M=n(47),P=n(6),x=n(98),E=n(128),_=n(82),O=n(90),T=n(265),F=n(224),k=n(159),A=n(379),I=n(383),D=v.mkLogger("SyncFileService");e.SyncFileService=class{constructor(){this.jobs=new u.Promises,this.service=new F.Service({name:"sync-file",stdinReceiver:this.stdinReceiver.bind(this)}),d.onRpcServerChange(()=>this.service.exit("rpcServerChange",0)),h.onProgressEvt(t=>k.stdoutWrite(t,!1)),this.start()}start(){return i(this,void 0,void 0,(function*(){(yield a.rejected(this.service.ready))?D.warn("setup(): service.ready was rejected, exitting."):(T.modelJsonSetup(),r.argv.length>2&&(yield this.importFiles(r.argv.slice(2)).then(()=>this.service.exit("Processed files from argv",0))),o.addFirstEndable(new o.EndableWrapper("SyncFileService",()=>(w.mapNotEmpty(this.jobs.pendingNames(),t=>D.info("Waiting for "+t)),this.jobs.awaitAll()))))}))}checkup(){return i(this,void 0,void 0,(function*(){if(x.memoryUsageIsHigh())return this.service.exit("high memory usage",13);try{yield b.exiftool().version()}catch(t){return this.service.exit("exiftool is unhealthy: "+t,13)}const t=yield x.healthChecks();return l.hasFail(t)||l.hasBad(t)?this.service.exit("Failed health checks: "+JSON.stringify(t),13):void 0}))}stdinReceiver(t){return i(this,void 0,void 0,(function*(){yield this.checkup(),o.ending()||w.compactBlanks(f.splitLines(t)).forEach(t=>i(this,void 0,void 0,(function*(){if(S.blank(t))return;const e=g.parseMaybe(t);return null==e?this.importFile(p.PosixFile.for(t)):S.notBlank(e.file)?this.importFile(p.PosixFile.for(e.file)):P.gt0(e.updateAssetFileId)?this.updateAssetFile(e.updateAssetFileId):P.gt0(e.updateAssetId)?this.updateAsset(e.updateAssetId):void console.log(JSON.stringify({error:"Cannot parse "+t}))})))}))}updateAssetFile(t){return this.jobs.serial(`SyncFileService.updateAssetFile(${t})`,()=>i(this,void 0,void 0,(function*(){try{const e=yield O.AssetFile.ops().findById(t);if(null==e)throw new Error("no such AssetFile");null!=(yield e.updateIfNeeded())&&_.Asset.touch([e.assetId]),k.stdoutWrite({id:t})}catch(e){k.stdoutWrite({id:t,error:M.errorToS(e)})}})))}updateAsset(t){return this.jobs.serial(`SyncFileService.updateAsset(${t})`,()=>i(this,void 0,void 0,(function*(){try{yield I.updateAsset(t),k.stdoutWrite({id:t})}catch(e){k.stdoutWrite({id:t,error:M.errorToS(e)})}})))}importFiles(t){return i(this,void 0,void 0,(function*(){for(const e of t)yield this.checkup(),yield this.importFile(p.PosixFile.for(e))}))}importFile(t){return i(this,void 0,void 0,(function*(){const e=Date.now();t.clear(),D.info("importFile()",t);const n=yield this.importFileToResult(t);return D.info("importFile() finished in "+(Date.now()-e)+"ms",{importResult:n}),k.stdoutWrite(n),n}))}importFileToResult(t){return this.jobs.serial(`SyncFileService.importFileToResult(${t})`,()=>this._importFileToResult(t))}_importFileToResult(t){return i(this,void 0,void 0,(function*(){try{const e=E.Library.instance();if(null==e)return{path:t.nativePath,error:"Library is not set yet"};const n=y.envSkipFilters?{rejected:[]}:yield s.AsyncFilter.andExplain(t,m.expensiveFileFilters);if(w.isNotEmpty(n.rejected))return{path:t.nativePath,error:"rejected by "+n.rejected.join(", ")+" "+c.NonRetriableErrorFlag};{const n=new A.AssetFileImporter(t,e.assetFileRepository(),e.previews()),i=yield n.apply();if(null==i)throw new Error("empty result");return{path:i.uri,assetFileId:i.id,assetId:i.assetId}}}catch(e){return D.warn("Failed to import "+t+": "+e),{path:t.nativePath,error:M.errorToS(e)}}}))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(42),s=n(18),o=n(32),a=n(123),u=n(101),l=n(3),c=n(120),d=n(11),h=n(4),f=n(0),p=n(6),m=n(323),g=n(263),v=n(90),y=n(382);e.AssetFileImporter=class{constructor(t,e,n){this.file=t,this.repo=e,this.previews=n,this.srcAssetFile=()=>this.assetFileFinder.apply(),this.assetFile=h.lazy(()=>i(this,void 0,void 0,(function*(){const t=yield this.srcAssetFile();if(this.logger.debug("srcAssetFile",t),null==t)return;const e=yield this.repoAssetFile();if(this.logger.debug("repoAssetFile",{repoAssetFile:e}),null==e)return this.logger.throw("got null assetFile from .assetRepoFile()",{srcAssetFile:t,repoAssetFile:e});const n=yield t.getAsset();return null==n?this.logger.throw("assetFile.getAsset() was null",{repoAssetFile:e}):null==n.id?this.logger.throw("repoAssetFile asset has null id",{asset:n}):(yield e.updateFromFile(),yield e.upsert(),e.uri!==t.uri&&(yield n.addAssetFile(e),yield t.updateFromFile(),yield t.upsert()),e)}))),this.repoAssetFile=h.lazy(()=>i(this,void 0,void 0,(function*(){const t=l.mkLogger(this.toString()+".repoAssetFile()"),e=yield this.srcAssetFile();if(null==e)return t.debug("srcAssetFile is undefined"),e;if(null==this.repo)return t.debug("this.repo is undefined"),e;const n=yield this.repo.importFile(this.file);if(t.info("repo.importFile() returned "+n,{srcAssetFile:e}),null==n||this.file.eql(n))return t.debug("this.repo isn't copying assets, returning srcAssetFile",e),e;const i=yield e.getAsset();if(null==i)return t.throw("INTERNAL ERROR, asset is null");const r=yield n.uri();if(null==r)return t.throw("INTERNAL ERROR, uri is null");const s=yield i.findAssetFileByUri(r);if(t.debug("by uri",{prior:s}),null!=s)return s;t.debug("Creating new assetFile");const o=new v.AssetFile;return yield o.setFile(n),i.addAssetFile(o)}))),this.logger=l.mkLogger(this.toString()),this.assetFileFinder=new y.AssetFileFinder(t)}toString(){return"AssetFileImporter("+this.file.nativePath+")"}newAssetFile(){return this.assetFileFinder.newAssetFile()}apply(){return i(this,void 0,void 0,(function*(){return null!=this.result?this.result.promise:(this.result=new r.Deferred("AssetFileImporter("+this.file+").apply"),this.result.observe(this._apply()).promise)}))}_apply(){return i(this,void 0,void 0,(function*(){if(null==(yield this.file.size()))return this.logger.throw("unreadable file");const t=yield a.syncFileTimeoutForFileMs(this.file);if(!p.gt0(t))return this.logger.throw("syncFileTimeoutForFile() returned undefined");f.map(this.result,e=>e.setTimeout(t)),this.logger.info("Setting timeout to "+s.fmtDuration(t));const e=yield this.assetFile();if(null==e)return this.logger.throw("_apply(): unexpected null assetFile");const n=yield e.getAsset();if(null==n)return this.logger.throw("_apply(): unexpected null asset");const r=n.id;return null==r||e.assetId!==n.id?this.logger.throw("_apply(): unexpected assetId",{asset_id:n.id,af_assetId:e.assetId,af_id:e.id}):(yield g.withAdvisoryLocks(["assetId:"+r],()=>i(this,void 0,void 0,(function*(){const t=yield this.buildPreviews(n);if(this.logger.debug("AssetPreviewInfo:",{assetId:r,info:t}),null!=t){const e=this.transcode(r,o.PosixFile.for(t.path));yield v.AssetFile.setShown(r,t.assetFileId),f.map(n.files,e=>e.forEach(e=>e.shown=e.id===t.assetFileId)),yield m.tagAndUpsertAsset(n,o.PosixFile.for(t.path)),yield e,n.shown=!0,n.version=c.AssetVersion,yield n.upsert()}}))),v.AssetFile.ops().findById(e.id))}))}buildPreviews(t){return i(this,void 0,void 0,(function*(){if(null!=this.previews){if(null==t)throw new Error("buildPreviews(): null asset");if(null==t.id)throw new Error("buildPreviews(): null asset.id");return this.logger.debug("buildPreviews()",{assetId:t.id}),this.previews.build({assetId:t.id,assetFiles:yield t.getFiles(),force:d.Settings.forceSync.valueOrDefault,validate:!1})}}))}transcode(t,e){return i(this,void 0,void 0,(function*(){return u.transcode(e,this.previews.ap(t).mp4())}))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(7),r=n(37),s=n(1),o=n(2),a=n(14),u=n(8),l=n(105);function c(t){return a.Opt(t).map(t=>[t.Keywords,t.XPKeywords]).map(t=>d(...s.flatten(t))).map(t=>t.slice(0,100).map(t=>[l.Keywords,t])).get()}function d(...t){return a.Opt(t).map(t=>s.flatten(t)).map(t=>t.map(t=>t.split(/[,;]/))).map(s.flatten).map(t=>t.map(t=>u.toS(t).trim()).filter(o.notBlank)).map(s.sort).map(t=>s.uniqBy(t.reverse(),t=>t.toLowerCase()).reverse()).getOrElse(()=>[])}e.keywordTags=c,e.extractKeywordTags=d,e.keywordTagFile=function(t){return i.thenMap(r.readTags(t),c)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=n(7),r=n(37),s=n(2),o=n(0),a=n(105);function u(t){return o.map(t,t=>s.mapNotBlank(t.lensMake,e=>s.mapNotBlank(t.lensModel,t=>[a.Lens,e,t])))}e.lensTag=u,e.lensTagFile=function(t){return i.thenMap(r.readTags(t),u)}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(7),s=n(18),o=n(191),a=n(252),u=n(3),l=n(37),c=n(164),d=n(1),h=n(2),f=n(5),p=n(4),m=n(70),g=n(64),v=n(263),y=n(82),b=n(90),w=n(305);e.AssetFileFinder=class{constructor(t){this.file=t,this.newAssetFile=p.lazy(()=>m.thenOpt((new b.AssetFile).updateFromFile(this.file)).getOrElse(()=>{throw new Error("Cannot update from file "+this.file)})),this.tags=p.lazy(()=>m.thenOpt(l.readTags(this.file)).getOrElse(()=>{throw new Error(this.file+" doesn't have metadata")})),this.capturedAt=p.lazy(()=>this.tags().then(t=>t.capturedAt)),this.imageHash=p.lazy(()=>o.imageHash(this.file)),this.capturedAtLocal=p.lazy(()=>m.thenOpt(this.capturedAt()).flatMap(t=>t.toLocal()).getOrElse(()=>{throw new Error(this.file+" doesn't have capturedAt local")})),this.mapSibling=t=>this.newAssetFileForAsset(r.thenMap(t,t=>t.getAsset())),this.apply=p.lazy(()=>i(this,void 0,void 0,(function*(){if(h.blank(yield this.file.uri()))throw new Error("Cannot import, URI is blank");if(null==(yield this.tags()))throw new Error("Cannot import, tags are missing");if(null==(yield this.capturedAt()))throw new Error("Cannot import, capturedAt is null");{const t=yield this.byExistingAsset();if(null!=t)return this.logger.info("Found existing asset for file"),t}this.logger.info("No existing asset yet. Fetching advisory locks.");const t=yield this.newAssetFile(),e=d.compactBlanks(["name:"+this.file.nameWithoutCount.toLowerCase(),"bname:"+c.bname(this.file),"at:"+t.capturedAtLocal/1e4,"sha:"+t.sha]);return v.withAdvisoryLocks(e,()=>i(this,void 0,void 0,(function*(){const e=yield this.byExistingAsset();if(null!=e)return this.logger.info("Found existing asset for file (after locks)"),e;const n=new y.Asset;if(n.capturedAtLocal=t.capturedAtLocal,yield n.addAssetFile(t),null==(yield n.insert()))throw new Error("Failed to insert new Asset for "+this.file);if(t.assetId=n.id,null==(yield t.insert()))throw new Error("Failed to insert new AssetFile for "+this.file);return t})))}))),this.logger=u.mkLogger("AssetFileFinder("+t+")")}newAssetFileForAsset(t){return i(this,void 0,void 0,(function*(){return r.thenMap(t,t=>i(this,void 0,void 0,(function*(){return t.addAssetFile(yield this.newAssetFile())})))}))}byExistingAsset(){return i(this,void 0,void 0,(function*(){const t=[{name:"byUri",f:()=>this.byUri()},{name:"bySha",f:()=>this.newAssetFileForAsset(this.assetBySha())},{name:"validFile",f:()=>a.validFile(this.file)},{name:"byCapturedAt",f:()=>this.newAssetFileForAsset(this.assetByCapturedAt())}];for(const{name:e,f:n}of t)try{const t=yield n();if(null!=t)return this.logger.info("apply(): "+e,{assetFileId:t.id,assetId:t.assetId}),t;this.logger.info("apply(): "+e+" is null")}catch(t){throw this.logger.info("apply(): "+e+" rejected: "+t),t}}))}byUri(){return r.thenMap(this.file.uri(),t=>b.AssetFile.ops().findOneBy({uri:t}))}assetBySha(){return r.thenMap(this.file.sha(),t=>y.Asset.findFirstByFile(e=>e.where("AssetFile.sha",t)))}assetByCapturedAt(){return i(this,void 0,void 0,(function*(){const t=yield this.capturedAtLocal();return this.logger.info("assetByCapturedAt()",{dbRpc:g.dbRpc(),opsName:b.AssetFile.ops().constructor.name}),r.firstDefinedPromise([()=>b.AssetFile.ops().all(b.AssetFile.query().where("capturedAtLocal",t)),()=>b.AssetFile.ops().all(b.AssetFile.query().whereBetween("capturedAtLocal",[t-200,t+200])),()=>r.thenMap(this.imageHash(),e=>b.AssetFile.ops().all(b.AssetFile.query().where("capturedAtPrecisionMs",">",0).andWhereBetween("capturedAtLocal",[s.localPlusMs(t,-f.dayMs),s.localPlusMs(t,f.dayMs)]).andWhere(t=>t.where("meanHash",e.meanHash).orWhere("rightHash",e.rightHash))))],t=>this.firstSimilar(t))}))}firstSimilar(t){return i(this,void 0,void 0,(function*(){const e=yield this.newAssetFile(),n=yield this.capturedAtLocal();if(null==e)throw new Error("Failed to update from "+this.file);const i=d.sortBy(t,t=>[Math.abs(t.capturedAtLocal-n),t.id]);for(const t of i){const n=yield t.updateIfNeeded();if(null!=n){const t=w.whyNotSimilar(n,e);if(null==t)return this.logger.info("Found sibling AssetFile",n),y.Asset.ops().findById(n.assetId);this.logger.debug("Contemporary assetFile not similar: "+t,n)}}}))}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(12),s=n(7),o=n(53),a=n(26),u=n(18),l=n(15),c=n(32),d=n(236),h=n(252),f=n(3),p=n(16),m=n(120),g=n(162),v=n(1),y=n(5),b=n(0),w=n(20),S=n(323),M=n(128),P=n(82),x=n(90),E=n(305);e.updateAsset=function t(e){return i(this,void 0,void 0,(function*(){const n=f.mkLogger(`UpdateAsset(${e})`),_=M.Library.instance();if(null==_)return n.throw("null library"+l.NonRetriableErrorFlag);const O=[];n.info("starting");const T=yield P.Asset.ops().findById(e);if(null==T)return n.throw("no such asset");const F=yield T.getFiles();if(v.isEmpty(F))return n.info("empty asset. Deleting."),void(yield P.Asset.ops().delete([e]));if(p.gte(T.version,m.AssetVersion))return void n.debug("already up-to-date");if(yield r.everyAsync(F,t=>s.thenNot(t.exists())))return void n.info("No existing files. Skipping for now.");yield o.withBoundedConcurrency({name:"AssetFile.updateIfNeeded",laters:F.map(t=>()=>t.updateIfNeeded()),maxConcurrent:g.maxCpus()}),yield function(t){return i(this,void 0,void 0,(function*(){const[e,n]=r.partition(t,t=>t.isUpdated());for(const t of n)yield b.map(e.find(e=>e.sha===t.sha),e=>t.updateFromShaSibling(e))}))}(F);const k=yield function(t){return i(this,void 0,void 0,(function*(){const e=f.mkLogger(`UpdateAsset.bestAssetFile(${t.map(t=>t.id)})`);for(const e of t)if(a.truthy(e.shown)&&(yield e.exists()))return e;const n=yield d.sortAssetFiles(t);return e.tap({msg:"best result",meta:{uris:w.toA(n).map(t=>t.uri)},result:b.map(n,t=>t.pop())})}))}(F);if(null==k)return n.info("No existing files. Skipping for now.");if(!k.isUpdated())return void n.info("Best file needs update. Skipping for now.");const[A,I]=yield s.partitionAsync(F,t=>i(this,void 0,void 0,(function*(){return E.isSimilar(t,k)||(yield t.notExists())})));if(v.isNotEmpty(I)){const[t,e]=yield s.partitionAsync(I,t=>s.thenMapOr(t.posixFile(),t=>h.isValidFile(t),()=>!1));yield v.mapNotEmpty(e,t=>(n.warn("Asset files are invalid. Deleting.",t),x.AssetFile.ops().delete(t.map(t=>t.id))));const i=yield r.clusterStrictAsync(t,E.isSimilar);for(const t of i){const e=new P.Asset;e.capturedAtLocal=t[0].capturedAtLocal,e.version=0,yield e.upsert(),O.push(e.id),yield x.AssetFile.dbr(n=>n.run(x.AssetFile.query().update({assetId:e.id,shown:0}).whereIn("id",t.map(t=>t.id)))),n.info("Pushed rejected asset files into new asset",{rejectAsset:e,rejectCluster:t})}}function D(t){return v.uniq(A.map(e=>e[t]))}const C=D("capturedAtLocal"),L=v.uniq(A.map(t=>t.capturedAtPrecisionMs)),R=yield x.AssetFile.ops().all(x.AssetFile.query().distinct().where("assetId","!=",e).andWhere(t=>{t.whereIn("sha",D("sha")).orWhereIn("capturedAtLocal",C).orWhere(t=>t.whereBetween("capturedAtLocal",[u.localPlusMs(Math.min(...C),-Math.max(...L,1)),u.localPlusMs(Math.max(...C),Math.max(...L,1))])).orWhere(t=>t.where("capturedAtPrecisionMs",">",0).andWhereBetween("capturedAtLocal",[u.localPlusMs(Math.min(...C),-y.dayMs),u.localPlusMs(Math.max(...C),y.dayMs)]).andWhere(t=>t.whereIn("meanHash",D("meanHash")).orWhereIn("rightHash",D("rightHash"))))}));yield o.withBoundedConcurrency({name:"AssetFile.updateIfNeeded",laters:R.map(t=>()=>t.updateIfNeeded()),maxConcurrent:g.maxCpus()});const N=R.filter(t=>E.isSimilar(t,k));n.debug("fetched expansion",{retainAFs:A.map(t=>t.id),rejectAFs:I.map(t=>t.id),externalAssetFiles:R.length,similarAssetFiles:N.length}),N.forEach(t=>{a.truthy(t.shown)&&O.push(t.assetId)});const j=[...A,...N];yield x.AssetFile.dbr(t=>t.run(x.AssetFile.query().update({assetId:T.id,shown:0}).whereIn("id",N.map(t=>t.id))));for(const t of j)t.assetId=T.id,t.shown=!1;const B=yield _.previews().build({assetId:e,assetFiles:j,validate:!0}),z=j.find(t=>t.uri===B.uri);if(null==z)return n.throw("invalid AssetPreviewInfo (failed to find best assetFile)",{assetPreviewInfo:B,assetFileURIs:j.map(t=>t.uri)});yield x.AssetFile.setShown(e,B.assetFileId),yield S.tagAndUpsertAsset(T,c.PosixFile.for(B.path)),T.capturedAtLocal=z.capturedAtLocal,T.version=m.AssetVersion,T.shown=!0,yield T.upsert();for(const e of O)yield t(e);return T}))}}]);
//# sourceMappingURL=sync-file.js.map